<html>
<head><meta charset="utf-8"><title>Feature request: Batched fuel consumption at basic block gra · wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/index.html">wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Feature.20request.3A.20Batched.20fuel.20consumption.20at.20basic.20block.20gra.html">Feature request: Batched fuel consumption at basic block gra</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="560898058"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Feature%20request%3A%20Batched%20fuel%20consumption%20at%20basic%20block%20gra/near/560898058" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aarav Dayal <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Feature.20request.3A.20Batched.20fuel.20consumption.20at.20basic.20block.20gra.html#560898058">(Nov 29 2025 at 09:12)</a>:</h4>
<p>Hello! I am working on my own virtual machine and have a question about how fuel consumption is currently implemented and a feature request regarding the same.</p>
<p>From my research I understand that:</p>
<ul>
<li>Fuel <strong>checks</strong> happen at control flow boundaries (function entry, loop headers)</li>
<li>Fuel <strong>consumption</strong> happens per WebAssembly operator (most operators consume 1 unit)</li>
<li>This per-operator consumption creates performance overhead</li>
</ul>
<p>I would prefer if something like this could be implemented in wasmtime:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="c1">// Instead of:</span>
<span class="n">instruction_1</span>
<span class="w">  </span><span class="n">consume_fuel</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">instruction_2</span>
<span class="w">  </span><span class="n">consume_fuel</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">instruction_3</span>
<span class="w">  </span><span class="n">consume_fuel</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c1">// It would be better if it was something like:</span>
<span class="n">instruction_1</span>
<span class="n">instruction_2</span>
<span class="n">instruction_3</span>
<span class="w">  </span><span class="n">consume_fuel</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="w">  </span><span class="c1">// Batch at end of basic block</span>
</code></pre></div>
<p>This would reduce the number of increment operations while still allowing fuel checks at control flow boundaries to interrupt execution when needed.</p>
<h2>Questions</h2>
<ol>
<li>Is this kind of batched fuel consumption currently possible with any configuration?</li>
<li>Has this been considered before? (I saw issue #4109 about "slacked fuel metering" but I'm not sure if that's the same thing)</li>
<li>Would this be feasible to implement in Cranelift's code generation, or are there fundamental reasons why per-operator consumption is necessary?</li>
</ol>



<a name="560929455"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Feature%20request%3A%20Batched%20fuel%20consumption%20at%20basic%20block%20gra/near/560929455" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dave Bakker (badeend) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Feature.20request.3A.20Batched.20fuel.20consumption.20at.20basic.20block.20gra.html#560929455">(Nov 29 2025 at 16:58)</a>:</h4>
<p>You may be interested in <a href="https://docs.wasmtime.dev/examples-interrupting-wasm.html">epoch-based interruption</a>:</p>
<blockquote>
<p>Epoch-based interruption imposes relatively low overhead on Wasm execution; it has been measured at around a 10% slowdown. It is faster than fuel-based interruption.</p>
</blockquote>



<a name="560953481"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Feature%20request%3A%20Batched%20fuel%20consumption%20at%20basic%20block%20gra/near/560953481" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aarav Dayal <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Feature.20request.3A.20Batched.20fuel.20consumption.20at.20basic.20block.20gra.html#560953481">(Nov 29 2025 at 23:37)</a>:</h4>
<p><span class="user-mention silent" data-user-id="378155">Dave Bakker (badeend)</span> <a href="#narrow/channel/217126-wasmtime/topic/Feature.20request.3A.20Batched.20fuel.20consumption.20at.20basic.20block.20gra/near/560929455">said</a>:</p>
<blockquote>
<p>You may be interested in <a href="https://docs.wasmtime.dev/examples-interrupting-wasm.html">epoch-based interruption</a>:</p>
<blockquote>
<p>Epoch-based interruption imposes relatively low overhead on Wasm execution; it has been measured at around a 10% slowdown. It is faster than fuel-based interruption.</p>
</blockquote>
</blockquote>
<p>I am interested in deterministic fuel metering.</p>



<a name="560954712"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Feature%20request%3A%20Batched%20fuel%20consumption%20at%20basic%20block%20gra/near/560954712" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Feature.20request.3A.20Batched.20fuel.20consumption.20at.20basic.20block.20gra.html#560954712">(Nov 30 2025 at 00:00)</a>:</h4>
<p>I believe that this sort of batching is already implemented. The code looks like it's consume-per-op but IIRC it batches up the actual increment until some sort of side-effecting thing happens. Once a side-effecting thing happens though (e.g. loads/stores) for the determinism of fuel it needs to be flushed.</p>
<p>Having a tunable option for ignoring side effecting ops other than control flow might be a possibility though</p>



<a name="560955536"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Feature%20request%3A%20Batched%20fuel%20consumption%20at%20basic%20block%20gra/near/560955536" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Aarav Dayal <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Feature.20request.3A.20Batched.20fuel.20consumption.20at.20basic.20block.20gra.html#560955536">(Nov 30 2025 at 00:14)</a>:</h4>
<p>Are you sure that wasmtime batches instruction <strong>increments</strong>?</p>



<hr><p>Last updated: Feb 22 2026 at 11:05 UTC</p>
</html>
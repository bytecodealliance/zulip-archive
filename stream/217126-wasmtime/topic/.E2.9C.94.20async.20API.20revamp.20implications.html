<html>
<head><meta charset="utf-8"><title>✔ async API revamp implications · wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/index.html">wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20async.20API.20revamp.20implications.html">✔ async API revamp implications</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="536430525"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20async%20API%20revamp%20implications/near/536430525" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20async.20API.20revamp.20implications.html#536430525">(Aug 27 2025 at 14:14)</a>:</h4>
<p>Yeah, that's an interesting observation.  I think it aligns pretty well with the vision for <code>stream&lt;t, u, v&gt;</code> where you're expected to either read or skip to the end of the stream before you can get the final <code>u</code> value, so I wouldn't consider it a problem.</p>
<p>Regarding GC languages: the ones I'm familiar with usually do have some sort of <code>close</code> function for input streams, and that generally integrates with the language's scoped resource handling, if available.</p>



<a name="536430948"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20async%20API%20revamp%20implications/near/536430948" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20async.20API.20revamp.20implications.html#536430948">(Aug 27 2025 at 14:16)</a>:</h4>
<p>But per your latest comment on the issue: yeah, you shouldn't have to drop the stream necessarily -- just read or skip to the end.</p>



<a name="536431028"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20async%20API%20revamp%20implications/near/536431028" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20async.20API.20revamp.20implications.html#536431028">(Aug 27 2025 at 14:16)</a>:</h4>
<p>I might need to tweak the implementation if that's not working.</p>



<a name="536431597"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20async%20API%20revamp%20implications/near/536431597" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Roman Volosatovs <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20async.20API.20revamp.20implications.html#536431597">(Aug 27 2025 at 14:19)</a>:</h4>
<p>If you want, we could jump on a quick call and I can show you the behavior I'm seeing?<br>
Otherwise, you can reproduce this by removing any of the <code>drop</code>s I've added in the commit. all <code>p3_sockets</code> tests currently pass and without the drop <code>tcp_sample_application</code> deadlocks</p>
<p>you'd likely also want to do something like:</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gh">diff --git a/crates/wasi/tests/all/p3/mod.rs b/crates/wasi/tests/all/p3/mod.rs</span>
<span class="gh">index 4efc033968..87e56b3d43 100644</span>
<span class="gd">--- a/crates/wasi/tests/all/p3/mod.rs</span>
<span class="gi">+++ b/crates/wasi/tests/all/p3/mod.rs</span>
<span class="gu">@@ -20,7 +20,7 @@ async fn run(path: &amp;str) -&gt; Result&lt;()&gt; {</span>
<span class="w"> </span>    wasmtime_wasi::p3::add_to_linker(&amp;mut linker).context("failed to link `wasi:cli@0.3.x`")?;

<span class="w"> </span>    let (mut store, _td) = Ctx::new(&amp;engine, name, |builder| MyWasiCtx {
<span class="gd">-        wasi: builder.build(),</span>
<span class="gi">+        wasi: builder.inherit_stdout().inherit_stderr().build(),</span>
<span class="w"> </span>        table: Default::default(),
<span class="w"> </span>    })?;
<span class="w"> </span>    let component = Component::from_file(&amp;engine, path)?;
</code></pre></div>
<p>to actually see the output from the component if you were to resort to print-debugging</p>



<a name="536431866"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20async%20API%20revamp%20implications/near/536431866" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20async.20API.20revamp.20implications.html#536431866">(Aug 27 2025 at 14:20)</a>:</h4>
<p>Yeah, I'll repro and debug and then let you know what I find.</p>



<a name="536432216"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20async%20API%20revamp%20implications/near/536432216" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Roman Volosatovs <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20async.20API.20revamp.20implications.html#536432216">(Aug 27 2025 at 14:22)</a>:</h4>
<p>But generally, the behavior right now makes sense to me - dropping the stream handle causes the socket shutdown, as specified in <code>wasi:sockets</code>. Since we have not encountered any errors, there's not really a reason for the future to return anything yet. Basically, the only way I see this not requiring the drop of the stream handle is host buffering data from the OS</p>



<a name="536432671"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20async%20API%20revamp%20implications/near/536432671" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20async.20API.20revamp.20implications.html#536432671">(Aug 27 2025 at 14:24)</a>:</h4>
<p>ah, ok, so the test is not necessarily reading to the end (i.e. not reading until it gets a <code>StreamResult::Dropped</code>), correct?  In that case, yeah, it makes sense that you'd need to drop the stream explicitly before awaiting the future.</p>



<a name="536432772"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20async%20API%20revamp%20implications/near/536432772" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Roman Volosatovs <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20async.20API.20revamp.20implications.html#536432772">(Aug 27 2025 at 14:24)</a>:</h4>
<p>yes, exactly, I'm just adding that to the test as we speak</p>



<a name="536433207"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20async%20API%20revamp%20implications/near/536433207" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Roman Volosatovs <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20async.20API.20revamp.20implications.html#536433207">(Aug 27 2025 at 14:26)</a>:</h4>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gh">diff --git a/crates/test-programs/src/bin/p3_sockets_tcp_sample_application.rs b/crates/test-programs/src/bin/p3_sockets_tcp_sample_application.rs</span>
<span class="gh">index 83d51fbcf8..2fe38cb855 100644</span>
<span class="gd">--- a/crates/test-programs/src/bin/p3_sockets_tcp_sample_application.rs</span>
<span class="gi">+++ b/crates/test-programs/src/bin/p3_sockets_tcp_sample_application.rs</span>
<span class="gu">@@ -44,11 +44,14 @@ async fn test_tcp_sample_application(family: IpAddressFamily, bind_address: IpSo</span>
<span class="w"> </span>            let (mut data_rx, fut) = sock.receive();
<span class="w"> </span>            let (result, data) = data_rx.read(Vec::with_capacity(100)).await;
<span class="w"> </span>            assert_eq!(result, StreamResult::Complete(first_message.len()));
<span class="gd">-</span>
<span class="w"> </span>            // Check that we sent and received our message!
<span class="w"> </span>            assert_eq!(data, first_message); // Not guaranteed to work but should work in practice.
<span class="gd">-            drop(data_rx);</span>
<span class="gd">-            fut.await.unwrap()</span>
<span class="gi">+</span>
<span class="gi">+            let (result, data) = data_rx.read(Vec::with_capacity(1)).await;</span>
<span class="gi">+            assert_eq!(result, StreamResult::Dropped);</span>
<span class="gi">+            assert_eq!(data, []);</span>
<span class="gi">+</span>
<span class="gi">+            fut.await.unwrap();</span>
<span class="w"> </span>        },
<span class="w"> </span>    );

<span class="gu">@@ -74,10 +77,13 @@ async fn test_tcp_sample_application(family: IpAddressFamily, bind_address: IpSo</span>
<span class="w"> </span>            let (mut data_rx, fut) = sock.receive();
<span class="w"> </span>            let (result, data) = data_rx.read(Vec::with_capacity(100)).await;
<span class="w"> </span>            assert_eq!(result, StreamResult::Complete(second_message.len()));
<span class="gd">-</span>
<span class="w"> </span>            // Check that we sent and received our message!
<span class="w"> </span>            assert_eq!(data, second_message); // Not guaranteed to work but should work in practice.
<span class="gd">-            drop(data_rx);</span>
<span class="gi">+</span>
<span class="gi">+            let (result, data) = data_rx.read(Vec::with_capacity(1)).await;</span>
<span class="gi">+            assert_eq!(result, StreamResult::Dropped);</span>
<span class="gi">+            assert_eq!(data, []);</span>
<span class="gi">+</span>
<span class="w"> </span>            fut.await.unwrap()
<span class="w"> </span>        }
<span class="w"> </span>    );
</code></pre></div>
<p>this works, and IMO that's actually the correct behavior - previous implementation was working "by accident"</p>



<a name="536433322"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20async%20API%20revamp%20implications/near/536433322" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20async.20API.20revamp.20implications.html#536433322">(Aug 27 2025 at 14:27)</a>:</h4>
<p>yeah, looking at the code I would expect that to work, so glad to know it does</p>



<a name="536433762"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20async%20API%20revamp%20implications/near/536433762" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20async.20API.20revamp.20implications.html#536433762">(Aug 27 2025 at 14:29)</a>:</h4>
<p>also good to know that <code>drop(data_rx)</code> is effectively equivalent to "skip to the end; I don't care about the rest", since that's more efficient than reading and ignoring the items.</p>



<a name="536433818"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20async%20API%20revamp%20implications/near/536433818" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20async.20API.20revamp.20implications.html#536433818">(Aug 27 2025 at 14:29)</a>:</h4>
<p>this all makes sense to me so far, but what's up with the last diff you pasted roman?</p>



<a name="536433834"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20async%20API%20revamp%20implications/near/536433834" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20async.20API.20revamp.20implications.html#536433834">(Aug 27 2025 at 14:29)</a>:</h4>
<p>is that required to make the test pass?</p>



<a name="536433932"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20async%20API%20revamp%20implications/near/536433932" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20async.20API.20revamp.20implications.html#536433932">(Aug 27 2025 at 14:30)</a>:</h4>
<p>I think the upshot is that you either need to drop the stream or read to the end before you await the future</p>



<a name="536434003"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20async%20API%20revamp%20implications/near/536434003" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20async.20API.20revamp.20implications.html#536434003">(Aug 27 2025 at 14:30)</a>:</h4>
<p>so either drop now or get <code>StreamResult::Dropped</code> before the future resolves?</p>



<a name="536434029"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20async%20API%20revamp%20implications/near/536434029" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20async.20API.20revamp.20implications.html#536434029">(Aug 27 2025 at 14:30)</a>:</h4>
<p>right</p>



<a name="536434051"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20async%20API%20revamp%20implications/near/536434051" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20async.20API.20revamp.20implications.html#536434051">(Aug 27 2025 at 14:30)</a>:</h4>
<p>yeah that makes sense to me</p>



<a name="536434073"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20async%20API%20revamp%20implications/near/536434073" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20async.20API.20revamp.20implications.html#536434073">(Aug 27 2025 at 14:30)</a>:</h4>
<p>i.e. both the before and after for that diff should work</p>



<a name="536434392"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20async%20API%20revamp%20implications/near/536434392" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Roman Volosatovs <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20async.20API.20revamp.20implications.html#536434392">(Aug 27 2025 at 14:32)</a>:</h4>
<p>previously the test was not doing either and it just happened to work, because the host task was buffering data from the host and therefore it was notified about the shutdown earlier</p>



<a name="536434459"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20async%20API%20revamp%20implications/near/536434459" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20async.20API.20revamp.20implications.html#536434459">(Aug 27 2025 at 14:32)</a>:</h4>
<p><span class="user-mention silent" data-user-id="484032">Roman Volosatovs</span> has marked this topic as resolved.</p>



<a name="536434598"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/%E2%9C%94%20async%20API%20revamp%20implications/near/536434598" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/.E2.9C.94.20async.20API.20revamp.20implications.html#536434598">(Aug 27 2025 at 14:33)</a>:</h4>
<p>I suspect that these sorts of minor tweaks in behavior are going to crop up over time, even after we ship WASIp3</p>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
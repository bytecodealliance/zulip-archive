<html>
<head><meta charset="utf-8"><title>epoch-based  interruption without `target_has_atomic = &quot;64&quot;` · wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/index.html">wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/epoch-based.20.20interruption.20without.20.60target_has_atomic.20.3D.20.2264.22.60.html">epoch-based  interruption without `target_has_atomic = &quot;64&quot;`</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="542280951"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/epoch-based%20%20interruption%20without%20%60target_has_atomic%20%3D%20%2264%22%60/near/542280951" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Antoine Lavandier <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/epoch-based.20.20interruption.20without.20.60target_has_atomic.20.3D.20.2264.22.60.html#542280951">(Sep 30 2025 at 13:47)</a>:</h4>
<p>Hello,</p>
<p>I would like to use epoch-based interruption with wasmtime but my target doesn't have 64 bits atomics. I would like to add support for this in the wasmtime. There are two orthogonal questions on which I would like feedback before trying to contribute anything </p>
<ul>
<li>Should the epoch counter be an u64 in all cases or can it be lowered to an u32/u16  for platforms that only have atomics up to u32/u16 ?</li>
<li>Should the atomics supported only be <code>core::sync::atomic</code> or is it ok to use the <a href="https://docs.rs/portable-atomic/latest/portable_atomic/"><code>portable-atomics</code></a> crate's atomic types. </li>
</ul>
<p>For the first question, this would increase mean writing stuff like : </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="cp">#[cfg( target_has_atomic = </span><span class="s">"64"</span><span class="cp">)]</span>
<span class="w">    </span><span class="n">epoch</span><span class="p">:</span><span class="w"> </span><span class="nc">AtomicU64</span><span class="p">,</span>
<span class="w">    </span><span class="cp">#[cfg(all(feature = </span><span class="s">"runtime"</span><span class="cp">, target_has_atomic = </span><span class="s">"32"</span><span class="cp">, not(target_has_atomic = </span><span class="s">"64"</span><span class="cp">)))]</span>
<span class="w">    </span><span class="n">epoch</span><span class="p">:</span><span class="w"> </span><span class="nc">AtomicU32</span><span class="p">,</span>

<span class="c1">// On every function previously #[cfg( target_has_atomic = "64")]</span>
<span class="cp">#[cfg(any(target_has_atomic = </span><span class="s">"64"</span><span class="cp">, target_has_atomic = </span><span class="s">"32"</span><span class="cp">))]</span>
<span class="k">fn</span><span class="w"> </span><span class="nf">a</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span>
</code></pre></div>
<p>And documenting that the maximum number of epochs isn't the same for every platform. </p>
<p>Using <code>portable-atomic</code> would allow every platform that supports <code>portable-atomic</code> to use an <code>AtomicU64</code>. This would most likely require adding a new <code>portable-atomic</code> feature to <code>wasmtime</code> that enables this dependency and uses its atomic types instead of the ones provided by <code>core</code>.</p>



<a name="542286183"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/epoch-based%20%20interruption%20without%20%60target_has_atomic%20%3D%20%2264%22%60/near/542286183" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/epoch-based.20.20interruption.20without.20.60target_has_atomic.20.3D.20.2264.22.60.html#542286183">(Sep 30 2025 at 14:06)</a>:</h4>
<p>Would using fuel work for your use case? Epochs get pretty tricky without 64-bit atomics unfortunately. One of the difficulties is plumbing this support through not only <code>#[cfg]</code> but through. Cranelift as well to understand it's a 32-bit variable instead of a 64-bit variable</p>



<a name="542290068"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/epoch-based%20%20interruption%20without%20%60target_has_atomic%20%3D%20%2264%22%60/near/542290068" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Antoine Lavandier <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/epoch-based.20.20interruption.20without.20.60target_has_atomic.20.3D.20.2264.22.60.html#542290068">(Sep 30 2025 at 14:21)</a>:</h4>
<p>Then using <code>portable-atomic</code> would be more suited than lowering the size of the atomics. <br>
I could probably use fuel provided that it works well with <code>async</code> but I'm worried about the increased code size from the fuel instrumentation</p>



<a name="542291104"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/epoch-based%20%20interruption%20without%20%60target_has_atomic%20%3D%20%2264%22%60/near/542291104" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/epoch-based.20.20interruption.20without.20.60target_has_atomic.20.3D.20.2264.22.60.html#542291104">(Sep 30 2025 at 14:25)</a>:</h4>
<p>Oh that'd be an interesting point of comparison yeah, code size with/without fuel. If the code size of fuel vs epochs is a tipping point it's honestly probably easier to make the code size for fuel smaller (e.g. I assume you're using Pulley so we could start adding some custom opcodes)</p>



<a name="542291661"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/epoch-based%20%20interruption%20without%20%60target_has_atomic%20%3D%20%2264%22%60/near/542291661" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/epoch-based.20.20interruption.20without.20.60target_has_atomic.20.3D.20.2264.22.60.html#542291661">(Sep 30 2025 at 14:27)</a>:</h4>
<p>Otherwise though one way we could manage <code>#[cfg]</code> is to, in theory, have:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[cfg(long_expr)]</span>
<span class="k">mod</span><span class="w"> </span><span class="nn">epoch64</span><span class="p">;</span>
<span class="cp">#[cfg(not(long_expr), longer_expr)]</span>
<span class="k">mod</span><span class="w"> </span><span class="nn">epoch32</span><span class="p">;</span>
<span class="cp">#[cfg(not(long_expr), not(longer_expr))]</span>
<span class="k">mod</span><span class="w"> </span><span class="nn">epoch_disabled</span><span class="p">;</span>
</code></pre></div>
<p>or something like that, basically only having <code>#[cfg]</code> at the module level and stuffing it all in there</p>



<a name="542294427"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/epoch-based%20%20interruption%20without%20%60target_has_atomic%20%3D%20%2264%22%60/near/542294427" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Antoine Lavandier <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/epoch-based.20.20interruption.20without.20.60target_has_atomic.20.3D.20.2264.22.60.html#542294427">(Sep 30 2025 at 14:38)</a>:</h4>
<p>I tried to precompile the same component with the following options :</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="n">config</span><span class="p">.</span><span class="n">memory_reservation</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="n">config</span><span class="p">.</span><span class="n">wasm_custom_page_sizes</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">    </span><span class="n">config</span><span class="p">.</span><span class="n">memory_may_move</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="w">    </span><span class="n">config</span><span class="p">.</span><span class="n">memory_init_cow</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="w">    </span><span class="n">config</span><span class="p">.</span><span class="n">cranelift_opt_level</span><span class="p">(</span><span class="n">wasmtime</span><span class="p">::</span><span class="n">OptLevel</span><span class="p">::</span><span class="n">SpeedAndSize</span><span class="p">);</span>
<span class="w">    </span><span class="n">config</span><span class="p">.</span><span class="n">target</span><span class="p">(</span><span class="s">"pulley32"</span><span class="p">);</span>
</code></pre></div>
<ul>
<li>Initial size before precompilation: <code>6262</code> bytes</li>
<li>Without instrumentation: <code>19952</code> bytes </li>
<li>With epoch: <code>24456</code>bytes (122% of the un-instrumented code)</li>
<li>With fuel: <code>26528</code> bytes (132% of the un-instrumented code)</li>
</ul>



<a name="542295477"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/epoch-based%20%20interruption%20without%20%60target_has_atomic%20%3D%20%2264%22%60/near/542295477" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Antoine Lavandier <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/epoch-based.20.20interruption.20without.20.60target_has_atomic.20.3D.20.2264.22.60.html#542295477">(Sep 30 2025 at 14:42)</a>:</h4>
<p>If using the <code>portable-atomic</code> it could also be as simple as changing this in <code>engine.rs</code> </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">core</span><span class="p">::</span><span class="n">sync</span><span class="p">::</span><span class="n">atomic</span><span class="p">::</span><span class="n">Ordering</span><span class="p">;</span>
<span class="cp">#[cfg(target_has_atomic = </span><span class="s">"64"</span><span class="cp">)]</span>
<span class="k">use</span><span class="w"> </span><span class="n">core</span><span class="p">::</span><span class="n">sync</span><span class="p">::</span><span class="n">atomic</span><span class="p">::</span><span class="n">AtomicU64</span><span class="p">;</span>
<span class="cp">#[cfg(feature = </span><span class="s">"portable-atomic"</span><span class="cp">)]</span>
<span class="k">use</span><span class="w"> </span><span class="n">portable_atomic</span><span class="p">::</span><span class="n">AtomicU64</span><span class="p">;</span>
</code></pre></div>
<p>Or am I missing something with regards to Cranelift ?</p>



<a name="542309897"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/epoch-based%20%20interruption%20without%20%60target_has_atomic%20%3D%20%2264%22%60/near/542309897" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/epoch-based.20.20interruption.20without.20.60target_has_atomic.20.3D.20.2264.22.60.html#542309897">(Sep 30 2025 at 15:41)</a>:</h4>
<p>I'm not really sure, I don't know how portable-atomic is itself implemented</p>



<a name="542309995"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/epoch-based%20%20interruption%20without%20%60target_has_atomic%20%3D%20%2264%22%60/near/542309995" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/epoch-based.20.20interruption.20without.20.60target_has_atomic.20.3D.20.2264.22.60.html#542309995">(Sep 30 2025 at 15:41)</a>:</h4>
<p>I'd have to dig into how an atomic 64-bit read works, because for example that's what Cranelift does and whatever portable-atomic does would need to be reflected into Cranelift too</p>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
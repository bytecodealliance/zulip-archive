<html>
<head><meta charset="utf-8"><title>Component model async and `task.return` with host futures · wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/index.html">wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Component.20model.20async.20and.20.60task.2Ereturn.60.20with.20host.20futures.html">Component model async and `task.return` with host futures</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="537339154"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Component%20model%20async%20and%20%60task.return%60%20with%20host%20futures/near/537339154" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Component.20model.20async.20and.20.60task.2Ereturn.60.20with.20host.20futures.html#537339154">(Sep 02 2025 at 18:00)</a>:</h4>
<p><span class="user-mention" data-user-id="509936">@Joel Dice</span> let's say I invoke an async guest function from the host. The guest calls <code>task.return</code> and then sleeps for 10s. Does the host-side future resolve immediately on <code>task.return</code> or does it wait for the task to exit?</p>



<a name="537341286"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Component%20model%20async%20and%20%60task.return%60%20with%20host%20futures/near/537341286" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Component.20model.20async.20and.20.60task.2Ereturn.60.20with.20host.20futures.html#537341286">(Sep 02 2025 at 18:14)</a>:</h4>
<p>It <em>should</em> be immediate, right?</p>



<a name="537341491"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Component%20model%20async%20and%20%60task.return%60%20with%20host%20futures/near/537341491" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Component.20model.20async.20and.20.60task.2Ereturn.60.20with.20host.20futures.html#537341491">(Sep 02 2025 at 18:15)</a>:</h4>
<p>I suppose this is was a leading question, but I'm under the impression it's not immediate currently. I was about to open an issue for making it immediate but wanted to confirm first.</p>
<p>If it is immediate, however, then we also need more API bindings since right now the host otherwise has no way of knowing when the task has exited after returning</p>



<a name="537341552"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Component%20model%20async%20and%20%60task.return%60%20with%20host%20futures/near/537341552" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Component.20model.20async.20and.20.60task.2Ereturn.60.20with.20host.20futures.html#537341552">(Sep 02 2025 at 18:16)</a>:</h4>
<p>so, yes, I agree it should probably be immediate, but in doing so we need to expose the "task exited" event too</p>



<a name="537341798"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Component%20model%20async%20and%20%60task.return%60%20with%20host%20futures/near/537341798" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Component.20model.20async.20and.20.60task.2Ereturn.60.20with.20host.20futures.html#537341798">(Sep 02 2025 at 18:17)</a>:</h4>
<p>Is the task that returned special from the caller's perspective compared to any other task that might have been created?</p>



<a name="537341955"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Component%20model%20async%20and%20%60task.return%60%20with%20host%20futures/near/537341955" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Component.20model.20async.20and.20.60task.2Ereturn.60.20with.20host.20futures.html#537341955">(Sep 02 2025 at 18:18)</a>:</h4>
<p>To me it is insofar as it represents the guests request to keep running after returning, so if the host wants to respect that it needs to know when the guest is done</p>



<a name="537342138"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Component%20model%20async%20and%20%60task.return%60%20with%20host%20futures/near/537342138" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Component.20model.20async.20and.20.60task.2Ereturn.60.20with.20host.20futures.html#537342138">(Sep 02 2025 at 18:20)</a>:</h4>
<p>Oh right this is meaningful because of the pseudo-structured-concurrency thing</p>



<a name="537342290"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Component%20model%20async%20and%20%60task.return%60%20with%20host%20futures/near/537342290" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Component.20model.20async.20and.20.60task.2Ereturn.60.20with.20host.20futures.html#537342290">(Sep 02 2025 at 18:21)</a>:</h4>
<p>well the host wouldn't have a guarantee that when the guest task exits that there's no transitive tasks, so it's not structured in that sense</p>



<a name="537342325"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Component%20model%20async%20and%20%60task.return%60%20with%20host%20futures/near/537342325" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Component.20model.20async.20and.20.60task.2Ereturn.60.20with.20host.20futures.html#537342325">(Sep 02 2025 at 18:21)</a>:</h4>
<p>but basically if everyone wants to participate in the structured concurrency paradigm it should be possible IMO</p>



<a name="537342586"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Component%20model%20async%20and%20%60task.return%60%20with%20host%20futures/near/537342586" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Component.20model.20async.20and.20.60task.2Ereturn.60.20with.20host.20futures.html#537342586">(Sep 02 2025 at 18:23)</a>:</h4>
<p>Do borrows have to be dropped before <code>task.return</code> or before task exit?</p>



<a name="537343084"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Component%20model%20async%20and%20%60task.return%60%20with%20host%20futures/near/537343084" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Component.20model.20async.20and.20.60task.2Ereturn.60.20with.20host.20futures.html#537343084">(Sep 02 2025 at 18:27)</a>:</h4>
<p>before <code>task.return</code>, <a href="https://github.com/WebAssembly/component-model/blob/main/design/mvp/Async.md#returning:~:text=decremented%20when%20the%20caller%20is%20notified%20that%20the%20subtask%20has%20returned.">I see</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/WebAssembly/component-model/blob/main/design/mvp/Async.md#returning:~:text=decremented%20when%20the%20caller%20is%20notified%20that%20the%20subtask%20has%20returned." style="background-image: url(&quot;https://uploads.zulipusercontent.net/aa89c102473fd5d2b37ebdffc3166e2adc9db6a6/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f643132363664373639333264336362383530386430326466636262626565346662653865336566393234363339656237343964313132636665326165356130622f576562417373656d626c792f636f6d706f6e656e742d6d6f64656c&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/WebAssembly/component-model/blob/main/design/mvp/Async.md#returning:~:text=decremented%20when%20the%20caller%20is%20notified%20that%20the%20subtask%20has%20returned." title="component-model/design/mvp/Async.md at main · WebAssembly/component-model">component-model/design/mvp/Async.md at main · WebAssembly/component-model</a></div><div class="message_embed_description">Repository for design and specification of the Component Model - WebAssembly/component-model</div></div></div>



<a name="537343326"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Component%20model%20async%20and%20%60task.return%60%20with%20host%20futures/near/537343326" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Component.20model.20async.20and.20.60task.2Ereturn.60.20with.20host.20futures.html#537343326">(Sep 02 2025 at 18:29)</a>:</h4>
<p><span class="user-mention silent" data-user-id="253994">Alex Crichton</span> <a href="#narrow/channel/217126-wasmtime/topic/Component.20model.20async.20and.20.60task.2Ereturn.60.20with.20host.20futures/near/537342290">said</a>:</p>
<blockquote>
<p>well the host wouldn't have a guarantee that when the guest task exits that there's no transitive tasks, so it's not structured in that sense</p>
</blockquote>
<p>I <em>think</em> it should, if <a href="https://github.com/WebAssembly/component-model/blob/main/design/mvp/Async.md#structured-concurrency:~:text=the%20supertask%20semantically%20%22tail%20calls%22%20any%20still%2Dlive%20subtasks">this</a> is implemented (and applies to the host)</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/WebAssembly/component-model/blob/main/design/mvp/Async.md#structured-concurrency:~:text=the%20supertask%20semantically%20%22tail%20calls%22%20any%20still%2Dlive%20subtasks" style="background-image: url(&quot;https://uploads.zulipusercontent.net/aa89c102473fd5d2b37ebdffc3166e2adc9db6a6/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f643132363664373639333264336362383530386430326466636262626565346662653865336566393234363339656237343964313132636665326165356130622f576562417373656d626c792f636f6d706f6e656e742d6d6f64656c&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/WebAssembly/component-model/blob/main/design/mvp/Async.md#structured-concurrency:~:text=the%20supertask%20semantically%20%22tail%20calls%22%20any%20still%2Dlive%20subtasks" title="component-model/design/mvp/Async.md at main · WebAssembly/component-model">component-model/design/mvp/Async.md at main · WebAssembly/component-model</a></div><div class="message_embed_description">Repository for design and specification of the Component Model - WebAssembly/component-model</div></div></div>



<a name="537343763"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Component%20model%20async%20and%20%60task.return%60%20with%20host%20futures/near/537343763" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Component.20model.20async.20and.20.60task.2Ereturn.60.20with.20host.20futures.html#537343763">(Sep 02 2025 at 18:32)</a>:</h4>
<p>aha good point, and now I also don't know whether that's implemented</p>



<a name="537350361"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Component%20model%20async%20and%20%60task.return%60%20with%20host%20futures/near/537350361" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Component.20model.20async.20and.20.60task.2Ereturn.60.20with.20host.20futures.html#537350361">(Sep 02 2025 at 19:19)</a>:</h4>
<p>Currently, there's no convenient way to wait for a task to exit in the Wasmtime API.  I was thinking we could make <code>call_concurrent</code> return a tuple of the result and a future that resolves when the task exits; that should be easy enough to do, but isn't implemented yet.</p>
<p>Technically, you can also pass a forever-pending future to <code>Instance::run_concurrent</code> and wait for it to return a "deadlock" trap, which means "the runtime has nothing left to do".  We use that hack in a few tests to wait for all outstanding tasks to exit, but it's obviously not a great long-term solution, plus it won't help if you only care about a specific task exiting.</p>



<a name="537350417"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Component%20model%20async%20and%20%60task.return%60%20with%20host%20futures/near/537350417" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Component.20model.20async.20and.20.60task.2Ereturn.60.20with.20host.20futures.html#537350417">(Sep 02 2025 at 19:19)</a>:</h4>
<p>Ah ok, so <code>task.return</code> is indeed immediate today?</p>



<a name="537352090"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Component%20model%20async%20and%20%60task.return%60%20with%20host%20futures/near/537352090" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Component.20model.20async.20and.20.60task.2Ereturn.60.20with.20host.20futures.html#537352090">(Sep 02 2025 at 19:33)</a>:</h4>
<p>Yes.</p>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
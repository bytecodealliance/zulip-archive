<html>
<head><meta charset="utf-8"><title>OOM handling in (parts of) Wasmtime · wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/index.html">wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/OOM.20handling.20in.20.28parts.20of.29.20Wasmtime.html">OOM handling in (parts of) Wasmtime</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="558503499"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/OOM%20handling%20in%20%28parts%20of%29%20Wasmtime/near/558503499" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/OOM.20handling.20in.20.28parts.20of.29.20Wasmtime.html#558503499">(Nov 20 2025 at 18:39)</a>:</h4>
<p><span class="user-mention" data-user-id="254389">@Chris Fallin</span> <span class="user-mention" data-user-id="253990">@fitzgen (he/him)</span> Regarding the OOM handling topic in today's meeting: I'm curious how you anticipate OOM errors will be handled.  I imagine there are roughly three scenarios:</p>
<ol>
<li>Just propagate it to the caller like other errors, e.g. <code>vec.try_push(foo)?</code></li>
<li>Handle it internally in Wasmtime by taking a different code path which presumably requires less or no allocation (and/or freeing up some other allocation) but still allows the operation to succeed</li>
<li>Propagate it to the embedder to deal with, presumably by dropping the store and returning a 500 error, or whatever is appropriate</li>
</ol>
<p>I'm naively imagining #1 and #3 will be quite common and #2 will be rare.  If that's true, then letting allocation failures panic, catching such panics at public API boundaries, and "poisoning" the store so it can't be used again could be a valid alternative approach.  For the rare #2 cases, the same approach could be used at a finer-grained level: catch the panic, drop any half-formed state, and try the fallback code path.</p>
<p>I mentioned something like this last time it was brought up, but I don't recall if there were objections, and if so, what they were.</p>



<a name="558503781"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/OOM%20handling%20in%20%28parts%20of%29%20Wasmtime/near/558503781" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/OOM.20handling.20in.20.28parts.20of.29.20Wasmtime.html#558503781">(Nov 20 2025 at 18:41)</a>:</h4>
<p>Yes mostly 1 and 3 but the problem with panics is that they internally allocate I am pretty sure and also they run destructors which if those attempt to allocate will lead to panic in panic which aborts</p>



<a name="558503840"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/OOM%20handling%20in%20%28parts%20of%29%20Wasmtime/near/558503840" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/OOM.20handling.20in.20.28parts.20of.29.20Wasmtime.html#558503840">(Nov 20 2025 at 18:41)</a>:</h4>
<p>But also our nostd doesn’t support panic unwinding</p>



<a name="558503892"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/OOM%20handling%20in%20%28parts%20of%29%20Wasmtime/near/558503892" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/OOM.20handling.20in.20.28parts.20of.29.20Wasmtime.html#558503892">(Nov 20 2025 at 18:41)</a>:</h4>
<p>Presumably propagating errors with <code>?</code> will also run destructors.</p>



<a name="558503973"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/OOM%20handling%20in%20%28parts%20of%29%20Wasmtime/near/558503973" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/OOM.20handling.20in.20.28parts.20of.29.20Wasmtime.html#558503973">(Nov 20 2025 at 18:42)</a>:</h4>
<p>but yeah, I see how it avoids the double panic</p>



<a name="558504012"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/OOM%20handling%20in%20%28parts%20of%29%20Wasmtime/near/558504012" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/OOM.20handling.20in.20.28parts.20of.29.20Wasmtime.html#558504012">(Nov 20 2025 at 18:42)</a>:</h4>
<p>True but if allocations return a result then you shouldn’t just unwrap that in drop</p>



<a name="558504099"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/OOM%20handling%20in%20%28parts%20of%29%20Wasmtime/near/558504099" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/OOM.20handling.20in.20.28parts.20of.29.20Wasmtime.html#558504099">(Nov 20 2025 at 18:43)</a>:</h4>
<p>yeah, either way you need to have well-behaved<code>Drop</code> implementations</p>



<a name="558504117"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/OOM%20handling%20in%20%28parts%20of%29%20Wasmtime/near/558504117" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/OOM.20handling.20in.20.28parts.20of.29.20Wasmtime.html#558504117">(Nov 20 2025 at 18:43)</a>:</h4>
<p>I think what you describe is possible but feels a bit hackier / doesn’t match my sense of style as much. Having a hard time putting it into words</p>



<a name="558504196"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/OOM%20handling%20in%20%28parts%20of%29%20Wasmtime/near/558504196" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/OOM.20handling.20in.20.28parts.20of.29.20Wasmtime.html#558504196">(Nov 20 2025 at 18:44)</a>:</h4>
<p>I guess I like that results don’t hide the error condition</p>



<a name="558504224"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/OOM%20handling%20in%20%28parts%20of%29%20Wasmtime/near/558504224" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/OOM.20handling.20in.20.28parts.20of.29.20Wasmtime.html#558504224">(Nov 20 2025 at 18:44)</a>:</h4>
<p>If we are going to actually handle it, then we should be explicit about that</p>



<a name="558504263"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/OOM%20handling%20in%20%28parts%20of%29%20Wasmtime/near/558504263" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/OOM.20handling.20in.20.28parts.20of.29.20Wasmtime.html#558504263">(Nov 20 2025 at 18:44)</a>:</h4>
<p>I'm not necessarily advocating for it: just feeling out the solution space, inspired a bit by Erlang-style supervision trees</p>



<a name="558504327"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/OOM%20handling%20in%20%28parts%20of%29%20Wasmtime/near/558504327" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/OOM.20handling.20in.20.28parts.20of.29.20Wasmtime.html#558504327">(Nov 20 2025 at 18:45)</a>:</h4>
<p>If vec push doesn’t return a result, then why not use it in drop? But that’s a foot gun.</p>



<a name="558504404"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/OOM%20handling%20in%20%28parts%20of%29%20Wasmtime/near/558504404" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/OOM.20handling.20in.20.28parts.20of.29.20Wasmtime.html#558504404">(Nov 20 2025 at 18:45)</a>:</h4>
<p>I do like the idea of poisoning stores and creating well defined boundaries</p>



<a name="558504462"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/OOM%20handling%20in%20%28parts%20of%29%20Wasmtime/near/558504462" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/OOM.20handling.20in.20.28parts.20of.29.20Wasmtime.html#558504462">(Nov 20 2025 at 18:45)</a>:</h4>
<p>One other thing that throws the wrench into "catch the panic" is that we build with panic=abort right now because we don't have libunwind in our no-std environment. So this whole branch is out I think</p>



<a name="558504497"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/OOM%20handling%20in%20%28parts%20of%29%20Wasmtime/near/558504497" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/OOM.20handling.20in.20.28parts.20of.29.20Wasmtime.html#558504497">(Nov 20 2025 at 18:46)</a>:</h4>
<p>in general I don't like DWARF being load-bearing here either</p>



<a name="558504564"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/OOM%20handling%20in%20%28parts%20of%29%20Wasmtime/near/558504564" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/OOM.20handling.20in.20.28parts.20of.29.20Wasmtime.html#558504564">(Nov 20 2025 at 18:46)</a>:</h4>
<p>Yeah we would also have to unwind over wasm</p>



<a name="558504672"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/OOM%20handling%20in%20%28parts%20of%29%20Wasmtime/near/558504672" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/OOM.20handling.20in.20.28parts.20of.29.20Wasmtime.html#558504672">(Nov 20 2025 at 18:47)</a>:</h4>
<p>indeed</p>



<a name="558504826"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/OOM%20handling%20in%20%28parts%20of%29%20Wasmtime/near/558504826" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/OOM.20handling.20in.20.28parts.20of.29.20Wasmtime.html#558504826">(Nov 20 2025 at 18:47)</a>:</h4>
<p>There's also the aspect that I don't know we've tested/audited for correct disentangling of state via destructors at all possible failure points -- maybe? but there's a reason that e.g. mutexes get poisoned on panics, and there is cross-store state too (e.g. global module registry and the like)</p>



<a name="558504928"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/OOM%20handling%20in%20%28parts%20of%29%20Wasmtime/near/558504928" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/OOM.20handling.20in.20.28parts.20of.29.20Wasmtime.html#558504928">(Nov 20 2025 at 18:48)</a>:</h4>
<p>We would sort of test that indirectly via the oom testing but yeah</p>



<a name="558504985"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/OOM%20handling%20in%20%28parts%20of%29%20Wasmtime/near/558504985" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/OOM.20handling.20in.20.28parts.20of.29.20Wasmtime.html#558504985">(Nov 20 2025 at 18:48)</a>:</h4>
<p>Right, I guess I'm saying we need to eat the frog either way, so we might as well do it via "normal" control flow</p>



<a name="558525906"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/OOM%20handling%20in%20%28parts%20of%29%20Wasmtime/near/558525906" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/OOM.20handling.20in.20.28parts.20of.29.20Wasmtime.html#558525906">(Nov 20 2025 at 20:48)</a>:</h4>
<p>While I agree that panicking in no_std is hard...</p>
<blockquote>
<p>Yeah we would also have to unwind over wasm</p>
</blockquote>
<p>this at least you don't have to deal with, we catch all panics in wasmtime at the wasm boundary, use a trap to unwind wasm, and then resume the panic on the other end</p>



<a name="558613843"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/OOM%20handling%20in%20%28parts%20of%29%20Wasmtime/near/558613843" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/OOM.20handling.20in.20.28parts.20of.29.20Wasmtime.html#558613843">(Nov 21 2025 at 09:27)</a>:</h4>
<p>The unwinding crate can be used with no_std. Though you do need nightly to be able to set the personality function that libstd would otherwise set.</p>



<a name="558703109"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/OOM%20handling%20in%20%28parts%20of%29%20Wasmtime/near/558703109" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/OOM.20handling.20in.20.28parts.20of.29.20Wasmtime.html#558703109">(Nov 21 2025 at 16:29)</a>:</h4>
<p>we talked about deserialization of cwasm's yesterday, and I just remembered that <a href="https://github.com/jamesmunns/postcard">Postcard</a> might be useful for that</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/jamesmunns/postcard" style="background-image: url(&quot;https://uploads.zulipusercontent.net/9ab65b8ac45404a6f84eab8624e684430f08bc9c/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f313734653065353034363434316562346163343566333063313965376630663537353939636166373366613935636630653461646538346465306130373863342f6a616d65736d756e6e732f706f737463617264&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/jamesmunns/postcard" title="GitHub - jamesmunns/postcard: A no_std + serde compatible message library for Rust">GitHub - jamesmunns/postcard: A no_std + serde compatible message library for Rust</a></div><div class="message_embed_description">A no_std + serde compatible message library for Rust - jamesmunns/postcard</div></div></div>



<a name="558722001"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/OOM%20handling%20in%20%28parts%20of%29%20Wasmtime/near/558722001" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/OOM.20handling.20in.20.28parts.20of.29.20Wasmtime.html#558722001">(Nov 21 2025 at 18:01)</a>:</h4>
<p><span class="user-mention silent" data-user-id="234973">Till Schneidereit</span> <a href="#narrow/channel/217126-wasmtime/topic/OOM.20handling.20in.20.28parts.20of.29.20Wasmtime/near/558703109">said</a>:</p>
<blockquote>
<p>we talked about deserialization of cwasm's yesterday, and I just remembered that <a href="https://github.com/jamesmunns/postcard">Postcard</a> might be useful for that</p>
</blockquote>
<p>we already use <code>postcard</code> today in fact: <a href="https://github.com/search?q=repo%3Abytecodealliance%2Fwasmtime%20postcard&amp;type=code">https://github.com/search?q=repo%3Abytecodealliance%2Fwasmtime%20postcard&amp;type=code</a></p>
<p>but I have not figured out if it supports OOM-handling or not from a very quick glance at its docs. I do know that it reuses the serde traits, and I don't know if those interfaces are going to constrain us here</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/search?q=repo%3Abytecodealliance%2Fwasmtime%20postcard&amp;type=code" style="background-image: url(&quot;https://uploads.zulipusercontent.net/33bfd30bde61bfd938502e4c1fdeaa24486f1e2b/68747470733a2f2f6769746875622e6769746875626173736574732e636f6d2f6173736574732f6769746875622d6f63746f6361742d3133633836623862333336642e706e67&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/search?q=repo%3Abytecodealliance%2Fwasmtime%20postcard&amp;type=code" title="Build software better, together">Build software better, together</a></div><div class="message_embed_description">GitHub is where people build software. More than 150 million people use GitHub to discover, fork, and contribute to over 420 million projects.</div></div></div>



<a name="558731412"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/OOM%20handling%20in%20%28parts%20of%29%20Wasmtime/near/558731412" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/OOM.20handling.20in.20.28parts.20of.29.20Wasmtime.html#558731412">(Nov 21 2025 at 18:54)</a>:</h4>
<p><span class="user-mention silent" data-user-id="253990">fitzgen (he/him)</span> <a href="#narrow/channel/217126-wasmtime/topic/OOM.20handling.20in.20.28parts.20of.29.20Wasmtime/near/558722001">said</a>:</p>
<blockquote>
<p>but I have not figured out if it supports OOM-handling or not from a very quick glance at its docs. I do know that it reuses the serde traits, and I don't know if those interfaces are going to constrain us here</p>
</blockquote>
<p>so I looked into this a little more and I think we can make it work <strong><em>if</em></strong> we create new collection types (eg <code>wasmtime_collections::Vec</code>) for our OOM-handling collections rather than do extension traits for <code>std</code>/<code>alloc</code> types.[^0] this is because we need a separate implementation of <code>serde::Deserialize</code> that does OOM handling, but there can only be one implementation of <code>serde::Deserialize</code> for one type.</p>
<p>[^0]: or alternatively use newtypes only within the things we want to deserialize with postcard/serde but if we are doing newtypes for this we might as well do it for all use sites</p>



<hr><p>Last updated: Feb 22 2026 at 11:05 UTC</p>
</html>
<html>
<head><meta charset="utf-8"><title>memory leak in wasi-nn · wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/index.html">wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/memory.20leak.20in.20wasi-nn.html">memory leak in wasi-nn</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="538335258"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/memory%20leak%20in%20wasi-nn/near/538335258" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Masahiro Kozuka <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/memory.20leak.20in.20wasi-nn.html#538335258">(Sep 09 2025 at 01:05)</a>:</h4>
<p>Hello.</p>
<p>I found a memory leak in wasi-nn. When we call compute(),  a tensor which is passed from wasm will be leaked because wasm pass its owenership but host doesn't comsume it.</p>
<p>I find this leak will be fixed with the following change. <br>
<a href="https://github.com/seera-networks/wasmtime/commit/d1ac513d00b0cd3e2a869544c2bc067b5f6298b3">https://github.com/seera-networks/wasmtime/commit/d1ac513d00b0cd3e2a869544c2bc067b5f6298b3</a></p>
<p>How can I contribute this change?</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/seera-networks/wasmtime/commit/d1ac513d00b0cd3e2a869544c2bc067b5f6298b3" style="background-image: url(&quot;https://uploads.zulipusercontent.net/a73137891cf9beafa08db468573469c8beb46ea5/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f663539643464373533616136633337653964363865373664383366616239636631383963666563343463346131383462346463396666346462313563653233312f73656572612d6e6574776f726b732f7761736d74696d652f636f6d6d69742f64316163353133643030623063643365326138363935343463326263303637623566363239386233&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/seera-networks/wasmtime/commit/d1ac513d00b0cd3e2a869544c2bc067b5f6298b3" title="fix memory leak · seera-networks/wasmtime@d1ac513">fix memory leak · seera-networks/wasmtime@d1ac513</a></div><div class="message_embed_description">A lightweight WebAssembly runtime that is fast, secure, and standards-compliant - fix memory leak · seera-networks/wasmtime@d1ac513</div></div></div>



<a name="538487457"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/memory%20leak%20in%20wasi-nn/near/538487457" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/memory.20leak.20in.20wasi-nn.html#538487457">(Sep 09 2025 at 17:12)</a>:</h4>
<p>a pull request is the preferred way to propose code changes</p>
<p>cc <span class="user-mention" data-user-id="254110">@Andrew Brown</span> for wasi-nn stuff</p>



<a name="538541932"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/memory%20leak%20in%20wasi-nn/near/538541932" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christof Petig <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/memory.20leak.20in.20wasi-nn.html#538541932">(Sep 09 2025 at 22:31)</a>:</h4>
<p>I memorized that within the Component model the host never frees data allocated by the guest directly, this is the purpose of the matching post_cabi function. Can you check whether this is the case here as well?</p>



<a name="538542334"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/memory%20leak%20in%20wasi-nn/near/538542334" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Brown <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/memory.20leak.20in.20wasi-nn.html#538542334">(Sep 09 2025 at 22:36)</a>:</h4>
<p>Yes, I believe you will want the guest to drop the tensor once you're done with it in whatever language you are using wasi-nn (what language <em>are</em> you using?). The appropriate <code>self.table.delete(...)</code> invocation happens in <code>HostTensor::drop</code>: <a href="https://github.com/bytecodealliance/wasmtime/blob/9d64c5250fa6d1eb1541c4e2d26da0ca6608ae21/crates/wasi-nn/src/wit.rs#L321-L324">https://github.com/bytecodealliance/wasmtime/blob/9d64c5250fa6d1eb1541c4e2d26da0ca6608ae21/crates/wasi-nn/src/wit.rs#L321-L324</a>.</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/blob/9d64c5250fa6d1eb1541c4e2d26da0ca6608ae21/crates/wasi-nn/src/wit.rs#L321-L324" style="background-image: url(&quot;https://uploads.zulipusercontent.net/0ed6d52e25463d390f1a1baec3fbca98911560a1/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f316132303131303430653630356330313132623730656236306634333163316134303130666435303666353639343134356530303937396538373638636236662f62797465636f6465616c6c69616e63652f7761736d74696d65&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/blob/9d64c5250fa6d1eb1541c4e2d26da0ca6608ae21/crates/wasi-nn/src/wit.rs#L321-L324" title="wasmtime/crates/wasi-nn/src/wit.rs at 9d64c5250fa6d1eb1541c4e2d26da0ca6608ae21 · bytecodealliance/wasmtime">wasmtime/crates/wasi-nn/src/wit.rs at 9d64c5250fa6d1eb1541c4e2d26da0ca6608ae21 · bytecodealliance/wasmtime</a></div><div class="message_embed_description">A lightweight WebAssembly runtime that is fast, secure, and standards-compliant - bytecodealliance/wasmtime</div></div></div>



<a name="538757256"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/memory%20leak%20in%20wasi-nn/near/538757256" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Masahiro Kozuka <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/memory.20leak.20in.20wasi-nn.html#538757256">(Sep 11 2025 at 00:56)</a>:</h4>
<p>Thank you for your reply! I'm using Rust. I think that it is the best to invoke self.table.delete() in HostTensor::drop(), but I have no idea to invoke HostTensor::drop() from guest.</p>
<p>The following is my guest code:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">tensor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Tensor</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tensor_dim</span><span class="p">,</span><span class="w"> </span><span class="n">TensorType</span><span class="p">::</span><span class="n">Fp32</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">input_tensor</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">named_tensor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[(</span><span class="s">"images"</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span><span class="w"> </span><span class="n">tensor</span><span class="p">)];</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">outputs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctx</span><span class="p">.</span><span class="n">compute</span><span class="p">(</span><span class="n">named_tensor</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
</code></pre></div>
<p>In this code, the owenership of <code>tensor</code> will be passed, so HostTensor::drop will never be invoked. This is the reason why I suppose that we should invoke self.table.delete() in compute().</p>



<a name="539371480"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/memory%20leak%20in%20wasi-nn/near/539371480" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Masahiro Kozuka <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/memory.20leak.20in.20wasi-nn.html#539371480">(Sep 14 2025 at 00:37)</a>:</h4>
<p><span class="user-mention" data-user-id="254110">@Andrew Brown</span> What do you think about my understanding? Do I misunderstand something?</p>



<a name="539378878"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/memory%20leak%20in%20wasi-nn/near/539378878" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Brown <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/memory.20leak.20in.20wasi-nn.html#539378878">(Sep 14 2025 at 03:55)</a>:</h4>
<p>I had thought that passing a resource in a WIT signature meant borrowing but your example makes me rethink that: Rust certainly expects ownership to transfer there. I guess I'm uncertain now: <span class="user-mention" data-user-id="253992">@Pat Hickey</span>, does passing a resource as an argument transfer ownership or borrow the resource?</p>



<a name="539399476"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/memory%20leak%20in%20wasi-nn/near/539399476" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Christof Petig <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/memory.20leak.20in.20wasi-nn.html#539399476">(Sep 14 2025 at 11:10)</a>:</h4>
<p>If the argument is wrapped in <code>borrow&lt;&gt;</code> it isn't consumed, as is the self argument in methods. But transfer clearly is the default.</p>



<a name="539648117"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/memory%20leak%20in%20wasi-nn/near/539648117" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Brown <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/memory.20leak.20in.20wasi-nn.html#539648117">(Sep 15 2025 at 21:09)</a>:</h4>
<p>Ok, this makes sense. I was unaware of the own/borrow notation when I switched wasi-nn from WITX to WIT long ago, so <span class="user-mention" data-user-id="957722">@Masahiro Kozuka</span>'s change makes complete sense if we are passing ownership of the tensor. <span class="user-mention" data-user-id="957722">@Masahiro Kozuka</span>, do you want to submit a PR with this change?</p>



<a name="539648205"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/memory%20leak%20in%20wasi-nn/near/539648205" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Andrew Brown <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/memory.20leak.20in.20wasi-nn.html#539648205">(Sep 15 2025 at 21:09)</a>:</h4>
<p>In the future, we could debate changing the specification to borrow instead (probably the original intention), but for now this change would fix the bug.</p>



<a name="539706208"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/memory%20leak%20in%20wasi-nn/near/539706208" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Masahiro Kozuka <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/memory.20leak.20in.20wasi-nn.html#539706208">(Sep 16 2025 at 08:01)</a>:</h4>
<p>Thanks. I will submit a PR in a few days.</p>



<a name="539942175"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/memory%20leak%20in%20wasi-nn/near/539942175" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Masahiro Kozuka <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/memory.20leak.20in.20wasi-nn.html#539942175">(Sep 17 2025 at 07:06)</a>:</h4>
<p><span class="user-mention" data-user-id="254110">@Andrew Brown</span> I sent <a href="https://github.com/bytecodealliance/wasmtime/pull/11704">a PR</a>.</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/pull/11704" style="background-image: url(&quot;https://uploads.zulipusercontent.net/57fae3ed350a884e69cf5b533fb2a57e7e7673b6/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f316334633065653231396434373332323331653763336236326534373163376561373635633462316537383361623831616137326231356331613834616238332f62797465636f6465616c6c69616e63652f7761736d74696d652f70756c6c2f3131373034&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/pull/11704" title="fix a memory leak in wasi-nn by masa-koz · Pull Request #11704 · bytecodealliance/wasmtime">fix a memory leak in wasi-nn by masa-koz · Pull Request #11704 · bytecodealliance/wasmtime</a></div><div class="message_embed_description">This PR will fix a memory leak in wasi-nn, which does'nt free the tensor resource whose owenership is transferred. You can find a discussion in the zulip.</div></div></div>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
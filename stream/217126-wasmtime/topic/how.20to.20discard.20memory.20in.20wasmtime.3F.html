<html>
<head><meta charset="utf-8"><title>how to discard memory in wasmtime? · wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/index.html">wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/how.20to.20discard.20memory.20in.20wasmtime.3F.html">how to discard memory in wasmtime?</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="546613493"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/how%20to%20discard%20memory%20in%20wasmtime%3F/near/546613493" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Srayan Jana <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/how.20to.20discard.20memory.20in.20wasmtime.3F.html#546613493">(Oct 23 2025 at 08:00)</a>:</h4>
<p>I’m aware that this isn’t part of the wasm spec yet (see <a href="https://github.com/WebAssembly/design/issues/1397">https://github.com/WebAssembly/design/issues/1397</a><br>
<a href="https://github.com/WebAssembly/memory-control/issues/7">https://github.com/WebAssembly/memory-control/issues/7</a>)<br>
But is there some sort of unofficial wasmtime extension or something to detect when memory isn’t being use and shrink it?</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/WebAssembly/design/issues/1397" style="background-image: url(&quot;https://uploads.zulipusercontent.net/3ce067d510e331c9557895f357652ccce5dfe5d1/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f623038393731336434613534633936386162616361343735303039313035636338373066653331613861383063663561336562356665616530306239313030652f576562417373656d626c792f64657369676e2f6973737565732f31333937&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/WebAssembly/design/issues/1397" title="Wasm needs a better memory management story · Issue #1397 · WebAssembly/design">Wasm needs a better memory management story · Issue #1397 · WebAssembly/design</a></div><div class="message_embed_description">Hi all, after a video call with google last week, I was encouraged to raise a conversation here around issues we at Unity have with Wasm memory allocation. The short summary is that currently Wasm ...</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/WebAssembly/memory-control/issues/7" style="background-image: url(&quot;https://uploads.zulipusercontent.net/28ebf6963a685123d3487c7c0953411c36dbc6ca/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f353931346534303738613537313564396339643737663138373431366433653762363266616231666634356638323037336632313733643638353630343930312f576562417373656d626c792f6d656d6f72792d636f6e74726f6c2f6973737565732f37&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/WebAssembly/memory-control/issues/7" title="`memory.discard` in a separate proposal? · Issue #7 · WebAssembly/memory-control">`memory.discard` in a separate proposal? · Issue #7 · WebAssembly/memory-control</a></div><div class="message_embed_description">Hi! I think it would be better to put the memory.discard instruction into a separate proposal. Grouping this instruction with other features is not strictly necessary and slows down the work on it....</div></div></div>



<a name="546634959"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/how%20to%20discard%20memory%20in%20wasmtime%3F/near/546634959" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/how.20to.20discard.20memory.20in.20wasmtime.3F.html#546634959">(Oct 23 2025 at 09:43)</a>:</h4>
<p>This topic was moved here from <a class="stream-topic" data-stream-id="206238" href="/#narrow/channel/206238-general/topic/how.20to.20discard.20memory.20in.20wasmtime.3F">#general &gt; how to discard memory in wasmtime?</a> by <span class="user-mention silent" data-user-id="234973">Till Schneidereit</span>.</p>



<a name="546636948"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/how%20to%20discard%20memory%20in%20wasmtime%3F/near/546636948" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/how.20to.20discard.20memory.20in.20wasmtime.3F.html#546636948">(Oct 23 2025 at 09:54)</a>:</h4>
<p>There isn't, no. Wasmtime doesn't do unofficial extensions, because those fracture the ecosystem. As documented <a href="https://docs.wasmtime.dev/stability-wasm-proposals.html#feature-requirements">here</a>, we have <a href="https://docs.wasmtime.dev/stability-tiers.html#tier-details">strict requirements for shipping functionality</a></p>



<a name="546744899"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/how%20to%20discard%20memory%20in%20wasmtime%3F/near/546744899" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Srayan Jana <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/how.20to.20discard.20memory.20in.20wasmtime.3F.html#546744899">(Oct 23 2025 at 18:27)</a>:</h4>
<p>O okay, so in the meantime, do you just set a maximum for heap memory and just never go past that?</p>



<a name="546749209"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/how%20to%20discard%20memory%20in%20wasmtime%3F/near/546749209" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/how.20to.20discard.20memory.20in.20wasmtime.3F.html#546749209">(Oct 23 2025 at 18:54)</a>:</h4>
<p>A <code>ResourceLimiter</code> and/or pooling allocator configuration settings can be used to limit memory growth, yes</p>



<a name="546749246"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/how%20to%20discard%20memory%20in%20wasmtime%3F/near/546749246" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/how.20to.20discard.20memory.20in.20wasmtime.3F.html#546749246">(Oct 23 2025 at 18:54)</a>:</h4>
<p>Once memory is allocated to an instance though there's no way to make it go away</p>



<a name="546749274"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/how%20to%20discard%20memory%20in%20wasmtime%3F/near/546749274" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/how.20to.20discard.20memory.20in.20wasmtime.3F.html#546749274">(Oct 23 2025 at 18:54)</a>:</h4>
<p>without deallocating the whole store that is</p>



<a name="546754288"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/how%20to%20discard%20memory%20in%20wasmtime%3F/near/546754288" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/how.20to.20discard.20memory.20in.20wasmtime.3F.html#546754288">(Oct 23 2025 at 19:25)</a>:</h4>
<p>In general, because allocating new instances is fast (~5 microseconds), the recommended method for reclaiming a Wasm instance's memory is to simply discard the <code>Store</code> and <code>Instance</code> and then create new ones when new work comes in (e.g. a new HTTP request)</p>



<a name="546763316"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/how%20to%20discard%20memory%20in%20wasmtime%3F/near/546763316" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Celarye <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/how.20to.20discard.20memory.20in.20wasmtime.3F.html#546763316">(Oct 23 2025 at 20:22)</a>:</h4>
<p>I personally use static variables to keep some in memory state for my components which I need throughout the whole runtime, example:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="n">CONTEXT</span><span class="p">:</span><span class="w"> </span><span class="nc">LazyLock</span><span class="o">&lt;</span><span class="n">Plugin</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LazyLock</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">||</span><span class="w"> </span><span class="n">Plugin</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">http_client</span><span class="p">:</span><span class="w"> </span><span class="nc">HttpClient</span><span class="p">::</span><span class="n">new</span><span class="p">(),</span>
<span class="w">    </span><span class="n">storred_settings</span><span class="p">:</span><span class="w"> </span><span class="nc">RwLock</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">PluginStoredSettings</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="o">..</span><span class="p">.</span>
<span class="w">    </span><span class="p">}),</span>
<span class="w">    </span><span class="n">stats</span><span class="p">:</span><span class="w"> </span><span class="nc">RwLock</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">PluginStats</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="o">..</span><span class="p">.</span>
<span class="w">    </span><span class="p">}),</span>
<span class="p">});</span>
</code></pre></div>
<p>So I think that in my case dropping and recreating the <code>Store</code> and <code>Instance</code> would not really be ideal <span aria-label="sweat smile" class="emoji emoji-1f605" role="img" title="sweat smile">:sweat_smile:</span>. I assumed the GC proposal was supposed to help with this down the line, but this is not yet implemented for the component-model?</p>



<a name="546763835"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/how%20to%20discard%20memory%20in%20wasmtime%3F/near/546763835" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/how.20to.20discard.20memory.20in.20wasmtime.3F.html#546763835">(Oct 23 2025 at 20:26)</a>:</h4>
<p>under the hood our GC implementation also does not free/discard memory, though you're right that semantically the spec allows that (garbage is unreachable by definition so it would be unobservable to reclaim backing store).</p>
<p>Our usual answer for expensive pre-initialized state is either instance reuse if your security threat model tolerates it (wasmtime now has a knob for this for wasip3 at least, as of recently, IIRC?) or pre-initialization and snapshotting with a tool like Wizer; then the initial state from the PoV of the core Wasm engine already has that state baked in.</p>



<a name="546767911"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/how%20to%20discard%20memory%20in%20wasmtime%3F/near/546767911" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/how.20to.20discard.20memory.20in.20wasmtime.3F.html#546767911">(Oct 23 2025 at 20:54)</a>:</h4>
<blockquote>
<p>instance reuse if your security threat model tolerates it (wasmtime now has a knob for this for wasip3 at least, as of recently, IIRC?)</p>
</blockquote>
<p>the new knob is specific to <code>wasmtime serve</code> in the wasmtime-cli, but its functionality is built out of "ordinary" wasmtime crate functionality that can be built into any embedding</p>



<a name="546768184"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/how%20to%20discard%20memory%20in%20wasmtime%3F/near/546768184" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/how.20to.20discard.20memory.20in.20wasmtime.3F.html#546768184">(Oct 23 2025 at 20:56)</a>:</h4>
<p>Right, sorry, to be clear -- one can do it in an ad-hoc way today; I just meant the ready-to-go option.</p>



<a name="546768358"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/how%20to%20discard%20memory%20in%20wasmtime%3F/near/546768358" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/how.20to.20discard.20memory.20in.20wasmtime.3F.html#546768358">(Oct 23 2025 at 20:57)</a>:</h4>
<p>Also, just to make sure you're tracking all the options and dependencies <span class="user-mention" data-user-id="941481">@Celarye</span> -- you mentioned GC as allowing memory reclamation, semantically; but presence of that proposal won't magically let guests written in, e.g., Rust, relinquish memory. You'd need a guest toolchain+language that specifically uses only GC objects (then one would need to do the engine work to reclaim backing after GC). Just want to make sure that's explicit :-)</p>



<a name="546780437"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/how%20to%20discard%20memory%20in%20wasmtime%3F/near/546780437" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Celarye <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/how.20to.20discard.20memory.20in.20wasmtime.3F.html#546780437">(Oct 23 2025 at 22:56)</a>:</h4>
<p>Hoh, I am not really sure what to do now.</p>
<p>To give some context as to what I am trying to achieve. I am writing a Discord bot and all of its functionality is covered by plugins (WASI components). At the moment I just re-use the same stores and instances per plugin throughout the whole runtime of the program. It would just run 24/7 and make many calls into those components.</p>
<p>But if I understand it correctly, those stores and instances never release memory and they will end up using more and more over time (even if in traditional programs this memory would be released)? Meaning I will need to have a way to clear the memory it has consumed but retain the global state (which I currently rely on for between calls).</p>



<a name="546781032"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/how%20to%20discard%20memory%20in%20wasmtime%3F/near/546781032" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/how.20to.20discard.20memory.20in.20wasmtime.3F.html#546781032">(Oct 23 2025 at 23:02)</a>:</h4>
<blockquote>
<p>those stores and instances never release memory and they will end up using more and more over time (even if in traditional programs this memory would be released)?</p>
</blockquote>
<p>That's not the case: a program with a stable working set size should reach equilibrium with a stable memory footprint for the <code>Store</code> over time.</p>
<p>In more detail: a Wasm guest with a linear memory controls its own memory allocation; its linear memory is allocated by a <code>malloc</code> function inside the guest, typically. The component model canonical ABI gives a specified interface to this (<code>cabi_realloc</code>) so that the host can allocate buffers inside the guest to receive call arguments, etc. All memory so allocated will normally be freed. Of course, "freed" in this case means "returned to the allocator inside the linear memory". So the linear memory will never shrink (is not allowed to do so by spec), but it also will not grow without bound with a normal malloc/free/... loop.</p>



<a name="546781061"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/how%20to%20discard%20memory%20in%20wasmtime%3F/near/546781061" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/how.20to.20discard.20memory.20in.20wasmtime.3F.html#546781061">(Oct 23 2025 at 23:02)</a>:</h4>
<p>To put it in traditional Unix terms: it's like a libc implementation of malloc that can <code>mmap</code> to get more chunks over time, but never returns those chunks to the OS. You can still malloc/free inside the process and reuse memory that way. "Process" maps to "Wasm instance" in this case.</p>



<a name="546781581"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/how%20to%20discard%20memory%20in%20wasmtime%3F/near/546781581" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Celarye <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/how.20to.20discard.20memory.20in.20wasmtime.3F.html#546781581">(Oct 23 2025 at 23:08)</a>:</h4>
<p>I see, thank you for explaining. I think I'm pretty happy with my current implementation then. I will however look into <code>ResourceLimiter</code> and/or pooling allocator configuration settings as well.</p>



<a name="547002866"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/how%20to%20discard%20memory%20in%20wasmtime%3F/near/547002866" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/how.20to.20discard.20memory.20in.20wasmtime.3F.html#547002866">(Oct 24 2025 at 21:39)</a>:</h4>
<p><span class="user-mention silent" data-user-id="941481">Celarye</span> <a href="#narrow/channel/217126-wasmtime/topic/how.20to.20discard.20memory.20in.20wasmtime.3F/near/546780437">said</a>:</p>
<blockquote>
<p>I am writing a Discord bot and all of its functionality is covered by plugins (WASI components). At the moment I just re-use the same stores and instances per plugin throughout the whole runtime of the program. It would just run 24/7 and make many calls into those components.</p>
</blockquote>
<p>This makes sense and components for plugins is a good use case.</p>
<p>I personally would suggest architecting it so that the state lives/persists outside of the <code>Instance</code> and <code>Store</code>, and then create new <code>Instance</code>s and <code>Store</code>s for each time a user on discord pings the bot, or some other event happens that the bot's plugins will respond to (e.g. a new commit was pushed to a github repo that the bot is following or whatever). This also allows you to persist that state in a sqlite database or something, which additionally lets you easily restart the bot's whole process or migrate to a new virtual server instance or whatever.</p>



<a name="547008772"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/how%20to%20discard%20memory%20in%20wasmtime%3F/near/547008772" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Celarye <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/how.20to.20discard.20memory.20in.20wasmtime.3F.html#547008772">(Oct 24 2025 at 22:54)</a>:</h4>
<p>The issue is that I do not really have an idea of what state a plugin may or may not have. I could maybe look into providing host functions to read/write serialized data from/to an SQLite database or so but I feel like this would worsen the DX a bit.</p>
<p>So at this moment it's completely up to the plugin developer to implement this, I've given them access to file I/O as well in the case using that benefits them.</p>
<p>Though I will have to look into this and see if there is a nicer way to solve this because I think recreating new <code>Instance</code>s and <code>Store</code>s for each call is indeed what I want to work towards.</p>
<p>I am also not sure how this all will work once I switch to WASIp3. For example, can multiple calls be made to the same <code>Store</code> and <code>Instance</code> at the same time? But maybe that's another problem for later, when WASIp3 stabilizes. <span aria-label="laughing" class="emoji emoji-1f606" role="img" title="laughing">:laughing:</span></p>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
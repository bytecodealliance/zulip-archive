<html>
<head><meta charset="utf-8"><title>Enabling the wmemcheck compile-time feature by default 路 wasmtime 路 Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/index.html">wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Enabling.20the.20wmemcheck.20compile-time.20feature.20by.20default.html">Enabling the wmemcheck compile-time feature by default</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="512564552"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Enabling%20the%20wmemcheck%20compile-time%20feature%20by%20default/near/512564552" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Enabling.20the.20wmemcheck.20compile-time.20feature.20by.20default.html#512564552">(Apr 16 2025 at 14:15)</a>:</h4>
<p>Is there a strong reason why we wouldn't enable this by default at least for the CLI build? Having this available would be very useful for projects that use Wasmtime to run test suites, such as StarlingMonkey.</p>
<p>I couldn't find any comments on why it's not enabled by default, and it doesn't seem like it's pulling in some substantial amount of additional code</p>



<a name="512570914"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Enabling%20the%20wmemcheck%20compile-time%20feature%20by%20default/near/512570914" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Enabling.20the.20wmemcheck.20compile-time.20feature.20by.20default.html#512570914">(Apr 16 2025 at 14:41)</a>:</h4>
<p>I was under the impression it wasn't complete enough to be available by default. Have you used it though and it's caught things? (I've always assume it's got false positives/negaitves to reduce the utility)</p>



<a name="512588148"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Enabling%20the%20wmemcheck%20compile-time%20feature%20by%20default/near/512588148" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Enabling.20the.20wmemcheck.20compile-time.20feature.20by.20default.html#512588148">(Apr 16 2025 at 15:52)</a>:</h4>
<p>I have not yet used it, because it wasn't readily available <span aria-label="grimacing" class="emoji emoji-1f62c" role="img" title="grimacing">:grimacing:</span> I'll do a run of the StarlingMonkey test suite with it in a bit though, and report back</p>



<a name="512588286"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Enabling%20the%20wmemcheck%20compile-time%20feature%20by%20default/near/512588286" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Enabling.20the.20wmemcheck.20compile-time.20feature.20by.20default.html#512588286">(Apr 16 2025 at 15:53)</a>:</h4>
<p><span class="user-mention" data-user-id="254389">@Chris Fallin</span> you worked on this, right? Do you have any recollection of what the reasoning was?</p>



<a name="512588580"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Enabling%20the%20wmemcheck%20compile-time%20feature%20by%20default/near/512588580" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Enabling.20the.20wmemcheck.20compile-time.20feature.20by.20default.html#512588580">(Apr 16 2025 at 15:54)</a>:</h4>
<p>I believe it is just very much a beta feature: incomplete and somewhat buggy</p>
<p>no one has worked on it since the original intern who developed it</p>



<a name="512588674"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Enabling%20the%20wmemcheck%20compile-time%20feature%20by%20default/near/512588674" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Enabling.20the.20wmemcheck.20compile-time.20feature.20by.20default.html#512588674">(Apr 16 2025 at 15:55)</a>:</h4>
<p>(meetings, will have a response in a few hours)</p>



<a name="512594404"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Enabling%20the%20wmemcheck%20compile-time%20feature%20by%20default/near/512594404" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Enabling.20the.20wmemcheck.20compile-time.20feature.20by.20default.html#512594404">(Apr 16 2025 at 16:19)</a>:</h4>
<p>ok, brief thoughts: yes, I mentored the intern who built it. The current status is that it doesn't quite capture every C stdlib call one would want to capture to track allocations properly. The thought when we upstreamed it was that we wanted it in tree so it would get further contributions and refinements, and indeed we have seen at least one PR to enhance it, IIRC; but I wouldn't be comfortable having it be an advertised option until we know it works well</p>



<a name="512594612"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Enabling%20the%20wmemcheck%20compile-time%20feature%20by%20default/near/512594612" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Enabling.20the.20wmemcheck.20compile-time.20feature.20by.20default.html#512594612">(Apr 16 2025 at 16:20)</a>:</h4>
<p>I'd be curious what you find with StarlingMonkey tests, <span class="user-mention" data-user-id="234973">@Till Schneidereit</span> -- either it will (to my surprise) Just Work, or we'll find some holes that may not be too bad to patch :-)</p>



<a name="512820937"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Enabling%20the%20wmemcheck%20compile-time%20feature%20by%20default/near/512820937" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Till Schneidereit <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Enabling.20the.20wmemcheck.20compile-time.20feature.20by.20default.html#512820937">(Apr 17 2025 at 12:59)</a>:</h4>
<p>Thank you for the context, <span class="user-mention" data-user-id="254389">@Chris Fallin</span>, much appreciated!</p>
<p>Turns out it does indeed not Just Work for StarlingMonkey. Instead, it complains about the very first load, <a href="https://github.com/bytecodealliance/StarlingMonkey/blob/main/host-apis/wasi-0.2.0/host_api.cpp#L1033">here</a>. In the test case where this error occurs, <code>REQUEST_HANDLER</code> is at this point definitely initialized, via <a href="https://github.com/bytecodealliance/StarlingMonkey/blob/main/host-apis/wasi-0.2.0/host_api.cpp#L1008">set_handler</a>, invoked <a href="https://github.com/bytecodealliance/StarlingMonkey/blob/main/builtins/web/fetch/fetch_event.cpp#L618">here</a>. Given that none of this involves any allocations, this seems like a false positive?</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/StarlingMonkey/blob/main/host-apis/wasi-0.2.0/host_api.cpp#L1033" style="background-image: url(&quot;https://uploads.zulipusercontent.net/aaf68eddedcec7a4ae92825a3103ed76fd2b94ed/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f373136336534333439393235333137643465613639373133646532666563343130356335316233636339383163393364333363356536316631663763316132632f62797465636f6465616c6c69616e63652f537461726c696e674d6f6e6b6579&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/StarlingMonkey/blob/main/host-apis/wasi-0.2.0/host_api.cpp#L1033" title="StarlingMonkey/host-apis/wasi-0.2.0/host_api.cpp at main 路 bytecodealliance/StarlingMonkey">StarlingMonkey/host-apis/wasi-0.2.0/host_api.cpp at main 路 bytecodealliance/StarlingMonkey</a></div><div class="message_embed_description">The StarlingMonkey JS runtime. Contribute to bytecodealliance/StarlingMonkey development by creating an account on GitHub.</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/StarlingMonkey/blob/main/host-apis/wasi-0.2.0/host_api.cpp#L1008" style="background-image: url(&quot;https://uploads.zulipusercontent.net/aaf68eddedcec7a4ae92825a3103ed76fd2b94ed/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f373136336534333439393235333137643465613639373133646532666563343130356335316233636339383163393364333363356536316631663763316132632f62797465636f6465616c6c69616e63652f537461726c696e674d6f6e6b6579&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/StarlingMonkey/blob/main/host-apis/wasi-0.2.0/host_api.cpp#L1008" title="StarlingMonkey/host-apis/wasi-0.2.0/host_api.cpp at main 路 bytecodealliance/StarlingMonkey">StarlingMonkey/host-apis/wasi-0.2.0/host_api.cpp at main 路 bytecodealliance/StarlingMonkey</a></div><div class="message_embed_description">The StarlingMonkey JS runtime. Contribute to bytecodealliance/StarlingMonkey development by creating an account on GitHub.</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/StarlingMonkey/blob/main/builtins/web/fetch/fetch_event.cpp#L618" style="background-image: url(&quot;https://uploads.zulipusercontent.net/aaf68eddedcec7a4ae92825a3103ed76fd2b94ed/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f373136336534333439393235333137643465613639373133646532666563343130356335316233636339383163393364333363356536316631663763316132632f62797465636f6465616c6c69616e63652f537461726c696e674d6f6e6b6579&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/StarlingMonkey/blob/main/builtins/web/fetch/fetch_event.cpp#L618" title="StarlingMonkey/builtins/web/fetch/fetch_event.cpp at main 路 bytecodealliance/StarlingMonkey">StarlingMonkey/builtins/web/fetch/fetch_event.cpp at main 路 bytecodealliance/StarlingMonkey</a></div><div class="message_embed_description">The StarlingMonkey JS runtime. Contribute to bytecodealliance/StarlingMonkey development by creating an account on GitHub.</div></div></div>



<a name="512858099"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Enabling%20the%20wmemcheck%20compile-time%20feature%20by%20default/near/512858099" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Enabling.20the.20wmemcheck.20compile-time.20feature.20by.20default.html#512858099">(Apr 17 2025 at 15:40)</a>:</h4>
<p>Maybe, it's hard to say -- this sort of issue I'd need to dig deeply into with <code>rr</code> probably and unfortunately don't have the cycles right now</p>



<a name="512858652"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Enabling%20the%20wmemcheck%20compile-time%20feature%20by%20default/near/512858652" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Enabling.20the.20wmemcheck.20compile-time.20feature.20by.20default.html#512858652">(Apr 17 2025 at 15:43)</a>:</h4>
<p>I don't think wmemcheck has the concept of static <code>.data</code> sections, it assumes everything is heap-allocated or stack allocated, so Till because your variable is in <code>.data</code> that's why it's a false positive</p>



<a name="512859591"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Enabling%20the%20wmemcheck%20compile-time%20feature%20by%20default/near/512859591" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Enabling.20the.20wmemcheck.20compile-time.20feature.20by.20default.html#512859591">(Apr 17 2025 at 15:48)</a>:</h4>
<p>Oh, yes, this is a tricky case -- it doesn't have any information about memory layout (unlike, say, Valgrind which can look at the ELF headers of the program it's running) so it doesn't know where static data ends and heap begins. IIRC we discussed a heuristic "assume the initial memory size is all global data" but that leads to poor behavior when static data is much less than 64k. We similarly bake in an assumption about where LLVM places the shadow stack</p>



<a name="512859643"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217126-wasmtime/topic/Enabling%20the%20wmemcheck%20compile-time%20feature%20by%20default/near/512859643" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217126-wasmtime/topic/Enabling.20the.20wmemcheck.20compile-time.20feature.20by.20default.html#512859643">(Apr 17 2025 at 15:48)</a>:</h4>
<p>In an ideal world, there would be a well-specified custom section that gives this information, produced by <code>wasm-ld</code>, that wmemcheck could consume</p>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
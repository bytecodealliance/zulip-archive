<html>
<head><meta charset="utf-8"><title>How are lists allocated in WIT? · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/index.html">general</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/How.20are.20lists.20allocated.20in.20WIT.3F.html">How are lists allocated in WIT?</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="503321038"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/How%20are%20lists%20allocated%20in%20WIT%3F/near/503321038" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sekoia <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/How.20are.20lists.20allocated.20in.20WIT.3F.html#503321038">(Mar 04 2025 at 17:11)</a>:</h4>
<p>Hiya. I'm trying to reverse-engineering the generated bindings of WASIp2, and I noticed something strange:<br>
In <a href="http://InputStream.read">InputStream.read</a>, the generated bindings are:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">read</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">:</span><span class="w"> </span><span class="kt">u64</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">_rt</span><span class="p">::</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">StreamError</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="cp">#[repr(align(4))]</span>
<span class="w">                        </span><span class="k">struct</span><span class="w"> </span><span class="nc">RetArea</span><span class="p">([::</span><span class="n">core</span><span class="p">::</span><span class="n">mem</span><span class="p">::</span><span class="n">MaybeUninit</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">;</span><span class="w"> </span><span class="mi">12</span><span class="p">]);</span>
<span class="w">                        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">ret_area</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RetArea</span><span class="p">(</span>
<span class="w">                            </span><span class="p">[::</span><span class="n">core</span><span class="p">::</span><span class="n">mem</span><span class="p">::</span><span class="n">MaybeUninit</span><span class="p">::</span><span class="n">uninit</span><span class="p">();</span><span class="w"> </span><span class="mi">12</span><span class="p">],</span>
<span class="w">                        </span><span class="p">);</span>
<span class="w">                        </span><span class="kd">let</span><span class="w"> </span><span class="n">ptr0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ret_area</span><span class="p">.</span><span class="mf">0.</span><span class="n">as_mut_ptr</span><span class="p">().</span><span class="n">cast</span><span class="p">::</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">();</span>
<span class="w">                        </span><span class="cp">#[cfg(target_arch = </span><span class="s">"wasm32"</span><span class="cp">)]</span>
<span class="w">                        </span><span class="cp">#[link(wasm_import_module = </span><span class="s">"wasi:io/streams@0.2.4"</span><span class="cp">)]</span>
<span class="w">                        </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="p">{</span>
<span class="w">                            </span><span class="cp">#[link_name = </span><span class="s">"[method]input-stream.read"</span><span class="cp">]</span>
<span class="w">                            </span><span class="k">fn</span><span class="w"> </span><span class="nf">wit_import1</span><span class="p">(</span><span class="n">_</span><span class="p">:</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">:</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">u8</span><span class="p">);</span>
<span class="w">                        </span><span class="p">}</span>
<span class="w">                        </span><span class="cp">#[cfg(not(target_arch = </span><span class="s">"wasm32"</span><span class="cp">))]</span>
<span class="w">                        </span><span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">wit_import1</span><span class="p">(</span><span class="n">_</span><span class="p">:</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">:</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">u8</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                            </span><span class="fm">unreachable!</span><span class="p">()</span>
<span class="w">                        </span><span class="p">}</span>
<span class="w">                        </span><span class="n">wit_import1</span><span class="p">((</span><span class="bp">self</span><span class="p">).</span><span class="n">handle</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">_rt</span><span class="p">::</span><span class="n">as_i64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">len</span><span class="p">),</span><span class="w"> </span><span class="n">ptr0</span><span class="p">);</span>
<span class="w">                        </span><span class="kd">let</span><span class="w"> </span><span class="n">l2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">i32</span><span class="p">::</span><span class="n">from</span><span class="p">(</span><span class="o">*</span><span class="n">ptr0</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">cast</span><span class="p">::</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">());</span>
<span class="w">                        </span><span class="kd">let</span><span class="w"> </span><span class="n">result9</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">l2</span><span class="w"> </span><span class="p">{</span>
<span class="w">                            </span><span class="mi">0</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                                </span><span class="kd">let</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">                                    </span><span class="kd">let</span><span class="w"> </span><span class="n">l3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">ptr0</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span><span class="n">cast</span><span class="p">::</span><span class="o">&lt;*</span><span class="k">mut</span><span class="w"> </span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">();</span>
<span class="w">                                    </span><span class="kd">let</span><span class="w"> </span><span class="n">l4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">ptr0</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="mi">8</span><span class="p">).</span><span class="n">cast</span><span class="p">::</span><span class="o">&lt;</span><span class="kt">usize</span><span class="o">&gt;</span><span class="p">();</span>
<span class="w">                                    </span><span class="kd">let</span><span class="w"> </span><span class="n">len5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">l4</span><span class="p">;</span>
<span class="w">                                    </span><span class="n">_rt</span><span class="p">::</span><span class="nb">Vec</span><span class="p">::</span><span class="n">from_raw_parts</span><span class="p">(</span><span class="n">l3</span><span class="p">.</span><span class="n">cast</span><span class="p">(),</span><span class="w"> </span><span class="n">len5</span><span class="p">,</span><span class="w"> </span><span class="n">len5</span><span class="p">)</span>
<span class="w">                                </span><span class="p">};</span>
<span class="w">                                </span><span class="nb">Ok</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<span class="w">                            </span><span class="p">}</span>
<span class="w">                            </span><span class="mi">1</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                                </span><span class="kd">let</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">                                    </span><span class="kd">let</span><span class="w"> </span><span class="n">l6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">i32</span><span class="p">::</span><span class="n">from</span><span class="p">(</span><span class="o">*</span><span class="n">ptr0</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span><span class="n">cast</span><span class="p">::</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">());</span>
<span class="w">                                    </span><span class="kd">let</span><span class="w"> </span><span class="n">v8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">l6</span><span class="w"> </span><span class="p">{</span>
<span class="w">                                        </span><span class="mi">0</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                                            </span><span class="kd">let</span><span class="w"> </span><span class="n">e8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">                                                </span><span class="kd">let</span><span class="w"> </span><span class="n">l7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">ptr0</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="mi">8</span><span class="p">).</span><span class="n">cast</span><span class="p">::</span><span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;</span><span class="p">();</span>
<span class="w">                                                </span><span class="k">super</span><span class="p">::</span><span class="k">super</span><span class="p">::</span><span class="k">super</span><span class="p">::</span><span class="n">wasi</span><span class="p">::</span><span class="n">io</span><span class="p">::</span><span class="n">error</span><span class="p">::</span><span class="n">Error</span><span class="p">::</span><span class="n">from_handle</span><span class="p">(</span>
<span class="w">                                                    </span><span class="n">l7</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u32</span><span class="p">,</span>
<span class="w">                                                </span><span class="p">)</span>
<span class="w">                                            </span><span class="p">};</span>
<span class="w">                                            </span><span class="n">StreamError</span><span class="p">::</span><span class="n">LastOperationFailed</span><span class="p">(</span><span class="n">e8</span><span class="p">)</span>
<span class="w">                                        </span><span class="p">}</span>
<span class="w">                                        </span><span class="n">n</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                                            </span><span class="fm">debug_assert_eq!</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s">"invalid enum discriminant"</span><span class="p">);</span>
<span class="w">                                            </span><span class="n">StreamError</span><span class="p">::</span><span class="n">Closed</span>
<span class="w">                                        </span><span class="p">}</span>
<span class="w">                                    </span><span class="p">};</span>
<span class="w">                                    </span><span class="n">v8</span>
<span class="w">                                </span><span class="p">};</span>
<span class="w">                                </span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<span class="w">                            </span><span class="p">}</span>
<span class="w">                            </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">_rt</span><span class="p">::</span><span class="n">invalid_enum_discriminant</span><span class="p">(),</span>
<span class="w">                        </span><span class="p">};</span>
<span class="w">                        </span><span class="n">result9</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span>
</code></pre></div>
<p>Specifically: the location the stream writes to isn't passed as an argument, but it is given as a return value. That means that the input stream  is somehow "allocating" memory, no? How is that safe? How does the host decide where to put the read data? (also, from <code>_rt::as_i64(&amp;len)</code>, it seems like the length is passed as a reference to a u64, which seems weird since it's the same size?)</p>
<p>I've tried to read the canonical ABI, but it's... not easy, and it's relatively subtle details here. It'd be great if there was some "debug view" of lowered functions/types... (idle thought, nothing else).</p>



<a name="503326647"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/How%20are%20lists%20allocated%20in%20WIT%3F/near/503326647" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/How.20are.20lists.20allocated.20in.20WIT.3F.html#503326647">(Mar 04 2025 at 17:39)</a>:</h4>
<p>The <code>len</code> there is "I'd like to read up to this amount" and the result is dynamically allocated into the guest with <code>cabi_realloc</code>, and that return pointer is stored in the <code>ptr0</code> return value area</p>



<a name="503327764"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/How%20are%20lists%20allocated%20in%20WIT%3F/near/503327764" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sekoia <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/How.20are.20lists.20allocated.20in.20WIT.3F.html#503327764">(Mar 04 2025 at 17:45)</a>:</h4>
<p>Where is <code>cabi_realloc</code> documented, and how does it decide where it can write?</p>



<a name="503327920"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/How%20are%20lists%20allocated%20in%20WIT%3F/near/503327920" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/How.20are.20lists.20allocated.20in.20WIT.3F.html#503327920">(Mar 04 2025 at 17:46)</a>:</h4>
<p>it's documented <a href="https://github.com/WebAssembly/component-model/blob/main/design/mvp/CanonicalABI.md">here</a>, along with everything else about the canonical abi</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/WebAssembly/component-model/blob/main/design/mvp/CanonicalABI.md" style="background-image: url(&quot;https://uploads.zulipusercontent.net/f1833b3aeca138b5ec0bd919acde9997bccd785c/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f613034663532383936313633653862303938366436343038636663313132633934393232386366363235613766643736613635303761333564643534633935392f576562417373656d626c792f636f6d706f6e656e742d6d6f64656c&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/WebAssembly/component-model/blob/main/design/mvp/CanonicalABI.md" title="component-model/design/mvp/CanonicalABI.md at main · WebAssembly/component-model">component-model/design/mvp/CanonicalABI.md at main · WebAssembly/component-model</a></div><div class="message_embed_description">Repository for design and specification of the Component Model - WebAssembly/component-model</div></div></div>



<a name="503328175"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/How%20are%20lists%20allocated%20in%20WIT%3F/near/503328175" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sekoia <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/How.20are.20lists.20allocated.20in.20WIT.3F.html#503328175">(Mar 04 2025 at 17:47)</a>:</h4>
<p>Oh, the c stands for <em>canonical</em>, not C. Makes sense (and it's documented as <code>realloc</code> in there). So any WIT component that needs it must export a <code>realloc</code> function, then? Interesting!</p>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
<html>
<head><meta charset="utf-8"><title>Pollable in tokio · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/index.html">general</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Pollable.20in.20tokio.html">Pollable in tokio</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="545827532"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Pollable%20in%20tokio/near/545827532" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Pollable.20in.20tokio.html#545827532">(Oct 19 2025 at 12:43)</a>:</h4>
<p>Hello, I have a problem with Pollable in wasmtime.</p>
<p>I have:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[async_trait]</span>
<span class="k">impl</span><span class="w"> </span><span class="n">Pollable</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">MyResource</span><span class="p">{</span>
<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="n">ready</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">){</span>
<span class="w">    </span><span class="n">eprintln</span><span class="p">(</span><span class="s">"ready - 1"</span><span class="p">);</span>
<span class="w">    </span><span class="n">tokio</span><span class="p">::</span><span class="n">time</span><span class="p">::</span><span class="n">sleep</span><span class="p">(</span><span class="n">tokio</span><span class="p">::</span><span class="n">time</span><span class="p">::</span><span class="n">Duration</span><span class="p">::</span><span class="n">from_secs</span><span class="p">(</span><span class="mi">3</span><span class="p">)).</span><span class="k">await</span><span class="p">;</span>
<span class="w">    </span><span class="n">eprintln</span><span class="p">(</span><span class="s">"ready - 2"</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>The sleep timer never clicks. I only see "ready - 1" in the logs.  I never see "ready - 2".  Is this because I call Ready() before Block() inside my wasm guest?</p>



<a name="545857297"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Pollable%20in%20tokio/near/545857297" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Pollable.20in.20tokio.html#545857297">(Oct 19 2025 at 21:13)</a>:</h4>
<p>so just to set the table there are two different <code>ready</code>s: <code>pollable.ready</code> the wit method, and <code>async fn Pollable::ready(&amp;mut self)</code> the Rust method</p>



<a name="545857396"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Pollable%20in%20tokio/near/545857396" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Pollable.20in.20tokio.html#545857396">(Oct 19 2025 at 21:15)</a>:</h4>
<p><code>pollable.block</code> is equivalent to <code>Pollable::ready(&amp;mut pollable_resource).await</code>. <code>pollable.ready</code> is equivalent to <code>futures::future::[poll_immediate](https://docs.rs/futures/latest/futures/future/fn.poll_immediate.html)(async { Pollable::ready(&amp;mut pollable_resource).await }).await</code>- basically it creates the future returned by the Pollable::ready method, and then it calls Future::poll on it exactly once, and returns true if it was <code>Poll::Ready</code> and false if it was <code>Poll::Pending</code></p>



<a name="545857417"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Pollable%20in%20tokio/near/545857417" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Pollable.20in.20tokio.html#545857417">(Oct 19 2025 at 21:16)</a>:</h4>
<p>Hi.  I am trying to implement the pollable.ready WIT method in the host.  So I implemented Pollable::read(&amp;mut self).  </p>
<p>I notice that if I add a panic after "read - 2" log line, that the future gets "read".</p>



<a name="545857453"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Pollable%20in%20tokio/near/545857453" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Pollable.20in.20tokio.html#545857453">(Oct 19 2025 at 21:16)</a>:</h4>
<p>yeah, thats intended</p>



<a name="545857464"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Pollable%20in%20tokio/near/545857464" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Pollable.20in.20tokio.html#545857464">(Oct 19 2025 at 21:16)</a>:</h4>
<p>whats going on there is that async {} block is changed by rustc to a Future</p>



<a name="545857481"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Pollable%20in%20tokio/near/545857481" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Pollable.20in.20tokio.html#545857481">(Oct 19 2025 at 21:17)</a>:</h4>
<p>the async block contains your eprintln!(1), then a function that will be Pending for 3 seconds and finally Ready, then eprintln!(2)</p>



<a name="545857495"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Pollable%20in%20tokio/near/545857495" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Pollable.20in.20tokio.html#545857495">(Oct 19 2025 at 21:17)</a>:</h4>
<p>But without the panic, the 3 second timer never lapses for me.</p>



<a name="545857502"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Pollable%20in%20tokio/near/545857502" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Pollable.20in.20tokio.html#545857502">(Oct 19 2025 at 21:17)</a>:</h4>
<p>correct, the panic is just the symptom</p>



<a name="545857504"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Pollable%20in%20tokio/near/545857504" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Pollable.20in.20tokio.html#545857504">(Oct 19 2025 at 21:18)</a>:</h4>
<p>what are you trying to achieve here</p>



<a name="545857522"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Pollable%20in%20tokio/near/545857522" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Pollable.20in.20tokio.html#545857522">(Oct 19 2025 at 21:18)</a>:</h4>
<p>theres a disconnect between your understanding of rust Futures and my docs and description of this interface, the differences are indeed subtle</p>



<a name="545857559"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Pollable%20in%20tokio/near/545857559" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Pollable.20in.20tokio.html#545857559">(Oct 19 2025 at 21:19)</a>:</h4>
<p>the goal of <code>async fn Pollable::ready</code> is that it becomes ready when the pollable is ready, but the method itself can be called a number of times (in calls to <code>pollable.ready</code> which is a nonblocking check, in calls to <code>pollable.block</code>, and in calls to <code>poll.poll</code>)</p>



<a name="545857561"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Pollable%20in%20tokio/near/545857561" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Pollable.20in.20tokio.html#545857561">(Oct 19 2025 at 21:19)</a>:</h4>
<p>I am trying to write a ready function using tokio async (ie a normal async function).  And my wasm guest calls Block(). I expect the host-side ready function to resolve after the timer elapses and the guest to unblock.</p>



<a name="545857589"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Pollable%20in%20tokio/near/545857589" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Pollable.20in.20tokio.html#545857589">(Oct 19 2025 at 21:20)</a>:</h4>
<p>so if you write an implementation of <code>Pollable::ready</code> that cant handle it being created and canceled arbitrarily you will not get what you want</p>



<a name="545857604"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Pollable%20in%20tokio/near/545857604" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Pollable.20in.20tokio.html#545857604">(Oct 19 2025 at 21:20)</a>:</h4>
<p>tell me more about what a normal async function is in your context.</p>



<a name="545857652"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Pollable%20in%20tokio/near/545857652" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Pollable.20in.20tokio.html#545857652">(Oct 19 2025 at 21:21)</a>:</h4>
<p>I have a flume channel I want to read from. But, I cannot even get a simple tokio timer to work.</p>



<a name="545857967"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Pollable%20in%20tokio/near/545857967" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Pollable.20in.20tokio.html#545857967">(Oct 19 2025 at 21:26)</a>:</h4>
<p>so, if you want to implement a pollable for something that is only ready 3 seconds after creation, you need to write the resource as storing the Instant at which it is ready, and impl Pollable with <code>tokio::time::sleep_until(self.instant).await</code>, see <a href="https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasi/src/p2/host/clocks.rs#L124">https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasi/src/p2/host/clocks.rs#L124</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasi/src/p2/host/clocks.rs#L124" style="background-image: url(&quot;https://uploads.zulipusercontent.net/fd8cc1e57b91f7a120ad0010773aee0b7a9e9508/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f633665353136363961363565333065383434326638316335336336363961663064666363366334643766336131323563303961346132323563313463303762342f62797465636f6465616c6c69616e63652f7761736d74696d65&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasi/src/p2/host/clocks.rs#L124" title="wasmtime/crates/wasi/src/p2/host/clocks.rs at main · bytecodealliance/wasmtime">wasmtime/crates/wasi/src/p2/host/clocks.rs at main · bytecodealliance/wasmtime</a></div><div class="message_embed_description">A lightweight WebAssembly runtime that is fast, secure, and standards-compliant - bytecodealliance/wasmtime</div></div></div>



<a name="545857991"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Pollable%20in%20tokio/near/545857991" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Pollable.20in.20tokio.html#545857991">(Oct 19 2025 at 21:27)</a>:</h4>
<p>because theres a difference between the creation of the resource itself, and the lifetime of the future given by the <code>Pollable::ready</code> function.</p>



<a name="545858031"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Pollable%20in%20tokio/near/545858031" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Pollable.20in.20tokio.html#545858031">(Oct 19 2025 at 21:27)</a>:</h4>
<p>theres a lot going on in there because of the way wasi works</p>



<a name="545858061"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Pollable%20in%20tokio/near/545858061" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Pollable.20in.20tokio.html#545858061">(Oct 19 2025 at 21:28)</a>:</h4>
<p>you'll have to read the source code of that clocks impl in wasmtime-wasi p2 and also the wasmtime-wasi-io implementation of pollable if you want to fully internalize it</p>



<a name="545858106"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Pollable%20in%20tokio/near/545858106" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Pollable.20in.20tokio.html#545858106">(Oct 19 2025 at 21:29)</a>:</h4>
<p>Thanks, I will take another crack at this focusing on the clock and wasi-io example.</p>



<a name="545858127"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Pollable%20in%20tokio/near/545858127" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Pollable.20in.20tokio.html#545858127">(Oct 19 2025 at 21:29)</a>:</h4>
<p>I am guessing the future canceling part is what I am missing, but I need to do more research to understand.</p>



<a name="545858140"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Pollable%20in%20tokio/near/545858140" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Pollable.20in.20tokio.html#545858140">(Oct 19 2025 at 21:29)</a>:</h4>
<p>you could also write your resource to contain a MaybeDone(your-fut) <a href="https://docs.rs/futures/latest/futures/future/enum.MaybeDone.html">https://docs.rs/futures/latest/futures/future/enum.MaybeDone.html</a> and then Pollable can await the MaybeDone, and when youre trying to add another method to the resource to get a thing out of your flume channel, you can use MaybeDone::output_mut to pop something out of the inside.</p>



<a name="545858176"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Pollable%20in%20tokio/near/545858176" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Pollable.20in.20tokio.html#545858176">(Oct 19 2025 at 21:30)</a>:</h4>
<p>Ah, this looks easier for me.</p>



<a name="545859350"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Pollable%20in%20tokio/near/545859350" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Pollable.20in.20tokio.html#545859350">(Oct 19 2025 at 21:54)</a>:</h4>
<p>I tried using a simple <code>tokio::time::sleep_until(*instant).await</code> just like the Clock example, but to no avail.  I am not sure how to use MaybeDone in the Pollable implementation.  </p>
<p>I tried defining an async block on every invocation of the ready function, then doing an await on the result.  However, that did not work either.</p>



<a name="545868541"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Pollable%20in%20tokio/near/545868541" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Pollable.20in.20tokio.html#545868541">(Oct 20 2025 at 00:56)</a>:</h4>
<p>Thanks. I appreciate the help, but there must be something else going on with my setup as the future is not being read. I tried your suggestion, but the timer never goes off.</p>
<p>I can't really understand why by putting a panic in a future the future is evaluated, but if I don't put a panic the future is never evaluated. So, I will do research on that.</p>



<a name="545869741"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Pollable%20in%20tokio/near/545869741" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Pollable.20in.20tokio.html#545869741">(Oct 20 2025 at 01:17)</a>:</h4>
<p>Ok, so, it looks like if I make multiple Ready calls from the wasm guest, all the Pollable futures get blocked. If I just do one call at a time from the guest, I don't get blocks.  This is similar to what someone told me in a previous question I asked on this forum, but I assumed that was for Block calls and not Ready calls.</p>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
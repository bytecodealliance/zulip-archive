<html>
<head><meta charset="utf-8"><title>Instrumenting wasi calls · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/index.html">general</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Instrumenting.20wasi.20calls.html">Instrumenting wasi calls</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="492797974"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Instrumenting%20wasi%20calls/near/492797974" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> celine santosh <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Instrumenting.20wasi.20calls.html#492797974">(Jan 09 2025 at 19:09)</a>:</h4>
<p>Hi</p>
<p>Is it possible to instrument wasmtime source code such that I can redirect all wasi calls to some monitor first before the actual wasi call?<br>
Is this feasible?</p>
<p>Thanks</p>



<a name="492799818"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Instrumenting%20wasi%20calls/near/492799818" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Instrumenting.20wasi.20calls.html#492799818">(Jan 09 2025 at 19:19)</a>:</h4>
<p>At a conceptual level this is possible because WASI is inserted by calling <code>add_to_linker</code> and you can instead add whatever you want to the linker instead (and avoid calling <code>add_to_linker</code>). From a practical standpoint that's difficult to do because you'd have to duplicate all the type signatures and such, however.</p>



<a name="492972032"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Instrumenting%20wasi%20calls/near/492972032" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> celine santosh <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Instrumenting.20wasi.20calls.html#492972032">(Jan 10 2025 at 15:22)</a>:</h4>
<p>Thanks, could you please also show a file in wasmtime repo where add_to_linker is called on a wasi function</p>



<a name="492972343"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Instrumenting%20wasi%20calls/near/492972343" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Instrumenting.20wasi.20calls.html#492972343">(Jan 10 2025 at 15:24)</a>:</h4>
<p>Ah alas I don't think we have an example of doing this, but the rough idea is that you'd call functions <a href="https://docs.rs/wasmtime-wasi/latest/wasmtime_wasi/preview1/wasi_snapshot_preview1/fn.environ_get.html">like this</a> manually.</p>



<a name="492972545"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Instrumenting%20wasi%20calls/near/492972545" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Instrumenting.20wasi.20calls.html#492972545">(Jan 10 2025 at 15:25)</a>:</h4>
<p>e.g. you'd create a <code>Linker</code>, add a custom function to it, and your custom function would forward to that.</p>
<p>Alternatively, now that I think about it, something that would be much more robust would be to write your own impl of <code>WasiSnapshotPreview1</code> which forwards to the <code>wasmtime-wasi</code> one, allowing you to interpose any function (although you're required to interpose all of them or at least forward arguments)</p>



<a name="492973804"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Instrumenting%20wasi%20calls/near/492973804" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Instrumenting.20wasi.20calls.html#492973804">(Jan 10 2025 at 15:32)</a>:</h4>
<p>Another option would be to create a component which both imports and exports all the interfaces in the <code>wasi-cli</code> <a href="https://github.com/WebAssembly/wasi-cli/blob/main/wit/imports.wit">imports</a> world, forwarding every call to the host and also sending monitoring events via another, custom imported interface.</p>



<a name="493012081"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Instrumenting%20wasi%20calls/near/493012081" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> celine santosh <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Instrumenting.20wasi.20calls.html#493012081">(Jan 10 2025 at 19:22)</a>:</h4>
<p>Thanks</p>
<p>I would require network calls to be redirected ,  I guess func_wrap is the one which replaces it<br>
but func_wrap() is not there in component model</p>



<a name="493012205"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Instrumenting%20wasi%20calls/near/493012205" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> celine santosh <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Instrumenting.20wasi.20calls.html#493012205">(Jan 10 2025 at 19:24)</a>:</h4>
<p><span class="user-mention silent" data-user-id="253994">Alex Crichton</span> <a href="#narrow/channel/206238-general/topic/Instrumenting.20wasi.20calls/near/492972545">said</a>:</p>
<blockquote>
<p>e.g. you'd create a <code>Linker</code>, add a custom function to it, and your custom function would forward to that.</p>
<p>Alternatively, now that I think about it, something that would be much more robust would be to write your own impl of <code>WasiSnapshotPreview1</code> which forwards to the <code>wasmtime-wasi</code> one, allowing you to interpose any function (although you're required to interpose all of them or at least forward arguments)</p>
</blockquote>
<p>Since I am using network calls especially tcp sockets this won't work in my case right</p>



<a name="493012450"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Instrumenting%20wasi%20calls/near/493012450" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> celine santosh <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Instrumenting.20wasi.20calls.html#493012450">(Jan 10 2025 at 19:25)</a>:</h4>
<p>Is there simpler option like for example in wasmtime repository , in <a href="http://tcp.rs">tcp.rs</a> file where start-connect is defined, I can call my custom function there? Changing the source code of wasmtime is what I meant by instrumenting.<br>
will it break any other functionality?</p>



<a name="493012778"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Instrumenting%20wasi%20calls/near/493012778" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Instrumenting.20wasi.20calls.html#493012778">(Jan 10 2025 at 19:27)</a>:</h4>
<p>Yeah, you can certainly fork <code>wasmtime-wasi</code> and add your custom code there.  That's probably the quickest option, although you'd need to maintain that fork yourself if you plan to use it long-term.  Perhaps if the changes are generic and broadly useful, they could be upstreamed.</p>



<a name="493220179"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Instrumenting%20wasi%20calls/near/493220179" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> celine santosh <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Instrumenting.20wasi.20calls.html#493220179">(Jan 12 2025 at 20:37)</a>:</h4>
<p>Okay Thanks a lot</p>



<a name="494892111"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Instrumenting%20wasi%20calls/near/494892111" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> celine santosh <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Instrumenting.20wasi.20calls.html#494892111">(Jan 20 2025 at 18:44)</a>:</h4>
<p>Hi</p>
<p>So I have created a <a href="http://runner.rs">runner.rs</a> where I create an engine , store, state linker etc.<br>
and I have inserted all wasi calls except sockets/tcp.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">add_to_linker_without_tcp</span><span class="o">&lt;</span><span class="n">T</span><span class="p">:</span><span class="w"> </span><span class="nc">WasiView</span><span class="o">&gt;</span><span class="p">(</span>
<span class="w">    </span><span class="n">linker</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">component</span><span class="p">::</span><span class="n">Linker</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">anyhow</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">linker</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">closure</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">type_annotate</span><span class="p">::</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="o">&gt;</span><span class="p">(</span><span class="o">|</span><span class="n">t</span><span class="o">|</span><span class="w"> </span><span class="n">WasiImpl</span><span class="p">(</span><span class="n">t</span><span class="p">));</span>

<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">clocks</span><span class="p">::</span><span class="n">wall_clock</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">clocks</span><span class="p">::</span><span class="n">monotonic_clock</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">sync</span><span class="p">::</span><span class="n">filesystem</span><span class="p">::</span><span class="n">types</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">filesystem</span><span class="p">::</span><span class="n">preopens</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">io</span><span class="p">::</span><span class="n">error</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">sync</span><span class="p">::</span><span class="n">io</span><span class="p">::</span><span class="n">poll</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">sync</span><span class="p">::</span><span class="n">io</span><span class="p">::</span><span class="n">streams</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">random</span><span class="p">::</span><span class="n">random</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">random</span><span class="p">::</span><span class="n">insecure</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">random</span><span class="p">::</span><span class="n">insecure_seed</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">cli</span><span class="p">::</span><span class="n">exit</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">cli</span><span class="p">::</span><span class="n">environment</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">cli</span><span class="p">::</span><span class="n">stdin</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">cli</span><span class="p">::</span><span class="n">stdout</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">cli</span><span class="p">::</span><span class="n">stderr</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">cli</span><span class="p">::</span><span class="n">terminal_input</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">cli</span><span class="p">::</span><span class="n">terminal_output</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">cli</span><span class="p">::</span><span class="n">terminal_stdin</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">cli</span><span class="p">::</span><span class="n">terminal_stdout</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">cli</span><span class="p">::</span><span class="n">terminal_stderr</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//wasmtime_wasi::bindings::sync::sockets::tcp::add_to_linker_get_host(l, closure)?;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">sockets</span><span class="p">::</span><span class="n">tcp_create_socket</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">sync</span><span class="p">::</span><span class="n">sockets</span><span class="p">::</span><span class="n">udp</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">sockets</span><span class="p">::</span><span class="n">udp_create_socket</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">sockets</span><span class="p">::</span><span class="n">instance_network</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">sockets</span><span class="p">::</span><span class="n">network</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">sockets</span><span class="p">::</span><span class="n">ip_name_lookup</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>
<p>So Instead of the wasi call start-connect I want to add my own custom start-connect from another package say mwasi:sockets/tcp which is in wrapper module.<br>
this is the wit file of  wrapper module </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">package</span><span class="w"> </span><span class="n">mwasi</span><span class="p">:</span><span class="nc">sockets</span><span class="o">@</span><span class="mf">0.2.0</span><span class="p">;</span>

<span class="n">interface</span><span class="w"> </span><span class="n">tcp</span><span class="p">{</span>

<span class="w">  </span><span class="k">use</span><span class="w"> </span><span class="n">wasi</span><span class="p">:</span><span class="nc">sockets</span><span class="o">/</span><span class="n">network</span><span class="o">@</span><span class="mf">0.2.0.</span><span class="p">{</span><span class="n">network</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="o">-</span><span class="n">code</span><span class="p">,</span><span class="w"> </span><span class="n">ip</span><span class="o">-</span><span class="n">socket</span><span class="o">-</span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="n">ip</span><span class="o">-</span><span class="n">address</span><span class="o">-</span><span class="n">family</span><span class="p">};</span>

<span class="w">  </span><span class="n">start</span><span class="o">-</span><span class="n">connect</span><span class="p">:</span><span class="w"> </span><span class="nc">func</span><span class="p">(</span><span class="n">networkinstance</span><span class="p">:</span><span class="w"> </span><span class="nc">network</span><span class="p">,</span><span class="w"> </span><span class="n">remoteaddress</span><span class="p">:</span><span class="w"> </span><span class="nc">ip</span><span class="o">-</span><span class="n">socket</span><span class="o">-</span><span class="n">address</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">result</span><span class="o">&lt;</span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="o">-</span><span class="n">code</span><span class="o">&gt;</span><span class="p">;</span><span class="w"> </span><span class="c1">//(result cm.Result[ error-code, struct{},  error-code])//result&lt;_, error-code&gt;;</span>

<span class="p">}</span>

<span class="n">world</span><span class="w"> </span><span class="n">wrapper</span><span class="p">{</span>
<span class="w">  </span><span class="n">import</span><span class="w"> </span><span class="n">wasi</span><span class="p">:</span><span class="nc">io</span><span class="o">/</span><span class="n">error</span><span class="o">@</span><span class="mf">0.2.0</span><span class="p">;</span>
<span class="w">  </span><span class="n">import</span><span class="w"> </span><span class="n">wasi</span><span class="p">:</span><span class="nc">sockets</span><span class="o">/</span><span class="n">tcp</span><span class="o">@</span><span class="mf">0.2.0</span><span class="p">;</span>
<span class="w">  </span><span class="n">import</span><span class="w"> </span><span class="n">wasi</span><span class="p">:</span><span class="nc">sockets</span><span class="o">/</span><span class="n">network</span><span class="o">@</span><span class="mf">0.2.0</span><span class="p">;</span>
<span class="w">  </span><span class="n">export</span><span class="w"> </span><span class="n">wasi</span><span class="p">:</span><span class="nc">cli</span><span class="o">/</span><span class="n">run</span><span class="o">@</span><span class="mf">0.2.0</span><span class="p">;</span>
<span class="w">  </span><span class="n">include</span><span class="w"> </span><span class="n">wasi</span><span class="p">:</span><span class="nc">cli</span><span class="o">/</span><span class="n">imports</span><span class="o">@</span><span class="mf">0.2.0</span><span class="p">;</span>
<span class="w">  </span><span class="n">export</span><span class="w"> </span><span class="n">tcp</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>The implementation of the start-connect is in Go.</p>
<p>How can I insert this interface tcp (which I created) into linker so that when main app calls start-connect ,my version is triggered. I have seen the wit-bindgen macro. Is that the way?<br>
I tried this method <a href="https://docs.wasmtime.dev/api/wasmtime/component/bindgen_examples/_5_all_world_export_kinds/index.html">https://docs.wasmtime.dev/api/wasmtime/component/bindgen_examples/_5_all_world_export_kinds/index.html</a><br>
But I don't know where to write the implementation of my exported interface. Also I want to implement it in Go which will be easier for my further steps.<br>
Or should I convert my wrapper module into wasm and load it as component in my runner and insert it in linker or something ?</p>
<p>Thanks</p>



<a name="494892802"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Instrumenting%20wasi%20calls/near/494892802" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Instrumenting.20wasi.20calls.html#494892802">(Jan 20 2025 at 18:48)</a>:</h4>
<p>Yes, you want to run the wasmtime::component::bindgen! macro on your wit file, and use <code>with</code> to point all of the wasi implementations at the wasmtime_wasi crate's implementations</p>



<a name="494892901"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Instrumenting%20wasi%20calls/near/494892901" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Instrumenting.20wasi.20calls.html#494892901">(Jan 20 2025 at 18:49)</a>:</h4>
<p>see the <code>with</code> section in <a href="https://docs.rs/wasmtime/latest/wasmtime/component/macro.bindgen.html#options-reference">https://docs.rs/wasmtime/latest/wasmtime/component/macro.bindgen.html#options-reference</a></p>



<a name="494893131"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Instrumenting%20wasi%20calls/near/494893131" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Instrumenting.20wasi.20calls.html#494893131">(Jan 20 2025 at 18:50)</a>:</h4>
<p>also, you dont want your <code>world wrapper</code> to export both <code>cli/run</code> and <code>tcp</code> unless you intend to require that all components in your world provide both of those exports, my interpretation of the above is you really just want your components to be invoked by the <code>start-connect</code> function</p>



<a name="494893191"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Instrumenting%20wasi%20calls/near/494893191" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Instrumenting.20wasi.20calls.html#494893191">(Jan 20 2025 at 18:51)</a>:</h4>
<p>(I cant offer any help with your components being written in go, i'm not up to speed on anything go related)</p>



<a name="494896603"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Instrumenting%20wasi%20calls/near/494896603" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> celine santosh <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Instrumenting.20wasi.20calls.html#494896603">(Jan 20 2025 at 19:15)</a>:</h4>
<p>Thanks a lot.<br>
Actually I want the main application to call my start-connect instead of wasi start-connect, so that I can redirect all the network calls to a monitor which checks for compliance , and then proceed with the normal wasi start-connect.<br>
So as the first step I have disabled the wasi start-connect from linker. <br>
Next I will proceed with wit bindgen macro but I am confused where do I give the implementation of my start-connect?<br>
Even in this example there are no implementations of <code>bytes-to-string</code> and duration-to-string in units interface.</p>



<a name="494903163"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Instrumenting%20wasi%20calls/near/494903163" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Instrumenting.20wasi.20calls.html#494903163">(Jan 20 2025 at 20:02)</a>:</h4>
<p>by exposing your package's <code>export tcp</code> and not `wasi:cli/run", your world is saying "the only way to invoke this component is to call tcp start-connect"</p>



<a name="494903595"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Instrumenting%20wasi%20calls/near/494903595" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Instrumenting.20wasi.20calls.html#494903595">(Jan 20 2025 at 20:05)</a>:</h4>
<p>if instead what you want is for components, when they want to create a tcp connection, to go through your interface and not the one exposed by wasi:sockets, you want to change your wit to say <code>import tcp</code>, because its available as an import function to the component, just like <code>import wasi:sockets/network</code> is making the wasi network functions available as imports.</p>



<a name="494903841"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Instrumenting%20wasi%20calls/near/494903841" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Instrumenting.20wasi.20calls.html#494903841">(Jan 20 2025 at 20:07)</a>:</h4>
<p>when you list <code>export tcp</code>, bindgen produces wrappers for a component that has an exported interface <code>tcp</code> and that interface has a function <code>start_connect</code>. when bindgen makes wrappers for <code>wasi:cli/run</code> it makes this struct Command with <a href="https://docs.rs/wasmtime-wasi/latest/wasmtime_wasi/bindings/struct.Command.html#method.wasi_cli_run">https://docs.rs/wasmtime-wasi/latest/wasmtime_wasi/bindings/struct.Command.html#method.wasi_cli_run</a></p>



<a name="494903938"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Instrumenting%20wasi%20calls/near/494903938" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Instrumenting.20wasi.20calls.html#494903938">(Jan 20 2025 at 20:08)</a>:</h4>
<p>and the return value of <code>wasi_cli_run</code> has a function <a href="https://docs.rs/wasmtime-wasi/latest/wasmtime_wasi/bindings/exports/wasi/cli/run/struct.Guest.html"><code>call_run</code></a> for the function named <code>run</code> inside that interface <code>run</code> (yes, repeated word makes it confusing)</p>



<a name="494904297"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Instrumenting%20wasi%20calls/near/494904297" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Instrumenting.20wasi.20calls.html#494904297">(Jan 20 2025 at 20:10)</a>:</h4>
<p>changing that to <code>import tcp</code> will mean bindgen produces a totally different kind of wrapper. instead it will make a <code>mod your_namespace { mod your_packagename { mod tcp { trait Host { fn start_connect(...) }, fn add_to_linker(...) } } }</code></p>



<a name="494904405"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Instrumenting%20wasi%20calls/near/494904405" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Instrumenting.20wasi.20calls.html#494904405">(Jan 20 2025 at 20:11)</a>:</h4>
<p>and then you can follow the example of wasmtime-wasi for how you author an impl of that Host trait, and then you call that generated add_to_linker function into the custom one you made above.</p>



<a name="494904537"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Instrumenting%20wasi%20calls/near/494904537" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Instrumenting.20wasi.20calls.html#494904537">(Jan 20 2025 at 20:12)</a>:</h4>
<p>when you said "the implementation of start-connect is in go" thats what made me think you wanted to call a component written in go.</p>



<a name="494904814"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Instrumenting%20wasi%20calls/near/494904814" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Instrumenting.20wasi.20calls.html#494904814">(Jan 20 2025 at 20:14)</a>:</h4>
<p>when your tcp.start-connect is an <code>import</code>, you need to provide an <code>impl Host</code> of that trait in Rust, so you'll either need to reimplement that start-connect go code in Rust, or call out to the go code by some other means, maybe with std::process::Command to call an external go executable? idk, i'm not a go person but theres no straightforward way to call between go and rust that i know of.</p>



<a name="495125138"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Instrumenting%20wasi%20calls/near/495125138" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> celine santosh <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Instrumenting.20wasi.20calls.html#495125138">(Jan 21 2025 at 19:01)</a>:</h4>
<p><span class="user-mention silent" data-user-id="253992">Pat Hickey</span> <a href="#narrow/channel/206238-general/topic/Instrumenting.20wasi.20calls/near/494904405">said</a>:</p>
<blockquote>
<p>and then you can follow the example of wasmtime-wasi for how you author an impl of that Host trait, and then you call that generated add_to_linker function into the custom one you made above.</p>
</blockquote>
<p>oh great, understood now.</p>



<a name="495125447"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Instrumenting%20wasi%20calls/near/495125447" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> celine santosh <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Instrumenting.20wasi.20calls.html#495125447">(Jan 21 2025 at 19:02)</a>:</h4>
<p><span class="user-mention silent" data-user-id="253992">Pat Hickey</span> <a href="#narrow/channel/206238-general/topic/Instrumenting.20wasi.20calls/near/494904814">said</a>:</p>
<blockquote>
<p>when your tcp.start-connect is an <code>import</code>, you need to provide an <code>impl Host</code> of that trait in Rust, so you'll either need to reimplement that start-connect go code in Rust, or call out to the go code by some other means, maybe with std::process::Command to call an external go executable? idk, i'm not a go person but theres no straightforward way to call between go and rust that i know of.</p>
</blockquote>
<p>I have a monitor which is implemented in Go , so I need to call one function from my custom start-connect function which check compliance and then proceeds with wasi start-connect. <br>
If I load my monitor as a wasm component in <a href="http://runner.rs">runner.rs</a> and retrieve the function I want to call, then I can call it from my custom start-connect function even if its in rust right?</p>



<a name="495130868"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Instrumenting%20wasi%20calls/near/495130868" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Instrumenting.20wasi.20calls.html#495130868">(Jan 21 2025 at 19:37)</a>:</h4>
<p>My understanding is that both Rust (via <code>extern "C"</code>) and Go (via Cgo) can make use of the C ABI, allowing Rust and Go code to be linked statically or dynamically.  I have experience with the Rust side of that, but none with the Go side.  You'll probably want to research <a href="https://pkg.go.dev/cmd/cgo#hdr-C_references_to_Go">using Cgo</a> and ask in a Go-specific forum if you have questions about that.</p>



<a name="495132029"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Instrumenting%20wasi%20calls/near/495132029" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> celine santosh <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Instrumenting.20wasi.20calls.html#495132029">(Jan 21 2025 at 19:45)</a>:</h4>
<p>oh okay , But I don't understand , we can actually make use of wasm's language agnostic feature right?<br>
By loading monitor as a wasm component and call its function from rust implementation. Isn't that possible?</p>



<a name="495133243"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Instrumenting%20wasi%20calls/near/495133243" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Instrumenting.20wasi.20calls.html#495133243">(Jan 21 2025 at 19:52)</a>:</h4>
<p>It depends on which approach you plan to use.  In this thread, we've laid out three possible approaches (at least):</p>
<ol>
<li>Virtualize WASI using component composition</li>
<li>Provide a mix of <code>wasmtime-wasi</code> and custom WASI functions in the host embedding when populating the <code>Linker</code> with host functions.</li>
<li>Fork <code>wasmtime-wasi</code> and add your instrumentation to it.</li>
</ol>
<p>Of those approaches, only #1 involves Wasm composition, whereas my understanding was that you are planning to use either #2 or #3.</p>
<p>Perhaps you're proposing #2 or #3 but also recursively loading another component inside the host function?  If so, yes, that could work.  You'd just need to make sure you're using a separate <code>Store</code> for the instrumentation component.</p>



<a name="495531274"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Instrumenting%20wasi%20calls/near/495531274" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> celine santosh <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Instrumenting.20wasi.20calls.html#495531274">(Jan 23 2025 at 15:51)</a>:</h4>
<p>Thanks<br>
Right now I am trying out #2. <br>
So I think it would be easier to load monitor as a component .</p>
<p>I was facing errors in <a href="http://runner.rs">runner.rs</a> Can anyone please help me in this </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">add_to_linker_without_tcp</span><span class="o">&lt;</span><span class="n">T</span><span class="p">:</span><span class="w"> </span><span class="nc">WasiView</span><span class="o">&gt;</span><span class="p">(</span>
<span class="w">    </span><span class="n">linker</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">component</span><span class="p">::</span><span class="n">Linker</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">anyhow</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">linker</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">closure</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">type_annotate</span><span class="p">::</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="o">&gt;</span><span class="p">(</span><span class="o">|</span><span class="n">t</span><span class="o">|</span><span class="w"> </span><span class="n">WasiImpl</span><span class="p">(</span><span class="n">t</span><span class="p">));</span>

<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">clocks</span><span class="p">::</span><span class="n">wall_clock</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">clocks</span><span class="p">::</span><span class="n">monotonic_clock</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">sync</span><span class="p">::</span><span class="n">filesystem</span><span class="p">::</span><span class="n">types</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">filesystem</span><span class="p">::</span><span class="n">preopens</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">io</span><span class="p">::</span><span class="n">error</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">sync</span><span class="p">::</span><span class="n">io</span><span class="p">::</span><span class="n">poll</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">sync</span><span class="p">::</span><span class="n">io</span><span class="p">::</span><span class="n">streams</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">random</span><span class="p">::</span><span class="n">random</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">random</span><span class="p">::</span><span class="n">insecure</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">random</span><span class="p">::</span><span class="n">insecure_seed</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">cli</span><span class="p">::</span><span class="n">exit</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">cli</span><span class="p">::</span><span class="n">environment</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">cli</span><span class="p">::</span><span class="n">stdin</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">cli</span><span class="p">::</span><span class="n">stdout</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">cli</span><span class="p">::</span><span class="n">stderr</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">cli</span><span class="p">::</span><span class="n">terminal_input</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">cli</span><span class="p">::</span><span class="n">terminal_output</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">cli</span><span class="p">::</span><span class="n">terminal_stdin</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">cli</span><span class="p">::</span><span class="n">terminal_stdout</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">cli</span><span class="p">::</span><span class="n">terminal_stderr</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//wasmtime_wasi::bindings::sync::sockets::tcp::add_to_linker_get_host(l, closure)?;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">sockets</span><span class="p">::</span><span class="n">tcp_create_socket</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">sync</span><span class="p">::</span><span class="n">sockets</span><span class="p">::</span><span class="n">udp</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">sockets</span><span class="p">::</span><span class="n">udp_create_socket</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">sockets</span><span class="p">::</span><span class="n">instance_network</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">sockets</span><span class="p">::</span><span class="n">network</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">sockets</span><span class="p">::</span><span class="n">ip_name_lookup</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">Wrapper</span><span class="p">::</span><span class="n">add_to_linker</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>
<p>I am not able to add the wrapper module which is generated by wit bindgen into the linker<br>
I get error </p>
<p><strong>error[E0271]</strong><strong>: expected <code>{closure@main.rs:74:41}</code> to be a closure that returns <code>&amp;mut _</code>, but it returns <code>WasiImpl&lt;&amp;mut T&gt;</code></strong></p>
<p><strong>--&gt;</strong> src/main.rs:103:31</p>
<p><strong>|</strong><br>
<strong>103</strong> <strong>|</strong>     Wrapper::add_to_linker(l, closure)?;</p>
<p><strong>|</strong>     <strong>----------------------</strong>    <strong>^^^^^^^</strong> <strong>expected <code>&amp;mut _</code>, found <code>WasiImpl&lt;&amp;mut T&gt;</code></strong></p>
<p><strong>|</strong>     <strong>|</strong></p>
<p><strong>|</strong>     <strong>required by a bound introduced by this call</strong></p>
<p><strong>|</strong></p>
<p><strong>=</strong> <strong>note</strong>: expected mutable reference <code>**&amp;mut _**</code></p>
<p>found struct <code>**WasiImpl&lt;&amp;mut T&gt;**</code><br>
<strong>note</strong>: required by a bound in <code>_::&lt;impl Wrapper&gt;::add_to_linker</code></p>



<a name="495955039"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Instrumenting%20wasi%20calls/near/495955039" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> celine santosh <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Instrumenting.20wasi.20calls.html#495955039">(Jan 26 2025 at 10:29)</a>:</h4>
<p>Hello<br>
Please ignore the previous message.</p>
<p>In my host embedding I have wit bindgen </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">bindgen</span><span class="o">!</span><span class="p">({</span>
<span class="w">    </span><span class="n">path</span><span class="p">:</span><span class="w"> </span><span class="s">"wit"</span><span class="p">,</span>
<span class="w">    </span><span class="n">world</span><span class="p">:</span><span class="w"> </span><span class="s">"wrapper"</span><span class="p">,</span>
<span class="w">    </span><span class="n">with</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s">"wasi"</span><span class="p">:</span><span class="w"> </span><span class="nc">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="n">require_store_data_send</span><span class="p">:</span><span class="w"> </span><span class="nc">true</span><span class="p">,</span>
<span class="p">});</span>
</code></pre></div>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">impl</span><span class="w"> </span><span class="n">mwasi</span><span class="p">::</span><span class="n">sockets</span><span class="p">::</span><span class="n">tcp</span><span class="p">::</span><span class="n">Host</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">MyState</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="k">fn</span><span class="w"> </span><span class="nf">start_connect</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">network</span><span class="p">:</span><span class="nc">Resource</span><span class="o">&lt;</span><span class="n">Network</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">remote_address</span><span class="p">:</span><span class="w"> </span><span class="nc">IpSocketAddress</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">ErrorCode</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Intercepted TCP call: Printing from the monitor"</span><span class="p">);</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"start-connect operation successful!"</span><span class="p">);</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">}</span>
</code></pre></div>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">add_to_linker_without_tcp</span><span class="o">&lt;</span><span class="n">T</span><span class="p">:</span><span class="w"> </span><span class="nc">WasiView</span><span class="o">&gt;</span><span class="p">(</span>
<span class="w">    </span><span class="n">linker</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">component</span><span class="p">::</span><span class="n">Linker</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">anyhow</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">linker</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">closure</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">type_annotate</span><span class="p">::</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="o">&gt;</span><span class="p">(</span><span class="o">|</span><span class="n">t</span><span class="o">|</span><span class="w"> </span><span class="n">WasiImpl</span><span class="p">(</span><span class="n">t</span><span class="p">));</span>
<span class="w">    </span><span class="c1">//let closure = |state: &amp;mut T| state.ctx();</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">clocks</span><span class="p">::</span><span class="n">wall_clock</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">clocks</span><span class="p">::</span><span class="n">monotonic_clock</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">sync</span><span class="p">::</span><span class="n">filesystem</span><span class="p">::</span><span class="n">types</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">filesystem</span><span class="p">::</span><span class="n">preopens</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">io</span><span class="p">::</span><span class="n">error</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">sync</span><span class="p">::</span><span class="n">io</span><span class="p">::</span><span class="n">poll</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">sync</span><span class="p">::</span><span class="n">io</span><span class="p">::</span><span class="n">streams</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">random</span><span class="p">::</span><span class="n">random</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">random</span><span class="p">::</span><span class="n">insecure</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">random</span><span class="p">::</span><span class="n">insecure_seed</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">cli</span><span class="p">::</span><span class="n">exit</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">cli</span><span class="p">::</span><span class="n">environment</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">cli</span><span class="p">::</span><span class="n">stdin</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">cli</span><span class="p">::</span><span class="n">stdout</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">cli</span><span class="p">::</span><span class="n">stderr</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">cli</span><span class="p">::</span><span class="n">terminal_input</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">cli</span><span class="p">::</span><span class="n">terminal_output</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">cli</span><span class="p">::</span><span class="n">terminal_stdin</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">cli</span><span class="p">::</span><span class="n">terminal_stdout</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">cli</span><span class="p">::</span><span class="n">terminal_stderr</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">sockets</span><span class="p">::</span><span class="n">tcp_create_socket</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">sync</span><span class="p">::</span><span class="n">sockets</span><span class="p">::</span><span class="n">udp</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">sockets</span><span class="p">::</span><span class="n">udp_create_socket</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">sockets</span><span class="p">::</span><span class="n">instance_network</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">sockets</span><span class="p">::</span><span class="n">network</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">sockets</span><span class="p">::</span><span class="n">ip_name_lookup</span><span class="p">::</span><span class="n">add_to_linker_get_host</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">closure</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="o">**</span><span class="n">Wrapper</span><span class="p">::</span><span class="n">add_to_linker</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">state</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">T</span><span class="o">|</span><span class="w"> </span><span class="n">state</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="o">**</span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>
<p>But why does this line <code>Wrapper::add_to_linker(l, |state: &amp;mut T| state)?;</code> give error <br>
<strong>error[E0277]</strong><strong>: the trait bound <code>T: wasmtime_wasi::bindings::random::insecure_seed::Host</code> is not satisfied</strong></p>
<p><strong>--&gt;</strong> src/main.rs:102:5</p>
<p><strong>|</strong><br>
<strong>102</strong> <strong>|</strong>     Wrapper::add_to_linker(l, |state: &amp;mut T| state)?;</p>
<p><strong>|</strong>     <strong>^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</strong> <strong>the trait <code>wasmtime_wasi::bindings::random::insecure_seed::Host</code> is not implemented for <code>T</code></strong></p>
<p><strong>|</strong><br>
<strong>note</strong>: required by a bound in <code>_::&lt;impl Wrapper&gt;::add_to_linker</code></p>
<p><strong>--&gt;</strong> src/main.rs:21:1</p>
<p><strong>|</strong><br>
<strong>21</strong>  <strong>|</strong> <strong>/</strong> bindgen!({<br>
<strong>22</strong>  <strong>|</strong> <strong>|</strong>     path: "wit",<br>
<strong>23</strong>  <strong>|</strong> <strong>|</strong>     world: "wrapper",<br>
<strong>24</strong>  <strong>|</strong> <strong>|</strong>     with: {<br>
<strong>...</strong>   <strong>|</strong><br>
<strong>27</strong>  <strong>|</strong> <strong>|</strong>     require_store_data_send: true,<br>
<strong>28</strong>  <strong>|</strong> <strong>|</strong> });</p>
<p><strong>|</strong> <strong>|__^</strong> <strong>required by this bound in <code>_::&lt;impl Wrapper&gt;::add_to_linker</code></strong></p>
<p><strong>=</strong> <strong>note</strong>: this error originates in the macro <code>bindgen</code> (in Nightly builds, run with -Z macro-backtrace for more info)<br>
<strong>help</strong>: consider further restricting this bound</p>
<p><strong>|</strong><br>
<strong>70</strong>  <strong>|</strong> pub fn add_to_linker_without_tcp&lt;T: WasiView + wasmtime_wasi::bindings::random::insecure_seed::Host&gt;(</p>
<p><strong>|</strong>                                              ++++++++++++++++++++++++++++++++++++++++++++++++++++++</p>
<p>It gives 28 other errors saying each host trait not implemented.</p>
<p>I have already given the <strong>with</strong> clause for wasmtime_wasi in the bindgen macro, so the host trait implementations are already specified then why am I getting this error ?</p>



<a name="496140229"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Instrumenting%20wasi%20calls/near/496140229" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Instrumenting.20wasi.20calls.html#496140229">(Jan 27 2025 at 14:49)</a>:</h4>
<p>You might want to use <a href="https://crates.io/crates/cargo-expand">cargo-expand</a> to examine the code generated by the <code>bindgen</code> macro, which might help explain what's going on.  The first thing I notice is that you're telling <code>bindgen</code> to use <code>wasmtime_wasi::bindings</code> for the entire <code>wasi</code> namespace, yet also providing an additional implementation of (part of) <code>wasi:sockets/tcp</code>, which seems like a contradiction.</p>
<p>Would you mind posting a self-contained test case e.g. to GitHub which exhibits the issue you're seeing?  That would make this easier to debug.</p>



<hr><p>Last updated: Feb 22 2026 at 11:05 UTC</p>
</html>
<html>
<head><meta charset="utf-8"><title>Issue compiling Rust component with async function · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/index.html">general</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Issue.20compiling.20Rust.20component.20with.20async.20function.html">Issue compiling Rust component with async function</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="561982868"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Issue%20compiling%20Rust%20component%20with%20async%20function/near/561982868" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathaniel Cook <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Issue.20compiling.20Rust.20component.20with.20async.20function.html#561982868">(Dec 04 2025 at 22:07)</a>:</h4>
<p>I have a simple wit world with a single async function:</p>
<div class="codehilite" data-code-language="wit"><pre><span></span><code>package component:df@0.1.0;

interface df-interface {
    fromcsv: async func(path: string) -&gt; s64;
}

world root {
    export df-interface;
}
</code></pre></div>
<p>In Rust I am attempting to implement the interface with this</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">mod</span><span class="w"> </span><span class="nn">bindings</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">wit_bindgen</span><span class="p">::</span><span class="n">generate</span><span class="o">!</span><span class="p">();</span>

<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="k">super</span><span class="p">::</span><span class="n">Module</span><span class="p">;</span>
<span class="w">    </span><span class="n">export</span><span class="o">!</span><span class="p">(</span><span class="n">Module</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">struct</span><span class="w"> </span><span class="nc">Module</span><span class="p">;</span>

<span class="k">impl</span><span class="w"> </span><span class="n">bindings</span><span class="p">::</span><span class="n">exports</span><span class="p">::</span><span class="n">component</span><span class="p">::</span><span class="n">df</span><span class="p">::</span><span class="n">df_interface</span><span class="p">::</span><span class="n">Guest</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Module</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">fromcsv</span><span class="p">(</span><span class="n">path</span><span class="p">:</span><span class="w"> </span><span class="nb">String</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="mi">0</span><span class="w"> </span><span class="c1">// Actual implementation doesn't matter</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>However when building the component with </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">cargo</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="o">--</span><span class="n">target</span><span class="o">=</span><span class="n">wasm32</span><span class="o">-</span><span class="n">wasip2</span>
</code></pre></div>
<p>I get a linking error</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">error</span><span class="p">:</span><span class="w"> </span><span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">parse</span><span class="w"> </span><span class="n">core</span><span class="w"> </span><span class="n">wasm</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">componentization</span>

<span class="w">          </span><span class="n">Caused</span><span class="w"> </span><span class="n">by</span><span class="p">:</span>
<span class="w">              </span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="nc">decoding</span><span class="w"> </span><span class="n">custom</span><span class="w"> </span><span class="n">section</span><span class="w"> </span><span class="n">component</span><span class="o">-</span><span class="k">type</span><span class="p">:</span><span class="nc">wit</span><span class="o">-</span><span class="n">bindgen</span><span class="p">:</span><span class="mf">0.49.0</span><span class="p">:</span><span class="nc">component</span><span class="p">:</span><span class="nc">df</span><span class="o">@</span><span class="mf">0.1.0</span><span class="p">:</span><span class="nc">root</span><span class="p">:</span><span class="nc">encoded</span><span class="w"> </span><span class="n">world</span>
<span class="w">              </span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="nc">invalid</span><span class="w"> </span><span class="n">leading</span><span class="w"> </span><span class="n">byte</span><span class="w"> </span><span class="p">(</span><span class="mh">0x43</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">component</span><span class="w"> </span><span class="n">defined</span><span class="w"> </span><span class="k">type</span><span class="w"> </span><span class="p">(</span><span class="n">at</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="mh">0x2f</span><span class="p">)</span>
</code></pre></div>
<p>Reading the spec I can see the <code>0x43</code> is the marker for an async function. If I remove the async aspect of the function everything builds but naturally I am not able to call async code in the implementation.</p>
<p>Happy to file a bug report on the right repo wasn't sure if this was a <code>wasm-component-ld</code> issue or further upstream before linking.</p>



<a name="561983967"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Issue%20compiling%20Rust%20component%20with%20async%20function/near/561983967" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Issue.20compiling.20Rust.20component.20with.20async.20function.html#561983967">(Dec 04 2025 at 22:16)</a>:</h4>
<p>You'll want to use the latest nightly toolchain or build the latest <code>wasm-component-ld</code> and pass <code>-Clinker=path/to/wasm-component-ld</code> to rustc (via <code>RUSTFLAGS</code> through Cargo) -- what you're seeing here is that the <code>wasm-component-ld</code> shipped with Rust stable doesn't understand the latest async stuff</p>



<a name="561984054"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Issue%20compiling%20Rust%20component%20with%20async%20function/near/561984054" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathaniel Cook <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Issue.20compiling.20Rust.20component.20with.20async.20function.html#561984054">(Dec 04 2025 at 22:16)</a>:</h4>
<p>Ok great, I am on latest stable, will try nightly thanks</p>



<a name="562017806"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Issue%20compiling%20Rust%20component%20with%20async%20function/near/562017806" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> ktz_alias <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Issue.20compiling.20Rust.20component.20with.20async.20function.html#562017806">(Dec 05 2025 at 04:16)</a>:</h4>
<p><span class="user-mention" data-user-id="439345">@Nathaniel Cook</span> This is a work around.  You can use <code>wasm-tools</code> to get around this issue:</p>
<ol>
<li>Compiling your code with the<code>wasm32-wasip1</code> target.</li>
<li>Run <code>wasm-tools component new</code> to convert the the resulting module to <code>wasip3</code> component.<p>- You will need to pass the appropriate adapter for WASI-P3 using the <code>--adapt</code> option (e.g. <code>wasi_snapshot_preview1.reactor.wasi</code>, etc.).<br>
  - Just be aware that adapter compatibility depends on the <code>wasm-tools</code> version you’re using.</p>
</li>
</ol>



<a name="562019860"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Issue%20compiling%20Rust%20component%20with%20async%20function/near/562019860" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathaniel Cook <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Issue.20compiling.20Rust.20component.20with.20async.20function.html#562019860">(Dec 05 2025 at 04:42)</a>:</h4>
<p>Thanks</p>



<hr><p>Last updated: Feb 22 2026 at 11:05 UTC</p>
</html>
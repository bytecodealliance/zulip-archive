<html>
<head><meta charset="utf-8"><title>Trap on failed cast from imported function · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/index.html">general</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Trap.20on.20failed.20cast.20from.20imported.20function.html">Trap on failed cast from imported function</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="538343692"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Trap%20on%20failed%20cast%20from%20imported%20function/near/538343692" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathaniel Cook <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Trap.20on.20failed.20cast.20from.20imported.20function.html#538343692">(Sep 09 2025 at 03:10)</a>:</h4>
<p>I have a DSL that compiles to WASM and I am attempting to get linking with other wasm components working. High level is all the code from my DSL gets compiled into a set of core modules and then all linked using core semantics into a single component. Then I link against the external wasm components. </p>
<p>The issue I am having is I get a trap for a failed cast when I try and run my component. The error comes from the linked shared everything core modules. Here is a the relevant code in the <code>main</code> function.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="p">(</span><span class="n">core</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="p">(;</span><span class="mi">1</span><span class="p">;)</span>
<span class="w">      </span><span class="p">(</span><span class="k">type</span><span class="w"> </span><span class="p">(;</span><span class="mi">0</span><span class="p">;)</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="p">(</span><span class="n">param</span><span class="w"> </span><span class="p">(</span><span class="k">ref</span><span class="w"> </span><span class="k">struct</span><span class="p">)</span><span class="w"> </span><span class="kt">f64</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="kt">f64</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="k">type</span><span class="w"> </span><span class="p">(;</span><span class="mi">1</span><span class="p">;)</span><span class="w"> </span><span class="p">(</span><span class="n">sub</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="p">(</span><span class="n">field</span><span class="w"> </span><span class="p">(</span><span class="k">ref</span><span class="w"> </span><span class="mi">0</span><span class="p">)))))</span>
<span class="w">      </span><span class="p">(</span><span class="k">type</span><span class="w"> </span><span class="p">(;</span><span class="mi">2</span><span class="p">;)</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="p">(</span><span class="n">param</span><span class="w"> </span><span class="p">(</span><span class="k">ref</span><span class="w"> </span><span class="k">struct</span><span class="p">)</span><span class="w"> </span><span class="kt">f64</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="p">(</span><span class="k">ref</span><span class="w"> </span><span class="mi">1</span><span class="p">))))</span>
<span class="w">      </span><span class="p">(</span><span class="k">type</span><span class="w"> </span><span class="p">(;</span><span class="mi">3</span><span class="p">;)</span><span class="w"> </span><span class="p">(</span><span class="n">sub</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="p">(</span><span class="n">field</span><span class="w"> </span><span class="p">(</span><span class="k">ref</span><span class="w"> </span><span class="mi">2</span><span class="p">)))))</span>
<span class="w">      </span><span class="p">(</span><span class="k">type</span><span class="w"> </span><span class="p">(;</span><span class="mi">4</span><span class="p">;)</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="p">(</span><span class="n">param</span><span class="w"> </span><span class="p">(</span><span class="k">ref</span><span class="w"> </span><span class="k">struct</span><span class="p">)</span><span class="w"> </span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="p">(</span><span class="k">ref</span><span class="w"> </span><span class="mi">3</span><span class="p">))))</span>
<span class="w">      </span><span class="p">(</span><span class="k">type</span><span class="w"> </span><span class="p">(;</span><span class="mi">5</span><span class="p">;)</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="p">(</span><span class="n">param</span><span class="w"> </span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="kt">f64</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="k">type</span><span class="w"> </span><span class="p">(;</span><span class="mi">6</span><span class="p">;)</span><span class="w"> </span><span class="p">(</span><span class="n">sub</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="p">(</span><span class="n">field</span><span class="w"> </span><span class="p">(</span><span class="k">ref</span><span class="w"> </span><span class="mi">4</span><span class="p">)))))</span>
<span class="w">      </span><span class="p">(</span><span class="k">type</span><span class="w"> </span><span class="p">(;</span><span class="mi">7</span><span class="p">;)</span><span class="w"> </span><span class="p">(</span><span class="n">sub</span><span class="w"> </span><span class="kr">final</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="p">(</span><span class="n">field</span><span class="w"> </span><span class="p">(</span><span class="k">ref</span><span class="w"> </span><span class="mi">4</span><span class="p">)))))</span>
<span class="w">      </span><span class="p">(</span><span class="n">import</span><span class="w"> </span><span class="s">"std::math"</span><span class="w"> </span><span class="s">"compute"</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="p">(;</span><span class="mi">0</span><span class="p">;)</span><span class="w"> </span><span class="p">(</span><span class="k">type</span><span class="w"> </span><span class="mi">4</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="n">export</span><span class="w"> </span><span class="s">"remote1"</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="n">export</span><span class="w"> </span><span class="s">"main"</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="p">(;</span><span class="mi">1</span><span class="p">;)</span><span class="w"> </span><span class="p">(</span><span class="k">type</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">param</span><span class="w"> </span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="kt">f64</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="n">local</span><span class="w"> </span><span class="p">(</span><span class="k">ref</span><span class="w"> </span><span class="mi">6</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">ref</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">ref</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span>
<span class="w">        </span><span class="k">ref</span><span class="p">.</span><span class="n">func</span><span class="w"> </span><span class="mi">0</span>
<span class="w">        </span><span class="k">struct</span><span class="p">.</span><span class="n">new</span><span class="w"> </span><span class="mi">7</span>
<span class="w">        </span><span class="k">ref</span><span class="p">.</span><span class="n">cast</span><span class="w"> </span><span class="p">(</span><span class="k">ref</span><span class="w"> </span><span class="mi">6</span><span class="p">)</span>
<span class="w">        </span><span class="n">local</span><span class="p">.</span><span class="n">tee</span><span class="w"> </span><span class="mi">1</span>
<span class="w">        </span><span class="kt">i64</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">1</span>
<span class="w">        </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">1</span>
<span class="w">        </span><span class="k">struct</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">0</span>
<span class="w">        </span><span class="n">call_ref</span><span class="w"> </span><span class="mi">4</span>
<span class="w">        </span><span class="n">local</span><span class="p">.</span><span class="n">tee</span><span class="w"> </span><span class="mi">2</span>
<span class="w">        </span><span class="kt">f64</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mh">0x1</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="w"> </span><span class="p">(;</span><span class="o">=</span><span class="mi">2</span><span class="p">;)</span>
<span class="w">        </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">2</span>
<span class="w">        </span><span class="k">struct</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">0</span>
<span class="w">        </span><span class="n">call_ref</span><span class="w"> </span><span class="mi">2</span>
<span class="w">        </span><span class="n">local</span><span class="p">.</span><span class="n">tee</span><span class="w"> </span><span class="mi">3</span>
<span class="w">        </span><span class="kt">f64</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mh">0x1</span><span class="p">.</span><span class="mi">8</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="w"> </span><span class="p">(;</span><span class="o">=</span><span class="mi">3</span><span class="p">;)</span>
<span class="w">        </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">3</span>
<span class="w">        </span><span class="k">struct</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span>
<span class="w">        </span><span class="n">call_ref</span><span class="w"> </span><span class="mi">0</span>
<span class="w">        </span><span class="k">return</span>
<span class="w">      </span><span class="p">)</span>
<span class="w">    </span><span class="p">)</span>
</code></pre></div>
<p>The trap occurs on the <code>call_ref 4</code> instruction. My DSL has curried closures so we are seeing a pattern of creating a struct (GC proposal) with a function reference as the first field and a its closed over env as the remaining fields.</p>
<p>Reading this code we create function ref to function 0 which is an imported function. Then after getting it out of the struct we call it with <code>call_ref 4</code>. We can easily see that the struct's field is of type 4 so this should be valid however I get the trap.</p>
<p>If I instead change the <code>ref.func 0</code> to a locally defined function instead of an imported one it I do not get the trap.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="p">(</span><span class="n">core</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="p">(;</span><span class="mi">1</span><span class="p">;)</span>
<span class="w">      </span><span class="p">(</span><span class="k">type</span><span class="w"> </span><span class="p">(;</span><span class="mi">0</span><span class="p">;)</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="p">(</span><span class="n">param</span><span class="w"> </span><span class="p">(</span><span class="k">ref</span><span class="w"> </span><span class="k">struct</span><span class="p">)</span><span class="w"> </span><span class="kt">f64</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="kt">f64</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="k">type</span><span class="w"> </span><span class="p">(;</span><span class="mi">1</span><span class="p">;)</span><span class="w"> </span><span class="p">(</span><span class="n">sub</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="p">(</span><span class="n">field</span><span class="w"> </span><span class="p">(</span><span class="k">ref</span><span class="w"> </span><span class="mi">0</span><span class="p">)))))</span>
<span class="w">      </span><span class="p">(</span><span class="k">type</span><span class="w"> </span><span class="p">(;</span><span class="mi">2</span><span class="p">;)</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="p">(</span><span class="n">param</span><span class="w"> </span><span class="p">(</span><span class="k">ref</span><span class="w"> </span><span class="k">struct</span><span class="p">)</span><span class="w"> </span><span class="kt">f64</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="p">(</span><span class="k">ref</span><span class="w"> </span><span class="mi">1</span><span class="p">))))</span>
<span class="w">      </span><span class="p">(</span><span class="k">type</span><span class="w"> </span><span class="p">(;</span><span class="mi">3</span><span class="p">;)</span><span class="w"> </span><span class="p">(</span><span class="n">sub</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="p">(</span><span class="n">field</span><span class="w"> </span><span class="p">(</span><span class="k">ref</span><span class="w"> </span><span class="mi">2</span><span class="p">)))))</span>
<span class="w">      </span><span class="p">(</span><span class="k">type</span><span class="w"> </span><span class="p">(;</span><span class="mi">4</span><span class="p">;)</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="p">(</span><span class="n">param</span><span class="w"> </span><span class="p">(</span><span class="k">ref</span><span class="w"> </span><span class="k">struct</span><span class="p">)</span><span class="w"> </span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="p">(</span><span class="k">ref</span><span class="w"> </span><span class="mi">3</span><span class="p">))))</span>
<span class="w">      </span><span class="p">(</span><span class="k">type</span><span class="w"> </span><span class="p">(;</span><span class="mi">5</span><span class="p">;)</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="p">(</span><span class="n">param</span><span class="w"> </span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="kt">f64</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="k">type</span><span class="w"> </span><span class="p">(;</span><span class="mi">6</span><span class="p">;)</span><span class="w"> </span><span class="p">(</span><span class="n">sub</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="p">(</span><span class="n">field</span><span class="w"> </span><span class="p">(</span><span class="k">ref</span><span class="w"> </span><span class="mi">4</span><span class="p">)))))</span>
<span class="w">      </span><span class="p">(</span><span class="k">type</span><span class="w"> </span><span class="p">(;</span><span class="mi">7</span><span class="p">;)</span><span class="w"> </span><span class="p">(</span><span class="n">sub</span><span class="w"> </span><span class="kr">final</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="p">(</span><span class="n">field</span><span class="w"> </span><span class="p">(</span><span class="k">ref</span><span class="w"> </span><span class="mi">4</span><span class="p">)))))</span>
<span class="w">      </span><span class="p">(</span><span class="n">import</span><span class="w"> </span><span class="s">"std::math"</span><span class="w"> </span><span class="s">"compute"</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="p">(;</span><span class="mi">0</span><span class="p">;)</span><span class="w"> </span><span class="p">(</span><span class="k">type</span><span class="w"> </span><span class="mi">4</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="n">export</span><span class="w"> </span><span class="s">"remote1"</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="n">export</span><span class="w"> </span><span class="s">"main"</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="n">export</span><span class="w"> </span><span class="s">"foo"</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="mi">2</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="n">export</span><span class="w"> </span><span class="s">"foo1"</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="mi">3</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="n">export</span><span class="w"> </span><span class="s">"foo2"</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="mi">4</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="p">(;</span><span class="mi">1</span><span class="p">;)</span><span class="w"> </span><span class="p">(</span><span class="k">type</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">param</span><span class="w"> </span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="kt">f64</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="n">local</span><span class="w"> </span><span class="p">(</span><span class="k">ref</span><span class="w"> </span><span class="mi">6</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">ref</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">ref</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span>
<span class="w">        </span><span class="k">ref</span><span class="p">.</span><span class="n">func</span><span class="w"> </span><span class="mi">2</span>
<span class="w">        </span><span class="k">struct</span><span class="p">.</span><span class="n">new</span><span class="w"> </span><span class="mi">7</span>
<span class="w">        </span><span class="k">ref</span><span class="p">.</span><span class="n">cast</span><span class="w"> </span><span class="p">(</span><span class="k">ref</span><span class="w"> </span><span class="mi">6</span><span class="p">)</span>
<span class="w">        </span><span class="n">local</span><span class="p">.</span><span class="n">tee</span><span class="w"> </span><span class="mi">1</span>
<span class="w">        </span><span class="kt">i64</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">1</span>
<span class="w">        </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">1</span>
<span class="w">        </span><span class="k">struct</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="mi">0</span>
<span class="w">        </span><span class="n">call_ref</span><span class="w"> </span><span class="mi">4</span>
<span class="w">        </span><span class="n">local</span><span class="p">.</span><span class="n">tee</span><span class="w"> </span><span class="mi">2</span>
<span class="w">        </span><span class="kt">f64</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mh">0x1</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="w"> </span><span class="p">(;</span><span class="o">=</span><span class="mi">2</span><span class="p">;)</span>
<span class="w">        </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">2</span>
<span class="w">        </span><span class="k">struct</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="mi">0</span>
<span class="w">        </span><span class="n">call_ref</span><span class="w"> </span><span class="mi">2</span>
<span class="w">        </span><span class="n">local</span><span class="p">.</span><span class="n">tee</span><span class="w"> </span><span class="mi">3</span>
<span class="w">        </span><span class="kt">f64</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mh">0x1</span><span class="p">.</span><span class="mi">8</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="w"> </span><span class="p">(;</span><span class="o">=</span><span class="mi">3</span><span class="p">;)</span>
<span class="w">        </span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">3</span>
<span class="w">        </span><span class="k">struct</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span>
<span class="w">        </span><span class="n">call_ref</span><span class="w"> </span><span class="mi">0</span>
<span class="w">        </span><span class="k">return</span>
<span class="w">      </span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="p">(;</span><span class="mi">2</span><span class="p">;)</span><span class="w"> </span><span class="p">(</span><span class="k">type</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">param</span><span class="w"> </span><span class="p">(</span><span class="k">ref</span><span class="w"> </span><span class="k">struct</span><span class="p">)</span><span class="w"> </span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="p">(</span><span class="k">ref</span><span class="w"> </span><span class="mi">3</span><span class="p">))</span>
<span class="w">            </span><span class="k">ref</span><span class="p">.</span><span class="n">func</span><span class="w"> </span><span class="mi">3</span>
<span class="w">            </span><span class="k">struct</span><span class="p">.</span><span class="n">new</span><span class="w"> </span><span class="mi">3</span>
<span class="w">            </span><span class="k">return</span>
<span class="w">      </span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="p">(;</span><span class="mi">3</span><span class="p">;)</span><span class="w"> </span><span class="p">(</span><span class="k">type</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">param</span><span class="w"> </span><span class="p">(</span><span class="k">ref</span><span class="w"> </span><span class="k">struct</span><span class="p">)</span><span class="w"> </span><span class="kt">f64</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="p">(</span><span class="k">ref</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span>
<span class="w">            </span><span class="k">ref</span><span class="p">.</span><span class="n">func</span><span class="w"> </span><span class="mi">4</span>
<span class="w">            </span><span class="k">struct</span><span class="p">.</span><span class="n">new</span><span class="w"> </span><span class="mi">1</span>
<span class="w">            </span><span class="k">return</span>
<span class="w">      </span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="p">(;</span><span class="mi">4</span><span class="p">;)</span><span class="w"> </span><span class="p">(</span><span class="k">type</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">param</span><span class="w"> </span><span class="p">(</span><span class="k">ref</span><span class="w"> </span><span class="k">struct</span><span class="p">)</span><span class="w"> </span><span class="kt">f64</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="kt">f64</span><span class="p">)</span>
<span class="w">            </span><span class="kt">f64</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mh">0x1</span><span class="n">p</span><span class="o">+</span><span class="mi">1</span><span class="w"> </span><span class="p">(;</span><span class="o">=</span><span class="mi">2</span><span class="p">;)</span>
<span class="w">            </span><span class="k">return</span>
<span class="w">      </span><span class="p">)</span>
<span class="w">    </span><span class="p">)</span>
</code></pre></div>
<p>Again lots of currying so I need multiple local functions to make this type check.</p>
<p>Is there something wrong about creating a function reference (using GC proposal semantics) to an imported function? Why does the code execute without a trap when its all local but not if a function is imported?</p>
<p>As far as I have been able to read in the various specs a function reference can be shared between core modules.</p>
<p>Here is the complete component if its helpful<br>
<a href="/user_uploads/15107/nWcf5Pyk5cIowOX15RXEc6LX/blr.wasm">blr.wasm</a></p>
<p>I can invoke it with </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">wasmtime</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">-</span><span class="n">W</span><span class="w"> </span><span class="n">gc</span><span class="o">=</span><span class="n">y</span><span class="p">,</span><span class="n">function</span><span class="o">-</span><span class="n">references</span><span class="o">=</span><span class="n">y</span><span class="p">,</span><span class="n">component</span><span class="o">-</span><span class="n">model</span><span class="o">-</span><span class="n">gc</span><span class="o">=</span><span class="n">y</span><span class="w"> </span><span class="o">--</span><span class="n">invoke</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">'</span><span class="w"> </span><span class="n">blr</span><span class="p">.</span><span class="n">wasm</span>
</code></pre></div>
<p>(I still need to update my compiler to emit code compatible with wasi/cli so I have a plain main function for now)</p>



<a name="538351130"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Trap%20on%20failed%20cast%20from%20imported%20function/near/538351130" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Trap.20on.20failed.20cast.20from.20imported.20function.html#538351130">(Sep 09 2025 at 05:00)</a>:</h4>
<p>This looks like a bug in wasmtime to me, thanks for the thorough writeup! Mind opening an issue on the wasmtime repo for this? Basically a copy paste of your message here should be sufficient.</p>
<p>Also <span class="user-mention" data-user-id="253990">@fitzgen (he/him)</span> you're likely interested in this</p>



<a name="538422265"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Trap%20on%20failed%20cast%20from%20imported%20function/near/538422265" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathaniel Cook <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Trap.20on.20failed.20cast.20from.20imported.20function.html#538422265">(Sep 09 2025 at 12:13)</a>:</h4>
<p>Good to know my workflow is expected, issue here <a href="https://github.com/bytecodealliance/wasmtime/issues/11650">https://github.com/bytecodealliance/wasmtime/issues/11650</a> </p>
<p>Do you see any workaround in the meantime?</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/issues/11650" style="background-image: url(&quot;https://uploads.zulipusercontent.net/d3b9aeed71f8cef14803306b3c61f65a5c4ce7a2/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f396239366635663635616564363536313039663932313333656463303330363436356330613535623435393633363338623539393264653365383536656664362f62797465636f6465616c6c69616e63652f7761736d74696d652f6973737565732f3131363530&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/issues/11650" title="Unexpected cast trap when making a call_ref · Issue #11650 · bytecodealliance/wasmtime">Unexpected cast trap when making a call_ref · Issue #11650 · bytecodealliance/wasmtime</a></div><div class="message_embed_description">The issue I am having is I get a trap for a failed cast when I try and run my component. The component is two composed components, one that links several core modules together generated by a compil...</div></div></div>



<a name="538463941"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Trap%20on%20failed%20cast%20from%20imported%20function/near/538463941" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Trap.20on.20failed.20cast.20from.20imported.20function.html#538463941">(Sep 09 2025 at 15:21)</a>:</h4>
<p>hm actually, are you sure that the trapping instruction is right?</p>
<p>Running that component locally I get the same two stack frames as the issue you opened, notably 0x17e517 called by 0x17e626</p>
<p>The failing instruction 0x17e517, however, is <code>ref.cast (ref 6)</code>, not a <code>call_ref</code> (although 0x17e626 is indeed call_ref). Is this perhaps a situation where the order of the backtrace was confused?</p>



<a name="538464102"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Trap%20on%20failed%20cast%20from%20imported%20function/near/538464102" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Trap.20on.20failed.20cast.20from.20imported.20function.html#538464102">(Sep 09 2025 at 15:22)</a>:</h4>
<p>basically the issue and your post here look like they're describing 0x17e626, the caller of the trapping function, not the trapping function at 0x17e517</p>



<a name="538464377"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Trap%20on%20failed%20cast%20from%20imported%20function/near/538464377" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathaniel Cook <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Trap.20on.20failed.20cast.20from.20imported.20function.html#538464377">(Sep 09 2025 at 15:23)</a>:</h4>
<p>Hmm, yeah I may have confused the order of the backtrace.</p>



<a name="538467048"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Trap%20on%20failed%20cast%20from%20imported%20function/near/538467048" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Nathaniel Cook <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Trap.20on.20failed.20cast.20from.20imported.20function.html#538467048">(Sep 09 2025 at 15:35)</a>:</h4>
<p>Yeah I can confirm I read the backtrace wrong and inspecting the <code>ref.cast (ref 6)</code> from the other core module its clear that the struct passed in is incorrect. Looks like a bug on my side. Appreciate the help and apologies for the noise. Kinda glads it my bug :) easier to fix.</p>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
<html>
<head><meta charset="utf-8"><title>Access raw TypedFunc and guest Memory in &quot;component mode&quot;? · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/index.html">general</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Access.20raw.20TypedFunc.20and.20guest.20Memory.20in.20.22component.20mode.22.3F.html">Access raw TypedFunc and guest Memory in &quot;component mode&quot;?</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="547081541"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Access%20raw%20TypedFunc%20and%20guest%20Memory%20in%20%22component%20mode%22%3F/near/547081541" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Meeuwsen <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Access.20raw.20TypedFunc.20and.20guest.20Memory.20in.20.22component.20mode.22.3F.html#547081541">(Oct 25 2025 at 20:42)</a>:</h4>
<p>I am using the standard embedded wasmtime host in component mode by using <code>bindgen!</code> macro and calling the generated guest resource trait methods and it works great. However, there is a hot function where this interface is forcing an additional copy (Rust Type -&gt; WIT Type -&gt; WASM memory) causing non-ideal performance. I think if I could go from Rust Type -&gt; WASM memory directly I could shave off some time. I just need to do this for 1 or 2 methods. Is there a way to do this?</p>



<a name="547082506"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Access%20raw%20TypedFunc%20and%20guest%20Memory%20in%20%22component%20mode%22%3F/near/547082506" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Access.20raw.20TypedFunc.20and.20guest.20Memory.20in.20.22component.20mode.22.3F.html#547082506">(Oct 25 2025 at 21:02)</a>:</h4>
<p>Not currently, no, there's no way to get core wasm functions from a component. Would you be able to share the shape of the performance problem you're running into? That could help guide perhaps an alternative architecture or possibly different APIs to add to wasmtime to make this faster</p>



<a name="547082839"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Access%20raw%20TypedFunc%20and%20guest%20Memory%20in%20%22component%20mode%22%3F/near/547082839" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Meeuwsen <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Access.20raw.20TypedFunc.20and.20guest.20Memory.20in.20.22component.20mode.22.3F.html#547082839">(Oct 25 2025 at 21:10)</a>:</h4>
<p>I created the same real world component in Rust native compiled mode and again as a WASM plugin (only difference is the WASM version uses <code>RefCell</code> to achieve mutability). I benchmarked the simple hot call that gets a slice of a WIT record as a param (which I convert from a slice of the non-WIT type). The native version is ~5ns per call and the WASM ~250ns per call on my M3 max. I haven't done any real profiling yet, but I suspect the handling of the slice conversion and copy into WASM memory is likely most of what is possible to optimize. The only optimization I did was swap out to a <code>SmallVec</code> from a <code>Vec</code> when converting to the WIT type. That shaved off 12% from skipping the allocation (~285ns --&gt; ~250ns). </p>
<p>This is the function I call on the host side:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">update_bar_and_calc</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">data</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="p">[</span><span class="n">indicator</span><span class="p">::</span><span class="n">DataUpdate</span><span class="p">],</span>
<span class="w">        </span><span class="n">new_bar</span><span class="p">:</span><span class="w"> </span><span class="kt">bool</span><span class="p">,</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="kt">f64</span><span class="p">,</span><span class="w"> </span><span class="n">StringError</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// TODO: Copy slice directly into Wasm memory instead of an extra copy/type conversion</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span>
<span class="w">            </span><span class="p">.</span><span class="n">iter</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">d</span><span class="o">|</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">into</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="n">collect</span><span class="p">::</span><span class="o">&lt;</span><span class="n">SmallVec</span><span class="o">&lt;</span><span class="p">[</span><span class="n">DataUpdate</span><span class="p">;</span><span class="w"> </span><span class="mi">4</span><span class="p">]</span><span class="o">&gt;&gt;</span><span class="p">();</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span>
<span class="w">            </span><span class="p">.</span><span class="n">component</span>
<span class="w">            </span><span class="p">.</span><span class="n">trading_indicator_guest</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="n">indicator</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="n">call_update_bar_and_calc</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">resource</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">new_bar</span><span class="p">);</span>
<span class="w">        </span><span class="bp">Self</span><span class="p">::</span><span class="n">map_result</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">value</span><span class="o">|</span><span class="w"> </span><span class="n">value</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
</code></pre></div>
<p>Guest side:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="sd">/// Update the current bar or start a new one</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">update_bar</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">:</span><span class="w"> </span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">DataUpdate</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">new_bar</span><span class="p">:</span><span class="w"> </span><span class="kt">bool</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="nb">String</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">new_bar</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Panic safety: data is same length as dependencies (length validated in 'new')</span>
<span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">borrow_mut</span><span class="p">().</span><span class="n">push</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">data</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Panic safety: data is same length as dependencies (length validated in 'new')</span>
<span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">borrow_mut</span><span class="p">().</span><span class="n">update_last</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">data</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="sd">/// Update the current bar or start a new one and calculate the indicator value</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">update_bar_and_calc</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">:</span><span class="w"> </span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">DataUpdate</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">new_bar</span><span class="p">:</span><span class="w"> </span><span class="kt">bool</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="kt">f64</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">update_bar</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">new_bar</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">borrow</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
<span class="w">    </span><span class="p">}</span>
</code></pre></div>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
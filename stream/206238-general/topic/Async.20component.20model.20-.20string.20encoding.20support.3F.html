<html>
<head><meta charset="utf-8"><title>Async component model - string encoding support? · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/index.html">general</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Async.20component.20model.20-.20string.20encoding.20support.3F.html">Async component model - string encoding support?</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="538076976"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Async%20component%20model%20-%20string%20encoding%20support%3F/near/538076976" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BigOrangeQWQ <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Async.20component.20model.20-.20string.20encoding.20support.3F.html#538076976">(Sep 07 2025 at 12:54)</a>:</h4>
<p>What is the support scope of Wasmtime's async component for different string encodings?</p>
<p>I have a WIT file as follows:</p>
<div class="codehilite" data-code-language="wit"><pre><span></span><code>package my:test;

interface i {
  ping: async func(x: future&lt;string&gt;, y: string) -&gt; future&lt;string&gt;;
}

world test {
  export i;
}

world runner {
  import i;
}
</code></pre></div>
<p>When using <code>wasm-tools component embed</code>, if the <code>string-encoding</code> parameters are different, it seems to trigger an <code>invalid</code> error during <code>task.return</code>. Specifically, because the parameter <code>y</code> is of type <code>string</code>, the <code>embed</code> operation encodes the <code>async lift</code>. However, if the <code>string-encoding</code> of <code>test</code> and <code>runner</code> differs, it causes an issue at this point (as seen in <a href="https://github.com/bytecodealliance/wasip3-prototyping/blob/68389f75e28468576fb5aa88d6ec173cb21fc603/crates/wasmtime/src/runtime/component/concurrent.rs#L2802">this code line</a>).</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasip3-prototyping/blob/68389f75e28468576fb5aa88d6ec173cb21fc603/crates/wasmtime/src/runtime/component/concurrent.rs#L2802" style="background-image: url(&quot;https://uploads.zulipusercontent.net/7726f6c11ef9ec07a71d50fcf569018b85c9da17/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f643166343163363937623361646561333835663637353964643161323236663435366538323930666461623134323938653864636261623931643333636565612f62797465636f6465616c6c69616e63652f7761736970332d70726f746f747970696e67&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasip3-prototyping/blob/68389f75e28468576fb5aa88d6ec173cb21fc603/crates/wasmtime/src/runtime/component/concurrent.rs#L2802" title="wasip3-prototyping/crates/wasmtime/src/runtime/component/concurrent.rs at 68389f75e28468576fb5aa88d6ec173cb21fc603 · bytecodealliance/wasip3-prototyping">wasip3-prototyping/crates/wasmtime/src/runtime/component/concurrent.rs at 68389f75e28468576fb5aa88d6ec173cb21fc603 · bytecodealliance/wasip3-prototyping</a></div><div class="message_embed_description">Fork of wasmtime for protoyping WASIp3 work and coordination, not intended for any production use case, purely for development - bytecodealliance/wasip3-prototyping</div></div></div>



<a name="538127070"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Async%20component%20model%20-%20string%20encoding%20support%3F/near/538127070" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Async.20component.20model.20-.20string.20encoding.20support.3F.html#538127070">(Sep 08 2025 at 04:07)</a>:</h4>
<p>non-utf8 encodings aren't super well tested right now, so while wasmtime should have support for everything this is likely a guest toolchain issue unable to produce the correct component. Could you file an issue with a reproduction? That'll help narrow down where the bug lies and we can transfer it to the right repo once the source is found</p>



<a name="538267807"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Async%20component%20model%20-%20string%20encoding%20support%3F/near/538267807" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> BigOrangeQWQ <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Async.20component.20model.20-.20string.20encoding.20support.3F.html#538267807">(Sep 08 2025 at 16:10)</a>:</h4>
<p>Yes, I agree. This issue cannot be reproduced with the wat files generated by <code>wasm-tools embed --dummy-names legacy --async-callback</code> (I've tried many methods but all failed). However, the wat code generated by <code>wit-bindgen</code> is too lengthy. I'm currently thinking about how to minimize the error case before submitting an issue.</p>



<a name="538291626"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Async%20component%20model%20-%20string%20encoding%20support%3F/near/538291626" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Async.20component.20model.20-.20string.20encoding.20support.3F.html#538291626">(Sep 08 2025 at 18:30)</a>:</h4>
<p>it's ok if it's not the most minimal thing in the world, we can help minimize too once we can repro</p>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
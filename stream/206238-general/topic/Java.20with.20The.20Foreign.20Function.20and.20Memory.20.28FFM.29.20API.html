<html>
<head><meta charset="utf-8"><title>Java with The Foreign Function and Memory (FFM) API · general · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/index.html">general</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html">Java with The Foreign Function and Memory (FFM) API</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="537766505"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537766505" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Benjamin Fry <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537766505">(Sep 04 2025 at 22:46)</a>:</h4>
<p>I am finally coming back to experiment with getting Wasmtime running in Java with the now stabilized FFM API and jextract. I'm currently running into an issue with getting the the <code>hello.c</code> C api demo working (in Java). It looks like I'm running into a poisoned <code>RwLock</code> in the <code>TypeRegistry</code>, clearing the poisoned value gets passed the issue, but then just runs into another panic after in <code>RegisteredType::register_singleton_rec_group</code>. This is all happening during the call to <code>wasmtime_func_new</code> matching the logic in <code>hello.c</code>. Anyone have any tips on how track down the issue and why this lock is getting poisoned? (this is in the current release-36.0.0 branch)</p>



<a name="537767390"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537767390" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537767390">(Sep 04 2025 at 22:57)</a>:</h4>
<p>If a lock is poisioned it means the thread it was running on died somehow (unwound via an exception)</p>



<a name="537767649"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537767649" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537767649">(Sep 04 2025 at 22:59)</a>:</h4>
<p>You can use the wasmtime c api from multiple threads safely, because internally wasmtime is thread safe, but if you unwind across wasmtime in one of your threads its quite possible to break everything for all threads</p>



<a name="537767750"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537767750" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Benjamin Fry <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537767750">(Sep 04 2025 at 23:00)</a>:</h4>
<p>I'm not currently spawning any additional threads. Is there a background process in Wasmtime?</p>



<a name="537767838"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537767838" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537767838">(Sep 04 2025 at 23:01)</a>:</h4>
<p>wasmtime will spawn threads in order to parallelize cranelift codegen of wasm</p>



<a name="537767858"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537767858" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537767858">(Sep 04 2025 at 23:01)</a>:</h4>
<p>but it manages those itself</p>



<a name="537767927"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537767927" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537767927">(Sep 04 2025 at 23:02)</a>:</h4>
<p>and if you're using wasmtime-wasi in there, it will start its own multi-threaded tokio to perform io</p>



<a name="537767974"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537767974" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Benjamin Fry <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537767974">(Sep 04 2025 at 23:02)</a>:</h4>
<p>yeah, this is literally just the hello demo, <a href="https://docs.wasmtime.dev/examples-c-hello-world.html">https://docs.wasmtime.dev/examples-c-hello-world.html</a>, nothing fancy yet.</p>



<a name="537768137"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537768137" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Benjamin Fry <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537768137">(Sep 04 2025 at 23:04)</a>:</h4>
<p>I'll see if I cut out the junit test runner if that removes some of the potential issues.</p>



<a name="537768143"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537768143" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537768143">(Sep 04 2025 at 23:04)</a>:</h4>
<p>sorry, I really don't have any other ideas. I don't know the jvm or FFM well enough to guess what might be getting you there.</p>



<a name="537768398"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537768398" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537768398">(Sep 04 2025 at 23:07)</a>:</h4>
<p>If you're able to set an environment variable <code>WASMTIME_LOG=trace</code>, the trace-log output from Wasmtime might give some hints as to what's going wrong</p>



<a name="537768443"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537768443" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537768443">(Sep 04 2025 at 23:07)</a>:</h4>
<p>(feel free to put that in a gist and link here -- I can't guarantee I'll see anything but someone might)</p>



<a name="537768480"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537768480" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Benjamin Fry <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537768480">(Sep 04 2025 at 23:08)</a>:</h4>
<p>ah, cool, I was wondering about that. I hacked up the code a bunch in wasmtime already to try and trace all of this in more detail.</p>



<a name="537768550"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537768550" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537768550">(Sep 04 2025 at 23:09)</a>:</h4>
<p>Oh it'll be <a href="https://github.com/bytecodealliance/wasmtime/blob/a631d20afa7a0154e63c2b8aa34a979864518991/crates/c-api/src/engine.rs#L14-L23"><code>RUST_LOG</code> for the c api</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/blob/a631d20afa7a0154e63c2b8aa34a979864518991/crates/c-api/src/engine.rs#L14-L23" style="background-image: url(&quot;https://uploads.zulipusercontent.net/ad70039577a9e226e3ac650db5a47b0386dfc46b/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f376138346631373561663432353133356438376434353363386132656133323561643232646134636163383261353866386361396130343761313735373862652f62797465636f6465616c6c69616e63652f7761736d74696d65&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/blob/a631d20afa7a0154e63c2b8aa34a979864518991/crates/c-api/src/engine.rs#L14-L23" title="wasmtime/crates/c-api/src/engine.rs at a631d20afa7a0154e63c2b8aa34a979864518991 · bytecodealliance/wasmtime">wasmtime/crates/c-api/src/engine.rs at a631d20afa7a0154e63c2b8aa34a979864518991 · bytecodealliance/wasmtime</a></div><div class="message_embed_description">A lightweight WebAssembly runtime that is fast, secure, and standards-compliant - bytecodealliance/wasmtime</div></div></div>



<a name="537768570"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537768570" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537768570">(Sep 04 2025 at 23:09)</a>:</h4>
<p>could you gist a backtrace as well?</p>



<a name="537768626"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537768626" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537768626">(Sep 04 2025 at 23:10)</a>:</h4>
<p>if you're running into a poisoned lock that means that something panicked earlier and that's the interesting backtrace in theory</p>



<a name="537768644"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537768644" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537768644">(Sep 04 2025 at 23:10)</a>:</h4>
<p>I'm not aware of anything which would cause this so it sounds like a bug</p>



<a name="537768950"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537768950" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Benjamin Fry <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537768950">(Sep 04 2025 at 23:14)</a>:</h4>
<p>Here's the backtrace: <a href="https://gist.github.com/bluejekyll/ff28e00ed03c9a3fc689291be2a8fd0b">https://gist.github.com/bluejekyll/ff28e00ed03c9a3fc689291be2a8fd0b</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://gist.github.com/bluejekyll/ff28e00ed03c9a3fc689291be2a8fd0b" style="background-image: url(&quot;https://uploads.zulipusercontent.net/2aafd906f69f8f71c7544060163ba3e419b173e8/68747470733a2f2f6769746875622e6769746875626173736574732e636f6d2f696d616765732f6d6f64756c65732f67697374732f676973742d6f672d696d6167652e706e67&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://gist.github.com/bluejekyll/ff28e00ed03c9a3fc689291be2a8fd0b" title="Poisoned RwLock in Wasmtime">Poisoned RwLock in Wasmtime</a></div><div class="message_embed_description">Poisoned RwLock in Wasmtime. GitHub Gist: instantly share code, notes, and snippets.</div></div></div>



<a name="537768995"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537768995" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Benjamin Fry <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537768995">(Sep 04 2025 at 23:14)</a>:</h4>
<p>let me get the full traced logs as well.</p>



<a name="537768998"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537768998" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537768998">(Sep 04 2025 at 23:14)</a>:</h4>
<p>oh</p>



<a name="537769004"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537769004" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537769004">(Sep 04 2025 at 23:14)</a>:</h4>
<p>no I got it</p>



<a name="537769008"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537769008" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537769008">(Sep 04 2025 at 23:14)</a>:</h4>
<p>wait no nvmd</p>



<a name="537769088"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537769088" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537769088">(Sep 04 2025 at 23:15)</a>:</h4>
<p>is this all you see, nothing else? There in theory should be some other backtrace b/c poisoning a lock should require a panic somewhere</p>



<a name="537769743"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537769743" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Benjamin Fry <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537769743">(Sep 04 2025 at 23:24)</a>:</h4>
<p>So far, the engine, store, and context all are created without errors. I can compile the wat -&gt; wasm without error. so things are "working" up to that point. I had a theory that the func_ty I was creating for the C callback was bad, but that appears to be fine as well.</p>



<a name="537769751"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537769751" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Benjamin Fry <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537769751">(Sep 04 2025 at 23:24)</a>:</h4>
<p>I have the full logs now...</p>



<a name="537769820"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537769820" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537769820">(Sep 04 2025 at 23:25)</a>:</h4>
<p>so you sort of <a href="https://github.com/bytecodealliance/wasmtime/blob/a631d20afa7a0154e63c2b8aa34a979864518991/examples/hello.c#L76">got this far</a> in a sense? (converted to Java of course)</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/blob/a631d20afa7a0154e63c2b8aa34a979864518991/examples/hello.c#L76" style="background-image: url(&quot;https://uploads.zulipusercontent.net/ad70039577a9e226e3ac650db5a47b0386dfc46b/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f376138346631373561663432353133356438376434353363386132656133323561643232646134636163383261353866386361396130343761313735373862652f62797465636f6465616c6c69616e63652f7761736d74696d65&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/blob/a631d20afa7a0154e63c2b8aa34a979864518991/examples/hello.c#L76" title="wasmtime/examples/hello.c at a631d20afa7a0154e63c2b8aa34a979864518991 · bytecodealliance/wasmtime">wasmtime/examples/hello.c at a631d20afa7a0154e63c2b8aa34a979864518991 · bytecodealliance/wasmtime</a></div><div class="message_embed_description">A lightweight WebAssembly runtime that is fast, secure, and standards-compliant - bytecodealliance/wasmtime</div></div></div>



<a name="537769939"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537769939" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Benjamin Fry <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537769939">(Sep 04 2025 at 23:27)</a>:</h4>
<p>yeah, exactly.</p>



<a name="537770120"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537770120" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Benjamin Fry <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537770120">(Sep 04 2025 at 23:30)</a>:</h4>
<p>I added a comment to that gist that has the log output.</p>



<a name="537770178"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537770178" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537770178">(Sep 04 2025 at 23:30)</a>:</h4>
<p>wow but really no other panicking backtrace?</p>



<a name="537770195"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537770195" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537770195">(Sep 04 2025 at 23:30)</a>:</h4>
<p>you could try running wasmtime inside gdb and adding catch points for rust panics, that should show wherever the panic is happening</p>



<a name="537770293"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537770293" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Benjamin Fry <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537770293">(Sep 04 2025 at 23:31)</a>:</h4>
<p>running in gdb will be hard... I'm going to try and remove some of the maven and junit overhead to make it just a raw java execution. that will take me a minute...</p>



<a name="537770320"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537770320" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537770320">(Sep 04 2025 at 23:32)</a>:</h4>
<p>how certain are you that the bindings are right? b/c this could also be random corruption of memory or something like that</p>



<a name="537770331"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537770331" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537770331">(Sep 04 2025 at 23:32)</a>:</h4>
<p>e.g. you just happen to flip the "this is poisoned lock" bit</p>



<a name="537770350"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537770350" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537770350">(Sep 04 2025 at 23:32)</a>:</h4>
<p>albeit implausible</p>



<a name="537770416"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537770416" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Benjamin Fry <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537770416">(Sep 04 2025 at 23:33)</a>:</h4>
<p>Oh, it totally could be corruption. I'm definitely new to this Java FFM API. I've done a lot of double checking, but definitely could be something there. I did try clearing the bit, but things are clearly in a bad state at that point.</p>



<a name="537770457"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537770457" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537770457">(Sep 04 2025 at 23:34)</a>:</h4>
<p>a smoking gun for wasmtime would be a reproduction with just the C API (e.g. a C file repro)</p>



<a name="537770461"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537770461" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537770461">(Sep 04 2025 at 23:34)</a>:</h4>
<p>but I realize that's probably difficult to create in this case</p>



<a name="537770472"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537770472" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537770472">(Sep 04 2025 at 23:34)</a>:</h4>
<p>actually in gdb you'll want to use <code>rbreak rust_panic</code> according to <a href="https://github.com/rust-lang/rust/issues/21102#issuecomment-3080599300">https://github.com/rust-lang/rust/issues/21102#issuecomment-3080599300</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/rust-lang/rust/issues/21102#issuecomment-3080599300" style="background-image: url(&quot;https://uploads.zulipusercontent.net/2329b09b88df69b67de7eb71be2145b190c67e8e/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f663030623561333733666436336231393061373439623731656330353164653861373066353863343637356462336332663339646664643230303763623062372f727573742d6c616e672f727573742f6973737565732f3231313032&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/rust-lang/rust/issues/21102#issuecomment-3080599300" title="GDB should break on panic · Issue #21102 · rust-lang/rust">GDB should break on panic · Issue #21102 · rust-lang/rust</a></div><div class="message_embed_description">Expected behavior: when I use gdb, gdb should catch the panic and I should be able to use bt to analyze the stack. when I use RUST_BACKTRACE=1 I should see source files and line numbers in the back...</div></div></div>



<a name="537770624"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537770624" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Benjamin Fry <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537770624">(Sep 04 2025 at 23:35)</a>:</h4>
<p>Yeah, I assume at this point that I'm screwing something up with Java, but I've not found that yet.</p>



<a name="537770753"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537770753" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537770753">(Sep 04 2025 at 23:36)</a>:</h4>
<p>are you able to push up some code to glance over?</p>



<a name="537770768"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537770768" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537770768">(Sep 04 2025 at 23:36)</a>:</h4>
<p>I also know nothing of java or ffm but something might stick out still</p>



<a name="537770861"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537770861" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Benjamin Fry <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537770861">(Sep 04 2025 at 23:37)</a>:</h4>
<p>I can post a gist of the demo code that I have in Java, if you want more I could push it...</p>



<a name="537770878"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537770878" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537770878">(Sep 04 2025 at 23:37)</a>:</h4>
<p>yeah just w/e you got so far interacting with the C API</p>



<a name="537771001"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537771001" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Benjamin Fry <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537771001">(Sep 04 2025 at 23:39)</a>:</h4>
<p>Here's the impl: <a href="https://gist.github.com/bluejekyll/cd0f53f2c701ce6f879c305048b1da73">https://gist.github.com/bluejekyll/cd0f53f2c701ce6f879c305048b1da73</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://gist.github.com/bluejekyll/cd0f53f2c701ce6f879c305048b1da73" style="background-image: url(&quot;https://uploads.zulipusercontent.net/2aafd906f69f8f71c7544060163ba3e419b173e8/68747470733a2f2f6769746875622e6769746875626173736574732e636f6d2f696d616765732f6d6f64756c65732f67697374732f676973742d6f672d696d6167652e706e67&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://gist.github.com/bluejekyll/cd0f53f2c701ce6f879c305048b1da73" title="WasmtimeJavaTest.java">WasmtimeJavaTest.java</a></div><div class="message_embed_description">WasmtimeJavaTest.java. GitHub Gist: instantly share code, notes, and snippets.</div></div></div>



<a name="537771132"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537771132" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Benjamin Fry <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537771132">(Sep 04 2025 at 23:41)</a>:</h4>
<p>I have my old JNI stuff lying around this codebase, I'd prefer not to push all of that until I get it cleaned up.</p>



<a name="537771354"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537771354" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537771354">(Sep 04 2025 at 23:44)</a>:</h4>
<p>unsure if this would affect things but <code>helloCallbackDesc</code> doesn't look quite right</p>



<a name="537771381"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537771381" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537771381">(Sep 04 2025 at 23:44)</a>:</h4>
<p>or is one of the first arguments the return value?</p>



<a name="537771382"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537771382" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537771382">(Sep 04 2025 at 23:44)</a>:</h4>
<p>return type*</p>



<a name="537771572"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537771572" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Benjamin Fry <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537771572">(Sep 04 2025 at 23:47)</a>:</h4>
<p>Doesn't that match this C API? <a href="https://github.com/bytecodealliance/wasmtime/blob/1047b51183f5906ded5d82ec375f77e586485b5f/examples/hello.c#L19-L21">https://github.com/bytecodealliance/wasmtime/blob/1047b51183f5906ded5d82ec375f77e586485b5f/examples/hello.c#L19-L21</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/blob/1047b51183f5906ded5d82ec375f77e586485b5f/examples/hello.c#L19-L21" style="background-image: url(&quot;https://uploads.zulipusercontent.net/959e7cb26fadaff8b8e8969e7e2a2fba8c87a89a/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f393664326664393636343036303938386331393136353465313164373537386630386637646565613130653438633732373131396232613561613064323631632f62797465636f6465616c6c69616e63652f7761736d74696d65&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/blob/1047b51183f5906ded5d82ec375f77e586485b5f/examples/hello.c#L19-L21" title="wasmtime/examples/hello.c at 1047b51183f5906ded5d82ec375f77e586485b5f · bytecodealliance/wasmtime">wasmtime/examples/hello.c at 1047b51183f5906ded5d82ec375f77e586485b5f · bytecodealliance/wasmtime</a></div><div class="message_embed_description">A lightweight WebAssembly runtime that is fast, secure, and standards-compliant - bytecodealliance/wasmtime</div></div></div>



<a name="537771598"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537771598" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Benjamin Fry <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537771598">(Sep 04 2025 at 23:47)</a>:</h4>
<p>I think the whole thing is crashing before that call though...</p>



<a name="537771704"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537771704" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537771704">(Sep 04 2025 at 23:48)</a>:</h4>
<p>no I think I'm just confused, it looks like the first parameter is actually the return type, then it's all the param types</p>



<a name="537771737"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537771737" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537771737">(Sep 04 2025 at 23:48)</a>:</h4>
<p>I thought it was just the param types but then the return type wouldn't otherwise be specified anywhere</p>



<a name="537771809"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537771809" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537771809">(Sep 04 2025 at 23:49)</a>:</h4>
<p>ok wild and crazy guess: tls is super borked</p>



<a name="537771837"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537771837" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537771837">(Sep 04 2025 at 23:50)</a>:</h4>
<p>IIRC panicking/poisoning goes through TLS infrastructure in the rust standard library and maybe something about that is super broken in this context</p>



<a name="537771873"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537771873" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537771873">(Sep 04 2025 at 23:50)</a>:</h4>
<p>so, e.g., when the lock is originally unlocked it mistakenly thinks the thread is panicking because the implementation of TLS is broken</p>



<a name="537771922"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537771922" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537771922">(Sep 04 2025 at 23:51)</a>:</h4>
<p>to confirm/deny this since it looks like you have a custom build of Wasmtime already you might be able to print <a href="https://doc.rust-lang.org/stable/std/thread/fn.panicking.html">this function's result</a> in various places throughout wasmtime</p>



<a name="537771941"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537771941" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537771941">(Sep 04 2025 at 23:51)</a>:</h4>
<p>that should always return <code>false</code> but if it prints true then something is gone wrong</p>



<a name="537771974"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537771974" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Benjamin Fry <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537771974">(Sep 04 2025 at 23:51)</a>:</h4>
<p>yeah, I can do that.</p>



<a name="537771980"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537771980" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Benjamin Fry <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537771980">(Sep 04 2025 at 23:51)</a>:</h4>
<p>give me a minute.</p>



<a name="537772010"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537772010" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537772010">(Sep 04 2025 at 23:52)</a>:</h4>
<p>how is wasmtime linked? I presume it's not statically linked so is java dlopen'ing the <a href="http://libwasmtime.so">libwasmtime.so</a> somewhere?</p>



<a name="537772237"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537772237" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Benjamin Fry <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537772237">(Sep 04 2025 at 23:54)</a>:</h4>
<p>yeah, dylib.</p>



<a name="537772373"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537772373" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Benjamin Fry <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537772373">(Sep 04 2025 at 23:57)</a>:</h4>
<p>here's the hs_err log file from java that has a bunch of state captured, if you're interested... (which is a SEGFAULT that I thought was partially due to the panic and the poisoned lock as I dug deeper). <a href="https://gist.github.com/bluejekyll/760a232f39c651647552e095f2451e24">https://gist.github.com/bluejekyll/760a232f39c651647552e095f2451e24</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://gist.github.com/bluejekyll/760a232f39c651647552e095f2451e24" style="background-image: url(&quot;https://uploads.zulipusercontent.net/2aafd906f69f8f71c7544060163ba3e419b173e8/68747470733a2f2f6769746875622e6769746875626173736574732e636f6d2f696d616765732f6d6f64756c65732f67697374732f676973742d6f672d696d6167652e706e67&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://gist.github.com/bluejekyll/760a232f39c651647552e095f2451e24" title="Wasmtime C API with Java Heap">Wasmtime C API with Java Heap</a></div><div class="message_embed_description">Wasmtime C API with Java Heap. GitHub Gist: instantly share code, notes, and snippets.</div></div></div>



<a name="537772562"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537772562" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Benjamin Fry <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537772562">(Sep 04 2025 at 23:59)</a>:</h4>
<p>that get's handled by Java's generated functions from the jextract tool.</p>



<a name="537772798"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537772798" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537772798">(Sep 05 2025 at 00:02)</a>:</h4>
<p>ok I think that may still be explainable with broken tls</p>



<a name="537772840"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537772840" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537772840">(Sep 05 2025 at 00:02)</a>:</h4>
<p>notably <code>RegisteredType::new</code> is on the stack which does rwlock things which hits tls</p>



<a name="537773088"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537773088" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537773088">(Sep 05 2025 at 00:06)</a>:</h4>
<p><a href="https://stackoverflow.com/questions/51116820/c-11-thread-local-and-foreign-threads">https://stackoverflow.com/questions/51116820/c-11-thread-local-and-foreign-threads</a> seems semi-related but also not helpful</p>
<div class="message_embed"><a class="message_embed_image" href="https://stackoverflow.com/questions/51116820/c-11-thread-local-and-foreign-threads" style="background-image: url(&quot;https://uploads.zulipusercontent.net/925df65c212e80f19e81fcac1fb25e660797c3ce/68747470733a2f2f63646e2e737374617469632e6e65742f53697465732f737461636b6f766572666c6f772f496d672f6170706c652d746f7563682d69636f6e40322e706e673f763d373364373961383962646564&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://stackoverflow.com/questions/51116820/c-11-thread-local-and-foreign-threads" title="C++ 11 thread_local and &quot;foreign&quot; threads">C++ 11 thread_local and "foreign" threads</a></div><div class="message_embed_description">I would like to use C++ 11 thread_local, but our application embeds a JVM, and sometimes C++ methods are called from Java-created thread via JNI. This is essentially the same problem as if an exter...</div></div></div>



<a name="537773191"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537773191" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Benjamin Fry <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537773191">(Sep 05 2025 at 00:07)</a>:</h4>
<p>wow, good find, let me read through that.</p>



<a name="537773305"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537773305" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537773305">(Sep 05 2025 at 00:09)</a>:</h4>
<p>apart from this though I'm all out of ideas :(</p>



<a name="537773603"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537773603" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Benjamin Fry <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537773603">(Sep 05 2025 at 00:11)</a>:</h4>
<p>Yeah, I'll keep digging. I think some of these hints have been good so far, and at least give me some things to experiment with.</p>



<a name="537865430"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537865430" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> David Lloyd <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537865430">(Sep 05 2025 at 13:00)</a>:</h4>
<p>I'd be interested in hearing more about how/if the JVM is trashing the TLS context if you find out anything specific</p>



<a name="537956656"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537956656" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Benjamin Fry <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537956656">(Sep 05 2025 at 22:48)</a>:</h4>
<p>I found something about some potential issues with signals for traps, disabling <code>signals_based_traps</code> (which btw, is not exposed to the c-api) seems to have "helped". I'm now getting to a more consistent failure at a slightly different location. But this is progress.</p>



<a name="537957386"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537957386" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537957386">(Sep 05 2025 at 22:58)</a>:</h4>
<p>that would make sense since I'd expect both the JVM and wasmtime use SIGSEGV or similar for catching illegal memory accesses (null references for Java)</p>



<a name="537957620"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537957620" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537957620">(Sep 05 2025 at 23:01)</a>:</h4>
<p>Wasmtime does have logic to forward on to an already-registered signal handler (see <a href="https://github.com/bytecodealliance/wasmtime/blob/9f47be2ed6b4ea99fd86f2592277a26d65eff5da/crates/wasmtime/src/runtime/vm/sys/unix/signals.rs#L232">here</a>); so this isn't a slam-dunk obvious conflict, at least, though there could still be weird interactions of course.</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/blob/9f47be2ed6b4ea99fd86f2592277a26d65eff5da/crates/wasmtime/src/runtime/vm/sys/unix/signals.rs#L232" style="background-image: url(&quot;https://uploads.zulipusercontent.net/f1d88351edc632f04736636a77a7234354e2b8bd/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f666566393036393763343264636265303132376362383462653166303931666335616132303661663234323862383538316231316263643634333263646234372f62797465636f6465616c6c69616e63652f7761736d74696d65&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/blob/9f47be2ed6b4ea99fd86f2592277a26d65eff5da/crates/wasmtime/src/runtime/vm/sys/unix/signals.rs#L232" title="wasmtime/crates/wasmtime/src/runtime/vm/sys/unix/signals.rs at 9f47be2ed6b4ea99fd86f2592277a26d65eff5da · bytecodealliance/wasmtime">wasmtime/crates/wasmtime/src/runtime/vm/sys/unix/signals.rs at 9f47be2ed6b4ea99fd86f2592277a26d65eff5da · bytecodealliance/wasmtime</a></div><div class="message_embed_description">A lightweight WebAssembly runtime that is fast, secure, and standards-compliant - bytecodealliance/wasmtime</div></div></div>



<a name="537958631"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537958631" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537958631">(Sep 05 2025 at 23:15)</a>:</h4>
<p>ok I know I'm a broken record but wasmtime's signal handler accesses TLS, and if we assume that the JVM sort of randomly gets signals for GC and whatnot and/or for other threads, and if we assume that accessing TLS in Rust is an issue, then that would explain a why a nondeterministic error with signal handling would be replaced by a deterministic error without signal handling. (but perhaps still point a smoking gun at tls...)</p>



<a name="537959328"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537959328" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Benjamin Fry <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537959328">(Sep 05 2025 at 23:27)</a>:</h4>
<p>Yeah, I'm continuing to try and track that down. But disabling the signal handling gives me a consistent failure scenario, whereas before it was hard to track down.</p>



<a name="537959504"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537959504" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Benjamin Fry <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537959504">(Sep 05 2025 at 23:30)</a>:</h4>
<p>Other things I need to double check somehow is if the Arena based allocations in the Java layer are somehow not playing nice in Rust, like somehow having different layouts or something.</p>



<a name="537959556"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537959556" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537959556">(Sep 05 2025 at 23:31)</a>:</h4>
<p>rust is going to be pulling in an allocator from libc</p>



<a name="537959700"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/206238-general/topic/Java%20with%20The%20Foreign%20Function%20and%20Memory%20%28FFM%29%20API/near/537959700" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/206238-general/topic/Java.20with.20The.20Foreign.20Function.20and.20Memory.20.28FFM.29.20API.html#537959700">(Sep 05 2025 at 23:34)</a>:</h4>
<p>both your libc and the jvm are going to be implementing their allocators by asking the OS for pages through mmap, i wouldnt be too suspicious about that compared to the red flags around TLS</p>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
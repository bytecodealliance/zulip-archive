<html>
<head><meta charset="utf-8"><title>[browser] poll_oneoff - Not a valid &quot;Pollable&quot; · jco · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/409526-jco/index.html">jco</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/409526-jco/topic/.5Bbrowser.5D.20poll_oneoff.20-.20Not.20a.20valid.20.22Pollable.22.html">[browser] poll_oneoff - Not a valid &quot;Pollable&quot;</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="547839040"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/409526-jco/topic/%5Bbrowser%5D%20poll_oneoff%20-%20Not%20a%20valid%20%22Pollable%22/near/547839040" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ed <a href="https://bytecodealliance.github.io/zulip-archive/stream/409526-jco/topic/.5Bbrowser.5D.20poll_oneoff.20-.20Not.20a.20valid.20.22Pollable.22.html#547839040">(Oct 30 2025 at 01:31)</a>:</h4>
<p><span class="user-mention silent" data-user-id="983594">Ed</span> <a href="#narrow/channel/206238-general/topic/.5Bbrowser.5D.20poll_oneoff.20-.20Not.20a.20valid.20.22Pollable.22/near/547838957">said</a>:</p>
<blockquote>
<p>TLDR: when my component calls WASI poll_oneoff it fails with "Not a valid 'Pollable' resource"</p>
<p>This is a real hack, but I hope I can be pointed in the right direction as I can't find any resources for more info on this. Background: this project is to perform patching on binary firmware files for industrial equipment. We have a working prototype via a container and need to get it out to the front line</p>
<p>We use Container2WASM (<a href="https://github.com/container2wasm/container2wasm">https://github.com/container2wasm/container2wasm</a>) to build the container into a WASM module (which uses WASI Preview1), then call wasm-tools to make that into a component (using the  wasm1 console adapter) and then call JCO to transpile that.</p>
<p>The core loads and starts, but once the VM starts polling, it fails witht he following exception:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">[</span><span class="n">PatchFirmware</span><span class="p">]</span><span class="w"> </span><span class="n">Error</span><span class="p">:</span><span class="w"> </span><span class="nc">TypeError</span><span class="p">:</span><span class="w"> </span><span class="nc">Resource</span><span class="w"> </span><span class="n">error</span><span class="p">:</span><span class="w"> </span><span class="nc">Not</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">valid</span><span class="w"> </span><span class="s">"Pollable"</span><span class="w"> </span><span class="n">resource</span><span class="p">.</span>

<span class="n">at</span><span class="w"> </span><span class="n">trampoline6</span><span class="w"> </span><span class="p">(</span><span class="n">firmwarepatcher</span><span class="p">.</span><span class="n">js</span><span class="p">:</span><span class="mi">862</span><span class="p">:</span><span class="mi">11</span><span class="p">)</span>

<span class="n">at</span><span class="w"> </span><span class="n">poll_oneoff</span><span class="w"> </span><span class="p">(</span><span class="n">firmwarepatcher</span><span class="p">.</span><span class="n">core2</span><span class="p">.</span><span class="n">wasm</span><span class="p">:</span><span class="mh">0x54a6</span><span class="p">)</span>

<span class="n">at</span><span class="w"> </span><span class="n">abba7226</span><span class="p">:</span><span class="mh">0x2b0</span>

<span class="n">at</span><span class="w"> </span><span class="n">__imported_wasi_snapshot_preview1_poll_oneoff</span><span class="w"> </span><span class="p">(</span><span class="n">firmwarepatcher</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">wasm</span><span class="p">:</span><span class="mh">0xae85</span><span class="p">)</span>

<span class="n">at</span><span class="w"> </span><span class="n">__wasi_poll_oneoff</span><span class="w"> </span><span class="p">(</span><span class="n">firmwarepatcher</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">wasm</span><span class="p">:</span><span class="mh">0x70787</span><span class="p">)</span>

<span class="n">at</span><span class="w"> </span><span class="n">pselect</span><span class="w"> </span><span class="p">(</span><span class="n">firmwarepatcher</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">wasm</span><span class="p">:</span><span class="mh">0x6be92</span><span class="p">)</span>

<span class="n">at</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="p">(</span><span class="n">firmwarepatcher</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">wasm</span><span class="p">:</span><span class="mh">0x6c045</span><span class="p">)</span>

<span class="n">at</span><span class="w"> </span><span class="n">virt_machine_run</span><span class="w"> </span><span class="p">(</span><span class="n">firmwarepatcher</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">wasm</span><span class="p">:</span><span class="mh">0x9693</span><span class="p">)</span>

<span class="n">at</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="p">(</span><span class="n">firmwarepatcher</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">wasm</span><span class="p">:</span><span class="mh">0xabc5</span><span class="p">)</span>

<span class="n">at</span><span class="w"> </span><span class="n">__main_void</span><span class="w"> </span><span class="p">(</span><span class="n">firmwarepatcher</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">wasm</span><span class="p">:</span><span class="mh">0x6c4dc</span><span class="p">)</span>
</code></pre></div>
<p>Previously we were using browser_wasi_shim with C2W (<a href="https://github.com/bjorn3/browser_wasi_shim">https://github.com/bjorn3/browser_wasi_shim</a>) which handled the polls correctly. We switched as that package lacks full WASI support, unlike JCO which we have successfully used for other (less janky) projects. But we haven't used it for command/CLI before, and wonder if we are missing a stdin/stdout which is causing the issue?</p>
<p>We are working on a proper solution... I promise! But for now, we need to get this working, so any advice would be great.</p>
<p>Here is the full build process:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">docker</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="o">-</span><span class="n">t</span><span class="w"> </span><span class="n">dk</span><span class="o">-</span><span class="n">patcher</span><span class="p">:</span><span class="nc">latest</span><span class="w"> </span><span class="o">--</span><span class="n">platform</span><span class="o">=</span><span class="n">linux</span><span class="o">/</span><span class="n">riscv64</span><span class="w"> </span><span class="p">.</span>
<span class="n">c2w</span><span class="w"> </span><span class="o">--</span><span class="n">target</span><span class="o">-</span><span class="n">arch</span><span class="o">=</span><span class="n">riscv64</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="n">dk</span><span class="o">-</span><span class="n">patcher</span><span class="p">:</span><span class="nc">latest</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">temptopatch</span><span class="p">.</span><span class="n">wasm</span>
<span class="n">wasm</span><span class="o">-</span><span class="n">tools</span><span class="w"> </span><span class="n">component</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">temptopatch</span><span class="p">.</span><span class="n">wasm</span><span class="w"> </span><span class="o">--</span><span class="n">adapt</span><span class="w"> </span><span class="n">wasi_snapshot_preview1</span><span class="o">=</span><span class="n">adapter</span><span class="p">.</span><span class="n">wasm</span><span class="w"> </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="n">temp</span><span class="p">.</span><span class="n">component</span><span class="p">.</span><span class="n">wasm</span>
<span class="n">bunx</span><span class="w"> </span><span class="o">@</span><span class="n">bytecodealliance</span><span class="o">/</span><span class="n">jco</span><span class="w"> </span><span class="n">transpile</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">temp</span><span class="p">.</span><span class="n">component</span><span class="p">.</span><span class="n">wasm</span><span class="w"> </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="o">../</span><span class="n">webserver</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">patcher</span><span class="w"> </span><span class="o">--</span><span class="n">name</span><span class="w"> </span><span class="o">'</span><span class="na">dashkeepfirmwarepatcher</span><span class="o">'</span><span class="w"> </span><span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">namespaced</span><span class="o">-</span><span class="n">exports</span><span class="w"> </span><span class="o">--</span><span class="k">async</span><span class="o">-</span><span class="n">mode</span><span class="w"> </span><span class="n">jspi</span>
</code></pre></div>
<p>Basic launch code:</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">expose</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="s">"comlink"</span><span class="p">;</span>
<span class="n">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">instantiate</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="s">"$lib/patcher/firmwarepatcher"</span><span class="p">;</span>
<span class="n">import</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">WASIShim</span><span class="p">,</span>
<span class="w">  </span><span class="k">type</span><span class="w"> </span><span class="nc">WASIImportObject</span><span class="p">,</span>
<span class="w">  </span><span class="k">type</span><span class="w"> </span><span class="nc">VersionedWASIImportObject</span><span class="p">,</span>
<span class="p">}</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="s">"@bytecodealliance/preview2-shim/instantiation"</span><span class="p">;</span>

<span class="k">const</span><span class="w"> </span><span class="n">wasmModules</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">import</span><span class="p">.</span><span class="n">meta</span><span class="p">.</span><span class="n">glob</span><span class="p">(</span><span class="s">"$lib/patcher/*.wasm"</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">as</span><span class="p">:</span><span class="w"> </span><span class="s">"url"</span><span class="p">,</span>
<span class="p">});</span>

<span class="n">export</span><span class="w"> </span><span class="k">type</span><span class="w"> </span><span class="nc">TPatchFirmware</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">typeof</span><span class="w"> </span><span class="n">PatchFirmware</span><span class="p">;</span>

<span class="k">async</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">PatchFirmware</span><span class="p">(</span>
<span class="w">  </span><span class="n">firmwareBuff</span><span class="p">:</span><span class="w"> </span><span class="nc">ArrayBuffer</span><span class="p">,</span>
<span class="w">  </span><span class="n">onStdout</span><span class="o">?</span><span class="p">:</span><span class="w"> </span><span class="p">(</span><span class="n">text</span><span class="p">:</span><span class="w"> </span><span class="nc">string</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">void</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">console</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="s">"[PatchFirmware] Starting firmware patching process"</span><span class="p">);</span>

<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">loader</span><span class="p">(</span><span class="n">path</span><span class="p">:</span><span class="w"> </span><span class="nc">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="n">WebAssembly</span><span class="p">.</span><span class="n">compileStreaming</span><span class="p">(</span>
<span class="w">        </span><span class="n">fetch</span><span class="p">(</span><span class="k">await</span><span class="w"> </span><span class="n">wasmModules</span><span class="p">[</span><span class="err">`</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">patcher</span><span class="o">/</span><span class="cp">$</span><span class="p">{</span><span class="n">path</span><span class="p">}</span><span class="err">`</span><span class="p">]()),</span>
<span class="w">      </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">shimCore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">WASIShim</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// for importing directly, i.e. wasi:cli/blah</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">shim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">shimCore</span><span class="p">.</span><span class="n">getImportObject</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// For importing when a version is defined, i.e. wasi:cli/blah@0.2.6</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">shimVersioned</span><span class="p">:</span><span class="w"> </span><span class="nc">VersionedWASIImportObject</span><span class="o">&lt;</span><span class="s">"0.2.6"</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span>
<span class="w">      </span><span class="n">shimCore</span><span class="p">.</span><span class="n">getImportObject</span><span class="p">({</span><span class="w"> </span><span class="n">asVersion</span><span class="p">:</span><span class="w"> </span><span class="s">"0.2.6"</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="n">shim</span><span class="w"> </span><span class="n">satisfies</span><span class="w"> </span><span class="n">WASIImportObject</span><span class="p">;</span>
<span class="w">    </span><span class="n">shim</span><span class="w"> </span><span class="n">satisfies</span><span class="w"> </span><span class="n">VersionedWASIImportObject</span><span class="o">&lt;</span><span class="s">""</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">    </span><span class="n">shimVersioned</span><span class="w"> </span><span class="n">satisfies</span><span class="w"> </span><span class="n">VersionedWASIImportObject</span><span class="o">&lt;</span><span class="s">"0.2.6"</span><span class="o">&gt;</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// @ts-ignore - We have provided it everything it needs (except for debug provisions)</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="n">instantiate</span><span class="p">(</span><span class="n">loader</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="o">..</span><span class="p">.</span><span class="n">shim</span><span class="p">,</span>
<span class="w">      </span><span class="o">..</span><span class="p">.</span><span class="n">shimVersioned</span><span class="p">,</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instance</span><span class="p">.</span><span class="n">run</span><span class="p">.</span><span class="n">run</span><span class="p">();</span>

<span class="w">    </span><span class="n">console</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">success</span><span class="p">:</span><span class="w"> </span><span class="nc">true</span><span class="p">,</span>
<span class="w">      </span><span class="n">message</span><span class="p">:</span><span class="w"> </span><span class="s">"Firmware patched successfully"</span><span class="p">,</span>
<span class="w">      </span><span class="n">result</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="n">catch</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">console</span><span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="s">"[PatchFirmware] Error:"</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">);</span>
<span class="w">    </span><span class="n">throw</span><span class="w"> </span><span class="n">error</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">expose</span><span class="p">(</span><span class="n">PatchFirmware</span><span class="p">);</span>
</code></pre></div><br>
</p>
</blockquote>



<hr><p>Last updated: Feb 22 2026 at 11:05 UTC</p>
</html>
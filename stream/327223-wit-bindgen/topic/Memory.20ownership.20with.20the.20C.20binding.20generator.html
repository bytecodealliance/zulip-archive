<html>
<head><meta charset="utf-8"><title>Memory ownership with the C binding generator 路 wit-bindgen 路 Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/index.html">wit-bindgen</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html">Memory ownership with the C binding generator</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="524447627"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524447627" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sy Brand <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524447627">(Jun 17 2025 at 13:00)</a>:</h4>
<p>I'm confused by the memory ownership semantics when using the C binding generator. The project README shows:</p>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">"host.h"</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">host_run</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">host_string_t</span><span class="w"> </span><span class="n">my_string</span><span class="p">;</span>
<span class="w">    </span><span class="n">host_string_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_string</span><span class="p">,</span><span class="w"> </span><span class="s">"Hello, world!"</span><span class="p">);</span>

<span class="w">    </span><span class="n">host_print</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_string</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>But the headers generated by <code>wit-bindgen</code> have the following comment on <code>xxx_string_set</code>:</p>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="c1">// Transfers ownership of `s` into the string `ret`</span>
</code></pre></div>
<p>Which implies to me that <code>ret</code> is going to be freed somewhere. But that doesn't make sense  for the code in the README, considering that <code>xxx_string_set</code> simply stores the pointer and length, so if  <code>my_string</code> were to be freed, it would be freeing a static string.</p>
<p>Is there documentation somewhere that specifies who is responsible for freeing memory that is passed to an import?</p>



<a name="524449649"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524449649" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524449649">(Jun 17 2025 at 13:09)</a>:</h4>
<p>I don't know about documentation but the caller is responsible. There should be a <code>host_string_free</code> if I'm understanding the example.</p>



<a name="524449962"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524449962" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524449962">(Jun 17 2025 at 13:10)</a>:</h4>
<p>The "transfer ownership" terminology is a little confusing in context; I think it really just means that the returned struct will own the allocation.</p>



<a name="524450072"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524450072" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sy Brand <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524450072">(Jun 17 2025 at 13:11)</a>:</h4>
<p>There would be a <code>host_string_free</code> defined, but calling it on <code>my_string</code> would call <code>free</code> on something that wasn't allocated via <code>malloc</code></p>



<a name="524450509"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524450509" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524450509">(Jun 17 2025 at 13:13)</a>:</h4>
<p>OK fair so <em>my</em> terminology was also confusing <span aria-label="slight smile" class="emoji emoji-1f642" role="img" title="slight smile">:slight_smile:</span></p>



<a name="524450909"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524450909" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524450909">(Jun 17 2025 at 13:15)</a>:</h4>
<p>Imports will not free arguments that are passed to them; the generated canonical ABI code may do its own memory management internally but the caller is responsible for anything it constructs and passes in. If you know how to express this in a way that would be more familiar to C devs I'm sure a PR would be welcome.</p>



<a name="524450991"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524450991" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sy Brand <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524450991">(Jun 17 2025 at 13:15)</a>:</h4>
<p>:D <br>
So basically nothing will be freed without you explicitly freeing it, <code>xxx_string_set</code> "takes ownership" as far as if you eventually call <code>xxx_string_free</code> on the result, you better not have references to the internal string lying around</p>



<a name="524451106"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524451106" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sy Brand <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524451106">(Jun 17 2025 at 13:16)</a>:</h4>
<p>That's clear now, thank you!</p>



<a name="524451186"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524451186" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524451186">(Jun 17 2025 at 13:16)</a>:</h4>
<p>Note there may be some caveats around resource handles and upcoming async stuff, but otherwise I think that is correct.</p>



<a name="524451612"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524451612" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sy Brand <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524451612">(Jun 17 2025 at 13:19)</a>:</h4>
<p>I think as far as documenting goes, a short description of the ownership model in the C section of the README and a bit more detail in the header comments to indicate the intended use of the functions would be helpful and make it so that users wouldn't have to read between the lines</p>



<a name="524451640"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524451640" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sy Brand <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524451640">(Jun 17 2025 at 13:19)</a>:</h4>
<p>I'd be happy to put in a PR</p>



<a name="524451781"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524451781" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524451781">(Jun 17 2025 at 13:20)</a>:</h4>
<p>On the flip side, imports may <em>return</em> allocated data and the caller <em>does</em> take ownership of that. iirc you can just blindly call <code>*_free</code> on any non-primitive return values; there should be at least an empty impl generated.</p>



<a name="524452091"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524452091" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sy Brand <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524452091">(Jun 17 2025 at 13:21)</a>:</h4>
<p>Makes sense!</p>



<a name="524452792"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524452792" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524452792">(Jun 17 2025 at 13:24)</a>:</h4>
<p>The (especially non-Rust) bindings are always in need of more love</p>



<a name="524462964"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524462964" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524462964">(Jun 17 2025 at 14:10)</a>:</h4>
<p>C means &lt;3</p>



<a name="524468783"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524468783" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524468783">(Jun 17 2025 at 14:36)</a>:</h4>
<p>I can probably apologize for the lack of documentation here, sorry!</p>
<p>Overall the memory ownership story for C is pretty tricky. The bindings are generated in such a way (in theory) that it's possible to use them without memory leaks, but it's not always easy to do so. I have no doubt that existing examples probably leak memory as nothing is checking for no leaks and that internal documentation can likely be improved (e.g. <code>*_string_set</code>)</p>



<a name="524472616"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524472616" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sy Brand <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524472616">(Jun 17 2025 at 14:55)</a>:</h4>
<p>I can go through the code and try to come up with a short document that explains the different functions that can be generated, what their intended uses are, and how to use them for arguments and return values to avoid leaks/bad frees. That can live in <code>crates/c/README.md</code> or some other name and be linked to from the C section of the top-level README. Would that be useful?</p>



<a name="524472934"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524472934" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524472934">(Jun 17 2025 at 14:57)</a>:</h4>
<p>that would be extremely useful!</p>



<a name="524473108"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524473108" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sy Brand <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524473108">(Jun 17 2025 at 14:58)</a>:</h4>
<p>Cool cool! I'll drop a message here if I need clarity on anything <span aria-label="blush" class="emoji emoji-1f60a" role="img" title="blush">:blush:</span></p>



<a name="524473217"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524473217" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sy Brand <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524473217">(Jun 17 2025 at 14:58)</a>:</h4>
<p>I appreciate all the quick responses</p>



<a name="524476596"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524476596" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524476596">(Jun 17 2025 at 15:14)</a>:</h4>
<p>When someone offers to help suddenly everyone comes out of the woodwork <span aria-label="slight smile" class="emoji emoji-1f642" role="img" title="slight smile">:slight_smile:</span></p>



<a name="524494090"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524494090" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524494090">(Jun 17 2025 at 16:54)</a>:</h4>
<p>EXTREMELY USEFUL LANN</p>



<a name="524676819"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524676819" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sy Brand <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524676819">(Jun 18 2025 at 10:39)</a>:</h4>
<p>I've made decent progress, but am a bit stuck on the dropping of borrowed handles of imported resources in exported functions</p>



<a name="524677211"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524677211" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sy Brand <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524677211">(Jun 18 2025 at 10:41)</a>:</h4>
<p>My understanding is that, if the guest has a borrowed handle to an imported resource, its responsibility for dropping that handle depends on how that borrow was obtained:</p>
<ul>
<li>If the borrow was obtained by calling <code>*_borrow_*</code> on an owned handle, no action is required on the borrow; only the owned handle should be dropped when the guest wants to end the lifetime of the resource</li>
<li>If the borrow was received as an argument to one of the guest's exported functions, the borrowed handle must be dropped by the guest</li>
</ul>



<a name="524677574"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524677574" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sy Brand <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524677574">(Jun 18 2025 at 10:43)</a>:</h4>
<p>On that second bullet point, there are two sub-cases that I can see for how the guest is supposed to drop the borrowed handle:</p>
<ul>
<li>If <code>--autodrop-borrows=yes</code> is supplied on the command line, the bindings automatically drop the borrowed handle after the implementation of the exported function returns</li>
<li>If <code>--autodrop-borrows=no</code> is supplied, or that argument is not supplied at all, the guest code must explicitly drop the borrowed handle</li>
</ul>



<a name="524677924"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524677924" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sy Brand <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524677924">(Jun 18 2025 at 10:45)</a>:</h4>
<p>The problem is, I don't see what it is intended for the guest code to call to explicitly drop the handle for the second case here, as the <code>*_drop_borrow</code> function is only generated if autodrop is enabled</p>



<a name="524678344"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524678344" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sy Brand <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524678344">(Jun 18 2025 at 10:48)</a>:</h4>
<p>My conclusion is that the <a href="https://github.com/bytecodealliance/wit-bindgen/blob/main/crates/c/src/lib.rs#L1298">condition here</a> is inverted and should instead be <code>!self.autodrop_enabled()</code>, so that the guest can manually call <code>*_drop_borrow</code> before exiting the exported function to drop the received borrow handle</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wit-bindgen/blob/main/crates/c/src/lib.rs#L1298" style="background-image: url(&quot;https://uploads.zulipusercontent.net/c74dc9d8a179327ed4f95f2c6ab5f55aca87eb1f/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f643535626562383432313664366336646433303338643336343635653264346430353038656433396232303934623337663361356137613462653934393831342f62797465636f6465616c6c69616e63652f7769742d62696e6467656e&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wit-bindgen/blob/main/crates/c/src/lib.rs#L1298" title="wit-bindgen/crates/c/src/lib.rs at main 路 bytecodealliance/wit-bindgen">wit-bindgen/crates/c/src/lib.rs at main 路 bytecodealliance/wit-bindgen</a></div><div class="message_embed_description">A language binding generator for WebAssembly interface types - bytecodealliance/wit-bindgen</div></div></div>



<a name="524678666"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524678666" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sy Brand <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524678666">(Jun 18 2025 at 10:49)</a>:</h4>
<p>But perhaps some the understanding I've written leading up to this conclusion is wrong</p>



<a name="524729980"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524729980" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524729980">(Jun 18 2025 at 15:10)</a>:</h4>
<p>Agreed with you, I think that's a typo and not-very-broadly-tested code, the <code>*_drop_borrow</code> functions should definitely be provided if autodrop is disabled</p>



<a name="524730004"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524730004" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524730004">(Jun 18 2025 at 15:10)</a>:</h4>
<p>Also can confirm your understanding of it all is indeed correct <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>



<a name="524730112"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524730112" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sy Brand <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524730112">(Jun 18 2025 at 15:11)</a>:</h4>
<p>Cool, I can make a PR for that</p>



<a name="524730736"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524730736" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524730736">(Jun 18 2025 at 15:14)</a>:</h4>
<p>If you're feeling particularly ambitious we've also nowadays got a system that's much more robust for adding tests for various bindings generators, so you an also try adding a test to <code>tests/runtime/*</code> for this behavior too</p>



<a name="524730834"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524730834" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sy Brand <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524730834">(Jun 18 2025 at 15:14)</a>:</h4>
<p>Maybe this indicates that autodrop could be made the default? Since the <code>*_drop_borrow</code> functions haven't been provided for non-autodrop builds since January last year, it seems that any users of borrowed imported resources in exported functions must either:</p>
<ul>
<li>Have since turned autodrop on</li>
<li>Be leaking borrowed handles</li>
<li>Have resorted to calling the dropping intrinsic directly (icky icky)<br>
Making it the default would cause that last group to double-free their borrowed handles, but you'd know better if anybody falls into that group <span aria-label="smile" class="emoji emoji-1f604" role="img" title="smile">:smile:</span></li>
</ul>



<a name="524731572"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524731572" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524731572">(Jun 18 2025 at 15:18)</a>:</h4>
<p>I fear you might be overestimating the number of users of the C bindings with borrows of imported resources in exports heh, I'd expect that set of folks to be almost empty</p>



<a name="524731659"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524731659" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524731659">(Jun 18 2025 at 15:18)</a>:</h4>
<p>but historically the reason I wanted autodrop turned off is that it doesn't support all signatures, but I also wanted bindings to be possible to generate by default</p>



<a name="524731682"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524731682" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sy Brand <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524731682">(Jun 18 2025 at 15:19)</a>:</h4>
<p>Yep, that is what I imagined <span aria-label="smile" class="emoji emoji-1f604" role="img" title="smile">:smile:</span></p>



<a name="524731759"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524731759" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524731759">(Jun 18 2025 at 15:19)</a>:</h4>
<p>so it's a bit of a tradeoff with autodrop, it's (a) unambiguously nicer IMO but (b) more restrictive</p>



<a name="524731780"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524731780" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sy Brand <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524731780">(Jun 18 2025 at 15:19)</a>:</h4>
<p>Ah, makes sense!</p>



<a name="524731835"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524731835" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524731835">(Jun 18 2025 at 15:19)</a>:</h4>
<p>IIRC I think <code>list&lt;borrow&lt;thing&gt;&gt;</code> in an exported function's arguments won't be supported and the bindings generation process should panic/fail</p>



<a name="524731872"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524731872" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524731872">(Jun 18 2025 at 15:19)</a>:</h4>
<p>it's always lists ;_;</p>



<a name="524731979"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524731979" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sy Brand <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524731979">(Jun 18 2025 at 15:20)</a>:</h4>
<p>With the imported resources thing cleared up, I'm aaaalmost done with the doc draft</p>



<a name="524735457"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524735457" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sy Brand <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524735457">(Jun 18 2025 at 15:38)</a>:</h4>
<p>The last bit I'm a unsure about is some parts of exported resources:</p>
<ol>
<li>
<p>It seems that the <code>*_drop_borrow</code> function gets defined for exported resources if the exported resource is used in an imported function. Am I right that there's no reason for this to happen and the component that exports the resource should never drop a borrowed handle to that resource, even if it receives one as an argument in one of its exported functions?</p>
</li>
<li>
<p>I'm not sure about the intended allocation and destruction pattern for the resource. Say I have a resource like:</p>
</li>
</ol>
<div class="codehilite" data-code-language="wit"><pre><span></span><code>package cat:registry;
 resource cat {
    get-name: func() -&gt; string;
    get-nicknames: func() -&gt; list&lt;string&gt;;
}
</code></pre></div>
<p>And I define the internal representation like this:</p>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">exports_cat_registry_cat_registry_api_cat_t</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">cat_registry_string_t</span><span class="w"> </span><span class="n">name</span><span class="p">;</span>
<span class="w">  </span><span class="n">cat_registry_list_string_t</span><span class="w"> </span><span class="n">nicknames</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<p>Is the intended lifecycle of a single <code>cat</code> resource as follows:</p>
<ul>
<li><code>malloc</code> an <code>exports_cat_registry_cat_registry_api_cat_t </code></li>
<li>Fill in the <code>name</code> and <code>nicknames</code> fields</li>
<li>Call <code>exports_cat_registry_cat_registry_api_cat_new</code> with the <code>malloc</code>ed pointer</li>
<li>Pass around the returned handle, do whatever</li>
<li>Eventually call <code>exports_cat_registry_cat_registry_api_cat_drop_own</code></li>
<li>Dropping the owning reference automatically calls <code>exports_cat_registry_cat_registry_api_cat_destructor</code></li>
<li><code>exports_cat_registry_cat_registry_api_cat_destructor</code> should clean up the <code>name</code> and <code>nicknames</code> fields, then call <code>free</code> on the argument to the destructor</li>
</ul>



<a name="524738191"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524738191" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524738191">(Jun 18 2025 at 15:52)</a>:</h4>
<blockquote>
<p>Am I right that there's no reason for this to happen and the component that exports the resource should never drop a borrowed handle to that resource, even if it receives one as an argument in one of its exported functions?</p>
</blockquote>
<p>Correct, it's not actually even possible for a borrow handle to make its way to the component defining the handle. When an export receives a borrow of a resource the component defined it gets a rep, not a handle, so there's fundamentally nothing to drop</p>



<a name="524738328"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524738328" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524738328">(Jun 18 2025 at 15:53)</a>:</h4>
<blockquote>
<p>Is the intended lifecycle of a single <code>cat</code> resource as follows:</p>
</blockquote>
<p>That all looks correct to me yeah</p>



<a name="524739568"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524739568" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sy Brand <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524739568">(Jun 18 2025 at 15:59)</a>:</h4>
<p>Thanks!</p>



<a name="524760882"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524760882" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sy Brand <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524760882">(Jun 18 2025 at 18:19)</a>:</h4>
<p>Another exported resource question. Given this definition:</p>
<div class="codehilite" data-code-language="wit"><pre><span></span><code>package cat:registry;

interface cat-registry-api {
    resource cat {
        get-name: func() -&gt; string;
        get-nicknames: func() -&gt; list&lt;string&gt;;
    }
}

interface cat-registry-user-api {
    use cat-registry-api.{cat};
    init: func();
    notify-cat-registered: func(cat: borrow&lt;cat&gt;);
}

world cat-registry {
    import cat-registry-user-api;
    export cat-registry-api;
    export wasi:cli/run@0.2.6;
}
</code></pre></div>
<p>I expect that, when generating bindings for <code>cat-registry</code>, the bindings for <code>notify-cat-registered</code> should take a pointer to the resource repr. But instead, the generator seems to treat it as if I'm importing <code>cat</code> because it is appearing in the context of an import (the <code>cat-registry-user-api</code> interface)</p>



<a name="524760944"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524760944" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sy Brand <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524760944">(Jun 18 2025 at 18:19)</a>:</h4>
<p>Which is why the <code>*_drop_borrow</code> from my earlier question gets generated</p>



<a name="524761130"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524761130" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sy Brand <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524761130">(Jun 18 2025 at 18:21)</a>:</h4>
<p>More concretely, the generator declares this:</p>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="k">extern</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">cat_registry_cat_registry_user_api_notify_cat_registered</span><span class="p">(</span><span class="n">cat_registry_cat_registry_user_api_borrow_cat_t</span><span class="w"> </span><span class="n">cat</span><span class="p">);</span>
</code></pre></div>
<p>When I expect it to generate this:</p>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="k">extern</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">cat_registry_cat_registry_user_api_notify_cat_registered</span><span class="p">(</span><span class="n">exports_cat_registry_cat_registry_api_borrow_cat_t</span><span class="w"> </span><span class="n">cat</span><span class="p">);</span>
</code></pre></div>



<a name="524761236"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524761236" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sy Brand <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524761236">(Jun 18 2025 at 18:21)</a>:</h4>
<p>I think the generator is missing tracking of whether a resource that appears in an imported function is one that the component we're generating for is exporting</p>



<a name="524761398"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524761398" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sy Brand <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524761398">(Jun 18 2025 at 18:23)</a>:</h4>
<p>Am I on the right lines, or is there some way I'm missing to do the right thing with the generated bindings, or some issue with my WIT?</p>



<a name="524763171"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524763171" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524763171">(Jun 18 2025 at 18:35)</a>:</h4>
<p>Ah ok so you're hitting on a particular subtle point of the component model</p>



<a name="524763197"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524763197" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524763197">(Jun 18 2025 at 18:35)</a>:</h4>
<p>this is working as expected, but it's known to be surprising, lemme see if I can dig up any  docs on this</p>



<a name="524763765"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524763765" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524763765">(Jun 18 2025 at 18:39)</a>:</h4>
<p>hm ok no shame on me those don't exist...</p>
<p>Anyway the basic limitation here is that imports into a component cannot refer to types defined in the component itself, e.g. exports, as that would create a cycle which can't otherwise be broken. Effectively the exported resource is a type that doesn't actually exist until the component is instantiated, meaning that imports, which must exist before the component is instantiated, otherwise couldn't exist.</p>
<p>This then leads to the question "why is this valid WIT?" and that gets into the concept of world elaboration. A small digression is exploring what happens if you write down <code>import wasi:filesystem/preopens</code>. That's also a valid WIT file but the <code>preopens</code> interface depends on <code>wasi:filesystem/types</code>, so somehow that has to get resolved. What ends up happening here is something I've been calling world elaboration where <code>import</code> statements transitively, and automatically, import dependency interfaces too.</p>
<p>Coming back to your example, if you do a <code>wasm-tools component wit</code> to print the elaborated form of the WIT you'll see that <code>world cat-registry</code> actually does <code>import cat-registry-api</code> despite you not actually writing this down. That's beause <code>cat-registry-user-api</code> depends on <code>cat-registry-api</code>, and it's otherwise not imported, so it's then forcibly imported.</p>
<p>So at the end of the day what you actually wrote down is both importing and exporting <code>cat-registry-api</code>. The <code>notify-cat-registered</code> function is referring to the imported resource, and the exported function is referring to a different resource, one that's exported</p>



<a name="524763867"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524763867" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524763867">(Jun 18 2025 at 18:40)</a>:</h4>
<p>There's unfortunately a lot of subtelty about this which can come up relatively quickly when folks are initially learning/playing around with WIT. If you're working with preexisting WIT you tend to be fine as this situation doesn't come up, but this is something where we could definitely have better documentation</p>



<a name="524767448"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524767448" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sy Brand <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524767448">(Jun 18 2025 at 19:05)</a>:</h4>
<p>Ah, I understand, thanks for the detailed explanation!</p>



<a name="524884504"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524884504" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sy Brand <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524884504">(Jun 19 2025 at 13:18)</a>:</h4>
<p>Apologies, I'm still having trouble wrapping my head round some of these subtleties. I can successfully create a component that imports some resource and exports a function that takes a borrow of that resource. But I'm struggling to create a configuration by which I can actually call that exported function, likely due to misunderstanding some of the finer points of the component model.</p>
<p>Say I have the following WIT:</p>
<div class="codehilite" data-code-language="wit"><pre><span></span><code>package cat:example;

interface registry-api {
    resource cat {
        get-name: func() -&gt; string;
        get-nicknames: func() -&gt; list&lt;string&gt;;
    }
    adopt-cat: func(name: string) -&gt; option&lt;cat&gt;;
}

interface adoption-authority-api {
    use registry-api.{cat};
    // The function I am trying to call
    notify-adoption: func(cat: borrow&lt;cat&gt;);
}

world adoption-authority {
    import registry-api;
    export adoption-authority-api;
}

world adopter {
    import adoption-authority-api;
    export init: func();
}

world registry {
    export registry-api;
    export wasi:cli/run@0.2.6;
}
</code></pre></div>
<p>The idea is that the <code>adopter</code> calls <code>registry/adopt-cat</code> in order to retrieve an owing handle to a <code>cat</code>. <code>adopter</code> then calls <code>adoption-authority/notify-adoption</code>, passing it a borrow of its owned handle.</p>



<a name="524884660"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524884660" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sy Brand <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524884660">(Jun 19 2025 at 13:19)</a>:</h4>
<p>Composing these with <code>wac plug</code> fails, which I'm guessing is because it sees the import of <code>cat</code> inside <code>adoption-authority</code> and <code>adopter</code> as separate types</p>



<a name="524885151"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524885151" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sy Brand <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524885151">(Jun 19 2025 at 13:21)</a>:</h4>
<p>So I try to do it with <code>wac compose</code>, hoping that this will be more successful by instantiating <code>registry</code> once and using that to fulfil the imports of both <code>adopter</code> and <code>adoption-authority</code>. Using this script:</p>
<div class="codehilite" data-code-language="wac"><pre><span></span><code>package cat:composition;

let registry = new cat:registry{};

let authority = new cat:adoption-authority {
    registry-api: registry
};

let adopter = new cat:adopter {
    adoption-authority-api: authority,
    registry-api: registry
};

export registry.run;
</code></pre></div>
<p>I get the error:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">  </span><span class="err"></span><span class="w"> </span><span class="n">mismatched</span><span class="w"> </span><span class="n">instantiation</span><span class="w"> </span><span class="n">argument</span><span class="w"> </span><span class="err">`</span><span class="n">cat</span><span class="p">:</span><span class="nc">example</span><span class="o">/</span><span class="n">registry</span><span class="o">-</span><span class="n">api</span><span class="err">`</span>
<span class="w">  </span><span class="err">扳</span><span class="w"> </span><span class="n">instance</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">missing</span><span class="w"> </span><span class="n">expected</span><span class="w"> </span><span class="n">resource</span><span class="w"> </span><span class="n">export</span><span class="w"> </span><span class="err">`</span><span class="n">cat</span><span class="err">`</span>
<span class="w">   </span><span class="err"></span><span class="p">[</span><span class="n">registry</span><span class="p">.</span><span class="n">wac</span><span class="p">:</span><span class="mi">6</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span>
<span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="err"></span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">authority</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">cat</span><span class="p">:</span><span class="nc">adoption</span><span class="o">-</span><span class="n">authority</span><span class="w"> </span><span class="p">{</span>
<span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="err"></span><span class="w">     </span><span class="n">registry</span><span class="o">-</span><span class="n">api</span><span class="p">:</span><span class="w"> </span><span class="nc">registry</span>
<span class="w">   </span><span class="err">路</span><span class="w">     </span><span class="err"></span>
<span class="w">   </span><span class="err">路</span><span class="w">           </span><span class="err">扳</span><span class="w"> </span><span class="n">mismatched</span><span class="w"> </span><span class="n">argument</span><span class="w"> </span><span class="err">`</span><span class="n">cat</span><span class="p">:</span><span class="nc">example</span><span class="o">/</span><span class="n">registry</span><span class="o">-</span><span class="n">api</span><span class="err">`</span>
<span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="err"></span><span class="w"> </span><span class="p">};</span>
<span class="w">   </span><span class="err">扳</span>
</code></pre></div>



<a name="524885809"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524885809" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sy Brand <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524885809">(Jun 19 2025 at 13:25)</a>:</h4>
<p>There's clearly some fundamental issue with my understanding of the import and export system. I'd be totally happy for a "what you're doing is totally unsupported" answer, I'm just hoping for an example that calls an exported function that has an imported resource as an argument.</p>



<a name="524889233"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524889233" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524889233">(Jun 19 2025 at 13:42)</a>:</h4>
<p>wac  may also not be perfect yet, as the tools have to keep pace.... and maintainers are spilt all over. :-)</p>



<a name="524894459"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524894459" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sy Brand <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524894459">(Jun 19 2025 at 14:08)</a>:</h4>
<p>Aha! The problem was my WAC syntax was wrong, I need to manually select the interface from the component like</p>
<div class="codehilite" data-code-language="wit"><pre><span></span><code>let authority = new cat:adoption-authority {
    registry-api: registry.registry-api,
};
</code></pre></div>



<a name="524906237"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524906237" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sy Brand <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524906237">(Jun 19 2025 at 15:13)</a>:</h4>
<p>It works!!!!</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">[</span><span class="n">registry</span><span class="p">]</span><span class="w"> </span><span class="n">Initialised</span>
<span class="p">[</span><span class="n">adopter</span><span class="p">]</span><span class="w"> </span><span class="n">Attempting</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">adopt</span><span class="w"> </span><span class="n">Poptart</span><span class="o">..</span><span class="p">.</span>
<span class="p">[</span><span class="n">registry</span><span class="p">]</span><span class="w"> </span><span class="n">Adopted</span><span class="w"> </span><span class="n">cat</span><span class="p">:</span>
<span class="p">[</span><span class="n">registry</span><span class="p">]</span><span class="w"> </span><span class="n">Poptart</span>
<span class="p">[</span><span class="n">adopter</span><span class="p">]</span><span class="w"> </span><span class="n">Adopted</span><span class="w"> </span><span class="n">cat</span><span class="w"> </span><span class="n">name</span><span class="p">:</span>
<span class="p">[</span><span class="n">adopter</span><span class="p">]</span><span class="w"> </span><span class="n">Poptart</span>
<span class="p">[</span><span class="n">adoption</span><span class="o">-</span><span class="n">authority</span><span class="p">]</span><span class="w"> </span><span class="n">Notified</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">adoption</span>
<span class="p">[</span><span class="n">adoption</span><span class="o">-</span><span class="n">authority</span><span class="p">]</span><span class="w"> </span><span class="n">Cat</span><span class="w"> </span><span class="n">name</span><span class="p">:</span>
<span class="p">[</span><span class="n">adoption</span><span class="o">-</span><span class="n">authority</span><span class="p">]</span><span class="w"> </span><span class="n">Poptart</span>
<span class="p">[</span><span class="n">adopter</span><span class="p">]</span><span class="w"> </span><span class="n">Adoption</span><span class="w"> </span><span class="n">complete</span><span class="o">!</span>
<span class="p">[</span><span class="n">registry</span><span class="p">]</span><span class="w"> </span><span class="n">Destroyed</span>
</code></pre></div>



<a name="524917423"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524917423" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sy Brand <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524917423">(Jun 19 2025 at 16:22)</a>:</h4>
<p>Alright, the documentation is ready for review: <a href="https://github.com/bytecodealliance/wit-bindgen/pull/1319">https://github.com/bytecodealliance/wit-bindgen/pull/1319</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wit-bindgen/pull/1319" style="background-image: url(&quot;https://uploads.zulipusercontent.net/098d7293bbbbbc980e8fb6bbbfebccb15035ea9d/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f353033373437333466383033313635396665623935333163356530663936313834396230363635313036653031616137396631306463383030636336643533622f62797465636f6465616c6c69616e63652f7769742d62696e6467656e2f70756c6c2f31333139&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wit-bindgen/pull/1319" title="Add documentation for the C binding generator by TartanLlama 路 Pull Request #1319 路 bytecodealliance/wit-bindgen">Add documentation for the C binding generator by TartanLlama 路 Pull Request #1319 路 bytecodealliance/wit-bindgen</a></div><div class="message_embed_description">Improves the documentation for the C binding generator:

Adds a new documentation component to crates/c/README.md with extensive documentation on generated bindings
Links to the documentation from ...</div></div></div>



<a name="524922533"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524922533" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524922533">(Jun 19 2025 at 16:59)</a>:</h4>
<p>The TartanLlama Abides.</p>



<a name="524933514"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/524933514" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Lann Martin <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#524933514">(Jun 19 2025 at 18:39)</a>:</h4>
<blockquote>
<p>Apologies, I'm still having trouble wrapping my head round some of these subtleties.</p>
</blockquote>
<p>You and <em>almost</em> everyone else <span aria-label="slight smile" class="emoji emoji-1f642" role="img" title="slight smile">:slight_smile:</span></p>



<a name="525049718"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/525049718" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#525049718">(Jun 20 2025 at 14:09)</a>:</h4>
<p>(back today)</p>
<p>Ah yeah I would comment saying that the WIT you describe above should indeed work, and I'm glad the wac syntax got sorted out! I'm still learning wac myself :)</p>
<p>I should be able to review the C docs today as well, thanks again!</p>



<a name="525058783"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/525058783" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sy Brand <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#525058783">(Jun 20 2025 at 15:03)</a>:</h4>
<p>Thanks! I also submitted a PR to fix the non-autodropped borrows case, including a runtime test: <a href="https://github.com/bytecodealliance/wit-bindgen/pull/1320">https://github.com/bytecodealliance/wit-bindgen/pull/1320</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wit-bindgen/pull/1320" style="background-image: url(&quot;https://uploads.zulipusercontent.net/ca5834a0a9d2b9b185879bd219dc2b5f966f85a3/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f326632383765333133343232643662366639363033363833656239353765623635656566636137613032366264303561383639666537633134386631656438392f62797465636f6465616c6c69616e63652f7769742d62696e6467656e2f70756c6c2f31333230&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wit-bindgen/pull/1320" title="[C] Generate explicit borrow dropping functions when autodrop borrows is disabled by TartanLlama 路 Pull Request #1320 路 bytecodealliance/wit-bindgen">[C] Generate explicit borrow dropping functions when autodrop borrows is disabled by TartanLlama 路 Pull Request #1320 路 bytecodealliance/wit-bindgen</a></div><div class="message_embed_description">Currently, the *_drop_borrow bindings are only generated when autodropping borrows is enabled, whereas it should be the other way around. This affects the case where a component exports a function ...</div></div></div>



<a name="525058971"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/525058971" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sy Brand <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#525058971">(Jun 20 2025 at 15:04)</a>:</h4>
<p>I couldn't seem to run the tests with <code>cargo test</code> as explained in the documentation though; I had to use <code>wit-bindgen test</code>. Is the documentation out of date or did I do something wrong?</p>



<a name="525060002"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/525060002" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sy Brand <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#525060002">(Jun 20 2025 at 15:11)</a>:</h4>
<p>By which I mean running <code>cargo test -p wit-bindgen-cli --no-default-features -F c</code> prints</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">running</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">test</span>
<span class="n">test</span><span class="w"> </span><span class="n">verify_cli</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="n">ok</span>

<span class="n">test</span><span class="w"> </span><span class="n">result</span><span class="p">:</span><span class="w"> </span><span class="nc">ok</span><span class="p">.</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">passed</span><span class="p">;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">failed</span><span class="p">;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">ignored</span><span class="p">;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">measured</span><span class="p">;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">filtered</span><span class="w"> </span><span class="n">out</span><span class="p">;</span><span class="w"> </span><span class="n">finished</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">0.00</span><span class="n">s</span>
</code></pre></div>
<p>Which doesn't seem like it's running all the tests, and if I intentionally break one, it still passes</p>



<a name="525061686"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/525061686" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sy Brand <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#525061686">(Jun 20 2025 at 15:21)</a>:</h4>
<p>Seems like maybe a similar change to this is required to the entire readme: <a href="https://github.com/bytecodealliance/wit-bindgen/pull/1310">https://github.com/bytecodealliance/wit-bindgen/pull/1310</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wit-bindgen/pull/1310" style="background-image: url(&quot;https://uploads.zulipusercontent.net/bcc6472e0e7a422df060571046515d3dd36cf806/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f653564316438633962643934383830323136303630373364623730376135316433643039376462316262373434613662313836616661336134333237623162652f62797465636f6465616c6c69616e63652f7769742d62696e6467656e2f70756c6c2f31333130&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wit-bindgen/pull/1310" title="adds command for the codegen tests to readme by elmerbulthuis 路 Pull Request #1310 路 bytecodealliance/wit-bindgen">adds command for the codegen tests to readme by elmerbulthuis 路 Pull Request #1310 路 bytecodealliance/wit-bindgen</a></div><div class="message_embed_description">We read every piece of feedback, and take your input very seriously.</div></div></div>



<a name="525062321"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/525062321" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#525062321">(Jun 20 2025 at 15:25)</a>:</h4>
<p>oh sorry yeah that's out of date docs</p>



<a name="525062439"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/525062439" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#525062439">(Jun 20 2025 at 15:26)</a>:</h4>
<p>nowadays it's, from the root of the repo:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="o">-</span><span class="n">l</span><span class="w"> </span><span class="n">rust</span><span class="p">,</span><span class="n">c</span><span class="w"> </span><span class="o">--</span><span class="n">artifacts</span><span class="w"> </span><span class="n">target</span><span class="o">/</span><span class="n">artifacts</span><span class="w"> </span><span class="o">--</span><span class="n">rust</span><span class="o">-</span><span class="n">wit</span><span class="o">-</span><span class="n">bindgen</span><span class="o">-</span><span class="n">path</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">crates</span><span class="o">/</span><span class="n">guest</span><span class="o">-</span><span class="n">rust</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">tests</span><span class="o">/</span><span class="n">runtime</span>
</code></pre></div>



<a name="525062496"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/525062496" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#525062496">(Jun 20 2025 at 15:26)</a>:</h4>
<p>you can also pass just <code>-l c</code> to skip rust tests</p>



<a name="525063067"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/525063067" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sy Brand <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#525063067">(Jun 20 2025 at 15:29)</a>:</h4>
<p>Cool cool, I'll make a PR for that too!</p>



<a name="525114803"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/525114803" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sy Brand <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#525114803">(Jun 20 2025 at 23:36)</a>:</h4>
<p>Thanks for all the feedback! Will likely address it on Monday</p>



<a name="525748556"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/525748556" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Sy Brand <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#525748556">(Jun 25 2025 at 16:17)</a>:</h4>
<p><span class="user-mention silent" data-user-id="253994">Alex Crichton</span> <a href="#narrow/channel/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator/near/524763765">said</a>:</p>
<blockquote>
<p>Anyway the basic limitation here is that imports into a component cannot refer to types defined in the component itself <em>snip</em></p>
</blockquote>
<p>I took your explanation and <a href="https://tartanllama.xyz/posts/wasm-circular-dependencies/">drafted a blog post</a> that explains all of this in more detail. Mostly for my own benefit, but hopefully it'll be useful to point people at if they make the same mistakes I did. If you happen to have time to give it a look for correctness, I'd much appreciate it!  Otherwise I'll just yeet it to the public in the next week or so and hope there are no mistakes <span aria-label="smile" class="emoji emoji-1f604" role="img" title="smile">:smile:</span>.</p>
<div class="message_embed"><a class="message_embed_image" href="https://tartanllama.xyz/posts/wasm-circular-dependencies/" style="background-image: url(&quot;https://uploads.zulipusercontent.net/51d90b7e6ba77c61759a8e048dedbdc92b099760/68747470733a2f2f74617274616e6c6c616d612e78797a2f706f7374732f7761736d2d63697263756c61722d646570656e64656e636965732f696e6465782e706e67&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://tartanllama.xyz/posts/wasm-circular-dependencies/" title="WebAssembly Components: Circular Dependencies and World Elaboration | Sy Brand">WebAssembly Components: Circular Dependencies and World Elaboration | Sy Brand</a></div><div class="message_embed_description">Why circular dependencies between imports and exports don't work, but seem valid</div></div></div>



<a name="525762389"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/327223-wit-bindgen/topic/Memory%20ownership%20with%20the%20C%20binding%20generator/near/525762389" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/327223-wit-bindgen/topic/Memory.20ownership.20with.20the.20C.20binding.20generator.html#525762389">(Jun 25 2025 at 17:46)</a>:</h4>
<p>Oh that's a fantastic post, I'm definitely going to save this and link this to others when this situation comes up!</p>
<p>All looks accurate to me as well, thanks for taking the time to do this!</p>



<hr><p>Last updated: Feb 22 2026 at 11:05 UTC</p>
</html>
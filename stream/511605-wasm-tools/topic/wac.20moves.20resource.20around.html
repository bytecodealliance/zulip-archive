<html>
<head><meta charset="utf-8"><title>wac moves resource around · wasm-tools · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/511605-wasm-tools/index.html">wasm-tools</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/511605-wasm-tools/topic/wac.20moves.20resource.20around.html">wac moves resource around</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="531926084"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/511605-wasm-tools/topic/wac%20moves%20resource%20around/near/531926084" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yan Chen <a href="https://bytecodealliance.github.io/zulip-archive/stream/511605-wasm-tools/topic/wac.20moves.20resource.20around.html#531926084">(Jul 30 2025 at 20:38)</a>:</h4>
<p>I have a <code>wac</code> question similar to <a href="https://github.com/bytecodealliance/wasm-tools/issues/1565#issuecomment-2815677725">https://github.com/bytecodealliance/wasm-tools/issues/1565#issuecomment-2815677725</a>, but not quite the same. Hope to get some suggestions about how I can fix this.</p>
<p>I have the following main WIT file</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">package</span><span class="w"> </span><span class="n">component</span><span class="p">:</span><span class="nc">main</span><span class="p">;</span>

<span class="n">interface</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">resource</span><span class="w"> </span><span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">interface</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">use</span><span class="w"> </span><span class="n">res</span><span class="p">.{</span><span class="n">res</span><span class="p">};</span>
<span class="w">  </span><span class="n">test</span><span class="p">:</span><span class="w"> </span><span class="nc">func</span><span class="p">(</span><span class="n">x</span><span class="p">:</span><span class="w"> </span><span class="nc">res</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">world</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">import</span><span class="w"> </span><span class="n">res</span><span class="p">;</span>
<span class="w">  </span><span class="n">export</span><span class="w"> </span><span class="n">main</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>And I want to virtualize the <code>res</code> interface by implementing this WIT</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">world</span><span class="w"> </span><span class="n">imports</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">import</span><span class="w"> </span><span class="n">res</span><span class="p">;</span>
<span class="w">  </span><span class="n">export</span><span class="w"> </span><span class="n">res</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>When I run <code>wac plug</code>, I get this final interface</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">package</span><span class="w"> </span><span class="n">component</span><span class="p">:</span><span class="nc">main</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">interface</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">resource</span><span class="w"> </span><span class="n">res</span><span class="p">;</span>

<span class="w">    </span><span class="n">test</span><span class="p">:</span><span class="w"> </span><span class="nc">func</span><span class="p">(</span><span class="n">x</span><span class="p">:</span><span class="w"> </span><span class="nc">res</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Basically <code>resource res</code> gets inlined into the <code>main</code> interface. On the host side, I'm still using the original WIT file which expects <code>res.res</code>, not <code>main.res</code>, so it caused a type mismatch when instantiating the wasm.  I created a <a href="https://github.com/chenyan2002/wac-bug-repo">repo</a>. Would be great if I can work around this problem via some wac script.</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasm-tools/issues/1565#issuecomment-2815677725" style="background-image: url(&quot;https://uploads.zulipusercontent.net/c2281c2cc466773facb17d04851e663c385c703d/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f363863353864336232343433303335386539333035323131636662636665383961633939396362333630363832636463303165643165306235383963393138322f62797465636f6465616c6c69616e63652f7761736d2d746f6f6c732f6973737565732f31353635&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasm-tools/issues/1565#issuecomment-2815677725" title="wasi-virt throws error in wasm-compose (redirected from wasi-virt to Wasm-tools) · Issue #1565 · bytecodealliance/wasm-tools">wasi-virt throws error in wasm-compose (redirected from wasi-virt to Wasm-tools) · Issue #1565 · bytecodealliance/wasm-tools</a></div><div class="message_embed_description">Hi, I'm trying to use wasi-virt with a micro service that I have written in rust. I want to give it a pre-opened file directory so that I can read a json file. I am using this command: wasi-virt --...</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/chenyan2002/wac-bug-repo" style="background-image: url(&quot;https://uploads.zulipusercontent.net/867d89179bcbe5eb88e568f8d8eff157928b3f95/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f383937666633396131633863353037646633623663376632373134663732656634343666386430303131383265656466306463643636326261313032613939612f6368656e79616e323030322f7761632d6275672d7265706f&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/chenyan2002/wac-bug-repo" title="GitHub - chenyan2002/wac-bug-repo">GitHub - chenyan2002/wac-bug-repo</a></div><div class="message_embed_description">Contribute to chenyan2002/wac-bug-repo development by creating an account on GitHub.</div></div></div>



<a name="531930313"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/511605-wasm-tools/topic/wac%20moves%20resource%20around/near/531930313" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/511605-wasm-tools/topic/wac.20moves.20resource.20around.html#531930313">(Jul 30 2025 at 21:04)</a>:</h4>
<p>Is your goal to get a component that looks like <code>world root { export main; }</code> and nothing else?</p>



<a name="531930450"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/511605-wasm-tools/topic/wac%20moves%20resource%20around/near/531930450" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/511605-wasm-tools/topic/wac.20moves.20resource.20around.html#531930450">(Jul 30 2025 at 21:05)</a>:</h4>
<p>(thanks for the repro! I was able to figure out what's going on poking around there)</p>



<a name="531930703"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/511605-wasm-tools/topic/wac%20moves%20resource%20around/near/531930703" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yan Chen <a href="https://bytecodealliance.github.io/zulip-archive/stream/511605-wasm-tools/topic/wac.20moves.20resource.20around.html#531930703">(Jul 30 2025 at 21:06)</a>:</h4>
<p>It should look like </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">world</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">import</span><span class="w"> </span><span class="n">res</span><span class="p">;</span>
<span class="w">  </span><span class="n">export</span><span class="w"> </span><span class="n">main</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>In my real example, <code>import res</code> exists in the final wasm, but I get another inlined <code>res</code> in the <code>main</code> interface as well. In the mini-repo, the <code>import res</code> somehow gets dead-code eliminated.</p>



<a name="531931078"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/511605-wasm-tools/topic/wac%20moves%20resource%20around/near/531931078" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/511605-wasm-tools/topic/wac.20moves.20resource.20around.html#531931078">(Jul 30 2025 at 21:09)</a>:</h4>
<p>hm ok then there's a few things going here I think, one is that your <code>virt.wasm</code> doesn't <code>import res</code>, it only does <code>export res</code>, so there's nothing to attach an actual host import to</p>



<a name="531931144"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/511605-wasm-tools/topic/wac%20moves%20resource%20around/near/531931144" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/511605-wasm-tools/topic/wac.20moves.20resource.20around.html#531931144">(Jul 30 2025 at 21:09)</a>:</h4>
<p>but are you thinking that the host <code>res</code> would be imported to <code>virt.wasm:import res</code>, then <code>virt.wasm:export res</code> is imported into <code>main.wasm</code>, and then <code>main.wasm:export main</code> is exported?</p>



<a name="531931835"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/511605-wasm-tools/topic/wac%20moves%20resource%20around/near/531931835" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yan Chen <a href="https://bytecodealliance.github.io/zulip-archive/stream/511605-wasm-tools/topic/wac.20moves.20resource.20around.html#531931835">(Jul 30 2025 at 21:14)</a>:</h4>
<p>hmm, the wit for <code>world imports</code> does have <code>import res</code>. Maybe I need to plug in some real code instead of <code>wit-bingen --stubs</code>.</p>
<p>Yes, at the WIT level, <code>virt.wasm:import res</code>--<code>virt.wasm:export res</code>--plug-to--<code>main.wasm:import res</code>--<code>main.wasm:export main</code>.</p>



<a name="531932100"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/511605-wasm-tools/topic/wac%20moves%20resource%20around/near/531932100" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/511605-wasm-tools/topic/wac.20moves.20resource.20around.html#531932100">(Jul 30 2025 at 21:16)</a>:</h4>
<p>ah ok, then for the result, that's not actually possible. What you're describing is a situation where runtime-wise what's happening is that the final component would <code>import res</code> to get a host thing but then the exported function would actually take an internal, virtualized <code>res</code> interface. That means that there's no actual way to describe what you want in WIT or components as it's not a valid component.</p>
<p>In situations like this <code>wac</code> does its best to produce something and the result can be confusing (e.g. changing the <code>interface</code> definitions as you're seeing). Ideally <code>wac</code> would produce a more first-class error of sorts.</p>



<a name="531932182"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/511605-wasm-tools/topic/wac%20moves%20resource%20around/near/531932182" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/511605-wasm-tools/topic/wac.20moves.20resource.20around.html#531932182">(Jul 30 2025 at 21:17)</a>:</h4>
<p>At the component model level the resource that <code>main</code> refers to must either be imported or exported, it can't be purely internal, so one example would be to have the final component do both <code>export res</code> and <code>export main</code> for example.</p>



<a name="531932822"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/511605-wasm-tools/topic/wac%20moves%20resource%20around/near/531932822" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/511605-wasm-tools/topic/wac.20moves.20resource.20around.html#531932822">(Jul 30 2025 at 21:21)</a>:</h4>
<p>For example:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">package</span><span class="w"> </span><span class="n">composed</span><span class="p">:</span><span class="nc">component</span><span class="p">;</span>

<span class="kd">let</span><span class="w"> </span><span class="n">imports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">virt</span><span class="p">:</span><span class="nc">imports</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w">  </span><span class="p">};</span>
<span class="kd">let</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">root</span><span class="p">:</span><span class="nc">component</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">res</span><span class="p">:</span><span class="w"> </span><span class="nc">imports</span><span class="p">.</span><span class="n">res</span><span class="p">,</span>
<span class="w">  </span><span class="o">..</span><span class="p">.</span>
<span class="p">};</span>
<span class="n">export</span><span class="w"> </span><span class="n">imports</span><span class="p">.</span><span class="n">res</span><span class="p">;</span>
<span class="n">export</span><span class="w"> </span><span class="n">main</span><span class="p">.</span><span class="n">main</span><span class="p">;</span>
</code></pre></div>
<p>produces:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">package</span><span class="w"> </span><span class="n">root</span><span class="p">:</span><span class="nc">component</span><span class="p">;</span>

<span class="n">world</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">export</span><span class="w"> </span><span class="n">component</span><span class="p">:</span><span class="nc">main</span><span class="o">/</span><span class="n">res</span><span class="p">;</span>
<span class="w">  </span><span class="n">export</span><span class="w"> </span><span class="n">component</span><span class="p">:</span><span class="nc">main</span><span class="o">/</span><span class="n">main</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">package</span><span class="w"> </span><span class="n">component</span><span class="p">:</span><span class="nc">main</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">interface</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">resource</span><span class="w"> </span><span class="n">res</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">interface</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">res</span><span class="p">.{</span><span class="n">res</span><span class="p">};</span>

<span class="w">    </span><span class="n">test</span><span class="p">:</span><span class="w"> </span><span class="nc">func</span><span class="p">(</span><span class="n">x</span><span class="p">:</span><span class="w"> </span><span class="nc">res</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>in your example repo</p>



<a name="531932862"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/511605-wasm-tools/topic/wac%20moves%20resource%20around/near/531932862" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/511605-wasm-tools/topic/wac.20moves.20resource.20around.html#531932862">(Jul 30 2025 at 21:21)</a>:</h4>
<p>(and yeah you'd have to add some sort of use of the host <code>import res</code> within <code>virt:imports</code> to prevent it from being DCE'd)</p>



<a name="531947812"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/511605-wasm-tools/topic/wac%20moves%20resource%20around/near/531947812" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yan Chen <a href="https://bytecodealliance.github.io/zulip-archive/stream/511605-wasm-tools/topic/wac.20moves.20resource.20around.html#531947812">(Jul 30 2025 at 23:05)</a>:</h4>
<p>Thanks! This fixed my example repo. In my real code, I get a more tricky case which is not very easy to reproduce. Roughly, it's this WIT file</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">package</span><span class="w"> </span><span class="n">component</span><span class="p">:</span><span class="nc">main</span><span class="p">;</span>

<span class="n">interface</span><span class="w"> </span><span class="k">async</span><span class="o">-</span><span class="n">io</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">resource</span><span class="w"> </span><span class="n">handle</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">interface</span><span class="w"> </span><span class="n">http</span><span class="o">-</span><span class="n">body</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">use</span><span class="w"> </span><span class="k">async</span><span class="o">-</span><span class="n">io</span><span class="p">.{</span><span class="n">handle</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">body</span><span class="o">-</span><span class="n">handle</span><span class="p">};</span>
<span class="p">}</span>

<span class="n">interface</span><span class="w"> </span><span class="n">http</span><span class="o">-</span><span class="n">resp</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">use</span><span class="w"> </span><span class="n">http</span><span class="o">-</span><span class="n">body</span><span class="p">.{</span><span class="n">body</span><span class="o">-</span><span class="n">handle</span><span class="p">};</span>
<span class="p">}</span>

<span class="n">interface</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">use</span><span class="w"> </span><span class="n">http</span><span class="o">-</span><span class="n">body</span><span class="p">.{</span><span class="n">body</span><span class="o">-</span><span class="n">handle</span><span class="p">};</span>
<span class="w">  </span><span class="n">test</span><span class="p">:</span><span class="w"> </span><span class="nc">func</span><span class="p">(</span><span class="n">x</span><span class="p">:</span><span class="w"> </span><span class="nc">body</span><span class="o">-</span><span class="n">handle</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">world</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">import</span><span class="w"> </span><span class="k">async</span><span class="o">-</span><span class="n">io</span><span class="p">;</span>
<span class="w">  </span><span class="n">import</span><span class="w"> </span><span class="n">http</span><span class="o">-</span><span class="n">body</span><span class="p">;</span>
<span class="w">  </span><span class="n">import</span><span class="w"> </span><span class="n">http</span><span class="o">-</span><span class="n">resp</span><span class="p">;</span>
<span class="w">  </span><span class="n">export</span><span class="w"> </span><span class="n">main</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">world</span><span class="w"> </span><span class="n">imports</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">import</span><span class="w"> </span><span class="k">async</span><span class="o">-</span><span class="n">io</span><span class="p">;</span>
<span class="w">  </span><span class="n">import</span><span class="w"> </span><span class="n">http</span><span class="o">-</span><span class="n">body</span><span class="p">;</span>
<span class="w">  </span><span class="n">import</span><span class="w"> </span><span class="n">http</span><span class="o">-</span><span class="n">resp</span><span class="p">;</span>
<span class="w">  </span><span class="n">export</span><span class="w"> </span><span class="k">async</span><span class="o">-</span><span class="n">io</span><span class="p">;</span>
<span class="w">  </span><span class="n">export</span><span class="w"> </span><span class="n">http</span><span class="o">-</span><span class="n">body</span><span class="p">;</span>
<span class="w">  </span><span class="n">export</span><span class="w"> </span><span class="n">http</span><span class="o">-</span><span class="n">resp</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>After <code>wit compose</code> with <code>export imports...; export main...;</code>, for <code>http-resp</code>, I get <code>use async-io.{handle as body-handle}</code> instead of the original <code>use http-body.{body-handle}</code>.</p>
<p>I'm not sure if this difference matters as they are just type alias in Rust. But I still get <code>failed to convert function to given type</code> error when instantiating the wasm module. If we try that WIT file directly, we actually get the correct alias name, so it's harder to reproduce it. Just posting here in case you have a hunch of what might go wrong.</p>



<a name="531954768"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/511605-wasm-tools/topic/wac%20moves%20resource%20around/near/531954768" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yan Chen <a href="https://bytecodealliance.github.io/zulip-archive/stream/511605-wasm-tools/topic/wac.20moves.20resource.20around.html#531954768">(Jul 31 2025 at 00:18)</a>:</h4>
<p>Okay, I have a <a href="https://github.com/chenyan2002/wac-bug-repo/tree/more-tricky-bug">repo</a> for this. <code>http-resp</code> is kind of "internal", as it's not directly mentioned in the original exports. After <code>wac compose</code>, it does get exported.</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/chenyan2002/wac-bug-repo/tree/more-tricky-bug" style="background-image: url(&quot;https://uploads.zulipusercontent.net/867d89179bcbe5eb88e568f8d8eff157928b3f95/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f383937666633396131633863353037646633623663376632373134663732656634343666386430303131383265656466306463643636326261313032613939612f6368656e79616e323030322f7761632d6275672d7265706f&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/chenyan2002/wac-bug-repo/tree/more-tricky-bug" title="GitHub - chenyan2002/wac-bug-repo at more-tricky-bug">GitHub - chenyan2002/wac-bug-repo at more-tricky-bug</a></div><div class="message_embed_description">Contribute to chenyan2002/wac-bug-repo development by creating an account on GitHub.</div></div></div>



<a name="532140014"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/511605-wasm-tools/topic/wac%20moves%20resource%20around/near/532140014" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/511605-wasm-tools/topic/wac.20moves.20resource.20around.html#532140014">(Jul 31 2025 at 18:16)</a>:</h4>
<p>hm ok that might be a bug in <code>wac</code> perhaps? That I think should all work otherwise though</p>



<a name="532140887"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/511605-wasm-tools/topic/wac%20moves%20resource%20around/near/532140887" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yan Chen <a href="https://bytecodealliance.github.io/zulip-archive/stream/511605-wasm-tools/topic/wac.20moves.20resource.20around.html#532140887">(Jul 31 2025 at 18:20)</a>:</h4>
<p>I did some more debugging. That alias is actually fine. The problem is that <code>main.test</code> now takes the <code>body-handle</code> resource from <code>export:async-io.handle</code>, not the <code>import:async-io.handle</code>. So the host is expecting a host-side resource handle, but the wasm provides a guest-side handle with the same name.</p>



<a name="532142147"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/511605-wasm-tools/topic/wac%20moves%20resource%20around/near/532142147" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/511605-wasm-tools/topic/wac.20moves.20resource.20around.html#532142147">(Jul 31 2025 at 18:27)</a>:</h4>
<p>I think that's more-or-less a fundamental requirement here unfortunately. The <code>main.wasm</code> component exports a function that refers to a resource in an import, and you're satisfying that import with <code>virt.wasm</code>. You'd have to make a second wrapper of sorts which was a <code>test</code> function, for example, which took a host handle, then created a guest handle from that host handle, then called the <code>main.wasm</code>'s test export with the guest handle</p>



<a name="532142172"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/511605-wasm-tools/topic/wac%20moves%20resource%20around/near/532142172" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/511605-wasm-tools/topic/wac.20moves.20resource.20around.html#532142172">(Jul 31 2025 at 18:27)</a>:</h4>
<p>so you'd have to interpose both on the imports and on the exports</p>



<a name="532161728"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/511605-wasm-tools/topic/wac%20moves%20resource%20around/near/532161728" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yan Chen <a href="https://bytecodealliance.github.io/zulip-archive/stream/511605-wasm-tools/topic/wac.20moves.20resource.20around.html#532161728">(Jul 31 2025 at 20:24)</a>:</h4>
<p>So I add an export module in the repo with this wac script</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="n">imports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">virt</span><span class="p">:</span><span class="nc">imports</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">};</span>
<span class="kd">let</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">root</span><span class="p">:</span><span class="nc">component</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="n">imports</span><span class="w"> </span><span class="p">};</span>
<span class="kd">let</span><span class="w"> </span><span class="kr">final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">virt</span><span class="p">:</span><span class="nc">exports</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">main</span><span class="p">:</span><span class="w"> </span><span class="nc">main</span><span class="p">.</span><span class="n">main</span><span class="p">,</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="p">};</span>
<span class="n">export</span><span class="w"> </span><span class="n">imports</span><span class="o">..</span><span class="p">.;</span>
<span class="n">export</span><span class="w"> </span><span class="n">main</span><span class="o">..</span><span class="p">.;</span>
</code></pre></div>
<p>And I get this error:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">error</span><span class="p">:</span><span class="w"> </span><span class="nc">the</span><span class="w"> </span><span class="n">encoding</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">graph</span><span class="w"> </span><span class="n">failed</span><span class="w"> </span><span class="n">validation</span>

<span class="n">Caused</span><span class="w"> </span><span class="n">by</span><span class="p">:</span>
<span class="w">    </span><span class="nc">type</span><span class="w"> </span><span class="n">mismatch</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">import</span><span class="w"> </span><span class="err">`</span><span class="n">component</span><span class="p">:</span><span class="nc">main</span><span class="o">/</span><span class="n">main</span><span class="err">`</span>
<span class="w">    </span><span class="k">type</span><span class="w"> </span><span class="nc">mismatch</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">instance</span><span class="w"> </span><span class="n">export</span><span class="w"> </span><span class="err">`</span><span class="n">body</span><span class="o">-</span><span class="n">handle</span><span class="err">`</span>
<span class="w">    </span><span class="n">resource</span><span class="w"> </span><span class="n">types</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">same</span><span class="w"> </span><span class="p">(</span><span class="n">ResourceId</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">globally_unique_id</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">contextually_unique_id</span><span class="p">:</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="n">vs</span><span class="p">.</span><span class="w"> </span><span class="n">ResourceId</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">globally_unique_id</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">contextually_unique_id</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">})</span><span class="w"> </span><span class="p">(</span><span class="n">at</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="mh">0x4685c6</span><span class="p">)</span>
</code></pre></div>
<p>It feels like the wac script is not expressive enough to indicate which import are host vs guest side, and the solver is doing a best effort job?</p>



<a name="532181327"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/511605-wasm-tools/topic/wac%20moves%20resource%20around/near/532181327" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/511605-wasm-tools/topic/wac.20moves.20resource.20around.html#532181327">(Jul 31 2025 at 22:46)</a>:</h4>
<p>perhaps? It depends on <code>virt:exports</code> and <code>final</code> there. While it's definitely a possibility that <code>wac</code> has bugs, it's also a possibility that this is model-able in the component model exactly as-is and needs some massaging (e.g. injecting the wrapper for both imports and exports)</p>



<a name="532185097"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/511605-wasm-tools/topic/wac%20moves%20resource%20around/near/532185097" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Yan Chen <a href="https://bytecodealliance.github.io/zulip-archive/stream/511605-wasm-tools/topic/wac.20moves.20resource.20around.html#532185097">(Jul 31 2025 at 23:17)</a>:</h4>
<p>Looking at <code>wac resolve</code>,  I think <code>wac compose</code> is actually doing the right thing: the resource gets virtualized, so the previously host side resource expectedly becomes a guest side resource, which eventually calls the host resource. The type mismatch is better resolved on the wasmtime-wit-bindgen side then.</p>
<p><a href="/user_uploads/15107/vHPMbJXkjLQWORXMfjECpN65/compose.gif">compose.gif</a></p>
<div class="message_inline_image"><a href="/user_uploads/15107/vHPMbJXkjLQWORXMfjECpN65/compose.gif" title="compose.gif"><img data-original-content-type="image/gif" data-original-dimensions="1448x531" src="/user_uploads/thumbnail/15107/vHPMbJXkjLQWORXMfjECpN65/compose.gif/840x560.webp"></a></div>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
<html>
<head><meta charset="utf-8"><title>UDP bind and connect behavior in `wasi-libc` · wasi · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/index.html">wasi</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/UDP.20bind.20and.20connect.20behavior.20in.20.60wasi-libc.60.html">UDP bind and connect behavior in `wasi-libc`</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="573803598"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/UDP%20bind%20and%20connect%20behavior%20in%20%60wasi-libc%60/near/573803598" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/UDP.20bind.20and.20connect.20behavior.20in.20.60wasi-libc.60.html#573803598">(Feb 13 2026 at 18:17)</a>:</h4>
<p>To the POSIX experts: I'm adding <a href="https://github.com/tokio-rs/mio/pull/1836">WASIp2 support to <code>mio</code></a> and currently triaging some test failures.  Along the way, I've found and fixed a few bugs in <code>wasi-libc</code>, but am not sure how to address <a href="https://github.com/tokio-rs/mio/blob/66ac9fab79bf191218488c4f35c99d13935b7e12/tests/udp_socket.rs#L396">this one</a>.</p>
<p>That test creates and binds three <code>SOCK_DGRAM</code> sockets, then reconnects them to <em>different</em> addresses than they were bound to.  Then it uses the first socket to send a packet to the address which the third socket is bound to <em>but</em> <em>not</em> <em>connected</em> <em>to</em>, expecting the third socket to receive that packet.  On <code>wasi-libc</code> and <code>wasmtime-wasi</code>'s p2 implementation, this fails because the third socket only receives sockets from the address it was connected to, no the one it was bound to.  If I comment out <a href="https://github.com/tokio-rs/mio/blob/66ac9fab79bf191218488c4f35c99d13935b7e12/tests/udp_socket.rs#L409">this line</a> (i.e. <em>not</em> connect the third socket), the test passes.</p>
<p>The Linux man page for <code>connect(2)</code> says this:</p>
<blockquote>
<p>If the socket sockfd is of type SOCK_DGRAM, then addr is the address to which datagrams are sent by default, and the only address from which datagrams are received.</p>
</blockquote>
<p>...which seems to say that <code>wasi-libc</code>/<code>wasmtime-wasi</code>'s behavior is correct, and that the <code>mio</code> test is wrong.  However, the test <em>does</em> pass on native Linux (i.e. with no Wasm involved) regardless of whether I comment out that one line or not, so Linux seems to be behaving differently than the man page indicates, i.e. the socket is receiving packets for the address it was bound to, not the one it was connected to.</p>
<p>Can anyone comment on what the correct behavior is here?  And maybe link to some authoritative document?</p>



<a name="573805833"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/UDP%20bind%20and%20connect%20behavior%20in%20%60wasi-libc%60/near/573805833" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/UDP.20bind.20and.20connect.20behavior.20in.20.60wasi-libc.60.html#573805833">(Feb 13 2026 at 18:25)</a>:</h4>
<p><a href="https://stackoverflow.com/a/9741966">This random SO answer</a> seems to confirm the behavior I'm seeing on Linux, which is that <code>connect</code>ing an already-bound UDP socket only affects where packets are <em>sent</em> using that socket, while the address from which packets are <em>received</em> remains the one the socket was bound to.</p>



<a name="573806605"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/UDP%20bind%20and%20connect%20behavior%20in%20%60wasi-libc%60/near/573806605" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> David Lloyd <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/UDP.20bind.20and.20connect.20behavior.20in.20.60wasi-libc.60.html#573806605">(Feb 13 2026 at 18:28)</a>:</h4>
<p><a href="https://pubs.opengroup.org/onlinepubs/9799919799/functions/V2_chap02.html#tag_16_10_06">https://pubs.opengroup.org/onlinepubs/9799919799/functions/V2_chap02.html#tag_16_10_06</a> is authoritative IMO (POSIX standard)</p>



<a name="573807548"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/UDP%20bind%20and%20connect%20behavior%20in%20%60wasi-libc%60/near/573807548" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/UDP.20bind.20and.20connect.20behavior.20in.20.60wasi-libc.60.html#573807548">(Feb 13 2026 at 18:34)</a>:</h4>
<p>Ah, that's helpful, it reading <a href="https://pubs.opengroup.org/onlinepubs/9799919799/functions/connect.html">this</a> helped me realize I was misreading the Linux man page:</p>
<blockquote>
<p>...and the only address from which datagrams are received.</p>
</blockquote>
<p>I read that as "the address on which datagrams are received", but now I see that's not what it's saying.  The <code>opengroup.org</code> page spells it out:</p>
<blockquote>
<p>For SOCK_DGRAM sockets, the peer address identifies where all datagrams are sent on subsequent <a href="https://pubs.opengroup.org/onlinepubs/9799919799/functions/send.html">*send*()</a> functions, and limits the remote sender for subsequent <a href="https://pubs.opengroup.org/onlinepubs/9799919799/functions/recv.html">*recv*()</a> functions</p>
</blockquote>



<a name="573807686"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/UDP%20bind%20and%20connect%20behavior%20in%20%60wasi-libc%60/near/573807686" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/UDP.20bind.20and.20connect.20behavior.20in.20.60wasi-libc.60.html#573807686">(Feb 13 2026 at 18:35)</a>:</h4>
<p>I'm a bit confused on your interpretation of the test here Joel, you say that the test reconnects the sockets to different addresses, but the test is only connecting for the first time? The <code>socket3</code> is configured to only receive from <code>socket1</code>'s address which looks like it should work given the specified behavior of <code>connect</code>?</p>



<a name="573807796"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/UDP%20bind%20and%20connect%20behavior%20in%20%60wasi-libc%60/near/573807796" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/UDP.20bind.20and.20connect.20behavior.20in.20.60wasi-libc.60.html#573807796">(Feb 13 2026 at 18:36)</a>:</h4>
<p>in the test only <code>socket1</code> is reconnected but <code>socket2</code> and <code>socket3</code> stay connected to <code>socket1</code> the whole time and <code>socket1</code> then never receives anything</p>



<a name="573807817"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/UDP%20bind%20and%20connect%20behavior%20in%20%60wasi-libc%60/near/573807817" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/UDP.20bind.20and.20connect.20behavior.20in.20.60wasi-libc.60.html#573807817">(Feb 13 2026 at 18:36)</a>:</h4>
<p>Yeah, I misinterpreted the "receive from" as "receive on"; i.e. I confused the role of sender address and receiver address for incoming packets.</p>



<a name="573808062"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/UDP%20bind%20and%20connect%20behavior%20in%20%60wasi-libc%60/near/573808062" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/UDP.20bind.20and.20connect.20behavior.20in.20.60wasi-libc.60.html#573808062">(Feb 13 2026 at 18:38)</a>:</h4>
<p>In any case, <code>wasi-libc</code>/<code>wasmtime-wasi</code> are <em>not</em> doing the right thing, which clarifies the next steps.</p>



<a name="573818617"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/UDP%20bind%20and%20connect%20behavior%20in%20%60wasi-libc%60/near/573818617" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/UDP.20bind.20and.20connect.20behavior.20in.20.60wasi-libc.60.html#573818617">(Feb 13 2026 at 19:55)</a>:</h4>
<p>ok, this seems to be an issue with <code>wasmtime-wasi</code>.  I added some logging and discovered that, when you connect a UDP socket for the first time, its local address remains unchanged from what it was bound to.  However, when you connect it a second time, the local address changes, even though only the remote address should have changed.  On native Linux, the local address always remains the same.</p>
<p>This seems to be related to the <code>wasmtime-wasi</code> code that proactively disconnects by calling <code>rustix::net::connect_unspec</code> before connecting to the new address.  This patch "fixes" it, although based on the surrounding comments I don't think it's the right solution:</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gh">diff --git a/crates/wasi/src/p2/host/udp.rs b/crates/wasi/src/p2/host/udp.rs</span>
<span class="gh">index 1ef8350399..5dd426e736 100644</span>
<span class="gd">--- a/crates/wasi/src/p2/host/udp.rs</span>
<span class="gi">+++ b/crates/wasi/src/p2/host/udp.rs</span>
<span class="gu">@@ -71,9 +71,9 @@ impl udp::HostUdpSocket for WasiSocketsCtxView&lt;'_&gt; {</span>
<span class="w"> </span>        //   if there isn't a disconnect in between.

<span class="w"> </span>        // Step #1: Disconnect
<span class="gd">-        if socket.is_connected() {</span>
<span class="gd">-            socket.disconnect()?;</span>
<span class="gd">-        }</span>
<span class="gi">+        // if socket.is_connected() {</span>
<span class="gi">+        //     socket.disconnect()?;</span>
<span class="gi">+        // }</span>

<span class="w"> </span>        // Step #2: (Re)connect
<span class="w"> </span>        if let Some(connect_addr) = remote_address {
<span class="gh">diff --git a/crates/wasi/src/sockets/udp.rs b/crates/wasi/src/sockets/udp.rs</span>
<span class="gh">index 482c6aa090..ba1e93f18d 100644</span>
<span class="gd">--- a/crates/wasi/src/sockets/udp.rs</span>
<span class="gi">+++ b/crates/wasi/src/sockets/udp.rs</span>
<span class="gu">@@ -162,10 +162,10 @@ impl UdpSocket {</span>
<span class="w"> </span>        //   if there isn't a disconnect in between.

<span class="w"> </span>        // Step #1: Disconnect
<span class="gd">-        if let UdpState::Connected(..) = self.udp_state {</span>
<span class="gd">-            udp_disconnect(&amp;self.socket)?;</span>
<span class="gd">-            self.udp_state = UdpState::Bound;</span>
<span class="gd">-        }</span>
<span class="gi">+        // if let UdpState::Connected(..) = self.udp_state {</span>
<span class="gi">+        //     udp_disconnect(&amp;self.socket)?;</span>
<span class="gi">+        //     self.udp_state = UdpState::Bound;</span>
<span class="gi">+        // }</span>
<span class="w"> </span>        // Step #2: (Re)connect
<span class="w"> </span>        connect(&amp;self.socket, &amp;addr).map_err(|error| match error {
<span class="w"> </span>            Errno::AFNOSUPPORT =&gt; ErrorCode::InvalidArgument, // See `udp_bind` implementation.
</code></pre></div>



<a name="573818755"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/UDP%20bind%20and%20connect%20behavior%20in%20%60wasi-libc%60/near/573818755" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/UDP.20bind.20and.20connect.20behavior.20in.20.60wasi-libc.60.html#573818755">(Feb 13 2026 at 19:56)</a>:</h4>
<p>I'll go ahead and open a Wasmtime issue and we can continue there.</p>



<hr><p>Last updated: Feb 22 2026 at 11:05 UTC</p>
</html>
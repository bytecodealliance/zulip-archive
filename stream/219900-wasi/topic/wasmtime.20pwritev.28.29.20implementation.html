<html>
<head><meta charset="utf-8"><title>wasmtime pwritev() implementation · wasi · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/index.html">wasi</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/wasmtime.20pwritev.28.29.20implementation.html">wasmtime pwritev() implementation</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="532771635"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/wasmtime%20pwritev%28%29%20implementation/near/532771635" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Chevalier <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/wasmtime.20pwritev.28.29.20implementation.html#532771635">(Aug 04 2025 at 17:44)</a>:</h4>
<p>Hi,</p>
<p>It looks like wasmtime's implementation of <code>pwritev()</code>, in both preview1 and the preview1 component adapter, only writes one of the vectors even when more than one non-empty vector is provided:</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasi-preview1-component-adapter/src/lib.rs#L1201">https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasi-preview1-component-adapter/src/lib.rs#L1201</a> (there's even a comment saying "Skip leading non-empty buffers", though not why)</p>
<p>and</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasi/src/preview1.rs#L580">https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasi/src/preview1.rs#L580</a></p>
<p>As far as I know, the semantics of <code>pwritev()</code> is that all the buffers should be written to the file.</p>
<p>Is this a bug or deliberate?</p>
<p>Thanks,<br>
Tim</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasi-preview1-component-adapter/src/lib.rs#L1201" style="background-image: url(&quot;https://uploads.zulipusercontent.net/581fd4d5bced9b3c38eae4afc04c47b3531147c5/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f613736373238396635343033633961613565636136363835636638626666636666333936336661643637336534623031656637366639333738356334613366352f62797465636f6465616c6c69616e63652f7761736d74696d65&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasi-preview1-component-adapter/src/lib.rs#L1201" title="wasmtime/crates/wasi-preview1-component-adapter/src/lib.rs at main · bytecodealliance/wasmtime">wasmtime/crates/wasi-preview1-component-adapter/src/lib.rs at main · bytecodealliance/wasmtime</a></div><div class="message_embed_description">A lightweight WebAssembly runtime that is fast, secure, and standards-compliant - bytecodealliance/wasmtime</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasi/src/preview1.rs#L580" style="background-image: url(&quot;https://uploads.zulipusercontent.net/581fd4d5bced9b3c38eae4afc04c47b3531147c5/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f613736373238396635343033633961613565636136363835636638626666636666333936336661643637336534623031656637366639333738356334613366352f62797465636f6465616c6c69616e63652f7761736d74696d65&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasi/src/preview1.rs#L580" title="wasmtime/crates/wasi/src/preview1.rs at main · bytecodealliance/wasmtime">wasmtime/crates/wasi/src/preview1.rs at main · bytecodealliance/wasmtime</a></div><div class="message_embed_description">A lightweight WebAssembly runtime that is fast, secure, and standards-compliant - bytecodealliance/wasmtime</div></div></div>



<a name="532772883"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/wasmtime%20pwritev%28%29%20implementation/near/532772883" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dave Bakker (badeend) <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/wasmtime.20pwritev.28.29.20implementation.html#532772883">(Aug 04 2025 at 17:53)</a>:</h4>
<blockquote>
<p>As far as I know, the semantics of <code>pwritev()</code> is that all the buffers should be written to the file.</p>
</blockquote>
<p>I don't think that's right. AFAIK, writes are always allowed to return less than requested.</p>



<a name="532773323"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/wasmtime%20pwritev%28%29%20implementation/near/532773323" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dave Bakker (badeend) <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/wasmtime.20pwritev.28.29.20implementation.html#532773323">(Aug 04 2025 at 17:55)</a>:</h4>
<p>The man pages don't describe any such requirement either.</p>



<a name="532774737"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/wasmtime%20pwritev%28%29%20implementation/near/532774737" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Chevalier <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/wasmtime.20pwritev.28.29.20implementation.html#532774737">(Aug 04 2025 at 18:06)</a>:</h4>
<p><span class="user-mention" data-user-id="378155">@Dave Bakker (badeend)</span> You're right -- but it still seems strange to me for the implementation to _always_ return less than requested.</p>



<a name="532775847"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/wasmtime%20pwritev%28%29%20implementation/near/532775847" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Dave Bakker (badeend) <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/wasmtime.20pwritev.28.29.20implementation.html#532775847">(Aug 04 2025 at 18:16)</a>:</h4>
<p>The adapter currently translates 1 "syscall" from the guest into 1 syscall on the host, and doesn't attempt to abstract over the mismatch.</p>
<p>Maybe atomicity might play a role here. If the adapter were to issue writes in a loop, the whole <code>pwritev</code> call from the guest's POV wouldn't be atomic anymore.<br>
Linux' docs mention:</p>
<blockquote>
<p>the data written by writev() is written as a single block that is not intermingled with output from writes in other processes</p>
</blockquote>
<p>But can't say for sure if this was the actual reason nor if atomicity is even a requirement for WASI. I wasn't involved in this code.</p>



<a name="532977233"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/wasmtime%20pwritev%28%29%20implementation/near/532977233" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/wasmtime.20pwritev.28.29.20implementation.html#532977233">(Aug 05 2025 at 19:26)</a>:</h4>
<p>im searching for anywhere we wrote down reasoning for that behavior</p>



<a name="532977268"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/wasmtime%20pwritev%28%29%20implementation/near/532977268" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/wasmtime.20pwritev.28.29.20implementation.html#532977268">(Aug 05 2025 at 19:27)</a>:</h4>
<p>i found <a href="https://github.com/bytecodealliance/wasmtime/issues/7830">https://github.com/bytecodealliance/wasmtime/issues/7830</a> which affirms it is the way it is because the manpage permits it</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/issues/7830" style="background-image: url(&quot;https://uploads.zulipusercontent.net/4847304a0f44746b0ce8c00b34dd8796fe37e2c8/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f316366633738623236633036636331643563383737303330653630626566333864323835623836396662616363323936386666343962336265336330326638322f62797465636f6465616c6c69616e63652f7761736d74696d652f6973737565732f37383330&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/issues/7830" title="POSIX `readv()`/`preadv()`/`writev()`/`pwritev()` do not use all buffers under preview 2 (as found by Python) · Issue #7830 · bytecodealliance/wasmtime">POSIX `readv()`/`preadv()`/`writev()`/`pwritev()` do not use all buffers under preview 2 (as found by Python) · Issue #7830 · bytecodealliance/wasmtime</a></div><div class="message_embed_description">Test Case TODO: upload Wasm file here Steps to Reproduce https://github.com/python/cpython/blob/07236f5b39a2e534cf190cd4f7c73300d209520b/Lib/test/test_posix.py#L520-L525 https://github.com/python/c...</div></div></div>



<a name="532977379"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/wasmtime%20pwritev%28%29%20implementation/near/532977379" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/wasmtime.20pwritev.28.29.20implementation.html#532977379">(Aug 05 2025 at 19:28)</a>:</h4>
<p>I can imagine that atomicity was the reason, but I don't know if that reason is well enough motivated that we should keep the behavior or not</p>



<a name="532977430"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/wasmtime%20pwritev%28%29%20implementation/near/532977430" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/wasmtime.20pwritev.28.29.20implementation.html#532977430">(Aug 05 2025 at 19:28)</a>:</h4>
<p>I suspect <span class="user-mention" data-user-id="254083">@Dan Gohman</span> is the one who remembers best</p>



<a name="532977851"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/wasmtime%20pwritev%28%29%20implementation/near/532977851" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Chevalier <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/wasmtime.20pwritev.28.29.20implementation.html#532977851">(Aug 05 2025 at 19:31)</a>:</h4>
<p>It would make sense if atomicity was the reason. The only way I can think of to implement the operations without underlying support in wasip2 would be to copy all the buffers into a single buffer -- but then, that probably wouldn't be what you want if you're concerned about performance enough to use these operations.</p>



<a name="532978980"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/wasmtime%20pwritev%28%29%20implementation/near/532978980" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/wasmtime.20pwritev.28.29.20implementation.html#532978980">(Aug 05 2025 at 19:39)</a>:</h4>
<p>making a copy of all the buffers into a single contiguous buffer is basically just off the table, too expensive</p>



<a name="532979047"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/wasmtime%20pwritev%28%29%20implementation/near/532979047" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pat Hickey <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/wasmtime.20pwritev.28.29.20implementation.html#532979047">(Aug 05 2025 at 19:40)</a>:</h4>
<p>so it really comes down to, do we just write the first buffer, or do we attempt to iterate through all of them</p>



<a name="532982475"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/wasmtime%20pwritev%28%29%20implementation/near/532982475" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/wasmtime.20pwritev.28.29.20implementation.html#532982475">(Aug 05 2025 at 20:04)</a>:</h4>
<p>There's more discussion as well at <a href="https://github.com/bytecodealliance/wasmtime/issues/8037">https://github.com/bytecodealliance/wasmtime/issues/8037</a> and <a href="https://github.com/bytecodealliance/wasmtime/pull/8072">https://github.com/bytecodealliance/wasmtime/pull/8072</a>. Personally I've also been one advocating for "it's ok to pick just one buffer" for the reason of atomicity.</p>
<p>This clearly is a common papercut though that hits folks though. My assumption is that most folks are doing small "hello world"-style things where it's unreasonable to expect a "real" implementation which would check the return value and loop over the result (e.g. writing raw <code>*.wat</code>). In such a context it might be reasonable to see that if multiple vectors were passed and the total size is less than some small threshold (e.g. 512 bytes) we could copy it to the host and do the write</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/issues/8037" style="background-image: url(&quot;https://uploads.zulipusercontent.net/9c5c858f5c33a8b8af33b73cef2fbc77a9dc7060/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f656262343838613738373566376263323135353939356538326433666365363936653139613566363434373766356331626531366663363930396165313065322f62797465636f6465616c6c69616e63652f7761736d74696d652f6973737565732f38303337&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/issues/8037" title="fd_write ignores iovs_len &gt; 1 · Issue #8037 · bytecodealliance/wasmtime">fd_write ignores iovs_len &gt; 1 · Issue #8037 · bytecodealliance/wasmtime</a></div><div class="message_embed_description">Am I crazy? I thought I might be misunderstanding something, but then I found someone else's example online that also doesn't work. Test Case ;; hello.wat (module ;; define the expected type for fd...</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/pull/8072" style="background-image: url(&quot;https://uploads.zulipusercontent.net/b7875502bb654476af891bca47f6af410aa4c9c9/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f613664346430373330396666383931346537366133373939303863663434633734613330353733643235393732316363393336623961326133393666656535652f62797465636f6465616c6c69616e63652f7761736d74696d652f70756c6c2f38303732&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/pull/8072" title="Write all iovs in fd_write of wasi-preview1-component-adapter by ospencer · Pull Request #8072 · bytecodealliance/wasmtime">Write all iovs in fd_write of wasi-preview1-component-adapter by ospencer · Pull Request #8072 · bytecodealliance/wasmtime</a></div><div class="message_embed_description">I noticed that the implementation of fd_write in the preview1 adapter only writes the first iov in the list passed. This change writes all of them. I&#39;m happy to add a test for this, though I co...</div></div></div>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
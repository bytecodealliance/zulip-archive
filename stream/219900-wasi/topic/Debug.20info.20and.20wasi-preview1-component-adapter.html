<html>
<head><meta charset="utf-8"><title>Debug info and wasi-preview1-component-adapter · wasi · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/index.html">wasi</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Debug.20info.20and.20wasi-preview1-component-adapter.html">Debug info and wasi-preview1-component-adapter</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="532175353"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Debug%20info%20and%20wasi-preview1-component-adapter/near/532175353" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Chevalier <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Debug.20info.20and.20wasi-preview1-component-adapter.html#532175353">(Jul 31 2025 at 22:01)</a>:</h4>
<p>Hi,</p>
<p>For background, I'm working on porting wasi-libc to use native wasip2 rather than relying on the preview1 component adapter. As an auxiliary task, I'm trying to improve test coverage so I know what the baseline behavior is with the component adapter. I'm trying to debug a test in lldb and am finding that there doesn't seem to be any debug info for functions defined in the component adapter. I added a new test that calls <code>posix_fdadvise()</code> and I want to set a breakpoint in the <code>fd_advise()</code> function defined in the component adapter. The breakpoint works, but the JITted code is displayed rather than the Rust source code:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Process</span><span class="w"> </span><span class="mi">1934747</span><span class="w"> </span><span class="n">stopped</span>
<span class="o">*</span><span class="w"> </span><span class="n">thread</span><span class="w"> </span><span class="p">#</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">'</span><span class="na">wasmtime</span><span class="o">'</span><span class="p">,</span><span class="w"> </span><span class="n">stop</span><span class="w"> </span><span class="n">reason</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">breakpoint</span><span class="w"> </span><span class="mf">1.5</span>
<span class="w">    </span><span class="n">frame</span><span class="w"> </span><span class="p">#</span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="mh">0x00007ffff60950a0</span><span class="w"> </span><span class="n">JIT</span><span class="p">(</span><span class="mh">0x7ffff5d77010</span><span class="p">)</span><span class="err">`</span><span class="n">fd_advise</span><span class="p">(</span><span class="n">var0</span><span class="o">=&lt;</span><span class="n">unavailable</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">var1</span><span class="o">=&lt;</span><span class="n">unavailable</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">var2</span><span class="o">=&lt;</span><span class="n">unavailable</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">var3</span><span class="o">=&lt;</span><span class="n">unavailable</span><span class="o">&gt;</span><span class="p">)</span>
<span class="n">JIT</span><span class="p">(</span><span class="mh">0x7ffff5d77010</span><span class="p">)</span><span class="err">`</span><span class="n">fd_advise</span><span class="p">:</span>
<span class="p">-&gt;</span><span class="w">  </span><span class="mh">0x7ffff60950a0</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">:</span><span class="w"> </span><span class="nc">pushq</span><span class="w">  </span><span class="o">%</span><span class="n">rbp</span>
<span class="w">    </span><span class="mh">0x7ffff60950a1</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">:</span><span class="w"> </span><span class="nc">movq</span><span class="w">   </span><span class="o">%</span><span class="n">rsp</span><span class="p">,</span><span class="w"> </span><span class="o">%</span><span class="n">rbp</span>
<span class="w">    </span><span class="mh">0x7ffff60950a4</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">4</span><span class="o">&gt;</span><span class="p">:</span><span class="w"> </span><span class="nc">movq</span><span class="w">   </span><span class="mh">0x8</span><span class="p">(</span><span class="o">%</span><span class="n">rdi</span><span class="p">),</span><span class="w"> </span><span class="o">%</span><span class="n">r10</span>
<span class="w">    </span><span class="mh">0x7ffff60950a8</span><span class="w"> </span><span class="o">&lt;+</span><span class="mi">8</span><span class="o">&gt;</span><span class="p">:</span><span class="w"> </span><span class="nc">movq</span><span class="w">   </span><span class="mh">0x10</span><span class="p">(</span><span class="o">%</span><span class="n">r10</span><span class="p">),</span><span class="w"> </span><span class="o">%</span><span class="n">r10</span>
</code></pre></div>
<p>I already recompiled the wasi-preview1-component-adapter crate for debugging and changed wasi-libc's test Makefile to use my debug version rather than the downloaded one from github, and am using a debug build of wasmtime. I also added "-g -O0" to <code>CFLAGS</code>. Otherwise, the test Makefile is unmodified, so the test is compiled like:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">clang</span><span class="o">-</span><span class="mi">19</span><span class="w"> </span><span class="o">--</span><span class="n">target</span><span class="o">=</span><span class="n">wasm32</span><span class="o">-</span><span class="n">wasip2</span><span class="w"> </span><span class="o">--</span><span class="n">sysroot</span><span class="o">=../</span><span class="n">sysroot</span><span class="w"> </span><span class="o">-</span><span class="n">Ibuild</span><span class="o">/</span><span class="n">download</span><span class="o">/</span><span class="n">libc</span><span class="o">-</span><span class="n">test</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">common</span><span class="w"> </span><span class="o">-</span><span class="n">g</span><span class="w"> </span><span class="o">-</span><span class="n">O0</span><span class="w"> </span><span class="o">-</span><span class="n">resource</span><span class="o">-</span><span class="n">dir</span><span class="w"> </span><span class="o">../</span><span class="n">build</span><span class="o">/</span><span class="n">wasm32</span><span class="o">-</span><span class="n">wasip2</span><span class="o">/</span><span class="n">resource</span><span class="o">-</span><span class="n">dir</span><span class="w"> </span><span class="o">-</span><span class="n">Wl</span><span class="p">,</span><span class="o">--</span><span class="n">skip</span><span class="o">-</span><span class="n">wit</span><span class="o">-</span><span class="n">component</span><span class="w">  </span><span class="n">build</span><span class="o">/</span><span class="n">wasm32</span><span class="o">-</span><span class="n">wasip2</span><span class="o">/</span><span class="n">misc</span><span class="o">/</span><span class="n">fadvise</span><span class="p">.</span><span class="n">wasm</span><span class="p">.</span><span class="n">o</span><span class="w"> </span><span class="n">build</span><span class="o">/</span><span class="n">wasm32</span><span class="o">-</span><span class="n">wasip2</span><span class="o">/</span><span class="n">common</span><span class="o">/</span><span class="n">path</span><span class="p">.</span><span class="n">wasm</span><span class="p">.</span><span class="n">o</span><span class="w"> </span><span class="n">build</span><span class="o">/</span><span class="n">wasm32</span><span class="o">-</span><span class="n">wasip2</span><span class="o">/</span><span class="n">common</span><span class="o">/</span><span class="n">print</span><span class="p">.</span><span class="n">wasm</span><span class="p">.</span><span class="n">o</span><span class="w"> </span><span class="n">build</span><span class="o">/</span><span class="n">wasm32</span><span class="o">-</span><span class="n">wasip2</span><span class="o">/</span><span class="n">common</span><span class="o">/</span><span class="n">rand</span><span class="p">.</span><span class="n">wasm</span><span class="p">.</span><span class="n">o</span><span class="w"> </span><span class="n">build</span><span class="o">/</span><span class="n">wasm32</span><span class="o">-</span><span class="n">wasip2</span><span class="o">/</span><span class="n">common</span><span class="o">/</span><span class="n">utf8</span><span class="p">.</span><span class="n">wasm</span><span class="p">.</span><span class="n">o</span><span class="w"> </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="n">build</span><span class="o">/</span><span class="n">wasm32</span><span class="o">-</span><span class="n">wasip2</span><span class="o">/</span><span class="n">misc</span><span class="o">/</span><span class="n">fadvise</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">wasm</span>
<span class="n">build</span><span class="o">/</span><span class="n">download</span><span class="o">/</span><span class="n">wasm</span><span class="o">-</span><span class="n">tools</span><span class="o">-</span><span class="mf">1.224.0</span><span class="o">-</span><span class="n">x86_64</span><span class="o">-</span><span class="n">linux</span><span class="o">/</span><span class="n">wasm</span><span class="o">-</span><span class="n">tools</span><span class="w"> </span><span class="n">component</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="o">--</span><span class="n">adapt</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">tjc</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">wasm32</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">unknown</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">wasi_snapshot_preview1</span><span class="p">.</span><span class="n">wasm</span><span class="w"> </span><span class="n">build</span><span class="o">/</span><span class="n">wasm32</span><span class="o">-</span><span class="n">wasip2</span><span class="o">/</span><span class="n">misc</span><span class="o">/</span><span class="n">fadvise</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">wasm</span><span class="w"> </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="n">build</span><span class="o">/</span><span class="n">wasm32</span><span class="o">-</span><span class="n">wasip2</span><span class="o">/</span><span class="n">misc</span><span class="o">/</span><span class="n">fadvise</span><span class="p">.</span><span class="n">component</span><span class="p">.</span><span class="n">wasm</span>
</code></pre></div>
<p>and then my lldb command is:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">lldb</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">tjc</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">wasmtime</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">-</span><span class="n">D</span><span class="w"> </span><span class="n">debug</span><span class="o">-</span><span class="n">info</span><span class="w"> </span><span class="o">-</span><span class="n">O</span><span class="w"> </span><span class="n">opt</span><span class="o">-</span><span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="w"> </span><span class="o">--</span><span class="n">wasm</span><span class="w"> </span><span class="n">component</span><span class="o">-</span><span class="n">model</span><span class="w"> </span><span class="o">--</span><span class="n">dir</span><span class="w"> </span><span class="n">fs</span><span class="p">::</span><span class="o">/</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">tjc</span><span class="o">/</span><span class="n">wasi</span><span class="o">-</span><span class="n">libc</span><span class="o">/</span><span class="n">test</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">wasm32</span><span class="o">-</span><span class="n">wasip2</span><span class="o">/</span><span class="n">misc</span><span class="o">/</span><span class="n">fadvise</span><span class="p">.</span><span class="n">component</span><span class="p">.</span><span class="n">wasm</span>
</code></pre></div>
<p>I would expect there to be debuginfo for <code>fd_advise</code> since I compiled both wasmtime and the wasi-preview1-component-adapter crate with debugging enabled. (For wasi-preview1-component-adapter, I used:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">cargo</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="n">wasi</span><span class="o">-</span><span class="n">preview1</span><span class="o">-</span><span class="n">component</span><span class="o">-</span><span class="n">adapter</span><span class="w"> </span><span class="o">--</span><span class="n">target</span><span class="w"> </span><span class="n">wasm32</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">unknown</span><span class="w"> </span><span class="o">--</span><span class="n">features</span><span class="w"> </span><span class="n">command</span><span class="w"> </span><span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">default</span><span class="o">-</span><span class="n">features</span>
</code></pre></div>
<p>Any suggestions? </p>
<p>Thanks,<br>
Tim</p>



<a name="532181594"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Debug%20info%20and%20wasi-preview1-component-adapter/near/532181594" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Debug.20info.20and.20wasi-preview1-component-adapter.html#532181594">(Jul 31 2025 at 22:48)</a>:</h4>
<p>Ah yes unfortunately this is expected. Way-back-when I figured "surely no one will want to gdb the adapter right?" and so everything was built assuming that it won't be necessary.</p>
<p>Specifically what happens is that as part of the componentization process the adapter is "GC'd" where unnecessary exports are pruned. That shuffles the code section (and deletes imports for example) which destroys all DWARF debug info. Nothing rewrites the DWARF info after the GC pass and either wit-component drops custom sections in the adapter entirely or doesn't bother to update them, resulting in either missing or broken DWARF.</p>
<p>In short, unfortunately this isn't possible, the adapter can't be debugged with lldb</p>



<a name="532181648"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Debug%20info%20and%20wasi-preview1-component-adapter/near/532181648" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Debug.20info.20and.20wasi-preview1-component-adapter.html#532181648">(Jul 31 2025 at 22:49)</a>:</h4>
<p>In the abstract I've found debugging the adapter to be extremely difficult historically as well. It's such a limited "language" in that you can't even use println or standard utilities like that</p>



<a name="532181799"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Debug%20info%20and%20wasi-preview1-component-adapter/near/532181799" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Debug.20info.20and.20wasi-preview1-component-adapter.html#532181799">(Jul 31 2025 at 22:50)</a>:</h4>
<p>One wild idea would be to avoid GC'ing the adapter entirely and instead just preserve everything. Such a flag of behavior in <code>wit-component</code> though (which is used as part of <code>wasm-component-ld</code> and <code>wasm-tools component new</code>) isn't yet implemented</p>



<a name="532183338"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Debug%20info%20and%20wasi-preview1-component-adapter/near/532183338" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Tim Chevalier <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Debug.20info.20and.20wasi-preview1-component-adapter.html#532183338">(Jul 31 2025 at 23:03)</a>:</h4>
<p>Thanks for the explanation! I'll try to figure out what kind of workaround I need.</p>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
<html>
<head><meta charset="utf-8"><title>Custom WASI LIBC · wasi · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/index.html">wasi</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Custom.20WASI.20LIBC.html">Custom WASI LIBC</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="565331420"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Custom%20WASI%20LIBC/near/565331420" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Axel Persinger <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Custom.20WASI.20LIBC.html#565331420">(Dec 25 2025 at 01:48)</a>:</h4>
<p>First off, sorry if this is the wrong place/format to ask this question, I'm new to Zulip.<br>
I'm looking to implement my own libc (my code runs in a special container environment that doesn't have access to the normal libc - so I can't use the regular WASI). I'm using <code>wasmtime</code> to run my WASM code, and I'm linking in (<code>wasmtime_linker_define_func</code>) my own functions by declaring them with the "<code>wasi_snapshot_preview1</code>" module and whatever name is being imported. For instance, I have <code>random_get</code> defined as:</p>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="n">wasm_trap_t</span><span class="o">*</span><span class="w"> </span><span class="nf">random_get</span><span class="p">(</span>
<span class="w">    </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">env</span><span class="p">,</span>
<span class="w">    </span><span class="n">wasmtime_caller_t</span><span class="o">*</span><span class="w"> </span><span class="n">caller</span><span class="p">,</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">wasmtime_val_t</span><span class="o">*</span><span class="w"> </span><span class="n">args</span><span class="p">,</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">nargs</span><span class="p">,</span>
<span class="w">    </span><span class="n">wasmtime_val_t</span><span class="o">*</span><span class="w"> </span><span class="n">results</span><span class="p">,</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">nresults</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">LOG_DEBUG</span><span class="p">(</span>
<span class="w">        </span><span class="s">"%s(%s, %p, %p, %zu, %p, %zu)"</span><span class="p">,</span>
<span class="w">        </span><span class="n">__FUNCTION__</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">caller</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">nargs</span><span class="p">,</span><span class="w"> </span><span class="n">results</span><span class="p">,</span><span class="w"> </span><span class="n">nresults</span><span class="p">);</span>

<span class="w">    </span><span class="n">LOG_DEBUG</span><span class="p">(</span><span class="s">"Arguments:"</span><span class="p">);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nargs</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">print_arg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">of</span><span class="p">.</span><span class="n">i32</span><span class="p">;</span>
<span class="w">    </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">of</span><span class="p">.</span><span class="n">i32</span><span class="p">;</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">wasmtime_context_t</span><span class="o">*</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_memory_t</span><span class="w"> </span><span class="n">memory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="n">wasmtime_extern_t</span><span class="w"> </span><span class="n">mem_extern</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">};</span>
<span class="w">    </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime_caller_context</span><span class="p">(</span><span class="n">caller</span><span class="p">);</span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">store</span><span class="p">);</span>

<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">wasmtime_caller_export_get</span><span class="p">(</span>
<span class="w">        </span><span class="n">caller</span><span class="p">,</span>
<span class="w">        </span><span class="s">"memory"</span><span class="p">,</span>
<span class="w">        </span><span class="k">sizeof</span><span class="p">(</span><span class="s">"memory"</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">        </span><span class="o">&amp;</span><span class="n">mem_extern</span><span class="p">));</span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">mem_extern</span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">WASMTIME_EXTERN_MEMORY</span><span class="p">);</span>

<span class="w">    </span><span class="n">memory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mem_extern</span><span class="p">.</span><span class="n">of</span><span class="p">.</span><span class="n">memory</span><span class="p">;</span>
<span class="w">    </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime_memory_data</span><span class="p">(</span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">memory</span><span class="p">);</span>
<span class="w">    </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime_memory_data_size</span><span class="p">(</span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">memory</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">buf</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nresults</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">kind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WASMTIME_I32</span><span class="p">;</span>
<span class="w">            </span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">of</span><span class="p">.</span><span class="n">i32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">len</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">data</span><span class="p">[</span><span class="n">buf</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="c1">// Pretend I'm not doing something naughty here!</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">LOG_DEBUG</span><span class="p">(</span><span class="s">"Results:"</span><span class="p">);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nresults</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">print_arg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>My issue is for more complicated functions like <code>clock_time_get</code>, I need the macros from WASI-libc (for instance <code>__WASI_CLOCKID_MONOTONIC</code>). But I'm not sure how to include the WASI header file properly because it complains to me that I need to build it with the WASI sys root (but I want to build it for x86!).</p>
<p>Any advice?</p>



<a name="565393647"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Custom%20WASI%20LIBC/near/565393647" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Custom.20WASI.20LIBC.html#565393647">(Dec 25 2025 at 22:21)</a>:</h4>
<p>The wasi-libc headers are only meant to be used from within the guest, not to be used on the host when implementing the wasi interfaces. For example it defines the <code>buf</code> field of <code>__wasi_iovec_t</code> as a pointer, when it is a 32bit index into the linear memory. You could copy paste and whatever you need and change it as necessary though. There won't be breaking changes to wasip1 (or any changes for that matter give that wasip2 and wasip3 now exist)</p>



<a name="565395790"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Custom%20WASI%20LIBC/near/565395790" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Axel Persinger <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Custom.20WASI.20LIBC.html#565395790">(Dec 25 2025 at 23:33)</a>:</h4>
<p>Okay, that makes sense. So is the only real way to implement this libc linked layer to just copy-paste the definitions between the <code>extern C</code> guards?</p>



<a name="566404873"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/Custom%20WASI%20LIBC/near/566404873" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/Custom.20WASI.20LIBC.html#566404873">(Jan 05 2026 at 17:24)</a>:</h4>
<p>bjorn3 is right yeah, you'll want to copy out these definitions for wasip1 if you want to use wasip1 APIs.</p>
<p>wasip1 is defined with <code>*.witx</code> which is the "formal" definition although the format itself never got fully specified. With components this is all formalized in <code>*.wit</code> with host and guest bindings generators which solves this problem</p>



<hr><p>Last updated: Feb 22 2026 at 11:05 UTC</p>
</html>
<html>
<head><meta charset="utf-8"><title>✔ Trampoline::{Future,Stream}{Read,Write} canon opts · wasi · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/index.html">wasi</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/.E2.9C.94.20Trampoline.3A.3A.7BFuture.2CStream.7D.7BRead.2CWrite.7D.20canon.20opts.html">✔ Trampoline::{Future,Stream}{Read,Write} canon opts</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="537525076"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/%E2%9C%94%20Trampoline%3A%3A%7BFuture%2CStream%7D%7BRead%2CWrite%7D%20canon%20opts/near/537525076" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Victor Adossi <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/.E2.9C.94.20Trampoline.3A.3A.7BFuture.2CStream.7D.7BRead.2CWrite.7D.20canon.20opts.html#537525076">(Sep 03 2025 at 17:33)</a>:</h4>
<p>Hey all, quick question -- it seems like <code>wasmtime_environ::Trampoline::StreamWrite</code> and friends have <code>async_</code> set in theircanon opts (via the <code>options: OptionsIndex</code> member). </p>
<p>I'm pulling the opts like this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span>
<span class="w">                    </span><span class="p">.</span><span class="n">component</span><span class="w"> </span><span class="c1">// &amp;wasmtime_environ::Component</span>
<span class="w">                    </span><span class="p">.</span><span class="n">options</span>
<span class="w">                    </span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="o">*</span><span class="n">options</span><span class="p">)</span>
<span class="w">                    </span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">"failed to find options"</span><span class="p">);</span>
</code></pre></div>
<p>When I get the <code>CanonicalOptions</code> object out, it's got <code>async_</code> set and no <code>callback</code> (which is invalid)</p>
<p>Intuitively, the canon functions are clearly not async, so I'm thinking the issue here is that <code>async_</code> is set on the <code>CanonicalOptions</code> that got created?</p>
<p>Alternatively, if I read this line in <a href="https://github.com/WebAssembly/component-model/blob/main/design/mvp/CanonicalABI.md#canonopt-validation">the canonopt validation section</a> a bit differently:</p>
<blockquote>
<ul>
<li><span aria-label="shuffle" class="emoji emoji-1f500" role="img" title="shuffle">:shuffle:</span> <code>callback</code> - the function has type <code>(func (param i32 i32 i32) (result i32))</code> and cannot be present without <code>async</code> and is only allowed with <a href="https://github.com/WebAssembly/component-model/blob/main/design/mvp/CanonicalABI.md#canon-lift"><code>canon lift</code></a></li>
</ul>
</blockquote>
<p>Maybe the intent was that it's fine for <code>async_</code> to be set, but <code>callback</code> <em>can</em> be missing (and I should basically only check that <em>non</em>-async things don't have a callback, not that all async things <em>must</em> have a callback).</p>
<p>Obviously during <code>canon_lift</code> the callback is quite required, but the canon function is a little blurrier...</p>
<p>I'm leaning towards the idea that the <code>CanonicalOptions</code> being set/saved for the relevant <code>Trampoline::</code> members should not have <code>async_</code> set in the first place.</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/WebAssembly/component-model/blob/main/design/mvp/CanonicalABI.md#canonopt-validation" style="background-image: url(&quot;https://uploads.zulipusercontent.net/7fc6da16cfa7069274d3b7aa350dd0ae4d436425/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f613030376431356539666433613636306135336131613834313366323166363731383864383261306535313966303131366663323565356366623432323964632f576562417373656d626c792f636f6d706f6e656e742d6d6f64656c&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/WebAssembly/component-model/blob/main/design/mvp/CanonicalABI.md#canonopt-validation" title="component-model/design/mvp/CanonicalABI.md at main · WebAssembly/component-model">component-model/design/mvp/CanonicalABI.md at main · WebAssembly/component-model</a></div><div class="message_embed_description">Repository for design and specification of the Component Model - WebAssembly/component-model</div></div></div>



<a name="537526179"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/%E2%9C%94%20Trampoline%3A%3A%7BFuture%2CStream%7D%7BRead%2CWrite%7D%20canon%20opts/near/537526179" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/.E2.9C.94.20Trampoline.3A.3A.7BFuture.2CStream.7D.7BRead.2CWrite.7D.20canon.20opts.html#537526179">(Sep 03 2025 at 17:39)</a>:</h4>
<p>ah yeah this is where each option is a bit overloaded in the context of each intrinsic</p>



<a name="537526218"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/%E2%9C%94%20Trampoline%3A%3A%7BFuture%2CStream%7D%7BRead%2CWrite%7D%20canon%20opts/near/537526218" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/.E2.9C.94.20Trampoline.3A.3A.7BFuture.2CStream.7D.7BRead.2CWrite.7D.20canon.20opts.html#537526218">(Sep 03 2025 at 17:40)</a>:</h4>
<p>but <code>async_</code> means whether these intrinsics are blocking or not basically for stream/future read/write</p>



<a name="537526265"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/%E2%9C%94%20Trampoline%3A%3A%7BFuture%2CStream%7D%7BRead%2CWrite%7D%20canon%20opts/near/537526265" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/.E2.9C.94.20Trampoline.3A.3A.7BFuture.2CStream.7D.7BRead.2CWrite.7D.20canon.20opts.html#537526265">(Sep 03 2025 at 17:40)</a>:</h4>
<p>and the validation is different from <code>canon lift</code>'d functions for now (in the future though we might allow just-<code>async_</code> on functions)</p>



<a name="537526277"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/%E2%9C%94%20Trampoline%3A%3A%7BFuture%2CStream%7D%7BRead%2CWrite%7D%20canon%20opts/near/537526277" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Victor Adossi <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/.E2.9C.94.20Trampoline.3A.3A.7BFuture.2CStream.7D.7BRead.2CWrite.7D.20canon.20opts.html#537526277">(Sep 03 2025 at 17:40)</a>:</h4>
<p>Ah OK, I thought that <em>might</em> be the case -- that somehow <code>async_</code> meant something different in this context</p>



<a name="537526361"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/%E2%9C%94%20Trampoline%3A%3A%7BFuture%2CStream%7D%7BRead%2CWrite%7D%20canon%20opts/near/537526361" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Victor Adossi <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/.E2.9C.94.20Trampoline.3A.3A.7BFuture.2CStream.7D.7BRead.2CWrite.7D.20canon.20opts.html#537526361">(Sep 03 2025 at 17:41)</a>:</h4>
<p>OK, great, I've got that implemented -- I just disabled that last check for <code>stream.write</code>/etc and kept all the other ones on</p>



<a name="537526426"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/%E2%9C%94%20Trampoline%3A%3A%7BFuture%2CStream%7D%7BRead%2CWrite%7D%20canon%20opts/near/537526426" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/.E2.9C.94.20Trampoline.3A.3A.7BFuture.2CStream.7D.7BRead.2CWrite.7D.20canon.20opts.html#537526426">(Sep 03 2025 at 17:41)</a>:</h4>
<p>FWIW you can skip all the validation bits in jco b/c wasmparser/wasmtime-environ do all that for you</p>



<a name="537526532"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/%E2%9C%94%20Trampoline%3A%3A%7BFuture%2CStream%7D%7BRead%2CWrite%7D%20canon%20opts/near/537526532" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Victor Adossi <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/.E2.9C.94.20Trampoline.3A.3A.7BFuture.2CStream.7D.7BRead.2CWrite.7D.20canon.20opts.html#537526532">(Sep 03 2025 at 17:42)</a>:</h4>
<p>Even better, I'll do that!</p>



<a name="537526777"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/%E2%9C%94%20Trampoline%3A%3A%7BFuture%2CStream%7D%7BRead%2CWrite%7D%20canon%20opts/near/537526777" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Victor Adossi <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/.E2.9C.94.20Trampoline.3A.3A.7BFuture.2CStream.7D.7BRead.2CWrite.7D.20canon.20opts.html#537526777">(Sep 03 2025 at 17:44)</a>:</h4>
<p>Thanks for the help! I think this makes sense now</p>



<a name="537526786"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/219900-wasi/topic/%E2%9C%94%20Trampoline%3A%3A%7BFuture%2CStream%7D%7BRead%2CWrite%7D%20canon%20opts/near/537526786" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/219900-wasi/topic/.E2.9C.94.20Trampoline.3A.3A.7BFuture.2CStream.7D.7BRead.2CWrite.7D.20canon.20opts.html#537526786">(Sep 03 2025 at 17:44)</a>:</h4>
<p><span class="user-mention silent" data-user-id="598440">Victor Adossi</span> has marked this topic as resolved.</p>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
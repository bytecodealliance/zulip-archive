<html>
<head><meta charset="utf-8"><title>wit-bindgen async/future · C#/.net-collaboration · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/index.html">C#/.net-collaboration</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html">wit-bindgen async/future</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="529702573"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/529702573" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#529702573">(Jul 20 2025 at 17:37)</a>:</h4>
<p>Hi, is it too early to start adding support for async and future in the c# code gen ?  I see there are tests already in the main branch?</p>



<a name="529711960"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/529711960" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#529711960">(Jul 20 2025 at 20:45)</a>:</h4>
<p>No, not too early -- now is a great time to get started.  I was planning to work on it myself but haven't had a chance yet.  Happy to answer any ABI-related questions if you're ready to take a stab at it.</p>



<a name="529912473"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/529912473" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#529912473">(Jul 21 2025 at 15:14)</a>:</h4>
<p>Thanks I'll make a start.</p>



<a name="530246069"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/530246069" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#530246069">(Jul 23 2025 at 01:04)</a>:</h4>
<p><span class="user-mention" data-user-id="509936">@Joel Dice</span> hi, might take me a few questions to get in the right space with this.  For <br>
<a href="https://github.com/bytecodealliance/wit-bindgen/blob/454d6885b5b54adb3601a9b80ca9ff64f6ed7b8d/tests/codegen/futures.wit#L6">https://github.com/bytecodealliance/wit-bindgen/blob/454d6885b5b54adb3601a9b80ca9ff64f6ed7b8d/tests/codegen/futures.wit#L6</a><br>
We have a function that takes a future as a parameter.  The import of this function sounds like it will in c#, take a <code>Task</code> and lower it to an i32.  But what can the receiver of this <code>i32</code> do with it?  I would expect that it could await the future, but how would it do that?</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wit-bindgen/blob/454d6885b5b54adb3601a9b80ca9ff64f6ed7b8d/tests/codegen/futures.wit#L6" style="background-image: url(&quot;https://uploads.zulipusercontent.net/5d72386f0a8b57f97c674ad0b67fa6da7778b551/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f396163653961306337313835616239626564663338653030393039396439613432376465393362323535343839323364393232336130303530393565366337322f62797465636f6465616c6c69616e63652f7769742d62696e6467656e&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wit-bindgen/blob/454d6885b5b54adb3601a9b80ca9ff64f6ed7b8d/tests/codegen/futures.wit#L6" title="wit-bindgen/tests/codegen/futures.wit at 454d6885b5b54adb3601a9b80ca9ff64f6ed7b8d · bytecodealliance/wit-bindgen">wit-bindgen/tests/codegen/futures.wit at 454d6885b5b54adb3601a9b80ca9ff64f6ed7b8d · bytecodealliance/wit-bindgen</a></div><div class="message_embed_description">A language binding generator for WebAssembly interface types - bytecodealliance/wit-bindgen</div></div></div>



<a name="530250399"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/530250399" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#530250399">(Jul 23 2025 at 02:06)</a>:</h4>
<p>For this single import I think I also need to provide a couple of extra functions , waitable-set-wait, that I must call before the calling the import, and provide a future-poll that the runtime can call to check the state of the future, is that sort of right?</p>



<a name="530666615"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/530666615" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#530666615">(Jul 25 2025 at 00:00)</a>:</h4>
<p>Think I've confused <code>future</code> and <code>async</code>  I will start with just <code>async</code> as that looks simpler</p>



<a name="530792807"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/530792807" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#530792807">(Jul 25 2025 at 14:54)</a>:</h4>
<p>Sorry for the late reply -- I was out on vacation for a few days.</p>
<p>To call an imported function that takes a <code>future</code>, the guest needs to first call <code>future.new</code>, which returns a pair of <code>i32</code> handles -- one representing the writable end (roughly equivalent to a <code>TaskCompletionSource</code>) and the other representing the readable end (roughly equivalent to the <code>Task</code> corresponding to the <code>TaskCompletionSource</code>).  Then it can pass the readable end to the function and later write a value to the writable end when such a value is available.</p>
<p>In the Rust bindings, we represent the writable end as a <a href="https://github.com/bytecodealliance/wit-bindgen/blob/454d6885b5b54adb3601a9b80ca9ff64f6ed7b8d/crates/guest-rust/rt/src/async_support/future_support.rs#L208">FutureWriter</a> and the readable end as a <a href="https://github.com/bytecodealliance/wit-bindgen/blob/454d6885b5b54adb3601a9b80ca9ff64f6ed7b8d/crates/guest-rust/rt/src/async_support/future_support.rs#L535">FutureReader</a>, which implements the <code>std::future::Future</code> trait, allowing it to be <code>await</code>ed.</p>
<p>Anyway, I agree that you'll probably want to start with just supporting the async import and export ABIs before moving on to <code>future</code> and <code>stream</code> support.  Note that a call to an async-lowered import will either return a result immediately or return <code>BLOCKED</code> with a subtask handle representing the status of the call.  That handle may be added to a <code>waitable-set</code>, which in turn may be waited on using either <code>waitable-set.wait</code> or by returning <code>CALLBACK_CODE_WAIT</code> from the async-lifted-with-callback export function that the host originally called the guest on.  The latter is generally preferable when using the callback-based ABI, since it allows the host to make other concurrent calls to the guest.</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wit-bindgen/blob/454d6885b5b54adb3601a9b80ca9ff64f6ed7b8d/crates/guest-rust/rt/src/async_support/future_support.rs#L208" style="background-image: url(&quot;https://uploads.zulipusercontent.net/5d72386f0a8b57f97c674ad0b67fa6da7778b551/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f396163653961306337313835616239626564663338653030393039396439613432376465393362323535343839323364393232336130303530393565366337322f62797465636f6465616c6c69616e63652f7769742d62696e6467656e&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wit-bindgen/blob/454d6885b5b54adb3601a9b80ca9ff64f6ed7b8d/crates/guest-rust/rt/src/async_support/future_support.rs#L208" title="wit-bindgen/crates/guest-rust/rt/src/async_support/future_support.rs at 454d6885b5b54adb3601a9b80ca9ff64f6ed7b8d · bytecodealliance/wit-bindgen">wit-bindgen/crates/guest-rust/rt/src/async_support/future_support.rs at 454d6885b5b54adb3601a9b80ca9ff64f6ed7b8d · bytecodealliance/wit-bindgen</a></div><div class="message_embed_description">A language binding generator for WebAssembly interface types - bytecodealliance/wit-bindgen</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wit-bindgen/blob/454d6885b5b54adb3601a9b80ca9ff64f6ed7b8d/crates/guest-rust/rt/src/async_support/future_support.rs#L535" style="background-image: url(&quot;https://uploads.zulipusercontent.net/5d72386f0a8b57f97c674ad0b67fa6da7778b551/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f396163653961306337313835616239626564663338653030393039396439613432376465393362323535343839323364393232336130303530393565366337322f62797465636f6465616c6c69616e63652f7769742d62696e6467656e&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wit-bindgen/blob/454d6885b5b54adb3601a9b80ca9ff64f6ed7b8d/crates/guest-rust/rt/src/async_support/future_support.rs#L535" title="wit-bindgen/crates/guest-rust/rt/src/async_support/future_support.rs at 454d6885b5b54adb3601a9b80ca9ff64f6ed7b8d · bytecodealliance/wit-bindgen">wit-bindgen/crates/guest-rust/rt/src/async_support/future_support.rs at 454d6885b5b54adb3601a9b80ca9ff64f6ed7b8d · bytecodealliance/wit-bindgen</a></div><div class="message_embed_description">A language binding generator for WebAssembly interface types - bytecodealliance/wit-bindgen</div></div></div>



<a name="530865850"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/530865850" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#530865850">(Jul 25 2025 at 23:49)</a>:</h4>
<p>For every async function we generate a <code>[async-lift]....</code> and a <code>[callback][async-lift]</code> for those 2 scenarios you describe ?</p>



<a name="530866140"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/530866140" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#530866140">(Jul 25 2025 at 23:52)</a>:</h4>
<p>on the export side I'm looking at first</p>



<a name="530920327"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/530920327" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#530920327">(Jul 26 2025 at 09:28)</a>:</h4>
<p>Yes, and the signature of the <code>[async-lift]...</code> function will take the same set of parameters the sync version would, but return an <code>i32</code> representing the "callback code".  The <code>[callback][async-lift]...</code> function will take 3 <code>i32</code> parameters (the first is the event type, and the meaning of the rest depends on the event type) and return an <code>i32</code> callback code.  Either the <code>[async-lift]...</code> or the <code>[callback][async-lift]...</code> function will return its value to the caller by calling the <code>task.return</code> function, whose signature depends on the WIT-level return type of the function being exported.</p>
<p>One way to get a feel for all this is to examine the output of the C bindings generator for various async-lifted exports.</p>



<a name="530946288"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/530946288" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#530946288">(Jul 26 2025 at 13:21)</a>:</h4>
<p>Thanks very much, I should be able to get the first tests passing from here.</p>



<a name="530990707"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/530990707" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#530990707">(Jul 26 2025 at 19:20)</a>:</h4>
<p>are you using a locally built clang to get support for <code>async</code> in wit ?</p>



<a name="530990779"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/530990779" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#530990779">(Jul 26 2025 at 19:20)</a>:</h4>
<p>Ive got</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">C</span><span class="p">:</span><span class="err">\</span><span class="n">github</span><span class="err">\</span><span class="n">wit</span><span class="o">-</span><span class="n">bindgen</span><span class="err">\</span><span class="n">target</span><span class="err">\</span><span class="n">artifacts</span><span class="err">\</span><span class="n">simple</span><span class="o">-</span><span class="n">import</span><span class="o">-</span><span class="n">params</span><span class="o">-</span><span class="n">results</span><span class="err">\</span><span class="n">test</span><span class="o">-</span><span class="n">csharp</span><span class="err">\</span><span class="n">bindings</span><span class="o">&gt;</span><span class="s">"c:\github\wasi-sdk25/bin/clang"</span><span class="w"> </span><span class="o">@</span><span class="n">obj</span><span class="err">\</span><span class="n">Debug</span><span class="err">\</span><span class="n">net9</span><span class="p">.</span><span class="mi">0</span><span class="err">\</span><span class="n">wasi</span><span class="o">-</span><span class="n">wasm</span><span class="err">\</span><span class="n">native</span><span class="err">\</span><span class="n">link</span><span class="p">.</span><span class="n">rsp</span><span class="w"> </span><span class="s">"</span>
<span class="s">error: unable to add component type "</span><span class="n">TestWorld_component_type</span><span class="p">.</span><span class="n">wit</span><span class="s">"</span>

<span class="s">Caused by:</span>
<span class="s">    0: expected keyword `func`, found an identifier</span>
<span class="s">            --&gt; TestWorld_component_type.wit:4:17</span>
<span class="s">             |</span>
<span class="s">           4 |   one-argument: async func(x: u32);</span>
<span class="s">             |                 ^</span>
<span class="s">clang: error: linker command failed with exit code 1 (use -v to see invocation)</span>
</code></pre></div>



<a name="530991699"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/530991699" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#530991699">(Jul 26 2025 at 19:28)</a>:</h4>
<p>I believe clang is calling <code>wasm-component-ld</code>, which is producing that error.  WASI-SDK's version of <code>wasm-component-ld</code> isn't new enough to understand async, so you'll want to replace the one in WASI-SDK with <a href="https://github.com/bytecodealliance/wasm-component-ld/releases/tag/v0.5.15">the latest release</a> (which isn't using the very latest wasm-tools, but it's only one version behind, so should be new enough).</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasm-component-ld/releases/tag/v0.5.15" style="background-image: url(&quot;https://uploads.zulipusercontent.net/71ec5ddeb036b8a411e4a855bea90be9892fcc01/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f646163366639663663386166613937316461663934393935333730353331356461396138346131306663363561386664333534333735616262383961303135322f62797465636f6465616c6c69616e63652f7761736d2d636f6d706f6e656e742d6c642f72656c65617365732f7461672f76302e352e3135&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasm-component-ld/releases/tag/v0.5.15" title="Release v0.5.15 · bytecodealliance/wasm-component-ld">Release v0.5.15 · bytecodealliance/wasm-component-ld</a></div><div class="message_embed_description">Command line linker for creating WebAssembly components - Release v0.5.15 · bytecodealliance/wasm-component-ld</div></div></div>



<a name="530991887"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/530991887" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#530991887">(Jul 26 2025 at 19:29)</a>:</h4>
<p>I've been using <code>wasm-tools</code> directly to convert modules to components and/or embed component type custom sections, so I haven't tried using <code>wasm-component-ld</code> yet -- hopefully it should just work.</p>



<a name="530991946"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/530991946" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#530991946">(Jul 26 2025 at 19:30)</a>:</h4>
<p>lets see :-)</p>



<a name="530995760"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/530995760" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#530995760">(Jul 26 2025 at 20:01)</a>:</h4>
<p>that links at least.  What is the significance of <code>[export]</code> in this c<br>
__attribute__((__import_module__("[export]a:b/i"), __import_name__("[task-return][async]one-argument")))</p>



<a name="530996303"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/530996303" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#530996303">(Jul 26 2025 at 20:06)</a>:</h4>
<p>I understand that this is the callback (task-return) for returning the async result, so it needs some specially handling by the linker I guess.</p>



<a name="530998450"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/530998450" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#530998450">(Jul 26 2025 at 20:24)</a>:</h4>
<p>yeah, that's just the convention we made up and which <code>wit-component</code> recognizes as the import module to expect the task-return function to be imported from.  We use the <code>[export]</code> prefix to indicate that, although this is an import, we're doing the import on behalf of a specific exported function.</p>



<a name="531046891"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/531046891" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#531046891">(Jul 27 2025 at 02:50)</a>:</h4>
<p>thanks, this can all wait until Monday, I'm just asking today.  I have this error</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">------</span><span class="w"> </span><span class="n">Failure</span><span class="p">:</span><span class="w"> </span><span class="nc">simple</span><span class="o">-</span><span class="n">import</span><span class="o">-</span><span class="n">params</span><span class="o">-</span><span class="n">results</span><span class="w"> </span><span class="o">--------</span>
<span class="w">  </span><span class="n">component</span><span class="p">:</span><span class="w"> </span><span class="nc">test</span>
<span class="w">  </span><span class="n">path</span><span class="p">:</span><span class="w"> </span><span class="nc">tests</span><span class="err">\</span><span class="n">runtime</span><span class="o">-</span><span class="k">async</span><span class="err">\</span><span class="k">async</span><span class="err">\</span><span class="n">simple</span><span class="o">-</span><span class="n">import</span><span class="o">-</span><span class="n">params</span><span class="o">-</span><span class="n">results</span><span class="err">\</span><span class="n">test</span><span class="p">.</span><span class="n">cs</span>
<span class="w">  </span><span class="n">error</span><span class="p">:</span><span class="w"> </span><span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">component</span><span class="w"> </span><span class="s">"tests</span><span class="se">\\</span><span class="s">runtime-async</span><span class="se">\\</span><span class="s">async</span><span class="se">\\</span><span class="s">simple-import-params-results</span><span class="se">\\</span><span class="s">test.cs"</span>

<span class="w">  </span><span class="n">Caused</span><span class="w"> </span><span class="n">by</span><span class="p">:</span>
<span class="w">      </span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="nc">compiler</span><span class="w"> </span><span class="n">produced</span><span class="w"> </span><span class="n">invalid</span><span class="w"> </span><span class="n">wasm</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="s">"C:</span><span class="se">\\</span><span class="s">github</span><span class="se">\\</span><span class="s">wit-bindgen</span><span class="se">\\</span><span class="s">.</span><span class="se">\\</span><span class="s">target</span><span class="se">\\</span><span class="s">artifacts</span><span class="se">\\</span><span class="s">simple-import-params-results</span><span class="se">\\</span><span class="s">test-csharp.wasm"</span>
<span class="w">      </span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="nc">lowered</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="n">types</span><span class="w"> </span><span class="err">`</span><span class="p">[]</span><span class="err">`</span><span class="w"> </span><span class="kr">do</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="n">types</span><span class="w"> </span><span class="err">`</span><span class="p">[</span><span class="n">I32</span><span class="p">]</span><span class="err">`</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">core</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="mi">140</span><span class="w"> </span><span class="p">(</span><span class="n">at</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="mh">0xfdd769</span><span class="p">)</span>
<span class="mi">1</span><span class="w"> </span><span class="n">tests</span><span class="w"> </span><span class="n">FAILED</span>
</code></pre></div>
<p>Which seems like I've got the <code>[async-lower]</code> or <code>[async-lift]</code> wrong, but they are both <code>int32 (int32)</code> for a <code>void</code> async that takes an <code>int32</code> which I think is right and the same as the c code gen.  Is there any modification of signatures that goes on <code>wasm-component-ld</code> or <code>wasmtime</code> ?</p>



<a name="531183329"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/531183329" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#531183329">(Jul 27 2025 at 17:49)</a>:</h4>
<p>its a bit weird becuse function 140 is unrelatead</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">   </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="cp">$</span><span class="s">"Thread::ResetCachedTransitionFrame()"</span><span class="w"> </span><span class="p">(;</span><span class="mi">140</span><span class="p">;)</span><span class="w"> </span><span class="p">(</span><span class="k">type</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">param</span><span class="w"> </span><span class="kt">i32</span><span class="p">)</span>
</code></pre></div>



<a name="531218892"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/531218892" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#531218892">(Jul 27 2025 at 21:49)</a>:</h4>
<p>oh, Im reading the <code>alias</code> wrong, but I still don't understand how this works.  The core function for this needs to return the callback code so it will have a result type of <code>i32</code>.  Is it the <code>canon lift</code> on the alias that is incorrect perhaps</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">(</span><span class="k">type</span><span class="w"> </span><span class="p">(;</span><span class="mi">49</span><span class="p">;)</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="p">(</span><span class="n">param</span><span class="w"> </span><span class="s">"x"</span><span class="w"> </span><span class="kt">u32</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="n">alias</span><span class="w"> </span><span class="n">core</span><span class="w"> </span><span class="n">export</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="s">"[async-lift]a:b/i#[async]one-argument"</span><span class="w"> </span><span class="p">(</span><span class="n">core</span><span class="w"> </span><span class="n">func</span><span class="w"> </span><span class="p">(;</span><span class="mi">140</span><span class="p">;)))</span>
<span class="w">  </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="p">(;</span><span class="mi">41</span><span class="p">;)</span><span class="w"> </span><span class="p">(</span><span class="k">type</span><span class="w"> </span><span class="mi">49</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">canon</span><span class="w"> </span><span class="n">lift</span><span class="w"> </span><span class="p">(</span><span class="n">core</span><span class="w"> </span><span class="n">func</span><span class="w"> </span><span class="mi">140</span><span class="p">)</span><span class="w"> </span><span class="k">async</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">component</span><span class="w"> </span><span class="p">(;</span><span class="mi">0</span><span class="p">;)</span>
<span class="w">    </span><span class="p">(</span><span class="k">type</span><span class="w"> </span><span class="p">(;</span><span class="mi">0</span><span class="p">;)</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="p">(</span><span class="n">param</span><span class="w"> </span><span class="s">"x"</span><span class="w"> </span><span class="kt">u32</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="n">import</span><span class="w"> </span><span class="s">"import-func-one-argument"</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="p">(;</span><span class="mi">0</span><span class="p">;)</span><span class="w"> </span><span class="p">(</span><span class="k">type</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">type</span><span class="w"> </span><span class="p">(;</span><span class="mi">1</span><span class="p">;)</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="p">(</span><span class="n">param</span><span class="w"> </span><span class="s">"x"</span><span class="w"> </span><span class="kt">u32</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="n">export</span><span class="w"> </span><span class="p">(;</span><span class="mi">1</span><span class="p">;)</span><span class="w"> </span><span class="s">"[async]one-argument"</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="p">(</span><span class="k">type</span><span class="w"> </span><span class="mi">1</span><span class="p">)))</span>
<span class="w">  </span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">instance</span><span class="w"> </span><span class="p">(;</span><span class="mi">20</span><span class="p">;)</span><span class="w"> </span><span class="p">(</span><span class="n">instantiate</span><span class="w"> </span><span class="mi">0</span>
<span class="w">      </span><span class="p">(</span><span class="n">with</span><span class="w"> </span><span class="s">"import-func-one-argument"</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="mi">41</span><span class="p">))</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">  </span><span class="p">)</span>
</code></pre></div>



<a name="531224126"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/531224126" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#531224126">(Jul 27 2025 at 22:25)</a>:</h4>
<p>I' m going to dig further into wasm-component-ld as I suspect something there currently.  I'm probably wrong, but need to see if what you do , generating the sections manually, fixes things</p>



<a name="531378514"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/531378514" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#531378514">(Jul 28 2025 at 14:00)</a>:</h4>
<p>If you can point me to a branch with your changes and instructions for reproducing the issue, I can take a look.</p>



<a name="531382851"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/531382851" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#531382851">(Jul 28 2025 at 14:18)</a>:</h4>
<p>Thanks very much, I wonder if its because I've got 2 wits in the link, haven't investigated that yet.<br>
<a href="https://github.com/yowl/cs-wit-bindgen/tree/csharp-async-simple">https://github.com/yowl/cs-wit-bindgen/tree/csharp-async-simple</a></p>
<p>Download wasi sdk 25 and replace wasm-component-ld, Im using a locally built one from main yesterday.<br>
Then <code>cargo build</code><br>
and  </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="o">--</span><span class="n">languages</span><span class="w"> </span><span class="n">csharp</span><span class="w"> </span><span class="n">tests</span><span class="err">\</span><span class="n">runtime</span><span class="o">-</span><span class="k">async</span><span class="w"> </span><span class="o">--</span><span class="n">artifacts</span><span class="w"> </span><span class="p">.</span><span class="err">\</span><span class="n">target</span><span class="err">\</span><span class="n">artifacts</span><span class="w"> </span><span class="o">--</span><span class="n">rust</span><span class="o">-</span><span class="n">wit</span><span class="o">-</span><span class="n">bindgen</span><span class="o">-</span><span class="n">path</span><span class="w"> </span><span class="p">.</span><span class="err">\</span><span class="n">crates</span><span class="err">\</span><span class="n">guest</span><span class="o">-</span><span class="n">rust</span><span class="w"> </span><span class="o">--</span><span class="n">runner</span><span class="w"> </span><span class="s">"wasmtime -W component-model-async"</span>
</code></pre></div>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/yowl/cs-wit-bindgen/tree/csharp-async-simple" style="background-image: url(&quot;https://uploads.zulipusercontent.net/938da4ff5fbc0b4206866958751d15811846828f/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f396337373635363035343461666431323461306331653065633331616262626234363632336336356333636432353431366534623738646331633837343033372f796f776c2f63732d7769742d62696e6467656e&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/yowl/cs-wit-bindgen/tree/csharp-async-simple" title="GitHub - yowl/cs-wit-bindgen at csharp-async-simple">GitHub - yowl/cs-wit-bindgen at csharp-async-simple</a></div><div class="message_embed_description">Testing wit-bindgen for c# and NativeAOT-LLVM. Contribute to yowl/cs-wit-bindgen development by creating an account on GitHub.</div></div></div>



<a name="531383051"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/531383051" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#531383051">(Jul 28 2025 at 14:19)</a>:</h4>
<p>Thanks.  I've got a bunch of meetings this morning, but I'll dig in later today.</p>



<a name="531383127"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/531383127" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#531383127">(Jul 28 2025 at 14:19)</a>:</h4>
<p>I'm not totally stuck yet, I can do more research later if you have better things to do.</p>



<a name="531430533"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/531430533" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#531430533">(Jul 28 2025 at 18:15)</a>:</h4>
<p>Okay, I reproduced this on my end.  It looks like <code>wit-component</code> is getting confused and generating an async lift <em>without</em> a callback because the core module is not exporting a callback function.  It <em>should</em> be rejecting the module when it sees that you're using the with-callback ABI but not providing a callback, but instead it produces a component that fails validation.  I'll fix the <code>wit-component</code> issue so we can catch the problem there (and hopefully provide a clearer diagnostic).</p>
<p>Meanwhile, maybe you can dig into why the generated C# code is not exporting a callback function.</p>



<a name="531430855"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/531430855" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#531430855">(Jul 28 2025 at 18:17)</a>:</h4>
<p>Ah thanks, right, I haven't implemented that bit yet as I don't think it will be on the call path yet.  But definitely I need to do it, so might as well be now</p>



<a name="531618822"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/531618822" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#531618822">(Jul 29 2025 at 14:03)</a>:</h4>
<p>Great, that seesm to be passing the first test.  Thanks very much.</p>



<a name="531965009"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/531965009" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#531965009">(Jul 31 2025 at 02:11)</a>:</h4>
<p>WIth an async function that returns a value, not void, I understand that it takes an extra pointer parameter is passed .  How does that relate to the <code>task-return</code> or the pointer is nothing to do with the return value, but is just used by the runtime?  What should this pointer  point to ?</p>



<a name="532080217"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/532080217" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#532080217">(Jul 31 2025 at 13:50)</a>:</h4>
<p>Are you referring to the async <em>lower</em> ABI?  If so, yes, the core signature of an async lowered function will include an extra parameter if the component-level signature returns a value, and that must point to an allocation in linear memory which is aligned and sized correctly for the result to be stored.  <code>task-return</code> isn't relevant here because we're talking about lowering imports, not lifting exports.</p>
<p>The async <em>lift</em> ABI has no such result pointer parameter, since <code>task-return</code> is used to return the result, if any.  The main thing to keep in mind is that the lift and lower ABIs are different.</p>



<a name="532157031"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/532157031" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#532157031">(Jul 31 2025 at 19:56)</a>:</h4>
<p>Thank you!</p>



<a name="532390208"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/532390208" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#532390208">(Aug 01 2025 at 23:01)</a>:</h4>
<p>I see the codegen tests use the <code>waitable-...</code> way of returning , is the <code>[task-return]</code>flow well tested ?</p>



<a name="532395278"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/532395278" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#532395278">(Aug 02 2025 at 00:05)</a>:</h4>
<p>ignore that, I see the c tests use it.</p>



<a name="534720917"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/534720917" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#534720917">(Aug 15 2025 at 22:43)</a>:</h4>
<p>I have a question about the c test for simple-future.  There are 2 functions in the wit<br>
<a href="https://github.com/bytecodealliance/wit-bindgen/blob/eaf42f6c12d9cca8231d5a361d20b6c21c2a2739/tests/runtime-async/async/simple-future/test.wit#L4-L5">https://github.com/bytecodealliance/wit-bindgen/blob/eaf42f6c12d9cca8231d5a361d20b6c21c2a2739/tests/runtime-async/async/simple-future/test.wit#L4-L5</a><br>
Looking at the test for <code>drop-future</code> where it writes to the writer:<br>
<a href="https://github.com/bytecodealliance/wit-bindgen/blob/eaf42f6c12d9cca8231d5a361d20b6c21c2a2739/tests/runtime-async/async/simple-future/runner.c#L34">https://github.com/bytecodealliance/wit-bindgen/blob/eaf42f6c12d9cca8231d5a361d20b6c21c2a2739/tests/runtime-async/async/simple-future/runner.c#L34</a><br>
It calls <code>test_future_void_write</code> which is generated as </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">runner_waitable_status_t</span><span class="w"> </span><span class="n">test_future_void_write</span><span class="p">(</span><span class="n">test_future_void_writer_t</span><span class="w"> </span><span class="n">writer</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">test_future_void__write</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span><span class="w"> </span><span class="n">NULL</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>which in turn calls <code>test_future_void__write</code> defined as </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">__attribute__</span><span class="p">((</span><span class="n">__import_module__</span><span class="p">(</span><span class="s">"my:test/i"</span><span class="p">),</span><span class="w"> </span><span class="n">__import_name__</span><span class="p">(</span><span class="s">"[async-lower][future-write-0][async]read-future"</span><span class="p">)))</span>
<span class="k">extern</span><span class="w"> </span><span class="n">uint32_t</span><span class="w"> </span><span class="n">test_future_void__write</span><span class="p">(</span><span class="n">uint32_t</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">uint8_t</span><span class="o">*</span><span class="p">);</span>
</code></pre></div>
<p>Which has the import name for the <code>read-future</code> function.  What am I missing here?</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wit-bindgen/blob/eaf42f6c12d9cca8231d5a361d20b6c21c2a2739/tests/runtime-async/async/simple-future/test.wit#L4-L5" style="background-image: url(&quot;https://uploads.zulipusercontent.net/50cd0505ad3a8575e79246c21a37b2737823449e/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f396633643162306531386134363863376234383163343734366363616634323461333366353336613261393134626430613836376139316365353664373734362f62797465636f6465616c6c69616e63652f7769742d62696e6467656e&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wit-bindgen/blob/eaf42f6c12d9cca8231d5a361d20b6c21c2a2739/tests/runtime-async/async/simple-future/test.wit#L4-L5" title="wit-bindgen/tests/runtime-async/async/simple-future/test.wit at eaf42f6c12d9cca8231d5a361d20b6c21c2a2739 · bytecodealliance/wit-bindgen">wit-bindgen/tests/runtime-async/async/simple-future/test.wit at eaf42f6c12d9cca8231d5a361d20b6c21c2a2739 · bytecodealliance/wit-bindgen</a></div><div class="message_embed_description">A language binding generator for WebAssembly interface types - bytecodealliance/wit-bindgen</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wit-bindgen/blob/eaf42f6c12d9cca8231d5a361d20b6c21c2a2739/tests/runtime-async/async/simple-future/runner.c#L34" style="background-image: url(&quot;https://uploads.zulipusercontent.net/50cd0505ad3a8575e79246c21a37b2737823449e/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f396633643162306531386134363863376234383163343734366363616634323461333366353336613261393134626430613836376139316365353664373734362f62797465636f6465616c6c69616e63652f7769742d62696e6467656e&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wit-bindgen/blob/eaf42f6c12d9cca8231d5a361d20b6c21c2a2739/tests/runtime-async/async/simple-future/runner.c#L34" title="wit-bindgen/tests/runtime-async/async/simple-future/runner.c at eaf42f6c12d9cca8231d5a361d20b6c21c2a2739 · bytecodealliance/wit-bindgen">wit-bindgen/tests/runtime-async/async/simple-future/runner.c at eaf42f6c12d9cca8231d5a361d20b6c21c2a2739 · bytecodealliance/wit-bindgen</a></div><div class="message_embed_description">A language binding generator for WebAssembly interface types - bytecodealliance/wit-bindgen</div></div></div>



<a name="534720976"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/534720976" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#534720976">(Aug 15 2025 at 22:44)</a>:</h4>
<p>I.e., I would expect to see an import for <code>drop-future</code>.</p>



<a name="534721063"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/534721063" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#534721063">(Aug 15 2025 at 22:45)</a>:</h4>
<p>Is it that internally any "void future" would work here, due to some internal things.  I think I read that only one task (subtask?) can be active at a time?</p>



<a name="534721911"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/534721911" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#534721911">(Aug 15 2025 at 22:59)</a>:</h4>
<p>I'm not sure I understand what you're asking, but note that we use a "trick" to refer to a given <code>future</code> or <code>stream</code> type in the binding generator, allowing <code>wit-component</code> to determine which type to use when generating references to the <code>future.write</code>, <code>future.drop</code>, etc. intrinsics: <a href="https://github.com/bytecodealliance/wasm-tools/blob/f6967282dce8f2b3be29ddcd0f33cb90a37ec8f4/crates/wit-parser/src/lib.rs#L1160-L1174">https://github.com/bytecodealliance/wasm-tools/blob/f6967282dce8f2b3be29ddcd0f33cb90a37ec8f4/crates/wit-parser/src/lib.rs#L1160-L1174</a></p>
<p>Trying to encode the entire type using only e.g. name mangling would be difficult if not impossible (imagine mangling <code>future&lt;list&lt;tuple&lt;some-record, some-resource-type&gt;&gt;&gt;</code>, especially given that resource types are not necessarily uniquely identified by their names, e.g. when a resource is both imported and exported), so we instead refer to some arbitrary function that uses the type we care about and use an index to indicate which one we mean.</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasm-tools/blob/f6967282dce8f2b3be29ddcd0f33cb90a37ec8f4/crates/wit-parser/src/lib.rs#L1160-L1174" style="background-image: url(&quot;https://uploads.zulipusercontent.net/0ea15d01313588cf5bf18f41153bad82b4a26ef6/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f623530353532303430643463363031303634303366623439663861623665363130343836663965303731613037633835363634306138336130616565376432382f62797465636f6465616c6c69616e63652f7761736d2d746f6f6c73&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasm-tools/blob/f6967282dce8f2b3be29ddcd0f33cb90a37ec8f4/crates/wit-parser/src/lib.rs#L1160-L1174" title="wasm-tools/crates/wit-parser/src/lib.rs at f6967282dce8f2b3be29ddcd0f33cb90a37ec8f4 · bytecodealliance/wasm-tools">wasm-tools/crates/wit-parser/src/lib.rs at f6967282dce8f2b3be29ddcd0f33cb90a37ec8f4 · bytecodealliance/wasm-tools</a></div><div class="message_embed_description"> CLI and Rust libraries for low-level manipulation of WebAssembly modules  - bytecodealliance/wasm-tools</div></div></div>



<a name="534722313"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/534722313" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#534722313">(Aug 15 2025 at 23:04)</a>:</h4>
<p>I'm curious about <code>read-future</code> in the name of the import used by the <code>drop-future</code> test.  Reading the link you posted, and your explanation, I think I get it.  The type is the same, so the name at the end of the import is not that important, its the type that must be matched.</p>



<a name="534767133"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/534767133" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#534767133">(Aug 16 2025 at 14:53)</a>:</h4>
<p>Yeah, the point is to pick a function that refers to the type -- if there is more than one which refers to that type, then the binding generator picks one arbitrarily and uses it.</p>



<a name="567276166"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/567276166" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#567276166">(Jan 09 2026 at 23:22)</a>:</h4>
<p>I'm thinking to add the cancel functionality next.  We can't extend <code>Task</code> to hold the handle as its sealed, so i was thinking we maintain a list of some sort of created async function tasks, so that we can map the task back to the handle.  We could then have an extensions perhaps to <code>Task</code>, e.g. <code>Cancel</code>, that would look up the handle from the hash set of <code>Task</code>s and call cancel on that handle.   Does that sound sensible?</p>



<a name="567276892"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/567276892" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#567276892">(Jan 09 2026 at 23:33)</a>:</h4>
<p>Personally, I'd recommend leaving cancellation until later.  I haven't even added cancel support to Python or Go yet; I'm basically waiting until someone asks for it.  I'd suggest finishing everything <em>except</em> cancellation first, at which point developers will be able to start doing interesting things with WASIp3 in .NET.</p>



<a name="567277031"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/567277031" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#567277031">(Jan 09 2026 at 23:35)</a>:</h4>
<p>Anyway, whenever you do tackle cancellation, the hash set sounds plausible to me; I'd be interested to here what Pavel thinks.  I'd have to go back and study <code>Task</code> again to have more of an opinion.</p>



<a name="567280400"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/567280400" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#567280400">(Jan 10 2026 at 00:24)</a>:</h4>
<p>Ok, I will leave it for now and look at a different runtime <br>
test to tackle.</p>



<a name="567331469"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/567331469" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Pavel Šavara <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#567331469">(Jan 10 2026 at 16:31)</a>:</h4>
<p><span class="user-mention silent" data-user-id="509936">Joel Dice</span> <a href="#narrow/channel/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture/near/567277031">said</a>:</p>
<blockquote>
<p>I'd be interested to here what Pavel thinks.  I'd have to go back and study <code>Task</code> again to have more of an opinion.</p>
</blockquote>
<p>I'm afraid I would have to spent some time playing with latest p3 before I can offer more valuable insight. Right now I think :</p>
<ul>
<li>I can explain how we marshal Task&lt;-&gt;Promise between C# and JavaScript. Interesting problems are around two garbage collectors involved. In my first attempt I got confused about ownership of Task vs ownership of the TaskCompletionSource. (prepresented by resolve()/reject() JS methods on JS side). You can also drop/dispose the proxy when it's resolved/rejected. Then the GC is left to collect only abandoned Tasks/Promises.</li>
<li>Are there delagates/functions/callbacks as call parameter to be marshaled in p3 ? Those also have GC story. In C# they could also capture a closure and keep alive other objects.</li>
<li>I'm worried that WASI streams could be resolved multiple times. Specifically I don't want to hack and re-resolve C# Task.</li>
<li>I think that on C# API we should marshal it as as implementation of System.IO.Stream API.  Only it's async methods. C# stream also has synchronous APIs, but those should throw PNSE. </li>
<li>I know there are ways how WASIp3 host could offer sync-over-async. I (stubbornly) insist that we don't want to expose any of the blocking system calls. Except those which are already blocking in the browser/wasi single-threaded API landscape today (some of the FS and some of the DNS and Crypto). My reason is that I want the managed "thread pool" queue to process work even is some other call is waiting. And I think that we are not able to survive re-entry with existing managed call on the stack of the same thread. That would break memory state invariant. I could be convinced that I'm wrong by a prototype, but I think it's not a trivial thing to do. I'm prepared to change my opinion after we have multi-threading, in which we could maybe overcome sync-over-async on dotnet side and we could do re-entrance as another guest thread (or something).</li>
<li>I don't know what's the current state of cooperative multi-threading. Is there some demo/presentation/lecture/video I can watch ?</li>
</ul>



<a name="567345461"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/567345461" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#567345461">(Jan 10 2026 at 20:42)</a>:</h4>
<p>I'm happy to add GC Collects in places  to see what breaks in the runtime tests</p>



<a name="567577009"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/567577009" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#567577009">(Jan 12 2026 at 16:04)</a>:</h4>
<p><span class="user-mention silent" data-user-id="471788">Pavel Šavara</span> <a href="#narrow/channel/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture/near/567331469">said</a>:</p>
<blockquote>
<ul>
<li>Are there delagates/functions/callbacks as call parameter to be marshaled in p3 ? Those also have GC story. In C# they could also capture a closure and keep alive other objects.</li>
</ul>
</blockquote>
<p>I don't have a direct answer to this, but I'll note that we've tried to make WASIp3 "less trappy" in that we try to avoid parent/child relationships between component model handles in general.  In p2, we had a lot of parent/child relationships such that if you dropped the parent handle before any of the children, you'd trap, which meant GC-based languages had to do extra work to ensure handles were dropped in the correct order.  p3 is a lot more relaxed about that, FWIW.</p>
<p><span class="user-mention silent" data-user-id="471788">Pavel Šavara</span> <a href="#narrow/channel/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture/near/567331469">said</a>:</p>
<blockquote>
<ul>
<li>I'm worried that WASI streams could be resolved multiple times. Specifically I don't want to hack and re-resolve C# Task.</li>
</ul>
</blockquote>
<p>Yeah, I don't think a <code>stream</code> should be represented as a <code>Task</code>.  Instead, each call to <code>Read</code> or <code>Write</code> should return a new <code>Task</code>, which is equivalent to how the Rust and Python bindings generators work.</p>
<p><span class="user-mention silent" data-user-id="471788">Pavel Šavara</span> <a href="#narrow/channel/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture/near/567331469">said</a>:</p>
<blockquote>
<ul>
<li>I'm prepared to change my opinion after we have multi-threading, in which we could maybe overcome sync-over-async on dotnet side and we could do re-entrance as another guest thread (or something).</li>
</ul>
</blockquote>
<p>It's looking like we might have cooperative multi-threading as part of 0.3.0, or if not, soon afterward.  And it's already implemented in Wasmtime, so I think it would be reasonable for the .NET port to just use mult-threading from the beginning.</p>
<p><span class="user-mention silent" data-user-id="471788">Pavel Šavara</span> <a href="#narrow/channel/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture/near/567331469">said</a>:</p>
<blockquote>
<ul>
<li>I don't know what's the current state of cooperative multi-threading. Is there some demo/presentation/lecture/video I can watch ?</li>
</ul>
</blockquote>
<p>This is the most up-to-date resource I'm aware of: <a href="https://github.com/WebAssembly/component-model/blob/main/design/mvp/Concurrency.md">https://github.com/WebAssembly/component-model/blob/main/design/mvp/Concurrency.md</a>.  You can also read about the <code>thread.*</code> intrinsics starting <a href="https://github.com/WebAssembly/component-model/blob/main/design/mvp/CanonicalABI.md#-canon-threadindex">here</a> for a summary of how threads can be created, suspended, and resumed.</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/WebAssembly/component-model/blob/main/design/mvp/Concurrency.md" style="background-image: url(&quot;https://uploads.zulipusercontent.net/1f55ddbf76be67ec34176f4f68fde7b9a66f8257/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f353637366334343738643566653735316237303563333739323730333862353134333662646639383934636332346137303463336532633634633831313665322f576562417373656d626c792f636f6d706f6e656e742d6d6f64656c&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/WebAssembly/component-model/blob/main/design/mvp/Concurrency.md" title="component-model/design/mvp/Concurrency.md at main · WebAssembly/component-model">component-model/design/mvp/Concurrency.md at main · WebAssembly/component-model</a></div><div class="message_embed_description">Repository for design and specification of the Component Model - WebAssembly/component-model</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/WebAssembly/component-model/blob/main/design/mvp/CanonicalABI.md#-canon-threadindex" style="background-image: url(&quot;https://uploads.zulipusercontent.net/1f55ddbf76be67ec34176f4f68fde7b9a66f8257/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f353637366334343738643566653735316237303563333739323730333862353134333662646639383934636332346137303463336532633634633831313665322f576562417373656d626c792f636f6d706f6e656e742d6d6f64656c&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/WebAssembly/component-model/blob/main/design/mvp/CanonicalABI.md#-canon-threadindex" title="component-model/design/mvp/CanonicalABI.md at main · WebAssembly/component-model">component-model/design/mvp/CanonicalABI.md at main · WebAssembly/component-model</a></div><div class="message_embed_description">Repository for design and specification of the Component Model - WebAssembly/component-model</div></div></div>



<a name="567653735"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/567653735" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#567653735">(Jan 12 2026 at 22:21)</a>:</h4>
<p>Regards this wit</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">  </span><span class="n">export</span><span class="w"> </span><span class="n">run</span><span class="p">:</span><span class="w"> </span><span class="nc">async</span><span class="w"> </span><span class="n">func</span><span class="p">();</span>
</code></pre></div>
<p>which is from a test runner.  Will the runtime try to call a <code>[callback]</code> function, and if it does, what would it pass for the <code>waitable</code>, second parameter?</p>



<a name="567654176"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/567654176" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#567654176">(Jan 12 2026 at 22:25)</a>:</h4>
<p>It will call the callback function if the <code>run</code> export returns <code>CALLBACK_CODE_YIELD</code> or <code>CALLBACK_CODE_WAIT</code>.  If it's the former, the <code>waitable</code> will be zero (i.e. not applicable).  If it's the latter, the <code>waitable</code> will be whichever <code>waitable</code> the event concerns, i.e. one of the <code>waitable</code>s in the <code>waitable-set</code> returned as part of the <code>CALLBACK_CODE_WAIT</code> return value.</p>
<p>If the <code>run</code> export returns <code>CALLBACK_CODE_EXIT</code>, then the <code>[callback]</code> function won't be called (at least not for that particular task).</p>



<a name="567655041"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/567655041" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#567655041">(Jan 12 2026 at 22:33)</a>:</h4>
<p>Thanks, that makes sense.  I'm trying to work out how I should handle <br>
<a href="https://github.com/bytecodealliance/wit-bindgen/blob/90b50130ee83f298581e23dffc916ff36c8fd8a3/tests/runtime-async/async/pending-import/test.c#L34">https://github.com/bytecodealliance/wit-bindgen/blob/90b50130ee83f298581e23dffc916ff36c8fd8a3/tests/runtime-async/async/pending-import/test.c#L34</a><br>
As you know this drop is part of the vtable, but I didn't really want to expose the vtable to the user code, i.e. the test code, so I though I could capture the correct vtable in the event, and then and a method to the event class to "drop the waitable", e.g.</p>
<div class="codehilite" data-code-language="C#"><pre><span></span><code><span class="w">        </span><span class="k">public</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">PendingImportCallback</span><span class="p">(</span><span class="n">AsyncSupport</span><span class="p">.</span><span class="n">Event</span><span class="w"> </span><span class="n">ev</span><span class="p">)</span>
</code></pre></div>
<p>Then inside this method:</p>
<div class="codehilite" data-code-language="C#"><pre><span></span><code><span class="w">            </span><span class="n">ev</span><span class="p">.</span><span class="n">DropWaitable</span><span class="p">();</span>
</code></pre></div>
<p>However if I do this in the export for the exported async method in the test code, the runner code, which exports a different method, the <code>run</code>, it also ends up with that export</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">            </span><span class="p">[</span><span class="n">global</span><span class="p">::</span><span class="n">System</span><span class="p">.</span><span class="n">Runtime</span><span class="p">.</span><span class="n">InteropServices</span><span class="p">.</span><span class="n">UnmanagedCallersOnlyAttribute</span><span class="p">(</span><span class="n">EntryPoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"[callback][async-lift]run"</span><span class="p">)]</span>
<span class="w">            </span><span class="n">public</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="n">int</span><span class="w"> </span><span class="n">RunCallback</span><span class="p">(</span><span class="n">int</span><span class="w"> </span><span class="n">eventRaw</span><span class="p">,</span><span class="w"> </span><span class="n">int</span><span class="w"> </span><span class="n">waitable</span><span class="p">,</span><span class="w"> </span><span class="n">int</span><span class="w"> </span><span class="n">code</span><span class="p">)</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="n">AsyncSupport</span><span class="p">.</span><span class="n">Event</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">AsyncSupport</span><span class="p">.</span><span class="n">Event</span><span class="p">(</span><span class="n">eventRaw</span><span class="p">,</span><span class="w"> </span><span class="n">waitable</span><span class="p">,</span><span class="w"> </span><span class="n">code</span><span class="p">,</span><span class="w"> </span><span class="n">FutureVTable</span><span class="p">);</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">RunnerWorldExportsImpl</span><span class="p">.</span><span class="n">RunCallback</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
</code></pre></div>
<p>And of course I have no future vtable here.</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wit-bindgen/blob/90b50130ee83f298581e23dffc916ff36c8fd8a3/tests/runtime-async/async/pending-import/test.c#L34" style="background-image: url(&quot;https://uploads.zulipusercontent.net/0038d7120ad8b67a63d9d865e77d77a498c9efb3/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f316238346161366435663132646263366230393831613532393766303638653835663966346631306332363963386536633333303835383138343630363361362f62797465636f6465616c6c69616e63652f7769742d62696e6467656e&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wit-bindgen/blob/90b50130ee83f298581e23dffc916ff36c8fd8a3/tests/runtime-async/async/pending-import/test.c#L34" title="wit-bindgen/tests/runtime-async/async/pending-import/test.c at 90b50130ee83f298581e23dffc916ff36c8fd8a3 · bytecodealliance/wit-bindgen">wit-bindgen/tests/runtime-async/async/pending-import/test.c at 90b50130ee83f298581e23dffc916ff36c8fd8a3 · bytecodealliance/wit-bindgen</a></div><div class="message_embed_description">A language binding generator for WebAssembly interface types - bytecodealliance/wit-bindgen</div></div></div>



<a name="567655331"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/567655331" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#567655331">(Jan 12 2026 at 22:35)</a>:</h4>
<p>Maybe I should capture in the function bindgen, if I have used a future, and then I can write the <code>callback</code>interop appropriately.</p>



<a name="567655411"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/567655411" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#567655411">(Jan 12 2026 at 22:36)</a>:</h4>
<p>Its also possible, that this will be more obvious to me, when I get to a more sophisticated wit.</p>



<a name="567656134"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/567656134" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#567656134">(Jan 12 2026 at 22:44)</a>:</h4>
<p>Let me think again about this, I may have a better question later.</p>



<a name="567656172"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/567656172" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#567656172">(Jan 12 2026 at 22:44)</a>:</h4>
<p>Sorry, in a meeting now, but will chime in when I can</p>



<a name="567656261"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/567656261" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#567656261">(Jan 12 2026 at 22:45)</a>:</h4>
<p>Ok, thanks, I was just thinking about how my current scheme doesn't work when the export has multiple future params of different types.</p>



<a name="567658211"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/567658211" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#567658211">(Jan 12 2026 at 23:05)</a>:</h4>
<p>Generally speaking, before returning <code>CALLBACK_CODE_WAIT</code> the bindings generator or associated runtime library should store an entry in task-local map representing the pair of the <code>waitable</code> and e.g. a closure or equivalent representing what to do when an event arrives for that <code>waitable</code>.  The key thing to note is that "task-local" means saved and restored using the <code>context.set</code> and <code>context.get</code> intrinsics, respectively.</p>
<p>Don't hesitate to look at what the Rust, Python, or Go bindings generators and their runtimes do.</p>



<a name="567658598"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/567658598" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#567658598">(Jan 12 2026 at 23:09)</a>:</h4>
<p>There is also a rust example for this test, I will look at what it generates here, thanks</p>



<a name="567658963"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/567658963" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#567658963">(Jan 12 2026 at 23:13)</a>:</h4>
<p>Ah, now I see something I tried to kick down the road, that is likely useful.  I just have a single context type.  I did notice that the c code created one for the function, but it didn't dawn on me that I could customise the one of the fields</p>



<a name="567659676"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/567659676" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#567659676">(Jan 12 2026 at 23:20)</a>:</h4>
<p>One thing that throws me a bit here, is that the rust test here is just</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">impl</span><span class="w"> </span><span class="k">crate</span><span class="p">::</span><span class="n">exports</span><span class="p">::</span><span class="n">my</span><span class="p">::</span><span class="n">test</span><span class="p">::</span><span class="n">i</span><span class="p">::</span><span class="n">Guest</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Component</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">pending_import</span><span class="p">(</span><span class="n">x</span><span class="p">:</span><span class="w"> </span><span class="nc">FutureReader</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">x</span><span class="p">.</span><span class="k">await</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Whereas the <code>c</code> is way longer .  Perhaps I should not be looking at the 'c' to get an idea of what should be in the user code, but just for the final sequence of events?</p>



<a name="567659933"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/567659933" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#567659933">(Jan 12 2026 at 23:23)</a>:</h4>
<p>That's because the C generator is ultra-minimal, leaving the details to the application developer.  The Rust, Python, and Go generators and their runtime libraries do a lot more, handling the details on behalf of the app developer.  For Rust, see <code>async_support.rs</code> and related code under the <code>rt</code> module, which is where those details are handled.</p>



<a name="567660037"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/567660037" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#567660037">(Jan 12 2026 at 23:24)</a>:</h4>
<p>You can also generate Rust bindings using the <code>wit-bindgen rust</code> subcommand to see how the generator bridges the application code with the ABI, using the <code>rt</code> library.</p>



<a name="567660128"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/567660128" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#567660128">(Jan 12 2026 at 23:25)</a>:</h4>
<p>THanks, I will reset my thinking a bit here.</p>



<a name="568535227"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/568535227" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#568535227">(Jan 16 2026 at 22:34)</a>:</h4>
<p>Hi, I'm on the way to making the C# bindings more like Go and Rust.  Still on the pending-inport example</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">package</span><span class="w"> </span><span class="n">my</span><span class="p">:</span><span class="nc">test</span><span class="p">;</span>

<span class="n">interface</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">pending</span><span class="o">-</span><span class="n">import</span><span class="p">:</span><span class="w"> </span><span class="nc">async</span><span class="w"> </span><span class="n">func</span><span class="p">(</span><span class="n">x</span><span class="p">:</span><span class="w"> </span><span class="nc">future</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">world</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">export</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>When the runner writes to the future <code>x</code>, that completes successfully, but the runtime should resume the future <code>read</code> in the test side, as I understand it.  But I'm missing how that happens as there doesn't seem to be an export that is called in the test, should I have registered a callback or something before returning <code>CallbackCode.Yield;</code> ?</p>



<a name="568535774"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/568535774" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#568535774">(Jan 16 2026 at 22:41)</a>:</h4>
<p>Perhaps  Im missing a waitable join somewhere..</p>



<a name="568536414"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/568536414" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#568536414">(Jan 16 2026 at 22:49)</a>:</h4>
<p>yes, that might be it, let me try that.</p>



<a name="568538562"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/568538562" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#568538562">(Jan 16 2026 at 23:18)</a>:</h4>
<p>Actually still I bit confused, I can't see where the rust is doing that, and there is no go implementation, except for the generated code which has </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">wit_async</span><span class="p">.</span><span class="n">SubtaskWait</span><span class="p">(</span><span class="n">uint32</span><span class="p">(</span><span class="n">wasm_import_pending_import</span><span class="p">((</span><span class="n">x</span><span class="p">).</span><span class="n">TakeHandle</span><span class="p">())))</span>
</code></pre></div>
<p>Which does do a join in <code>SubtaskWait</code> but it doesn't seem to leave space to do the writing to the future, so not sure how that works....</p>



<a name="568590920"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/568590920" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#568590920">(Jan 17 2026 at 14:25)</a>:</h4>
<p>I 've added a join which I think was the missing bit, was trying to get away without implementing the <code>[callback]</code> part so looking at that bit now.</p>



<a name="568602924"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/568602924" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#568602924">(Jan 17 2026 at 17:18)</a>:</h4>
<p>I'm getting this error at the end of the test execution after calling the callback on the test side</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">wasm</span><span class="w"> </span><span class="n">trap</span><span class="p">:</span><span class="w"> </span><span class="nc">async</span><span class="o">-</span><span class="n">lifted</span><span class="w"> </span><span class="n">export</span><span class="w"> </span><span class="n">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">produce</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">result</span>
</code></pre></div>
<p>The callback I have for <code>[callback][async-lift]my:test/i#pending-import</code> is returning 0 which I thought was <code>CALLBACK_CODE_EXIT</code>, is that not right ?</p>



<a name="568603507"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/568603507" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#568603507">(Jan 17 2026 at 17:28)</a>:</h4>
<p>ah, I 've not called task-return.  Sorry for spanming</p>



<a name="568761290"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/568761290" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Ralph <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#568761290">(Jan 19 2026 at 09:57)</a>:</h4>
<p><span class="user-mention" data-user-id="395878">@Scott Waye</span> you spam all you want. It helps to see your thinking process -- it shows what we need to explain better and/or modify. If you can't figure it out, how can others? :-)</p>



<a name="568862664"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/568862664" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#568862664">(Jan 19 2026 at 18:44)</a>:</h4>
<p>Lol, I do find writing things down sometimes kicks the brain into doing something useful.  I need a chat client that just go &gt; /dev/null :-)</p>



<a name="570929299"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/570929299" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#570929299">(Jan 30 2026 at 02:15)</a>:</h4>
<p>About the implementation of the Stream <code>Write/StartWrite</code> method, the buffer is passed, but who is responsible for freeing that, is it the reader?</p>



<a name="570929365"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/570929365" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#570929365">(Jan 30 2026 at 02:16)</a>:</h4>
<p>I say freeing, but could be unpinning in C#</p>



<a name="571081393"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/571081393" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#571081393">(Jan 30 2026 at 17:05)</a>:</h4>
<p>The reader will normally be a different component from the writer (or the host), so it wouldn't be able to free the buffer even if it wanted to.  Instead, the writer is responsible for freeing or unpinning the write buffer once the write completes (i.e. after it either completes immediately without delay or after an <code>EVENT_STREAM_WRITE</code> is received for that write).  Same goes for the read end: the component that's reading must ensure the read buffer stays valid (and doesn't move) until it has been notified either via a return code or an event that the write has been completed (or cancelled).</p>



<a name="571111049"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/571111049" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#571111049">(Jan 30 2026 at 19:42)</a>:</h4>
<p><code>EVENT_STREAM_WRITE</code> gives the buffer in the args i suppose.</p>



<a name="571111296"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/571111296" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#571111296">(Jan 30 2026 at 19:44)</a>:</h4>
<p>I might be able to kick this bit down the road I suppose, with a TODO</p>



<a name="571111830"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/571111830" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#571111830">(Jan 30 2026 at 19:47)</a>:</h4>
<p>Hmm, I guess it depends on what, precisely, you plan to kick down the road.  It's fine to pin the buffer <em>longer</em> than necessary, but if you pin it <em>shorter</em> than necessary you'll end up with hard-to-debug heap corruption sooner or later.</p>



<a name="571112021"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/571112021" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#571112021">(Jan 30 2026 at 19:48)</a>:</h4>
<p>That is true, I was thinking to pin it, and leave it there.  But if the <code>EVENT_STREAM_WRITE</code> gets the buffer, then it would be trivial to clean up</p>



<a name="571112996"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/571112996" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#571112996">(Jan 30 2026 at 19:53)</a>:</h4>
<p>Looking at the Go </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">        </span><span class="n">case</span><span class="w"> </span><span class="n">EVENT_STREAM_READ</span><span class="p">,</span><span class="w"> </span><span class="n">EVENT_STREAM_WRITE</span><span class="p">,</span><span class="w"> </span><span class="n">EVENT_FUTURE_READ</span><span class="p">,</span><span class="w"> </span><span class="n">EVENT_FUTURE_WRITE</span><span class="p">:</span>
<span class="w">            </span><span class="nc">waitableJoin</span><span class="p">(</span><span class="n">event1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">            </span><span class="n">channel</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">pending</span><span class="p">[</span><span class="n">event1</span><span class="p">]</span>
<span class="w">            </span><span class="n">delete</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">pending</span><span class="p">,</span><span class="w"> </span><span class="n">event1</span><span class="p">)</span>
<span class="w">            </span><span class="n">channel</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">event2</span>
</code></pre></div>
<p>I suppose <code>delete</code> would be the thing to look at, if I can find it.</p>



<a name="571113814"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/571113814" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#571113814">(Jan 30 2026 at 19:59)</a>:</h4>
<p>That just removes an entry from the <code>state.pending</code> map; it doesn't affect pinning.  Unpinning the read buffer for Go happens via <a href="https://github.com/bytecodealliance/wit-bindgen/blob/350e8ad7abe8f65357c8984535d7bca5b9882c2c/crates/go/src/package/wit_types/wit_stream.go#L56">this defer statement</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wit-bindgen/blob/350e8ad7abe8f65357c8984535d7bca5b9882c2c/crates/go/src/package/wit_types/wit_stream.go#L56" style="background-image: url(&quot;https://uploads.zulipusercontent.net/14bfde608a302da208e2ace8925ffe3595739189/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f613432636437353239316361663362643466346164383236353564643039353163306331306336363638303334363539336165363963316134333665633738302f62797465636f6465616c6c69616e63652f7769742d62696e6467656e&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wit-bindgen/blob/350e8ad7abe8f65357c8984535d7bca5b9882c2c/crates/go/src/package/wit_types/wit_stream.go#L56" title="wit-bindgen/crates/go/src/package/wit_types/wit_stream.go at 350e8ad7abe8f65357c8984535d7bca5b9882c2c · bytecodealliance/wit-bindgen">wit-bindgen/crates/go/src/package/wit_types/wit_stream.go at 350e8ad7abe8f65357c8984535d7bca5b9882c2c · bytecodealliance/wit-bindgen</a></div><div class="message_embed_description">A language binding generator for WebAssembly interface types - bytecodealliance/wit-bindgen</div></div></div>



<a name="571113998"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/571113998" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#571113998">(Jan 30 2026 at 20:00)</a>:</h4>
<p>That works because <code>wit_async.FutureOrStreamWait</code> (called later in the same function) blocks the calling goroutine until the read completes, at which point the buffer can be unpinned.</p>



<a name="571114792"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/571114792" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#571114792">(Jan 30 2026 at 20:06)</a>:</h4>
<p>Think I understand that code, once the lifting is complete the read buffer can go.   I suppose <code>write</code> is similar.</p>



<a name="571114799"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/571114799" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#571114799">(Jan 30 2026 at 20:06)</a>:</h4>
<p>thanks</p>



<a name="571117042"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/571117042" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#571117042">(Jan 30 2026 at 20:20)</a>:</h4>
<p>Technically, we could unpin as soon as <code>wit_async.FutureOrStreamWait</code> returns and before lifting.  Unpinning just means the GC is free to move the buffer, but that won't harm pure Go code.  The pinning is just to ensure the pointer we passed to the host remains valid, and thus is no longer needed once the host tells us the read has completed.</p>



<a name="571145006"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/571145006" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#571145006">(Jan 31 2026 at 00:10)</a>:</h4>
<p>Ah yes, of course.</p>



<a name="571295267"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/571295267" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#571295267">(Feb 01 2026 at 15:31)</a>:</h4>
<p>Not sure what I've done, but I have this error <br>
---- simple-stream-payload | runner.cs | test.cs ----<br>
  runner: .\tests\runtime-async\async\simple-stream-payload\runner.cs<br>
  compiled runner: C:\github\wit-bindgen\.\target\artifacts\simple-stream-payload\simple-stream-payload\runner-csharp.wasm<br>
  error: failed to run <code>simple-stream-payload</code></p>
<p>Caused by:<br>
      0: failed to compose "C:\\github\\wit-bindgen\\.\\target\\artifacts\\simple-stream-payload\\simple-stream-payload\\runner-csharp.wasm" with "C:\\github\\wit-bindgen\\.\\target\\artifacts\\simple-stream-payload\\simple-stream-payload\\test-csharp.wasm"<br>
      1: no dependencies of component <code>C:\github\wit-bindgen\.\target\artifacts\simple-stream-payload\simple-stream-payload\runner-csharp.wasm</code> were found</p>
<p>What dependencies is it looking for, a particular import?</p>



<a name="571329010"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/571329010" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#571329010">(Feb 02 2026 at 00:51)</a>:</h4>
<p>Think I've missed some code in the runner, will check that.</p>



<a name="571331698"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/571331698" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Alex Crichton <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#571331698">(Feb 02 2026 at 01:29)</a>:</h4>
<p>ah yeah that error means that the runner doesn't actually import the test component, so it might be that the runner is stubbed out or not importing anything?</p>



<a name="571458114"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/571458114" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#571458114">(Feb 02 2026 at 15:15)</a>:</h4>
<p>Yep, if I don't actually use it the NAOT compiler will trim the import</p>



<a name="571973207"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/571973207" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#571973207">(Feb 04 2026 at 17:43)</a>:</h4>
<p>In the runtime tests, the runner exports a run method, and I have this error</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">(</span><span class="n">base</span><span class="p">)</span><span class="w"> </span><span class="n">PS</span><span class="w"> </span><span class="n">C</span><span class="p">:</span><span class="err">\</span><span class="n">github</span><span class="err">\</span><span class="n">wit</span><span class="o">-</span><span class="n">bindgen</span><span class="o">&gt;</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"> </span><span class="o">-</span><span class="n">W</span><span class="w"> </span><span class="n">component</span><span class="o">-</span><span class="n">model</span><span class="o">-</span><span class="k">async</span><span class="w"> </span><span class="n">C</span><span class="p">:</span><span class="err">\</span><span class="n">github</span><span class="err">\</span><span class="n">wit</span><span class="o">-</span><span class="n">bindgen</span><span class="err">\</span><span class="n">target</span><span class="err">\</span><span class="n">artifacts</span><span class="err">\</span><span class="n">simple</span><span class="o">-</span><span class="n">future</span><span class="err">\</span><span class="n">composed</span><span class="o">-</span><span class="n">runner</span><span class="p">.</span><span class="n">cs</span><span class="o">-</span><span class="n">test</span><span class="p">.</span><span class="n">cs</span><span class="p">.</span><span class="n">wasm</span>
<span class="n">Error</span><span class="p">:</span><span class="w"> </span><span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">main</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="err">`</span><span class="n">C</span><span class="p">:</span><span class="err">\</span><span class="n">github</span><span class="err">\</span><span class="n">wit</span><span class="o">-</span><span class="n">bindgen</span><span class="err">\</span><span class="n">target</span><span class="err">\</span><span class="n">artifacts</span><span class="err">\</span><span class="n">simple</span><span class="o">-</span><span class="n">future</span><span class="err">\</span><span class="n">composed</span><span class="o">-</span><span class="n">runner</span><span class="p">.</span><span class="n">cs</span><span class="o">-</span><span class="n">test</span><span class="p">.</span><span class="n">cs</span><span class="p">.</span><span class="n">wasm</span><span class="err">`</span>

<span class="n">Caused</span><span class="w"> </span><span class="n">by</span><span class="p">:</span>
<span class="w">    </span><span class="nc">no</span><span class="w"> </span><span class="n">exported</span><span class="w"> </span><span class="n">instance</span><span class="w"> </span><span class="n">named</span><span class="w"> </span><span class="err">`</span><span class="n">wasi</span><span class="p">:</span><span class="nc">cli</span><span class="o">/</span><span class="n">run</span><span class="o">@</span><span class="mf">0.2.6</span><span class="err">`</span>
</code></pre></div>
<p>My export is <code>[async-lift]run"</code>  which I think used to be correct.  Has something changed - something now expects the cli run export ?</p>



<a name="571984097"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/571984097" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#571984097">(Feb 04 2026 at 18:40)</a>:</h4>
<p>The <code>wasmtime</code> CLI defaults to the <code>run</code> command, which by default expects the component input to export <code>wasi:cli/run</code>.  However, the runner tests in wit-bindgen now export a top-level <code>run</code> function, which you can invoke using <code>wasmtime run --invoke='run()' foo.wasm</code></p>



<a name="571984273"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/571984273" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#571984273">(Feb 04 2026 at 18:41)</a>:</h4>
<p>ah, that explains how CI is passing, thanks</p>



<a name="572138668"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/572138668" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#572138668">(Feb 05 2026 at 12:47)</a>:</h4>
<p>With this test <a href="https://github.com/bytecodealliance/wit-bindgen/blob/350e8ad7abe8f65357c8984535d7bca5b9882c2c/tests/runtime-async/async/simple-stream-payload/runner.rs">https://github.com/bytecodealliance/wit-bindgen/blob/350e8ad7abe8f65357c8984535d7bca5b9882c2c/tests/runtime-async/async/simple-stream-payload/runner.rs</a> , would you expect the first write to be blocked (and need to return to the event loop before getting its <code>count</code> back?</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wit-bindgen/blob/350e8ad7abe8f65357c8984535d7bca5b9882c2c/tests/runtime-async/async/simple-stream-payload/runner.rs" style="background-image: url(&quot;https://uploads.zulipusercontent.net/f734695f2c7b8e454e14fd9a68e96de19e7b839d/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f303461373435306461373332626430353639383038663537306565356462623664656531393436313065613538376263663532626235626532636330373362652f62797465636f6465616c6c69616e63652f7769742d62696e6467656e&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wit-bindgen/blob/350e8ad7abe8f65357c8984535d7bca5b9882c2c/tests/runtime-async/async/simple-stream-payload/runner.rs" title="wit-bindgen/tests/runtime-async/async/simple-stream-payload/runner.rs at 350e8ad7abe8f65357c8984535d7bca5b9882c2c · bytecodealliance/wit-bindgen">wit-bindgen/tests/runtime-async/async/simple-stream-payload/runner.rs at 350e8ad7abe8f65357c8984535d7bca5b9882c2c · bytecodealliance/wit-bindgen</a></div><div class="message_embed_description">A language binding generator for WebAssembly interface types - bytecodealliance/wit-bindgen</div></div></div>



<a name="572165854"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/572165854" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#572165854">(Feb 05 2026 at 14:38)</a>:</h4>
<p>Possibly; it depends on the details of how <code>future::join!</code> is implemented and how the <code>read_stream</code> function in the composed component is implemented.  If the <code>read_stream</code> function is called first and initiates a read immediately, then the write will finish as soon as it is called.  I.e. if the read happens first it will return BLOCKED and the write will complete immediately, but if the write happens first then it will return BLOCKED and the read will complete immediately.</p>



<a name="572166667"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/572166667" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#572166667">(Feb 05 2026 at 14:41)</a>:</h4>
<p>I see, in my case the write will happen first so the BLOCK is expected.  In which case the mechanism is for the runner to yield I think?</p>



<a name="572167074"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/572167074" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#572167074">(Feb 05 2026 at 14:42)</a>:</h4>
<p>This seems to happen in <code>go</code> with the reading from the channel, but I can't see exactly what that does in terms of the low level ABI calls, is it <code>pollable.poll</code> or there is a callback ?</p>



<a name="572167692"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/572167692" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#572167692">(Feb 05 2026 at 14:44)</a>:</h4>
<p>Here I think <a href="https://github.com/bytecodealliance/wit-bindgen/blob/350e8ad7abe8f65357c8984535d7bca5b9882c2c/crates/go/src/package/wit_async/wit_async.go#L195">https://github.com/bytecodealliance/wit-bindgen/blob/350e8ad7abe8f65357c8984535d7bca5b9882c2c/crates/go/src/package/wit_async/wit_async.go#L195</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wit-bindgen/blob/350e8ad7abe8f65357c8984535d7bca5b9882c2c/crates/go/src/package/wit_async/wit_async.go#L195" style="background-image: url(&quot;https://uploads.zulipusercontent.net/f734695f2c7b8e454e14fd9a68e96de19e7b839d/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f303461373435306461373332626430353639383038663537306565356462623664656531393436313065613538376263663532626235626532636330373362652f62797465636f6465616c6c69616e63652f7769742d62696e6467656e&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wit-bindgen/blob/350e8ad7abe8f65357c8984535d7bca5b9882c2c/crates/go/src/package/wit_async/wit_async.go#L195" title="wit-bindgen/crates/go/src/package/wit_async/wit_async.go at 350e8ad7abe8f65357c8984535d7bca5b9882c2c · bytecodealliance/wit-bindgen">wit-bindgen/crates/go/src/package/wit_async/wit_async.go at 350e8ad7abe8f65357c8984535d7bca5b9882c2c · bytecodealliance/wit-bindgen</a></div><div class="message_embed_description">A language binding generator for WebAssembly interface types - bytecodealliance/wit-bindgen</div></div></div>



<a name="572168256"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/572168256" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#572168256">(Feb 05 2026 at 14:46)</a>:</h4>
<p>Are you with Akamai now ?</p>



<a name="572171894"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/572171894" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#572171894">(Feb 05 2026 at 14:59)</a>:</h4>
<p><span class="user-mention silent" data-user-id="395878">Scott Waye</span> <a href="#narrow/channel/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture/near/572166667">said</a>:</p>
<blockquote>
<p>I see, in my case the write will happen first so the BLOCK is expected.  In which case the mechanism is for the runner to yield I think?</p>
</blockquote>
<p>It will return <code>CALLBACK_CODE_WAIT</code> with a waitable-set containing the stream handle.  That's true for both Rust (because the "stackless" concurrency model using a callback for async exports matches its async/await model) and Go (because even though it has "stackful" goroutines, those are currently implemented by the Go compiler using a CPS transform that effectively makes them "stackless").</p>



<a name="572172045"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/572172045" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#572172045">(Feb 05 2026 at 15:00)</a>:</h4>
<p><span class="user-mention silent" data-user-id="395878">Scott Waye</span> <a href="#narrow/channel/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture/near/572168256">said</a>:</p>
<blockquote>
<p>Are you with Akamai now ?</p>
</blockquote>
<p>Yes!</p>



<a name="572174931"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/572174931" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#572174931">(Feb 05 2026 at 15:10)</a>:</h4>
<p>I'm missing something, or looking in the wrong place.  <a href="https://github.com/bytecodealliance/wit-bindgen/blob/350e8ad7abe8f65357c8984535d7bca5b9882c2c/crates/go/src/package/wit_async/wit_async.go#L187C6-L187C24">https://github.com/bytecodealliance/wit-bindgen/blob/350e8ad7abe8f65357c8984535d7bca5b9882c2c/crates/go/src/package/wit_async/wit_async.go#L187C6-L187C24</a>  catches <code>RETURN_CODE_BLOCKED </code> and creates the waitable set and does the join.  Then after the write is unblocked, it enters here <a href="https://github.com/bytecodealliance/wit-bindgen/blob/350e8ad7abe8f65357c8984535d7bca5b9882c2c/crates/go/src/package/wit_async/wit_async.go#L120">https://github.com/bytecodealliance/wit-bindgen/blob/350e8ad7abe8f65357c8984535d7bca5b9882c2c/crates/go/src/package/wit_async/wit_async.go#L120</a> doesnt it?</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wit-bindgen/blob/350e8ad7abe8f65357c8984535d7bca5b9882c2c/crates/go/src/package/wit_async/wit_async.go#L187C6-L187C24" style="background-image: url(&quot;https://uploads.zulipusercontent.net/f734695f2c7b8e454e14fd9a68e96de19e7b839d/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f303461373435306461373332626430353639383038663537306565356462623664656531393436313065613538376263663532626235626532636330373362652f62797465636f6465616c6c69616e63652f7769742d62696e6467656e&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wit-bindgen/blob/350e8ad7abe8f65357c8984535d7bca5b9882c2c/crates/go/src/package/wit_async/wit_async.go#L187C6-L187C24" title="wit-bindgen/crates/go/src/package/wit_async/wit_async.go at 350e8ad7abe8f65357c8984535d7bca5b9882c2c · bytecodealliance/wit-bindgen">wit-bindgen/crates/go/src/package/wit_async/wit_async.go at 350e8ad7abe8f65357c8984535d7bca5b9882c2c · bytecodealliance/wit-bindgen</a></div><div class="message_embed_description">A language binding generator for WebAssembly interface types - bytecodealliance/wit-bindgen</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wit-bindgen/blob/350e8ad7abe8f65357c8984535d7bca5b9882c2c/crates/go/src/package/wit_async/wit_async.go#L120" style="background-image: url(&quot;https://uploads.zulipusercontent.net/f734695f2c7b8e454e14fd9a68e96de19e7b839d/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f303461373435306461373332626430353639383038663537306565356462623664656531393436313065613538376263663532626235626532636330373362652f62797465636f6465616c6c69616e63652f7769742d62696e6467656e&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wit-bindgen/blob/350e8ad7abe8f65357c8984535d7bca5b9882c2c/crates/go/src/package/wit_async/wit_async.go#L120" title="wit-bindgen/crates/go/src/package/wit_async/wit_async.go at 350e8ad7abe8f65357c8984535d7bca5b9882c2c · bytecodealliance/wit-bindgen">wit-bindgen/crates/go/src/package/wit_async/wit_async.go at 350e8ad7abe8f65357c8984535d7bca5b9882c2c · bytecodealliance/wit-bindgen</a></div><div class="message_embed_description">A language binding generator for WebAssembly interface types - bytecodealliance/wit-bindgen</div></div></div>



<a name="572175079"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/572175079" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#572175079">(Feb 05 2026 at 15:10)</a>:</h4>
<p>I'm in a meeting now; but will take a look when I have a chance.</p>



<a name="572177081"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/572177081" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#572177081">(Feb 05 2026 at 15:18)</a>:</h4>
<p>If you prefer we can cover this in the next meeting, which I think is in 2 weeks?</p>



<a name="572209204"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/572209204" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#572209204">(Feb 05 2026 at 17:22)</a>:</h4>
<p>In <code>FutureOrStreamWait</code>, the <code>code = (&lt;-channel)</code> line blocks the current goroutine, which unwinds the goroutine stack and passes control to the Go scheduler.  If there are no other runnable goroutines, then the "root" goroutine resumes <a href="https://github.com/bytecodealliance/wit-bindgen/blob/350e8ad7abe8f65357c8984535d7bca5b9882c2c/crates/go/src/package/wit_async/wit_async.go#L127">here</a>, and that returns control to the host <a href="https://github.com/bytecodealliance/wit-bindgen/blob/350e8ad7abe8f65357c8984535d7bca5b9882c2c/crates/go/src/package/wit_async/wit_async.go#L161">here</a>.</p>
<p>Go is its own special beast; to really understand what's going on you have to read <a href="https://github.com/golang/go/blob/99d7121934a9cfa7963d3a9bfd840779fd2869f6/src/cmd/compile/internal/wasm/ssa.go#L19-L130">this</a> and study the Wasm code it generates.  I don't recommend you do that, though.  Just imagine <code>FutureOrStreamWait</code> is an async function in C# that awaits a <code>Task</code> representing the future or stream and returns control to the top level event loop in the meantime.</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wit-bindgen/blob/350e8ad7abe8f65357c8984535d7bca5b9882c2c/crates/go/src/package/wit_async/wit_async.go#L127" style="background-image: url(&quot;https://uploads.zulipusercontent.net/00667b18d08d4bf1aaa3a9d763f475dfc456295a/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f323966393236396466313832653263656236656133636331633863396637646239373664646262393330366566303039636639666461316365616631303937642f62797465636f6465616c6c69616e63652f7769742d62696e6467656e&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wit-bindgen/blob/350e8ad7abe8f65357c8984535d7bca5b9882c2c/crates/go/src/package/wit_async/wit_async.go#L127" title="wit-bindgen/crates/go/src/package/wit_async/wit_async.go at 350e8ad7abe8f65357c8984535d7bca5b9882c2c · bytecodealliance/wit-bindgen">wit-bindgen/crates/go/src/package/wit_async/wit_async.go at 350e8ad7abe8f65357c8984535d7bca5b9882c2c · bytecodealliance/wit-bindgen</a></div><div class="message_embed_description">A language binding generator for WebAssembly interface types - bytecodealliance/wit-bindgen</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wit-bindgen/blob/350e8ad7abe8f65357c8984535d7bca5b9882c2c/crates/go/src/package/wit_async/wit_async.go#L161" style="background-image: url(&quot;https://uploads.zulipusercontent.net/00667b18d08d4bf1aaa3a9d763f475dfc456295a/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f323966393236396466313832653263656236656133636331633863396637646239373664646262393330366566303039636639666461316365616631303937642f62797465636f6465616c6c69616e63652f7769742d62696e6467656e&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wit-bindgen/blob/350e8ad7abe8f65357c8984535d7bca5b9882c2c/crates/go/src/package/wit_async/wit_async.go#L161" title="wit-bindgen/crates/go/src/package/wit_async/wit_async.go at 350e8ad7abe8f65357c8984535d7bca5b9882c2c · bytecodealliance/wit-bindgen">wit-bindgen/crates/go/src/package/wit_async/wit_async.go at 350e8ad7abe8f65357c8984535d7bca5b9882c2c · bytecodealliance/wit-bindgen</a></div><div class="message_embed_description">A language binding generator for WebAssembly interface types - bytecodealliance/wit-bindgen</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/golang/go/blob/99d7121934a9cfa7963d3a9bfd840779fd2869f6/src/cmd/compile/internal/wasm/ssa.go#L19-L130" style="background-image: url(&quot;https://uploads.zulipusercontent.net/7f3ebbd97dcb1b68554a95c6f0f4e8bf5e0cc70e/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f363031343637326237656636376561363530383665313464633565343232363365366339383638653232366263613633653961363163633862653539666461312f676f6c616e672f676f&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/golang/go/blob/99d7121934a9cfa7963d3a9bfd840779fd2869f6/src/cmd/compile/internal/wasm/ssa.go#L19-L130" title="go/src/cmd/compile/internal/wasm/ssa.go at 99d7121934a9cfa7963d3a9bfd840779fd2869f6 · golang/go">go/src/cmd/compile/internal/wasm/ssa.go at 99d7121934a9cfa7963d3a9bfd840779fd2869f6 · golang/go</a></div><div class="message_embed_description">The Go programming language. Contribute to golang/go development by creating an account on GitHub.</div></div></div>



<a name="572212521"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/572212521" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#572212521">(Feb 05 2026 at 17:37)</a>:</h4>
<p>Thanks, an <code>async Task</code> is where I want to get to.  I can create that <code>Task</code> using a <code>TaskCompletionSource</code> and store it somewhere as <code>go</code> does.  Then I will need to complete that task at some point, in go that would be from <code>Callback</code> I think, where is <code>Callback</code> hooked up?  <a href="https://github.com/bytecodealliance/wit-bindgen/blob/350e8ad7abe8f65357c8984535d7bca5b9882c2c/crates/go/src/package/wit_async/wit_async.go#L61">https://github.com/bytecodealliance/wit-bindgen/blob/350e8ad7abe8f65357c8984535d7bca5b9882c2c/crates/go/src/package/wit_async/wit_async.go#L61</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wit-bindgen/blob/350e8ad7abe8f65357c8984535d7bca5b9882c2c/crates/go/src/package/wit_async/wit_async.go#L61" style="background-image: url(&quot;https://uploads.zulipusercontent.net/00667b18d08d4bf1aaa3a9d763f475dfc456295a/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f323966393236396466313832653263656236656133636331633863396637646239373664646262393330366566303039636639666461316365616631303937642f62797465636f6465616c6c69616e63652f7769742d62696e6467656e&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wit-bindgen/blob/350e8ad7abe8f65357c8984535d7bca5b9882c2c/crates/go/src/package/wit_async/wit_async.go#L61" title="wit-bindgen/crates/go/src/package/wit_async/wit_async.go at 350e8ad7abe8f65357c8984535d7bca5b9882c2c · bytecodealliance/wit-bindgen">wit-bindgen/crates/go/src/package/wit_async/wit_async.go at 350e8ad7abe8f65357c8984535d7bca5b9882c2c · bytecodealliance/wit-bindgen</a></div><div class="message_embed_description">A language binding generator for WebAssembly interface types - bytecodealliance/wit-bindgen</div></div></div>



<a name="572212770"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/572212770" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#572212770">(Feb 05 2026 at 17:38)</a>:</h4>
<p>Oh I see it</p>



<a name="572212880"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/572212880" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#572212880">(Feb 05 2026 at 17:39)</a>:</h4>
<p>Its a <code>[callback]</code> export</p>



<a name="572213072"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/572213072" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#572213072">(Feb 05 2026 at 17:40)</a>:</h4>
<p>Awesome, I can play some more, thanks a lot.</p>



<a name="572405978"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/572405978" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#572405978">(Feb 06 2026 at 15:31)</a>:</h4>
<p>Hi, made a little progress, but have another question, if I return <code>CALLBACK_CODE_WAIT</code> out of the async <code>run</code> in the runner, how do I run the event loop, or is that handled by wasmtime?</p>



<a name="572406440"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/572406440" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#572406440">(Feb 06 2026 at 15:34)</a>:</h4>
<p>Returning <code>CALLBACK_CODE_WAIT</code> tells the host: "wait until one of the waitables in this waitable-set has an event and then deliver that event to my callback function".  During that wait, no guest code is run for that task -- it's entirely in the host's hands at that point.</p>



<a name="572406779"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/572406779" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#572406779">(Feb 06 2026 at 15:35)</a>:</h4>
<p>In other words, you should _not_ return <code>CALLBACK_CODE_WAIT</code> to the host until you've run out of things to do in the guest (i.e. there's nothing you can do until one of the pending waitables has an event)</p>



<a name="572407833"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/572407833" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#572407833">(Feb 06 2026 at 15:40)</a>:</h4>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="n">public</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="n">Task</span><span class="w"> </span><span class="n">Run</span><span class="p">()</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">var</span><span class="w"> </span><span class="p">(</span><span class="n">rx</span><span class="p">,</span><span class="w"> </span><span class="n">tx</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IIImports</span><span class="p">.</span><span class="n">StreamNewByte</span><span class="p">();</span>
<span class="w">        </span><span class="k">async</span><span class="w"> </span><span class="n">Task</span><span class="w"> </span><span class="n">Test</span><span class="p">()</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">var</span><span class="w"> </span><span class="n">writtenOne</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="n">tx</span><span class="p">.</span><span class="n">Write</span><span class="p">([</span><span class="mi">0</span><span class="p">]);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">AsyncSupport</span><span class="p">.</span><span class="n">Join</span><span class="p">(</span><span class="n">Test</span><span class="p">(),</span><span class="w"> </span><span class="n">IIImports</span><span class="p">.</span><span class="n">ReadStream</span><span class="p">(</span><span class="n">rx</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
</code></pre></div>
<p>Taking this simplified runner, if <code>Write</code> blocks, <code>AsyncSupport.Join</code> should loop calling <code>[waitable-set-poll]</code> or return and <code>Run</code> returns<code>CALLBACK_CODE_WAIT</code> ?</p>



<a name="572408505"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/572408505" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#572408505">(Feb 06 2026 at 15:43)</a>:</h4>
<p>Like <code>Run</code> is marked <code>async</code> but if <code>Join</code> waits for its <code>Task</code>s to finish in a busy loop, then there is nothing async about it, so I suppose it needs to return <code>CALLBACK_CODE_WAIT</code></p>



<a name="572408916"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/572408916" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#572408916">(Feb 06 2026 at 15:45)</a>:</h4>
<p>So I think that fits with your statement "run ouf of things to do", its the last statement in the function after all.</p>



<a name="572409083"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/572409083" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#572409083">(Feb 06 2026 at 15:46)</a>:</h4>
<p>you must be fed up with me by now :-)<br>
\</p>



<a name="572410010"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/572410010" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#572410010">(Feb 06 2026 at 15:50)</a>:</h4>
<p>Somewhere there should be a function that returns a <code>uint32</code>; it should run a task, and if that task hasn't completed yet, it should collect all the waitables created by that task into a waitable-set and return <code>CALLBACK_CODE_WAIT</code>.  It's been long enough since I worked on .NET that I can't remember what "run a task" looks like, so apologies for being vague about that.</p>



<a name="572410701"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/572410701" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#572410701">(Feb 06 2026 at 15:53)</a>:</h4>
<p>if there <em>aren't</em> any waitables, then it could just return <code>CALLBACK_CODE_YIELD</code>, meaning "I, the guest, don't have anything I'm waiting on, but I'm in the middle of a compute-intensive operation and want to give other tasks a chance to run because I'm a good citizen; call my callback after you've let other tasks run and I'll continue"</p>



<a name="572410800"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/572410800" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#572410800">(Feb 06 2026 at 15:53)</a>:</h4>
<p>it might help to do a zoom call at some point and walk through this together</p>



<a name="572411357"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/572411357" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#572411357">(Feb 06 2026 at 15:56)</a>:</h4>
<p>thanks, let me try a few things first based on the above.  I feel it is very close, just might need somethings moving around.</p>



<a name="572412271"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/572412271" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#572412271">(Feb 06 2026 at 15:59)</a>:</h4>
<p>BTW, to clarify what I said above: if there <em>are</em> waitables, you still might want to return <code>CALLBACK_CODE_YIELD</code> instead of <code>CALLBACK_CODE_WAIT</code> and also call <code>waitable-set.poll</code>, which says "I've got some waitables I'm interested in, but I also have stuff to do in the meantime, so give other tasks a chance to run and let me know if any of those waitables are ready, but otherwise let me run some more".  You can see that logic for Rust <a href="https://github.com/bytecodealliance/wit-bindgen/blob/76e9f08917cacce2515445dc69ce923410449e5f/crates/guest-rust/src/rt/async_support.rs#L250-L277">here</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wit-bindgen/blob/76e9f08917cacce2515445dc69ce923410449e5f/crates/guest-rust/src/rt/async_support.rs#L250-L277" style="background-image: url(&quot;https://uploads.zulipusercontent.net/00667b18d08d4bf1aaa3a9d763f475dfc456295a/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f323966393236396466313832653263656236656133636331633863396637646239373664646262393330366566303039636639666461316365616631303937642f62797465636f6465616c6c69616e63652f7769742d62696e6467656e&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wit-bindgen/blob/76e9f08917cacce2515445dc69ce923410449e5f/crates/guest-rust/src/rt/async_support.rs#L250-L277" title="wit-bindgen/crates/guest-rust/src/rt/async_support.rs at 76e9f08917cacce2515445dc69ce923410449e5f · bytecodealliance/wit-bindgen">wit-bindgen/crates/guest-rust/src/rt/async_support.rs at 76e9f08917cacce2515445dc69ce923410449e5f · bytecodealliance/wit-bindgen</a></div><div class="message_embed_description">A language binding generator for WebAssembly interface types - bytecodealliance/wit-bindgen</div></div></div>



<a name="572413139"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/572413139" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#572413139">(Feb 06 2026 at 16:03)</a>:</h4>
<p>In pseudo-code:</p>
<div class="codehilite" data-code-language="Text only"><pre><span></span><code>if I have more work to do, regardless of any pending waitables:
  if I have pending waitables:
    event = call waitable-set.poll(my-waitable-set)
    if event non nil:
      deliver(event)
      continue
  return CALLBACK_CODE_YIELD
else:
  return CALLBACK_CODE_WAIT | (my-waitable-set &lt;&lt; 4)
</code></pre></div>



<hr><p>Last updated: Feb 22 2026 at 11:05 UTC</p>
</html>
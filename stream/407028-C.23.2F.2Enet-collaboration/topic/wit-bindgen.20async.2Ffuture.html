<html>
<head><meta charset="utf-8"><title>wit-bindgen async/future · C#/.net-collaboration · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/index.html">C#/.net-collaboration</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html">wit-bindgen async/future</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="529702573"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/529702573" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#529702573">(Jul 20 2025 at 17:37)</a>:</h4>
<p>Hi, is it too early to start adding support for async and future in the c# code gen ?  I see there are tests already in the main branch?</p>



<a name="529711960"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/529711960" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#529711960">(Jul 20 2025 at 20:45)</a>:</h4>
<p>No, not too early -- now is a great time to get started.  I was planning to work on it myself but haven't had a chance yet.  Happy to answer any ABI-related questions if you're ready to take a stab at it.</p>



<a name="529912473"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/529912473" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#529912473">(Jul 21 2025 at 15:14)</a>:</h4>
<p>Thanks I'll make a start.</p>



<a name="530246069"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/530246069" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#530246069">(Jul 23 2025 at 01:04)</a>:</h4>
<p><span class="user-mention" data-user-id="509936">@Joel Dice</span> hi, might take me a few questions to get in the right space with this.  For <br>
<a href="https://github.com/bytecodealliance/wit-bindgen/blob/454d6885b5b54adb3601a9b80ca9ff64f6ed7b8d/tests/codegen/futures.wit#L6">https://github.com/bytecodealliance/wit-bindgen/blob/454d6885b5b54adb3601a9b80ca9ff64f6ed7b8d/tests/codegen/futures.wit#L6</a><br>
We have a function that takes a future as a parameter.  The import of this function sounds like it will in c#, take a <code>Task</code> and lower it to an i32.  But what can the receiver of this <code>i32</code> do with it?  I would expect that it could await the future, but how would it do that?</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wit-bindgen/blob/454d6885b5b54adb3601a9b80ca9ff64f6ed7b8d/tests/codegen/futures.wit#L6" style="background-image: url(&quot;https://uploads.zulipusercontent.net/5d72386f0a8b57f97c674ad0b67fa6da7778b551/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f396163653961306337313835616239626564663338653030393039396439613432376465393362323535343839323364393232336130303530393565366337322f62797465636f6465616c6c69616e63652f7769742d62696e6467656e&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wit-bindgen/blob/454d6885b5b54adb3601a9b80ca9ff64f6ed7b8d/tests/codegen/futures.wit#L6" title="wit-bindgen/tests/codegen/futures.wit at 454d6885b5b54adb3601a9b80ca9ff64f6ed7b8d · bytecodealliance/wit-bindgen">wit-bindgen/tests/codegen/futures.wit at 454d6885b5b54adb3601a9b80ca9ff64f6ed7b8d · bytecodealliance/wit-bindgen</a></div><div class="message_embed_description">A language binding generator for WebAssembly interface types - bytecodealliance/wit-bindgen</div></div></div>



<a name="530250399"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/530250399" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#530250399">(Jul 23 2025 at 02:06)</a>:</h4>
<p>For this single import I think I also need to provide a couple of extra functions , waitable-set-wait, that I must call before the calling the import, and provide a future-poll that the runtime can call to check the state of the future, is that sort of right?</p>



<a name="530666615"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/530666615" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#530666615">(Jul 25 2025 at 00:00)</a>:</h4>
<p>Think I've confused <code>future</code> and <code>async</code>  I will start with just <code>async</code> as that looks simpler</p>



<a name="530792807"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/530792807" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#530792807">(Jul 25 2025 at 14:54)</a>:</h4>
<p>Sorry for the late reply -- I was out on vacation for a few days.</p>
<p>To call an imported function that takes a <code>future</code>, the guest needs to first call <code>future.new</code>, which returns a pair of <code>i32</code> handles -- one representing the writable end (roughly equivalent to a <code>TaskCompletionSource</code>) and the other representing the readable end (roughly equivalent to the <code>Task</code> corresponding to the <code>TaskCompletionSource</code>).  Then it can pass the readable end to the function and later write a value to the writable end when such a value is available.</p>
<p>In the Rust bindings, we represent the writable end as a <a href="https://github.com/bytecodealliance/wit-bindgen/blob/454d6885b5b54adb3601a9b80ca9ff64f6ed7b8d/crates/guest-rust/rt/src/async_support/future_support.rs#L208">FutureWriter</a> and the readable end as a <a href="https://github.com/bytecodealliance/wit-bindgen/blob/454d6885b5b54adb3601a9b80ca9ff64f6ed7b8d/crates/guest-rust/rt/src/async_support/future_support.rs#L535">FutureReader</a>, which implements the <code>std::future::Future</code> trait, allowing it to be <code>await</code>ed.</p>
<p>Anyway, I agree that you'll probably want to start with just supporting the async import and export ABIs before moving on to <code>future</code> and <code>stream</code> support.  Note that a call to an async-lowered import will either return a result immediately or return <code>BLOCKED</code> with a subtask handle representing the status of the call.  That handle may be added to a <code>waitable-set</code>, which in turn may be waited on using either <code>waitable-set.wait</code> or by returning <code>CALLBACK_CODE_WAIT</code> from the async-lifted-with-callback export function that the host originally called the guest on.  The latter is generally preferable when using the callback-based ABI, since it allows the host to make other concurrent calls to the guest.</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wit-bindgen/blob/454d6885b5b54adb3601a9b80ca9ff64f6ed7b8d/crates/guest-rust/rt/src/async_support/future_support.rs#L208" style="background-image: url(&quot;https://uploads.zulipusercontent.net/5d72386f0a8b57f97c674ad0b67fa6da7778b551/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f396163653961306337313835616239626564663338653030393039396439613432376465393362323535343839323364393232336130303530393565366337322f62797465636f6465616c6c69616e63652f7769742d62696e6467656e&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wit-bindgen/blob/454d6885b5b54adb3601a9b80ca9ff64f6ed7b8d/crates/guest-rust/rt/src/async_support/future_support.rs#L208" title="wit-bindgen/crates/guest-rust/rt/src/async_support/future_support.rs at 454d6885b5b54adb3601a9b80ca9ff64f6ed7b8d · bytecodealliance/wit-bindgen">wit-bindgen/crates/guest-rust/rt/src/async_support/future_support.rs at 454d6885b5b54adb3601a9b80ca9ff64f6ed7b8d · bytecodealliance/wit-bindgen</a></div><div class="message_embed_description">A language binding generator for WebAssembly interface types - bytecodealliance/wit-bindgen</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wit-bindgen/blob/454d6885b5b54adb3601a9b80ca9ff64f6ed7b8d/crates/guest-rust/rt/src/async_support/future_support.rs#L535" style="background-image: url(&quot;https://uploads.zulipusercontent.net/5d72386f0a8b57f97c674ad0b67fa6da7778b551/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f396163653961306337313835616239626564663338653030393039396439613432376465393362323535343839323364393232336130303530393565366337322f62797465636f6465616c6c69616e63652f7769742d62696e6467656e&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wit-bindgen/blob/454d6885b5b54adb3601a9b80ca9ff64f6ed7b8d/crates/guest-rust/rt/src/async_support/future_support.rs#L535" title="wit-bindgen/crates/guest-rust/rt/src/async_support/future_support.rs at 454d6885b5b54adb3601a9b80ca9ff64f6ed7b8d · bytecodealliance/wit-bindgen">wit-bindgen/crates/guest-rust/rt/src/async_support/future_support.rs at 454d6885b5b54adb3601a9b80ca9ff64f6ed7b8d · bytecodealliance/wit-bindgen</a></div><div class="message_embed_description">A language binding generator for WebAssembly interface types - bytecodealliance/wit-bindgen</div></div></div>



<a name="530865850"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/530865850" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#530865850">(Jul 25 2025 at 23:49)</a>:</h4>
<p>For every async function we generate a <code>[async-lift]....</code> and a <code>[callback][async-lift]</code> for those 2 scenarios you describe ?</p>



<a name="530866140"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/530866140" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#530866140">(Jul 25 2025 at 23:52)</a>:</h4>
<p>on the export side I'm looking at first</p>



<a name="530920327"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/530920327" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#530920327">(Jul 26 2025 at 09:28)</a>:</h4>
<p>Yes, and the signature of the <code>[async-lift]...</code> function will take the same set of parameters the sync version would, but return an <code>i32</code> representing the "callback code".  The <code>[callback][async-lift]...</code> function will take 3 <code>i32</code> parameters (the first is the event type, and the meaning of the rest depends on the event type) and return an <code>i32</code> callback code.  Either the <code>[async-lift]...</code> or the <code>[callback][async-lift]...</code> function will return its value to the caller by calling the <code>task.return</code> function, whose signature depends on the WIT-level return type of the function being exported.</p>
<p>One way to get a feel for all this is to examine the output of the C bindings generator for various async-lifted exports.</p>



<a name="530946288"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/530946288" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#530946288">(Jul 26 2025 at 13:21)</a>:</h4>
<p>Thanks very much, I should be able to get the first tests passing from here.</p>



<a name="530990707"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/530990707" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#530990707">(Jul 26 2025 at 19:20)</a>:</h4>
<p>are you using a locally built clang to get support for <code>async</code> in wit ?</p>



<a name="530990779"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/530990779" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#530990779">(Jul 26 2025 at 19:20)</a>:</h4>
<p>Ive got</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">C</span><span class="p">:</span><span class="err">\</span><span class="n">github</span><span class="err">\</span><span class="n">wit</span><span class="o">-</span><span class="n">bindgen</span><span class="err">\</span><span class="n">target</span><span class="err">\</span><span class="n">artifacts</span><span class="err">\</span><span class="n">simple</span><span class="o">-</span><span class="n">import</span><span class="o">-</span><span class="n">params</span><span class="o">-</span><span class="n">results</span><span class="err">\</span><span class="n">test</span><span class="o">-</span><span class="n">csharp</span><span class="err">\</span><span class="n">bindings</span><span class="o">&gt;</span><span class="s">"c:\github\wasi-sdk25/bin/clang"</span><span class="w"> </span><span class="o">@</span><span class="n">obj</span><span class="err">\</span><span class="n">Debug</span><span class="err">\</span><span class="n">net9</span><span class="p">.</span><span class="mi">0</span><span class="err">\</span><span class="n">wasi</span><span class="o">-</span><span class="n">wasm</span><span class="err">\</span><span class="n">native</span><span class="err">\</span><span class="n">link</span><span class="p">.</span><span class="n">rsp</span><span class="w"> </span><span class="s">"</span>
<span class="s">error: unable to add component type "</span><span class="n">TestWorld_component_type</span><span class="p">.</span><span class="n">wit</span><span class="s">"</span>

<span class="s">Caused by:</span>
<span class="s">    0: expected keyword `func`, found an identifier</span>
<span class="s">            --&gt; TestWorld_component_type.wit:4:17</span>
<span class="s">             |</span>
<span class="s">           4 |   one-argument: async func(x: u32);</span>
<span class="s">             |                 ^</span>
<span class="s">clang: error: linker command failed with exit code 1 (use -v to see invocation)</span>
</code></pre></div>



<a name="530991699"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/530991699" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#530991699">(Jul 26 2025 at 19:28)</a>:</h4>
<p>I believe clang is calling <code>wasm-component-ld</code>, which is producing that error.  WASI-SDK's version of <code>wasm-component-ld</code> isn't new enough to understand async, so you'll want to replace the one in WASI-SDK with <a href="https://github.com/bytecodealliance/wasm-component-ld/releases/tag/v0.5.15">the latest release</a> (which isn't using the very latest wasm-tools, but it's only one version behind, so should be new enough).</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasm-component-ld/releases/tag/v0.5.15" style="background-image: url(&quot;https://uploads.zulipusercontent.net/71ec5ddeb036b8a411e4a855bea90be9892fcc01/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f646163366639663663386166613937316461663934393935333730353331356461396138346131306663363561386664333534333735616262383961303135322f62797465636f6465616c6c69616e63652f7761736d2d636f6d706f6e656e742d6c642f72656c65617365732f7461672f76302e352e3135&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasm-component-ld/releases/tag/v0.5.15" title="Release v0.5.15 · bytecodealliance/wasm-component-ld">Release v0.5.15 · bytecodealliance/wasm-component-ld</a></div><div class="message_embed_description">Command line linker for creating WebAssembly components - Release v0.5.15 · bytecodealliance/wasm-component-ld</div></div></div>



<a name="530991887"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/530991887" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#530991887">(Jul 26 2025 at 19:29)</a>:</h4>
<p>I've been using <code>wasm-tools</code> directly to convert modules to components and/or embed component type custom sections, so I haven't tried using <code>wasm-component-ld</code> yet -- hopefully it should just work.</p>



<a name="530991946"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/530991946" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#530991946">(Jul 26 2025 at 19:30)</a>:</h4>
<p>lets see :-)</p>



<a name="530995760"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/530995760" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#530995760">(Jul 26 2025 at 20:01)</a>:</h4>
<p>that links at least.  What is the significance of <code>[export]</code> in this c<br>
__attribute__((__import_module__("[export]a:b/i"), __import_name__("[task-return][async]one-argument")))</p>



<a name="530996303"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/530996303" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#530996303">(Jul 26 2025 at 20:06)</a>:</h4>
<p>I understand that this is the callback (task-return) for returning the async result, so it needs some specially handling by the linker I guess.</p>



<a name="530998450"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/530998450" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#530998450">(Jul 26 2025 at 20:24)</a>:</h4>
<p>yeah, that's just the convention we made up and which <code>wit-component</code> recognizes as the import module to expect the task-return function to be imported from.  We use the <code>[export]</code> prefix to indicate that, although this is an import, we're doing the import on behalf of a specific exported function.</p>



<a name="531046891"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/531046891" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#531046891">(Jul 27 2025 at 02:50)</a>:</h4>
<p>thanks, this can all wait until Monday, I'm just asking today.  I have this error</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">------</span><span class="w"> </span><span class="n">Failure</span><span class="p">:</span><span class="w"> </span><span class="nc">simple</span><span class="o">-</span><span class="n">import</span><span class="o">-</span><span class="n">params</span><span class="o">-</span><span class="n">results</span><span class="w"> </span><span class="o">--------</span>
<span class="w">  </span><span class="n">component</span><span class="p">:</span><span class="w"> </span><span class="nc">test</span>
<span class="w">  </span><span class="n">path</span><span class="p">:</span><span class="w"> </span><span class="nc">tests</span><span class="err">\</span><span class="n">runtime</span><span class="o">-</span><span class="k">async</span><span class="err">\</span><span class="k">async</span><span class="err">\</span><span class="n">simple</span><span class="o">-</span><span class="n">import</span><span class="o">-</span><span class="n">params</span><span class="o">-</span><span class="n">results</span><span class="err">\</span><span class="n">test</span><span class="p">.</span><span class="n">cs</span>
<span class="w">  </span><span class="n">error</span><span class="p">:</span><span class="w"> </span><span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">component</span><span class="w"> </span><span class="s">"tests</span><span class="se">\\</span><span class="s">runtime-async</span><span class="se">\\</span><span class="s">async</span><span class="se">\\</span><span class="s">simple-import-params-results</span><span class="se">\\</span><span class="s">test.cs"</span>

<span class="w">  </span><span class="n">Caused</span><span class="w"> </span><span class="n">by</span><span class="p">:</span>
<span class="w">      </span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="nc">compiler</span><span class="w"> </span><span class="n">produced</span><span class="w"> </span><span class="n">invalid</span><span class="w"> </span><span class="n">wasm</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="s">"C:</span><span class="se">\\</span><span class="s">github</span><span class="se">\\</span><span class="s">wit-bindgen</span><span class="se">\\</span><span class="s">.</span><span class="se">\\</span><span class="s">target</span><span class="se">\\</span><span class="s">artifacts</span><span class="se">\\</span><span class="s">simple-import-params-results</span><span class="se">\\</span><span class="s">test-csharp.wasm"</span>
<span class="w">      </span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="nc">lowered</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="n">types</span><span class="w"> </span><span class="err">`</span><span class="p">[]</span><span class="err">`</span><span class="w"> </span><span class="kr">do</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="n">types</span><span class="w"> </span><span class="err">`</span><span class="p">[</span><span class="n">I32</span><span class="p">]</span><span class="err">`</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">core</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="mi">140</span><span class="w"> </span><span class="p">(</span><span class="n">at</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="mh">0xfdd769</span><span class="p">)</span>
<span class="mi">1</span><span class="w"> </span><span class="n">tests</span><span class="w"> </span><span class="n">FAILED</span>
</code></pre></div>
<p>Which seems like I've got the <code>[async-lower]</code> or <code>[async-lift]</code> wrong, but they are both <code>int32 (int32)</code> for a <code>void</code> async that takes an <code>int32</code> which I think is right and the same as the c code gen.  Is there any modification of signatures that goes on <code>wasm-component-ld</code> or <code>wasmtime</code> ?</p>



<a name="531183329"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/531183329" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#531183329">(Jul 27 2025 at 17:49)</a>:</h4>
<p>its a bit weird becuse function 140 is unrelatead</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">   </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="cp">$</span><span class="s">"Thread::ResetCachedTransitionFrame()"</span><span class="w"> </span><span class="p">(;</span><span class="mi">140</span><span class="p">;)</span><span class="w"> </span><span class="p">(</span><span class="k">type</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">param</span><span class="w"> </span><span class="kt">i32</span><span class="p">)</span>
</code></pre></div>



<a name="531218892"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/531218892" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#531218892">(Jul 27 2025 at 21:49)</a>:</h4>
<p>oh, Im reading the <code>alias</code> wrong, but I still don't understand how this works.  The core function for this needs to return the callback code so it will have a result type of <code>i32</code>.  Is it the <code>canon lift</code> on the alias that is incorrect perhaps</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">(</span><span class="k">type</span><span class="w"> </span><span class="p">(;</span><span class="mi">49</span><span class="p">;)</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="p">(</span><span class="n">param</span><span class="w"> </span><span class="s">"x"</span><span class="w"> </span><span class="kt">u32</span><span class="p">)))</span>
<span class="w">  </span><span class="p">(</span><span class="n">alias</span><span class="w"> </span><span class="n">core</span><span class="w"> </span><span class="n">export</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="s">"[async-lift]a:b/i#[async]one-argument"</span><span class="w"> </span><span class="p">(</span><span class="n">core</span><span class="w"> </span><span class="n">func</span><span class="w"> </span><span class="p">(;</span><span class="mi">140</span><span class="p">;)))</span>
<span class="w">  </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="p">(;</span><span class="mi">41</span><span class="p">;)</span><span class="w"> </span><span class="p">(</span><span class="k">type</span><span class="w"> </span><span class="mi">49</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">canon</span><span class="w"> </span><span class="n">lift</span><span class="w"> </span><span class="p">(</span><span class="n">core</span><span class="w"> </span><span class="n">func</span><span class="w"> </span><span class="mi">140</span><span class="p">)</span><span class="w"> </span><span class="k">async</span><span class="p">))</span>
<span class="w">  </span><span class="p">(</span><span class="n">component</span><span class="w"> </span><span class="p">(;</span><span class="mi">0</span><span class="p">;)</span>
<span class="w">    </span><span class="p">(</span><span class="k">type</span><span class="w"> </span><span class="p">(;</span><span class="mi">0</span><span class="p">;)</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="p">(</span><span class="n">param</span><span class="w"> </span><span class="s">"x"</span><span class="w"> </span><span class="kt">u32</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="n">import</span><span class="w"> </span><span class="s">"import-func-one-argument"</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="p">(;</span><span class="mi">0</span><span class="p">;)</span><span class="w"> </span><span class="p">(</span><span class="k">type</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="k">type</span><span class="w"> </span><span class="p">(;</span><span class="mi">1</span><span class="p">;)</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="p">(</span><span class="n">param</span><span class="w"> </span><span class="s">"x"</span><span class="w"> </span><span class="kt">u32</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="n">export</span><span class="w"> </span><span class="p">(;</span><span class="mi">1</span><span class="p">;)</span><span class="w"> </span><span class="s">"[async]one-argument"</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="p">(</span><span class="k">type</span><span class="w"> </span><span class="mi">1</span><span class="p">)))</span>
<span class="w">  </span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="n">instance</span><span class="w"> </span><span class="p">(;</span><span class="mi">20</span><span class="p">;)</span><span class="w"> </span><span class="p">(</span><span class="n">instantiate</span><span class="w"> </span><span class="mi">0</span>
<span class="w">      </span><span class="p">(</span><span class="n">with</span><span class="w"> </span><span class="s">"import-func-one-argument"</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="mi">41</span><span class="p">))</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">  </span><span class="p">)</span>
</code></pre></div>



<a name="531224126"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/531224126" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#531224126">(Jul 27 2025 at 22:25)</a>:</h4>
<p>I' m going to dig further into wasm-component-ld as I suspect something there currently.  I'm probably wrong, but need to see if what you do , generating the sections manually, fixes things</p>



<a name="531378514"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/531378514" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#531378514">(Jul 28 2025 at 14:00)</a>:</h4>
<p>If you can point me to a branch with your changes and instructions for reproducing the issue, I can take a look.</p>



<a name="531382851"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/531382851" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#531382851">(Jul 28 2025 at 14:18)</a>:</h4>
<p>Thanks very much, I wonder if its because I've got 2 wits in the link, haven't investigated that yet.<br>
<a href="https://github.com/yowl/cs-wit-bindgen/tree/csharp-async-simple">https://github.com/yowl/cs-wit-bindgen/tree/csharp-async-simple</a></p>
<p>Download wasi sdk 25 and replace wasm-component-ld, Im using a locally built one from main yesterday.<br>
Then <code>cargo build</code><br>
and  </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="o">--</span><span class="n">languages</span><span class="w"> </span><span class="n">csharp</span><span class="w"> </span><span class="n">tests</span><span class="err">\</span><span class="n">runtime</span><span class="o">-</span><span class="k">async</span><span class="w"> </span><span class="o">--</span><span class="n">artifacts</span><span class="w"> </span><span class="p">.</span><span class="err">\</span><span class="n">target</span><span class="err">\</span><span class="n">artifacts</span><span class="w"> </span><span class="o">--</span><span class="n">rust</span><span class="o">-</span><span class="n">wit</span><span class="o">-</span><span class="n">bindgen</span><span class="o">-</span><span class="n">path</span><span class="w"> </span><span class="p">.</span><span class="err">\</span><span class="n">crates</span><span class="err">\</span><span class="n">guest</span><span class="o">-</span><span class="n">rust</span><span class="w"> </span><span class="o">--</span><span class="n">runner</span><span class="w"> </span><span class="s">"wasmtime -W component-model-async"</span>
</code></pre></div>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/yowl/cs-wit-bindgen/tree/csharp-async-simple" style="background-image: url(&quot;https://uploads.zulipusercontent.net/938da4ff5fbc0b4206866958751d15811846828f/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f396337373635363035343461666431323461306331653065633331616262626234363632336336356333636432353431366534623738646331633837343033372f796f776c2f63732d7769742d62696e6467656e&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/yowl/cs-wit-bindgen/tree/csharp-async-simple" title="GitHub - yowl/cs-wit-bindgen at csharp-async-simple">GitHub - yowl/cs-wit-bindgen at csharp-async-simple</a></div><div class="message_embed_description">Testing wit-bindgen for c# and NativeAOT-LLVM. Contribute to yowl/cs-wit-bindgen development by creating an account on GitHub.</div></div></div>



<a name="531383051"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/531383051" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#531383051">(Jul 28 2025 at 14:19)</a>:</h4>
<p>Thanks.  I've got a bunch of meetings this morning, but I'll dig in later today.</p>



<a name="531383127"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/531383127" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#531383127">(Jul 28 2025 at 14:19)</a>:</h4>
<p>I'm not totally stuck yet, I can do more research later if you have better things to do.</p>



<a name="531430533"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/531430533" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#531430533">(Jul 28 2025 at 18:15)</a>:</h4>
<p>Okay, I reproduced this on my end.  It looks like <code>wit-component</code> is getting confused and generating an async lift <em>without</em> a callback because the core module is not exporting a callback function.  It <em>should</em> be rejecting the module when it sees that you're using the with-callback ABI but not providing a callback, but instead it produces a component that fails validation.  I'll fix the <code>wit-component</code> issue so we can catch the problem there (and hopefully provide a clearer diagnostic).</p>
<p>Meanwhile, maybe you can dig into why the generated C# code is not exporting a callback function.</p>



<a name="531430855"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/531430855" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#531430855">(Jul 28 2025 at 18:17)</a>:</h4>
<p>Ah thanks, right, I haven't implemented that bit yet as I don't think it will be on the call path yet.  But definitely I need to do it, so might as well be now</p>



<a name="531618822"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/531618822" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#531618822">(Jul 29 2025 at 14:03)</a>:</h4>
<p>Great, that seesm to be passing the first test.  Thanks very much.</p>



<a name="531965009"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/531965009" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#531965009">(Jul 31 2025 at 02:11)</a>:</h4>
<p>WIth an async function that returns a value, not void, I understand that it takes an extra pointer parameter is passed .  How does that relate to the <code>task-return</code> or the pointer is nothing to do with the return value, but is just used by the runtime?  What should this pointer  point to ?</p>



<a name="532080217"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/532080217" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#532080217">(Jul 31 2025 at 13:50)</a>:</h4>
<p>Are you referring to the async <em>lower</em> ABI?  If so, yes, the core signature of an async lowered function will include an extra parameter if the component-level signature returns a value, and that must point to an allocation in linear memory which is aligned and sized correctly for the result to be stored.  <code>task-return</code> isn't relevant here because we're talking about lowering imports, not lifting exports.</p>
<p>The async <em>lift</em> ABI has no such result pointer parameter, since <code>task-return</code> is used to return the result, if any.  The main thing to keep in mind is that the lift and lower ABIs are different.</p>



<a name="532157031"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/532157031" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#532157031">(Jul 31 2025 at 19:56)</a>:</h4>
<p>Thank you!</p>



<a name="532390208"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/532390208" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#532390208">(Aug 01 2025 at 23:01)</a>:</h4>
<p>I see the codegen tests use the <code>waitable-...</code> way of returning , is the <code>[task-return]</code>flow well tested ?</p>



<a name="532395278"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/532395278" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#532395278">(Aug 02 2025 at 00:05)</a>:</h4>
<p>ignore that, I see the c tests use it.</p>



<a name="534720917"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/534720917" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#534720917">(Aug 15 2025 at 22:43)</a>:</h4>
<p>I have a question about the c test for simple-future.  There are 2 functions in the wit<br>
<a href="https://github.com/bytecodealliance/wit-bindgen/blob/eaf42f6c12d9cca8231d5a361d20b6c21c2a2739/tests/runtime-async/async/simple-future/test.wit#L4-L5">https://github.com/bytecodealliance/wit-bindgen/blob/eaf42f6c12d9cca8231d5a361d20b6c21c2a2739/tests/runtime-async/async/simple-future/test.wit#L4-L5</a><br>
Looking at the test for <code>drop-future</code> where it writes to the writer:<br>
<a href="https://github.com/bytecodealliance/wit-bindgen/blob/eaf42f6c12d9cca8231d5a361d20b6c21c2a2739/tests/runtime-async/async/simple-future/runner.c#L34">https://github.com/bytecodealliance/wit-bindgen/blob/eaf42f6c12d9cca8231d5a361d20b6c21c2a2739/tests/runtime-async/async/simple-future/runner.c#L34</a><br>
It calls <code>test_future_void_write</code> which is generated as </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">runner_waitable_status_t</span><span class="w"> </span><span class="n">test_future_void_write</span><span class="p">(</span><span class="n">test_future_void_writer_t</span><span class="w"> </span><span class="n">writer</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">test_future_void__write</span><span class="p">(</span><span class="n">writer</span><span class="p">,</span><span class="w"> </span><span class="n">NULL</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>which in turn calls <code>test_future_void__write</code> defined as </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">__attribute__</span><span class="p">((</span><span class="n">__import_module__</span><span class="p">(</span><span class="s">"my:test/i"</span><span class="p">),</span><span class="w"> </span><span class="n">__import_name__</span><span class="p">(</span><span class="s">"[async-lower][future-write-0][async]read-future"</span><span class="p">)))</span>
<span class="k">extern</span><span class="w"> </span><span class="n">uint32_t</span><span class="w"> </span><span class="n">test_future_void__write</span><span class="p">(</span><span class="n">uint32_t</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">uint8_t</span><span class="o">*</span><span class="p">);</span>
</code></pre></div>
<p>Which has the import name for the <code>read-future</code> function.  What am I missing here?</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wit-bindgen/blob/eaf42f6c12d9cca8231d5a361d20b6c21c2a2739/tests/runtime-async/async/simple-future/test.wit#L4-L5" style="background-image: url(&quot;https://uploads.zulipusercontent.net/50cd0505ad3a8575e79246c21a37b2737823449e/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f396633643162306531386134363863376234383163343734366363616634323461333366353336613261393134626430613836376139316365353664373734362f62797465636f6465616c6c69616e63652f7769742d62696e6467656e&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wit-bindgen/blob/eaf42f6c12d9cca8231d5a361d20b6c21c2a2739/tests/runtime-async/async/simple-future/test.wit#L4-L5" title="wit-bindgen/tests/runtime-async/async/simple-future/test.wit at eaf42f6c12d9cca8231d5a361d20b6c21c2a2739 · bytecodealliance/wit-bindgen">wit-bindgen/tests/runtime-async/async/simple-future/test.wit at eaf42f6c12d9cca8231d5a361d20b6c21c2a2739 · bytecodealliance/wit-bindgen</a></div><div class="message_embed_description">A language binding generator for WebAssembly interface types - bytecodealliance/wit-bindgen</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wit-bindgen/blob/eaf42f6c12d9cca8231d5a361d20b6c21c2a2739/tests/runtime-async/async/simple-future/runner.c#L34" style="background-image: url(&quot;https://uploads.zulipusercontent.net/50cd0505ad3a8575e79246c21a37b2737823449e/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f396633643162306531386134363863376234383163343734366363616634323461333366353336613261393134626430613836376139316365353664373734362f62797465636f6465616c6c69616e63652f7769742d62696e6467656e&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wit-bindgen/blob/eaf42f6c12d9cca8231d5a361d20b6c21c2a2739/tests/runtime-async/async/simple-future/runner.c#L34" title="wit-bindgen/tests/runtime-async/async/simple-future/runner.c at eaf42f6c12d9cca8231d5a361d20b6c21c2a2739 · bytecodealliance/wit-bindgen">wit-bindgen/tests/runtime-async/async/simple-future/runner.c at eaf42f6c12d9cca8231d5a361d20b6c21c2a2739 · bytecodealliance/wit-bindgen</a></div><div class="message_embed_description">A language binding generator for WebAssembly interface types - bytecodealliance/wit-bindgen</div></div></div>



<a name="534720976"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/534720976" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#534720976">(Aug 15 2025 at 22:44)</a>:</h4>
<p>I.e., I would expect to see an import for <code>drop-future</code>.</p>



<a name="534721063"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/534721063" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#534721063">(Aug 15 2025 at 22:45)</a>:</h4>
<p>Is it that internally any "void future" would work here, due to some internal things.  I think I read that only one task (subtask?) can be active at a time?</p>



<a name="534721911"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/534721911" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#534721911">(Aug 15 2025 at 22:59)</a>:</h4>
<p>I'm not sure I understand what you're asking, but note that we use a "trick" to refer to a given <code>future</code> or <code>stream</code> type in the binding generator, allowing <code>wit-component</code> to determine which type to use when generating references to the <code>future.write</code>, <code>future.drop</code>, etc. intrinsics: <a href="https://github.com/bytecodealliance/wasm-tools/blob/f6967282dce8f2b3be29ddcd0f33cb90a37ec8f4/crates/wit-parser/src/lib.rs#L1160-L1174">https://github.com/bytecodealliance/wasm-tools/blob/f6967282dce8f2b3be29ddcd0f33cb90a37ec8f4/crates/wit-parser/src/lib.rs#L1160-L1174</a></p>
<p>Trying to encode the entire type using only e.g. name mangling would be difficult if not impossible (imagine mangling <code>future&lt;list&lt;tuple&lt;some-record, some-resource-type&gt;&gt;&gt;</code>, especially given that resource types are not necessarily uniquely identified by their names, e.g. when a resource is both imported and exported), so we instead refer to some arbitrary function that uses the type we care about and use an index to indicate which one we mean.</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasm-tools/blob/f6967282dce8f2b3be29ddcd0f33cb90a37ec8f4/crates/wit-parser/src/lib.rs#L1160-L1174" style="background-image: url(&quot;https://uploads.zulipusercontent.net/0ea15d01313588cf5bf18f41153bad82b4a26ef6/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f623530353532303430643463363031303634303366623439663861623665363130343836663965303731613037633835363634306138336130616565376432382f62797465636f6465616c6c69616e63652f7761736d2d746f6f6c73&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasm-tools/blob/f6967282dce8f2b3be29ddcd0f33cb90a37ec8f4/crates/wit-parser/src/lib.rs#L1160-L1174" title="wasm-tools/crates/wit-parser/src/lib.rs at f6967282dce8f2b3be29ddcd0f33cb90a37ec8f4 · bytecodealliance/wasm-tools">wasm-tools/crates/wit-parser/src/lib.rs at f6967282dce8f2b3be29ddcd0f33cb90a37ec8f4 · bytecodealliance/wasm-tools</a></div><div class="message_embed_description"> CLI and Rust libraries for low-level manipulation of WebAssembly modules  - bytecodealliance/wasm-tools</div></div></div>



<a name="534722313"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/534722313" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Scott Waye <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#534722313">(Aug 15 2025 at 23:04)</a>:</h4>
<p>I'm curious about <code>read-future</code> in the name of the import used by the <code>drop-future</code> test.  Reading the link you posted, and your explanation, I think I get it.  The type is the same, so the name at the end of the import is not that important, its the type that must be matched.</p>



<a name="534767133"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/407028-C%23/.net-collaboration/topic/wit-bindgen%20async/future/near/534767133" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Joel Dice <a href="https://bytecodealliance.github.io/zulip-archive/stream/407028-C.23.2F.2Enet-collaboration/topic/wit-bindgen.20async.2Ffuture.html#534767133">(Aug 16 2025 at 14:53)</a>:</h4>
<p>Yeah, the point is to pick a function that refers to the type -- if there is more than one which refers to that type, then the binding generator picks one arbitrarily and uses it.</p>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
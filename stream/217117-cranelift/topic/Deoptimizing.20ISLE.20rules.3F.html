<html>
<head><meta charset="utf-8"><title>Deoptimizing ISLE rules? · cranelift · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/index.html">cranelift</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Deoptimizing.20ISLE.20rules.3F.html">Deoptimizing ISLE rules?</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="558884660"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Deoptimizing%20ISLE%20rules%3F/near/558884660" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bongjun Jang <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Deoptimizing.20ISLE.20rules.3F.html#558884660">(Nov 23 2025 at 10:33)</a>:</h4>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/68a6afd4f925724fd359c13a27fac5a6163d12f4/cranelift/codegen/src/opts/bitops.isle#L44-L50">https://github.com/bytecodealliance/wasmtime/blob/68a6afd4f925724fd359c13a27fac5a6163d12f4/cranelift/codegen/src/opts/bitops.isle#L44-L50</a></p>
<p>Hi, reading mid-end optimizations in ISLE, I noticed that these rules increase cost which defined in <a href="https://github.com/bytecodealliance/wasmtime/blob/68a6afd4f925724fd359c13a27fac5a6163d12f4/cranelift/codegen/src/egraph/cost.rs#L111-L132">https://github.com/bytecodealliance/wasmtime/blob/68a6afd4f925724fd359c13a27fac5a6163d12f4/cranelift/codegen/src/egraph/cost.rs#L111-L132</a>.<br>
Is there a rationale why such rules exist? I think this is opposed to the first rule writing mid-end opts in ISLE stated at <a href="https://github.com/bytecodealliance/wasmtime/blob/68a6afd4f925724fd359c13a27fac5a6163d12f4/cranelift/codegen/src/opts/README.md">https://github.com/bytecodealliance/wasmtime/blob/68a6afd4f925724fd359c13a27fac5a6163d12f4/cranelift/codegen/src/opts/README.md</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/blob/68a6afd4f925724fd359c13a27fac5a6163d12f4/cranelift/codegen/src/opts/bitops.isle#L44-L50" style="background-image: url(&quot;https://uploads.zulipusercontent.net/4176f6de7ac20f6e6830f90d3f2ad197998dafea/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f376336643565376435343430623533363230343364353462346437313432623931616633393463623338336464316333373838636439303661346136643466322f62797465636f6465616c6c69616e63652f7761736d74696d65&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/blob/68a6afd4f925724fd359c13a27fac5a6163d12f4/cranelift/codegen/src/opts/bitops.isle#L44-L50" title="wasmtime/cranelift/codegen/src/opts/bitops.isle at 68a6afd4f925724fd359c13a27fac5a6163d12f4 · bytecodealliance/wasmtime">wasmtime/cranelift/codegen/src/opts/bitops.isle at 68a6afd4f925724fd359c13a27fac5a6163d12f4 · bytecodealliance/wasmtime</a></div><div class="message_embed_description">A lightweight WebAssembly runtime that is fast, secure, and standards-compliant - bytecodealliance/wasmtime</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/blob/68a6afd4f925724fd359c13a27fac5a6163d12f4/cranelift/codegen/src/egraph/cost.rs#L111-L132" style="background-image: url(&quot;https://uploads.zulipusercontent.net/4176f6de7ac20f6e6830f90d3f2ad197998dafea/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f376336643565376435343430623533363230343364353462346437313432623931616633393463623338336464316333373838636439303661346136643466322f62797465636f6465616c6c69616e63652f7761736d74696d65&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/blob/68a6afd4f925724fd359c13a27fac5a6163d12f4/cranelift/codegen/src/egraph/cost.rs#L111-L132" title="wasmtime/cranelift/codegen/src/egraph/cost.rs at 68a6afd4f925724fd359c13a27fac5a6163d12f4 · bytecodealliance/wasmtime">wasmtime/cranelift/codegen/src/egraph/cost.rs at 68a6afd4f925724fd359c13a27fac5a6163d12f4 · bytecodealliance/wasmtime</a></div><div class="message_embed_description">A lightweight WebAssembly runtime that is fast, secure, and standards-compliant - bytecodealliance/wasmtime</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/blob/68a6afd4f925724fd359c13a27fac5a6163d12f4/cranelift/codegen/src/opts/README.md" style="background-image: url(&quot;https://uploads.zulipusercontent.net/4176f6de7ac20f6e6830f90d3f2ad197998dafea/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f376336643565376435343430623533363230343364353462346437313432623931616633393463623338336464316333373838636439303661346136643466322f62797465636f6465616c6c69616e63652f7761736d74696d65&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/blob/68a6afd4f925724fd359c13a27fac5a6163d12f4/cranelift/codegen/src/opts/README.md" title="wasmtime/cranelift/codegen/src/opts/README.md at 68a6afd4f925724fd359c13a27fac5a6163d12f4 · bytecodealliance/wasmtime">wasmtime/cranelift/codegen/src/opts/README.md at 68a6afd4f925724fd359c13a27fac5a6163d12f4 · bytecodealliance/wasmtime</a></div><div class="message_embed_description">A lightweight WebAssembly runtime that is fast, secure, and standards-compliant - bytecodealliance/wasmtime</div></div></div>



<a name="558917700"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Deoptimizing%20ISLE%20rules%3F/near/558917700" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Deoptimizing.20ISLE.20rules.3F.html#558917700">(Nov 23 2025 at 19:42)</a>:</h4>
<p>The first rule there is a guideline, but not a hard rule (the system doesn't depend on always-reducing cost as an invariant). In the specific case you linked, it is a kind of <em>normalization</em>: the idea is that we want to simplify possibly deeply nested bit-op expressions and the way we do that is by "pushing NOTs down the tree" to the leaves</p>



<a name="558959872"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Deoptimizing%20ISLE%20rules%3F/near/558959872" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bongjun Jang <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Deoptimizing.20ISLE.20rules.3F.html#558959872">(Nov 24 2025 at 06:30)</a>:</h4>
<p>thanks for the reply. normalization (constant operand to right, etc) can help improve the execution performance in general, but how does "pushing NOTs down the tree"  improve performance? Is there any possibility or evidence that it can lead to better codegen/optimization opportunity for this case?</p>



<a name="558985718"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Deoptimizing%20ISLE%20rules%3F/near/558985718" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Jacob Lifshay <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Deoptimizing.20ISLE.20rules.3F.html#558985718">(Nov 24 2025 at 09:11)</a>:</h4>
<p>afaik the general idea of e-graphs (what ISLE is mostly used for) is that it generates a bunch of different equivalent expressions for your code and then picks the least expensive one, so some of the expression transformations may make it more expensive only for later optimizations to make it even less expensive.<br>
e.g. if you're optimizing <code>((a == b) &amp; !c) &amp; !d</code>, just doing the de-morgan rule once would give you <code>!(!((a == b) &amp; !c) | !!d)</code> which is a bit more expensive, but that can be further optimized to <code>!((a != b) | c) | d</code> which has one less instruction than the original expression.</p>



<a name="560043625"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Deoptimizing%20ISLE%20rules%3F/near/560043625" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Deoptimizing.20ISLE.20rules.3F.html#560043625">(Nov 24 2025 at 23:56)</a>:</h4>
<p>Yes, and in general, pushing boolean expressions toward a normal form allows expressions to GVN together more. I don't have ready examples or data for that, but it's a general compilers-transformation principle. I would consider these rules part of the same family as the push-constants-to-the-right-and-reassociate rules that let cprop work better.</p>



<a name="560043751"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Deoptimizing%20ISLE%20rules%3F/near/560043751" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Deoptimizing.20ISLE.20rules.3F.html#560043751">(Nov 24 2025 at 23:57)</a>:</h4>
<p>(Note to researchers: getting data on how individual rules, and combinations of rules together, bring optimization benefit -- i.e., somehow finding a way to attribute "credit" to rules -- would be really neat and a way to talk about all this more objectively)</p>



<a name="560086655"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Deoptimizing%20ISLE%20rules%3F/near/560086655" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bongjun Jang <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Deoptimizing.20ISLE.20rules.3F.html#560086655">(Nov 25 2025 at 07:50)</a>:</h4>
<p>Hi, I uploaded performance evaluation data of removing the rules in wasmtime Github: <a href="https://github.com/bytecodealliance/wasmtime/issues/12086">https://github.com/bytecodealliance/wasmtime/issues/12086</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/issues/12086" style="background-image: url(&quot;https://uploads.zulipusercontent.net/a7f99053fdf3618b1b5d8aafa3dde374dd31a99b/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f623361393534336433623032386365393637633961393839366139613033313533376237346631363662613264333239356461636563653634653839306131372f62797465636f6465616c6c69616e63652f7761736d74696d652f6973737565732f3132303836&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/issues/12086" title="Cranelift: deoptimizing rules in ISLE · Issue #12086 · bytecodealliance/wasmtime">Cranelift: deoptimizing rules in ISLE · Issue #12086 · bytecodealliance/wasmtime</a></div><div class="message_embed_description">Hi, this is a follow up from #cranelift &gt; Deoptimizing ISLE rules?. As mentioned in the Zulip topic above, I suspect these ISLE rules can degrade performance, since it can increase the number of in...</div></div></div>



<hr><p>Last updated: Feb 22 2026 at 11:05 UTC</p>
</html>
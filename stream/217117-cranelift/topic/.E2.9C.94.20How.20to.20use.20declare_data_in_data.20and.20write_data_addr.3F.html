<html>
<head><meta charset="utf-8"><title>✔ How to use declare_data_in_data and write_data_addr? · cranelift · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/index.html">cranelift</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20How.20to.20use.20declare_data_in_data.20and.20write_data_addr.3F.html">✔ How to use declare_data_in_data and write_data_addr?</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="536720646"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20How%20to%20use%20declare_data_in_data%20and%20write_data_addr%3F/near/536720646" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Adel Prokurov <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20How.20to.20use.20declare_data_in_data.20and.20write_data_addr.3F.html#536720646">(Aug 29 2025 at 05:30)</a>:</h4>
<p>Hello! I am writing a compiler for Scheme and have to initialize <code>GLOBALS</code> array for GC to trace globals. This array is initialized like this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">globals_array</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span>
<span class="w">            </span><span class="p">.</span><span class="n">module</span>
<span class="w">            </span><span class="p">.</span><span class="n">declare_data</span><span class="p">(</span><span class="s">"CAPY_GLOBALS"</span><span class="p">,</span><span class="w"> </span><span class="n">Linkage</span><span class="p">::</span><span class="n">Export</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">desc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DataDescription</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<span class="w">        </span><span class="n">desc</span><span class="p">.</span><span class="n">set_align</span><span class="p">(</span><span class="n">size_of</span><span class="p">::</span><span class="o">&lt;</span><span class="kt">usize</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">_</span><span class="p">);</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">datas</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span>
<span class="w">            </span><span class="p">.</span><span class="n">constants</span>
<span class="w">            </span><span class="p">.</span><span class="n">values</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="n">copied</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="n">chain</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">cache_cells</span><span class="p">.</span><span class="n">values</span><span class="p">().</span><span class="n">copied</span><span class="p">());</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">datas</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">gv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">module</span><span class="p">.</span><span class="n">declare_data_in_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">desc</span><span class="p">);</span>

<span class="w">            </span><span class="n">desc</span><span class="p">.</span><span class="n">write_data_addr</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="n">gv</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">            </span><span class="n">offset</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">desc</span><span class="p">.</span><span class="n">define_zeroinit</span><span class="p">(</span><span class="n">offset</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">);</span>

<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">module</span><span class="p">.</span><span class="n">define_data</span><span class="p">(</span><span class="n">globals_array</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">desc</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
</code></pre></div>
<p>but when I load produced shared-library using <code>dlopen</code> and then <code>dlsym</code> the array it is not populated with anyfing but fully zeroed, is that expected?</p>



<a name="536720665"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20How%20to%20use%20declare_data_in_data%20and%20write_data_addr%3F/near/536720665" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Adel Prokurov <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20How.20to.20use.20declare_data_in_data.20and.20write_data_addr.3F.html#536720665">(Aug 29 2025 at 05:30)</a>:</h4>
<p>what would be the correct way to put addresses of all constants into that array?</p>



<a name="536721029"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20How%20to%20use%20declare_data_in_data%20and%20write_data_addr%3F/near/536721029" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Adel Prokurov <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20How.20to.20use.20declare_data_in_data.20and.20write_data_addr.3F.html#536721029">(Aug 29 2025 at 05:34)</a>:</h4>
<p>Oh apparently I had to use <code>.define(vec![0; offset])</code> instead of zeroinit, that makes this thing work properly.</p>



<a name="536721031"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20How%20to%20use%20declare_data_in_data%20and%20write_data_addr%3F/near/536721031" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20How.20to.20use.20declare_data_in_data.20and.20write_data_addr.3F.html#536721031">(Aug 29 2025 at 05:34)</a>:</h4>
<p><span class="user-mention silent" data-user-id="382336">Adel Prokurov</span> has marked this topic as resolved.</p>



<hr><p>Last updated: Feb 22 2026 at 11:05 UTC</p>
</html>
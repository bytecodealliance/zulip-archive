<html>
<head><meta charset="utf-8"><title>Interleaving `Inst` and `Value` nodes? · cranelift · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/index.html">cranelift</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Interleaving.20.60Inst.60.20and.20.60Value.60.20nodes.3F.html">Interleaving `Inst` and `Value` nodes?</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="545821402"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Interleaving%20%60Inst%60%20and%20%60Value%60%20nodes%3F/near/545821402" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bongjun Jang <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Interleaving.20.60Inst.60.20and.20.60Value.60.20nodes.3F.html#545821402">(Oct 19 2025 at 10:55)</a>:</h4>
<p>Hi, I'm interested in writing an optimization <code>(((X / Y) = N) = ((Y * N) = X))</code> in ISLE.<br>
The left-hand side will have something like <code>(icmp (IntCC.Equal) (udiv x y) ...)</code>.<br>
However, the problem is that the <code>udiv</code> term yields an <code>Inst</code> node while the <code>icmp</code> term requires <code>Value</code> nodes as operands.<br>
It makes writing such a rule very difficult.</p>
<p>Is there any walkaround possible in ISLE? Thank you!</p>



<a name="545866491"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Interleaving%20%60Inst%60%20and%20%60Value%60%20nodes%3F/near/545866491" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Interleaving.20.60Inst.60.20and.20.60Value.60.20nodes.3F.html#545866491">(Oct 20 2025 at 00:14)</a>:</h4>
<p>It looks like there is some glue missing here:</p>
<ul>
<li>In the lowering prelude of ISLE (i.e., a different set of definitions/bindings used when compiling machine backends, rather than mid-end opt rules), we have an auto-converter defined <a href="https://github.com/bytecodealliance/wasmtime/blob/bd7b59dad0923097760eb73103582252fcd2f408/cranelift/codegen/src/prelude_lower.isle#L1192">here</a>.</li>
<li>We define the corresponding Rust helper <a href="https://github.com/bytecodealliance/wasmtime/blob/bd7b59dad0923097760eb73103582252fcd2f408/cranelift/codegen/src/isle_prelude.rs#L939">here</a>, i.e. present for both mid-end and lowering environments.</li>
<li>We define the actual FFI signature <a href="https://github.com/bytecodealliance/wasmtime/blob/bd7b59dad0923097760eb73103582252fcd2f408/cranelift/codegen/src/prelude.isle#L43-L46">here</a>, i.e., also common to both environments. </li>
<li>
<p>So it appears that the only missing piece is moving the</p>
<p><code>
(convert Inst Value def_inst)
</code></p>
<p>line from the lowering-specific prelude to the common prelude. I just checked that doing so causes a simple rule of the form you show to typecheck in the mid-end. (I didn't take the time to come up with a <em>valid</em> rule and check its full execution but please let me know if that doesn't work!)</p>
</li>
</ul>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/blob/bd7b59dad0923097760eb73103582252fcd2f408/cranelift/codegen/src/prelude_lower.isle#L1192" style="background-image: url(&quot;https://uploads.zulipusercontent.net/fd8cc1e57b91f7a120ad0010773aee0b7a9e9508/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f633665353136363961363565333065383434326638316335336336363961663064666363366334643766336131323563303961346132323563313463303762342f62797465636f6465616c6c69616e63652f7761736d74696d65&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/blob/bd7b59dad0923097760eb73103582252fcd2f408/cranelift/codegen/src/prelude_lower.isle#L1192" title="wasmtime/cranelift/codegen/src/prelude_lower.isle at bd7b59dad0923097760eb73103582252fcd2f408 · bytecodealliance/wasmtime">wasmtime/cranelift/codegen/src/prelude_lower.isle at bd7b59dad0923097760eb73103582252fcd2f408 · bytecodealliance/wasmtime</a></div><div class="message_embed_description">A lightweight WebAssembly runtime that is fast, secure, and standards-compliant - bytecodealliance/wasmtime</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/blob/bd7b59dad0923097760eb73103582252fcd2f408/cranelift/codegen/src/isle_prelude.rs#L939" style="background-image: url(&quot;https://uploads.zulipusercontent.net/fd8cc1e57b91f7a120ad0010773aee0b7a9e9508/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f633665353136363961363565333065383434326638316335336336363961663064666363366334643766336131323563303961346132323563313463303762342f62797465636f6465616c6c69616e63652f7761736d74696d65&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/blob/bd7b59dad0923097760eb73103582252fcd2f408/cranelift/codegen/src/isle_prelude.rs#L939" title="wasmtime/cranelift/codegen/src/isle_prelude.rs at bd7b59dad0923097760eb73103582252fcd2f408 · bytecodealliance/wasmtime">wasmtime/cranelift/codegen/src/isle_prelude.rs at bd7b59dad0923097760eb73103582252fcd2f408 · bytecodealliance/wasmtime</a></div><div class="message_embed_description">A lightweight WebAssembly runtime that is fast, secure, and standards-compliant - bytecodealliance/wasmtime</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/blob/bd7b59dad0923097760eb73103582252fcd2f408/cranelift/codegen/src/prelude.isle#L43-L46" style="background-image: url(&quot;https://uploads.zulipusercontent.net/fd8cc1e57b91f7a120ad0010773aee0b7a9e9508/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f633665353136363961363565333065383434326638316335336336363961663064666363366334643766336131323563303961346132323563313463303762342f62797465636f6465616c6c69616e63652f7761736d74696d65&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/blob/bd7b59dad0923097760eb73103582252fcd2f408/cranelift/codegen/src/prelude.isle#L43-L46" title="wasmtime/cranelift/codegen/src/prelude.isle at bd7b59dad0923097760eb73103582252fcd2f408 · bytecodealliance/wasmtime">wasmtime/cranelift/codegen/src/prelude.isle at bd7b59dad0923097760eb73103582252fcd2f408 · bytecodealliance/wasmtime</a></div><div class="message_embed_description">A lightweight WebAssembly runtime that is fast, secure, and standards-compliant - bytecodealliance/wasmtime</div></div></div>



<a name="545866531"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Interleaving%20%60Inst%60%20and%20%60Value%60%20nodes%3F/near/545866531" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Interleaving.20.60Inst.60.20and.20.60Value.60.20nodes.3F.html#545866531">(Oct 20 2025 at 00:15)</a>:</h4>
<p>Feel free to do so as part of an upcoming PR if you have one, or separately and tag me for review, either way.</p>



<a name="545866578"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Interleaving%20%60Inst%60%20and%20%60Value%60%20nodes%3F/near/545866578" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Interleaving.20.60Inst.60.20and.20.60Value.60.20nodes.3F.html#545866578">(Oct 20 2025 at 00:17)</a>:</h4>
<p>(and, goes without saying but: thank you for continuing to work on optimizations of this sort! the slow but steady improvements to our codegen are greatly appreciated)</p>



<a name="545868347"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Interleaving%20%60Inst%60%20and%20%60Value%60%20nodes%3F/near/545868347" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bongjun Jang <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Interleaving.20.60Inst.60.20and.20.60Value.60.20nodes.3F.html#545868347">(Oct 20 2025 at 00:52)</a>:</h4>
<p>Thank you for the detailed answer! I'm trying to generate valid ISLE rules as many as possible.</p>
<p>For that you mentioned improvements for cranelift's codegen,<br>
I wonder if we can precisely measure the improvements on generated code, and the compilation overhead. At the moment, I can think of running cranelift on some benchmarks and measure the time spent. Is there any established method for Cranelift per se?</p>



<a name="545880021"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Interleaving%20%60Inst%60%20and%20%60Value%60%20nodes%3F/near/545880021" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Interleaving.20.60Inst.60.20and.20.60Value.60.20nodes.3F.html#545880021">(Oct 20 2025 at 04:14)</a>:</h4>
<p>We normally use <a href="https://github.com/bytecodealliance/sightglass/">Sightglass</a> for that; see <a href="https://github.com/bytecodealliance/sightglass/?tab=readme-ov-file#comparing-a-feature-branch-to-main">this part</a> of the readme in particular showing how to build two different <code>.so</code>s from Wasmtime and compare them</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/sightglass/" style="background-image: url(&quot;https://uploads.zulipusercontent.net/c600a628af8a82c063d4196dd0dd7fed5ef86ab3/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f623637663834623235393731613061653035313731396132386361383665343635313734373837323563646365643236356132393536356432393463633631642f62797465636f6465616c6c69616e63652f7369676874676c617373&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/sightglass/" title="GitHub - bytecodealliance/sightglass: A benchmark suite and tool to compare different implementations of the same primitives.">GitHub - bytecodealliance/sightglass: A benchmark suite and tool to compare different implementations of the same primitives.</a></div><div class="message_embed_description">A benchmark suite and tool to compare different implementations of the same primitives. - bytecodealliance/sightglass</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/sightglass/?tab=readme-ov-file#comparing-a-feature-branch-to-main" style="background-image: url(&quot;https://uploads.zulipusercontent.net/c600a628af8a82c063d4196dd0dd7fed5ef86ab3/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f623637663834623235393731613061653035313731396132386361383665343635313734373837323563646365643236356132393536356432393463633631642f62797465636f6465616c6c69616e63652f7369676874676c617373&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/sightglass/?tab=readme-ov-file#comparing-a-feature-branch-to-main" title="GitHub - bytecodealliance/sightglass: A benchmark suite and tool to compare different implementations of the same primitives.">GitHub - bytecodealliance/sightglass: A benchmark suite and tool to compare different implementations of the same primitives.</a></div><div class="message_embed_description">A benchmark suite and tool to compare different implementations of the same primitives. - bytecodealliance/sightglass</div></div></div>



<a name="545880135"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Interleaving%20%60Inst%60%20and%20%60Value%60%20nodes%3F/near/545880135" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Interleaving.20.60Inst.60.20and.20.60Value.60.20nodes.3F.html#545880135">(Oct 20 2025 at 04:15)</a>:</h4>
<p>the benchmark suite still isn't super-well filled out, but at least will give you something. Typically the numbers that are most interesting to the core Cranelift folks are the non-microbenchmarks, which more or less is the <a href="https://github.com/bytecodealliance/sightglass/blob/main/benchmarks/default.suite">default</a> suite plus maybe regex and blake3-*</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/sightglass/blob/main/benchmarks/default.suite" style="background-image: url(&quot;https://uploads.zulipusercontent.net/c600a628af8a82c063d4196dd0dd7fed5ef86ab3/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f623637663834623235393731613061653035313731396132386361383665343635313734373837323563646365643236356132393536356432393463633631642f62797465636f6465616c6c69616e63652f7369676874676c617373&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/sightglass/blob/main/benchmarks/default.suite" title="sightglass/benchmarks/default.suite at main · bytecodealliance/sightglass">sightglass/benchmarks/default.suite at main · bytecodealliance/sightglass</a></div><div class="message_embed_description">A benchmark suite and tool to compare different implementations of the same primitives. - bytecodealliance/sightglass</div></div></div>



<a name="545881671"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/Interleaving%20%60Inst%60%20and%20%60Value%60%20nodes%3F/near/545881671" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Bongjun Jang <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/Interleaving.20.60Inst.60.20and.20.60Value.60.20nodes.3F.html#545881671">(Oct 20 2025 at 04:38)</a>:</h4>
<p>Thank you very much. I hope the improved codegen can make some change. I'll try the benchamrks.</p>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
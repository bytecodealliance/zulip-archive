<html>
<head><meta charset="utf-8"><title>regalloc3 benchmarks Â· cranelift Â· Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/index.html">cranelift</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/regalloc3.20benchmarks.html">regalloc3 benchmarks</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="502139536"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/regalloc3%20benchmarks/near/502139536" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Erik Rose <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/regalloc3.20benchmarks.html#502139536">(Feb 26 2025 at 20:36)</a>:</h4>
<p><span class="user-mention" data-user-id="301625">@Amanieu</span> Per our exchange at today's meeting, here are the benchmarks I ran against wasmtime <code>main</code> (79e1b5374710cd66af9f6330b4c2a231e61d9866) vs. <a href="https://github.com/bytecodealliance/wasmtime/commit/eb2acdfb4f27795856c7455824b08bb705d60e64">https://github.com/bytecodealliance/wasmtime/commit/eb2acdfb4f27795856c7455824b08bb705d60e64</a>, which pulls in your <code>regalloc3</code> branch of regalloc2 (but not your <code>adjust-split</code> branch). You had expected a 50% slowdown in compilation, but I recalled a 25% one. Some benchmarks were indeed up in the 20s, but, on average, they were 14% slower on the low end of the CI, 17% slower on the high. I offer this only in case you find it interesting/surprising and by no means want to slow your work on the allocator, which will benefit us all! :-) Again, I ran these on an ARM chip (M3 Max), which has double the GPRs as an x64.</p>
<p><a href="/user_uploads/15107/X_OVo6Gpy3kzI60yuszJrVsG/regalloc3-all-suite-compilation-only.txt">regalloc3 all suite compilation only.txt</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/commit/eb2acdfb4f27795856c7455824b08bb705d60e64" style="background-image: url(&quot;https://uploads.zulipusercontent.net/c93089aacaa95cd4f43c12cf82fc8ad4c6c601e1/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f646562313766393939326266333062363563613334613961306263613666343832663665626132386135653430396662373636303533653831303531383835342f62797465636f6465616c6c69616e63652f7761736d74696d652f636f6d6d69742f65623261636466623466323737393538353663373435353832346230386262373035643630653634&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/commit/eb2acdfb4f27795856c7455824b08bb705d60e64" title="Point at Amanieu's repo for regalloc3 for easier replicability. Â· bytecodealliance/wasmtime@eb2acdf">Point at Amanieu's repo for regalloc3 for easier replicability. Â· bytecodealliance/wasmtime@eb2acdf</a></div><div class="message_embed_description">I didn't change anything in there yet anyway.</div></div></div>



<a name="502140157"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/regalloc3%20benchmarks/near/502140157" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/regalloc3.20benchmarks.html#502140157">(Feb 26 2025 at 20:39)</a>:</h4>
<p>I'd suggest focusing on just <code>spidermonkey</code>, <code>bz2</code>, and <code>pulldown-cmark</code>. maybe as a second tier <code>intgemm-simd</code>, <code>meshoptimizer</code>, and <code>libsodium</code>. but all the shootout stuff is just tiny micro benchmarks that aren't really interesting unless you are focused on optimizing the thing they happen to micro bench.</p>



<a name="502140294"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/regalloc3%20benchmarks/near/502140294" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/regalloc3.20benchmarks.html#502140294">(Feb 26 2025 at 20:40)</a>:</h4>
<p>in practice, the shootout benchmarks are going to just be noise unless you're trying to focus on their specific thing</p>



<a name="502140421"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/regalloc3%20benchmarks/near/502140421" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/regalloc3.20benchmarks.html#502140421">(Feb 26 2025 at 20:41)</a>:</h4>
<p>I guess blake3 is fairly interesting interesting</p>



<a name="502140640"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/regalloc3%20benchmarks/near/502140640" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Erik Rose <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/regalloc3.20benchmarks.html#502140640">(Feb 26 2025 at 20:42)</a>:</h4>
<p>So 28-29, 17-20, and 25-27%, respectively.<br>
2nd tier: 25-26, 17-21, and â‰ˆ15-20</p>
<p>Doesn't really change the numbers, but sure will save me time benchmarking! Thanks!</p>



<a name="502141012"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/regalloc3%20benchmarks/near/502141012" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/regalloc3.20benchmarks.html#502141012">(Feb 26 2025 at 20:44)</a>:</h4>
<p>right yeah, I'm just trying to help make benchmarking easier and make it easier to evaluate the results</p>



<a name="502141386"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/regalloc3%20benchmarks/near/502141386" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> fitzgen (he/him) <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/regalloc3.20benchmarks.html#502141386">(Feb 26 2025 at 20:47)</a>:</h4>
<p>you can also benchmark particular phases as well, if you want to focus only on compile time for example, you can do</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">sightglass</span><span class="o">-</span><span class="n">cli</span><span class="w"> </span><span class="n">benchmark</span><span class="w"> </span><span class="o">--</span><span class="n">benchmark</span><span class="o">-</span><span class="n">phase</span><span class="w"> </span><span class="n">compilation</span><span class="w"> </span><span class="o">..</span><span class="p">.</span>
</code></pre></div>



<a name="502141781"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/regalloc3%20benchmarks/near/502141781" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Erik Rose <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/regalloc3.20benchmarks.html#502141781">(Feb 26 2025 at 20:49)</a>:</h4>
<p>I can also have it spit out JSON and save myself a lot of regexes, but I have yet to remember to do that until the middle of a long run. ;-)</p>



<a name="502155133"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/regalloc3%20benchmarks/near/502155133" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/regalloc3.20benchmarks.html#502155133">(Feb 26 2025 at 22:21)</a>:</h4>
<p>FYI I run my benchmarks with the shuffling allocator disabled because it makes allocations extremely slow and distorts the runtime. That could be an explanation of why you're seeing different results.</p>



<a name="502160547"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/regalloc3%20benchmarks/near/502160547" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/regalloc3.20benchmarks.html#502160547">(Feb 26 2025 at 23:01)</a>:</h4>
<p>ah, right, I filed <a href="https://github.com/bytecodealliance/sightglass/issues/280">https://github.com/bytecodealliance/sightglass/issues/280</a> a while ago to switch the default but then ran out of spare energy to do it; <span class="user-mention" data-user-id="819709">@Erik Rose</span> that could be an easy PR to make</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/sightglass/issues/280" style="background-image: url(&quot;https://uploads.zulipusercontent.net/08b1fde5b1692bb511fca9db8f930ea70cd58180/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f663361366464303965633036643165326239363738626134636466613264663337376438306139393933373730343538333264663463386465383335336164652f62797465636f6465616c6c69616e63652f7369676874676c6173732f6973737565732f323830&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/sightglass/issues/280" title="Consider disabling the shuffling allocator by default Â· Issue #280 Â· bytecodealliance/sightglass">Consider disabling the shuffling allocator by default Â· Issue #280 Â· bytecodealliance/sightglass</a></div><div class="message_embed_description">A recent report by @d-sonuga indicates wildly differing data when measuring the impact of regalloc improvements on compile time depending on whether Sightglass's shuffling allocator is enabled or n...</div></div></div>



<a name="502160707"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/regalloc3%20benchmarks/near/502160707" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/regalloc3.20benchmarks.html#502160707">(Feb 26 2025 at 23:01)</a>:</h4>
<p>It's a one-line change:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">diff</span><span class="w"> </span><span class="o">--</span><span class="n">git</span><span class="w"> </span><span class="n">a</span><span class="o">/</span><span class="n">crates</span><span class="o">/</span><span class="n">bench</span><span class="o">-</span><span class="n">api</span><span class="o">/</span><span class="n">Cargo</span><span class="p">.</span><span class="n">toml</span><span class="w"> </span><span class="n">b</span><span class="o">/</span><span class="n">crates</span><span class="o">/</span><span class="n">bench</span><span class="o">-</span><span class="n">api</span><span class="o">/</span><span class="n">Cargo</span><span class="p">.</span><span class="n">toml</span>
<span class="n">index</span><span class="w"> </span><span class="n">a171b0beed</span><span class="o">..</span><span class="n">de288922ba</span><span class="w"> </span><span class="mi">100644</span>
<span class="o">---</span><span class="w"> </span><span class="n">a</span><span class="o">/</span><span class="n">crates</span><span class="o">/</span><span class="n">bench</span><span class="o">-</span><span class="n">api</span><span class="o">/</span><span class="n">Cargo</span><span class="p">.</span><span class="n">toml</span>
<span class="o">+++</span><span class="w"> </span><span class="n">b</span><span class="o">/</span><span class="n">crates</span><span class="o">/</span><span class="n">bench</span><span class="o">-</span><span class="n">api</span><span class="o">/</span><span class="n">Cargo</span><span class="p">.</span><span class="n">toml</span>
<span class="o">@@</span><span class="w"> </span><span class="o">-</span><span class="mi">35</span><span class="p">,</span><span class="mi">5</span><span class="w"> </span><span class="o">+</span><span class="mi">35</span><span class="p">,</span><span class="mi">5</span><span class="w"> </span><span class="o">@@</span><span class="w"> </span><span class="n">clap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">workspace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">}</span>
<span class="w"> </span><span class="n">wat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">workspace</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">}</span>

<span class="w"> </span><span class="p">[</span><span class="n">features</span><span class="p">]</span>
<span class="o">-</span><span class="n">default</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s">"shuffling-allocator"</span><span class="p">,</span><span class="w"> </span><span class="s">"wasi-nn"</span><span class="p">]</span>
<span class="o">+</span><span class="n">default</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s">"wasi-nn"</span><span class="p">]</span>
<span class="w"> </span><span class="n">wasi</span><span class="o">-</span><span class="n">nn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s">"wasmtime-wasi-nn"</span><span class="p">]</span>
</code></pre></div>



<a name="502160968"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/regalloc3%20benchmarks/near/502160968" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/regalloc3.20benchmarks.html#502160968">(Feb 26 2025 at 23:03)</a>:</h4>
<p>I must have been very low on spare energy then :-)</p>



<a name="502162393"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/regalloc3%20benchmarks/near/502162393" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/regalloc3.20benchmarks.html#502162393">(Feb 26 2025 at 23:12)</a>:</h4>
<p><span class="user-mention" data-user-id="819709">@Erik Rose</span> Here are the results I am getting on my (admittedly quite perf-noisy) machine:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">compilation</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">cycles</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">benchmarks</span><span class="o">/</span><span class="n">bz2</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="err">Î”</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">43971560.50</span><span class="w"> </span><span class="err">Â±</span><span class="w"> </span><span class="mf">34846300.90</span><span class="w"> </span><span class="p">(</span><span class="n">confidence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="o">%</span><span class="p">)</span>

<span class="w">  </span><span class="mi">3</span><span class="o">-</span><span class="n">spill</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.08</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.66</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="mf">2.</span><span class="n">so</span><span class="o">!</span>

<span class="w">  </span><span class="p">[</span><span class="mi">129186085</span><span class="w"> </span><span class="mf">162930575.50</span><span class="w"> </span><span class="mi">216937350</span><span class="p">]</span><span class="w"> </span><span class="mf">2.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">85216530</span><span class="w"> </span><span class="mf">118959015.00</span><span class="w"> </span><span class="mi">141328075</span><span class="p">]</span><span class="w"> </span><span class="mi">3</span><span class="o">-</span><span class="n">spill</span><span class="p">.</span><span class="n">so</span>

<span class="n">compilation</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">cycles</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">benchmarks</span><span class="o">/</span><span class="n">pulldown</span><span class="o">-</span><span class="n">cmark</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="n">No</span><span class="w"> </span><span class="n">difference</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">performance</span><span class="p">.</span>

<span class="w">  </span><span class="p">[</span><span class="mi">95009950</span><span class="w"> </span><span class="mf">116081567.00</span><span class="w"> </span><span class="mi">158748170</span><span class="p">]</span><span class="w"> </span><span class="mf">2.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">80138100</span><span class="w"> </span><span class="mf">111471111.50</span><span class="w"> </span><span class="mi">141233575</span><span class="p">]</span><span class="w"> </span><span class="mi">3</span><span class="o">-</span><span class="n">spill</span><span class="p">.</span><span class="n">so</span>

<span class="n">compilation</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">cycles</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">benchmarks</span><span class="o">/</span><span class="n">spidermonkey</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="n">No</span><span class="w"> </span><span class="n">difference</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">performance</span><span class="p">.</span>

<span class="w">  </span><span class="p">[</span><span class="mi">1066633785</span><span class="w"> </span><span class="mf">1108409337.00</span><span class="w"> </span><span class="mi">1163300915</span><span class="p">]</span><span class="w"> </span><span class="mf">2.</span><span class="n">so</span>
<span class="w">  </span><span class="p">[</span><span class="mi">1039408055</span><span class="w"> </span><span class="mf">1077584459.00</span><span class="w"> </span><span class="mi">1112557740</span><span class="p">]</span><span class="w"> </span><span class="mi">3</span><span class="o">-</span><span class="n">spill</span><span class="p">.</span><span class="n">so</span>
</code></pre></div>
<p>This was using an older version of regalloc3 which didn't have live range splitting (the 50% cost I mentioned in only with live range splitting). This should be the same version you tested based on your Cargo.lock.</p>



<a name="502162568"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/regalloc3%20benchmarks/near/502162568" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/regalloc3.20benchmarks.html#502162568">(Feb 26 2025 at 23:14)</a>:</h4>
<p>However you can see that ra3 is consistently faster than ra2 in terms of compilation speed.</p>



<a name="502162643"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/regalloc3%20benchmarks/near/502162643" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/regalloc3.20benchmarks.html#502162643">(Feb 26 2025 at 23:14)</a>:</h4>
<p>how does runtime perf look in the non-spilling version? (I forget, sorry; it'd be helpful to have an up-to-date summary of all the numbers somewhere)</p>



<a name="502162972"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/regalloc3%20benchmarks/near/502162972" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/regalloc3.20benchmarks.html#502162972">(Feb 26 2025 at 23:17)</a>:</h4>
<p>I'm currently in the middle of some perf optimizations, but you can find the older results here: <a class="message-link" href="/#narrow/channel/217117-cranelift/topic/regalloc3.20progress.20update/near/491635900">#cranelift &gt; regalloc3 progress update @ ðŸ’¬</a></p>



<a name="502284785"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/regalloc3%20benchmarks/near/502284785" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/regalloc3.20benchmarks.html#502284785">(Feb 27 2025 at 13:32)</a>:</h4>
<p><span class="user-mention" data-user-id="819709">@Erik Rose</span> I've confirmed that the 25% regression you observed is entirely due to the shuffling allocator. regalloc3 doesn't make use of smallvec and instead relies on the caller to reuse the register allocation context for multiple functions (preserving the <code>Vec</code> allocations inside it). Unfortunately Cranelift doesn't use <code>regalloc2::run_with_ctx</code> and therefore cannot take advantage of this.</p>



<a name="502284916"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/regalloc3%20benchmarks/near/502284916" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/regalloc3.20benchmarks.html#502284916">(Feb 27 2025 at 13:32)</a>:</h4>
<p>However the difference is only really noticable with the shuffling allocator enabled since it allocations so slow that compilation takes ~5x longer.</p>



<a name="502301026"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/regalloc3%20benchmarks/near/502301026" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Erik Rose <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/regalloc3.20benchmarks.html#502301026">(Feb 27 2025 at 14:40)</a>:</h4>
<p>Fantastic. Thanks, Amanieu! I will update my checkouts, get off the shuffling allocator, and re-run my benchmarks.</p>
<p>I opened a PR to disable the shuffling allocator as well: <a href="https://github.com/bytecodealliance/wasmtime/pull/10300">https://github.com/bytecodealliance/wasmtime/pull/10300</a>.</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/pull/10300" style="background-image: url(&quot;https://uploads.zulipusercontent.net/35be954a774a8f92a777bd208bb790d0a8ced5f5/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f656432653662363032623963343661616462356334303833633132623264636237363033393862653236393534356564613666306265313039623862376162612f62797465636f6465616c6c69616e63652f7761736d74696d652f70756c6c2f3130333030&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/pull/10300" title="Disable shuffling allocator during benchmarks by default. by erikrose Â· Pull Request #10300 Â· bytecodealliance/wasmtime">Disable shuffling allocator during benchmarks by default. by erikrose Â· Pull Request #10300 Â· bytecodealliance/wasmtime</a></div><div class="message_embed_description">The slowness of the shuffling obscured performance signal (by dwarfing it) more than the accidental localities it was meant to avoid. Closes bytecodealliance/sightglass#280.
This issue came up in h...</div></div></div>



<a name="502302608"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/regalloc3%20benchmarks/near/502302608" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/regalloc3.20benchmarks.html#502302608">(Feb 27 2025 at 14:46)</a>:</h4>
<p>Note that if you update your checkouts now, the current main branch default to enabling live range splitting which is what causes the 50% slowdown I previously mentioned.</p>



<a name="502302799"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/regalloc3%20benchmarks/near/502302799" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/regalloc3.20benchmarks.html#502302799">(Feb 27 2025 at 14:47)</a>:</h4>
<p>You can override it by selecting <code>SplitStrategy::Spill</code> in the regalloc3 options. Or just modify your regalloc3 checkout to make that the default temporarily.</p>



<a name="525817545"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/regalloc3%20benchmarks/near/525817545" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leaves <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/regalloc3.20benchmarks.html#525817545">(Jun 26 2025 at 03:17)</a>:</h4>
<p><span class="user-mention" data-user-id="301625">@Amanieu</span> considering swapping from ra2 to 3. Do you have any sort of design doc available similar to ra2? Mostly I'm just a bit confused on the difference between a bank and a class. In what instance would I need multiple register banks to describe one class?</p>



<a name="525823480"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/regalloc3%20benchmarks/near/525823480" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/regalloc3.20benchmarks.html#525823480">(Jun 26 2025 at 04:45)</a>:</h4>
<p><span class="user-mention" data-user-id="732970">@Leaves</span> Have you looked at the <a href="https://github.com/Amanieu/regalloc3/blob/main/src/reginfo.rs">documentation</a> for the <code>reginfo</code> module? Also there are examples available <a href="https://github.com/Amanieu/regalloc3/tree/main/example_reginfo">here</a>.</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/Amanieu/regalloc3/blob/main/src/reginfo.rs" style="background-image: url(&quot;https://uploads.zulipusercontent.net/844a1d877e3b35bb167c4bc151523dfeca553747/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f366337303432646330313162373437633364366439326238316366396333313337376135666136373066313736316133336430373737373865653032663533382f416d616e6965752f726567616c6c6f6333&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/Amanieu/regalloc3/blob/main/src/reginfo.rs" title="regalloc3/src/reginfo.rs at main Â· Amanieu/regalloc3">regalloc3/src/reginfo.rs at main Â· Amanieu/regalloc3</a></div><div class="message_embed_description">New register allocator designed as a successor to regalloc2 - Amanieu/regalloc3</div></div></div><div class="message_embed"><a class="message_embed_image" href="https://github.com/Amanieu/regalloc3/tree/main/example_reginfo" style="background-image: url(&quot;https://uploads.zulipusercontent.net/844a1d877e3b35bb167c4bc151523dfeca553747/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f366337303432646330313162373437633364366439326238316366396333313337376135666136373066313736316133336430373737373865653032663533382f416d616e6965752f726567616c6c6f6333&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/Amanieu/regalloc3/tree/main/example_reginfo" title="regalloc3/example_reginfo at main Â· Amanieu/regalloc3">regalloc3/example_reginfo at main Â· Amanieu/regalloc3</a></div><div class="message_embed_description">New register allocator designed as a successor to regalloc2 - Amanieu/regalloc3</div></div></div>



<a name="525902644"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/regalloc3%20benchmarks/near/525902644" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leaves <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/regalloc3.20benchmarks.html#525902644">(Jun 26 2025 at 13:17)</a>:</h4>
<p>Yep, that's exactly what I'm looking for, I had entirely missed that comment at the top! </p>
<p>Edit: Ok that comment explained everything I was curious about, thank you much.</p>



<a name="525996073"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/regalloc3%20benchmarks/near/525996073" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leaves <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/regalloc3.20benchmarks.html#525996073">(Jun 27 2025 at 00:20)</a>:</h4>
<p><span class="user-mention" data-user-id="301625">@Amanieu</span> Sorry to bug you again, is there a proper way to get the set of all registers used by the allocator? Including registers allocated to instructions, and those used by edits. I'm currently just iterating over all the instructions using output_insts(..) and recording it as I go. But a succinct method to get this would be nice(if it exists).</p>



<a name="526014465"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/regalloc3%20benchmarks/near/526014465" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/regalloc3.20benchmarks.html#526014465">(Jun 27 2025 at 05:19)</a>:</h4>
<p><span class="user-mention" data-user-id="732970">@Leaves</span> No, there is no other way. Regalloc3 doesn't track this internally, especially for temporary registers that are only used as scratch registers for moves.</p>



<a name="526014512"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/regalloc3%20benchmarks/near/526014512" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/regalloc3.20benchmarks.html#526014512">(Jun 27 2025 at 05:20)</a>:</h4>
<p>What do you need this information for? If it's for stack frame setup (callee-saved registers), you may want to specify those registers as defined on function entry and used by return instructions. That way they will automatically be spilled to a stack slot by the register allocator.</p>



<a name="526082067"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/regalloc3%20benchmarks/near/526082067" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leaves <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/regalloc3.20benchmarks.html#526082067">(Jun 27 2025 at 13:20)</a>:</h4>
<p>Yeah for stack frame setup. I need to know what registers are saved to properly emit push/pop pairs. It's important that these registers are saved in an easy to define way for the various UnwindInfo formats. If RA3 is deciding where they are spilled/filled, I won't be able to locate this to emit proper unwind information. And I need to know how many pairs of push/pops there are, so I can know the entire stack frame size, prior to lowering an intrinsic like __AddressOfReturnAddress() which needs to read from RSP+FrameSize.</p>
<p>Where FrameSize = PushedRegisters * 8 + StackLayout.spillslot_area_size.</p>
<p>So, I need to iterate over all the instructions and edits first, find out which non-volatile registers are written in any way, and only then can I lower that intrinsic.</p>



<a name="526083580"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/regalloc3%20benchmarks/near/526083580" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/regalloc3.20benchmarks.html#526083580">(Jun 27 2025 at 13:28)</a>:</h4>
<p>Alternatively, you can let the register allocator handle saving/restoring into regalloc-managed spillslots. Just specify the constraints that the return instruction takes the original values of the callee-saved registers as fixed-register inputs. Then just get the stack frame size from <code>output.stack_layout()</code>.</p>



<a name="526083784"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/regalloc3%20benchmarks/near/526083784" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leaves <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/regalloc3.20benchmarks.html#526083784">(Jun 27 2025 at 13:29)</a>:</h4>
<p>I will not be able to describe these saves with unwind info though, and for certain targets like windows that require support for asyncronous exception support, I need to be very careful with this. Allowing RA3 to arbitrarily determine spill/fill locations for non-volatile registers will make that impossible.</p>



<a name="526083838"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/regalloc3%20benchmarks/near/526083838" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/regalloc3.20benchmarks.html#526083838">(Jun 27 2025 at 13:29)</a>:</h4>
<p>For the unwind information, you can get the location of each value from <code>output.value_locations()</code>. You can use that to get the values of the callee-saved at every point in the function.</p>



<a name="526084188"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/regalloc3%20benchmarks/near/526084188" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leaves <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/regalloc3.20benchmarks.html#526084188">(Jun 27 2025 at 13:31)</a>:</h4>
<p>That is true, however there is a limit to the number of locations that a non-volatile register can be saved into in with the Windows UnwindInfo spec. They must be saved in the prolog, and the prolog cannot be larger than 256 bytes. So, I would need to guarantee that regalloc saves them once there, and only restores from that location at function end.</p>



<a name="526084386"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/regalloc3%20benchmarks/near/526084386" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/regalloc3.20benchmarks.html#526084386">(Jun 27 2025 at 13:32)</a>:</h4>
<p>Right, in that case you probably have to do this yourself. And there is no way other than scanning through the output instructions to find out which registers are used. It's not tracked internally in the allocator, so there isn't any faster way of doing this.</p>



<a name="526084396"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/regalloc3%20benchmarks/near/526084396" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leaves <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/regalloc3.20benchmarks.html#526084396">(Jun 27 2025 at 13:32)</a>:</h4>
<p>Additionally PUSH/POP pairs at the beginning/end of the function are smaller in size, even when encoding a spill/fill with an 8bit displacement. MOV [RSP+8BitDisp]</p>



<a name="526084586"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/regalloc3%20benchmarks/near/526084586" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leaves <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/regalloc3.20benchmarks.html#526084586">(Jun 27 2025 at 13:33)</a>:</h4>
<p>Got it, I implemented that, and it appears to work well. RA2 required something similar anyway but there were more simple allocs/edits slices to iterate over.</p>



<a name="526084833"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/regalloc3%20benchmarks/near/526084833" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/regalloc3.20benchmarks.html#526084833">(Jun 27 2025 at 13:34)</a>:</h4>
<p>Hmm now that I think about it, it's actually possible to make this more efficient by tracking it internally. I'll add an API for it.</p>



<a name="526084988"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/regalloc3%20benchmarks/near/526084988" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/regalloc3.20benchmarks.html#526084988">(Jun 27 2025 at 13:35)</a>:</h4>
<p>It would be something along the lines of <code>fn reg_units_used(&amp;self) -&gt; &amp;RegUnitSet</code>.</p>



<a name="526085536"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/regalloc3%20benchmarks/near/526085536" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leaves <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/regalloc3.20benchmarks.html#526085536">(Jun 27 2025 at 13:37)</a>:</h4>
<p>What would be most helpful would be reg_units_read(&amp;self), reg_units_written(&amp;self). Read alone wouldn't be enough for this case.</p>
<p>Are you open to PRs btw?</p>



<a name="526085894"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/regalloc3%20benchmarks/near/526085894" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/regalloc3.20benchmarks.html#526085894">(Jun 27 2025 at 13:39)</a>:</h4>
<p>That's not as simple as it seems: the initial values for registers is emitted by the entry instruction, so all registers that are used are technically written.</p>



<a name="526086030"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/regalloc3%20benchmarks/near/526086030" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/regalloc3.20benchmarks.html#526086030">(Jun 27 2025 at 13:40)</a>:</h4>
<p>I'm open to PRs but I would prefer if it was discussed first to avoid unnecessary work.</p>



<a name="526086203"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/regalloc3%20benchmarks/near/526086203" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leaves <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/regalloc3.20benchmarks.html#526086203">(Jun 27 2025 at 13:40)</a>:</h4>
<p>Thats right actually, I do skip the defs created by my NativeRegistersIn instruction that is the first instruction in the function. So that would need to be considered as well <span aria-label="grimacing" class="emoji emoji-1f62c" role="img" title="grimacing">:grimacing:</span></p>



<a name="526086771"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/regalloc3%20benchmarks/near/526086771" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/regalloc3.20benchmarks.html#526086771">(Jun 27 2025 at 13:43)</a>:</h4>
<p>Tracking which registers are used can be done relatively efficiently, essentially meaning "does this register at any point hold a regalloc-managed value".</p>



<a name="526086819"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/regalloc3%20benchmarks/near/526086819" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/regalloc3.20benchmarks.html#526086819">(Jun 27 2025 at 13:43)</a>:</h4>
<p>For anything more than that your best bet is still just scanning the output I think.</p>



<a name="526087119"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/regalloc3%20benchmarks/near/526087119" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leaves <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/regalloc3.20benchmarks.html#526087119">(Jun 27 2025 at 13:44)</a>:</h4>
<p>I think so now as well after considering the fact that I need to disregard Defs from certain instructions.</p>



<a name="526112903"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/regalloc3%20benchmarks/near/526112903" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leaves <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/regalloc3.20benchmarks.html#526112903">(Jun 27 2025 at 15:56)</a>:</h4>
<p>I suppose this is really getting away from cranelift/regalloc2 talk now. But if both validators are returning Ok for RA3 and I'm still getting an error about rematerialization(despite always returning None for rematerialization), what direction should I go in for debugging?</p>
<p>Error actually arising is "add_remat called with non-rematerializable value" and it's called on a block parameter(%17) for a small exit block.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">block13</span><span class="p">(</span><span class="o">%</span><span class="mi">17</span><span class="p">)</span><span class="w"> </span><span class="n">freq</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
<span class="p">;</span><span class="w"> </span><span class="n">predecessors</span><span class="p">:</span><span class="w"> </span><span class="nc">block6</span><span class="p">,</span><span class="w"> </span><span class="n">block7</span><span class="p">,</span><span class="w"> </span><span class="n">block10</span><span class="p">,</span><span class="w"> </span><span class="n">block11</span><span class="p">,</span><span class="w"> </span><span class="n">block12</span>
<span class="w">    </span><span class="n">inst66</span><span class="p">:</span><span class="w"> </span><span class="nc">inst</span>
<span class="w">    </span><span class="n">inst67</span><span class="p">:</span><span class="w"> </span><span class="nc">inst</span><span class="w"> </span><span class="n">Use</span><span class="p">(</span><span class="o">%</span><span class="mi">2</span><span class="p">):</span><span class="nc">r1</span><span class="w"> </span><span class="n">Use</span><span class="p">(</span><span class="o">%</span><span class="mi">17</span><span class="p">):</span><span class="nc">r0</span>
<span class="w">    </span><span class="n">inst68</span><span class="p">:</span><span class="w"> </span><span class="nc">ret</span>
</code></pre></div>



<a name="526113085"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/regalloc3%20benchmarks/near/526113085" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/regalloc3.20benchmarks.html#526113085">(Jun 27 2025 at 15:57)</a>:</h4>
<p>Can you dump the function and reginfo to text form so I can try it with regalloc3-tool?</p>



<a name="526113337"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/regalloc3%20benchmarks/near/526113337" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leaves <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/regalloc3.20benchmarks.html#526113337">(Jun 27 2025 at 15:59)</a>:</h4>
<p>Do you mean just converting to a GenericFunction then printing it?</p>



<a name="526113701"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/regalloc3%20benchmarks/near/526113701" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leaves <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/regalloc3.20benchmarks.html#526113701">(Jun 27 2025 at 16:01)</a>:</h4>
<p><a href="https://pastebin.com/raw/vpSvqK8X">https://pastebin.com/raw/vpSvqK8X</a><br>
<a href="https://pastebin.com/raw/QzJx8aGE">https://pastebin.com/raw/QzJx8aGE</a></p>



<a name="526116621"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/regalloc3%20benchmarks/near/526116621" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/regalloc3.20benchmarks.html#526116621">(Jun 27 2025 at 16:18)</a>:</h4>
<p>42 messages were moved from this topic to <a class="stream-topic" data-stream-id="217117" href="/#narrow/channel/217117-cranelift/topic/regalloc3.20debugging/with/525817545">#cranelift &gt; regalloc3 debugging</a> by <span class="user-mention silent" data-user-id="301625">Amanieu</span>.</p>



<a name="527201621"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/regalloc3%20benchmarks/near/527201621" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/regalloc3.20benchmarks.html#527201621">(Jul 04 2025 at 15:41)</a>:</h4>
<p>Latest benchmark results for regalloc3:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">compilation</span>
<span class="w">  </span><span class="n">benchmarks</span><span class="o">/</span><span class="n">bz2</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>
<span class="w">    </span><span class="n">cycles</span>
<span class="w">      </span><span class="p">[</span><span class="mi">388409280</span><span class="w"> </span><span class="mf">394336775.00</span><span class="w"> </span><span class="mi">420104370</span><span class="p">]</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">ra2</span><span class="p">.</span><span class="n">so</span>
<span class="w">      </span><span class="p">[</span><span class="mi">324084635</span><span class="w"> </span><span class="mf">327185663.00</span><span class="w"> </span><span class="mi">345267545</span><span class="p">]</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">ra3</span><span class="o">-</span><span class="n">spill</span><span class="p">.</span><span class="n">so</span>
<span class="w">      </span><span class="p">[</span><span class="mi">361255790</span><span class="w"> </span><span class="mf">364677054.00</span><span class="w"> </span><span class="mi">383229420</span><span class="p">]</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">ra3</span><span class="o">-</span><span class="n">split</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="n">benchmarks</span><span class="o">/</span><span class="n">pulldown</span><span class="o">-</span><span class="n">cmark</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>
<span class="w">    </span><span class="n">cycles</span>
<span class="w">      </span><span class="p">[</span><span class="mi">796059285</span><span class="w"> </span><span class="mf">799510071.50</span><span class="w"> </span><span class="mi">807007075</span><span class="p">]</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">ra2</span><span class="p">.</span><span class="n">so</span>
<span class="w">      </span><span class="p">[</span><span class="mi">716654015</span><span class="w"> </span><span class="mf">721313358.50</span><span class="w"> </span><span class="mi">729701735</span><span class="p">]</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">ra3</span><span class="o">-</span><span class="n">spill</span><span class="p">.</span><span class="n">so</span>
<span class="w">      </span><span class="p">[</span><span class="mi">782036010</span><span class="w"> </span><span class="mf">786266075.00</span><span class="w"> </span><span class="mi">789498185</span><span class="p">]</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">ra3</span><span class="o">-</span><span class="n">split</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="n">benchmarks</span><span class="o">/</span><span class="n">spidermonkey</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>
<span class="w">    </span><span class="n">cycles</span>
<span class="w">      </span><span class="p">[</span><span class="mi">20091993285</span><span class="w"> </span><span class="mf">20178233887.00</span><span class="w"> </span><span class="mi">20278362790</span><span class="p">]</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">ra2</span><span class="p">.</span><span class="n">so</span>
<span class="w">      </span><span class="p">[</span><span class="mi">18244842070</span><span class="w"> </span><span class="mf">18398756379.50</span><span class="w"> </span><span class="mi">18586440250</span><span class="p">]</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">ra3</span><span class="o">-</span><span class="n">spill</span><span class="p">.</span><span class="n">so</span>
<span class="w">      </span><span class="p">[</span><span class="mi">19562045300</span><span class="w"> </span><span class="mf">19644339190.00</span><span class="w"> </span><span class="mi">19873169225</span><span class="p">]</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">ra3</span><span class="o">-</span><span class="n">split</span><span class="p">.</span><span class="n">so</span>
<span class="n">execution</span>
<span class="w">  </span><span class="n">benchmarks</span><span class="o">/</span><span class="n">bz2</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>
<span class="w">    </span><span class="n">cycles</span>
<span class="w">      </span><span class="p">[</span><span class="mi">118045165</span><span class="w"> </span><span class="mf">118595158.50</span><span class="w"> </span><span class="mi">121545340</span><span class="p">]</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">ra2</span><span class="p">.</span><span class="n">so</span>
<span class="w">      </span><span class="p">[</span><span class="mi">112530215</span><span class="w"> </span><span class="mf">112865336.50</span><span class="w"> </span><span class="mi">113412705</span><span class="p">]</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">ra3</span><span class="o">-</span><span class="n">spill</span><span class="p">.</span><span class="n">so</span>
<span class="w">      </span><span class="p">[</span><span class="mi">111467545</span><span class="w"> </span><span class="mf">111745469.50</span><span class="w"> </span><span class="mi">112304780</span><span class="p">]</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">ra3</span><span class="o">-</span><span class="n">split</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="n">benchmarks</span><span class="o">/</span><span class="n">pulldown</span><span class="o">-</span><span class="n">cmark</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>
<span class="w">    </span><span class="n">cycles</span>
<span class="w">      </span><span class="p">[</span><span class="mi">9640925</span><span class="w"> </span><span class="mf">9705132.50</span><span class="w"> </span><span class="mi">9788520</span><span class="p">]</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">ra2</span><span class="p">.</span><span class="n">so</span>
<span class="w">      </span><span class="p">[</span><span class="mi">8748110</span><span class="w"> </span><span class="mf">8830787.00</span><span class="w"> </span><span class="mi">9037630</span><span class="p">]</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">ra3</span><span class="o">-</span><span class="n">spill</span><span class="p">.</span><span class="n">so</span>
<span class="w">      </span><span class="p">[</span><span class="mi">8934240</span><span class="w"> </span><span class="mf">9045858.50</span><span class="w"> </span><span class="mi">9167515</span><span class="p">]</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">ra3</span><span class="o">-</span><span class="n">split</span><span class="p">.</span><span class="n">so</span>
<span class="w">  </span><span class="n">benchmarks</span><span class="o">/</span><span class="n">spidermonkey</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>
<span class="w">    </span><span class="n">cycles</span>
<span class="w">      </span><span class="p">[</span><span class="mi">1136702140</span><span class="w"> </span><span class="mf">1140818234.50</span><span class="w"> </span><span class="mi">1153406240</span><span class="p">]</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">ra2</span><span class="p">.</span><span class="n">so</span>
<span class="w">      </span><span class="p">[</span><span class="mi">1090508300</span><span class="w"> </span><span class="mf">1100439718.00</span><span class="w"> </span><span class="mi">1122041375</span><span class="p">]</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">ra3</span><span class="o">-</span><span class="n">spill</span><span class="p">.</span><span class="n">so</span>
<span class="w">      </span><span class="p">[</span><span class="mi">1113807730</span><span class="w"> </span><span class="mf">1119928414.50</span><span class="w"> </span><span class="mi">1128316140</span><span class="p">]</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">ra3</span><span class="o">-</span><span class="n">split</span><span class="p">.</span><span class="n">so</span>
</code></pre></div>



<a name="527227324"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/regalloc3%20benchmarks/near/527227324" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/regalloc3.20benchmarks.html#527227324">(Jul 04 2025 at 19:53)</a>:</h4>
<p>At this point I consider regalloc3 basically done and ready for use. I'm currently writing up a design document for it, but other than that it's ready for review.</p>



<a name="527238860"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/regalloc3%20benchmarks/near/527238860" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Leaves <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/regalloc3.20benchmarks.html#527238860">(Jul 04 2025 at 23:30)</a>:</h4>
<p>I second that. After porting my own compiler form RA2 to RA3, fuzzing extensively, and deploying into product, I am VERY happy with the results.  The only change I would make would be relaxing some of the requirements around BB params, but only if it doesn't hurt output code quality. Requiring additional optimization passes to prep for regalloc is somewhat tedius.</p>



<a name="527243541"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/regalloc3%20benchmarks/near/527243541" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/regalloc3.20benchmarks.html#527243541">(Jul 05 2025 at 01:05)</a>:</h4>
<p><span class="user-mention" data-user-id="301625">@Amanieu</span> thanks for these latest results. As we discussed back in January, to get RA3 into Cranelift, we'll need someone to:</p>
<ul>
<li>Post a PR that adds an option to Cranelift to use RA3 as an option (presumably you have this, from the above benchmarks?) -- we'll want to keep both RA2 and RA3 available simultaneously and then move the default at some point if indeed it meets our needs (and ensure that both pass our full test suite in CI);</li>
<li>Put up the RA3 implementation as a PR against an empty repository and request review on that as well;</li>
<li>Work with the BA TSC to create a repository under the Bytecode Alliance org, and discuss details like transferring publishing permissions to the same group that owns Wasmtime/Cranelift; this last step probably after the above two.</li>
</ul>
<p>This is big enough that we'll probably want an RFC for the transition as well; and please feel free to schedule time on the Cranelift weekly meeting agenda.</p>



<a name="527356641"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/regalloc3%20benchmarks/near/527356641" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Amanieu <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/regalloc3.20benchmarks.html#527356641">(Jul 06 2025 at 16:15)</a>:</h4>
<p><span class="user-mention" data-user-id="254389">@Chris Fallin</span> Sure! I'm currently finishing up the design document. Once that is done, I will post a PR against an empty branch so that you can review the code. I've also submitted <a href="https://github.com/bytecodealliance/regalloc2/pull/230">https://github.com/bytecodealliance/regalloc2/pull/230</a> which adds regalloc3 as a back-end for regalloc2.</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/regalloc2/pull/230" style="background-image: url(&quot;https://uploads.zulipusercontent.net/ee0609e7b254aa64ff79665b5e5b42bbe5871b2c/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f303933653561663264343131353164333966653836633039623731323437376561663435346165356331653862666134346632643936303062336135366338612f62797465636f6465616c6c69616e63652f726567616c6c6f63322f70756c6c2f323330&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/regalloc2/pull/230" title="Add support for using regalloc3 as the allocator back-end by Amanieu Â· Pull Request #230 Â· bytecodealliance/regalloc2">Add support for using regalloc3 as the allocator back-end by Amanieu Â· Pull Request #230 Â· bytecodealliance/regalloc2</a></div><div class="message_embed_description">Currently still a draft because:

The regalloc3 crate isn't published yet.
This is missing support for debug locations.</div></div></div>



<hr><p>Last updated: Feb 22 2026 at 11:05 UTC</p>
</html>
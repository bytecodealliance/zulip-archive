<html>
<head><meta charset="utf-8"><title>✔ Cranelift debuginfo with set_srcloc? · cranelift · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/index.html">cranelift</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20Cranelift.20debuginfo.20with.20set_srcloc.3F.html">✔ Cranelift debuginfo with set_srcloc?</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="554615065"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20Cranelift%20debuginfo%20with%20set_srcloc%3F/near/554615065" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Anqur <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20Cranelift.20debuginfo.20with.20set_srcloc.3F.html#554615065">(Nov 10 2025 at 03:31)</a>:</h4>
<p>Thanks for all the replies! <span class="user-mention" data-user-id="253990">@fitzgen (he/him)</span> <span class="user-mention" data-user-id="382336">@Adel Prokurov</span>  I finally made it by using <code>object</code> and <code>gimli</code> for writing an in-memory ELF object with DWARF, and LLDB's JIT interface now recognizes my generated code. It's lucky that these two are all bundled in the Cranelift related crates. Some notable steps to make this happen:</p>
<ul>
<li>I forked the <code>cranelift-jit</code> crate to expose the function <strong>size</strong>, which seems impossible to get in the original crate. This serves as the size of the <code>.text</code> section.</li>
<li>Use <code>object::write</code> to write the ELF object, leave the <code>.text</code> section data blank. Add a symbol to this section with the generated function name, e.g. <code>b"jit_main"</code>.</li>
<li>Write the DWARF sections, and write them to the object with <code>.set_section_data</code>.</li>
<li>Write the ELF object to the memory. Then use <code>object::read</code> to read it again.</li>
</ul>
<p>Then the hard part: do the manual relocations (have to be <code>unsafe</code>):</p>
<ul>
<li>For <code>.text</code> section, set <code>sh_addr</code> with the code address, and <code>sh_size</code>with the size.</li>
<li>For other sections, set <code>sh_addr</code> to the <code>bytes.as_ptr() + sh_off</code>, so those <code>0x0</code> addresses are now the actual ones in virtual memory.</li>
</ul>
<p>Because I notice that <code>object::write</code> and <code>object::build</code> only accepts a <code>Cow</code> to write (I'm afraid it copies) the data, but since we already have a portion of in-memory generated code, we only need to set the right address and size.</p>
<ul>
<li>Finally, register the ELF object with <code>wasmtime-jit-debug</code> crate.</li>
</ul>
<p>And now settting breakpoints should work, but stacktraces and unwinding might not work properly, I'm still doing my experimentation on this.</p>



<a name="554615708"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20Cranelift%20debuginfo%20with%20set_srcloc%3F/near/554615708" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Notification Bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20Cranelift.20debuginfo.20with.20set_srcloc.3F.html#554615708">(Nov 10 2025 at 03:40)</a>:</h4>
<p><span class="user-mention silent" data-user-id="985444">Anqur</span> has marked this topic as resolved.</p>



<a name="554666574"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20Cranelift%20debuginfo%20with%20set_srcloc%3F/near/554666574" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20Cranelift.20debuginfo.20with.20set_srcloc.3F.html#554666574">(Nov 10 2025 at 10:38)</a>:</h4>
<p>For backtraces/unwinding you could take inspiration from <a href="https://github.com/rust-lang/rustc_codegen_cranelift/blob/9d292ca475cf182d404f5c1f4b6eaf07ac8bfb21/src/debuginfo/unwind.rs#L265-L312">https://github.com/rust-lang/rustc_codegen_cranelift/blob/9d292ca475cf182d404f5c1f4b6eaf07ac8bfb21/src/debuginfo/unwind.rs#L265-L312</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/rust-lang/rustc_codegen_cranelift/blob/9d292ca475cf182d404f5c1f4b6eaf07ac8bfb21/src/debuginfo/unwind.rs#L265-L312" style="background-image: url(&quot;https://uploads.zulipusercontent.net/4611d0de456f84eb15e053e53681dd99acd06d67/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f316539393162363839343634383034323635623733373966636535633366386364636439323461303162386563353763663936386333643633323665316266612f727573742d6c616e672f72757374635f636f646567656e5f6372616e656c696674&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/rust-lang/rustc_codegen_cranelift/blob/9d292ca475cf182d404f5c1f4b6eaf07ac8bfb21/src/debuginfo/unwind.rs#L265-L312" title="rustc_codegen_cranelift/src/debuginfo/unwind.rs at 9d292ca475cf182d404f5c1f4b6eaf07ac8bfb21 · rust-lang/rustc_codegen_cranelift">rustc_codegen_cranelift/src/debuginfo/unwind.rs at 9d292ca475cf182d404f5c1f4b6eaf07ac8bfb21 · rust-lang/rustc_codegen_cranelift</a></div><div class="message_embed_description">Cranelift based backend for rustc. Contribute to rust-lang/rustc_codegen_cranelift development by creating an account on GitHub.</div></div></div>



<a name="554666785"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/%E2%9C%94%20Cranelift%20debuginfo%20with%20set_srcloc%3F/near/554666785" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/.E2.9C.94.20Cranelift.20debuginfo.20with.20set_srcloc.3F.html#554666785">(Nov 10 2025 at 10:39)</a>:</h4>
<p>Although I think that only works for backtraces generated by your executable itself, not for debuggers. For debuggers I suspect you need to include the <code>.eh_frame</code> section in the debuginfo ELF file you register with the debugger.</p>



<hr><p>Last updated: Feb 22 2026 at 11:05 UTC</p>
</html>
<html>
<head><meta charset="utf-8"><title>stack_addr + load/store merging · cranelift · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/index.html">cranelift</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/stack_addr.20.2B.20load.2Fstore.20merging.html">stack_addr + load/store merging</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="540447623"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/stack_addr%20%2B%20load/store%20merging/near/540447623" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/stack_addr.20.2B.20load.2Fstore.20merging.html#540447623">(Sep 19 2025 at 12:49)</a>:</h4>
<p>I noticed that on arm64 a stack_addr + load/store gets merged into a single instruction. This doesn't seem to happen on x86 however. Where is this implemented for arm64?</p>



<a name="540447809"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/stack_addr%20%2B%20load/store%20merging/near/540447809" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/stack_addr.20.2B.20load.2Fstore.20merging.html#540447809">(Sep 19 2025 at 12:50)</a>:</h4>
<div class="codehilite" data-code-language="GAS"><pre><span></span><code><span class="nf">function</span><span class="w"> </span><span class="nv">%stack_store_small</span><span class="p">(</span><span class="no">i64</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="nf">ss0</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="no">explicit_slot</span><span class="w"> </span><span class="mi">8</span>

<span class="nf">block0</span><span class="p">(</span><span class="no">v0</span><span class="p">:</span><span class="w"> </span><span class="no">i64</span><span class="p">):</span>
<span class="w">  </span><span class="nf">stack_store.i64</span><span class="w"> </span><span class="no">v0</span><span class="p">,</span><span class="w"> </span><span class="no">ss0</span>
<span class="w">  </span><span class="nf">return</span>
<span class="err">}</span>

<span class="c1">; VCode:</span>
<span class="c1">;   stp fp, lr, [sp, #-16]!</span>
<span class="c1">;   mov fp, sp</span>
<span class="c1">;   sub sp, sp, #16</span>
<span class="c1">; block0:</span>
<span class="c1">;   mov x2, sp</span>
<span class="c1">;   str x0, [x2]</span>
<span class="c1">;   add sp, sp, #16</span>
<span class="c1">;   ldp fp, lr, [sp], #16</span>
<span class="c1">;   ret</span>
</code></pre></div>
<p>vs</p>
<div class="codehilite" data-code-language="GAS"><pre><span></span><code><span class="nf">function</span><span class="w"> </span><span class="nv">%stack_store_small</span><span class="p">(</span><span class="no">i64</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="nf">ss0</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="no">explicit_slot</span><span class="w"> </span><span class="mi">8</span>

<span class="nf">block0</span><span class="p">(</span><span class="no">v0</span><span class="p">:</span><span class="w"> </span><span class="no">i64</span><span class="p">):</span>
<span class="w">  </span><span class="nf">stack_store.i64</span><span class="w"> </span><span class="no">v0</span><span class="p">,</span><span class="w"> </span><span class="no">ss0</span>
<span class="w">  </span><span class="nf">return</span>
<span class="err">}</span>

<span class="c1">; VCode:</span>
<span class="c1">;   pushq %rbp</span>
<span class="c1">;   movq %rsp, %rbp</span>
<span class="c1">;   subq $0x10, %rsp</span>
<span class="c1">; block0:</span>
<span class="c1">;   leaq &lt;offset:1&gt;+(%rsp), %rax</span>
<span class="c1">;   movq %rdi, (%rax)</span>
<span class="c1">;   addq $0x10, %rsp</span>
<span class="c1">;   movq %rbp, %rsp</span>
<span class="c1">;   popq %rbp</span>
<span class="c1">;   retq</span>
</code></pre></div>



<a name="540447941"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/stack_addr%20%2B%20load/store%20merging/near/540447941" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/stack_addr.20.2B.20load.2Fstore.20merging.html#540447941">(Sep 19 2025 at 12:51)</a>:</h4>
<p>Never mind, I read the arm64 asm wrong. There is doesn't happen either.</p>



<a name="540466352"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/stack_addr%20%2B%20load/store%20merging/near/540466352" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/stack_addr.20.2B.20load.2Fstore.20merging.html#540466352">(Sep 19 2025 at 14:12)</a>:</h4>
<p>Got something kinda working. Before:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">[</span><span class="n">BENCH</span><span class="w"> </span><span class="n">RUN</span><span class="p">]</span><span class="w"> </span><span class="n">ebobby</span><span class="o">/</span><span class="n">simple</span><span class="o">-</span><span class="n">raytracer</span>
<span class="n">Benchmark</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">raytracer_cg_llvm</span>
<span class="w">  </span><span class="n">Time</span><span class="w"> </span><span class="p">(</span><span class="n">mean</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="err">σ</span><span class="p">):</span><span class="w">      </span><span class="mf">2.690</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="err">±</span><span class="w">  </span><span class="mf">0.043</span><span class="w"> </span><span class="n">s</span><span class="w">    </span><span class="p">[</span><span class="n">User</span><span class="p">:</span><span class="w"> </span><span class="mf">2.686</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">System</span><span class="p">:</span><span class="w"> </span><span class="mf">0.004</span><span class="w"> </span><span class="n">s</span><span class="p">]</span>
<span class="w">  </span><span class="n">Range</span><span class="w"> </span><span class="p">(</span><span class="n">min</span><span class="w"> </span><span class="err">…</span><span class="w"> </span><span class="n">max</span><span class="p">):</span><span class="w">    </span><span class="mf">2.663</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="err">…</span><span class="w">  </span><span class="mf">2.807</span><span class="w"> </span><span class="n">s</span><span class="w">    </span><span class="mi">10</span><span class="w"> </span><span class="n">runs</span>

<span class="n">Benchmark</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">raytracer_cg_clif</span>
<span class="w">  </span><span class="n">Time</span><span class="w"> </span><span class="p">(</span><span class="n">mean</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="err">σ</span><span class="p">):</span><span class="w">      </span><span class="mf">3.702</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="err">±</span><span class="w">  </span><span class="mf">0.021</span><span class="w"> </span><span class="n">s</span><span class="w">    </span><span class="p">[</span><span class="n">User</span><span class="p">:</span><span class="w"> </span><span class="mf">3.697</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">System</span><span class="p">:</span><span class="w"> </span><span class="mf">0.005</span><span class="w"> </span><span class="n">s</span><span class="p">]</span>
<span class="w">  </span><span class="n">Range</span><span class="w"> </span><span class="p">(</span><span class="n">min</span><span class="w"> </span><span class="err">…</span><span class="w"> </span><span class="n">max</span><span class="p">):</span><span class="w">    </span><span class="mf">3.674</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="err">…</span><span class="w">  </span><span class="mf">3.738</span><span class="w"> </span><span class="n">s</span><span class="w">    </span><span class="mi">10</span><span class="w"> </span><span class="n">runs</span>

<span class="n">Benchmark</span><span class="w"> </span><span class="mi">3</span><span class="p">:</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">raytracer_cg_clif_opt</span>
<span class="w">  </span><span class="n">Time</span><span class="w"> </span><span class="p">(</span><span class="n">mean</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="err">σ</span><span class="p">):</span><span class="w">      </span><span class="mf">2.286</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="err">±</span><span class="w">  </span><span class="mf">0.011</span><span class="w"> </span><span class="n">s</span><span class="w">    </span><span class="p">[</span><span class="n">User</span><span class="p">:</span><span class="w"> </span><span class="mf">2.282</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">System</span><span class="p">:</span><span class="w"> </span><span class="mf">0.004</span><span class="w"> </span><span class="n">s</span><span class="p">]</span>
<span class="w">  </span><span class="n">Range</span><span class="w"> </span><span class="p">(</span><span class="n">min</span><span class="w"> </span><span class="err">…</span><span class="w"> </span><span class="n">max</span><span class="p">):</span><span class="w">    </span><span class="mf">2.268</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="err">…</span><span class="w">  </span><span class="mf">2.306</span><span class="w"> </span><span class="n">s</span><span class="w">    </span><span class="mi">10</span><span class="w"> </span><span class="n">runs</span>

<span class="n">Summary</span>
<span class="w">  </span><span class="p">.</span><span class="o">/</span><span class="n">raytracer_cg_clif_opt</span><span class="w"> </span><span class="n">ran</span>
<span class="w">    </span><span class="mf">1.18</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">0.02</span><span class="w"> </span><span class="n">times</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">raytracer_cg_llvm</span>
<span class="w">    </span><span class="mf">1.62</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">0.01</span><span class="w"> </span><span class="n">times</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">raytracer_cg_clif</span>
</code></pre></div>
<p>After:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">[</span><span class="n">BENCH</span><span class="w"> </span><span class="n">RUN</span><span class="p">]</span><span class="w"> </span><span class="n">ebobby</span><span class="o">/</span><span class="n">simple</span><span class="o">-</span><span class="n">raytracer</span>
<span class="n">Benchmark</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">raytracer_cg_llvm</span>
<span class="w">  </span><span class="n">Time</span><span class="w"> </span><span class="p">(</span><span class="n">mean</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="err">σ</span><span class="p">):</span><span class="w">      </span><span class="mf">2.668</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="err">±</span><span class="w">  </span><span class="mf">0.010</span><span class="w"> </span><span class="n">s</span><span class="w">    </span><span class="p">[</span><span class="n">User</span><span class="p">:</span><span class="w"> </span><span class="mf">2.663</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">System</span><span class="p">:</span><span class="w"> </span><span class="mf">0.004</span><span class="w"> </span><span class="n">s</span><span class="p">]</span>
<span class="w">  </span><span class="n">Range</span><span class="w"> </span><span class="p">(</span><span class="n">min</span><span class="w"> </span><span class="err">…</span><span class="w"> </span><span class="n">max</span><span class="p">):</span><span class="w">    </span><span class="mf">2.660</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="err">…</span><span class="w">  </span><span class="mf">2.687</span><span class="w"> </span><span class="n">s</span><span class="w">    </span><span class="mi">10</span><span class="w"> </span><span class="n">runs</span>

<span class="n">Benchmark</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">raytracer_cg_clif</span>
<span class="w">  </span><span class="n">Time</span><span class="w"> </span><span class="p">(</span><span class="n">mean</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="err">σ</span><span class="p">):</span><span class="w">      </span><span class="mf">2.552</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="err">±</span><span class="w">  </span><span class="mf">0.016</span><span class="w"> </span><span class="n">s</span><span class="w">    </span><span class="p">[</span><span class="n">User</span><span class="p">:</span><span class="w"> </span><span class="mf">2.547</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">System</span><span class="p">:</span><span class="w"> </span><span class="mf">0.004</span><span class="w"> </span><span class="n">s</span><span class="p">]</span>
<span class="w">  </span><span class="n">Range</span><span class="w"> </span><span class="p">(</span><span class="n">min</span><span class="w"> </span><span class="err">…</span><span class="w"> </span><span class="n">max</span><span class="p">):</span><span class="w">    </span><span class="mf">2.539</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="err">…</span><span class="w">  </span><span class="mf">2.588</span><span class="w"> </span><span class="n">s</span><span class="w">    </span><span class="mi">10</span><span class="w"> </span><span class="n">runs</span>

<span class="n">Benchmark</span><span class="w"> </span><span class="mi">3</span><span class="p">:</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">raytracer_cg_clif_opt</span>
<span class="w">  </span><span class="n">Time</span><span class="w"> </span><span class="p">(</span><span class="n">mean</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="err">σ</span><span class="p">):</span><span class="w">      </span><span class="mf">2.151</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="err">±</span><span class="w">  </span><span class="mf">0.022</span><span class="w"> </span><span class="n">s</span><span class="w">    </span><span class="p">[</span><span class="n">User</span><span class="p">:</span><span class="w"> </span><span class="mf">2.147</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">System</span><span class="p">:</span><span class="w"> </span><span class="mf">0.004</span><span class="w"> </span><span class="n">s</span><span class="p">]</span>
<span class="w">  </span><span class="n">Range</span><span class="w"> </span><span class="p">(</span><span class="n">min</span><span class="w"> </span><span class="err">…</span><span class="w"> </span><span class="n">max</span><span class="p">):</span><span class="w">    </span><span class="mf">2.130</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="err">…</span><span class="w">  </span><span class="mf">2.206</span><span class="w"> </span><span class="n">s</span><span class="w">    </span><span class="mi">10</span><span class="w"> </span><span class="n">runs</span>

<span class="n">Summary</span>
<span class="w">  </span><span class="p">.</span><span class="o">/</span><span class="n">raytracer_cg_clif_opt</span><span class="w"> </span><span class="n">ran</span>
<span class="w">    </span><span class="mf">1.19</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">0.01</span><span class="w"> </span><span class="n">times</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">raytracer_cg_clif</span>
<span class="w">    </span><span class="mf">1.24</span><span class="w"> </span><span class="err">±</span><span class="w"> </span><span class="mf">0.01</span><span class="w"> </span><span class="n">times</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">raytracer_cg_llvm</span>
</code></pre></div>



<a name="540800105"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/stack_addr%20%2B%20load/store%20merging/near/540800105" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/stack_addr.20.2B.20load.2Fstore.20merging.html#540800105">(Sep 22 2025 at 13:12)</a>:</h4>
<p><a href="https://github.com/bytecodealliance/wasmtime/pull/11727">https://github.com/bytecodealliance/wasmtime/pull/11727</a> by <span class="user-mention" data-user-id="254389">@Chris Fallin</span> has a better implementation with the same perf benefits.</p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/pull/11727" style="background-image: url(&quot;https://uploads.zulipusercontent.net/ab9ccf2c633a2e152f17cd23b7c5f51ea9324732/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f366535346437623138646631343637613666363933303934336332343234623032326236636435633366383132623264303530303863366166356238383538382f62797465636f6465616c6c69616e63652f7761736d74696d652f70756c6c2f3131373237&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/pull/11727" title="Cranelift: use SP-offset amodes for `stack_addr`+load/store. by cfallin · Pull Request #11727 · bytecodealliance/wasmtime">Cranelift: use SP-offset amodes for `stack_addr`+load/store. by cfallin · Pull Request #11727 · bytecodealliance/wasmtime</a></div><div class="message_embed_description">We provide stack_load/ stack_store / stack_addr instructions in Cranelift to operate on stack slots, and the first two are legalized to a stack_addr plus an ordinary load or store instruction.
We c...</div></div></div>



<a name="540809117"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/stack_addr%20%2B%20load/store%20merging/near/540809117" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Chris Fallin <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/stack_addr.20.2B.20load.2Fstore.20merging.html#540809117">(Sep 22 2025 at 13:48)</a>:</h4>
<p>Ah, I vaguely recalled seeing something about this but couldn’t find an issue — happy this will solve your problem too!</p>



<a name="540813782"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/217117-cranelift/topic/stack_addr%20%2B%20load/store%20merging/near/540813782" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> bjorn3 <a href="https://bytecodealliance.github.io/zulip-archive/stream/217117-cranelift/topic/stack_addr.20.2B.20load.2Fstore.20merging.html#540813782">(Sep 22 2025 at 14:05)</a>:</h4>
<p>Looks like there was an ancient issue for this too: <a href="https://github.com/bytecodealliance/wasmtime/issues/1064">https://github.com/bytecodealliance/wasmtime/issues/1064</a></p>
<div class="message_embed"><a class="message_embed_image" href="https://github.com/bytecodealliance/wasmtime/issues/1064" style="background-image: url(&quot;https://uploads.zulipusercontent.net/411d89797a989c8906e2e2e866150ccd7959bcb8/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f613632663364653336396539633664326164343439376338363739303862623861626630643865313964343266393530383539623133363734633139653937352f62797465636f6465616c6c69616e63652f7761736d74696d652f6973737565732f31303634&quot;)"></a><div class="data-container"><div class="message_embed_title"><a href="https://github.com/bytecodealliance/wasmtime/issues/1064" title="Optimize `stack_store` and `stack_load` · Issue #1064 · bytecodealliance/wasmtime">Optimize `stack_store` and `stack_load` · Issue #1064 · bytecodealliance/wasmtime</a></div><div class="message_embed_description">Currently, stack_store and stack_load are legalized into stack_addr followed by plain store and load, producing code like this: lea rax, qword ptr [rsp + 8] mov qword ptr [rax], rdi We really want ...</div></div></div>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
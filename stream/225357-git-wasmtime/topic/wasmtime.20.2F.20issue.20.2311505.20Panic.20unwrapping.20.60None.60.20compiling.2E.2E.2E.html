<html>
<head><meta charset="utf-8"><title>wasmtime / issue #11505 Panic unwrapping `None` compiling... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311505.20Panic.20unwrapping.20.60None.60.20compiling.2E.2E.2E.html">wasmtime / issue #11505 Panic unwrapping `None` compiling...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="535592571"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311505%20Panic%20unwrapping%20%60None%60%20compiling.../near/535592571" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311505.20Panic.20unwrapping.20.60None.60.20compiling.2E.2E.2E.html#535592571">(Aug 21 2025 at 23:27)</a>:</h4>
<p>alexcrichton opened <a href="https://github.com/bytecodealliance/wasmtime/issues/11505">issue #11505</a>:</p>
<blockquote>
<p>This input:</p>
<div class="codehilite" data-code-language="wasm"><pre><span></span><code>(module
  (type (;0;) (func))
  (tag (;0;) (type 0))
  (global (;0;) (mut i32) i32.const 1000)
  (export "" (func 0))
  (func (;0;) (type 0)
    global.get 0
    i32.eqz
    if ;; label = @1
      unreachable
    end
    global.get 0
    i32.const 1
    i32.sub
    global.set 0
    loop (type 0) ;; label = @1
      global.get 0
      i32.eqz
      if ;; label = @2
        unreachable
      end
      global.get 0
      i32.const 1
      i32.sub
      global.set 0
      return_call 0
      try_table ;; label = @2
        try_table (type 0) (catch_all 0 (;@2;)) (catch_all 0 (;@2;)) (catch_all 0 (;@2;)) ;; label = @3
        end
      end
    end
  )
)
</code></pre></div>
<p>panics with:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">testcase0</span><span class="p">.</span><span class="n">wat</span><span class="w"> </span><span class="o">-</span><span class="n">W</span><span class="w"> </span><span class="n">exceptions</span>
<span class="w">    </span><span class="n">Finished</span><span class="w"> </span><span class="err">`</span><span class="n">dev</span><span class="err">`</span><span class="w"> </span><span class="n">profile</span><span class="w"> </span><span class="p">[</span><span class="n">unoptimized</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">debuginfo</span><span class="p">]</span><span class="w"> </span><span class="n">target</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">0.10</span><span class="n">s</span>
<span class="w">     </span><span class="n">Running</span><span class="w"> </span><span class="err">`</span><span class="n">target</span><span class="o">/</span><span class="n">x86_64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">wasmtime</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">testcase0</span><span class="p">.</span><span class="n">wat</span><span class="w"> </span><span class="o">-</span><span class="n">W</span><span class="w"> </span><span class="n">exceptions</span><span class="err">`</span>

<span class="n">thread</span><span class="w"> </span><span class="o">'&lt;</span><span class="n">unnamed</span><span class="o">&gt;'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">crates</span><span class="o">/</span><span class="n">cranelift</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">translate</span><span class="o">/</span><span class="n">code_translator</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">3162</span><span class="p">:</span><span class="mi">45</span><span class="p">:</span>
<span class="nc">called</span><span class="w"> </span><span class="err">`</span><span class="nb">Option</span><span class="p">::</span><span class="n">unwrap</span><span class="p">()</span><span class="err">`</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="err">`</span><span class="nb">None</span><span class="err">`</span><span class="w"> </span><span class="n">value</span>
<span class="n">note</span><span class="p">:</span><span class="w"> </span><span class="nc">run</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="err">`</span><span class="n">RUST_BACKTRACE</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">display</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">backtrace</span>
</code></pre></div>
<p>@cfallin I was curious to see what would happen since wasm-smith has support for exceptions. I don't think the support is too useful from a runtime perspective but it's likely interesting from a compile-time perspective (similar with most of our other wasm-smith-generated modules). If you're curious this is the diff I used to get <code>differential</code> running and it took a few seconds to find the above case:</p>
<p>&lt;details&gt;</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gh">diff --git a/crates/fuzzing/src/generators/config.rs b/crates/fuzzing/src/generators/config.rs</span>
<span class="gh">index 553bbea530..72b9c0fc46 100644</span>
<span class="gd">--- a/crates/fuzzing/src/generators/config.rs</span>
<span class="gi">+++ b/crates/fuzzing/src/generators/config.rs</span>
<span class="gu">@@ -662,6 +662,7 @@ impl WasmtimeConfig {</span>
<span class="w"> </span>                config.config.gc_enabled = false;
<span class="w"> </span>                config.config.tail_call_enabled = false;
<span class="w"> </span>                config.config.reference_types_enabled = false;
<span class="gi">+                config.config.exceptions_enabled = false;</span>
<span class="w"> </span>                config.function_references_enabled = false;

<span class="w"> </span>                // Winch's SIMD implementations require AVX and AVX2.
<span class="gh">diff --git a/crates/fuzzing/src/generators/module.rs b/crates/fuzzing/src/generators/module.rs</span>
<span class="gh">index 97078890b8..7b65c92c4c 100644</span>
<span class="gd">--- a/crates/fuzzing/src/generators/module.rs</span>
<span class="gi">+++ b/crates/fuzzing/src/generators/module.rs</span>
<span class="gu">@@ -48,7 +48,7 @@ impl&lt;'a&gt; Arbitrary&lt;'a&gt; for ModuleConfig {</span>
<span class="w"> </span>        let _ = config.tail_call_enabled;
<span class="w"> </span>        let _ = config.extended_const_enabled;
<span class="w"> </span>        let _ = config.gc_enabled;
<span class="gd">-        config.exceptions_enabled = false;</span>
<span class="gi">+        let _ = config.exceptions_enabled;</span>
<span class="w"> </span>        config.custom_page_sizes_enabled = u.arbitrary()?;
<span class="w"> </span>        config.wide_arithmetic_enabled = u.arbitrary()?;
<span class="w"> </span>        config.memory64_enabled = u.ratio(1, 20)?;
<span class="gh">diff --git a/crates/fuzzing/src/oracles.rs b/crates/fuzzing/src/oracles.rs</span>
<span class="gh">index 39e6a948fc..1e717ccd44 100644</span>
<span class="gd">--- a/crates/fuzzing/src/oracles.rs</span>
<span class="gi">+++ b/crates/fuzzing/src/oracles.rs</span>
<span class="gu">@@ -1417,7 +1417,8 @@ mod tests {</span>
<span class="w"> </span>            | WasmFeatures::GC
<span class="w"> </span>            | WasmFeatures::GC_TYPES
<span class="w"> </span>            | WasmFeatures::CUSTOM_PAGE_SIZES
<span class="gd">-            | WasmFeatures::EXTENDED_CONST;</span>
<span class="gi">+            | WasmFeatures::EXTENDED_CONST</span>
<span class="gi">+            | WasmFeatures::EXCEPTIONS;</span>

<span class="w"> </span>        // All other features that wasmparser supports, which is presumably a
<span class="w"> </span>        // superset of the features that wasm-smith supports, are listed here as
<span class="gh">diff --git a/crates/fuzzing/src/oracles/diff_spec.rs b/crates/fuzzing/src/oracles/diff_spec.rs</span>
<span class="gh">index 643e9cb3b4..c5b9edbafc 100644</span>
<span class="gd">--- a/crates/fuzzing/src/oracles/diff_spec.rs</span>
<span class="gi">+++ b/crates/fuzzing/src/oracles/diff_spec.rs</span>
<span class="gu">@@ -28,6 +28,7 @@ impl SpecInterpreter {</span>
<span class="w"> </span>        config.custom_page_sizes_enabled = false;
<span class="w"> </span>        config.wide_arithmetic_enabled = false;
<span class="w"> </span>        config.extended_const_enabled = false;
<span class="gi">+        config.exceptions_enabled = false;</span>

<span class="w"> </span>        Self
<span class="w"> </span>    }
</code></pre></div>
<p>&lt;/details&gt;</p>
</blockquote>



<a name="535592573"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311505%20Panic%20unwrapping%20%60None%60%20compiling.../near/535592573" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311505.20Panic.20unwrapping.20.60None.60.20compiling.2E.2E.2E.html#535592573">(Aug 21 2025 at 23:27)</a>:</h4>
<p><a href="https://github.com/alexcrichton">alexcrichton</a> added the fuzz-bug label to <a href="https://github.com/bytecodealliance/wasmtime/issues/11505">Issue #11505</a>.</p>



<a name="535592575"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311505%20Panic%20unwrapping%20%60None%60%20compiling.../near/535592575" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311505.20Panic.20unwrapping.20.60None.60.20compiling.2E.2E.2E.html#535592575">(Aug 21 2025 at 23:27)</a>:</h4>
<p><a href="https://github.com/alexcrichton">alexcrichton</a> added the wasm-proposal:exceptions label to <a href="https://github.com/bytecodealliance/wasmtime/issues/11505">Issue #11505</a>.</p>



<a name="535594427"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311505%20Panic%20unwrapping%20%60None%60%20compiling.../near/535594427" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311505.20Panic.20unwrapping.20.60None.60.20compiling.2E.2E.2E.html#535594427">(Aug 21 2025 at 23:56)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/11505#issuecomment-3212495294">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11505">issue #11505</a>:</p>
<blockquote>
<p>Thanks; taking a look!</p>
</blockquote>



<a name="535600194"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311505%20Panic%20unwrapping%20%60None%60%20compiling.../near/535600194" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311505.20Panic.20unwrapping.20.60None.60.20compiling.2E.2E.2E.html#535600194">(Aug 22 2025 at 01:19)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/11505#issuecomment-3212652853">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11505">issue #11505</a>:</p>
<blockquote>
<p>Minimizes to</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">(</span><span class="n">module</span>
<span class="w">  </span><span class="p">(</span><span class="n">func</span>
<span class="w">    </span><span class="p">(</span><span class="n">unreachable</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">try_table</span><span class="p">)))</span>
</code></pre></div>
<p>and happens because I missed adding a control-stack entry in the unreachable-code handler in the translator for a <code>try_block</code>, so we underflow the control stack. PR incoming.</p>
</blockquote>



<a name="535609391"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311505%20Panic%20unwrapping%20%60None%60%20compiling.../near/535609391" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311505.20Panic.20unwrapping.20.60None.60.20compiling.2E.2E.2E.html#535609391">(Aug 22 2025 at 03:42)</a>:</h4>
<p>alexcrichton closed <a href="https://github.com/bytecodealliance/wasmtime/issues/11505">issue #11505</a>:</p>
<blockquote>
<p>This input:</p>
<div class="codehilite" data-code-language="wasm"><pre><span></span><code>(module
  (type (;0;) (func))
  (tag (;0;) (type 0))
  (global (;0;) (mut i32) i32.const 1000)
  (export "" (func 0))
  (func (;0;) (type 0)
    global.get 0
    i32.eqz
    if ;; label = @1
      unreachable
    end
    global.get 0
    i32.const 1
    i32.sub
    global.set 0
    loop (type 0) ;; label = @1
      global.get 0
      i32.eqz
      if ;; label = @2
        unreachable
      end
      global.get 0
      i32.const 1
      i32.sub
      global.set 0
      return_call 0
      try_table ;; label = @2
        try_table (type 0) (catch_all 0 (;@2;)) (catch_all 0 (;@2;)) (catch_all 0 (;@2;)) ;; label = @3
        end
      end
    end
  )
)
</code></pre></div>
<p>panics with:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">testcase0</span><span class="p">.</span><span class="n">wat</span><span class="w"> </span><span class="o">-</span><span class="n">W</span><span class="w"> </span><span class="n">exceptions</span>
<span class="w">    </span><span class="n">Finished</span><span class="w"> </span><span class="err">`</span><span class="n">dev</span><span class="err">`</span><span class="w"> </span><span class="n">profile</span><span class="w"> </span><span class="p">[</span><span class="n">unoptimized</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">debuginfo</span><span class="p">]</span><span class="w"> </span><span class="n">target</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">0.10</span><span class="n">s</span>
<span class="w">     </span><span class="n">Running</span><span class="w"> </span><span class="err">`</span><span class="n">target</span><span class="o">/</span><span class="n">x86_64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">wasmtime</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">testcase0</span><span class="p">.</span><span class="n">wat</span><span class="w"> </span><span class="o">-</span><span class="n">W</span><span class="w"> </span><span class="n">exceptions</span><span class="err">`</span>

<span class="n">thread</span><span class="w"> </span><span class="o">'&lt;</span><span class="n">unnamed</span><span class="o">&gt;'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">crates</span><span class="o">/</span><span class="n">cranelift</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">translate</span><span class="o">/</span><span class="n">code_translator</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">3162</span><span class="p">:</span><span class="mi">45</span><span class="p">:</span>
<span class="nc">called</span><span class="w"> </span><span class="err">`</span><span class="nb">Option</span><span class="p">::</span><span class="n">unwrap</span><span class="p">()</span><span class="err">`</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="err">`</span><span class="nb">None</span><span class="err">`</span><span class="w"> </span><span class="n">value</span>
<span class="n">note</span><span class="p">:</span><span class="w"> </span><span class="nc">run</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="err">`</span><span class="n">RUST_BACKTRACE</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">display</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">backtrace</span>
</code></pre></div>
<p>@cfallin I was curious to see what would happen since wasm-smith has support for exceptions. I don't think the support is too useful from a runtime perspective but it's likely interesting from a compile-time perspective (similar with most of our other wasm-smith-generated modules). If you're curious this is the diff I used to get <code>differential</code> running and it took a few seconds to find the above case:</p>
<p>&lt;details&gt;</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gh">diff --git a/crates/fuzzing/src/generators/config.rs b/crates/fuzzing/src/generators/config.rs</span>
<span class="gh">index 553bbea530..72b9c0fc46 100644</span>
<span class="gd">--- a/crates/fuzzing/src/generators/config.rs</span>
<span class="gi">+++ b/crates/fuzzing/src/generators/config.rs</span>
<span class="gu">@@ -662,6 +662,7 @@ impl WasmtimeConfig {</span>
<span class="w"> </span>                config.config.gc_enabled = false;
<span class="w"> </span>                config.config.tail_call_enabled = false;
<span class="w"> </span>                config.config.reference_types_enabled = false;
<span class="gi">+                config.config.exceptions_enabled = false;</span>
<span class="w"> </span>                config.function_references_enabled = false;

<span class="w"> </span>                // Winch's SIMD implementations require AVX and AVX2.
<span class="gh">diff --git a/crates/fuzzing/src/generators/module.rs b/crates/fuzzing/src/generators/module.rs</span>
<span class="gh">index 97078890b8..7b65c92c4c 100644</span>
<span class="gd">--- a/crates/fuzzing/src/generators/module.rs</span>
<span class="gi">+++ b/crates/fuzzing/src/generators/module.rs</span>
<span class="gu">@@ -48,7 +48,7 @@ impl&lt;'a&gt; Arbitrary&lt;'a&gt; for ModuleConfig {</span>
<span class="w"> </span>        let _ = config.tail_call_enabled;
<span class="w"> </span>        let _ = config.extended_const_enabled;
<span class="w"> </span>        let _ = config.gc_enabled;
<span class="gd">-        config.exceptions_enabled = false;</span>
<span class="gi">+        let _ = config.exceptions_enabled;</span>
<span class="w"> </span>        config.custom_page_sizes_enabled = u.arbitrary()?;
<span class="w"> </span>        config.wide_arithmetic_enabled = u.arbitrary()?;
<span class="w"> </span>        config.memory64_enabled = u.ratio(1, 20)?;
<span class="gh">diff --git a/crates/fuzzing/src/oracles.rs b/crates/fuzzing/src/oracles.rs</span>
<span class="gh">index 39e6a948fc..1e717ccd44 100644</span>
<span class="gd">--- a/crates/fuzzing/src/oracles.rs</span>
<span class="gi">+++ b/crates/fuzzing/src/oracles.rs</span>
<span class="gu">@@ -1417,7 +1417,8 @@ mod tests {</span>
<span class="w"> </span>            | WasmFeatures::GC
<span class="w"> </span>            | WasmFeatures::GC_TYPES
<span class="w"> </span>            | WasmFeatures::CUSTOM_PAGE_SIZES
<span class="gd">-            | WasmFeatures::EXTENDED_CONST;</span>
<span class="gi">+            | WasmFeatures::EXTENDED_CONST</span>
<span class="gi">+            | WasmFeatures::EXCEPTIONS;</span>

<span class="w"> </span>        // All other features that wasmparser supports, which is presumably a
<span class="w"> </span>        // superset of the features that wasm-smith supports, are listed here as
<span class="gh">diff --git a/crates/fuzzing/src/oracles/diff_spec.rs b/crates/fuzzing/src/oracles/diff_spec.rs</span>
<span class="gh">index 643e9cb3b4..c5b9edbafc 100644</span>
<span class="gd">--- a/crates/fuzzing/src/oracles/diff_spec.rs</span>
<span class="gi">+++ b/crates/fuzzing/src/oracles/diff_spec.rs</span>
<span class="gu">@@ -28,6 +28,7 @@ impl SpecInterpreter {</span>
<span class="w"> </span>        config.custom_page_sizes_enabled = false;
<span class="w"> </span>        config.wide_arithmetic_enabled = false;
<span class="w"> </span>        config.extended_const_enabled = false;
<span class="gi">+        config.exceptions_enabled = false;</span>

<span class="w"> </span>        Self
<span class="w"> </span>    }
</code></pre></div>
<p>&lt;/details&gt;</p>
</blockquote>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
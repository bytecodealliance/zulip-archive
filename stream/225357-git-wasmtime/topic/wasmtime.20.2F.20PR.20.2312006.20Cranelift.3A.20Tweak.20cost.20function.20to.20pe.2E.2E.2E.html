<html>
<head><meta charset="utf-8"><title>wasmtime / PR #12006 Cranelift: Tweak cost function to pe... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312006.20Cranelift.3A.20Tweak.20cost.20function.20to.20pe.2E.2E.2E.html">wasmtime / PR #12006 Cranelift: Tweak cost function to pe...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="554386595"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312006%20Cranelift%3A%20Tweak%20cost%20function%20to%20pe.../near/554386595" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312006.20Cranelift.3A.20Tweak.20cost.20function.20to.20pe.2E.2E.2E.html#554386595">(Nov 07 2025 at 18:08)</a>:</h4>
<p>fitzgen opened <a href="https://github.com/bytecodealliance/wasmtime/pull/12006">PR #12006</a> from <code>fitzgen:dont-select-select</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p><code>select</code>s cannot be speculated through on some of our targets (e.g. x64) so strongly prefer not choosing them.</p>
<p>Using a target-specific cost function, so that we only pessimize <code>select</code> when it makes sense, is left for follow up work and is tracked in #12005.</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="554386598"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312006%20Cranelift%3A%20Tweak%20cost%20function%20to%20pe.../near/554386598" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312006.20Cranelift.3A.20Tweak.20cost.20function.20to.20pe.2E.2E.2E.html#554386598">(Nov 07 2025 at 18:08)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/alexcrichton">alexcrichton</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/12006">PR #12006</a>.</p>



<a name="554386600"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312006%20Cranelift%3A%20Tweak%20cost%20function%20to%20pe.../near/554386600" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312006.20Cranelift.3A.20Tweak.20cost.20function.20to.20pe.2E.2E.2E.html#554386600">(Nov 07 2025 at 18:08)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/12006">PR #12006</a>.</p>



<a name="554387019"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312006%20Cranelift%3A%20Tweak%20cost%20function%20to%20pe.../near/554387019" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312006.20Cranelift.3A.20Tweak.20cost.20function.20to.20pe.2E.2E.2E.html#554387019">(Nov 07 2025 at 18:10)</a>:</h4>
<p>fitzgen edited <a href="https://github.com/bytecodealliance/wasmtime/pull/12006">PR #12006</a>:</p>
<blockquote>
<p><code>select</code>s cannot be speculated through on some of our targets (e.g. x64) so strongly prefer not choosing them.</p>
<p>Using a target-specific cost function, so that we only pessimize <code>select</code> when it makes sense for the target, is left for follow up work and is tracked in #12005. FWIW, no CPUs on the market do value speculation today, as far as I am aware, so this particular case is somewhat hypothetical (but the larger goal of target-specific cost functions would still be useful).</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="554387880"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312006%20Cranelift%3A%20Tweak%20cost%20function%20to%20pe.../near/554387880" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312006.20Cranelift.3A.20Tweak.20cost.20function.20to.20pe.2E.2E.2E.html#554387880">(Nov 07 2025 at 18:15)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/12006#issuecomment-3504073494">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/12006">PR #12006</a>:</p>
<blockquote>
<blockquote>
<p>selects cannot be speculated through on some of our targets (e.g. x64) so strongly prefer not choosing them.</p>
</blockquote>
<p>FWIW, I think this is losing a little nuance and the reality doesn't merit a cost of 50 (!). In more detail, select (cmove) works like any other multi-input operator on modern out-of-order CPUs; the main difference is that it has three inputs (flags/condition, source for the CMOVcc, old register value for the CMOVcc). When all three inputs are ready, the instruction will execute.</p>
<p>When folks say that "select isn't speculated through" what they mean is that the CPU doesn't have a condition predictor (like the branch predictor) that will allow the instruction to speculatively go without the condition input ready. It doesn't mean, however, that the instruction blocks all speculation or serves as a pipeline barrier/flush. That would be far worse!</p>
<p>Supporting source: <a href="https://www.agner.org/optimize/instruction_tables.pdf">Agner Fog's instruction latency tables</a> show on a reasonable x86-64 baseline (Skylake, circa 2015), CMOVcc reg/reg form is 1 uop and has a latency of 1 cycle and a reciprocal throughput of 0.5 (so two CMOVccs can complete per cycle).</p>
</blockquote>



<a name="554388943"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312006%20Cranelift%3A%20Tweak%20cost%20function%20to%20pe.../near/554388943" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312006.20Cranelift.3A.20Tweak.20cost.20function.20to.20pe.2E.2E.2E.html#554388943">(Nov 07 2025 at 18:20)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/cfallin">cfallin</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/12006">PR #12006</a>.</p>



<a name="554394290"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312006%20Cranelift%3A%20Tweak%20cost%20function%20to%20pe.../near/554394290" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312006.20Cranelift.3A.20Tweak.20cost.20function.20to.20pe.2E.2E.2E.html#554394290">(Nov 07 2025 at 18:48)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/12006">PR #12006</a>.</p>



<a name="554394737"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312006%20Cranelift%3A%20Tweak%20cost%20function%20to%20pe.../near/554394737" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312006.20Cranelift.3A.20Tweak.20cost.20function.20to.20pe.2E.2E.2E.html#554394737">(Nov 07 2025 at 18:51)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/pull/12006#issuecomment-3504268951">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/12006">PR #12006</a>:</p>
<blockquote>
<p>@cfallin I was indeed not thinking in a nuanced way about this, thanks for the clarifications/reality check.</p>
<p>I removed the <code>select</code> special case, so it will hit the default cost, which will be slightly greater than the cost of adds/etc.</p>
<p>I left <code>imul</code> at cost 10 though.</p>
</blockquote>



<hr><p>Last updated: Feb 22 2026 at 11:05 UTC</p>
</html>
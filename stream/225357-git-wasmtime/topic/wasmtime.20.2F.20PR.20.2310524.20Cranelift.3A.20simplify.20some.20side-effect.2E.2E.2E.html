<html>
<head><meta charset="utf-8"><title>wasmtime / PR #10524 Cranelift: simplify some side-effect... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310524.20Cranelift.3A.20simplify.20some.20side-effect.2E.2E.2E.html">wasmtime / PR #10524 Cranelift: simplify some side-effect...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="510307424"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310524%20Cranelift%3A%20simplify%20some%20side-effect.../near/510307424" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310524.20Cranelift.3A.20simplify.20some.20side-effect.2E.2E.2E.html#510307424">(Apr 04 2025 at 23:31)</a>:</h4>
<p>fitzgen opened <a href="https://github.com/bytecodealliance/wasmtime/pull/10524">PR #10524</a> from <code>fitzgen:simplify-skeleton</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>This commit adds a new top-level ISLE entrypoint specifically for instructions in the side-effectful skeleton: <code>simplify_skeleton</code>. While these rewrites are processed during the egraph pass, values from skeleton instructions still do not get inserted into the egraph. Indeed, <code>simplify_skeleton</code> operates on <em>instructions</em> rather than <em>values</em> because we do not represent side effects as values; values do not have side effects in CLIF, instructions do. Therefore, rather than doing a whole dynamic-programming style extraction of the best candidate simplification like we do with the egraph, we take an eager and greedy approach.</p>
<p>Furthermore, <code>simplify_skeleton</code> is limited only to skeleton instructions that do not involve control-flow or terminators right now. This is because changing the control-flow graph can change whether a use is dominated by a def or not, and we do not currently have the machinery to track and fix up invalidated uses. Addressing this is left for future commits.</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="510307425"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310524%20Cranelift%3A%20simplify%20some%20side-effect.../near/510307425" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310524.20Cranelift.3A.20simplify.20some.20side-effect.2E.2E.2E.html#510307425">(Apr 04 2025 at 23:31)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/cfallin">cfallin</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/10524">PR #10524</a>.</p>



<a name="510307427"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310524%20Cranelift%3A%20simplify%20some%20side-effect.../near/510307427" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310524.20Cranelift.3A.20simplify.20some.20side-effect.2E.2E.2E.html#510307427">(Apr 04 2025 at 23:31)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/10524">PR #10524</a>.</p>



<a name="510307429"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310524%20Cranelift%3A%20simplify%20some%20side-effect.../near/510307429" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310524.20Cranelift.3A.20simplify.20some.20side-effect.2E.2E.2E.html#510307429">(Apr 04 2025 at 23:31)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/pchickey">pchickey</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/10524">PR #10524</a>.</p>



<a name="510307431"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310524%20Cranelift%3A%20simplify%20some%20side-effect.../near/510307431" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310524.20Cranelift.3A.20simplify.20some.20side-effect.2E.2E.2E.html#510307431">(Apr 04 2025 at 23:31)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers">wasmtime-core-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/10524">PR #10524</a>.</p>



<a name="510309086"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310524%20Cranelift%3A%20simplify%20some%20side-effect.../near/510309086" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310524.20Cranelift.3A.20simplify.20some.20side-effect.2E.2E.2E.html#510309086">(Apr 04 2025 at 23:50)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/pull/10524#issuecomment-2779912660">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/10524">PR #10524</a>:</p>
<blockquote>
<p>FWIW, I just did a sightglass run, and this had no statistically significant effect on any of our default benchmarks. If you look at the disas test expectation updates however, you’ll see that it is a big boon for gc codegen.</p>
</blockquote>



<a name="510309352"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310524%20Cranelift%3A%20simplify%20some%20side-effect.../near/510309352" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310524.20Cranelift.3A.20simplify.20some.20side-effect.2E.2E.2E.html#510309352">(Apr 04 2025 at 23:54)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/10524">PR #10524</a>.</p>



<a name="510320536"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310524%20Cranelift%3A%20simplify%20some%20side-effect.../near/510320536" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310524.20Cranelift.3A.20simplify.20some.20side-effect.2E.2E.2E.html#510320536">(Apr 05 2025 at 02:13)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/10524#issuecomment-2780141295">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/10524">PR #10524</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @cfallin, @fitzgen</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "cranelift", "cranelift:area:machinst", "cranelift:meta", "isle"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>cfallin: isle</li>
<li>fitzgen: isle</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="510788437"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310524%20Cranelift%3A%20simplify%20some%20side-effect.../near/510788437" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310524.20Cranelift.3A.20simplify.20some.20side-effect.2E.2E.2E.html#510788437">(Apr 08 2025 at 00:06)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/10524#pullrequestreview-2748347642">PR review</a>:</p>
<blockquote>
<p>Looks great -- very cool to see the GC tests clean up with the new opts in particular!</p>
<p>I think I mentioned it last week but just to write it down: I suspect a good way to lift some of the CFG-mutation limitations around traps would be to make <code>trap</code> a non-terminator, and to add <code>unreachable</code> as a terminator. This would allow us to turn insts that we can prove always trap into <code>trap</code> (e.g. the <code>sdiv</code> case mentioned below, as well as trapnz-of-1 and trapz-of-0). The branch-folding cases are a bit harder; ideally we do actually skip traversing the newly-unreachable blocks, perhaps by tombstoning them with a flag set by the branch simplification. Would you mind creating a followup issue for this?</p>
</blockquote>



<a name="510788439"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310524%20Cranelift%3A%20simplify%20some%20side-effect.../near/510788439" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310524.20Cranelift.3A.20simplify.20some.20side-effect.2E.2E.2E.html#510788439">(Apr 08 2025 at 00:06)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/10524#discussion_r2032164529">PR review comment</a>:</p>
<blockquote>
<p>Idle thought: we have the "temporarily take a reused thing then clear it" pattern in several places -- would it be possible to factor this out into a macro, with pluggable bits for the vec type and parent type and field name?</p>
</blockquote>



<a name="510788440"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310524%20Cranelift%3A%20simplify%20some%20side-effect.../near/510788440" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310524.20Cranelift.3A.20simplify.20some.20side-effect.2E.2E.2E.html#510788440">(Apr 08 2025 at 00:06)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/10524#discussion_r2032169911">PR review comment</a>:</p>
<blockquote>
<p>Can we add a test for <code>INT_MIN / -1</code> and show that it remains un-cprop'd?</p>
<p>(It would be even neater if it could change into an unconditional trap but I know that's a limitation at the moment)</p>
</blockquote>



<a name="510972681"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310524%20Cranelift%3A%20simplify%20some%20side-effect.../near/510972681" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310524.20Cranelift.3A.20simplify.20some.20side-effect.2E.2E.2E.html#510972681">(Apr 08 2025 at 16:03)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/10524#pullrequestreview-2750563822">PR review</a>.</p>



<a name="510972682"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310524%20Cranelift%3A%20simplify%20some%20side-effect.../near/510972682" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310524.20Cranelift.3A.20simplify.20some.20side-effect.2E.2E.2E.html#510972682">(Apr 08 2025 at 16:03)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/10524#discussion_r2033537436">PR review comment</a>:</p>
<blockquote>
<p>Sure, I can do this in a follow up</p>
</blockquote>



<a name="510977034"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310524%20Cranelift%3A%20simplify%20some%20side-effect.../near/510977034" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310524.20Cranelift.3A.20simplify.20some.20side-effect.2E.2E.2E.html#510977034">(Apr 08 2025 at 16:23)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/pull/10524#issuecomment-2787005798">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/10524">PR #10524</a>:</p>
<blockquote>
<blockquote>
<p>I think I mentioned it last week but just to write it down: I suspect a good way to lift some of the CFG-mutation limitations around traps would be to make <code>trap</code> a non-terminator, and to add <code>unreachable</code> as a terminator.</p>
</blockquote>
<p>Yes, we could even avoid a new <code>unreachable</code> instruction if we wanted by adding a <code>terminator: bool</code> to <code>trap</code>, if we wanted, since we should have the bytes available in the <code>InstructionData</code>.</p>
<p>Or if we do want two different instructions, it is probably easier to make the new instruction the non-terminator, so that existing uses of <code>trap</code> don't need updating.</p>
<p>I had also floated the idea of <code>trap</code> returning a variable number of values, that we could use as dummy values in now-unreachable uses, just as a convenience and to make the branch-folding a little simpler to deal with (rather than requiring tracking reachability perfectly). This could be an intermediate step since it would allow us to avoid perfectly tracking and fixing up unreachable blocks, but keeping dominating defs for any now-unreachable blocks' uses.</p>
<blockquote>
<p>The branch-folding cases are a bit harder; ideally we do actually skip traversing the newly-unreachable blocks, perhaps by tombstoning them with a flag set by the branch simplification. Would you mind creating a followup issue for this?</p>
</blockquote>
<p>We also would need to differentiate between blocks that do vs don't become unreachable, which is a further little wrinkle.</p>
<p>But yeah, happy to write up an issue.</p>
</blockquote>



<a name="510990173"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310524%20Cranelift%3A%20simplify%20some%20side-effect.../near/510990173" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310524.20Cranelift.3A.20simplify.20some.20side-effect.2E.2E.2E.html#510990173">(Apr 08 2025 at 17:31)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/10524">PR #10524</a>.</p>



<a name="510991585"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310524%20Cranelift%3A%20simplify%20some%20side-effect.../near/510991585" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310524.20Cranelift.3A.20simplify.20some.20side-effect.2E.2E.2E.html#510991585">(Apr 08 2025 at 17:38)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/10524">PR #10524</a>.</p>



<a name="510991609"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310524%20Cranelift%3A%20simplify%20some%20side-effect.../near/510991609" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310524.20Cranelift.3A.20simplify.20some.20side-effect.2E.2E.2E.html#510991609">(Apr 08 2025 at 17:38)</a>:</h4>
<p>fitzgen has enabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/10524">PR #10524</a>.</p>



<a name="510998800"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310524%20Cranelift%3A%20simplify%20some%20side-effect.../near/510998800" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310524.20Cranelift.3A.20simplify.20some.20side-effect.2E.2E.2E.html#510998800">(Apr 08 2025 at 18:18)</a>:</h4>
<p>fitzgen merged <a href="https://github.com/bytecodealliance/wasmtime/pull/10524">PR #10524</a>.</p>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
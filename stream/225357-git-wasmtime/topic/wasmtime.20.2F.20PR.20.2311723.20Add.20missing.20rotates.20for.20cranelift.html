<html>
<head><meta charset="utf-8"><title>wasmtime / PR #11723 Add missing rotates for cranelift · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311723.20Add.20missing.20rotates.20for.20cranelift.html">wasmtime / PR #11723 Add missing rotates for cranelift</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="540546288"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311723%20Add%20missing%20rotates%20for%20cranelift/near/540546288" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311723.20Add.20missing.20rotates.20for.20cranelift.html#540546288">(Sep 19 2025 at 23:56)</a>:</h4>
<p>khagankhan opened <a href="https://github.com/bytecodealliance/wasmtime/pull/11723">PR #11723</a> from <code>khagankhan:rotate-mo</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>This adds the missed rotate optimizations in cranelift mid-end opened in #11722 </p>
<div class="codehilite" data-code-language="wasm"><pre><span></span><code>(module
  (func $main (export "main") (result i32)
    ;; Step 1: (i32.rotl (i32.const 1) (i32.const 1))
    ;; 1 in binary (32-bit) = 0b...0001
    ;; Rotate left by 1 bit = 0b...0010 = 2
    (i32.rotl (i32.const 1) (i32.const 1))

    ;; Step 2: (i32.rotr (i32.const 10) (i32.const 1))
    ;; 10 in binary = 0b...1010
    ;; Rotate right by 1 bit = 0b...0101 = 5
    (i32.rotr (i32.const 10) (i32.const 1))

    ;; Step 3: Add the results
    ;; 2 + 5 = 7
    (i32.add)
  )
)
</code></pre></div>
<p>Before PR: </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">;;</span><span class="w"> </span><span class="n">Intermediate</span><span class="w"> </span><span class="n">Representation</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="o">&lt;</span><span class="n">wasm</span><span class="p">[</span><span class="mi">0</span><span class="p">]::</span><span class="n">function</span><span class="p">[</span><span class="mi">0</span><span class="p">]::</span><span class="n">main</span><span class="o">&gt;</span><span class="p">:</span>
<span class="nc">function</span><span class="w"> </span><span class="n">u0</span><span class="p">:</span><span class="mi">0</span><span class="p">(</span><span class="kt">i64</span><span class="w"> </span><span class="n">vmctx</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nc">tail</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">gv0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vmctx</span>
<span class="w">    </span><span class="n">gv1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">readonly</span><span class="w"> </span><span class="n">gv0</span><span class="o">+</span><span class="mi">8</span>
<span class="w">    </span><span class="n">gv2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">gv1</span><span class="o">+</span><span class="mi">16</span>
<span class="w">    </span><span class="n">stack_limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gv2</span>

<span class="w">                                </span><span class="n">block0</span><span class="p">(</span><span class="n">v0</span><span class="p">:</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="p">:</span><span class="w"> </span><span class="kt">i64</span><span class="p">):</span>
<span class="o">@</span><span class="mi">002</span><span class="n">d</span><span class="w">                               </span><span class="n">jump</span><span class="w"> </span><span class="n">block1</span>

<span class="w">                                </span><span class="n">block1</span><span class="p">:</span>
<span class="o">@</span><span class="mi">0022</span><span class="w">                               </span><span class="n">v3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="mi">1</span>
<span class="o">@</span><span class="mi">0026</span><span class="w">                               </span><span class="n">v5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rotl</span><span class="w"> </span><span class="n">v3</span><span class="p">,</span><span class="w"> </span><span class="n">v3</span><span class="w">  </span><span class="p">;</span><span class="w"> </span><span class="n">v3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">v3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="o">@</span><span class="mi">0027</span><span class="w">                               </span><span class="n">v6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="mi">10</span>
<span class="o">@</span><span class="mi">002</span><span class="n">b</span><span class="w">                               </span><span class="n">v8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rotr</span><span class="w"> </span><span class="n">v6</span><span class="p">,</span><span class="w"> </span><span class="n">v3</span><span class="w">  </span><span class="p">;</span><span class="w"> </span><span class="n">v6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="n">v3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="o">@</span><span class="mi">002</span><span class="n">c</span><span class="w">                               </span><span class="n">v9</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd</span><span class="w"> </span><span class="n">v5</span><span class="p">,</span><span class="w"> </span><span class="n">v8</span>
<span class="o">@</span><span class="mi">002</span><span class="n">d</span><span class="w">                               </span><span class="k">return</span><span class="w"> </span><span class="n">v9</span>
<span class="p">}</span>
</code></pre></div>
<p>After PR:</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">;;</span><span class="w"> </span><span class="n">Intermediate</span><span class="w"> </span><span class="n">Representation</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="o">&lt;</span><span class="n">wasm</span><span class="p">[</span><span class="mi">0</span><span class="p">]::</span><span class="n">function</span><span class="p">[</span><span class="mi">0</span><span class="p">]::</span><span class="n">main</span><span class="o">&gt;</span><span class="p">:</span>
<span class="nc">function</span><span class="w"> </span><span class="n">u0</span><span class="p">:</span><span class="mi">0</span><span class="p">(</span><span class="kt">i64</span><span class="w"> </span><span class="n">vmctx</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="nc">tail</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">gv0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vmctx</span>
<span class="w">    </span><span class="n">gv1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">readonly</span><span class="w"> </span><span class="n">gv0</span><span class="o">+</span><span class="mi">8</span>
<span class="w">    </span><span class="n">gv2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">gv1</span><span class="o">+</span><span class="mi">16</span>
<span class="w">    </span><span class="n">stack_limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gv2</span>

<span class="w">                                </span><span class="n">block0</span><span class="p">(</span><span class="n">v0</span><span class="p">:</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="p">:</span><span class="w"> </span><span class="kt">i64</span><span class="p">):</span>
<span class="o">@</span><span class="mi">002</span><span class="n">d</span><span class="w">                               </span><span class="n">jump</span><span class="w"> </span><span class="n">block1</span>

<span class="w">                                </span><span class="n">block1</span><span class="p">:</span>
<span class="w">                                    </span><span class="nc">v12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="mi">7</span>
<span class="o">@</span><span class="mi">002</span><span class="n">d</span><span class="w">                               </span><span class="k">return</span><span class="w"> </span><span class="n">v12</span><span class="w">  </span><span class="p">;</span><span class="w"> </span><span class="n">v12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">7</span>
<span class="p">}</span>
</code></pre></div><br>
</p>
</blockquote>



<a name="540546289"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311723%20Add%20missing%20rotates%20for%20cranelift/near/540546289" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311723.20Add.20missing.20rotates.20for.20cranelift.html#540546289">(Sep 19 2025 at 23:56)</a>:</h4>
<p><strong>khagankhan</strong> requested <a href="https://github.com/alexcrichton">alexcrichton</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/11723">PR #11723</a>.</p>



<a name="540546290"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311723%20Add%20missing%20rotates%20for%20cranelift/near/540546290" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311723.20Add.20missing.20rotates.20for.20cranelift.html#540546290">(Sep 19 2025 at 23:56)</a>:</h4>
<p><strong>khagankhan</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/11723">PR #11723</a>.</p>



<a name="540552804"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311723%20Add%20missing%20rotates%20for%20cranelift/near/540552804" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311723.20Add.20missing.20rotates.20for.20cranelift.html#540552804">(Sep 20 2025 at 02:09)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/11723#issuecomment-3314405865">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11723">PR #11723</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @cfallin, @fitzgen</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "cranelift", "isle"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>cfallin: isle</li>
<li>fitzgen: isle</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="540608529"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311723%20Add%20missing%20rotates%20for%20cranelift/near/540608529" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311723.20Add.20missing.20rotates.20for.20cranelift.html#540608529">(Sep 20 2025 at 19:55)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/11723#discussion_r2365785483">PR review comment</a>:</p>
<blockquote>
<p>I'd recommend using <a href="https://doc.rust-lang.org/stable/std/primitive.i64.html#method.cast_unsigned"><code>cast_unsigned</code></a> here as it avoid using <code>as</code> which is something we try to avoid since it's by default a lossy cast.</p>
</blockquote>



<a name="540608530"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311723%20Add%20missing%20rotates%20for%20cranelift/near/540608530" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311723.20Add.20missing.20rotates.20for.20cranelift.html#540608530">(Sep 20 2025 at 19:55)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/11723#discussion_r2365785290">PR review comment</a>:</p>
<blockquote>
<p>It's ok to not test for 0 here because a 0-size integral type should cause a panic (which <code>% 0</code> would do I believe). Handling it here would accidentally try to recover from what should otherwise be a panicking situation.</p>
</blockquote>



<a name="540608531"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311723%20Add%20missing%20rotates%20for%20cranelift/near/540608531" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311723.20Add.20missing.20rotates.20for.20cranelift.html#540608531">(Sep 20 2025 at 19:55)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11723#pullrequestreview-3249220002">PR review</a>:</p>
<blockquote>
<p>Thanks! Mind adding some tests for this too? They'd go in <code>cranelift/filetests/filetests/egraph</code> for testing the IR is updated appropriately and <code>cranelift/filetests/filetests/runtests</code> for ensuring that the behavior matches the interpreter.</p>
</blockquote>



<a name="540608532"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311723%20Add%20missing%20rotates%20for%20cranelift/near/540608532" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311723.20Add.20missing.20rotates.20for.20cranelift.html#540608532">(Sep 20 2025 at 19:55)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/11723#discussion_r2365784580">PR review comment</a>:</p>
<blockquote>
<p>The <code>min</code> here should be an assert of some form because if <code>ty.bits()</code> is <code>&gt;=64</code> then that's an invalid state for this function to be in and it should panic.</p>
</blockquote>



<a name="540608533"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311723%20Add%20missing%20rotates%20for%20cranelift/near/540608533" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311723.20Add.20missing.20rotates.20for.20cranelift.html#540608533">(Sep 20 2025 at 19:55)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/11723#discussion_r2365785699">PR review comment</a>:</p>
<blockquote>
<p>For promotion back up to u64 I'd recommend using <code>u64::from((xv as u8).rotate_left(amt))</code> to avoid <code>as u64</code>. The <code>as u8</code> is still required, however, as this is intentionally truncating data.</p>
</blockquote>



<a name="540608806"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311723%20Add%20missing%20rotates%20for%20cranelift/near/540608806" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311723.20Add.20missing.20rotates.20for.20cranelift.html#540608806">(Sep 20 2025 at 20:00)</a>:</h4>
<p>khagankhan <a href="https://github.com/bytecodealliance/wasmtime/pull/11723#issuecomment-3315217196">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11723">PR #11723</a>:</p>
<blockquote>
<p>Sure thing! @alexcrichton Just made PR to get initial thoughts. I will address the comments</p>
</blockquote>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
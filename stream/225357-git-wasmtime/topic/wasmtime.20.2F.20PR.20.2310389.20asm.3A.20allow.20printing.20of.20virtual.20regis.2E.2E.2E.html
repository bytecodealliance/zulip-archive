<html>
<head><meta charset="utf-8"><title>wasmtime / PR #10389 asm: allow printing of virtual regis... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310389.20asm.3A.20allow.20printing.20of.20virtual.20regis.2E.2E.2E.html">wasmtime / PR #10389 asm: allow printing of virtual regis...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="505280350"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310389%20asm%3A%20allow%20printing%20of%20virtual%20regis.../near/505280350" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310389.20asm.3A.20allow.20printing.20of.20virtual.20regis.2E.2E.2E.html#505280350">(Mar 13 2025 at 00:11)</a>:</h4>
<p>abrown opened <a href="https://github.com/bytecodealliance/wasmtime/pull/10389">PR #10389</a> from <code>abrown:assembler-print-vreg</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>#10361 identifies a situation in which we want to print assembly instructions that have not yet been register allocated. Because of this, the register slots hold virtual registers, which the assembler does not know how to pretty-print. This change overrides <code>AsReg::to_string</code> in a few places so that <code>cranelift-codegen</code>'s view of registers can be pretty-printed using the existing code for doing so.</p>
</blockquote>



<a name="505280352"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310389%20asm%3A%20allow%20printing%20of%20virtual%20regis.../near/505280352" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310389.20asm.3A.20allow.20printing.20of.20virtual.20regis.2E.2E.2E.html#505280352">(Mar 13 2025 at 00:12)</a>:</h4>
<p><strong>abrown</strong> requested <a href="https://github.com/cfallin">cfallin</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/10389">PR #10389</a>.</p>



<a name="505280353"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310389%20asm%3A%20allow%20printing%20of%20virtual%20regis.../near/505280353" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310389.20asm.3A.20allow.20printing.20of.20virtual.20regis.2E.2E.2E.html#505280353">(Mar 13 2025 at 00:12)</a>:</h4>
<p><strong>abrown</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/10389">PR #10389</a>.</p>



<a name="505280441"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310389%20asm%3A%20allow%20printing%20of%20virtual%20regis.../near/505280441" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310389.20asm.3A.20allow.20printing.20of.20virtual.20regis.2E.2E.2E.html#505280441">(Mar 13 2025 at 00:12)</a>:</h4>
<p>abrown edited <a href="https://github.com/bytecodealliance/wasmtime/pull/10389">PR #10389</a>:</p>
<blockquote>
<p>#10361 identifies a situation in which we want to print assembly instructions that have not yet been register allocated. Because of this, the register slots hold virtual registers, which the assembler does not know how to pretty-print. This change overrides <code>AsReg::to_string</code> in a few places so that <code>cranelift-codegen</code>'s view of registers can be pretty-printed using the existing code for doing so. Closes #10361.</p>
</blockquote>



<a name="505280535"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310389%20asm%3A%20allow%20printing%20of%20virtual%20regis.../near/505280535" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310389.20asm.3A.20allow.20printing.20of.20virtual.20regis.2E.2E.2E.html#505280535">(Mar 13 2025 at 00:13)</a>:</h4>
<p>abrown <a href="https://github.com/bytecodealliance/wasmtime/pull/10389#issuecomment-2719398945">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/10389">PR #10389</a>:</p>
<blockquote>
<p>@cfallin, I was going to add some tests to keep this working correctly: can you remind me how to create a virtual <code>Reg</code> out of thin air?</p>
</blockquote>



<a name="505287631"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310389%20asm%3A%20allow%20printing%20of%20virtual%20regis.../near/505287631" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310389.20asm.3A.20allow.20printing.20of.20virtual.20regis.2E.2E.2E.html#505287631">(Mar 13 2025 at 01:05)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/10389#issuecomment-2719482205">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/10389">PR #10389</a>:</p>
<blockquote>
<p>Thanks for addressing this!</p>
<blockquote>
<p>@cfallin, I was going to add some tests to keep this working correctly: can you remind me how to create a virtual Reg out of thin air?</p>
</blockquote>
<p>Sounds good; something like <code>VReg::new(200, RegClass::Int)</code> should work I think?</p>
</blockquote>



<a name="505288826"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310389%20asm%3A%20allow%20printing%20of%20virtual%20regis.../near/505288826" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310389.20asm.3A.20allow.20printing.20of.20virtual.20regis.2E.2E.2E.html#505288826">(Mar 13 2025 at 01:12)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/10389#pullrequestreview-2680201695">PR review</a>:</p>
<blockquote>
<p>This approach is definitely workable -- I'm fine with landing this. However I note that <code>AsReg</code> in the assembler crate carries a <code>Debug</code> constraint already, meaning that we're requiring the user of the assembler library to provide a <code>Debug</code>-printable type -- is there any way we could make <code>to_string</code> handle this case at the assembler crate level by delegating to that (e.g. <code>format!("{:?}", self)</code>) and differeniate between the real and virtual cases by making <code>enc()</code> return an <code>Option&lt;u8&gt;</code>? I also feel this is a little more "honest" in the sense that not every <code>AsReg</code> value will be a physical register at all times. <code>.enc().expect("need physreg for encoding")</code> in actual emission code seems fine in that case.</p>
<p>If that turns out to be too complex, no worries, this existing solution is fine too.</p>
</blockquote>



<a name="505541932"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310389%20asm%3A%20allow%20printing%20of%20virtual%20regis.../near/505541932" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310389.20asm.3A.20allow.20printing.20of.20virtual.20regis.2E.2E.2E.html#505541932">(Mar 13 2025 at 23:01)</a>:</h4>
<p>abrown updated <a href="https://github.com/bytecodealliance/wasmtime/pull/10389">PR #10389</a>.</p>



<a name="505545858"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310389%20asm%3A%20allow%20printing%20of%20virtual%20regis.../near/505545858" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310389.20asm.3A.20allow.20printing.20of.20virtual.20regis.2E.2E.2E.html#505545858">(Mar 13 2025 at 23:36)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/10389#issuecomment-2722930573">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/10389">PR #10389</a>:</p>
<blockquote>
<p>I poked at this a little myself and I think I'm actually fine with the way this works currently. Modifying <code>AsReg::enc()</code> to return <code>Option&lt;u8&gt;</code> is in some sense closer to reality -- the register may or may not have a physical encoding -- but almost all users use it only when it does, and only pretty-printing differs, so it's probably just as good to simply document that it can panic when the reg is virtual, and make pretty-printing work explicitly instead, as you've done here. I also played a bit with the plumbing on pretty-printing -- one could invert so that <code>to_string()</code> in the assembler crate calls back to the embedder (Cranelift) for vregs but again it's about the same amount of code, and this works fine. So I'll say LGTM, and we can always refactor later if needed.</p>
<p>Thanks for adding the test as well!</p>
</blockquote>



<a name="505699576"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310389%20asm%3A%20allow%20printing%20of%20virtual%20regis.../near/505699576" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310389.20asm.3A.20allow.20printing.20of.20virtual.20regis.2E.2E.2E.html#505699576">(Mar 14 2025 at 15:10)</a>:</h4>
<p>abrown merged <a href="https://github.com/bytecodealliance/wasmtime/pull/10389">PR #10389</a>.</p>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
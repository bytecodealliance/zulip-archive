<html>
<head><meta charset="utf-8"><title>wasmtime / PR #12303 Optimize ISLE compilation · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312303.20Optimize.20ISLE.20compilation.html">wasmtime / PR #12303 Optimize ISLE compilation</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="567093967"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312303%20Optimize%20ISLE%20compilation/near/567093967" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312303.20Optimize.20ISLE.20compilation.html#567093967">(Jan 09 2026 at 08:48)</a>:</h4>
<p><strong>bongjunj</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/12303">PR #12303</a>.</p>



<a name="567093968"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312303%20Optimize%20ISLE%20compilation/near/567093968" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312303.20Optimize.20ISLE.20compilation.html#567093968">(Jan 09 2026 at 08:48)</a>:</h4>
<p>bongjunj opened <a href="https://github.com/bytecodealliance/wasmtime/pull/12303">PR #12303</a> from <code>bongjunj:optimize-isle-compilation</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
<h2>Overview</h2>
<p>The current implementation of ISLE code generation emits a single Rust function for each ISLE term, and <code>rustc</code> compiles the Rust code to integrate ISLE with other modules of Cranelift.</p>
<p>This can cause a compilation bottleneck when a ISLE term contains numerous rules ending up with producing a very very large Rust function, since <code>rustc</code> cannot efficiently compile such functions. Notably, the term <code>simplify</code> which implements the mid-end peephole optimizations has about 500 rules, and the symptom is already visible. (And the ruleset is growing!) You can check, compiling Cranelift, <code>cranelift-codegen</code> takes most of the time in the following report: <a href="https://github.com/user-attachments/files/24522422/cargo-timing.html">cargo-timing.html</a></p>
<p>Plus: a timing report for compiling wasmtime: </p>
<p>With this PR, the ISLE codegen helps <code>rustc</code> by wrapping a large match statement generated by <code>islec</code> in a closure. By introducing closures, a portion of a huge Rust function (for a ISLE term) can be split into several smaller compilation units for <code>rustc</code>, reducing the compilation time.</p>
<h2>Evaluation</h2>
<p>On the <code>main</code> branch, the build times for <code>cranelift-codegen</code> before/after this optimization are measured. This PR saves ~2 seconds.</p>
<ul>
<li>Before: 23.81 sec</li>
</ul>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">~/</span><span class="n">wasmtime</span><span class="w"> </span><span class="p">(</span><span class="n">optimize</span><span class="o">-</span><span class="n">isle</span><span class="o">-</span><span class="n">compilation</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">clean</span>
<span class="w">     </span><span class="n">Removed</span><span class="w"> </span><span class="mi">10031</span><span class="w"> </span><span class="n">files</span><span class="p">,</span><span class="w"> </span><span class="mf">12.6</span><span class="n">GiB</span><span class="w"> </span><span class="n">total</span>
<span class="o">~/</span><span class="n">wasmtime</span><span class="w"> </span><span class="p">(</span><span class="n">optimize</span><span class="o">-</span><span class="n">isle</span><span class="o">-</span><span class="n">compilation</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="o">-</span><span class="n">q</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="n">cranelift</span><span class="o">-</span><span class="n">codegen</span>

<span class="n">________________________________________________________</span>
<span class="n">Executed</span><span class="w"> </span><span class="k">in</span><span class="w">   </span><span class="mf">23.81</span><span class="w"> </span><span class="n">secs</span><span class="w">    </span><span class="n">fish</span><span class="w">           </span><span class="n">external</span>
<span class="w">   </span><span class="n">usr</span><span class="w"> </span><span class="n">time</span><span class="w">   </span><span class="mf">43.59</span><span class="w"> </span><span class="n">secs</span><span class="w">    </span><span class="mf">0.00</span><span class="w"> </span><span class="n">micros</span><span class="w">   </span><span class="mf">43.59</span><span class="w"> </span><span class="n">secs</span>
<span class="w">   </span><span class="n">sys</span><span class="w"> </span><span class="n">time</span><span class="w">    </span><span class="mf">5.04</span><span class="w"> </span><span class="n">secs</span><span class="w">  </span><span class="mf">592.00</span><span class="w"> </span><span class="n">micros</span><span class="w">    </span><span class="mf">5.04</span><span class="w"> </span><span class="n">secs</span>
</code></pre></div>
<ul>
<li>After: 26.04 sec</li>
</ul>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">~/</span><span class="n">wasmtime</span><span class="w"> </span><span class="p">((</span><span class="n">dev</span><span class="p">))</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">clean</span>
<span class="n">t</span><span class="w">     </span><span class="n">Removed</span><span class="w"> </span><span class="mi">1356</span><span class="w"> </span><span class="n">files</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="n">GiB</span><span class="w"> </span><span class="n">total</span>
<span class="o">~/</span><span class="n">wasmtime</span><span class="w"> </span><span class="p">((</span><span class="n">dev</span><span class="p">))</span><span class="o">&gt;</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="o">-</span><span class="n">q</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="n">cranelift</span><span class="o">-</span><span class="n">codegen</span>

<span class="n">________________________________________________________</span>
<span class="n">Executed</span><span class="w"> </span><span class="k">in</span><span class="w">   </span><span class="mf">26.04</span><span class="w"> </span><span class="n">secs</span><span class="w">    </span><span class="n">fish</span><span class="w">           </span><span class="n">external</span>
<span class="w">   </span><span class="n">usr</span><span class="w"> </span><span class="n">time</span><span class="w">   </span><span class="mf">46.58</span><span class="w"> </span><span class="n">secs</span><span class="w">    </span><span class="mf">0.00</span><span class="w"> </span><span class="n">micros</span><span class="w">   </span><span class="mf">46.58</span><span class="w"> </span><span class="n">secs</span>
<span class="w">   </span><span class="n">sys</span><span class="w"> </span><span class="n">time</span><span class="w">    </span><span class="mf">5.15</span><span class="w"> </span><span class="n">secs</span><span class="w">  </span><span class="mf">583.00</span><span class="w"> </span><span class="n">micros</span><span class="w">    </span><span class="mf">5.15</span><span class="w"> </span><span class="n">secs</span>
</code></pre></div>
<ul>
<li>
<p>Cargo Timing Reports</p>
<ul>
<li>
<p>Before: <br>
<a href="https://github.com/user-attachments/files/24523107/cargo-timing-old.html">cargo-timing-old.html</a></p>
</li>
<li>
<p>After: <br>
<a href="https://github.com/user-attachments/files/24523109/cargo-timing-new.html">cargo-timing-new.html</a></p>
</li>
</ul>
</li>
</ul>
<h2>Extra</h2>
<p>I am experimenting with over 6,000 ISLE <code>simplify</code> rules.<br>
The compilation time reduced from 841.37 seconds to 69.34 seconds with this PR. (+11x speedup)</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">~/</span><span class="n">w</span><span class="o">/</span><span class="n">cranelift</span><span class="w"> </span><span class="p">((</span><span class="n">many</span><span class="o">-</span><span class="n">rules</span><span class="o">-</span><span class="n">no</span><span class="o">-</span><span class="n">opt</span><span class="p">))</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">clean</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="n">cranelift</span><span class="o">-</span><span class="n">codegen</span>
<span class="n">________________________________________________________</span>
<span class="n">Executed</span><span class="w"> </span><span class="k">in</span><span class="w">  </span><span class="mf">841.37</span><span class="w"> </span><span class="n">secs</span><span class="w">    </span><span class="n">fish</span><span class="w">           </span><span class="n">external</span>
<span class="w">   </span><span class="n">usr</span><span class="w"> </span><span class="n">time</span><span class="w">  </span><span class="mf">826.92</span><span class="w"> </span><span class="n">secs</span><span class="w">  </span><span class="mf">325.00</span><span class="w"> </span><span class="n">micros</span><span class="w">  </span><span class="mf">826.92</span><span class="w"> </span><span class="n">secs</span>
<span class="w">   </span><span class="n">sys</span><span class="w"> </span><span class="n">time</span><span class="w">   </span><span class="mf">49.98</span><span class="w"> </span><span class="n">secs</span><span class="w">  </span><span class="mf">135.00</span><span class="w"> </span><span class="n">micros</span><span class="w">   </span><span class="mf">49.98</span><span class="w"> </span><span class="n">secs</span>

<span class="w"> </span><span class="o">~/</span><span class="n">w</span><span class="o">/</span><span class="n">cranelift</span><span class="w"> </span><span class="p">(</span><span class="n">many</span><span class="o">-</span><span class="n">rules</span><span class="o">-</span><span class="n">opt</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">clean</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="o">-</span><span class="n">q</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="n">cranelift</span><span class="o">-</span><span class="n">codegen</span>
<span class="n">________________________________________________________</span>
<span class="n">Executed</span><span class="w"> </span><span class="k">in</span><span class="w">   </span><span class="mf">69.34</span><span class="w"> </span><span class="n">secs</span><span class="w">    </span><span class="n">fish</span><span class="w">           </span><span class="n">external</span>
<span class="w">   </span><span class="n">usr</span><span class="w"> </span><span class="n">time</span><span class="w">   </span><span class="mf">98.32</span><span class="w"> </span><span class="n">secs</span><span class="w">  </span><span class="mf">362.00</span><span class="w"> </span><span class="n">micros</span><span class="w">   </span><span class="mf">98.32</span><span class="w"> </span><span class="n">secs</span>
<span class="w">   </span><span class="n">sys</span><span class="w"> </span><span class="n">time</span><span class="w">    </span><span class="mf">6.42</span><span class="w"> </span><span class="n">secs</span><span class="w">  </span><span class="mf">149.00</span><span class="w"> </span><span class="n">micros</span><span class="w">    </span><span class="mf">6.42</span><span class="w"> </span><span class="n">secs</span>
</code></pre></div>
</blockquote>



<a name="567093970"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312303%20Optimize%20ISLE%20compilation/near/567093970" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312303.20Optimize.20ISLE.20compilation.html#567093970">(Jan 09 2026 at 08:48)</a>:</h4>
<p><strong>bongjunj</strong> requested <a href="https://github.com/fitzgen">fitzgen</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/12303">PR #12303</a>.</p>



<a name="567094013"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312303%20Optimize%20ISLE%20compilation/near/567094013" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312303.20Optimize.20ISLE.20compilation.html#567094013">(Jan 09 2026 at 08:48)</a>:</h4>
<p>bongjunj edited <a href="https://github.com/bytecodealliance/wasmtime/pull/12303">PR #12303</a>:</p>
<blockquote>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
<h2>Overview</h2>
<p>The current implementation of ISLE code generation emits a single Rust function for each ISLE term, and <code>rustc</code> compiles the Rust code to integrate ISLE with other modules of Cranelift.</p>
<p>This can cause a compilation bottleneck when a ISLE term contains numerous rules ending up with producing a very very large Rust function, since <code>rustc</code> cannot efficiently compile such functions. Notably, the term <code>simplify</code> which implements the mid-end peephole optimizations has about 500 rules, and the symptom is already visible. (And the ruleset is growing!) You can check, compiling Cranelift, <code>cranelift-codegen</code> takes most of the time in the following report: <a href="https://github.com/user-attachments/files/24522422/cargo-timing.html">cargo-timing.html</a></p>
<p>Plus: a timing report for compiling wasmtime: </p>
<p>With this PR, the ISLE codegen helps <code>rustc</code> by wrapping a large match statement generated by <code>islec</code> in a closure. By introducing closures, a portion of a huge Rust function (for a ISLE term) can be split into several smaller compilation units for <code>rustc</code>, reducing the compilation time.</p>
<h2>Evaluation</h2>
<p>On the <code>main</code> branch, the build times for <code>cranelift-codegen</code> before/after this optimization are measured. This PR saves ~2 seconds.</p>
<ul>
<li>Before: 23.81 sec</li>
</ul>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">~/</span><span class="n">wasmtime</span><span class="w"> </span><span class="p">(</span><span class="n">optimize</span><span class="o">-</span><span class="n">isle</span><span class="o">-</span><span class="n">compilation</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">clean</span>
<span class="w">     </span><span class="n">Removed</span><span class="w"> </span><span class="mi">10031</span><span class="w"> </span><span class="n">files</span><span class="p">,</span><span class="w"> </span><span class="mf">12.6</span><span class="n">GiB</span><span class="w"> </span><span class="n">total</span>
<span class="o">~/</span><span class="n">wasmtime</span><span class="w"> </span><span class="p">(</span><span class="n">optimize</span><span class="o">-</span><span class="n">isle</span><span class="o">-</span><span class="n">compilation</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="o">-</span><span class="n">q</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="n">cranelift</span><span class="o">-</span><span class="n">codegen</span>

<span class="n">________________________________________________________</span>
<span class="n">Executed</span><span class="w"> </span><span class="k">in</span><span class="w">   </span><span class="mf">23.81</span><span class="w"> </span><span class="n">secs</span><span class="w">    </span><span class="n">fish</span><span class="w">           </span><span class="n">external</span>
<span class="w">   </span><span class="n">usr</span><span class="w"> </span><span class="n">time</span><span class="w">   </span><span class="mf">43.59</span><span class="w"> </span><span class="n">secs</span><span class="w">    </span><span class="mf">0.00</span><span class="w"> </span><span class="n">micros</span><span class="w">   </span><span class="mf">43.59</span><span class="w"> </span><span class="n">secs</span>
<span class="w">   </span><span class="n">sys</span><span class="w"> </span><span class="n">time</span><span class="w">    </span><span class="mf">5.04</span><span class="w"> </span><span class="n">secs</span><span class="w">  </span><span class="mf">592.00</span><span class="w"> </span><span class="n">micros</span><span class="w">    </span><span class="mf">5.04</span><span class="w"> </span><span class="n">secs</span>
</code></pre></div>
<ul>
<li>After: 26.04 sec</li>
</ul>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">~/</span><span class="n">wasmtime</span><span class="w"> </span><span class="p">((</span><span class="n">dev</span><span class="p">))</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">clean</span>
<span class="n">t</span><span class="w">     </span><span class="n">Removed</span><span class="w"> </span><span class="mi">1356</span><span class="w"> </span><span class="n">files</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="n">GiB</span><span class="w"> </span><span class="n">total</span>
<span class="o">~/</span><span class="n">wasmtime</span><span class="w"> </span><span class="p">((</span><span class="n">dev</span><span class="p">))</span><span class="o">&gt;</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="o">-</span><span class="n">q</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="n">cranelift</span><span class="o">-</span><span class="n">codegen</span>

<span class="n">________________________________________________________</span>
<span class="n">Executed</span><span class="w"> </span><span class="k">in</span><span class="w">   </span><span class="mf">26.04</span><span class="w"> </span><span class="n">secs</span><span class="w">    </span><span class="n">fish</span><span class="w">           </span><span class="n">external</span>
<span class="w">   </span><span class="n">usr</span><span class="w"> </span><span class="n">time</span><span class="w">   </span><span class="mf">46.58</span><span class="w"> </span><span class="n">secs</span><span class="w">    </span><span class="mf">0.00</span><span class="w"> </span><span class="n">micros</span><span class="w">   </span><span class="mf">46.58</span><span class="w"> </span><span class="n">secs</span>
<span class="w">   </span><span class="n">sys</span><span class="w"> </span><span class="n">time</span><span class="w">    </span><span class="mf">5.15</span><span class="w"> </span><span class="n">secs</span><span class="w">  </span><span class="mf">583.00</span><span class="w"> </span><span class="n">micros</span><span class="w">    </span><span class="mf">5.15</span><span class="w"> </span><span class="n">secs</span>
</code></pre></div>
<ul>
<li>Cargo Timing Reports<ul>
<li>Before: <a href="https://github.com/user-attachments/files/24523107/cargo-timing-old.html">cargo-timing-old.html</a></li>
<li>After: <a href="https://github.com/user-attachments/files/24523109/cargo-timing-new.html">cargo-timing-new.html</a></li>
</ul>
</li>
</ul>
<h2>Extra</h2>
<p>I am experimenting with over 6,000 ISLE <code>simplify</code> rules.<br>
The compilation time reduced from 841.37 seconds to 69.34 seconds with this PR. (+11x speedup)</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">~/</span><span class="n">w</span><span class="o">/</span><span class="n">cranelift</span><span class="w"> </span><span class="p">((</span><span class="n">many</span><span class="o">-</span><span class="n">rules</span><span class="o">-</span><span class="n">no</span><span class="o">-</span><span class="n">opt</span><span class="p">))</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">clean</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="n">cranelift</span><span class="o">-</span><span class="n">codegen</span>
<span class="n">________________________________________________________</span>
<span class="n">Executed</span><span class="w"> </span><span class="k">in</span><span class="w">  </span><span class="mf">841.37</span><span class="w"> </span><span class="n">secs</span><span class="w">    </span><span class="n">fish</span><span class="w">           </span><span class="n">external</span>
<span class="w">   </span><span class="n">usr</span><span class="w"> </span><span class="n">time</span><span class="w">  </span><span class="mf">826.92</span><span class="w"> </span><span class="n">secs</span><span class="w">  </span><span class="mf">325.00</span><span class="w"> </span><span class="n">micros</span><span class="w">  </span><span class="mf">826.92</span><span class="w"> </span><span class="n">secs</span>
<span class="w">   </span><span class="n">sys</span><span class="w"> </span><span class="n">time</span><span class="w">   </span><span class="mf">49.98</span><span class="w"> </span><span class="n">secs</span><span class="w">  </span><span class="mf">135.00</span><span class="w"> </span><span class="n">micros</span><span class="w">   </span><span class="mf">49.98</span><span class="w"> </span><span class="n">secs</span>

<span class="w"> </span><span class="o">~/</span><span class="n">w</span><span class="o">/</span><span class="n">cranelift</span><span class="w"> </span><span class="p">(</span><span class="n">many</span><span class="o">-</span><span class="n">rules</span><span class="o">-</span><span class="n">opt</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">clean</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="o">-</span><span class="n">q</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="n">cranelift</span><span class="o">-</span><span class="n">codegen</span>
<span class="n">________________________________________________________</span>
<span class="n">Executed</span><span class="w"> </span><span class="k">in</span><span class="w">   </span><span class="mf">69.34</span><span class="w"> </span><span class="n">secs</span><span class="w">    </span><span class="n">fish</span><span class="w">           </span><span class="n">external</span>
<span class="w">   </span><span class="n">usr</span><span class="w"> </span><span class="n">time</span><span class="w">   </span><span class="mf">98.32</span><span class="w"> </span><span class="n">secs</span><span class="w">  </span><span class="mf">362.00</span><span class="w"> </span><span class="n">micros</span><span class="w">   </span><span class="mf">98.32</span><span class="w"> </span><span class="n">secs</span>
<span class="w">   </span><span class="n">sys</span><span class="w"> </span><span class="n">time</span><span class="w">    </span><span class="mf">6.42</span><span class="w"> </span><span class="n">secs</span><span class="w">  </span><span class="mf">149.00</span><span class="w"> </span><span class="n">micros</span><span class="w">    </span><span class="mf">6.42</span><span class="w"> </span><span class="n">secs</span>
</code></pre></div>
</blockquote>



<a name="567094540"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312303%20Optimize%20ISLE%20compilation/near/567094540" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312303.20Optimize.20ISLE.20compilation.html#567094540">(Jan 09 2026 at 08:52)</a>:</h4>
<p>bongjunj edited <a href="https://github.com/bytecodealliance/wasmtime/pull/12303">PR #12303</a>:</p>
<blockquote>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
<h2>Overview</h2>
<p>The current implementation of ISLE code generation emits a single Rust function for each ISLE term, and <code>rustc</code> compiles the Rust code to integrate ISLE with other modules of Cranelift.</p>
<p>This can cause a compilation bottleneck when a ISLE term contains numerous rules ending up with producing a very very large Rust function, since <code>rustc</code> cannot efficiently compile such functions. Notably, the term <code>simplify</code> which implements the mid-end peephole optimizations has about 500 rules, and the symptom is already visible. (And the ruleset is growing!) You can check, compiling Cranelift, <code>cranelift-codegen</code> takes most of the time in the following report: <a href="https://github.com/user-attachments/files/24522422/cargo-timing.html">cargo-timing.html</a></p>
<p>Plus: a timing report for compiling wasmtime: </p>
<p>With this PR, the ISLE codegen helps <code>rustc</code> by wrapping a large match statement generated by <code>islec</code> in a closure. By introducing closures, a portion of a huge Rust function (for a ISLE term) can be split into several smaller compilation units for <code>rustc</code>, reducing the compilation time.</p>
<h2>Evaluation</h2>
<p>On the <code>main</code> branch, the build times for <code>cranelift-codegen</code> before/after this optimization are measured. This PR saves ~2 seconds on my machine (x86-64, 64 core, 512GB memory)</p>
<ul>
<li>Before: 23.81 sec</li>
</ul>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">~/</span><span class="n">wasmtime</span><span class="w"> </span><span class="p">(</span><span class="n">optimize</span><span class="o">-</span><span class="n">isle</span><span class="o">-</span><span class="n">compilation</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">clean</span>
<span class="w">     </span><span class="n">Removed</span><span class="w"> </span><span class="mi">10031</span><span class="w"> </span><span class="n">files</span><span class="p">,</span><span class="w"> </span><span class="mf">12.6</span><span class="n">GiB</span><span class="w"> </span><span class="n">total</span>
<span class="o">~/</span><span class="n">wasmtime</span><span class="w"> </span><span class="p">(</span><span class="n">optimize</span><span class="o">-</span><span class="n">isle</span><span class="o">-</span><span class="n">compilation</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="o">-</span><span class="n">q</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="n">cranelift</span><span class="o">-</span><span class="n">codegen</span>

<span class="n">________________________________________________________</span>
<span class="n">Executed</span><span class="w"> </span><span class="k">in</span><span class="w">   </span><span class="mf">23.81</span><span class="w"> </span><span class="n">secs</span><span class="w">    </span><span class="n">fish</span><span class="w">           </span><span class="n">external</span>
<span class="w">   </span><span class="n">usr</span><span class="w"> </span><span class="n">time</span><span class="w">   </span><span class="mf">43.59</span><span class="w"> </span><span class="n">secs</span><span class="w">    </span><span class="mf">0.00</span><span class="w"> </span><span class="n">micros</span><span class="w">   </span><span class="mf">43.59</span><span class="w"> </span><span class="n">secs</span>
<span class="w">   </span><span class="n">sys</span><span class="w"> </span><span class="n">time</span><span class="w">    </span><span class="mf">5.04</span><span class="w"> </span><span class="n">secs</span><span class="w">  </span><span class="mf">592.00</span><span class="w"> </span><span class="n">micros</span><span class="w">    </span><span class="mf">5.04</span><span class="w"> </span><span class="n">secs</span>
</code></pre></div>
<ul>
<li>After: 26.04 sec</li>
</ul>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">~/</span><span class="n">wasmtime</span><span class="w"> </span><span class="p">((</span><span class="n">dev</span><span class="p">))</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">clean</span>
<span class="n">t</span><span class="w">     </span><span class="n">Removed</span><span class="w"> </span><span class="mi">1356</span><span class="w"> </span><span class="n">files</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="n">GiB</span><span class="w"> </span><span class="n">total</span>
<span class="o">~/</span><span class="n">wasmtime</span><span class="w"> </span><span class="p">((</span><span class="n">dev</span><span class="p">))</span><span class="o">&gt;</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="o">-</span><span class="n">q</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="n">cranelift</span><span class="o">-</span><span class="n">codegen</span>

<span class="n">________________________________________________________</span>
<span class="n">Executed</span><span class="w"> </span><span class="k">in</span><span class="w">   </span><span class="mf">26.04</span><span class="w"> </span><span class="n">secs</span><span class="w">    </span><span class="n">fish</span><span class="w">           </span><span class="n">external</span>
<span class="w">   </span><span class="n">usr</span><span class="w"> </span><span class="n">time</span><span class="w">   </span><span class="mf">46.58</span><span class="w"> </span><span class="n">secs</span><span class="w">    </span><span class="mf">0.00</span><span class="w"> </span><span class="n">micros</span><span class="w">   </span><span class="mf">46.58</span><span class="w"> </span><span class="n">secs</span>
<span class="w">   </span><span class="n">sys</span><span class="w"> </span><span class="n">time</span><span class="w">    </span><span class="mf">5.15</span><span class="w"> </span><span class="n">secs</span><span class="w">  </span><span class="mf">583.00</span><span class="w"> </span><span class="n">micros</span><span class="w">    </span><span class="mf">5.15</span><span class="w"> </span><span class="n">secs</span>
</code></pre></div>
<ul>
<li>Cargo Timing Reports<ul>
<li>Before: <a href="https://github.com/user-attachments/files/24523107/cargo-timing-old.html">cargo-timing-old.html</a></li>
<li>After: <a href="https://github.com/user-attachments/files/24523109/cargo-timing-new.html">cargo-timing-new.html</a></li>
</ul>
</li>
</ul>
<h2>Extra</h2>
<p>I am experimenting with over 6,000 ISLE <code>simplify</code> rules.<br>
The compilation time reduced from 841.37 seconds to 69.34 seconds with this PR. (+11x speedup)</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">~/</span><span class="n">w</span><span class="o">/</span><span class="n">cranelift</span><span class="w"> </span><span class="p">((</span><span class="n">many</span><span class="o">-</span><span class="n">rules</span><span class="o">-</span><span class="n">no</span><span class="o">-</span><span class="n">opt</span><span class="p">))</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">clean</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="n">cranelift</span><span class="o">-</span><span class="n">codegen</span>
<span class="n">________________________________________________________</span>
<span class="n">Executed</span><span class="w"> </span><span class="k">in</span><span class="w">  </span><span class="mf">841.37</span><span class="w"> </span><span class="n">secs</span><span class="w">    </span><span class="n">fish</span><span class="w">           </span><span class="n">external</span>
<span class="w">   </span><span class="n">usr</span><span class="w"> </span><span class="n">time</span><span class="w">  </span><span class="mf">826.92</span><span class="w"> </span><span class="n">secs</span><span class="w">  </span><span class="mf">325.00</span><span class="w"> </span><span class="n">micros</span><span class="w">  </span><span class="mf">826.92</span><span class="w"> </span><span class="n">secs</span>
<span class="w">   </span><span class="n">sys</span><span class="w"> </span><span class="n">time</span><span class="w">   </span><span class="mf">49.98</span><span class="w"> </span><span class="n">secs</span><span class="w">  </span><span class="mf">135.00</span><span class="w"> </span><span class="n">micros</span><span class="w">   </span><span class="mf">49.98</span><span class="w"> </span><span class="n">secs</span>

<span class="w"> </span><span class="o">~/</span><span class="n">w</span><span class="o">/</span><span class="n">cranelift</span><span class="w"> </span><span class="p">(</span><span class="n">many</span><span class="o">-</span><span class="n">rules</span><span class="o">-</span><span class="n">opt</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">clean</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="o">-</span><span class="n">q</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="n">cranelift</span><span class="o">-</span><span class="n">codegen</span>
<span class="n">________________________________________________________</span>
<span class="n">Executed</span><span class="w"> </span><span class="k">in</span><span class="w">   </span><span class="mf">69.34</span><span class="w"> </span><span class="n">secs</span><span class="w">    </span><span class="n">fish</span><span class="w">           </span><span class="n">external</span>
<span class="w">   </span><span class="n">usr</span><span class="w"> </span><span class="n">time</span><span class="w">   </span><span class="mf">98.32</span><span class="w"> </span><span class="n">secs</span><span class="w">  </span><span class="mf">362.00</span><span class="w"> </span><span class="n">micros</span><span class="w">   </span><span class="mf">98.32</span><span class="w"> </span><span class="n">secs</span>
<span class="w">   </span><span class="n">sys</span><span class="w"> </span><span class="n">time</span><span class="w">    </span><span class="mf">6.42</span><span class="w"> </span><span class="n">secs</span><span class="w">  </span><span class="mf">149.00</span><span class="w"> </span><span class="n">micros</span><span class="w">    </span><span class="mf">6.42</span><span class="w"> </span><span class="n">secs</span>
</code></pre></div>
</blockquote>



<a name="567098107"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312303%20Optimize%20ISLE%20compilation/near/567098107" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312303.20Optimize.20ISLE.20compilation.html#567098107">(Jan 09 2026 at 09:16)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/12303#issuecomment-3728001237">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/12303">PR #12303</a>:</p>
<blockquote>
<p>@bongjunj thanks for this experimentation!</p>
<p>Before moving further, would you mind benchmarking compilation time as well? One of the reasons for putting all of the codegen for an ISLE term in one function is so that the compiler can optimize the code together; splitting that code between functions and (especially) introducing ABI boundaries may produce slowdowns when Cranelift runs. IMHO, it's worth it to spend a few extra seconds when compiling Cranelift if it makes Cranelift itself run faster. If no effect, of course, then no problem and I'll be happy to review this. Thanks!</p>
</blockquote>



<a name="567137171"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312303%20Optimize%20ISLE%20compilation/near/567137171" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312303.20Optimize.20ISLE.20compilation.html#567137171">(Jan 09 2026 at 13:03)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/12303#issuecomment-3728832557">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/12303">PR #12303</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @cfallin, @fitzgen</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "cranelift", "isle"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>cfallin: isle</li>
<li>fitzgen: isle</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="567176492"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312303%20Optimize%20ISLE%20compilation/near/567176492" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312303.20Optimize.20ISLE.20compilation.html#567176492">(Jan 09 2026 at 16:09)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/12303#issuecomment-3729580673">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/12303">PR #12303</a>:</p>
<blockquote>
<p>An 11x reduction in compile time is quite massive, so even if this is a ~NN% regression in compile-time-of-wasm-code I think this would be a great thing to land at least for debug builds and maybe optionally for release builds with some sort of tunable too.</p>
</blockquote>



<a name="567177066"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312303%20Optimize%20ISLE%20compilation/near/567177066" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312303.20Optimize.20ISLE.20compilation.html#567177066">(Jan 09 2026 at 16:11)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/12303#issuecomment-3729593374">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/12303">PR #12303</a>:</p>
<blockquote>
<p>Note, that's an 11x reduction with Bongjun's huge new ruleset; ~10% on <code>main</code>. That's neat but I wouldn't regress compile time for it IMHO.</p>
</blockquote>



<a name="567195021"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312303%20Optimize%20ISLE%20compilation/near/567195021" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312303.20Optimize.20ISLE.20compilation.html#567195021">(Jan 09 2026 at 17:32)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/pull/12303#issuecomment-3729911057">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/12303">PR #12303</a>:</p>
<blockquote>
<p>If it does result in Wasm compilation time regressions, it may still make sense to have this as an option of the ISLE compiler that we can enable during development or something, if we can make the maintenance burden minimal.</p>
</blockquote>



<a name="567195660"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312303%20Optimize%20ISLE%20compilation/near/567195660" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312303.20Optimize.20ISLE.20compilation.html#567195660">(Jan 09 2026 at 17:35)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/12303#pullrequestreview-3644924393">PR review</a>.</p>



<a name="567195661"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312303%20Optimize%20ISLE%20compilation/near/567195661" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312303.20Optimize.20ISLE.20compilation.html#567195661">(Jan 09 2026 at 17:35)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/12303#discussion_r2677041935">PR review comment</a>:</p>
<blockquote>
<p>Regarding my previous comment: it could potentially make sense to make <code>MATCH_ARM_BODY_CLOSURE_THRESHOLD</code> a dynamic ISLE compilation option, rather than a constant, and then tweak that value in Cranelift's invocation of the ISLE compiler depending on if a cargo feature is enabled or whether this is a release vs debug build of Cranelift or something.</p>
</blockquote>



<a name="567431387"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312303%20Optimize%20ISLE%20compilation/near/567431387" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312303.20Optimize.20ISLE.20compilation.html#567431387">(Jan 12 2026 at 02:02)</a>:</h4>
<p>bongjunj edited <a href="https://github.com/bytecodealliance/wasmtime/pull/12303">PR #12303</a>:</p>
<blockquote>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
<h2>Overview</h2>
<p>The current implementation of ISLE code generation emits a single Rust function for each ISLE term, and <code>rustc</code> compiles the Rust code to integrate ISLE with other modules of Cranelift.</p>
<p>This can cause a compilation bottleneck when a ISLE term contains numerous rules ending up with producing a very very large Rust function, since <code>rustc</code> cannot efficiently compile such functions. Notably, the term <code>simplify</code> which implements the mid-end peephole optimizations has about 500 rules, and the symptom is already visible. (And the ruleset is growing!) You can check, compiling Cranelift, <code>cranelift-codegen</code> takes most of the time in the following report: <a href="https://github.com/user-attachments/files/24522422/cargo-timing.html">cargo-timing.html</a></p>
<p>Plus: a timing report for compiling wasmtime: </p>
<p>With this PR, the ISLE codegen helps <code>rustc</code> by wrapping a large match statement generated by <code>islec</code> in a closure. By introducing closures, a portion of a huge Rust function (for a ISLE term) can be split into several smaller compilation units for <code>rustc</code>, reducing the compilation time.</p>
<h2>Evaluation</h2>
<p>On the <code>main</code> branch, the build times for <code>cranelift-codegen</code> before/after this optimization are measured. This PR saves ~2 seconds on my machine (x86-64, 64 core, 512GB memory)</p>
<ul>
<li>After: 23.81 sec</li>
</ul>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">~/</span><span class="n">wasmtime</span><span class="w"> </span><span class="p">(</span><span class="n">optimize</span><span class="o">-</span><span class="n">isle</span><span class="o">-</span><span class="n">compilation</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">clean</span>
<span class="w">     </span><span class="n">Removed</span><span class="w"> </span><span class="mi">10031</span><span class="w"> </span><span class="n">files</span><span class="p">,</span><span class="w"> </span><span class="mf">12.6</span><span class="n">GiB</span><span class="w"> </span><span class="n">total</span>
<span class="o">~/</span><span class="n">wasmtime</span><span class="w"> </span><span class="p">(</span><span class="n">optimize</span><span class="o">-</span><span class="n">isle</span><span class="o">-</span><span class="n">compilation</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="o">-</span><span class="n">q</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="n">cranelift</span><span class="o">-</span><span class="n">codegen</span>

<span class="n">________________________________________________________</span>
<span class="n">Executed</span><span class="w"> </span><span class="k">in</span><span class="w">   </span><span class="mf">23.81</span><span class="w"> </span><span class="n">secs</span><span class="w">    </span><span class="n">fish</span><span class="w">           </span><span class="n">external</span>
<span class="w">   </span><span class="n">usr</span><span class="w"> </span><span class="n">time</span><span class="w">   </span><span class="mf">43.59</span><span class="w"> </span><span class="n">secs</span><span class="w">    </span><span class="mf">0.00</span><span class="w"> </span><span class="n">micros</span><span class="w">   </span><span class="mf">43.59</span><span class="w"> </span><span class="n">secs</span>
<span class="w">   </span><span class="n">sys</span><span class="w"> </span><span class="n">time</span><span class="w">    </span><span class="mf">5.04</span><span class="w"> </span><span class="n">secs</span><span class="w">  </span><span class="mf">592.00</span><span class="w"> </span><span class="n">micros</span><span class="w">    </span><span class="mf">5.04</span><span class="w"> </span><span class="n">secs</span>
</code></pre></div>
<ul>
<li>Before: 26.04 sec</li>
</ul>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">~/</span><span class="n">wasmtime</span><span class="w"> </span><span class="p">((</span><span class="n">dev</span><span class="p">))</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">clean</span>
<span class="n">t</span><span class="w">     </span><span class="n">Removed</span><span class="w"> </span><span class="mi">1356</span><span class="w"> </span><span class="n">files</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="n">GiB</span><span class="w"> </span><span class="n">total</span>
<span class="o">~/</span><span class="n">wasmtime</span><span class="w"> </span><span class="p">((</span><span class="n">dev</span><span class="p">))</span><span class="o">&gt;</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="o">-</span><span class="n">q</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="n">cranelift</span><span class="o">-</span><span class="n">codegen</span>

<span class="n">________________________________________________________</span>
<span class="n">Executed</span><span class="w"> </span><span class="k">in</span><span class="w">   </span><span class="mf">26.04</span><span class="w"> </span><span class="n">secs</span><span class="w">    </span><span class="n">fish</span><span class="w">           </span><span class="n">external</span>
<span class="w">   </span><span class="n">usr</span><span class="w"> </span><span class="n">time</span><span class="w">   </span><span class="mf">46.58</span><span class="w"> </span><span class="n">secs</span><span class="w">    </span><span class="mf">0.00</span><span class="w"> </span><span class="n">micros</span><span class="w">   </span><span class="mf">46.58</span><span class="w"> </span><span class="n">secs</span>
<span class="w">   </span><span class="n">sys</span><span class="w"> </span><span class="n">time</span><span class="w">    </span><span class="mf">5.15</span><span class="w"> </span><span class="n">secs</span><span class="w">  </span><span class="mf">583.00</span><span class="w"> </span><span class="n">micros</span><span class="w">    </span><span class="mf">5.15</span><span class="w"> </span><span class="n">secs</span>
</code></pre></div>
<ul>
<li>Cargo Timing Reports<ul>
<li>Before: <a href="https://github.com/user-attachments/files/24523107/cargo-timing-old.html">cargo-timing-old.html</a></li>
<li>After: <a href="https://github.com/user-attachments/files/24523109/cargo-timing-new.html">cargo-timing-new.html</a></li>
</ul>
</li>
</ul>
<h2>Extra</h2>
<p>I am experimenting with over 6,000 ISLE <code>simplify</code> rules.<br>
The compilation time reduced from 841.37 seconds to 69.34 seconds with this PR. (+11x speedup)</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">~/</span><span class="n">w</span><span class="o">/</span><span class="n">cranelift</span><span class="w"> </span><span class="p">((</span><span class="n">many</span><span class="o">-</span><span class="n">rules</span><span class="o">-</span><span class="n">no</span><span class="o">-</span><span class="n">opt</span><span class="p">))</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">clean</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="n">cranelift</span><span class="o">-</span><span class="n">codegen</span>
<span class="n">________________________________________________________</span>
<span class="n">Executed</span><span class="w"> </span><span class="k">in</span><span class="w">  </span><span class="mf">841.37</span><span class="w"> </span><span class="n">secs</span><span class="w">    </span><span class="n">fish</span><span class="w">           </span><span class="n">external</span>
<span class="w">   </span><span class="n">usr</span><span class="w"> </span><span class="n">time</span><span class="w">  </span><span class="mf">826.92</span><span class="w"> </span><span class="n">secs</span><span class="w">  </span><span class="mf">325.00</span><span class="w"> </span><span class="n">micros</span><span class="w">  </span><span class="mf">826.92</span><span class="w"> </span><span class="n">secs</span>
<span class="w">   </span><span class="n">sys</span><span class="w"> </span><span class="n">time</span><span class="w">   </span><span class="mf">49.98</span><span class="w"> </span><span class="n">secs</span><span class="w">  </span><span class="mf">135.00</span><span class="w"> </span><span class="n">micros</span><span class="w">   </span><span class="mf">49.98</span><span class="w"> </span><span class="n">secs</span>

<span class="w"> </span><span class="o">~/</span><span class="n">w</span><span class="o">/</span><span class="n">cranelift</span><span class="w"> </span><span class="p">(</span><span class="n">many</span><span class="o">-</span><span class="n">rules</span><span class="o">-</span><span class="n">opt</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">clean</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="o">-</span><span class="n">q</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="n">cranelift</span><span class="o">-</span><span class="n">codegen</span>
<span class="n">________________________________________________________</span>
<span class="n">Executed</span><span class="w"> </span><span class="k">in</span><span class="w">   </span><span class="mf">69.34</span><span class="w"> </span><span class="n">secs</span><span class="w">    </span><span class="n">fish</span><span class="w">           </span><span class="n">external</span>
<span class="w">   </span><span class="n">usr</span><span class="w"> </span><span class="n">time</span><span class="w">   </span><span class="mf">98.32</span><span class="w"> </span><span class="n">secs</span><span class="w">  </span><span class="mf">362.00</span><span class="w"> </span><span class="n">micros</span><span class="w">   </span><span class="mf">98.32</span><span class="w"> </span><span class="n">secs</span>
<span class="w">   </span><span class="n">sys</span><span class="w"> </span><span class="n">time</span><span class="w">    </span><span class="mf">6.42</span><span class="w"> </span><span class="n">secs</span><span class="w">  </span><span class="mf">149.00</span><span class="w"> </span><span class="n">micros</span><span class="w">    </span><span class="mf">6.42</span><span class="w"> </span><span class="n">secs</span>
</code></pre></div>
</blockquote>



<a name="567438286"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312303%20Optimize%20ISLE%20compilation/near/567438286" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312303.20Optimize.20ISLE.20compilation.html#567438286">(Jan 12 2026 at 04:25)</a>:</h4>
<p>bongjunj edited <a href="https://github.com/bytecodealliance/wasmtime/pull/12303">PR #12303</a>:</p>
<blockquote>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
<h2>Overview</h2>
<p>The current implementation of ISLE code generation emits a single Rust function for each ISLE term, and <code>rustc</code> compiles the Rust code to integrate ISLE with other modules of Cranelift.</p>
<p>This can cause a compilation bottleneck when a ISLE term contains numerous rules ending up with producing a very very large Rust function, since <code>rustc</code> cannot efficiently compile such functions. Notably, the term <code>simplify</code> which implements the mid-end peephole optimizations has about 500 rules, and the symptom is already visible. (And the ruleset is growing!) You can check, compiling Cranelift, <code>cranelift-codegen</code> takes most of the time in the following report: <a href="https://github.com/user-attachments/files/24522422/cargo-timing.html">cargo-timing.html</a></p>
<p>With this PR, the ISLE codegen helps <code>rustc</code> by wrapping a large match statement generated by <code>islec</code> in a closure. By introducing closures, a portion of a huge Rust function (for a ISLE term) can be split into several smaller compilation units for <code>rustc</code>, reducing the compilation time.</p>
<h2>Evaluation</h2>
<p>On the <code>main</code> branch, the build times for <code>cranelift-codegen</code> before/after this optimization are measured. This PR saves ~2 seconds on my machine (x86-64, 64 core, 512GB memory)</p>
<ul>
<li>After: 23.81 sec</li>
</ul>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">~/</span><span class="n">wasmtime</span><span class="w"> </span><span class="p">(</span><span class="n">optimize</span><span class="o">-</span><span class="n">isle</span><span class="o">-</span><span class="n">compilation</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">clean</span>
<span class="w">     </span><span class="n">Removed</span><span class="w"> </span><span class="mi">10031</span><span class="w"> </span><span class="n">files</span><span class="p">,</span><span class="w"> </span><span class="mf">12.6</span><span class="n">GiB</span><span class="w"> </span><span class="n">total</span>
<span class="o">~/</span><span class="n">wasmtime</span><span class="w"> </span><span class="p">(</span><span class="n">optimize</span><span class="o">-</span><span class="n">isle</span><span class="o">-</span><span class="n">compilation</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="o">-</span><span class="n">q</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="n">cranelift</span><span class="o">-</span><span class="n">codegen</span>

<span class="n">________________________________________________________</span>
<span class="n">Executed</span><span class="w"> </span><span class="k">in</span><span class="w">   </span><span class="mf">23.81</span><span class="w"> </span><span class="n">secs</span><span class="w">    </span><span class="n">fish</span><span class="w">           </span><span class="n">external</span>
<span class="w">   </span><span class="n">usr</span><span class="w"> </span><span class="n">time</span><span class="w">   </span><span class="mf">43.59</span><span class="w"> </span><span class="n">secs</span><span class="w">    </span><span class="mf">0.00</span><span class="w"> </span><span class="n">micros</span><span class="w">   </span><span class="mf">43.59</span><span class="w"> </span><span class="n">secs</span>
<span class="w">   </span><span class="n">sys</span><span class="w"> </span><span class="n">time</span><span class="w">    </span><span class="mf">5.04</span><span class="w"> </span><span class="n">secs</span><span class="w">  </span><span class="mf">592.00</span><span class="w"> </span><span class="n">micros</span><span class="w">    </span><span class="mf">5.04</span><span class="w"> </span><span class="n">secs</span>
</code></pre></div>
<ul>
<li>Before: 26.04 sec</li>
</ul>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">~/</span><span class="n">wasmtime</span><span class="w"> </span><span class="p">((</span><span class="n">dev</span><span class="p">))</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">clean</span>
<span class="n">t</span><span class="w">     </span><span class="n">Removed</span><span class="w"> </span><span class="mi">1356</span><span class="w"> </span><span class="n">files</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="n">GiB</span><span class="w"> </span><span class="n">total</span>
<span class="o">~/</span><span class="n">wasmtime</span><span class="w"> </span><span class="p">((</span><span class="n">dev</span><span class="p">))</span><span class="o">&gt;</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="o">-</span><span class="n">q</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="n">cranelift</span><span class="o">-</span><span class="n">codegen</span>

<span class="n">________________________________________________________</span>
<span class="n">Executed</span><span class="w"> </span><span class="k">in</span><span class="w">   </span><span class="mf">26.04</span><span class="w"> </span><span class="n">secs</span><span class="w">    </span><span class="n">fish</span><span class="w">           </span><span class="n">external</span>
<span class="w">   </span><span class="n">usr</span><span class="w"> </span><span class="n">time</span><span class="w">   </span><span class="mf">46.58</span><span class="w"> </span><span class="n">secs</span><span class="w">    </span><span class="mf">0.00</span><span class="w"> </span><span class="n">micros</span><span class="w">   </span><span class="mf">46.58</span><span class="w"> </span><span class="n">secs</span>
<span class="w">   </span><span class="n">sys</span><span class="w"> </span><span class="n">time</span><span class="w">    </span><span class="mf">5.15</span><span class="w"> </span><span class="n">secs</span><span class="w">  </span><span class="mf">583.00</span><span class="w"> </span><span class="n">micros</span><span class="w">    </span><span class="mf">5.15</span><span class="w"> </span><span class="n">secs</span>
</code></pre></div>
<ul>
<li>Cargo Timing Reports<ul>
<li>Before: <a href="https://github.com/user-attachments/files/24523107/cargo-timing-old.html">cargo-timing-old.html</a></li>
<li>After: <a href="https://github.com/user-attachments/files/24523109/cargo-timing-new.html">cargo-timing-new.html</a></li>
</ul>
</li>
</ul>
<h2>Extra</h2>
<p>I am experimenting with over 6,000 ISLE <code>simplify</code> rules.<br>
The compilation time reduced from 841.37 seconds to 69.34 seconds with this PR. (+11x speedup)</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">~/</span><span class="n">w</span><span class="o">/</span><span class="n">cranelift</span><span class="w"> </span><span class="p">((</span><span class="n">many</span><span class="o">-</span><span class="n">rules</span><span class="o">-</span><span class="n">no</span><span class="o">-</span><span class="n">opt</span><span class="p">))</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">clean</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="n">cranelift</span><span class="o">-</span><span class="n">codegen</span>
<span class="n">________________________________________________________</span>
<span class="n">Executed</span><span class="w"> </span><span class="k">in</span><span class="w">  </span><span class="mf">841.37</span><span class="w"> </span><span class="n">secs</span><span class="w">    </span><span class="n">fish</span><span class="w">           </span><span class="n">external</span>
<span class="w">   </span><span class="n">usr</span><span class="w"> </span><span class="n">time</span><span class="w">  </span><span class="mf">826.92</span><span class="w"> </span><span class="n">secs</span><span class="w">  </span><span class="mf">325.00</span><span class="w"> </span><span class="n">micros</span><span class="w">  </span><span class="mf">826.92</span><span class="w"> </span><span class="n">secs</span>
<span class="w">   </span><span class="n">sys</span><span class="w"> </span><span class="n">time</span><span class="w">   </span><span class="mf">49.98</span><span class="w"> </span><span class="n">secs</span><span class="w">  </span><span class="mf">135.00</span><span class="w"> </span><span class="n">micros</span><span class="w">   </span><span class="mf">49.98</span><span class="w"> </span><span class="n">secs</span>

<span class="w"> </span><span class="o">~/</span><span class="n">w</span><span class="o">/</span><span class="n">cranelift</span><span class="w"> </span><span class="p">(</span><span class="n">many</span><span class="o">-</span><span class="n">rules</span><span class="o">-</span><span class="n">opt</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">clean</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="o">-</span><span class="n">q</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="n">cranelift</span><span class="o">-</span><span class="n">codegen</span>
<span class="n">________________________________________________________</span>
<span class="n">Executed</span><span class="w"> </span><span class="k">in</span><span class="w">   </span><span class="mf">69.34</span><span class="w"> </span><span class="n">secs</span><span class="w">    </span><span class="n">fish</span><span class="w">           </span><span class="n">external</span>
<span class="w">   </span><span class="n">usr</span><span class="w"> </span><span class="n">time</span><span class="w">   </span><span class="mf">98.32</span><span class="w"> </span><span class="n">secs</span><span class="w">  </span><span class="mf">362.00</span><span class="w"> </span><span class="n">micros</span><span class="w">   </span><span class="mf">98.32</span><span class="w"> </span><span class="n">secs</span>
<span class="w">   </span><span class="n">sys</span><span class="w"> </span><span class="n">time</span><span class="w">    </span><span class="mf">6.42</span><span class="w"> </span><span class="n">secs</span><span class="w">  </span><span class="mf">149.00</span><span class="w"> </span><span class="n">micros</span><span class="w">    </span><span class="mf">6.42</span><span class="w"> </span><span class="n">secs</span>
</code></pre></div>
</blockquote>



<a name="567442666"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312303%20Optimize%20ISLE%20compilation/near/567442666" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312303.20Optimize.20ISLE.20compilation.html#567442666">(Jan 12 2026 at 05:04)</a>:</h4>
<p>bongjunj <a href="https://github.com/bytecodealliance/wasmtime/pull/12303#issuecomment-3736895588">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/12303">PR #12303</a>:</p>
<blockquote>
<p>@cfallin </p>
<p>Thanks for the comment! I've ran the benchmarks and measure the compilation time.<br>
It turned out that the compilation overhead is almost next to zero.<br>
This is probably because it introduces closures only for large pattern matches.<br>
The raw data (for 10 iterations -- default setting of sightglass-cli) is as below:</p>
<table>
<thead>
<tr>
<th>bench</th>
<th>optimize-isle-compilation</th>
<th>main</th>
<th>overhead</th>
</tr>
</thead>
<tbody>
<tr>
<td>bz2</td>
<td>273,462,445</td>
<td>271,631,283</td>
<td>0.67%</td>
</tr>
<tr>
<td>pulldown-cmark</td>
<td>623,480,512</td>
<td>622,976,525</td>
<td>0.08%</td>
</tr>
<tr>
<td>spidermonkey</td>
<td>21,592,595,980</td>
<td>21,523,101,083</td>
<td>0.32%</td>
</tr>
</tbody>
</table>
</blockquote>



<a name="567443008"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312303%20Optimize%20ISLE%20compilation/near/567443008" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312303.20Optimize.20ISLE.20compilation.html#567443008">(Jan 12 2026 at 05:11)</a>:</h4>
<p>bongjunj submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/12303#pullrequestreview-3649193466">PR review</a>.</p>



<a name="567443009"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312303%20Optimize%20ISLE%20compilation/near/567443009" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312303.20Optimize.20ISLE.20compilation.html#567443009">(Jan 12 2026 at 05:11)</a>:</h4>
<p>bongjunj created <a href="https://github.com/bytecodealliance/wasmtime/pull/12303#discussion_r2680890907">PR review comment</a>:</p>
<blockquote>
<p>FYI I experimented three values for this: 128, 256, 512.<br>
The best one was 256 for the current ruleset (~500 rules), and 512 for my massive ruleset (~6,700 rules).<br>
There could be some relation between threshold value and the ruleset size. Additionally, the parallelism available of the development environment could affect too.</p>
<p>However, as this could affect the quality of the compiled cranelift, I assumed at first sticking to the best value was a good idea.  </p>
</blockquote>



<a name="568924652"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312303%20Optimize%20ISLE%20compilation/near/568924652" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312303.20Optimize.20ISLE.20compilation.html#568924652">(Jan 20 2026 at 00:44)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/12303#issuecomment-3770564582">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/12303">PR #12303</a>:</p>
<blockquote>
<p>Sorry for the delayed response here -- was traveling then lost track of this PR.</p>
<p>Thanks for the experiments! I think I agree with Nick that this would be good to have as an option, probably off by default. 0.67% compile time is still an unfortunate regression to take (on the flip side, 1% speedups make us pretty happy and take work to find), and is more important than the time taken to compile Cranelift, since usually you compile Cranelift once then use that compiled Cranelift-containing program many times. But when developing Cranelift, it would be useful to have this option.</p>
<p>Could you put this under a Cargo feature that alters the behavior of <code>islec</code> as invoked by <code>cranelift-codegen</code>'s <code>build.rs</code>?</p>
</blockquote>



<a name="568924686"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312303%20Optimize%20ISLE%20compilation/near/568924686" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312303.20Optimize.20ISLE.20compilation.html#568924686">(Jan 20 2026 at 00:44)</a>:</h4>
<p>cfallin edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/12303#issuecomment-3770564582">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/12303">PR #12303</a>:</p>
<blockquote>
<p>Sorry for the delayed response here -- was traveling then lost track of this PR.</p>
<p>Thanks for the experiments! I think I agree with Nick that this would be good to have as an option, probably off by default. 0.67% compile time is still an unfortunate regression to take (on the flip side, 1% speedups make us pretty happy and take work to find), and is (usually) more important than the time taken to compile Cranelift, since usually you compile Cranelift once then use that compiled Cranelift-containing program many times. But when developing Cranelift, it would be useful to have this option.</p>
<p>Could you put this under a Cargo feature that alters the behavior of <code>islec</code> as invoked by <code>cranelift-codegen</code>'s <code>build.rs</code>?</p>
</blockquote>



<a name="569221308"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312303%20Optimize%20ISLE%20compilation/near/569221308" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312303.20Optimize.20ISLE.20compilation.html#569221308">(Jan 21 2026 at 10:42)</a>:</h4>
<p>bongjunj <a href="https://github.com/bytecodealliance/wasmtime/pull/12303#issuecomment-3777401331">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/12303">PR #12303</a>:</p>
<blockquote>
<p>@cfallin thanks for the comment!<br>
I think I could handle this until this weekend. Will mention you when I finish the feature.</p>
<p>Thank you.</p>
</blockquote>



<a name="570229610"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312303%20Optimize%20ISLE%20compilation/near/570229610" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312303.20Optimize.20ISLE.20compilation.html#570229610">(Jan 27 2026 at 03:41)</a>:</h4>
<p>bongjunj updated <a href="https://github.com/bytecodealliance/wasmtime/pull/12303">PR #12303</a>.</p>



<a name="570232042"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312303%20Optimize%20ISLE%20compilation/near/570232042" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312303.20Optimize.20ISLE.20compilation.html#570232042">(Jan 27 2026 at 04:15)</a>:</h4>
<p>bongjunj updated <a href="https://github.com/bytecodealliance/wasmtime/pull/12303">PR #12303</a>.</p>



<a name="570232447"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312303%20Optimize%20ISLE%20compilation/near/570232447" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312303.20Optimize.20ISLE.20compilation.html#570232447">(Jan 27 2026 at 04:20)</a>:</h4>
<p>bongjunj updated <a href="https://github.com/bytecodealliance/wasmtime/pull/12303">PR #12303</a>.</p>



<a name="570232583"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312303%20Optimize%20ISLE%20compilation/near/570232583" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312303.20Optimize.20ISLE.20compilation.html#570232583">(Jan 27 2026 at 04:22)</a>:</h4>
<p>bongjunj <a href="https://github.com/bytecodealliance/wasmtime/pull/12303#issuecomment-3803028826">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/12303">PR #12303</a>:</p>
<blockquote>
<p>@cfallin This is now wrapped under a Cargo feature <code>isle-split-match</code> on the crate <code>cranelift-codegen</code>.</p>
<p>@fitzgen Now we have a controllable splitting threshold, via setting an environment variable: <code>ISLE_SPLIT_MATCH_THRESHOLD=512</code></p>
</blockquote>



<a name="570369443"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312303%20Optimize%20ISLE%20compilation/near/570369443" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312303.20Optimize.20ISLE.20compilation.html#570369443">(Jan 27 2026 at 16:39)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/12303#pullrequestreview-3712261670">PR review</a>:</p>
<blockquote>
<p>LGTM -- thanks very much for the patience here!</p>
</blockquote>



<a name="570369508"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312303%20Optimize%20ISLE%20compilation/near/570369508" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312303.20Optimize.20ISLE.20compilation.html#570369508">(Jan 27 2026 at 16:39)</a>:</h4>
<p>cfallin added <a href="https://github.com/bytecodealliance/wasmtime/pull/12303">PR #12303 Optimize ISLE compilation</a> to the merge queue.</p>



<a name="570376238"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312303%20Optimize%20ISLE%20compilation/near/570376238" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312303.20Optimize.20ISLE.20compilation.html#570376238">(Jan 27 2026 at 17:08)</a>:</h4>
<p>cfallin merged <a href="https://github.com/bytecodealliance/wasmtime/pull/12303">PR #12303</a>.</p>



<a name="570376240"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312303%20Optimize%20ISLE%20compilation/near/570376240" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312303.20Optimize.20ISLE.20compilation.html#570376240">(Jan 27 2026 at 17:08)</a>:</h4>
<p>cfallin removed <a href="https://github.com/bytecodealliance/wasmtime/pull/12303">PR #12303 Optimize ISLE compilation</a> from the merge queue.</p>



<hr><p>Last updated: Feb 22 2026 at 11:05 UTC</p>
</html>
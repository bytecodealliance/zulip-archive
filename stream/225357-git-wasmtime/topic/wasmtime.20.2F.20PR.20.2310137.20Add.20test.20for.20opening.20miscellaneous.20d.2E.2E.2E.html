<html>
<head><meta charset="utf-8"><title>wasmtime / PR #10137 Add test for opening miscellaneous d... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310137.20Add.20test.20for.20opening.20miscellaneous.20d.2E.2E.2E.html">wasmtime / PR #10137 Add test for opening miscellaneous d...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="496378749"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310137%20Add%20test%20for%20opening%20miscellaneous%20d.../near/496378749" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310137.20Add.20test.20for.20opening.20miscellaneous.20d.2E.2E.2E.html#496378749">(Jan 28 2025 at 16:45)</a>:</h4>
<p>erikrose opened <a href="https://github.com/bytecodealliance/wasmtime/pull/10137">PR #10137</a> from <code>erikrose:dev-read-test</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>Fixes #514, but CI is grumpy and I have questions.</p>
<p>Both the sync and async variants run by <code>cargo test -p wasi-common preview1_device_read</code> work and are valid.</p>
<p>However, <code>foreach_preview1!(assert_test_exists)</code> fails its assertions when I run <code>ci/run-tests.sh</code> unless I repeat my tests in <code>wasi</code> (commented out here) as well as <code>wasi-common</code>. Is that the intent? I'm not sure what value such repetition has for this test. Perhaps I'm adding tests in the wrong place altogether. I welcome any illumination! (@alexcrichton?)</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">error</span><span class="p">[</span><span class="n">E0432</span><span class="p">]:</span><span class="w"> </span><span class="nc">unresolved</span><span class="w"> </span><span class="n">import</span><span class="w"> </span><span class="err">`</span><span class="bp">self</span><span class="p">::</span><span class="n">preview1_device_read</span><span class="err">`</span>
<span class="w">  </span><span class="o">-</span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">crates</span><span class="o">/</span><span class="n">wasi</span><span class="o">/</span><span class="n">tests</span><span class="o">/</span><span class="n">all</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">86</span><span class="p">:</span><span class="mi">13</span>
<span class="w">   </span><span class="o">|</span>
<span class="mi">86</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="k">use</span><span class="w"> </span><span class="bp">self</span><span class="p">::</span><span class="cp">$name</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">_</span><span class="p">;</span>
<span class="w">   </span><span class="o">|</span><span class="w">             </span><span class="o">^^^^^^^^^^^^^^^^</span><span class="w"> </span><span class="n">no</span><span class="w"> </span><span class="err">`</span><span class="n">preview1_device_read</span><span class="err">`</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="err">`</span><span class="n">async_</span><span class="err">`</span>
<span class="w">   </span><span class="o">|</span>
<span class="w">  </span><span class="p">:::</span><span class="w"> </span><span class="nc">crates</span><span class="o">/</span><span class="n">wasi</span><span class="o">/</span><span class="n">tests</span><span class="o">/</span><span class="n">all</span><span class="o">/</span><span class="n">async_</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">30</span><span class="p">:</span><span class="mi">1</span>
<span class="w">   </span><span class="o">|</span>
<span class="mi">30</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">foreach_preview1</span><span class="o">!</span><span class="p">(</span><span class="n">assert_test_exists</span><span class="p">);</span>
<span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="o">-------------------------------------</span>
<span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="o">|</span>
<span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">help</span><span class="p">:</span><span class="w"> </span><span class="nc">a</span><span class="w"> </span><span class="n">similar</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="n">exists</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">module</span><span class="p">:</span><span class="w"> </span><span class="err">`</span><span class="n">PREVIEW1_DEVICE_READ</span><span class="err">`</span>
<span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="kr">macro</span><span class="w"> </span><span class="n">invocation</span>
<span class="w">   </span><span class="o">|</span>
<span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">note</span><span class="p">:</span><span class="w"> </span><span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">originates</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="kr">macro</span><span class="w"> </span><span class="err">`</span><span class="n">assert_test_exists</span><span class="err">`</span><span class="w"> </span><span class="n">which</span><span class="w"> </span><span class="n">comes</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">expansion</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="kr">macro</span><span class="w"> </span><span class="err">`</span><span class="n">foreach_preview1</span><span class="err">`</span><span class="w"> </span><span class="p">(</span><span class="k">in</span><span class="w"> </span><span class="n">Nightly</span><span class="w"> </span><span class="n">builds</span><span class="p">,</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="o">-</span><span class="n">Z</span><span class="w"> </span><span class="kr">macro</span><span class="o">-</span><span class="n">backtrace</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">info</span><span class="p">)</span>

<span class="n">error</span><span class="p">[</span><span class="n">E0432</span><span class="p">]:</span><span class="w"> </span><span class="nc">unresolved</span><span class="w"> </span><span class="n">import</span><span class="w"> </span><span class="err">`</span><span class="bp">self</span><span class="p">::</span><span class="n">preview1_device_read</span><span class="err">`</span>
<span class="w">  </span><span class="o">-</span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">crates</span><span class="o">/</span><span class="n">wasi</span><span class="o">/</span><span class="n">tests</span><span class="o">/</span><span class="n">all</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">86</span><span class="p">:</span><span class="mi">13</span>
<span class="w">   </span><span class="o">|</span>
<span class="mi">86</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="k">use</span><span class="w"> </span><span class="bp">self</span><span class="p">::</span><span class="cp">$name</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">_</span><span class="p">;</span>
<span class="w">   </span><span class="o">|</span><span class="w">             </span><span class="o">^^^^^^^^^^^^^^^^</span><span class="w"> </span><span class="n">no</span><span class="w"> </span><span class="err">`</span><span class="n">preview1_device_read</span><span class="err">`</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="err">`</span><span class="n">preview1</span><span class="err">`</span>
<span class="w">   </span><span class="o">|</span>
<span class="w">  </span><span class="p">:::</span><span class="w"> </span><span class="nc">crates</span><span class="o">/</span><span class="n">wasi</span><span class="o">/</span><span class="n">tests</span><span class="o">/</span><span class="n">all</span><span class="o">/</span><span class="n">preview1</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">28</span><span class="p">:</span><span class="mi">1</span>
<span class="w">   </span><span class="o">|</span>
<span class="mi">28</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">foreach_preview1</span><span class="o">!</span><span class="p">(</span><span class="n">assert_test_exists</span><span class="p">);</span>
<span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="o">-------------------------------------</span>
<span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="o">|</span>
<span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">help</span><span class="p">:</span><span class="w"> </span><span class="nc">a</span><span class="w"> </span><span class="n">similar</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="n">exists</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">module</span><span class="p">:</span><span class="w"> </span><span class="err">`</span><span class="n">PREVIEW1_DEVICE_READ</span><span class="err">`</span>
<span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="kr">macro</span><span class="w"> </span><span class="n">invocation</span>
<span class="w">   </span><span class="o">|</span>
<span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">note</span><span class="p">:</span><span class="w"> </span><span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">originates</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="kr">macro</span><span class="w"> </span><span class="err">`</span><span class="n">assert_test_exists</span><span class="err">`</span><span class="w"> </span><span class="n">which</span><span class="w"> </span><span class="n">comes</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">expansion</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="kr">macro</span><span class="w"> </span><span class="err">`</span><span class="n">foreach_preview1</span><span class="err">`</span><span class="w"> </span><span class="p">(</span><span class="k">in</span><span class="w"> </span><span class="n">Nightly</span><span class="w"> </span><span class="n">builds</span><span class="p">,</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="o">-</span><span class="n">Z</span><span class="w"> </span><span class="kr">macro</span><span class="o">-</span><span class="n">backtrace</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">info</span><span class="p">)</span>

<span class="n">error</span><span class="p">[</span><span class="n">E0432</span><span class="p">]:</span><span class="w"> </span><span class="nc">unresolved</span><span class="w"> </span><span class="n">import</span><span class="w"> </span><span class="err">`</span><span class="bp">self</span><span class="p">::</span><span class="n">preview1_device_read</span><span class="err">`</span>
<span class="w">  </span><span class="o">-</span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">crates</span><span class="o">/</span><span class="n">wasi</span><span class="o">/</span><span class="n">tests</span><span class="o">/</span><span class="n">all</span><span class="o">/</span><span class="n">main</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">86</span><span class="p">:</span><span class="mi">13</span>
<span class="w">   </span><span class="o">|</span>
<span class="mi">86</span><span class="w"> </span><span class="o">|</span><span class="w">         </span><span class="k">use</span><span class="w"> </span><span class="bp">self</span><span class="p">::</span><span class="cp">$name</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">_</span><span class="p">;</span>
<span class="w">   </span><span class="o">|</span><span class="w">             </span><span class="o">^^^^^^^^^^^^^^^^</span><span class="w"> </span><span class="n">no</span><span class="w"> </span><span class="err">`</span><span class="n">preview1_device_read</span><span class="err">`</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="err">`</span><span class="n">sync</span><span class="err">`</span>
<span class="w">   </span><span class="o">|</span>
<span class="w">  </span><span class="p">:::</span><span class="w"> </span><span class="nc">crates</span><span class="o">/</span><span class="n">wasi</span><span class="o">/</span><span class="n">tests</span><span class="o">/</span><span class="n">all</span><span class="o">/</span><span class="n">sync</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">1</span>
<span class="w">   </span><span class="o">|</span>
<span class="mi">32</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">foreach_preview1</span><span class="o">!</span><span class="p">(</span><span class="n">assert_test_exists</span><span class="p">);</span>
<span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="o">-------------------------------------</span>
<span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="o">|</span>
<span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">help</span><span class="p">:</span><span class="w"> </span><span class="nc">a</span><span class="w"> </span><span class="n">similar</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="n">exists</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">module</span><span class="p">:</span><span class="w"> </span><span class="err">`</span><span class="n">PREVIEW1_DEVICE_READ</span><span class="err">`</span>
<span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="kr">macro</span><span class="w"> </span><span class="n">invocation</span>
<span class="w">   </span><span class="o">|</span>
<span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">note</span><span class="p">:</span><span class="w"> </span><span class="nc">this</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">originates</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="kr">macro</span><span class="w"> </span><span class="err">`</span><span class="n">assert_test_exists</span><span class="err">`</span><span class="w"> </span><span class="n">which</span><span class="w"> </span><span class="n">comes</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">expansion</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="kr">macro</span><span class="w"> </span><span class="err">`</span><span class="n">foreach_preview1</span><span class="err">`</span><span class="w"> </span><span class="p">(</span><span class="k">in</span><span class="w"> </span><span class="n">Nightly</span><span class="w"> </span><span class="n">builds</span><span class="p">,</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="o">-</span><span class="n">Z</span><span class="w"> </span><span class="kr">macro</span><span class="o">-</span><span class="n">backtrace</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">info</span><span class="p">)</span>
</code></pre></div>
<p>Note that I've hard-coded a "/dev" preopen into the test harnesses temporarily. Once I'm sure I'm adding to the right set of tests, I'll refactor to pass it only for this new one.</p>
</blockquote>



<a name="496399131"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310137%20Add%20test%20for%20opening%20miscellaneous%20d.../near/496399131" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310137.20Add.20test.20for.20opening.20miscellaneous.20d.2E.2E.2E.html#496399131">(Jan 28 2025 at 18:27)</a>:</h4>
<p>erikrose updated <a href="https://github.com/bytecodealliance/wasmtime/pull/10137">PR #10137</a>.</p>



<a name="496415723"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310137%20Add%20test%20for%20opening%20miscellaneous%20d.../near/496415723" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310137.20Add.20test.20for.20opening.20miscellaneous.20d.2E.2E.2E.html#496415723">(Jan 28 2025 at 20:07)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/10137#issuecomment-2619956305">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/10137">PR #10137</a>:</p>
<blockquote>
<p>Thanks! Yeah what you're seeing here is a bit of history + testing infrastructure, sorry for the confusion...</p>
<p>The <code>wasi-common</code> crate that #514 refers to has been deprecated for some time now in favor of <code>wasmtime-wasi</code>, although currently all <code>preview1_*.rs</code> tests are run in both to ensure neither regresses. The infrastructure basically asserts (via a slightly roundabout method) that there's a test function for each test case which is hand-written. You've added the tests to wasi-common here but the <code>wasmtime-wasi</code> test suite asserts it's running all preview1 tests here but uncommenting the blocks there should be good to go.</p>
<p>One thing you'll need to handle I think though is Windows-vs-Unix as these tests probably won't pass on Windows. Additionally it looks like you're changing how all tests are run by preopening <code>/dev</code> instead of the workspace? If possible that'd only be done for this one test as opposed to all of them, which might need a slightly fancier helper function to run the test than what exists right now </p>
</blockquote>



<a name="496422283"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310137%20Add%20test%20for%20opening%20miscellaneous%20d.../near/496422283" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310137.20Add.20test.20for.20opening.20miscellaneous.20d.2E.2E.2E.html#496422283">(Jan 28 2025 at 20:53)</a>:</h4>
<p>erikrose <a href="https://github.com/bytecodealliance/wasmtime/pull/10137#issuecomment-2620034580">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/10137">PR #10137</a>:</p>
<blockquote>
<p>Thanks so much! That clears it right up. Redundancy that serves a purpose is no redundancy at all. :-)</p>
<blockquote>
<p>One thing you'll need to handle I think though is Windows-vs-Unix as these tests probably won't pass on Windows.</p>
</blockquote>
<p>AFAIK, Windows doesn't have file-like devices, so I don't believe the tests make sense there. Indeed, ports of utils like <code>dd</code> have had to implement <a href="http://www.chrysocome.net/dd">fakes to work around the lack</a>. That's why I stuck<code>#[cfg_attr(not(unix), ignore)]</code> around the tests initially. Though please scream if I'm missing something.</p>
<blockquote>
<p>Additionally it looks like you're changing how all tests are run by preopening /dev instead of the workspace?</p>
</blockquote>
<p>Just some temporary violence. I had said this below the giant error message, but hiding it there made it easy to miss:</p>
<blockquote>
<p>Note that I've hard-coded a "/dev" preopen into the test harnesses temporarily. Once I'm sure I'm adding to the right set of tests, I'll refactor to pass it only for this new one.</p>
</blockquote>
<p>Thanks again! With that new information, I'll see if I can get things going.</p>
</blockquote>



<a name="496427540"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310137%20Add%20test%20for%20opening%20miscellaneous%20d.../near/496427540" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310137.20Add.20test.20for.20opening.20miscellaneous.20d.2E.2E.2E.html#496427540">(Jan 28 2025 at 21:30)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/10137#issuecomment-2620094737">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/10137">PR #10137</a>:</p>
<blockquote>
<p>Oops sorry I completely missed the <code>#[cfg_attr(not(unix), ignore)]</code>, sounds like you've got it all in hand <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span> </p>
</blockquote>



<hr><p>Last updated: Feb 22 2026 at 11:05 UTC</p>
</html>
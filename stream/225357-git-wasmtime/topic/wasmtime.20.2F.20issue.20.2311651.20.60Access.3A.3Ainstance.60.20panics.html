<html>
<head><meta charset="utf-8"><title>wasmtime / issue #11651 `Access::instance` panics · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311651.20.60Access.3A.3Ainstance.60.20panics.html">wasmtime / issue #11651 `Access::instance` panics</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="538450371"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311651%20%60Access%3A%3Ainstance%60%20panics/near/538450371" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311651.20.60Access.3A.3Ainstance.60.20panics.html#538450371">(Sep 09 2025 at 14:22)</a>:</h4>
<p>rvolosatovs opened <a href="https://github.com/bytecodealliance/wasmtime/issues/11651">issue #11651</a>:</p>
<blockquote>
<h3>Test Case</h3>
<p>Use <code>store</code> option to bindgen without <code>async</code> or simply call <code>instance</code> on <code>Access</code> returned by <code>Access::new</code></p>
<h3>Steps to Reproduce</h3>
<p>apply the following diff to #11649 </p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gh">diff --git a/crates/wasi-http/src/p3/bindings.rs b/crates/wasi-http/src/p3/bindings.rs</span>
<span class="gh">index b7fec724c1..9f2bd8e9cf 100644</span>
<span class="gd">--- a/crates/wasi-http/src/p3/bindings.rs</span>
<span class="gi">+++ b/crates/wasi-http/src/p3/bindings.rs</span>
<span class="gu">@@ -11,8 +11,8 @@ mod generated {</span>
<span class="w"> </span>            "wasi:http/types/[drop]response": store | trappable | tracing,
<span class="w"> </span>            "wasi:http/types/[method]request.consume-body": async | store | trappable | tracing,
<span class="w"> </span>            "wasi:http/types/[method]response.consume-body": async | store | trappable | tracing,
<span class="gd">-            "wasi:http/types/[static]request.new": async | store | trappable | tracing,</span>
<span class="gd">-            "wasi:http/types/[static]response.new": async | store | trappable | tracing,</span>
<span class="gi">+            "wasi:http/types/[static]request.new": store | trappable | tracing,</span>
<span class="gi">+            "wasi:http/types/[static]response.new": store | trappable | tracing,</span>
<span class="w"> </span>            default: trappable | tracing,
<span class="w"> </span>        },
<span class="w"> </span>        exports: { default: async | store },
<span class="gh">diff --git a/crates/wasi-http/src/p3/host/types.rs b/crates/wasi-http/src/p3/host/types.rs</span>
<span class="gh">index 165e4e4e12..3d662da585 100644</span>
<span class="gd">--- a/crates/wasi-http/src/p3/host/types.rs</span>
<span class="gi">+++ b/crates/wasi-http/src/p3/host/types.rs</span>
<span class="gu">@@ -303,45 +303,43 @@ impl HostFields for WasiHttpCtxView&lt;'_&gt; {</span>
<span class="w"> </span>}

<span class="w"> </span>impl HostRequestWithStore for WasiHttp {
<span class="gd">-    async fn new&lt;T&gt;(</span>
<span class="gd">-        store: &amp;Accessor&lt;T, Self&gt;,</span>
<span class="gi">+    fn new&lt;T&gt;(</span>
<span class="gi">+        mut store: Access&lt;'_, T, Self&gt;,</span>
<span class="w"> </span>        headers: Resource&lt;Headers&gt;,
<span class="w"> </span>        contents: Option&lt;StreamReader&lt;u8&gt;&gt;,
<span class="w"> </span>        trailers: FutureReader&lt;Result&lt;Option&lt;Resource&lt;Trailers&gt;&gt;, ErrorCode&gt;&gt;,
<span class="w"> </span>        options: Option&lt;Resource&lt;RequestOptions&gt;&gt;,
<span class="w"> </span>    ) -&gt; wasmtime::Result&lt;(Resource&lt;Request&gt;, FutureReader&lt;Result&lt;(), ErrorCode&gt;&gt;)&gt; {
<span class="gi">+        let WasiHttpCtxView { table, .. } = store.get();</span>
<span class="gi">+        let headers = delete_fields(table, headers)?;</span>
<span class="gi">+        let options = options</span>
<span class="gi">+            .map(|options| delete_request_options(table, options))</span>
<span class="gi">+            .transpose()?;</span>
<span class="gi">+        let (result_tx, result_rx) = oneshot::channel();</span>
<span class="gi">+        let body = Body::Guest {</span>
<span class="gi">+            contents_rx: contents,</span>
<span class="gi">+            trailers_rx: trailers,</span>
<span class="gi">+            result_tx,</span>
<span class="gi">+        };</span>
<span class="gi">+        let req = Request {</span>
<span class="gi">+            method: http::Method::GET,</span>
<span class="gi">+            scheme: None,</span>
<span class="gi">+            authority: None,</span>
<span class="gi">+            path_with_query: None,</span>
<span class="gi">+            headers: headers.into(),</span>
<span class="gi">+            options: options.map(Into::into),</span>
<span class="gi">+            body,</span>
<span class="gi">+        };</span>
<span class="gi">+        let req = table.push(req).context("failed to push request to table")?;</span>
<span class="w"> </span>        let instance = store.instance();
<span class="gd">-        store.with(|mut store| {</span>
<span class="gd">-            let (result_tx, result_rx) = oneshot::channel();</span>
<span class="gd">-            let WasiHttpCtxView { table, .. } = store.get();</span>
<span class="gd">-            let headers = delete_fields(table, headers)?;</span>
<span class="gd">-            let options = options</span>
<span class="gd">-                .map(|options| delete_request_options(table, options))</span>
<span class="gd">-                .transpose()?;</span>
<span class="gd">-            let body = Body::Guest {</span>
<span class="gd">-                contents_rx: contents,</span>
<span class="gd">-                trailers_rx: trailers,</span>
<span class="gd">-                result_tx,</span>
<span class="gd">-            };</span>
<span class="gd">-            let req = Request {</span>
<span class="gd">-                method: http::Method::GET,</span>
<span class="gd">-                scheme: None,</span>
<span class="gd">-                authority: None,</span>
<span class="gd">-                path_with_query: None,</span>
<span class="gd">-                headers: headers.into(),</span>
<span class="gd">-                options: options.map(Into::into),</span>
<span class="gd">-                body,</span>
<span class="gd">-            };</span>
<span class="gd">-            let req = table.push(req).context("failed to push request to table")?;</span>
<span class="gd">-            Ok((</span>
<span class="gd">-                req,</span>
<span class="gd">-                FutureReader::new(</span>
<span class="gd">-                    instance,</span>
<span class="gd">-                    &amp;mut store,</span>
<span class="gd">-                    GuestBodyResultProducer::Receiver(result_rx),</span>
<span class="gd">-                ),</span>
<span class="gd">-            ))</span>
<span class="gd">-        })</span>
<span class="gi">+        Ok((</span>
<span class="gi">+            req,</span>
<span class="gi">+            FutureReader::new(</span>
<span class="gi">+                instance,</span>
<span class="gi">+                &amp;mut store,</span>
<span class="gi">+                GuestBodyResultProducer::Receiver(result_rx),</span>
<span class="gi">+            ),</span>
<span class="gi">+        ))</span>
<span class="w"> </span>    }

<span class="w"> </span>    async fn consume_body&lt;T&gt;(
<span class="gu">@@ -586,39 +584,37 @@ impl HostRequestOptions for WasiHttpCtxView&lt;'_&gt; {</span>
<span class="w"> </span>}

<span class="w"> </span>impl HostResponseWithStore for WasiHttp {
<span class="gd">-    async fn new&lt;T&gt;(</span>
<span class="gd">-        store: &amp;Accessor&lt;T, Self&gt;,</span>
<span class="gi">+    fn new&lt;T&gt;(</span>
<span class="gi">+        mut store: Access&lt;'_, T, Self&gt;,</span>
<span class="w"> </span>        headers: Resource&lt;Headers&gt;,
<span class="w"> </span>        contents: Option&lt;StreamReader&lt;u8&gt;&gt;,
<span class="w"> </span>        trailers: FutureReader&lt;Result&lt;Option&lt;Resource&lt;Trailers&gt;&gt;, ErrorCode&gt;&gt;,
<span class="w"> </span>    ) -&gt; wasmtime::Result&lt;(Resource&lt;Response&gt;, FutureReader&lt;Result&lt;(), ErrorCode&gt;&gt;)&gt; {
<span class="gi">+        let WasiHttpCtxView { table, .. } = store.get();</span>
<span class="gi">+        let headers = delete_fields(table, headers)?;</span>
<span class="gi">+        let (result_tx, result_rx) = oneshot::channel();</span>
<span class="gi">+        let body = Body::Guest {</span>
<span class="gi">+            contents_rx: contents,</span>
<span class="gi">+            trailers_rx: trailers,</span>
<span class="gi">+            result_tx,</span>
<span class="gi">+        };</span>
<span class="gi">+        let res = Response {</span>
<span class="gi">+            status: http::StatusCode::OK,</span>
<span class="gi">+            headers: headers.into(),</span>
<span class="gi">+            body,</span>
<span class="gi">+        };</span>
<span class="gi">+        let res = table</span>
<span class="gi">+            .push(res)</span>
<span class="gi">+            .context("failed to push response to table")?;</span>
<span class="w"> </span>        let instance = store.instance();
<span class="gd">-        store.with(|mut store| {</span>
<span class="gd">-            let (result_tx, result_rx) = oneshot::channel();</span>
<span class="gd">-            let WasiHttpCtxView { table, .. } = store.get();</span>
<span class="gd">-            let headers = delete_fields(table, headers)?;</span>
<span class="gd">-            let body = Body::Guest {</span>
<span class="gd">-                contents_rx: contents,</span>
<span class="gd">-                trailers_rx: trailers,</span>
<span class="gd">-                result_tx,</span>
<span class="gd">-            };</span>
<span class="gd">-            let res = Response {</span>
<span class="gd">-                status: http::StatusCode::OK,</span>
<span class="gd">-                headers: headers.into(),</span>
<span class="gd">-                body,</span>
<span class="gd">-            };</span>
<span class="gd">-            let res = table</span>
<span class="gd">-                .push(res)</span>
<span class="gd">-                .context("failed to push response to table")?;</span>
<span class="gd">-            Ok((</span>
<span class="gd">-                res,</span>
<span class="gd">-                FutureReader::new(</span>
<span class="gd">-                    instance,</span>
<span class="gd">-                    &amp;mut store,</span>
<span class="gd">-                    GuestBodyResultProducer::Receiver(result_rx),</span>
<span class="gd">-                ),</span>
<span class="gd">-            ))</span>
<span class="gd">-        })</span>
<span class="gi">+        Ok((</span>
<span class="gi">+            res,</span>
<span class="gi">+            FutureReader::new(</span>
<span class="gi">+                instance,</span>
<span class="gi">+                &amp;mut store,</span>
<span class="gi">+                GuestBodyResultProducer::Receiver(result_rx),</span>
<span class="gi">+            ),</span>
<span class="gi">+        ))</span>
<span class="w"> </span>    }

<span class="w"> </span>    async fn consume_body&lt;T&gt;(
</code></pre></div>
<h3>Expected Results</h3>
<p>Success</p>
<h3>Actual Results</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">p3</span><span class="p">::</span><span class="n">p3_http_outbound_request_unsupported_scheme</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">rvolosatovs</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">bytecodealliance</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">crates</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">component</span><span class="o">/</span><span class="n">concurrent</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">255</span><span class="p">:</span><span class="mi">23</span><span class="p">:</span>
<span class="nc">called</span><span class="w"> </span><span class="err">`</span><span class="nb">Option</span><span class="p">::</span><span class="n">unwrap</span><span class="p">()</span><span class="err">`</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="err">`</span><span class="nb">None</span><span class="err">`</span><span class="w"> </span><span class="n">value</span>
</code></pre></div>
<h3>Extra Info</h3>
<p>This was introduced in #11628</p>
<p>cc @alexcrichton </p>
</blockquote>



<a name="538450372"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311651%20%60Access%3A%3Ainstance%60%20panics/near/538450372" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311651.20.60Access.3A.3Ainstance.60.20panics.html#538450372">(Sep 09 2025 at 14:22)</a>:</h4>
<p><a href="https://github.com/rvolosatovs">rvolosatovs</a> added the bug label to <a href="https://github.com/bytecodealliance/wasmtime/issues/11651">Issue #11651</a>.</p>



<a name="538461923"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311651%20%60Access%3A%3Ainstance%60%20panics/near/538461923" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311651.20.60Access.3A.3Ainstance.60.20panics.html#538461923">(Sep 09 2025 at 15:12)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/11651#issuecomment-3271171250">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11651">issue #11651</a>:</p>
<blockquote>
<p>This is currently an intentional design decision but it's based under the assumption that <a href="https://github.com/bytecodealliance/wasmtime/issues/11226">https://github.com/bytecodealliance/wasmtime/issues/11226</a> is going to be resolved which means that all the <code>Instance</code> parameters are going to go away. We planned on talking to Luke this Thursday about some various ramifications of this decision as it touches on component model semantics a bit, but after that the hope was to implement that and remove the <code>Instance</code> from <code>Accessor</code> too</p>
</blockquote>



<a name="538904635"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311651%20%60Access%3A%3Ainstance%60%20panics/near/538904635" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311651.20.60Access.3A.3Ainstance.60.20panics.html#538904635">(Sep 11 2025 at 16:40)</a>:</h4>
<p><a href="https://github.com/fitzgen">fitzgen</a> added the wasm-proposal:component-model-async label to <a href="https://github.com/bytecodealliance/wasmtime/issues/11651">Issue #11651</a>.</p>



<a name="539597576"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311651%20%60Access%3A%3Ainstance%60%20panics/near/539597576" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311651.20.60Access.3A.3Ainstance.60.20panics.html#539597576">(Sep 15 2025 at 16:01)</a>:</h4>
<p>alexcrichton assigned dicej to <a href="https://github.com/bytecodealliance/wasmtime/issues/11651">issue #11651</a>.</p>



<a name="543400906"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311651%20%60Access%3A%3Ainstance%60%20panics/near/543400906" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311651.20.60Access.3A.3Ainstance.60.20panics.html#543400906">(Oct 06 2025 at 20:16)</a>:</h4>
<p>dicej closed <a href="https://github.com/bytecodealliance/wasmtime/issues/11651">issue #11651</a>:</p>
<blockquote>
<h3>Test Case</h3>
<p>Use <code>store</code> option to bindgen without <code>async</code> or simply call <code>instance</code> on <code>Access</code> returned by <code>Access::new</code></p>
<h3>Steps to Reproduce</h3>
<p>apply the following diff to #11649 </p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gh">diff --git a/crates/wasi-http/src/p3/bindings.rs b/crates/wasi-http/src/p3/bindings.rs</span>
<span class="gh">index b7fec724c1..9f2bd8e9cf 100644</span>
<span class="gd">--- a/crates/wasi-http/src/p3/bindings.rs</span>
<span class="gi">+++ b/crates/wasi-http/src/p3/bindings.rs</span>
<span class="gu">@@ -11,8 +11,8 @@ mod generated {</span>
<span class="w"> </span>            "wasi:http/types/[drop]response": store | trappable | tracing,
<span class="w"> </span>            "wasi:http/types/[method]request.consume-body": async | store | trappable | tracing,
<span class="w"> </span>            "wasi:http/types/[method]response.consume-body": async | store | trappable | tracing,
<span class="gd">-            "wasi:http/types/[static]request.new": async | store | trappable | tracing,</span>
<span class="gd">-            "wasi:http/types/[static]response.new": async | store | trappable | tracing,</span>
<span class="gi">+            "wasi:http/types/[static]request.new": store | trappable | tracing,</span>
<span class="gi">+            "wasi:http/types/[static]response.new": store | trappable | tracing,</span>
<span class="w"> </span>            default: trappable | tracing,
<span class="w"> </span>        },
<span class="w"> </span>        exports: { default: async | store },
<span class="gh">diff --git a/crates/wasi-http/src/p3/host/types.rs b/crates/wasi-http/src/p3/host/types.rs</span>
<span class="gh">index 165e4e4e12..3d662da585 100644</span>
<span class="gd">--- a/crates/wasi-http/src/p3/host/types.rs</span>
<span class="gi">+++ b/crates/wasi-http/src/p3/host/types.rs</span>
<span class="gu">@@ -303,45 +303,43 @@ impl HostFields for WasiHttpCtxView&lt;'_&gt; {</span>
<span class="w"> </span>}

<span class="w"> </span>impl HostRequestWithStore for WasiHttp {
<span class="gd">-    async fn new&lt;T&gt;(</span>
<span class="gd">-        store: &amp;Accessor&lt;T, Self&gt;,</span>
<span class="gi">+    fn new&lt;T&gt;(</span>
<span class="gi">+        mut store: Access&lt;'_, T, Self&gt;,</span>
<span class="w"> </span>        headers: Resource&lt;Headers&gt;,
<span class="w"> </span>        contents: Option&lt;StreamReader&lt;u8&gt;&gt;,
<span class="w"> </span>        trailers: FutureReader&lt;Result&lt;Option&lt;Resource&lt;Trailers&gt;&gt;, ErrorCode&gt;&gt;,
<span class="w"> </span>        options: Option&lt;Resource&lt;RequestOptions&gt;&gt;,
<span class="w"> </span>    ) -&gt; wasmtime::Result&lt;(Resource&lt;Request&gt;, FutureReader&lt;Result&lt;(), ErrorCode&gt;&gt;)&gt; {
<span class="gi">+        let WasiHttpCtxView { table, .. } = store.get();</span>
<span class="gi">+        let headers = delete_fields(table, headers)?;</span>
<span class="gi">+        let options = options</span>
<span class="gi">+            .map(|options| delete_request_options(table, options))</span>
<span class="gi">+            .transpose()?;</span>
<span class="gi">+        let (result_tx, result_rx) = oneshot::channel();</span>
<span class="gi">+        let body = Body::Guest {</span>
<span class="gi">+            contents_rx: contents,</span>
<span class="gi">+            trailers_rx: trailers,</span>
<span class="gi">+            result_tx,</span>
<span class="gi">+        };</span>
<span class="gi">+        let req = Request {</span>
<span class="gi">+            method: http::Method::GET,</span>
<span class="gi">+            scheme: None,</span>
<span class="gi">+            authority: None,</span>
<span class="gi">+            path_with_query: None,</span>
<span class="gi">+            headers: headers.into(),</span>
<span class="gi">+            options: options.map(Into::into),</span>
<span class="gi">+            body,</span>
<span class="gi">+        };</span>
<span class="gi">+        let req = table.push(req).context("failed to push request to table")?;</span>
<span class="w"> </span>        let instance = store.instance();
<span class="gd">-        store.with(|mut store| {</span>
<span class="gd">-            let (result_tx, result_rx) = oneshot::channel();</span>
<span class="gd">-            let WasiHttpCtxView { table, .. } = store.get();</span>
<span class="gd">-            let headers = delete_fields(table, headers)?;</span>
<span class="gd">-            let options = options</span>
<span class="gd">-                .map(|options| delete_request_options(table, options))</span>
<span class="gd">-                .transpose()?;</span>
<span class="gd">-            let body = Body::Guest {</span>
<span class="gd">-                contents_rx: contents,</span>
<span class="gd">-                trailers_rx: trailers,</span>
<span class="gd">-                result_tx,</span>
<span class="gd">-            };</span>
<span class="gd">-            let req = Request {</span>
<span class="gd">-                method: http::Method::GET,</span>
<span class="gd">-                scheme: None,</span>
<span class="gd">-                authority: None,</span>
<span class="gd">-                path_with_query: None,</span>
<span class="gd">-                headers: headers.into(),</span>
<span class="gd">-                options: options.map(Into::into),</span>
<span class="gd">-                body,</span>
<span class="gd">-            };</span>
<span class="gd">-            let req = table.push(req).context("failed to push request to table")?;</span>
<span class="gd">-            Ok((</span>
<span class="gd">-                req,</span>
<span class="gd">-                FutureReader::new(</span>
<span class="gd">-                    instance,</span>
<span class="gd">-                    &amp;mut store,</span>
<span class="gd">-                    GuestBodyResultProducer::Receiver(result_rx),</span>
<span class="gd">-                ),</span>
<span class="gd">-            ))</span>
<span class="gd">-        })</span>
<span class="gi">+        Ok((</span>
<span class="gi">+            req,</span>
<span class="gi">+            FutureReader::new(</span>
<span class="gi">+                instance,</span>
<span class="gi">+                &amp;mut store,</span>
<span class="gi">+                GuestBodyResultProducer::Receiver(result_rx),</span>
<span class="gi">+            ),</span>
<span class="gi">+        ))</span>
<span class="w"> </span>    }

<span class="w"> </span>    async fn consume_body&lt;T&gt;(
<span class="gu">@@ -586,39 +584,37 @@ impl HostRequestOptions for WasiHttpCtxView&lt;'_&gt; {</span>
<span class="w"> </span>}

<span class="w"> </span>impl HostResponseWithStore for WasiHttp {
<span class="gd">-    async fn new&lt;T&gt;(</span>
<span class="gd">-        store: &amp;Accessor&lt;T, Self&gt;,</span>
<span class="gi">+    fn new&lt;T&gt;(</span>
<span class="gi">+        mut store: Access&lt;'_, T, Self&gt;,</span>
<span class="w"> </span>        headers: Resource&lt;Headers&gt;,
<span class="w"> </span>        contents: Option&lt;StreamReader&lt;u8&gt;&gt;,
<span class="w"> </span>        trailers: FutureReader&lt;Result&lt;Option&lt;Resource&lt;Trailers&gt;&gt;, ErrorCode&gt;&gt;,
<span class="w"> </span>    ) -&gt; wasmtime::Result&lt;(Resource&lt;Response&gt;, FutureReader&lt;Result&lt;(), ErrorCode&gt;&gt;)&gt; {
<span class="gi">+        let WasiHttpCtxView { table, .. } = store.get();</span>
<span class="gi">+        let headers = delete_fields(table, headers)?;</span>
<span class="gi">+        let (result_tx, result_rx) = oneshot::channel();</span>
<span class="gi">+        let body = Body::Guest {</span>
<span class="gi">+            contents_rx: contents,</span>
<span class="gi">+            trailers_rx: trailers,</span>
<span class="gi">+            result_tx,</span>
<span class="gi">+        };</span>
<span class="gi">+        let res = Response {</span>
<span class="gi">+            status: http::StatusCode::OK,</span>
<span class="gi">+            headers: headers.into(),</span>
<span class="gi">+            body,</span>
<span class="gi">+        };</span>
<span class="gi">+        let res = table</span>
<span class="gi">+            .push(res)</span>
<span class="gi">+            .context("failed to push response to table")?;</span>
<span class="w"> </span>        let instance = store.instance();
<span class="gd">-        store.with(|mut store| {</span>
<span class="gd">-            let (result_tx, result_rx) = oneshot::channel();</span>
<span class="gd">-            let WasiHttpCtxView { table, .. } = store.get();</span>
<span class="gd">-            let headers = delete_fields(table, headers)?;</span>
<span class="gd">-            let body = Body::Guest {</span>
<span class="gd">-                contents_rx: contents,</span>
<span class="gd">-                trailers_rx: trailers,</span>
<span class="gd">-                result_tx,</span>
<span class="gd">-            };</span>
<span class="gd">-            let res = Response {</span>
<span class="gd">-                status: http::StatusCode::OK,</span>
<span class="gd">-                headers: headers.into(),</span>
<span class="gd">-                body,</span>
<span class="gd">-            };</span>
<span class="gd">-            let res = table</span>
<span class="gd">-                .push(res)</span>
<span class="gd">-                .context("failed to push response to table")?;</span>
<span class="gd">-            Ok((</span>
<span class="gd">-                res,</span>
<span class="gd">-                FutureReader::new(</span>
<span class="gd">-                    instance,</span>
<span class="gd">-                    &amp;mut store,</span>
<span class="gd">-                    GuestBodyResultProducer::Receiver(result_rx),</span>
<span class="gd">-                ),</span>
<span class="gd">-            ))</span>
<span class="gd">-        })</span>
<span class="gi">+        Ok((</span>
<span class="gi">+            res,</span>
<span class="gi">+            FutureReader::new(</span>
<span class="gi">+                instance,</span>
<span class="gi">+                &amp;mut store,</span>
<span class="gi">+                GuestBodyResultProducer::Receiver(result_rx),</span>
<span class="gi">+            ),</span>
<span class="gi">+        ))</span>
<span class="w"> </span>    }

<span class="w"> </span>    async fn consume_body&lt;T&gt;(
</code></pre></div>
<h3>Expected Results</h3>
<p>Success</p>
<h3>Actual Results</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">p3</span><span class="p">::</span><span class="n">p3_http_outbound_request_unsupported_scheme</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">rvolosatovs</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">github</span><span class="p">.</span><span class="n">com</span><span class="o">/</span><span class="n">bytecodealliance</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">crates</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runtime</span><span class="o">/</span><span class="n">component</span><span class="o">/</span><span class="n">concurrent</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">255</span><span class="p">:</span><span class="mi">23</span><span class="p">:</span>
<span class="nc">called</span><span class="w"> </span><span class="err">`</span><span class="nb">Option</span><span class="p">::</span><span class="n">unwrap</span><span class="p">()</span><span class="err">`</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="err">`</span><span class="nb">None</span><span class="err">`</span><span class="w"> </span><span class="n">value</span>
</code></pre></div>
<h3>Extra Info</h3>
<p>This was introduced in #11628</p>
<p>cc @alexcrichton </p>
</blockquote>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
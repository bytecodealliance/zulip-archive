<html>
<head><meta charset="utf-8"><title>wasmtime / PR #11418 Fix the bug of QEMU command in the c... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311418.20Fix.20the.20bug.20of.20QEMU.20command.20in.20the.20c.2E.2E.2E.html">wasmtime / PR #11418 Fix the bug of QEMU command in the c...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="534475890"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311418%20Fix%20the%20bug%20of%20QEMU%20command%20in%20the%20c.../near/534475890" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311418.20Fix.20the.20bug.20of.20QEMU.20command.20in.20the.20c.2E.2E.2E.html#534475890">(Aug 14 2025 at 12:46)</a>:</h4>
<p>yomaytk edited <a href="https://github.com/bytecodealliance/wasmtime/pull/11418">PR #11418</a>.</p>



<a name="534479728"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311418%20Fix%20the%20bug%20of%20QEMU%20command%20in%20the%20c.../near/534479728" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311418.20Fix.20the.20bug.20of.20QEMU.20command.20in.20the.20c.2E.2E.2E.html#534479728">(Aug 14 2025 at 13:06)</a>:</h4>
<p>yomaytk <a href="https://github.com/bytecodealliance/wasmtime/pull/11418#issuecomment-3188390616">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11418">PR #11418</a>:</p>
<blockquote>
<p>Thank you for the detailed analysis—I understand.<br>
As you suggested, exporting CARGO_TARGET_*_RUNNER resolves the issue, so I’ve updated the code in that way.</p>
<blockquote>
<p>but that's a bit of a bummer.</p>
</blockquote>
<p>Do you mean that it’s not ideal for .cargo/config.toml to depend on <code>CARGO_TARGET_*_RUNNER</code>?<br>
<code>CARGO_TARGET_*_RUNNER</code> looks like a variable that’s intended to be used only in CI.</p>
</blockquote>



<a name="534479813"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311418%20Fix%20the%20bug%20of%20QEMU%20command%20in%20the%20c.../near/534479813" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311418.20Fix.20the.20bug.20of.20QEMU.20command.20in.20the.20c.2E.2E.2E.html#534479813">(Aug 14 2025 at 13:07)</a>:</h4>
<p>yomaytk edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/11418#issuecomment-3188390616">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11418">PR #11418</a>:</p>
<blockquote>
<p>Thank you for the detailed analysis—I understand.<br>
As you suggested, exporting <code>CARGO_TARGET_*_RUNNER</code> resolves the issue, so I’ve updated the code in that way.</p>
<blockquote>
<p>but that's a bit of a bummer.</p>
</blockquote>
<p>Do you mean that it’s not ideal for .cargo/config.toml to depend on <code>CARGO_TARGET_*_RUNNER</code>?<br>
<code>CARGO_TARGET_*_RUNNER</code> looks like a variable that’s intended to be used only in CI.</p>
</blockquote>



<a name="534515731"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311418%20Fix%20the%20bug%20of%20QEMU%20command%20in%20the%20c.../near/534515731" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311418.20Fix.20the.20bug.20of.20QEMU.20command.20in.20the.20c.2E.2E.2E.html#534515731">(Aug 14 2025 at 16:16)</a>:</h4>
<p>yomaytk edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/11418#issuecomment-3188390616">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11418">PR #11418</a>:</p>
<blockquote>
<p>Thank you for the detailed analysis—I understand.<br>
As you suggested, exporting <code>CARGO_TARGET_*_RUNNER</code> resolves the issue, so I’ve updated the code in that way. Could your review again?</p>
<blockquote>
<p>but that's a bit of a bummer.</p>
</blockquote>
<p>Do you mean that it’s not ideal for .cargo/config.toml to depend on <code>CARGO_TARGET_*_RUNNER</code>?<br>
<code>CARGO_TARGET_*_RUNNER</code> looks like a variable that’s intended to be used only in CI.</p>
</blockquote>



<a name="534563353"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311418%20Fix%20the%20bug%20of%20QEMU%20command%20in%20the%20c.../near/534563353" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311418.20Fix.20the.20bug.20of.20QEMU.20command.20in.20the.20c.2E.2E.2E.html#534563353">(Aug 14 2025 at 21:31)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/11418#issuecomment-3189926175">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11418">PR #11418</a>:</p>
<blockquote>
<p>Would you mind updating this to recommend setting the env vars directly instead of <code>.cargo/config.toml</code>? That way <code>test-util/src/lib.rs</code> wouldn't need modifications or need to encode system-specific paths like it's currently doing.</p>
<p>Ah by "bummer" I mean that requiring env vars is not fun since they're not shared by shells by default (unlike <code>.cargo/config.toml</code>). What you've got here is a bit of a quine-like situation where you want to specify a runner that specifies env vars to specify the runner which would need to specify env vars which ... (so on and so forth). What this really just wants is the env var to be inherited, or some way for the test itself to learn the runner configuration from Cargo's config, but only the former is possible.</p>
</blockquote>



<a name="534604664"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311418%20Fix%20the%20bug%20of%20QEMU%20command%20in%20the%20c.../near/534604664" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311418.20Fix.20the.20bug.20of.20QEMU.20command.20in.20the.20c.2E.2E.2E.html#534604664">(Aug 15 2025 at 06:27)</a>:</h4>
<p>yomaytk <a href="https://github.com/bytecodealliance/wasmtime/pull/11418#issuecomment-3190755972">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11418">PR #11418</a>:</p>
<blockquote>
<p>Thanks! Exporting <code>CARGO_*_RUNNER</code> is simple and requires no code changes. However, the current <a href="https://github.com/bytecodealliance/wasmtime/blob/f206a3ecc6f1245f94e8ce522f424f654e45fd87/crates/test-util/src/lib.rs#L13-L21"><code>cargo_test_runner</code></a> is implemented to use the first runner in the iterator, so when we want to run tests against multiple targets, we have to unset all non-target <code>CARGO_*_RUNNER</code> variables each time. Then, I’m considering two approaches:</p>
<ol>
<li>
<p>Introduce an architecture-agnostic <code>CARGO_TARGET_RUNNER</code>, and set it each time we switch targets as follows.<br>
<code>$ export CARGO_TARGET_RUNNER='qemu-aarch64 -L /usr/aarch64-linux-gnu -E LD_LIBRARY_PATH=/usr/aarch64-linux-gnu/lib -E WASMTIME_TEST_NO_HOG_MEMORY=1'</code>.</p>
</li>
<li>
<p>Specify each <code>CARGO_*_RUNNER</code> in <code>.cargo/config.toml</code> under the <code>[env]</code> section. Introduce <code>CARGO_TARGET_ARCH</code>, and fix <code>cargo_test_runner</code> to filter by the environment variable (as below). Then run tests like:<br>
<code>$ CARGO_TARGET_ARCH=aarch64 cargo test --target aarch64-unknown-linux-gnu</code>.</p>
</li>
</ol>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">cargo_test_runner</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Option</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Note that this technically should look for the current target as well</span>
<span class="w">    </span><span class="c1">// instead of picking "any runner", but that's left for a future</span>
<span class="w">    </span><span class="c1">// refactoring.</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">runner</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">env</span><span class="p">::</span><span class="n">vars</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">filter</span><span class="p">(</span><span class="o">|</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">_v</span><span class="p">)</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">k</span><span class="p">.</span><span class="n">starts_with</span><span class="p">(</span><span class="s">"CARGO_TARGET"</span><span class="p">)</span>
<span class="w">                </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">k</span><span class="p">.</span><span class="n">ends_with</span><span class="p">(</span><span class="s">"RUNNER"</span><span class="p">)</span>
<span class="w">                </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">k</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span>
<span class="w">                    </span><span class="o">&amp;</span><span class="n">std</span><span class="p">::</span><span class="n">env</span><span class="p">::</span><span class="n">var</span><span class="p">(</span><span class="s">"CARGO_TARGET_ARCH"</span><span class="p">)</span>
<span class="w">                        </span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">target_arch</span><span class="o">|</span><span class="w"> </span><span class="n">target_arch</span><span class="p">.</span><span class="n">to_uppercase</span><span class="p">())</span>
<span class="w">                        </span><span class="p">.</span><span class="n">unwrap_or_else</span><span class="p">(</span><span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="w"> </span><span class="s">""</span><span class="p">.</span><span class="n">to_string</span><span class="p">()),</span>
<span class="w">                </span><span class="p">)</span>
<span class="w">        </span><span class="p">})</span>
<span class="w">        </span><span class="p">.</span><span class="n">next</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="nb">Some</span><span class="p">(</span><span class="n">runner</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<p>Alternatively, there may be a better approach. I’d appreciate your thoughts.</p>
</blockquote>



<a name="534605947"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311418%20Fix%20the%20bug%20of%20QEMU%20command%20in%20the%20c.../near/534605947" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311418.20Fix.20the.20bug.20of.20QEMU.20command.20in.20the.20c.2E.2E.2E.html#534605947">(Aug 15 2025 at 06:42)</a>:</h4>
<p>yomaytk deleted a <a href="https://github.com/bytecodealliance/wasmtime/pull/11418#issuecomment-3190755972">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11418">PR #11418</a>:</p>
<blockquote>
<p>Thanks! Exporting <code>CARGO_*_RUNNER</code> is simple and requires no code changes. However, the current <a href="https://github.com/bytecodealliance/wasmtime/blob/f206a3ecc6f1245f94e8ce522f424f654e45fd87/crates/test-util/src/lib.rs#L13-L21"><code>cargo_test_runner</code></a> is implemented to use the first runner in the iterator, so when we want to run tests against multiple targets, we have to unset all non-target <code>CARGO_*_RUNNER</code> variables each time. Then, I’m considering two approaches:</p>
<ol>
<li>
<p>Introduce an architecture-agnostic <code>CARGO_TARGET_RUNNER</code>, and set it each time we switch targets as follows.<br>
<code>$ export CARGO_TARGET_RUNNER='qemu-aarch64 -L /usr/aarch64-linux-gnu -E LD_LIBRARY_PATH=/usr/aarch64-linux-gnu/lib -E WASMTIME_TEST_NO_HOG_MEMORY=1'</code>.</p>
</li>
<li>
<p>Specify each <code>CARGO_*_RUNNER</code> in <code>.cargo/config.toml</code> under the <code>[env]</code> section. Introduce <code>CARGO_TARGET_ARCH</code>, and fix <code>cargo_test_runner</code> to filter by the environment variable (as below). Then run tests like:<br>
<code>$ CARGO_TARGET_ARCH=aarch64 cargo test --target aarch64-unknown-linux-gnu</code>.</p>
</li>
</ol>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">cargo_test_runner</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Option</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Note that this technically should look for the current target as well</span>
<span class="w">    </span><span class="c1">// instead of picking "any runner", but that's left for a future</span>
<span class="w">    </span><span class="c1">// refactoring.</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">runner</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">env</span><span class="p">::</span><span class="n">vars</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">filter</span><span class="p">(</span><span class="o">|</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">_v</span><span class="p">)</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">k</span><span class="p">.</span><span class="n">starts_with</span><span class="p">(</span><span class="s">"CARGO_TARGET"</span><span class="p">)</span>
<span class="w">                </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">k</span><span class="p">.</span><span class="n">ends_with</span><span class="p">(</span><span class="s">"RUNNER"</span><span class="p">)</span>
<span class="w">                </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">k</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span>
<span class="w">                    </span><span class="o">&amp;</span><span class="n">std</span><span class="p">::</span><span class="n">env</span><span class="p">::</span><span class="n">var</span><span class="p">(</span><span class="s">"CARGO_TARGET_ARCH"</span><span class="p">)</span>
<span class="w">                        </span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">target_arch</span><span class="o">|</span><span class="w"> </span><span class="n">target_arch</span><span class="p">.</span><span class="n">to_uppercase</span><span class="p">())</span>
<span class="w">                        </span><span class="p">.</span><span class="n">unwrap_or_else</span><span class="p">(</span><span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="w"> </span><span class="s">""</span><span class="p">.</span><span class="n">to_string</span><span class="p">()),</span>
<span class="w">                </span><span class="p">)</span>
<span class="w">        </span><span class="p">})</span>
<span class="w">        </span><span class="p">.</span><span class="n">next</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="nb">Some</span><span class="p">(</span><span class="n">runner</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>
<p>Alternatively, there may be a better approach. I’d appreciate your thoughts.</p>
</blockquote>



<a name="534611628"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311418%20Fix%20the%20bug%20of%20QEMU%20command%20in%20the%20c.../near/534611628" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311418.20Fix.20the.20bug.20of.20QEMU.20command.20in.20the.20c.2E.2E.2E.html#534611628">(Aug 15 2025 at 07:41)</a>:</h4>
<p>yomaytk updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11418">PR #11418</a>.</p>



<a name="534611844"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311418%20Fix%20the%20bug%20of%20QEMU%20command%20in%20the%20c.../near/534611844" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311418.20Fix.20the.20bug.20of.20QEMU.20command.20in.20the.20c.2E.2E.2E.html#534611844">(Aug 15 2025 at 07:43)</a>:</h4>
<p>yomaytk updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11418">PR #11418</a>.</p>



<a name="534614127"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311418%20Fix%20the%20bug%20of%20QEMU%20command%20in%20the%20c.../near/534614127" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311418.20Fix.20the.20bug.20of.20QEMU.20command.20in.20the.20c.2E.2E.2E.html#534614127">(Aug 15 2025 at 08:01)</a>:</h4>
<p>yomaytk <a href="https://github.com/bytecodealliance/wasmtime/pull/11418#issuecomment-3190888755">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11418">PR #11418</a>:</p>
<blockquote>
<p>Thanks! Exporting <code>CARGO_*_RUNNER</code> is simple and requires no code changes. However, since the current <code>cargo_test_runner</code> is implemented to use the first runner in the iterator, when we want to run tests for multiple targets, we have to unset all non-target <code>CARGO_*_RUNNER</code> variables each time. Then, I’m considering two approaches:</p>
<ol>
<li>
<p>Introduce an architecture-agnostic <code>CARGO_TARGET_RUNNER</code> and set it each time we switch targets.:<br>
<code>$ export CARGO_TARGET_RUNNER=‘qemu-aarch64 -L /usr/aarch64-linux-gnu -E LD_LIBRARY_PATH=/usr/aarch64-linux-gnu/lib -E WASMTIME_TEST_NO_HOG_MEMORY=1’</code>.</p>
</li>
<li>
<p>Introduce <code>CARGO_TARGET_ARCH</code> representing the target, and fix <code>cargo_test_runner</code> to detect the appropriate runner based on this environment variable. Run tests like:<br>
<code>$ CARGO_TARGET_ARCH=aarch64 cargo test --target aarch64-unknown-linux-gnu.</code></p>
</li>
</ol>
<p>For reference, the latest changes in this PR implement the second approach.</p>
<p>There may be a better method; I’d appreciate your thoughts.</p>
</blockquote>



<a name="534614723"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311418%20Fix%20the%20bug%20of%20QEMU%20command%20in%20the%20c.../near/534614723" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311418.20Fix.20the.20bug.20of.20QEMU.20command.20in.20the.20c.2E.2E.2E.html#534614723">(Aug 15 2025 at 08:06)</a>:</h4>
<p>yomaytk edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/11418#issuecomment-3190888755">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11418">PR #11418</a>:</p>
<blockquote>
<p>Thanks! Exporting <code>CARGO_*_RUNNER</code> is simple and requires no code changes. However, since the current <code>cargo_test_runner</code> is implemented to use the first runner in the iterator, when we want to run tests for multiple targets, we have to unset all non-target <code>CARGO_*_RUNNER</code> variables each time. Then, I’m considering two approaches:</p>
<ol>
<li>
<p>Introduce an architecture-agnostic <code>CARGO_TARGET_RUNNER</code> and set it each time we switch targets.:<br>
<code>$ export CARGO_TARGET_RUNNER=‘qemu-aarch64 -L /usr/aarch64-linux-gnu -E LD_LIBRARY_PATH=/usr/aarch64-linux-gnu/lib -E WASMTIME_TEST_NO_HOG_MEMORY=1’</code>.</p>
</li>
<li>
<p>Introduce <code>CARGO_TARGET_ARCH</code> representing the target, and fix <code>cargo_test_runner</code> to detect the appropriate runner based on this environment variable. Run tests like:<br>
<code>$ CARGO_TARGET_ARCH=aarch64 cargo test --target aarch64-unknown-linux-gnu</code>.</p>
</li>
</ol>
<p>For reference, the latest changes in this PR implement the second approach.</p>
<p>There may be a better method; I’d appreciate your thoughts.</p>
</blockquote>



<a name="534620520"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311418%20Fix%20the%20bug%20of%20QEMU%20command%20in%20the%20c.../near/534620520" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311418.20Fix.20the.20bug.20of.20QEMU.20command.20in.20the.20c.2E.2E.2E.html#534620520">(Aug 15 2025 at 08:54)</a>:</h4>
<p>yomaytk updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11418">PR #11418</a>.</p>



<a name="534620586"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311418%20Fix%20the%20bug%20of%20QEMU%20command%20in%20the%20c.../near/534620586" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311418.20Fix.20the.20bug.20of.20QEMU.20command.20in.20the.20c.2E.2E.2E.html#534620586">(Aug 15 2025 at 08:54)</a>:</h4>
<p>yomaytk edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/11418#issuecomment-3190888755">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11418">PR #11418</a>:</p>
<blockquote>
<p>Thanks! Exporting <code>CARGO_*_RUNNER</code> is simple and requires no code changes. However, since the current <code>cargo_test_runner</code> is implemented to use the first runner in the iterator, when we want to run tests for multiple targets, we have to unset all non-target <code>CARGO_*_RUNNER</code> variables each time. Then, I’m considering two approaches:</p>
<ol>
<li>
<p>Introduce an architecture-agnostic <code>CARGO_TARGET_RUNNER</code> and set it each time we switch targets.:<br>
<code>$ export CARGO_TARGET_RUNNER=‘qemu-aarch64 -L /usr/aarch64-linux-gnu -E LD_LIBRARY_PATH=/usr/aarch64-linux-gnu/lib -E WASMTIME_TEST_NO_HOG_MEMORY=1’</code>.</p>
</li>
<li>
<p>Introduce <code>CARGO_LOCAL_TARGET_ARCH</code> representing the target, and fix <code>cargo_test_runner</code> to detect the appropriate runner based on this environment variable. Run tests like:<br>
<code>$ CARGO_LOCAL_TARGET_ARCH=aarch64 cargo test --target aarch64-unknown-linux-gnu</code>.</p>
</li>
</ol>
<p>For reference, the latest changes in this PR implement the second approach.</p>
<p>There may be a better method; I’d appreciate your thoughts.</p>
</blockquote>



<a name="534635703"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311418%20Fix%20the%20bug%20of%20QEMU%20command%20in%20the%20c.../near/534635703" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311418.20Fix.20the.20bug.20of.20QEMU.20command.20in.20the.20c.2E.2E.2E.html#534635703">(Aug 15 2025 at 11:07)</a>:</h4>
<p>yomaytk deleted a <a href="https://github.com/bytecodealliance/wasmtime/pull/11418#issuecomment-3190888755">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11418">PR #11418</a>:</p>
<blockquote>
<p>Thanks! Exporting <code>CARGO_*_RUNNER</code> is simple and requires no code changes. However, since the current <code>cargo_test_runner</code> is implemented to use the first runner in the iterator, when we want to run tests for multiple targets, we have to unset all non-target <code>CARGO_*_RUNNER</code> variables each time. Then, I’m considering two approaches:</p>
<ol>
<li>
<p>Introduce an architecture-agnostic <code>CARGO_TARGET_RUNNER</code> and set it each time we switch targets.:<br>
<code>$ export CARGO_TARGET_RUNNER=‘qemu-aarch64 -L /usr/aarch64-linux-gnu -E LD_LIBRARY_PATH=/usr/aarch64-linux-gnu/lib -E WASMTIME_TEST_NO_HOG_MEMORY=1’</code>.</p>
</li>
<li>
<p>Introduce <code>CARGO_LOCAL_TARGET_ARCH</code> representing the target, and fix <code>cargo_test_runner</code> to detect the appropriate runner based on this environment variable. Run tests like:<br>
<code>$ CARGO_LOCAL_TARGET_ARCH=aarch64 cargo test --target aarch64-unknown-linux-gnu</code>.</p>
</li>
</ol>
<p>For reference, the latest changes in this PR implement the second approach.</p>
<p>There may be a better method; I’d appreciate your thoughts.</p>
</blockquote>



<a name="534656769"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311418%20Fix%20the%20bug%20of%20QEMU%20command%20in%20the%20c.../near/534656769" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311418.20Fix.20the.20bug.20of.20QEMU.20command.20in.20the.20c.2E.2E.2E.html#534656769">(Aug 15 2025 at 13:51)</a>:</h4>
<p>yomaytk updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11418">PR #11418</a>.</p>



<a name="534657096"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311418%20Fix%20the%20bug%20of%20QEMU%20command%20in%20the%20c.../near/534657096" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311418.20Fix.20the.20bug.20of.20QEMU.20command.20in.20the.20c.2E.2E.2E.html#534657096">(Aug 15 2025 at 13:53)</a>:</h4>
<p>yomaytk updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11418">PR #11418</a>.</p>



<a name="534659959"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311418%20Fix%20the%20bug%20of%20QEMU%20command%20in%20the%20c.../near/534659959" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311418.20Fix.20the.20bug.20of.20QEMU.20command.20in.20the.20c.2E.2E.2E.html#534659959">(Aug 15 2025 at 14:11)</a>:</h4>
<p>yomaytk <a href="https://github.com/bytecodealliance/wasmtime/pull/11418#issuecomment-3191598320">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11418">PR #11418</a>:</p>
<blockquote>
<p>Thanks! Exporting <code>CARGO_*_RUNNER</code> is simple and requires no code changes. However, since the current <code>cargo_test_runner</code> is implemented to use the first runner in the iterator, when we want to run tests for multiple targets, we have to unset all non-target <code>CARGO_*_RUNNER</code> variables each time. Then, I’m considering the following approaches:</p>
<ul>
<li>Introduce <code>CARGO_TARGET_ARCH</code> representing the target, allowing <code>cargo_test_runner</code> to detect the appropriate runner. The same variable will also be defined in CI. Run local tests like:<br>
<code>$ CARGO_TARGET_ARCH=aarch64 cargo test --target aarch64-unknown-linux-gnu</code>.</li>
</ul>
<p>The latest changes in this PR implement this approach.</p>
<p>There may be a better method; I’d appreciate your thoughts.</p>
</blockquote>



<a name="534695082"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311418%20Fix%20the%20bug%20of%20QEMU%20command%20in%20the%20c.../near/534695082" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311418.20Fix.20the.20bug.20of.20QEMU.20command.20in.20the.20c.2E.2E.2E.html#534695082">(Aug 15 2025 at 18:29)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/11418#issuecomment-3192383727">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11418">PR #11418</a>:</p>
<blockquote>
<p>Thanks for your work here, and I'm sorry if this is taking longer than expected. This is unfortunately a bit of a minefield where there's bugs that can't be fixed and I also have personal preferences about how we document and structure this. I also ideally want to have minimal impact on various bits of infrastructure since this is a relatively niche thing that shouldn't haev an outside impact. </p>
<p>This PR as-is adds a new required environment variable that's required to be specified to run tests in QEMU. Additionally it specifies configuration which is redundant in <code>.cargo/config.toml</code> where there's non-obvious overlap and surprising behavior.</p>
<p>If you're interested in seeing this PR all the way through, I'd recommend a possible change of removing the <code>.cargo/config.toml</code> configuration entirely and documenting only the <code>CARGO_*_RUNNER</code> env vars with an example of how to do one. Personally I think that would be sufficient for now and it's not super pressing to get the tests to a working state where you can set all the env vars for all the targets and run tests all at once for many targets.</p>
<p>If you'd like to get the multi-target approach working I'd recommend using <code>cfg(target_arch = "...")</code> instead of a new environment variable to figure out which one to filter for and look for.</p>
<p>Orthogonally to this PR, another option is to skip tests that use <code>Command</code> by default in cross-compiled situations. That way CI could opt-in to running these tests but others running <code>cargo test</code> could use the preexisting <code>.cargo/config.toml</code> configuration and it would work as expected.</p>
<hr>
<p>Basically I want to avoid redundant configuration, hardcoding system-specifics in the repo, or adding undue burden on infrastructure for running these tests. It's unfortunately not easy to balance all these concerns though.</p>
</blockquote>



<a name="534741167"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311418%20Fix%20the%20bug%20of%20QEMU%20command%20in%20the%20c.../near/534741167" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311418.20Fix.20the.20bug.20of.20QEMU.20command.20in.20the.20c.2E.2E.2E.html#534741167">(Aug 16 2025 at 05:56)</a>:</h4>
<p>yomaytk <a href="https://github.com/bytecodealliance/wasmtime/pull/11418#issuecomment-3193420390">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11418">PR #11418</a>:</p>
<blockquote>
<p>Ah, I see—thank you for the detailed explanation. I understand that the proposed feature is niche and that it wouldn’t be good to place a burden on the infrastructure. Then, I’ll update this PR to document how to set <code>CARGO_*_RUNNER</code>.</p>
<blockquote>
<p>documenting only the CARGO_*_RUNNER env vars</p>
</blockquote>
<p>Just to confirm, do we also need to document <code>CARGO_*_LINKER</code>?</p>
</blockquote>



<a name="534974899"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311418%20Fix%20the%20bug%20of%20QEMU%20command%20in%20the%20c.../near/534974899" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311418.20Fix.20the.20bug.20of.20QEMU.20command.20in.20the.20c.2E.2E.2E.html#534974899">(Aug 18 2025 at 15:26)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/11418#issuecomment-3197392889">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11418">PR #11418</a>:</p>
<blockquote>
<p>The linker bits don't <em>need</em> to be in env vars, but they do need to be specified somewhere. If the runner is in an env var I think it'd make sense to follow suit and use that for the linker too (no need to document two similar-and-related configuration systems here)</p>
</blockquote>



<a name="534992474"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311418%20Fix%20the%20bug%20of%20QEMU%20command%20in%20the%20c.../near/534992474" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311418.20Fix.20the.20bug.20of.20QEMU.20command.20in.20the.20c.2E.2E.2E.html#534992474">(Aug 18 2025 at 17:20)</a>:</h4>
<p>yomaytk updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11418">PR #11418</a>.</p>



<a name="534993661"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311418%20Fix%20the%20bug%20of%20QEMU%20command%20in%20the%20c.../near/534993661" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311418.20Fix.20the.20bug.20of.20QEMU.20command.20in.20the.20c.2E.2E.2E.html#534993661">(Aug 18 2025 at 17:30)</a>:</h4>
<p>yomaytk <a href="https://github.com/bytecodealliance/wasmtime/pull/11418#issuecomment-3197818156">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11418">PR #11418</a>:</p>
<blockquote>
<p>Got it. I’ve updated the PR—could you review it again?</p>
</blockquote>



<a name="534993925"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311418%20Fix%20the%20bug%20of%20QEMU%20command%20in%20the%20c.../near/534993925" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311418.20Fix.20the.20bug.20of.20QEMU.20command.20in.20the.20c.2E.2E.2E.html#534993925">(Aug 18 2025 at 17:32)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11418#pullrequestreview-3129291771">PR review</a>:</p>
<blockquote>
<p>Thanks!</p>
</blockquote>



<a name="534993937"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311418%20Fix%20the%20bug%20of%20QEMU%20command%20in%20the%20c.../near/534993937" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311418.20Fix.20the.20bug.20of.20QEMU.20command.20in.20the.20c.2E.2E.2E.html#534993937">(Aug 18 2025 at 17:32)</a>:</h4>
<p>alexcrichton has enabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/11418">PR #11418</a>.</p>



<a name="534996766"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311418%20Fix%20the%20bug%20of%20QEMU%20command%20in%20the%20c.../near/534996766" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311418.20Fix.20the.20bug.20of.20QEMU.20command.20in.20the.20c.2E.2E.2E.html#534996766">(Aug 18 2025 at 17:54)</a>:</h4>
<p>alexcrichton merged <a href="https://github.com/bytecodealliance/wasmtime/pull/11418">PR #11418</a>.</p>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
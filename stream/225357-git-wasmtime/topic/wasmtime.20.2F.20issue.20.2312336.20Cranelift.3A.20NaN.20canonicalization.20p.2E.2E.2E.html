<html>
<head><meta charset="utf-8"><title>wasmtime / issue #12336 Cranelift: NaN canonicalization p... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312336.20Cranelift.3A.20NaN.20canonicalization.20p.2E.2E.2E.html">wasmtime / issue #12336 Cranelift: NaN canonicalization p...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="567867809"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312336%20Cranelift%3A%20NaN%20canonicalization%20p.../near/567867809" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312336.20Cranelift.3A.20NaN.20canonicalization.20p.2E.2E.2E.html#567867809">(Jan 13 2026 at 22:09)</a>:</h4>
<p>zzjas opened <a href="https://github.com/bytecodealliance/wasmtime/issues/12336">issue #12336</a>:</p>
<blockquote>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">test</span><span class="w"> </span><span class="n">compile</span>
<span class="n">set</span><span class="w"> </span><span class="n">enable_nan_canonicalization</span><span class="o">=</span><span class="kc">true</span>
<span class="n">target</span><span class="w"> </span><span class="n">s390x</span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">fadd_f128</span><span class="p">(</span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">f128</span><span class="p">,</span><span class="w"> </span><span class="n">f128</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span><span class="p">:</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="p">:</span><span class="w"> </span><span class="nc">f128</span><span class="p">,</span><span class="w"> </span><span class="n">v2</span><span class="p">:</span><span class="w"> </span><span class="nc">f128</span><span class="p">):</span>
<span class="w">    </span><span class="nc">v3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fadd</span><span class="w"> </span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="n">v2</span>
<span class="w">    </span><span class="n">store</span><span class="w"> </span><span class="n">v3</span><span class="p">,</span><span class="w"> </span><span class="n">v0</span>
<span class="w">    </span><span class="k">return</span>
<span class="p">}</span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<p><code>RUST_BACKTRACE=1 cargo run -p cranelift-tools -- test test.clif</code></p>
<h3>Expected Results</h3>
<p>No crash</p>
<h3>Actual Results</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">worker</span><span class="w"> </span><span class="p">#</span><span class="mi">0</span><span class="o">'</span><span class="w"> </span><span class="p">(</span><span class="mi">2560515</span><span class="p">)</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">cranelift</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">nan_canonicalization</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">121</span><span class="p">:</span><span class="mi">13</span><span class="p">:</span>
<span class="nc">Could</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">canonicalize</span><span class="w"> </span><span class="n">NaN</span><span class="p">:</span><span class="w"> </span><span class="nc">Unexpected</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="k">type</span><span class="w"> </span><span class="nc">found</span><span class="p">.</span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: e82a7abfd3e88145450a5465def20f6781e0eb65</p>
<h3>Extra Info</h3>
<p>F16 (on RISC-V with zfh) and F128 (on s390x) are valid floating-point types that pass the <code>is_fp_arith()</code> check in <code>nan_canonicalization.rs</code> but fall through to the panic in <code>add_nan_canon_seq()</code>:</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/e82a7abfd3e88145450a5465def20f6781e0eb65/cranelift/codegen/src/nan_canonicalization.rs#L92-L123">https://github.com/bytecodealliance/wasmtime/blob/e82a7abfd3e88145450a5465def20f6781e0eb65/cranelift/codegen/src/nan_canonicalization.rs#L92-L123</a></p>
<p>Adding the following arm will fix the F128 for s390x:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">        </span><span class="n">types</span><span class="p">::</span><span class="n">F128</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">nan_const</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos</span><span class="p">.</span><span class="n">func</span><span class="p">.</span><span class="n">dfg</span><span class="p">.</span><span class="n">constants</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Ieee128</span><span class="p">::</span><span class="n">NAN</span><span class="p">.</span><span class="n">into</span><span class="p">());</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">canon_nan</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">f128const</span><span class="p">(</span><span class="n">nan_const</span><span class="p">);</span>
<span class="w">            </span><span class="n">scalar_select</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="n">canon_nan</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
</code></pre></div>
<p>I'm not sure if F16 needs to be fixed because of #7322.</p>
<p>Thanks for looking into this and I'm happy to submit a PR if the fix to F128 looks ok.</p>
</blockquote>



<a name="567867812"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312336%20Cranelift%3A%20NaN%20canonicalization%20p.../near/567867812" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312336.20Cranelift.3A.20NaN.20canonicalization.20p.2E.2E.2E.html#567867812">(Jan 13 2026 at 22:09)</a>:</h4>
<p><a href="https://github.com/zzjas">zzjas</a> added the bug label to <a href="https://github.com/bytecodealliance/wasmtime/issues/12336">Issue #12336</a>.</p>



<a name="567867813"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312336%20Cranelift%3A%20NaN%20canonicalization%20p.../near/567867813" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312336.20Cranelift.3A.20NaN.20canonicalization.20p.2E.2E.2E.html#567867813">(Jan 13 2026 at 22:09)</a>:</h4>
<p><a href="https://github.com/zzjas">zzjas</a> added the cranelift label to <a href="https://github.com/bytecodealliance/wasmtime/issues/12336">Issue #12336</a>.</p>



<a name="567872235"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312336%20Cranelift%3A%20NaN%20canonicalization%20p.../near/567872235" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312336.20Cranelift.3A.20NaN.20canonicalization.20p.2E.2E.2E.html#567872235">(Jan 13 2026 at 22:45)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/12336#issuecomment-3746906836">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12336">issue #12336</a>:</p>
<blockquote>
<p>I think it'd be reasonable to add support to the <code>nan_canonicalization.rs</code> pass for this yeah, and if you're willing to make a PR that'd be much appreciated!</p>
</blockquote>



<a name="567874228"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312336%20Cranelift%3A%20NaN%20canonicalization%20p.../near/567874228" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312336.20Cranelift.3A.20NaN.20canonicalization.20p.2E.2E.2E.html#567874228">(Jan 13 2026 at 23:05)</a>:</h4>
<p>zzjas <a href="https://github.com/bytecodealliance/wasmtime/issues/12336#issuecomment-3746955049">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12336">issue #12336</a>:</p>
<blockquote>
<p>Happy to make a PR! Just to confirm, do you think just fixing for F128 is enough or would it better to fix for both F128 and F16? Thanks!</p>
</blockquote>



<a name="567874982"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312336%20Cranelift%3A%20NaN%20canonicalization%20p.../near/567874982" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312336.20Cranelift.3A.20NaN.20canonicalization.20p.2E.2E.2E.html#567874982">(Jan 13 2026 at 23:12)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/12336#issuecomment-3746971277">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12336">issue #12336</a>:</p>
<blockquote>
<p>I'd personally leave that call to you as a subjective balance between implementation complexity and how motivated you are. Cranelift is probably going to have somewhat patchy support for f16/f128 for awhile unless a particularly motivated contributor comes by, so the exact state of support to me I think is fine with whatever so long as it's incrementally moving forward</p>
</blockquote>



<a name="567883096"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312336%20Cranelift%3A%20NaN%20canonicalization%20p.../near/567883096" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312336.20Cranelift.3A.20NaN.20canonicalization.20p.2E.2E.2E.html#567883096">(Jan 14 2026 at 00:23)</a>:</h4>
<p>cfallin closed <a href="https://github.com/bytecodealliance/wasmtime/issues/12336">issue #12336</a>:</p>
<blockquote>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">test</span><span class="w"> </span><span class="n">compile</span>
<span class="n">set</span><span class="w"> </span><span class="n">enable_nan_canonicalization</span><span class="o">=</span><span class="kc">true</span>
<span class="n">target</span><span class="w"> </span><span class="n">s390x</span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">fadd_f128</span><span class="p">(</span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">f128</span><span class="p">,</span><span class="w"> </span><span class="n">f128</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span><span class="p">:</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="p">:</span><span class="w"> </span><span class="nc">f128</span><span class="p">,</span><span class="w"> </span><span class="n">v2</span><span class="p">:</span><span class="w"> </span><span class="nc">f128</span><span class="p">):</span>
<span class="w">    </span><span class="nc">v3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fadd</span><span class="w"> </span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="n">v2</span>
<span class="w">    </span><span class="n">store</span><span class="w"> </span><span class="n">v3</span><span class="p">,</span><span class="w"> </span><span class="n">v0</span>
<span class="w">    </span><span class="k">return</span>
<span class="p">}</span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<p><code>RUST_BACKTRACE=1 cargo run -p cranelift-tools -- test test.clif</code></p>
<h3>Expected Results</h3>
<p>No crash</p>
<h3>Actual Results</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">worker</span><span class="w"> </span><span class="p">#</span><span class="mi">0</span><span class="o">'</span><span class="w"> </span><span class="p">(</span><span class="mi">2560515</span><span class="p">)</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">cranelift</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">nan_canonicalization</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">121</span><span class="p">:</span><span class="mi">13</span><span class="p">:</span>
<span class="nc">Could</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">canonicalize</span><span class="w"> </span><span class="n">NaN</span><span class="p">:</span><span class="w"> </span><span class="nc">Unexpected</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="k">type</span><span class="w"> </span><span class="nc">found</span><span class="p">.</span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: e82a7abfd3e88145450a5465def20f6781e0eb65</p>
<h3>Extra Info</h3>
<p>F16 (on RISC-V with zfh) and F128 (on s390x) are valid floating-point types that pass the <code>is_fp_arith()</code> check in <code>nan_canonicalization.rs</code> but fall through to the panic in <code>add_nan_canon_seq()</code>:</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/e82a7abfd3e88145450a5465def20f6781e0eb65/cranelift/codegen/src/nan_canonicalization.rs#L92-L123">https://github.com/bytecodealliance/wasmtime/blob/e82a7abfd3e88145450a5465def20f6781e0eb65/cranelift/codegen/src/nan_canonicalization.rs#L92-L123</a></p>
<p>Adding the following arm will fix the F128 for s390x:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">        </span><span class="n">types</span><span class="p">::</span><span class="n">F128</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">nan_const</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos</span><span class="p">.</span><span class="n">func</span><span class="p">.</span><span class="n">dfg</span><span class="p">.</span><span class="n">constants</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Ieee128</span><span class="p">::</span><span class="n">NAN</span><span class="p">.</span><span class="n">into</span><span class="p">());</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">canon_nan</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos</span><span class="p">.</span><span class="n">ins</span><span class="p">().</span><span class="n">f128const</span><span class="p">(</span><span class="n">nan_const</span><span class="p">);</span>
<span class="w">            </span><span class="n">scalar_select</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="n">canon_nan</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
</code></pre></div>
<p>I'm not sure if F16 needs to be fixed because of #7322.</p>
<p>Thanks for looking into this and I'm happy to submit a PR if the fix to F128 looks ok.</p>
</blockquote>



<hr><p>Last updated: Feb 22 2026 at 11:05 UTC</p>
</html>
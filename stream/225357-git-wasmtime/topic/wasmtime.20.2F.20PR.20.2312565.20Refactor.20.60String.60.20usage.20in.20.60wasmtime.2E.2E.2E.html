<html>
<head><meta charset="utf-8"><title>wasmtime / PR #12565 Refactor `String` usage in `wasmtime... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312565.20Refactor.20.60String.60.20usage.20in.20.60wasmtime.2E.2E.2E.html">wasmtime / PR #12565 Refactor `String` usage in `wasmtime...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="573160961"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312565%20Refactor%20%60String%60%20usage%20in%20%60wasmtime.../near/573160961" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312565.20Refactor.20.60String.60.20usage.20in.20.60wasmtime.2E.2E.2E.html#573160961">(Feb 10 2026 at 22:18)</a>:</h4>
<p>fitzgen opened <a href="https://github.com/bytecodealliance/wasmtime/pull/12565">PR #12565</a> from <code>fitzgen:use-oom-handling-string-in-env-module</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>Do not hold regular <code>String</code>s; instead use our own OOM-handling<br>
<code>wasmtime_core::alloc::String</code> or, even better, an interned <code>Atom</code> from the<br>
<code>StringPool</code>.</p>
<p>Also avoid <code>IndexMap</code>, as it doesn't handle OOMs.</p>
<p>Depends on</p>
<ul>
<li><a href="https://github.com/bytecodealliance/wasmtime/pull/12564">https://github.com/bytecodealliance/wasmtime/pull/12564</a></li>
<li><a href="https://github.com/bytecodealliance/wasmtime/pull/12563">https://github.com/bytecodealliance/wasmtime/pull/12563</a></li>
<li><a href="https://github.com/bytecodealliance/wasmtime/pull/12562">https://github.com/bytecodealliance/wasmtime/pull/12562</a></li>
</ul>
</blockquote>



<a name="573160962"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312565%20Refactor%20%60String%60%20usage%20in%20%60wasmtime.../near/573160962" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312565.20Refactor.20.60String.60.20usage.20in.20.60wasmtime.2E.2E.2E.html#573160962">(Feb 10 2026 at 22:18)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/12565">PR #12565</a>.</p>



<a name="573160963"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312565%20Refactor%20%60String%60%20usage%20in%20%60wasmtime.../near/573160963" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312565.20Refactor.20.60String.60.20usage.20in.20.60wasmtime.2E.2E.2E.html#573160963">(Feb 10 2026 at 22:18)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/cfallin">cfallin</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/12565">PR #12565</a>.</p>



<a name="573160964"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312565%20Refactor%20%60String%60%20usage%20in%20%60wasmtime.../near/573160964" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312565.20Refactor.20.60String.60.20usage.20in.20.60wasmtime.2E.2E.2E.html#573160964">(Feb 10 2026 at 22:18)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers">wasmtime-core-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/12565">PR #12565</a>.</p>



<a name="573161802"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312565%20Refactor%20%60String%60%20usage%20in%20%60wasmtime.../near/573161802" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312565.20Refactor.20.60String.60.20usage.20in.20.60wasmtime.2E.2E.2E.html#573161802">(Feb 10 2026 at 22:24)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/12565#issuecomment-3881064791">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/12565">PR #12565</a>:</p>
<blockquote>
<p>Knee-jerk reaction before you have too many more PRs that depend on this -- <code>IndexMap</code> is a relatively fundamental dependency especially for components, so I'm not sure we'll be able to escape making an OOM friendly version. Or at least I recall my impression being that we have quite a lot of <code>IndexMap</code>s throughout compilation/etc. Is the usage pretty localized to just one or two locations though?</p>
</blockquote>



<a name="573163166"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312565%20Refactor%20%60String%60%20usage%20in%20%60wasmtime.../near/573163166" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312565.20Refactor.20.60String.60.20usage.20in.20.60wasmtime.2E.2E.2E.html#573163166">(Feb 10 2026 at 22:33)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/pull/12565#issuecomment-3881097091">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/12565">PR #12565</a>:</p>
<blockquote>
<blockquote>
<p>Knee-jerk reaction before you have too many more PRs that depend on this -- <code>IndexMap</code> is a relatively fundamental dependency especially for components, so I'm not sure we'll be able to escape making an OOM friendly version. Or at least I recall my impression being that we have quite a lot of <code>IndexMap</code>s throughout compilation/etc. Is the usage pretty localized to just one or two locations though?</p>
</blockquote>
<p><code>IndexMap</code> is either <code>index_map::IndexMap</code> or a <code>BTreeMap</code> depending on <code>wasmparser</code> configuration:</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/755979dd81eb79ff746fb4e63d4570513216e731/crates/environ/src/prelude.rs#L30">https://github.com/bytecodealliance/wasmtime/blob/755979dd81eb79ff746fb4e63d4570513216e731/crates/environ/src/prelude.rs#L30</a></p>
<p><code>std</code>/<code>alloc</code> does not provide a way to fallibly reserve/insert/allocate for <code>BTreeMap</code>s.</p>
<p>And <code>index_map::IndexMap</code> does not provide a <code>try_reserve</code> method either. Additionally, <code>index_map::IndexMap</code>'s <code>Deserialize</code> implementation requires that the key be <code>Clone</code>, which our OOM-handling <code>String</code>s are most definitely not.</p>
<p>So it seems like continuing to use <code>IndexMap</code> is going to be an uphill battle.</p>
<p>We <em>could</em> make our own <code>IndexMap</code> that is a full implementation, rather than simply a newtype wrapper over either of those existing implementations. But that also seems pretty annoying and like more of a maintenance burden than is ideal... But maybe not, given that what I did with <code>exports</code> here is basically inlining/hard-coding one specific instance of that?</p>
<p>Thoughts?</p>
</blockquote>



<a name="573178351"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312565%20Refactor%20%60String%60%20usage%20in%20%60wasmtime.../near/573178351" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312565.20Refactor.20.60String.60.20usage.20in.20.60wasmtime.2E.2E.2E.html#573178351">(Feb 11 2026 at 00:48)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/12565#issuecomment-3881527738">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/12565">PR #12565</a>:</p>
<blockquote>
<p>One possible fix might be to use <code>indexmap::IndexMap</code> (directly from the crate, not <code>wasmparser</code>). That should support no_std and it looks like it's got a <code>try_reserve</code> to work for us as well. For <code>Deserialize</code> wouldn't we be writing custom impls as opposed to using any built-in ones too?</p>
<p>I guess what I'm saying is that my leaning is that we should have an <code>indexmap::IndexMap</code> wrapper the same way we have a <code>Vec</code> wrapper and then replace the usage of <code>wasmparser::IndexMap</code> with that fallible <code>IndexMap</code>. </p>
</blockquote>



<a name="573194242"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312565%20Refactor%20%60String%60%20usage%20in%20%60wasmtime.../near/573194242" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312565.20Refactor.20.60String.60.20usage.20in.20.60wasmtime.2E.2E.2E.html#573194242">(Feb 11 2026 at 03:39)</a>:</h4>
<p>github-actions[bot] added the label <code>cranelift</code> on <a href="https://github.com/bytecodealliance/wasmtime/pull/12565">PR #12565</a>.</p>



<a name="573194244"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312565%20Refactor%20%60String%60%20usage%20in%20%60wasmtime.../near/573194244" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312565.20Refactor.20.60String.60.20usage.20in.20.60wasmtime.2E.2E.2E.html#573194244">(Feb 11 2026 at 03:39)</a>:</h4>
<p>github-actions[bot] added the label <code>wasmtime:api</code> on <a href="https://github.com/bytecodealliance/wasmtime/pull/12565">PR #12565</a>.</p>



<a name="573606694"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312565%20Refactor%20%60String%60%20usage%20in%20%60wasmtime.../near/573606694" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312565.20Refactor.20.60String.60.20usage.20in.20.60wasmtime.2E.2E.2E.html#573606694">(Feb 12 2026 at 19:50)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/12565">PR #12565</a>.</p>



<a name="573606925"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312565%20Refactor%20%60String%60%20usage%20in%20%60wasmtime.../near/573606925" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312565.20Refactor.20.60String.60.20usage.20in.20.60wasmtime.2E.2E.2E.html#573606925">(Feb 12 2026 at 19:51)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/pull/12565#issuecomment-3893060695">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/12565">PR #12565</a>:</p>
<blockquote>
<blockquote>
<p>I guess what I'm saying is that my leaning is that we should have an <code>indexmap::IndexMap</code> wrapper the same way we have a <code>Vec</code> wrapper and then replace the usage of <code>wasmparser::IndexMap</code> with that fallible <code>IndexMap</code>.</p>
</blockquote>
<p>Okay, that has been done and I've pushed a new commit that switches this back to using <code>IndexMap</code> instead of multiple <code>{Primary,Secondary}Map</code>s.</p>
<p>Also this depends on these other PRs now:</p>
<ul>
<li><a href="https://github.com/bytecodealliance/wasmtime/pull/12580">https://github.com/bytecodealliance/wasmtime/pull/12580</a></li>
<li><a href="https://github.com/bytecodealliance/wasmtime/pull/12579">https://github.com/bytecodealliance/wasmtime/pull/12579</a></li>
</ul>
</blockquote>



<a name="573618236"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312565%20Refactor%20%60String%60%20usage%20in%20%60wasmtime.../near/573618236" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312565.20Refactor.20.60String.60.20usage.20in.20.60wasmtime.2E.2E.2E.html#573618236">(Feb 12 2026 at 21:12)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/12565">PR #12565</a>.</p>



<a name="573618238"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312565%20Refactor%20%60String%60%20usage%20in%20%60wasmtime.../near/573618238" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312565.20Refactor.20.60String.60.20usage.20in.20.60wasmtime.2E.2E.2E.html#573618238">(Feb 12 2026 at 21:12)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/12565#pullrequestreview-3793695112">PR review</a>.</p>



<a name="573618239"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312565%20Refactor%20%60String%60%20usage%20in%20%60wasmtime.../near/573618239" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312565.20Refactor.20.60String.60.20usage.20in.20.60wasmtime.2E.2E.2E.html#573618239">(Feb 12 2026 at 21:12)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/12565#discussion_r2801080702">PR review comment</a>:</p>
<blockquote>
<p>This I think is no longer needed?</p>
</blockquote>



<a name="573618307"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312565%20Refactor%20%60String%60%20usage%20in%20%60wasmtime.../near/573618307" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312565.20Refactor.20.60String.60.20usage.20in.20.60wasmtime.2E.2E.2E.html#573618307">(Feb 12 2026 at 21:13)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/12565">PR #12565</a>.</p>



<a name="573618348"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312565%20Refactor%20%60String%60%20usage%20in%20%60wasmtime.../near/573618348" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312565.20Refactor.20.60String.60.20usage.20in.20.60wasmtime.2E.2E.2E.html#573618348">(Feb 12 2026 at 21:13)</a>:</h4>
<p>fitzgen has enabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/12565">PR #12565</a>.</p>



<a name="573620098"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312565%20Refactor%20%60String%60%20usage%20in%20%60wasmtime.../near/573620098" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312565.20Refactor.20.60String.60.20usage.20in.20.60wasmtime.2E.2E.2E.html#573620098">(Feb 12 2026 at 21:27)</a>:</h4>
<p>fitzgen added <a href="https://github.com/bytecodealliance/wasmtime/pull/12565">PR #12565 Refactor <code>String</code> usage in <code>wasmtime_environ::Module</code></a> to the merge queue</p>



<a name="573627604"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312565%20Refactor%20%60String%60%20usage%20in%20%60wasmtime.../near/573627604" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312565.20Refactor.20.60String.60.20usage.20in.20.60wasmtime.2E.2E.2E.html#573627604">(Feb 12 2026 at 22:15)</a>:</h4>
<p>fitzgen merged <a href="https://github.com/bytecodealliance/wasmtime/pull/12565">PR #12565</a>.</p>



<a name="573627608"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312565%20Refactor%20%60String%60%20usage%20in%20%60wasmtime.../near/573627608" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312565.20Refactor.20.60String.60.20usage.20in.20.60wasmtime.2E.2E.2E.html#573627608">(Feb 12 2026 at 22:15)</a>:</h4>
<p>fitzgen removed <a href="https://github.com/bytecodealliance/wasmtime/pull/12565">PR #12565 Refactor <code>String</code> usage in <code>wasmtime_environ::Module</code></a> from the merge queue</p>



<hr><p>Last updated: Feb 22 2026 at 11:05 UTC</p>
</html>
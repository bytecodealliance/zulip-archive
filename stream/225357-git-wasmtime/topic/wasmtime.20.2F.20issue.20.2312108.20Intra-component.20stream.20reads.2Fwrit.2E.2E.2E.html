<html>
<head><meta charset="utf-8"><title>wasmtime / issue #12108 Intra-component stream reads/writ... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312108.20Intra-component.20stream.20reads.2Fwrit.2E.2E.2E.html">wasmtime / issue #12108 Intra-component stream reads/writ...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="561499837"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312108%20Intra-component%20stream%20reads/writ.../near/561499837" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312108.20Intra-component.20stream.20reads.2Fwrit.2E.2E.2E.html#561499837">(Dec 02 2025 at 19:15)</a>:</h4>
<p>alexcrichton assigned dicej to <a href="https://github.com/bytecodealliance/wasmtime/issues/12108">issue #12108</a>.</p>



<a name="561499841"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312108%20Intra-component%20stream%20reads/writ.../near/561499841" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312108.20Intra-component.20stream.20reads.2Fwrit.2E.2E.2E.html#561499841">(Dec 02 2025 at 19:15)</a>:</h4>
<p>alexcrichton opened <a href="https://github.com/bytecodealliance/wasmtime/issues/12108">issue #12108</a>:</p>
<blockquote>
<p>For this test case:</p>
<div class="codehilite" data-code-language="wasm"><pre><span></span><code>(component
  (core module $libc (memory (export "m") 1))
  (core instance $libc (instantiate $libc))

  (type $s (stream u32))
  (core func $stream.new (canon stream.new $s))
  (core func $stream.read (canon stream.read $s async (memory $libc "m")))
  (core func $stream.write (canon stream.write $s async (memory $libc "m")))

  (core module $m
    (import "" "stream.new" (func $stream.new (result i64)))
    (import "" "stream.read" (func $stream.read (param i32 i32 i32) (result i32)))
    (import "" "stream.write" (func $stream.write (param i32 i32 i32) (result i32)))

    (func (export "run")
      (local $tmp i64)
      (local $r i32)
      (local $w i32)
      (local.set $tmp (call $stream.new))

      (local.set $r (i32.wrap_i64 (local.get $tmp)))
      (local.set $w (i32.wrap_i64 (i64.shr_u (local.get $tmp) (i64.const 32))))

      (call $stream.read (local.get $r) (i32.const 0) (i32.const 4))
      i32.const -1 ;; BLOCKED
      i32.ne
      if unreachable end

      (call $stream.write (local.get $w) (i32.const 0) (i32.const 4))
      drop
    )
  )

  (core instance $i (instantiate $m
    (with "" (instance
      (export "stream.new" (func $stream.new))
      (export "stream.read" (func $stream.read))
      (export "stream.write" (func $stream.write))
    ))
  ))

  (func (export "run") (canon lift (core func $i "run")))
)

(assert_trap (invoke "run") "some message here")
</code></pre></div>
<p>this yields:</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">wast</span><span class="w"> </span><span class="n">foo</span><span class="p">.</span><span class="n">wast</span><span class="w"> </span><span class="o">-</span><span class="n">W</span><span class="w"> </span><span class="n">component</span><span class="o">-</span><span class="n">model</span><span class="o">-</span><span class="k">async</span>
<span class="w">    </span><span class="n">Finished</span><span class="w"> </span><span class="err">`</span><span class="n">dev</span><span class="err">`</span><span class="w"> </span><span class="n">profile</span><span class="w"> </span><span class="p">[</span><span class="n">unoptimized</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">debuginfo</span><span class="p">]</span><span class="w"> </span><span class="n">target</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">0.10</span><span class="n">s</span>
<span class="w">     </span><span class="n">Running</span><span class="w"> </span><span class="err">`</span><span class="n">target</span><span class="o">/</span><span class="n">x86_64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">wasmtime</span><span class="w"> </span><span class="n">wast</span><span class="w"> </span><span class="n">foo</span><span class="p">.</span><span class="n">wast</span><span class="w"> </span><span class="o">-</span><span class="n">W</span><span class="w"> </span><span class="n">component</span><span class="o">-</span><span class="n">model</span><span class="o">-</span><span class="k">async</span><span class="err">`</span>
<span class="n">Error</span><span class="p">:</span><span class="w"> </span><span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">script</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">'</span><span class="na">foo</span><span class="p">.</span><span class="n">wast</span><span class="o">'</span>

<span class="n">Caused</span><span class="w"> </span><span class="n">by</span><span class="p">:</span>
<span class="w">    </span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="nc">failed</span><span class="w"> </span><span class="n">directive</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">foo</span><span class="p">.</span><span class="n">wast</span><span class="p">:</span><span class="mi">45</span>
<span class="w">    </span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="nc">expected</span><span class="w"> </span><span class="n">trap</span><span class="p">,</span><span class="w"> </span><span class="n">got</span><span class="w"> </span><span class="n">Component</span><span class="p">([])</span>
</code></pre></div><br>
</p>
</blockquote>



<a name="561499842"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312108%20Intra-component%20stream%20reads/writ.../near/561499842" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312108.20Intra-component.20stream.20reads.2Fwrit.2E.2E.2E.html#561499842">(Dec 02 2025 at 19:15)</a>:</h4>
<p><a href="https://github.com/alexcrichton">alexcrichton</a> added the wasm-proposal:component-model-async label to <a href="https://github.com/bytecodealliance/wasmtime/issues/12108">Issue #12108</a>.</p>



<a name="561499951"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312108%20Intra-component%20stream%20reads/writ.../near/561499951" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312108.20Intra-component.20stream.20reads.2Fwrit.2E.2E.2E.html#561499951">(Dec 02 2025 at 19:16)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/12108#issuecomment-3603600072">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12108">issue #12108</a>:</p>
<blockquote>
<p>Same for futures:</p>
<p><div class="codehilite" data-code-language="wasm"><pre><span></span><code>(component
  (core module $libc (memory (export "m") 1))
  (core instance $libc (instantiate $libc))

  (type $s (future u32))
  (core func $future.new (canon future.new $s))
  (core func $future.read (canon future.read $s async (memory $libc "m")))
  (core func $future.write (canon future.write $s async (memory $libc "m")))

  (core module $m
    (import "" "future.new" (func $future.new (result i64)))
    (import "" "future.read" (func $future.read (param i32 i32) (result i32)))
    (import "" "future.write" (func $future.write (param i32 i32) (result i32)))

    (func (export "run")
      (local $tmp i64)
      (local $r i32)
      (local $w i32)
      (local.set $tmp (call $future.new))

      (local.set $r (i32.wrap_i64 (local.get $tmp)))
      (local.set $w (i32.wrap_i64 (i64.shr_u (local.get $tmp) (i64.const 32))))

      (call $future.read (local.get $r) (i32.const 0))
      i32.const -1 ;; BLOCKED
      i32.ne
      if unreachable end

      (call $future.write (local.get $w) (i32.const 0))
      drop
    )
  )

  (core instance $i (instantiate $m
    (with "" (instance
      (export "future.new" (func $future.new))
      (export "future.read" (func $future.read))
      (export "future.write" (func $future.write))
    ))
  ))

  (func (export "run") (canon lift (core func $i "run")))
)

(assert_trap (invoke "run") "some message here")
</code></pre></div><br>
</p>
</blockquote>



<a name="561690943"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312108%20Intra-component%20stream%20reads/writ.../near/561690943" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312108.20Intra-component.20stream.20reads.2Fwrit.2E.2E.2E.html#561690943">(Dec 03 2025 at 15:55)</a>:</h4>
<p>dicej <a href="https://github.com/bytecodealliance/wasmtime/issues/12108#issuecomment-3607548312">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12108">issue #12108</a>:</p>
<blockquote>
<p>FYI, I've fixed this locally, but it turns out the <code>p3_http_middleware_host_to_host</code> is doing intra-component <code>stream&lt;u8&gt;</code> reads and writes.  Specifically, the <code>p3_http_middleware</code> component is creating a stream, wrapping it in a request, and passing that request to the <code>p3_http_echo</code> component.  Then the <code>p3_http_echo</code> component consumes the request, wraps the stream in a response, and returns the response.  Finally, the <code>p3_http_middleware</code> component consumes the response and reads from the stream, not realizing it's the same stream it created.</p>
<p>I think we anticipated this kind of scenario, but it's not clear to me which component ought to change its behavior here.  It seems unfair to make the <code>p3_http_echo</code> component conservatively create an intermediate stream to avoid passing the original one back to the caller, and it's not clear to me how <code>p3_http_middleware</code> could be defensive about it either.</p>
<p>@lukewagner do you have thoughts on this?</p>
</blockquote>



<a name="561701831"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312108%20Intra-component%20stream%20reads/writ.../near/561701831" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312108.20Intra-component.20stream.20reads.2Fwrit.2E.2E.2E.html#561701831">(Dec 03 2025 at 16:37)</a>:</h4>
<p>lukewagner <a href="https://github.com/bytecodealliance/wasmtime/issues/12108#issuecomment-3607756407">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12108">issue #12108</a>:</p>
<blockquote>
<p>The same-component trap is very much a "this will bite folks in unexpected and unfair ways" TODO to fix, so I think, unfortunately, the "right" fix is to have the echo server do an intermediate copy.  FWIW, IIUC, once we get lazy-lowering, I think the same-component-instance case should mostly fall out for free (or with only modest effort) and so we could simply delete the trap.</p>
</blockquote>



<a name="561712231"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312108%20Intra-component%20stream%20reads/writ.../near/561712231" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312108.20Intra-component.20stream.20reads.2Fwrit.2E.2E.2E.html#561712231">(Dec 03 2025 at 17:18)</a>:</h4>
<p>dicej <a href="https://github.com/bytecodealliance/wasmtime/issues/12108#issuecomment-3607939480">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12108">issue #12108</a>:</p>
<blockquote>
<p>I'm remembering now when we last discussed this, and I guess the ideal solution would be for <code>wit_bindgen</code>'s <code>Stream{Writer::write,Reader::read}</code> to check for the intra-component case and switch to an in-memory channel.  The tricky part is switching back and forth between the "intra" and "inter" states as the read handle is passed in and out of the component.</p>
</blockquote>



<a name="561729327"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312108%20Intra-component%20stream%20reads/writ.../near/561729327" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312108.20Intra-component.20stream.20reads.2Fwrit.2E.2E.2E.html#561729327">(Dec 03 2025 at 18:47)</a>:</h4>
<p>alexcrichton closed <a href="https://github.com/bytecodealliance/wasmtime/issues/12108">issue #12108</a>:</p>
<blockquote>
<p>For this test case:</p>
<div class="codehilite" data-code-language="wasm"><pre><span></span><code>(component
  (core module $libc (memory (export "m") 1))
  (core instance $libc (instantiate $libc))

  (type $s (stream u32))
  (core func $stream.new (canon stream.new $s))
  (core func $stream.read (canon stream.read $s async (memory $libc "m")))
  (core func $stream.write (canon stream.write $s async (memory $libc "m")))

  (core module $m
    (import "" "stream.new" (func $stream.new (result i64)))
    (import "" "stream.read" (func $stream.read (param i32 i32 i32) (result i32)))
    (import "" "stream.write" (func $stream.write (param i32 i32 i32) (result i32)))

    (func (export "run")
      (local $tmp i64)
      (local $r i32)
      (local $w i32)
      (local.set $tmp (call $stream.new))

      (local.set $r (i32.wrap_i64 (local.get $tmp)))
      (local.set $w (i32.wrap_i64 (i64.shr_u (local.get $tmp) (i64.const 32))))

      (call $stream.read (local.get $r) (i32.const 0) (i32.const 4))
      i32.const -1 ;; BLOCKED
      i32.ne
      if unreachable end

      (call $stream.write (local.get $w) (i32.const 0) (i32.const 4))
      drop
    )
  )

  (core instance $i (instantiate $m
    (with "" (instance
      (export "stream.new" (func $stream.new))
      (export "stream.read" (func $stream.read))
      (export "stream.write" (func $stream.write))
    ))
  ))

  (func (export "run") (canon lift (core func $i "run")))
)

(assert_trap (invoke "run") "some message here")
</code></pre></div>
<p>this yields:</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">wast</span><span class="w"> </span><span class="n">foo</span><span class="p">.</span><span class="n">wast</span><span class="w"> </span><span class="o">-</span><span class="n">W</span><span class="w"> </span><span class="n">component</span><span class="o">-</span><span class="n">model</span><span class="o">-</span><span class="k">async</span>
<span class="w">    </span><span class="n">Finished</span><span class="w"> </span><span class="err">`</span><span class="n">dev</span><span class="err">`</span><span class="w"> </span><span class="n">profile</span><span class="w"> </span><span class="p">[</span><span class="n">unoptimized</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">debuginfo</span><span class="p">]</span><span class="w"> </span><span class="n">target</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">0.10</span><span class="n">s</span>
<span class="w">     </span><span class="n">Running</span><span class="w"> </span><span class="err">`</span><span class="n">target</span><span class="o">/</span><span class="n">x86_64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">wasmtime</span><span class="w"> </span><span class="n">wast</span><span class="w"> </span><span class="n">foo</span><span class="p">.</span><span class="n">wast</span><span class="w"> </span><span class="o">-</span><span class="n">W</span><span class="w"> </span><span class="n">component</span><span class="o">-</span><span class="n">model</span><span class="o">-</span><span class="k">async</span><span class="err">`</span>
<span class="n">Error</span><span class="p">:</span><span class="w"> </span><span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">script</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">'</span><span class="na">foo</span><span class="p">.</span><span class="n">wast</span><span class="o">'</span>

<span class="n">Caused</span><span class="w"> </span><span class="n">by</span><span class="p">:</span>
<span class="w">    </span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="nc">failed</span><span class="w"> </span><span class="n">directive</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">foo</span><span class="p">.</span><span class="n">wast</span><span class="p">:</span><span class="mi">45</span>
<span class="w">    </span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="nc">expected</span><span class="w"> </span><span class="n">trap</span><span class="p">,</span><span class="w"> </span><span class="n">got</span><span class="w"> </span><span class="n">Component</span><span class="p">([])</span>
</code></pre></div><br>
</p>
</blockquote>



<hr><p>Last updated: Feb 22 2026 at 11:05 UTC</p>
</html>
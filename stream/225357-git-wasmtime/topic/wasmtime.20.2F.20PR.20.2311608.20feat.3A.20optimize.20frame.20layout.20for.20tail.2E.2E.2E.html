<html>
<head><meta charset="utf-8"><title>wasmtime / PR #11608 feat: optimize frame layout for tail... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311608.20feat.3A.20optimize.20frame.20layout.20for.20tail.2E.2E.2E.html">wasmtime / PR #11608 feat: optimize frame layout for tail...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="537762828"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311608%20feat%3A%20optimize%20frame%20layout%20for%20tail.../near/537762828" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311608.20feat.3A.20optimize.20frame.20layout.20for.20tail.2E.2E.2E.html#537762828">(Sep 04 2025 at 22:08)</a>:</h4>
<p>pnodet opened <a href="https://github.com/bytecodealliance/wasmtime/pull/11608">PR #11608</a> from <code>pnodet:pnodet-11</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>Reduce frame size from 16 to 8 bytes for functions that only make tail calls (FunctionCalls::TailOnly). This optimization:</p>
</blockquote>



<a name="537763142"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311608%20feat%3A%20optimize%20frame%20layout%20for%20tail.../near/537763142" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311608.20feat.3A.20optimize.20frame.20layout.20for.20tail.2E.2E.2E.html#537763142">(Sep 04 2025 at 22:11)</a>:</h4>
<p>pnodet <a href="https://github.com/bytecodealliance/wasmtime/pull/11608#issuecomment-3255964925">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11608">PR #11608</a>:</p>
<blockquote>
<p>@cfallin What do you think of something like this? I only looked into aarch64 for the moment since other ISAs such as x64 s390x looks quite different and more complex to implement.</p>
</blockquote>



<a name="537763152"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311608%20feat%3A%20optimize%20frame%20layout%20for%20tail.../near/537763152" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311608.20feat.3A.20optimize.20frame.20layout.20for.20tail.2E.2E.2E.html#537763152">(Sep 04 2025 at 22:11)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/11608#issuecomment-3255965404">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11608">PR #11608</a>:</p>
<blockquote>
<p>Unfortunately I don't think this is going to work: the stack pointer has to be 16-aligned, and aarch64 will actually trap if memory accesses occur with a misaligned SP.</p>
<p>Furthermore the savings I would expect is not "only push FP, not LR", but "don't push anything at all if the frame is zero-size". This should be the case for tail-calling functions with. no stack storage (spillslots, stackslots or clobbers) and no outgoing argument space.</p>
</blockquote>



<a name="537764632"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311608%20feat%3A%20optimize%20frame%20layout%20for%20tail.../near/537764632" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311608.20feat.3A.20optimize.20frame.20layout.20for.20tail.2E.2E.2E.html#537764632">(Sep 04 2025 at 22:26)</a>:</h4>
<p>pnodet <a href="https://github.com/bytecodealliance/wasmtime/pull/11608#issuecomment-3256028604">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11608">PR #11608</a>:</p>
<blockquote>
<p>Don't debuggers rely on frame pointers for stack traces? Could setting the frame size to 0 hurt debugging/unwinding?</p>
</blockquote>



<a name="537765285"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311608%20feat%3A%20optimize%20frame%20layout%20for%20tail.../near/537765285" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311608.20feat.3A.20optimize.20frame.20layout.20for.20tail.2E.2E.2E.html#537765285">(Sep 04 2025 at 22:32)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/pull/11608#issuecomment-3256052244">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11608">PR #11608</a>:</p>
<blockquote>
<p>Debuggers and profilers should handle missing stack frames for leaf functions already. And besides debuggers actually generally use .eh_frame for stack unwinding, only falling back to frame pointers when .eh_frame is not available.</p>
</blockquote>



<a name="537765754"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311608%20feat%3A%20optimize%20frame%20layout%20for%20tail.../near/537765754" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311608.20feat.3A.20optimize.20frame.20layout.20for.20tail.2E.2E.2E.html#537765754">(Sep 04 2025 at 22:37)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/11608#issuecomment-3256073559">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11608">PR #11608</a>:</p>
<blockquote>
<p>Right -- we already omit frame pointers for functions that are truly leaf functions (no calls at all, with no frame storage); this is a common optimization.</p>
<p>In Wasmtime, where we use our own stack-walking logic and unwinder and want simplicity/robustness, we configure Cranelift never to omit frame pointers; so this optimization largely applies to other uses of Cranelift, like bjorn3's <code>cg_clif</code>.</p>
</blockquote>



<a name="537766418"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311608%20feat%3A%20optimize%20frame%20layout%20for%20tail.../near/537766418" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311608.20feat.3A.20optimize.20frame.20layout.20for.20tail.2E.2E.2E.html#537766418">(Sep 04 2025 at 22:45)</a>:</h4>
<p>pnodet <a href="https://github.com/bytecodealliance/wasmtime/pull/11608#issuecomment-3256105882">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11608">PR #11608</a>:</p>
<blockquote>
<p>Then could it be safe to have something like this?</p>
<p><div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="w"> </span>       // Compute linkage frame size.
<span class="w"> </span>       let setup_area_size = if flags.preserve_frame_pointers()
<span class="w"> </span>           // The function arguments that are passed on the stack are addressed
<span class="w"> </span>           // relative to the Frame Pointer.
<span class="w"> </span>           || flags.unwind_info()
<span class="w"> </span>           || incoming_args_size &gt; 0
<span class="w"> </span>           || clobber_size &gt; 0
<span class="w"> </span>           || fixed_frame_storage_size &gt; 0
<span class="w"> </span>       {
<span class="w"> </span>           16 // FP, LR
<span class="w"> </span>       } else {
<span class="w"> </span>           match function_calls {
<span class="w"> </span>               FunctionCalls::Regular =&gt; 16,
<span class="w"> </span>               FunctionCalls::None =&gt; 0,
<span class="gd">-               FunctionCalls::TailOnly =&gt; 8,</span>
<span class="gi">+               FunctionCalls::TailOnly =&gt; 0,</span>
<span class="w"> </span>           }
<span class="w"> </span>       };
</code></pre></div><br>
</p>
</blockquote>



<a name="537767626"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311608%20feat%3A%20optimize%20frame%20layout%20for%20tail.../near/537767626" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311608.20feat.3A.20optimize.20frame.20layout.20for.20tail.2E.2E.2E.html#537767626">(Sep 04 2025 at 22:59)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/11608#issuecomment-3256157619">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11608">PR #11608</a>:</p>
<blockquote>
<p>I think you'll want to check the tail args and outgoing args size as well (the other parameters to <code>compute_frame_layout</code>) -- basically, if any part of the frame needs to exist, then we need to do the FP setup even if we only have tail calls.</p>
</blockquote>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
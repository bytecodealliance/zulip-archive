<html>
<head><meta charset="utf-8"><title>wasmtime / PR #11487 Add initial empty rec groups · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311487.20Add.20initial.20empty.20rec.20groups.html">wasmtime / PR #11487 Add initial empty rec groups</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="535430226"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311487%20Add%20initial%20empty%20rec%20groups/near/535430226" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311487.20Add.20initial.20empty.20rec.20groups.html#535430226">(Aug 21 2025 at 05:04)</a>:</h4>
<p>khagankhan opened <a href="https://github.com/bytecodealliance/wasmtime/pull/11487">PR #11487</a> from <code>khagankhan:rec-empty</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>This PR introduces initial support for empty <code>(rec ...)</code> groups:</p>
<ul>
<li>Adds generation of empty recursive groups within a configurable range (clamping is applied).</li>
<li>Establishes foundational support for future GC work (e.g., struct definitions, related implementations).</li>
<li>Updates existing tests and adds new unit tests.</li>
<li>Introduce a new <code>Op</code> that attempts to instantiate a struct from a group. It is designed to be self-dropping due to type incompatibility.</li>
</ul>
<hr>
<p>Note:</p>
<p>The line:</p>
<div class="codehilite"><pre><span></span><code>StructNew(k: |ops| ops.total_struct_types() =&gt; u32) : 0 =&gt; 0,
</code></pre></div>

<p>should effectively prevent <code>struct.new</code> from being generated when no struct types exist. Depending on the configuration and macro logic, it will either:</p>
<ul>
<li>Not be generated at all,</li>
<li>Trigger an assertion failure during macro expansion,</li>
<li>Or work as expected by skipping generation.</li>
</ul>
<p>I will confirm and refine this behavior in a follow-up PR.<br>
</p>
</blockquote>



<a name="535430227"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311487%20Add%20initial%20empty%20rec%20groups/near/535430227" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311487.20Add.20initial.20empty.20rec.20groups.html#535430227">(Aug 21 2025 at 05:04)</a>:</h4>
<p><strong>khagankhan</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-fuzz-reviewers">wasmtime-fuzz-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/11487">PR #11487</a>.</p>



<a name="535430228"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311487%20Add%20initial%20empty%20rec%20groups/near/535430228" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311487.20Add.20initial.20empty.20rec.20groups.html#535430228">(Aug 21 2025 at 05:04)</a>:</h4>
<p><strong>khagankhan</strong> requested <a href="https://github.com/fitzgen">fitzgen</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/11487">PR #11487</a>.</p>



<a name="535447565"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311487%20Add%20initial%20empty%20rec%20groups/near/535447565" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311487.20Add.20initial.20empty.20rec.20groups.html#535447565">(Aug 21 2025 at 07:45)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/11487#issuecomment-3209392052">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11487">PR #11487</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @fitzgen</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "fuzzing"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>fitzgen: fuzzing</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="535586495"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311487%20Add%20initial%20empty%20rec%20groups/near/535586495" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311487.20Add.20initial.20empty.20rec.20groups.html#535586495">(Aug 21 2025 at 22:14)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11487#pullrequestreview-3141754051">PR review</a>:</p>
<blockquote>
<p>Thanks! A few thoughts below.</p>
</blockquote>



<a name="535586496"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311487%20Add%20initial%20empty%20rec%20groups/near/535586496" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311487.20Add.20initial.20empty.20rec.20groups.html#535586496">(Aug 21 2025 at 22:14)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/11487#discussion_r2292156184">PR review comment</a>:</p>
<blockquote>
<p>Because this is going to be serialized and deserialized, and the fuzzer will occasionally mutate those raw bytes, that means that we will get arbitrary values for <code>next_group</code> and <code>rec_groups</code> and we can't rely on any relationship between the two fields (such as, <code>rec_groups</code> does not contain a group with <code>id == next_group</code>).</p>
<p>It is probably better to get rid of the <code>next_group</code> field and just insert random values, resolving conflicts at insertion time as necessary (or even just ignoring conflicts and letting that "merge" rec groups).</p>
</blockquote>



<a name="535586497"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311487%20Add%20initial%20empty%20rec%20groups/near/535586497" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311487.20Add.20initial.20empty.20rec.20groups.html#535586497">(Aug 21 2025 at 22:14)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/11487#discussion_r2291770931">PR review comment</a>:</p>
<blockquote>
<p>Nitpick: even though we are starting with <code>struct</code> types we plan on defining all kinds of types here eventually, so lets future-proof this a little bit and name it simply <code>Types</code>.</p>
</blockquote>



<a name="535586498"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311487%20Add%20initial%20empty%20rec%20groups/near/535586498" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311487.20Add.20initial.20empty.20rec.20groups.html#535586498">(Aug 21 2025 at 22:14)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/11487#discussion_r2292222536">PR review comment</a>:</p>
<blockquote>
<p>I think we should delay emitting empty structs in rec groups, and just emit empty rec groups in this PR. Because longer-term, we aren't going to want to special-case empty structs in rec groups like this.</p>
<p>Then, in the next PR, we can extend <code>Types</code> something like this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">Types</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ...previous stuff from above...</span>

<span class="w">    </span><span class="c1">// The actual type definitions.</span>
<span class="w">    </span><span class="n">type_defs</span><span class="p">:</span><span class="w"> </span><span class="nc">BTreeMap</span><span class="o">&lt;</span><span class="n">TypeId</span><span class="p">,</span><span class="w"> </span><span class="n">SubType</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">SubType</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Eventually, this will have finality and an optional super</span>
<span class="w">    </span><span class="c1">// type; for now it will only have this stuff.</span>

<span class="w">    </span><span class="c1">// The rec group that this type should be defined within.</span>
<span class="w">    </span><span class="n">rec_group</span><span class="p">:</span><span class="w"> </span><span class="nc">RecGroupId</span><span class="p">,</span>

<span class="w">    </span><span class="c1">// The actual type definition.</span>
<span class="w">    </span><span class="n">composite_type</span><span class="p">:</span><span class="w"> </span><span class="nc">CompositeType</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">enum</span><span class="w"> </span><span class="nc">CompositeType</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Struct</span><span class="p">(</span><span class="n">StructType</span><span class="p">),</span>

<span class="w">    </span><span class="c1">// And eventually, this will have array types too.</span>
<span class="p">}</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">StructType</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Empty for now, but eventually will have fields.</span>
<span class="p">}</span>
</code></pre></div>
<p>When doing fixups/emitting a Wasm binary, we will create a map from rec group id to set of type ids for the types that are defined within it, since we need that to encode the rec group and its members. And then further in the future, we will have to do an SCC-based thing[^0] to merge rec groups together if there are cycles, since references to types across rec groups need to be acyclic (that is, type references can only be cyclic within the same rec group).</p>
<p>[^0]: FWIW, we have an <a href="https://github.com/bytecodealliance/wasmtime/blob/c7308165c6d92d3cb6334e1980800a024ce2d889/crates/wasmtime/src/compile/scc.rs#L31">existing implementation of Tarjan's SCC algorithm</a> in tree for our inliner. We could consider reusing that directly, or we could just copy and tweak some code. Will need to think more about this when we get to it.</p>
<p>Anyways, all that should give us a really good skeleton to start filling out everything else on top of.</p>
</blockquote>



<a name="535586499"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311487%20Add%20initial%20empty%20rec%20groups/near/535586499" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311487.20Add.20initial.20empty.20rec.20groups.html#535586499">(Aug 21 2025 at 22:14)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/11487#discussion_r2292238069">PR review comment</a>:</p>
<blockquote>
<p>And then we can add this in that next PR as well.</p>
</blockquote>



<a name="535586500"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311487%20Add%20initial%20empty%20rec%20groups/near/535586500" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311487.20Add.20initial.20empty.20rec.20groups.html#535586500">(Aug 21 2025 at 22:14)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/11487#discussion_r2292240369">PR review comment</a>:</p>
<blockquote>
<p>Kinda unexpected to have the "empty" ops contain a non-zero number of rec groups?</p>
</blockquote>



<a name="535589823"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311487%20Add%20initial%20empty%20rec%20groups/near/535589823" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311487.20Add.20initial.20empty.20rec.20groups.html#535589823">(Aug 21 2025 at 22:54)</a>:</h4>
<p>khagankhan submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11487#pullrequestreview-3142495912">PR review</a>.</p>



<a name="535589824"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311487%20Add%20initial%20empty%20rec%20groups/near/535589824" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311487.20Add.20initial.20empty.20rec.20groups.html#535589824">(Aug 21 2025 at 22:54)</a>:</h4>
<p>khagankhan created <a href="https://github.com/bytecodealliance/wasmtime/pull/11487#discussion_r2292293344">PR review comment</a>:</p>
<blockquote>
<p>Oh... Copy-paste error</p>
</blockquote>



<a name="535589914"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311487%20Add%20initial%20empty%20rec%20groups/near/535589914" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311487.20Add.20initial.20empty.20rec.20groups.html#535589914">(Aug 21 2025 at 22:55)</a>:</h4>
<p>khagankhan updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11487">PR #11487</a>.</p>



<a name="536524612"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311487%20Add%20initial%20empty%20rec%20groups/near/536524612" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311487.20Add.20initial.20empty.20rec.20groups.html#536524612">(Aug 28 2025 at 03:24)</a>:</h4>
<p>khagankhan updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11487">PR #11487</a>.</p>



<a name="536668160"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311487%20Add%20initial%20empty%20rec%20groups/near/536668160" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311487.20Add.20initial.20empty.20rec.20groups.html#536668160">(Aug 28 2025 at 19:02)</a>:</h4>
<p>khagankhan <a href="https://github.com/bytecodealliance/wasmtime/pull/11487#issuecomment-3234620437">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11487">PR #11487</a>:</p>
<blockquote>
<p>@fitzgen I guess it is ready for another round of review</p>
</blockquote>



<a name="536668216"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311487%20Add%20initial%20empty%20rec%20groups/near/536668216" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311487.20Add.20initial.20empty.20rec.20groups.html#536668216">(Aug 28 2025 at 19:02)</a>:</h4>
<p>khagankhan edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/11487#issuecomment-3234620437">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11487">PR #11487</a>:</p>
<blockquote>
<p>Thanks @fitzgen ! I guess it is ready for another round of review</p>
</blockquote>



<a name="536669151"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311487%20Add%20initial%20empty%20rec%20groups/near/536669151" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311487.20Add.20initial.20empty.20rec.20groups.html#536669151">(Aug 28 2025 at 19:09)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11487#pullrequestreview-3166172446">PR review</a>:</p>
<blockquote>
<p>Looks great!</p>
</blockquote>



<a name="536669333"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311487%20Add%20initial%20empty%20rec%20groups/near/536669333" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311487.20Add.20initial.20empty.20rec.20groups.html#536669333">(Aug 28 2025 at 19:10)</a>:</h4>
<p>khagankhan <a href="https://github.com/bytecodealliance/wasmtime/pull/11487#issuecomment-3234642087">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11487">PR #11487</a>:</p>
<blockquote>
<p>Thank you! Time to make new ones!!!!</p>
</blockquote>



<a name="536674112"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311487%20Add%20initial%20empty%20rec%20groups/near/536674112" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311487.20Add.20initial.20empty.20rec.20groups.html#536674112">(Aug 28 2025 at 19:49)</a>:</h4>
<p>fitzgen merged <a href="https://github.com/bytecodealliance/wasmtime/pull/11487">PR #11487</a>.</p>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
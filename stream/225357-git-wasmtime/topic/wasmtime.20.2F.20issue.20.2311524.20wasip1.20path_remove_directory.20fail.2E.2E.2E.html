<html>
<head><meta charset="utf-8"><title>wasmtime / issue #11524 wasip1 path_remove_directory fail... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311524.20wasip1.20path_remove_directory.20fail.2E.2E.2E.html">wasmtime / issue #11524 wasip1 path_remove_directory fail...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="535966434"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311524%20wasip1%20path_remove_directory%20fail.../near/535966434" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311524.20wasip1.20path_remove_directory.20fail.2E.2E.2E.html#535966434">(Aug 25 2025 at 07:13)</a>:</h4>
<p>wingo opened <a href="https://github.com/bytecodealliance/wasmtime/issues/11524">issue #11524</a>:</p>
<blockquote>
<h3>Test Case</h3>
<p>For the wasi-testsuite test <a href="https://github.com/WebAssembly/wasi-testsuite/blob/main/tests/rust/src/bin/remove_directory_trailing_slashes.rs#L19">remove_directory_trailing_slashes</a>, we mkdir <code>dir.cleanup</code>, then try to rrmdir <code>dir.cleanup/</code> (note trailing slash).  This fails because it uses the "get the parent then remove the leaf" strategy, and the parent of <code>dir.cleanup/</code> is <code>dir.cleanup</code>, and the leaf is <code>.</code>.</p>
<p>A trace: <a href="https://github.com/WebAssembly/wasi-testsuite/issues/101#issuecomment-3214123363">https://github.com/WebAssembly/wasi-testsuite/issues/101#issuecomment-3214123363</a></p>
<p>I would expect that the rmdir removes trailing slashes.</p>
<p>Filing this bug here as I am not sure if this is a failure of cap-std or if callers are required to remove trailing slashes already.</p>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: 1a88c70a6ec088ee213658488549306f8951405d (august 19)<br>
</p>
</blockquote>



<a name="535966436"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311524%20wasip1%20path_remove_directory%20fail.../near/535966436" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311524.20wasip1.20path_remove_directory.20fail.2E.2E.2E.html#535966436">(Aug 25 2025 at 07:13)</a>:</h4>
<p><a href="https://github.com/wingo">wingo</a> added the bug label to <a href="https://github.com/bytecodealliance/wasmtime/issues/11524">Issue #11524</a>.</p>



<a name="536039219"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311524%20wasip1%20path_remove_directory%20fail.../near/536039219" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311524.20wasip1.20path_remove_directory.20fail.2E.2E.2E.html#536039219">(Aug 25 2025 at 14:34)</a>:</h4>
<p><a href="https://github.com/alexcrichton">alexcrichton</a> added the wasi label to <a href="https://github.com/bytecodealliance/wasmtime/issues/11524">Issue #11524</a>.</p>



<a name="536039223"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311524%20wasip1%20path_remove_directory%20fail.../near/536039223" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311524.20wasip1.20path_remove_directory.20fail.2E.2E.2E.html#536039223">(Aug 25 2025 at 14:34)</a>:</h4>
<p><a href="https://github.com/alexcrichton">alexcrichton</a> added the wasi:impl label to <a href="https://github.com/bytecodealliance/wasmtime/issues/11524">Issue #11524</a>.</p>



<a name="536649317"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311524%20wasip1%20path_remove_directory%20fail.../near/536649317" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311524.20wasip1.20path_remove_directory.20fail.2E.2E.2E.html#536649317">(Aug 28 2025 at 16:57)</a>:</h4>
<p>fitzgen assigned sunfishcode to <a href="https://github.com/bytecodealliance/wasmtime/issues/11524">issue #11524</a>.</p>



<a name="537678032"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311524%20wasip1%20path_remove_directory%20fail.../near/537678032" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311524.20wasip1.20path_remove_directory.20fail.2E.2E.2E.html#537678032">(Sep 04 2025 at 13:52)</a>:</h4>
<p>wingo <a href="https://github.com/bytecodealliance/wasmtime/issues/11524#issuecomment-3253843726">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11524">issue #11524</a>:</p>
<blockquote>
<p>Given that cap-std needs to sometimes normalize paths, consider using some wrapper around <code>std::path::Path</code> for normalized paths.  Otherwise it's too easy to pass an absolute path to some routine that needs a normalized relative path.</p>
</blockquote>



<a name="537843126"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311524%20wasip1%20path_remove_directory%20fail.../near/537843126" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311524.20wasip1.20path_remove_directory.20fail.2E.2E.2E.html#537843126">(Sep 05 2025 at 10:52)</a>:</h4>
<p>wingo <a href="https://github.com/bytecodealliance/wasmtime/issues/11524#issuecomment-3257932134">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11524">issue #11524</a>:</p>
<blockquote>
<p>Same failure in wasip3:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">process</span><span class="p">;</span>
<span class="k">extern</span><span class="w"> </span><span class="k">crate</span><span class="w"> </span><span class="n">wit_bindgen</span><span class="p">;</span>

<span class="n">wit_bindgen</span><span class="p">::</span><span class="n">generate</span><span class="o">!</span><span class="p">({</span>
<span class="w">    </span><span class="n">inline</span><span class="p">:</span><span class="w"> </span><span class="nc">r</span><span class="s">"</span>
<span class="s">  package test:test;</span>

<span class="s">  world test {</span>
<span class="s">      include wasi:filesystem/imports@0.3.0-rc-2025-08-15;</span>
<span class="s">      include wasi:cli/command@0.3.0-rc-2025-08-15;</span>
<span class="s">  }</span>
<span class="s">"</span><span class="p">,</span>
<span class="w">    </span><span class="n">additional_derives</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="nb">PartialEq</span><span class="p">,</span><span class="w"> </span><span class="nb">Eq</span><span class="p">,</span><span class="w"> </span><span class="n">Hash</span><span class="p">,</span><span class="w"> </span><span class="nb">Clone</span><span class="p">],</span>
<span class="w">    </span><span class="c1">// Work around https://github.com/bytecodealliance/wasm-tools/issues/2285.</span>
<span class="w">    </span><span class="n">features</span><span class="p">:[</span><span class="s">"clocks-timezone"</span><span class="p">],</span>
<span class="w">    </span><span class="k">async</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="s">"wasi:cli/run@0.3.0-rc-2025-08-15#run"</span><span class="p">,</span>
<span class="w">    </span><span class="p">],</span>
<span class="w">    </span><span class="n">generate_all</span>
<span class="p">});</span>

<span class="k">use</span><span class="w"> </span><span class="n">wasi</span><span class="p">::</span><span class="n">filesystem</span><span class="p">::</span><span class="n">types</span><span class="p">::{</span><span class="n">PathFlags</span><span class="p">,</span><span class="n">ErrorCode</span><span class="p">};</span>

<span class="k">async</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">test_filesystem</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="o">&amp;</span><span class="n">wasi</span><span class="p">::</span><span class="n">filesystem</span><span class="p">::</span><span class="n">preopens</span><span class="p">::</span><span class="n">get_directories</span><span class="p">()[</span><span class="o">..</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">[(</span><span class="n">dirfd</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">)]</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">dirfd</span><span class="p">.</span><span class="n">create_directory_at</span><span class="p">(</span><span class="s">"qqq/"</span><span class="p">.</span><span class="n">to_string</span><span class="p">())</span>
<span class="w">                </span><span class="p">.</span><span class="k">await</span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">"mkdir qqq/"</span><span class="p">);</span>
<span class="w">            </span><span class="n">dirfd</span><span class="p">.</span><span class="n">remove_directory_at</span><span class="p">(</span><span class="s">"qqq/"</span><span class="p">.</span><span class="n">to_string</span><span class="p">())</span>
<span class="w">                </span><span class="p">.</span><span class="k">await</span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">"rmdir qqq/"</span><span class="p">);</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="p">[</span><span class="o">..</span><span class="p">]</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="fm">eprintln!</span><span class="p">(</span><span class="s">"usage: run with one open dir"</span><span class="p">);</span>
<span class="w">            </span><span class="n">process</span><span class="p">::</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">Component</span><span class="p">;</span>
<span class="n">export</span><span class="o">!</span><span class="p">(</span><span class="n">Component</span><span class="p">);</span>
<span class="k">impl</span><span class="w"> </span><span class="n">exports</span><span class="p">::</span><span class="n">wasi</span><span class="p">::</span><span class="n">cli</span><span class="p">::</span><span class="n">run</span><span class="p">::</span><span class="n">Guest</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Component</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">run</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">test_filesystem</span><span class="p">().</span><span class="k">await</span><span class="p">;</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">fn</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="fm">unreachable!</span><span class="p">(</span><span class="s">"main is a stub"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>The <code>mkdir qqq/</code> straces as:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">mkdirat</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="s">"qqq"</span><span class="p">,</span><span class="w"> </span><span class="mi">0777</span><span class="p">)</span><span class="w">                 </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
</code></pre></div>
<p>Whereas the <code>rmdir qqq/</code> straces as:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">openat2</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="s">"qqq/"</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">flags</span><span class="o">=</span><span class="n">O_RDONLY</span><span class="o">|</span><span class="n">O_CLOEXEC</span><span class="o">|</span><span class="n">O_PATH</span><span class="o">|</span><span class="n">O_DIRECTORY</span><span class="p">,</span><span class="w"> </span><span class="n">resolve</span><span class="o">=</span><span class="n">RESOLVE_NO_MAGICLINKS</span><span class="o">|</span><span class="n">RESOLVE_BENEATH</span><span class="p">},</span><span class="w"> </span><span class="mi">24</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">11</span>
<span class="n">unlinkat</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="s">"."</span><span class="p">,</span><span class="w"> </span><span class="n">AT_REMOVEDIR</span><span class="p">)</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="n">EINVAL</span><span class="w"> </span><span class="p">(</span><span class="n">Invalid</span><span class="w"> </span><span class="n">argument</span><span class="p">)</span>
</code></pre></div>
</blockquote>



<a name="543572620"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311524%20wasip1%20path_remove_directory%20fail.../near/543572620" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311524.20wasip1.20path_remove_directory.20fail.2E.2E.2E.html#543572620">(Oct 07 2025 at 16:16)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/11524#issuecomment-3377613811">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11524">issue #11524</a>:</p>
<blockquote>
<p>@sunfishcode are you still interested in investigating this?</p>
</blockquote>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
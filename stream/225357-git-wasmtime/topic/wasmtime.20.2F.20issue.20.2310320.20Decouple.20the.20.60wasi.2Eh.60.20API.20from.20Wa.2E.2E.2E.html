<html>
<head><meta charset="utf-8"><title>wasmtime / issue #10320 Decouple the `wasi.h` API from Wa... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310320.20Decouple.20the.20.60wasi.2Eh.60.20API.20from.20Wa.2E.2E.2E.html">wasmtime / issue #10320 Decouple the `wasi.h` API from Wa...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="503009158"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310320%20Decouple%20the%20%60wasi.h%60%20API%20from%20Wa.../near/503009158" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310320.20Decouple.20the.20.60wasi.2Eh.60.20API.20from.20Wa.2E.2E.2E.html#503009158">(Mar 03 2025 at 12:03)</a>:</h4>
<p>geraintluff opened <a href="https://github.com/bytecodealliance/wasmtime/issues/10320">issue #10320</a>:</p>
<blockquote>
<h4>Feature</h4>
<p>Can the <code>wasi.h</code> API be made generic, so that it only references <code>wasm.h</code>, and not any Wasmtime internals?</p>
<p>It's really close already, and I've detailed the exact changes below make it usable for this situation.</p>
<h4>Benefit</h4>
<p>Making the WASI API more generic would let users swap the implementation out, supporting straightforward WASI with other engines.</p>
<p>For example, I'm writing a library which uses a WASM engine through the official C API.  I'm testing it by linking to Wasmtime, but nothing in my code is Wasmtime-specific, so users <em>could</em> use alternatives (such as Bytecode Alliance's WAMR, which has a smaller binary footprint).</p>
<p>Wasmtime's implementation of the <code>wasi.h</code> API could still be tightly coupled to its <code>wasm.h</code> implementation, (i.e. knowing that <code>wasm_store_t *</code> was a particular Wasmtime class).</p>
<p>I'm writing a C++ implementation of such a WASI module, but it would be awesome to have Wasmtime's one spun out and usable independently, for security and performance reasons.</p>
<h4>Implementation</h4>
<p>I've added the following changes to Wasmtime's <code>wasi.h</code>:</p>
<ul>
<li>remove <code>#include &lt;wasmtime/conf.h&gt;</code> and <code>#ifdef WASMTIME_FEATURE_WASI</code></li>
<li>remove the <code>WASMTIME_</code> prefixes from the <code>wasi_dir_perms_flags</code>/<code>wasi_file_perms_flags</code> enums.</li>
<li>add a single function to resolve a WASI import:</li>
</ul>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="cm">/**</span>
<span class="cm"> * \brief returns a WASI import, or NULL if not supported by the config.</span>
<span class="cm"> *</span>
<span class="cm"> * The caller is expected to deallocate the returned import.</span>
<span class="cm"> *</span>
<span class="cm"> * The import is valid only for the lifetime of the supplied config and store.</span>
<span class="cm"> */</span>
<span class="n">WASI_API_EXTERN</span><span class="w"> </span><span class="n">wasm_extern_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">wasi_config_resolve</span><span class="p">(</span><span class="n">wasi_config_t</span><span class="w"> </span><span class="o">*</span><span class="n">config</span><span class="p">,</span>
<span class="w">                                                    </span><span class="n">wasm_store_t</span><span class="w"> </span><span class="o">*</span><span class="n">store</span><span class="p">,</span>
<span class="w">                                                    </span><span class="n">wasm_importtype_t</span><span class="w"> </span><span class="o">*</span><span class="n">type</span><span class="p">);</span>
</code></pre></div>
<h4>Alternatives</h4>
<p>Since I can't use an engine-agnostic WASI API, I'm _currently_ writing/using my own C++ library, which provides WASI for <em>any</em> WASM engine.</p>
<p>This would still be useful for other engines which don't (yet) provide their own <code>wasi.h</code>, but being able to use Wasmtime's (fast and secure) WASI implementation without being locked to Wasmtime specifically would be much preferable!</p>
</blockquote>



<a name="503016188"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310320%20Decouple%20the%20%60wasi.h%60%20API%20from%20Wa.../near/503016188" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310320.20Decouple.20the.20.60wasi.2Eh.60.20API.20from.20Wa.2E.2E.2E.html#503016188">(Mar 03 2025 at 12:40)</a>:</h4>
<p>geraintluff edited <a href="https://github.com/bytecodealliance/wasmtime/issues/10320">issue #10320</a>:</p>
<blockquote>
<h4>Feature</h4>
<p>Can the <code>wasi.h</code> API be made generic, so that it only references <code>wasm.h</code>, and not any Wasmtime internals?</p>
<p>It's really close already, and I've detailed the exact changes below make it usable for this situation.</p>
<h4>Benefit</h4>
<p>Making the WASI API more generic would let users swap the implementation out, supporting straightforward WASI with other engines.</p>
<p>For example, I'm writing a library which uses a WASM engine through the official C API.  I'm testing it by linking to Wasmtime, but nothing in my code is Wasmtime-specific, so users <em>could</em> link the library to alternatives (such as Bytecode Alliance's WAMR, which has a smaller binary footprint).</p>
<p>I can't (currently) use WASI the same way, so (to be engine-agnostic) I've ended up writing my own C++ WASI implementation.  It would be awesome to use Wasmtime's one (for security and performance) when using the Wasmtime engine, by just linking appropriately.  Wasmtime's implementation of the <code>wasi.h</code> API could still be tightly coupled to its <code>wasm.h</code> implementation, (i.e. knowing that <code>wasm_store_t *</code> was a particular Wasmtime class).</p>
<h4>Implementation</h4>
<p>I've added the following changes to Wasmtime's <code>wasi.h</code>:</p>
<ul>
<li>remove <code>#include &lt;wasmtime/conf.h&gt;</code> and <code>#ifdef WASMTIME_FEATURE_WASI</code></li>
<li>remove the <code>WASMTIME_</code> prefixes from the <code>wasi_dir_perms_flags</code>/<code>wasi_file_perms_flags</code> enums.</li>
<li>add a single function to resolve a WASI import:</li>
</ul>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="cm">/**</span>
<span class="cm"> * \brief returns a WASI import, or NULL if not supported by the config.</span>
<span class="cm"> *</span>
<span class="cm"> * The caller is expected to deallocate the returned import.</span>
<span class="cm"> *</span>
<span class="cm"> * The import is valid only for the lifetime of the supplied config and store.</span>
<span class="cm"> */</span>
<span class="n">WASI_API_EXTERN</span><span class="w"> </span><span class="n">wasm_extern_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">wasi_config_resolve</span><span class="p">(</span><span class="n">wasi_config_t</span><span class="w"> </span><span class="o">*</span><span class="n">config</span><span class="p">,</span>
<span class="w">                                                    </span><span class="n">wasm_store_t</span><span class="w"> </span><span class="o">*</span><span class="n">store</span><span class="p">,</span>
<span class="w">                                                    </span><span class="n">wasm_importtype_t</span><span class="w"> </span><span class="o">*</span><span class="n">type</span><span class="p">);</span>
</code></pre></div>
<h4>Alternatives</h4>
<p>Since I can't use an engine-agnostic WASI API, I'm _currently_ writing/using my own C++ library, which provides WASI for <em>any</em> WASM engine.</p>
<p>This would still be useful for other engines which don't (yet) provide their own <code>wasi.h</code>, but being able to use Wasmtime's (fast and secure) WASI implementation without being locked to Wasmtime specifically would be much preferable!</p>
</blockquote>



<a name="503016376"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310320%20Decouple%20the%20%60wasi.h%60%20API%20from%20Wa.../near/503016376" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310320.20Decouple.20the.20.60wasi.2Eh.60.20API.20from.20Wa.2E.2E.2E.html#503016376">(Mar 03 2025 at 12:40)</a>:</h4>
<p>geraintluff edited <a href="https://github.com/bytecodealliance/wasmtime/issues/10320">issue #10320</a>:</p>
<blockquote>
<h4>Feature</h4>
<p>Can the <code>wasi.h</code> API be made generic, so that it only references <code>wasm.h</code>, and not any Wasmtime internals?</p>
<p>It's really close already, and I've detailed the exact changes below make it usable for this situation.</p>
<h4>Benefit</h4>
<p>Making the WASI API more generic would let users swap the implementation out, supporting straightforward WASI with other engines.</p>
<p>For example, I'm writing a library which uses a WASM engine through the official C API.  I'm testing it by linking to Wasmtime, but nothing in my code is Wasmtime-specific, so users <em>could</em> link the library to alternatives (such as Bytecode Alliance's WAMR, which has a smaller binary footprint).</p>
<p>I can't (currently) use WASI the same way, so (to be engine-agnostic) I've ended up writing my own C++ WASI implementation, which uses the engine entirely through the WASM C API.  It would be awesome to use Wasmtime's one (for security and performance) when using the Wasmtime engine, by just linking appropriately.  Wasmtime's implementation of the <code>wasi.h</code> API could still be tightly coupled to its <code>wasm.h</code> implementation, (i.e. knowing that <code>wasm_store_t *</code> was a particular Wasmtime class).</p>
<h4>Implementation</h4>
<p>I've added the following changes to Wasmtime's <code>wasi.h</code>:</p>
<ul>
<li>remove <code>#include &lt;wasmtime/conf.h&gt;</code> and <code>#ifdef WASMTIME_FEATURE_WASI</code></li>
<li>remove the <code>WASMTIME_</code> prefixes from the <code>wasi_dir_perms_flags</code>/<code>wasi_file_perms_flags</code> enums.</li>
<li>add a single function to resolve a WASI import:</li>
</ul>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="cm">/**</span>
<span class="cm"> * \brief returns a WASI import, or NULL if not supported by the config.</span>
<span class="cm"> *</span>
<span class="cm"> * The caller is expected to deallocate the returned import.</span>
<span class="cm"> *</span>
<span class="cm"> * The import is valid only for the lifetime of the supplied config and store.</span>
<span class="cm"> */</span>
<span class="n">WASI_API_EXTERN</span><span class="w"> </span><span class="n">wasm_extern_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">wasi_config_resolve</span><span class="p">(</span><span class="n">wasi_config_t</span><span class="w"> </span><span class="o">*</span><span class="n">config</span><span class="p">,</span>
<span class="w">                                                    </span><span class="n">wasm_store_t</span><span class="w"> </span><span class="o">*</span><span class="n">store</span><span class="p">,</span>
<span class="w">                                                    </span><span class="n">wasm_importtype_t</span><span class="w"> </span><span class="o">*</span><span class="n">type</span><span class="p">);</span>
</code></pre></div>
<h4>Alternatives</h4>
<p>Since I can't use an engine-agnostic WASI API, I'm _currently_ writing/using my own C++ library, which provides WASI for <em>any</em> WASM engine.</p>
<p>This would still be useful for other engines which don't (yet) provide their own <code>wasi.h</code>, but being able to use Wasmtime's (fast and secure) WASI implementation without being locked to Wasmtime specifically would be much preferable!</p>
</blockquote>



<a name="503021141"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310320%20Decouple%20the%20%60wasi.h%60%20API%20from%20Wa.../near/503021141" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310320.20Decouple.20the.20.60wasi.2Eh.60.20API.20from.20Wa.2E.2E.2E.html#503021141">(Mar 03 2025 at 13:04)</a>:</h4>
<p>geraintluff edited <a href="https://github.com/bytecodealliance/wasmtime/issues/10320">issue #10320</a>:</p>
<blockquote>
<h4>Feature</h4>
<p>Can the <code>wasi.h</code> API be made generic, so that it only references <code>wasm.h</code>, and not any Wasmtime internals?</p>
<p>It's really close already, and I've detailed the exact changes below make it usable for this situation.</p>
<h4>Benefit</h4>
<p>Making the WASI API more generic would let users swap the implementation out, supporting straightforward WASI with other engines.</p>
<p>For example, I'm writing a library which uses a WASM engine through the official C API.  I'm testing it by linking to Wasmtime, but nothing in my code is Wasmtime-specific, so users <em>could</em> link the library to alternatives (such as Bytecode Alliance's WAMR, which has a smaller binary footprint).</p>
<p>I can't (currently) use WASI the same way.  It would be awesome to use Wasmtime's one (for security and performance) when using the Wasmtime engine, or a more generic fallback one, just by linking differently.  Wasmtime's implementation of the <code>wasi.h</code> API could still be tightly coupled to its <code>wasm.h</code> implementation, (i.e. knowing that <code>wasm_store_t *</code> was a particular Wasmtime class).</p>
<h4>Implementation</h4>
<p>I've added the following changes to Wasmtime's <code>wasi.h</code>:</p>
<ul>
<li>remove <code>#include &lt;wasmtime/conf.h&gt;</code> and <code>#ifdef WASMTIME_FEATURE_WASI</code></li>
<li>remove the <code>WASMTIME_</code> prefixes from the <code>wasi_dir_perms_flags</code>/<code>wasi_file_perms_flags</code> enums.</li>
<li>add a single function to resolve a WASI import:</li>
</ul>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="cm">/**</span>
<span class="cm"> * \brief returns a WASI import, or NULL if not supported by the config.</span>
<span class="cm"> *</span>
<span class="cm"> * The caller is expected to deallocate the returned import.</span>
<span class="cm"> *</span>
<span class="cm"> * The import is valid only for the lifetime of the supplied config and store.</span>
<span class="cm"> */</span>
<span class="n">WASI_API_EXTERN</span><span class="w"> </span><span class="n">wasm_extern_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">wasi_config_resolve</span><span class="p">(</span><span class="n">wasi_config_t</span><span class="w"> </span><span class="o">*</span><span class="n">config</span><span class="p">,</span>
<span class="w">                                                    </span><span class="n">wasm_store_t</span><span class="w"> </span><span class="o">*</span><span class="n">store</span><span class="p">,</span>
<span class="w">                                                    </span><span class="n">wasm_importtype_t</span><span class="w"> </span><span class="o">*</span><span class="n">type</span><span class="p">);</span>
</code></pre></div>
<h4>Alternatives</h4>
<p>To be engine-agnostic, I'm _currently_ writing/using my own C++ library which provides the above API, entirely through the WASM C API so it works with any WASM engine.</p>
<p>Unfortunately, this means I can't use Wasmtime's (fast and secure) WASI implementation unless I put some gnarly Wasmtime-specific <code>#ifdef</code>s in the code.</p>
</blockquote>



<a name="503022220"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310320%20Decouple%20the%20%60wasi.h%60%20API%20from%20Wa.../near/503022220" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310320.20Decouple.20the.20.60wasi.2Eh.60.20API.20from.20Wa.2E.2E.2E.html#503022220">(Mar 03 2025 at 13:09)</a>:</h4>
<p>geraintluff edited <a href="https://github.com/bytecodealliance/wasmtime/issues/10320">issue #10320</a>:</p>
<blockquote>
<h4>Feature</h4>
<p>Can the <code>wasi.h</code> API be made generic, so that it only references <code>wasm.h</code>, and not any Wasmtime internals?</p>
<p>It's really close already, and I've detailed the exact changes below which would make it usable for this.</p>
<h4>Benefit</h4>
<p>Making the WASI API more generic would let users swap the implementation out, supporting straightforward WASI with other engines.</p>
<p>For example, I'm writing a library which uses a WASM engine through the official C API.  I'm testing it by linking to Wasmtime, but nothing in my code is Wasmtime-specific, so users <em>could</em> link the library to alternatives (such as Bytecode Alliance's WAMR, which has a smaller binary footprint).</p>
<p>I can't (currently) use WASI the same way.  It would be awesome to use Wasmtime's one (for security and performance) when using the Wasmtime engine, or a more generic fallback one, just by linking differently.  Wasmtime's implementation of the <code>wasi.h</code> API could still be tightly coupled to its <code>wasm.h</code> implementation, (i.e. knowing that <code>wasm_store_t *</code> was a particular Wasmtime class).</p>
<h4>Implementation</h4>
<p>I've added the following changes to Wasmtime's <code>wasi.h</code>:</p>
<ul>
<li>remove <code>#include &lt;wasmtime/conf.h&gt;</code> and <code>#ifdef WASMTIME_FEATURE_WASI</code></li>
<li>remove the <code>WASMTIME_</code> prefixes from the <code>wasi_dir_perms_flags</code>/<code>wasi_file_perms_flags</code> enums.</li>
<li>add a single function to resolve a WASI import:</li>
</ul>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="cm">/**</span>
<span class="cm"> * \brief returns a WASI import, or NULL if not supported by the config.</span>
<span class="cm"> *</span>
<span class="cm"> * The caller is expected to deallocate the returned import.</span>
<span class="cm"> *</span>
<span class="cm"> * The import is valid only for the lifetime of the supplied config and store.</span>
<span class="cm"> */</span>
<span class="n">WASI_API_EXTERN</span><span class="w"> </span><span class="n">wasm_extern_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">wasi_config_resolve</span><span class="p">(</span><span class="n">wasi_config_t</span><span class="w"> </span><span class="o">*</span><span class="n">config</span><span class="p">,</span>
<span class="w">                                                    </span><span class="n">wasm_store_t</span><span class="w"> </span><span class="o">*</span><span class="n">store</span><span class="p">,</span>
<span class="w">                                                    </span><span class="n">wasm_importtype_t</span><span class="w"> </span><span class="o">*</span><span class="n">type</span><span class="p">);</span>
</code></pre></div>
<h4>Alternatives</h4>
<p>To be engine-agnostic, I'm _currently_ writing/using my own C++ library which provides the above API, entirely through the WASM C API so it works with any WASM engine.</p>
<p>Unfortunately, this means I can't use Wasmtime's (fast and secure) WASI implementation unless I put some gnarly Wasmtime-specific <code>#ifdef</code>s in the code.</p>
</blockquote>



<a name="503022327"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310320%20Decouple%20the%20%60wasi.h%60%20API%20from%20Wa.../near/503022327" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310320.20Decouple.20the.20.60wasi.2Eh.60.20API.20from.20Wa.2E.2E.2E.html#503022327">(Mar 03 2025 at 13:10)</a>:</h4>
<p>geraintluff edited <a href="https://github.com/bytecodealliance/wasmtime/issues/10320">issue #10320</a>:</p>
<blockquote>
<h4>Feature</h4>
<p>Can the <code>wasi.h</code> API be made generic, so that it only references <code>wasm.h</code>, and not any Wasmtime internals?</p>
<p>It's really close already, and I've detailed the exact changes below which would make it usable for this.</p>
<h4>Benefit</h4>
<p>Making the WASI API more generic would let users swap the implementation out, supporting straightforward WASI with other engines.</p>
<p>For example, I'm writing a library which uses a WASM engine through the official C API.  I'm testing it by linking to Wasmtime, but nothing in my code is Wasmtime-specific, so users <em>could</em> link the library to alternatives (such as Bytecode Alliance's WAMR, which has a smaller binary footprint) with no code changes.</p>
<p>I can't (currently) use WASI the same way.  It would be awesome to use Wasmtime's one (for security and performance) when using the Wasmtime engine, or a more generic fallback one, just by linking differently.  Wasmtime's implementation of the <code>wasi.h</code> API could still be tightly coupled to its <code>wasm.h</code> implementation, (i.e. knowing that <code>wasm_store_t *</code> was a particular Wasmtime class).</p>
<h4>Implementation</h4>
<p>I've added the following changes to Wasmtime's <code>wasi.h</code>:</p>
<ul>
<li>remove <code>#include &lt;wasmtime/conf.h&gt;</code> and <code>#ifdef WASMTIME_FEATURE_WASI</code></li>
<li>remove the <code>WASMTIME_</code> prefixes from the <code>wasi_dir_perms_flags</code>/<code>wasi_file_perms_flags</code> enums.</li>
<li>add a single function to resolve a WASI import:</li>
</ul>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="cm">/**</span>
<span class="cm"> * \brief returns a WASI import, or NULL if not supported by the config.</span>
<span class="cm"> *</span>
<span class="cm"> * The caller is expected to deallocate the returned import.</span>
<span class="cm"> *</span>
<span class="cm"> * The import is valid only for the lifetime of the supplied config and store.</span>
<span class="cm"> */</span>
<span class="n">WASI_API_EXTERN</span><span class="w"> </span><span class="n">wasm_extern_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">wasi_config_resolve</span><span class="p">(</span><span class="n">wasi_config_t</span><span class="w"> </span><span class="o">*</span><span class="n">config</span><span class="p">,</span>
<span class="w">                                                    </span><span class="n">wasm_store_t</span><span class="w"> </span><span class="o">*</span><span class="n">store</span><span class="p">,</span>
<span class="w">                                                    </span><span class="n">wasm_importtype_t</span><span class="w"> </span><span class="o">*</span><span class="n">type</span><span class="p">);</span>
</code></pre></div>
<h4>Alternatives</h4>
<p>To be engine-agnostic, I'm _currently_ writing/using my own C++ library which provides the above API, entirely through the WASM C API so it works with any WASM engine.</p>
<p>Unfortunately, this means I can't use Wasmtime's (fast and secure) WASI implementation unless I put some gnarly Wasmtime-specific <code>#ifdef</code>s in the code.</p>
</blockquote>



<a name="503024085"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310320%20Decouple%20the%20%60wasi.h%60%20API%20from%20Wa.../near/503024085" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310320.20Decouple.20the.20.60wasi.2Eh.60.20API.20from.20Wa.2E.2E.2E.html#503024085">(Mar 03 2025 at 13:18)</a>:</h4>
<p>geraintluff edited <a href="https://github.com/bytecodealliance/wasmtime/issues/10320">issue #10320</a>:</p>
<blockquote>
<h4>Feature</h4>
<p>Can the <code>wasi.h</code> API be made generic, so that it only references <code>wasm.h</code>, and not any Wasmtime internals?</p>
<p>It's really close already, and I've detailed the exact changes below which would make it usable for this.</p>
<h4>Benefit</h4>
<p>Making the WASI API more generic would let users swap the implementation out, supporting straightforward WASI with other engines.</p>
<p>For example, I'm writing a library which uses a WASM engine through the official C API.  I'm testing it by linking to Wasmtime, but nothing in my code is Wasmtime-specific, so users <em>could</em> link the library to alternatives (such as Bytecode Alliance's WAMR, which has a smaller binary footprint) with no code changes.</p>
<p>I can't (currently) use WASI the same way.  It would be awesome to use Wasmtime's one (for security and performance) when using the Wasmtime engine, or a more generic fallback one, just by linking differently.  Wasmtime's implementation of the <code>wasi.h</code> API could still be tightly coupled to its <code>wasm.h</code> implementation, (i.e. knowing that <code>wasm_store_t *</code> was a particular Wasmtime class).</p>
<h4>Implementation</h4>
<p>I've added the following changes to Wasmtime's <code>wasi.h</code>:</p>
<ul>
<li>remove <code>#include &lt;wasmtime/conf.h&gt;</code> and <code>#ifdef WASMTIME_FEATURE_WASI</code></li>
<li>remove the <code>WASMTIME_</code> prefixes from the <code>wasi_dir_perms_flags</code>/<code>wasi_file_perms_flags</code> enums.</li>
<li>add a single function to resolve a WASI import:</li>
</ul>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="cm">/**</span>
<span class="cm"> * \brief returns a WASI import, or NULL if not supported by the config.</span>
<span class="cm"> *</span>
<span class="cm"> * The caller is expected to deallocate the returned import.</span>
<span class="cm"> *</span>
<span class="cm"> * The import is valid only for the lifetime of the supplied config and store.</span>
<span class="cm"> */</span>
<span class="n">WASI_API_EXTERN</span><span class="w"> </span><span class="n">wasm_extern_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">wasi_config_resolve</span><span class="p">(</span><span class="n">wasi_config_t</span><span class="w"> </span><span class="o">*</span><span class="n">config</span><span class="p">,</span>
<span class="w">                                                    </span><span class="n">wasm_store_t</span><span class="w"> </span><span class="o">*</span><span class="n">store</span><span class="p">,</span>
<span class="w">                                                    </span><span class="k">const</span><span class="w"> </span><span class="n">wasm_importtype_t</span><span class="w"> </span><span class="o">*</span><span class="n">type</span><span class="p">);</span>
</code></pre></div>
<h4>Alternatives</h4>
<p>To be engine-agnostic, I'm _currently_ writing/using my own C++ library which provides the above API, entirely through the WASM C API so it works with any WASM engine.</p>
<p>Unfortunately, this means I can't use Wasmtime's (fast and secure) WASI implementation unless I put some gnarly Wasmtime-specific <code>#ifdef</code>s in the code.</p>
</blockquote>



<a name="503064055"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310320%20Decouple%20the%20%60wasi.h%60%20API%20from%20Wa.../near/503064055" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310320.20Decouple.20the.20.60wasi.2Eh.60.20API.20from.20Wa.2E.2E.2E.html#503064055">(Mar 03 2025 at 16:04)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/10320#issuecomment-2694868429">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10320">issue #10320</a>:</p>
<blockquote>
<p>Personally I would not recommend using the <code>wasm.h</code> C API. It is less safe and less performant than Wasmtime's custom C API. For this reason I've additionally wanted to historically move in the direction of making <code>wasi.h</code> more like <code>wasmtime/wasi.h</code> and making it Wasmtime-specific. It was originally envisioned as the start of a standard but that hasn't really panned out so we've had various pressures historically pushing in the direction of integrating it more tightly and changing it over time.</p>
<blockquote>
<p>which has a smaller binary footprint</p>
</blockquote>
<p>This should not be the case in theory, if you find a drastic difference we have <a href="https://docs.wasmtime.dev/examples-minimal.html">documentation on producing minimal builds</a> and if a large different still remains we'd appreciate a bug report!</p>
</blockquote>



<a name="503083839"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310320%20Decouple%20the%20%60wasi.h%60%20API%20from%20Wa.../near/503083839" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310320.20Decouple.20the.20.60wasi.2Eh.60.20API.20from.20Wa.2E.2E.2E.html#503083839">(Mar 03 2025 at 17:27)</a>:</h4>
<p>geraintluff <a href="https://github.com/bytecodealliance/wasmtime/issues/10320#issuecomment-2695083458">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10320">issue #10320</a>:</p>
<blockquote>
<p>So you reckon the WASM C API is a bad idea, and would prefer each library to be tied to a particular WASM engine?</p>
<p>For what it's worth, if the WASM C API hadn't made it so easy to switch, I would still be using Wasmer.  It's what I started with, and it lets you use the <a href="https://wasmer.io/posts/wasmer-3_3-and-javascriptcore">JavaScriptCore WebAssembly engine</a> (so you don't even need to ship a compiler/JIT for MacOS).</p>
</blockquote>



<a name="503117191"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310320%20Decouple%20the%20%60wasi.h%60%20API%20from%20Wa.../near/503117191" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310320.20Decouple.20the.20.60wasi.2Eh.60.20API.20from.20Wa.2E.2E.2E.html#503117191">(Mar 03 2025 at 20:26)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/10320#issuecomment-2695462687">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10320">issue #10320</a>:</p>
<blockquote>
<p>I'm pointing out that this issue is unlikely to happen in my opinion since we've generally gone in the opposite direction of <code>wasm.h</code>.  That does not mean it shouldn't be done nor that it won't be done, just that from my own personal perspective it's probably not worth doing. I don't mean to stifle development of <code>wasm.h</code> or a hypothetical "official" <code>wasi.h</code> either. </p>
<p>The topic of the quality fo the <code>wasm.h</code> API is probably a bit orthogonal to this issue. I brought it up to motivate why I have the rationale I do, but if you'd like to dig into that it's probably best to do so on Zulip for example or in a dedicated location.</p>
</blockquote>



<a name="503232307"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310320%20Decouple%20the%20%60wasi.h%60%20API%20from%20Wa.../near/503232307" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310320.20Decouple.20the.20.60wasi.2Eh.60.20API.20from.20Wa.2E.2E.2E.html#503232307">(Mar 04 2025 at 10:35)</a>:</h4>
<p>geraintluff <a href="https://github.com/bytecodealliance/wasmtime/issues/10320#issuecomment-2697013961">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10320">issue #10320</a>:</p>
<blockquote>
<p>What (in your opinion) are the chances of _removing_ the <code>wasi.h</code> exports then, and using Wasmtime-only names instead of something that looks like it should be generic?</p>
<p>At the moment, I've had to do some awkward linking tricks to stop the Wasmtime exports from clashing with my own implementation.  I like the <code>wasi.h</code> API (with the above changes) and would like to provide something with that API.</p>
</blockquote>



<a name="503232535"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310320%20Decouple%20the%20%60wasi.h%60%20API%20from%20Wa.../near/503232535" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310320.20Decouple.20the.20.60wasi.2Eh.60.20API.20from.20Wa.2E.2E.2E.html#503232535">(Mar 04 2025 at 10:37)</a>:</h4>
<p>geraintluff edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/10320#issuecomment-2697013961">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10320">issue #10320</a>:</p>
<blockquote>
<p>What (in your opinion) are the chances of _removing_ the <code>wasi.h</code> exports then, and using Wasmtime-only names instead of something that looks like it should be generic?</p>
<p>At the moment, I've had to do some awkward linking tricks to stop the Wasmtime exports from clashing with my own implementation.  I like the <code>wasi.h</code> API (with the above changes) and would like to provide something with that interface, particularly if Wasmtime isn't interested in it.</p>
</blockquote>



<a name="503232563"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310320%20Decouple%20the%20%60wasi.h%60%20API%20from%20Wa.../near/503232563" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310320.20Decouple.20the.20.60wasi.2Eh.60.20API.20from.20Wa.2E.2E.2E.html#503232563">(Mar 04 2025 at 10:37)</a>:</h4>
<p>geraintluff edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/10320#issuecomment-2697013961">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10320">issue #10320</a>:</p>
<blockquote>
<p>What (in your opinion) are the chances of _removing_ the <code>wasi.h</code> exports then, and using Wasmtime-only names instead of something that looks like it should be generic?</p>
<p>At the moment, I've had to do some awkward linking tricks to stop the Wasmtime exports from clashing with my own implementation.  I like the <code>wasi.h</code> API (with the above changes) and would like to provide something with that interface, particularly if Wasmtime isn't interested in filling the same gap.</p>
</blockquote>



<a name="503233851"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310320%20Decouple%20the%20%60wasi.h%60%20API%20from%20Wa.../near/503233851" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310320.20Decouple.20the.20.60wasi.2Eh.60.20API.20from.20Wa.2E.2E.2E.html#503233851">(Mar 04 2025 at 10:44)</a>:</h4>
<p>geraintluff edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/10320#issuecomment-2697013961">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10320">issue #10320</a>:</p>
<blockquote>
<p>What (in your opinion) are the chances of _removing_ the <code>wasi.h</code> exports then, and using Wasmtime-only names instead of something that looks like it should be generic?</p>
<p>At the moment, I've had to do some awkward linking tricks to stop the Wasmtime exports from clashing with my own implementation.  I like the <code>wasi.h</code> API (with the above changes) and would like to provide something with that interface - something independent and engine-agnostic, plus a wrapper around Wasmtime-coupled one if possible.</p>
</blockquote>



<a name="503522295"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310320%20Decouple%20the%20%60wasi.h%60%20API%20from%20Wa.../near/503522295" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310320.20Decouple.20the.20.60wasi.2Eh.60.20API.20from.20Wa.2E.2E.2E.html#503522295">(Mar 05 2025 at 13:56)</a>:</h4>
<p>geraintluff closed <a href="https://github.com/bytecodealliance/wasmtime/issues/10320">issue #10320</a>:</p>
<blockquote>
<h4>Feature</h4>
<p>Can the <code>wasi.h</code> API be made generic, so that it only references <code>wasm.h</code>, and not any Wasmtime internals?</p>
<p>It's really close already, and I've detailed the exact changes below which would make it usable for this.</p>
<h4>Benefit</h4>
<p>Making the WASI API more generic would let users swap the implementation out, supporting straightforward WASI with other engines.</p>
<p>For example, I'm writing a library which uses a WASM engine through the official C API.  I'm testing it by linking to Wasmtime, but nothing in my code is Wasmtime-specific, so users <em>could</em> link the library to alternatives (such as Bytecode Alliance's WAMR, which has a smaller binary footprint) with no code changes.</p>
<p>I can't (currently) use WASI the same way.  It would be awesome to use Wasmtime's one (for security and performance) when using the Wasmtime engine, or a more generic fallback one, just by linking differently.  Wasmtime's implementation of the <code>wasi.h</code> API could still be tightly coupled to its <code>wasm.h</code> implementation, (i.e. knowing that <code>wasm_store_t *</code> was a particular Wasmtime class).</p>
<h4>Implementation</h4>
<p>I've added the following changes to Wasmtime's <code>wasi.h</code>:</p>
<ul>
<li>remove <code>#include &lt;wasmtime/conf.h&gt;</code> and <code>#ifdef WASMTIME_FEATURE_WASI</code></li>
<li>remove the <code>WASMTIME_</code> prefixes from the <code>wasi_dir_perms_flags</code>/<code>wasi_file_perms_flags</code> enums.</li>
<li>add a single function to resolve a WASI import:</li>
</ul>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="cm">/**</span>
<span class="cm"> * \brief returns a WASI import, or NULL if not supported by the config.</span>
<span class="cm"> *</span>
<span class="cm"> * The caller is expected to deallocate the returned import.</span>
<span class="cm"> *</span>
<span class="cm"> * The import is valid only for the lifetime of the supplied config and store.</span>
<span class="cm"> */</span>
<span class="n">WASI_API_EXTERN</span><span class="w"> </span><span class="n">wasm_extern_t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">wasi_config_resolve</span><span class="p">(</span><span class="n">wasi_config_t</span><span class="w"> </span><span class="o">*</span><span class="n">config</span><span class="p">,</span>
<span class="w">                                                    </span><span class="n">wasm_store_t</span><span class="w"> </span><span class="o">*</span><span class="n">store</span><span class="p">,</span>
<span class="w">                                                    </span><span class="k">const</span><span class="w"> </span><span class="n">wasm_importtype_t</span><span class="w"> </span><span class="o">*</span><span class="n">type</span><span class="p">);</span>
</code></pre></div>
<h4>Alternatives</h4>
<p>To be engine-agnostic, I'm _currently_ writing/using my own C++ library which provides the above API, entirely through the WASM C API so it works with any WASM engine.</p>
<p>Unfortunately, this means I can't use Wasmtime's (fast and secure) WASI implementation unless I put some gnarly Wasmtime-specific <code>#ifdef</code>s in the code.</p>
</blockquote>



<a name="503522299"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310320%20Decouple%20the%20%60wasi.h%60%20API%20from%20Wa.../near/503522299" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310320.20Decouple.20the.20.60wasi.2Eh.60.20API.20from.20Wa.2E.2E.2E.html#503522299">(Mar 05 2025 at 13:56)</a>:</h4>
<p>geraintluff <a href="https://github.com/bytecodealliance/wasmtime/issues/10320#issuecomment-2701019911">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10320">issue #10320</a>:</p>
<blockquote>
<p>OK, so Wasmtime's <code>wasm.h</code> interface actually aborts on a key operation I needed (calling a function by index in a function table), so I can't use it, WASI or not.</p>
<p>Closing as no longer relevant.</p>
</blockquote>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
<html>
<head><meta charset="utf-8"><title>wasmtime / issue #11753 GC-related panic and hangs · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311753.20GC-related.20panic.20and.20hangs.html">wasmtime / issue #11753 GC-related panic and hangs</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="542016320"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311753%20GC-related%20panic%20and%20hangs/near/542016320" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311753.20GC-related.20panic.20and.20hangs.html#542016320">(Sep 29 2025 at 11:51)</a>:</h4>
<p>id-ilych opened <a href="https://github.com/bytecodealliance/wasmtime/issues/11753">issue #11753</a>:</p>
<blockquote>
<h3>Test Case</h3>
<p>The form does not allow WASM attachments, so here is the link<br>
<a href="https://github.com/id-ilych/wasmtime-bugreport/raw/3eddc3cab6fa/host/guest.wasm">https://github.com/id-ilych/wasmtime-bugreport/raw/3eddc3cab6fa/host/guest.wasm</a></p>
<p>The host code</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">error</span><span class="p">::</span><span class="n">Error</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>

<span class="k">fn</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">arg_a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">env</span><span class="p">::</span><span class="n">args</span><span class="p">().</span><span class="n">nth</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">unwrap</span><span class="p">().</span><span class="n">parse</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">arg_b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">env</span><span class="p">::</span><span class="n">args</span><span class="p">().</span><span class="n">nth</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="n">unwrap</span><span class="p">().</span><span class="n">parse</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">arg_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">env</span><span class="p">::</span><span class="n">args</span><span class="p">().</span><span class="n">nth</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="n">unwrap</span><span class="p">().</span><span class="n">parse</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">arg_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">env</span><span class="p">::</span><span class="n">args</span><span class="p">().</span><span class="n">nth</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span><span class="n">unwrap</span><span class="p">().</span><span class="n">parse</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">arg_z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">env</span><span class="p">::</span><span class="n">args</span><span class="p">().</span><span class="n">nth</span><span class="p">(</span><span class="mi">5</span><span class="p">).</span><span class="n">unwrap</span><span class="p">().</span><span class="n">parse</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Engine</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">Config</span><span class="p">::</span><span class="n">default</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">gc_support</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">wasm_gc</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">wasm_exceptions</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">wasm_reference_types</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">wasm_function_references</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">allocation_strategy</span><span class="p">(</span><span class="n">PoolingAllocationConfig</span><span class="p">::</span><span class="n">new</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="n">max_memory_size</span><span class="p">(</span><span class="mi">1_000_000</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">to_owned</span><span class="p">()</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">    </span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Module</span><span class="p">::</span><span class="n">from_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="s">"guest.wasm"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Linker</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">);</span>
<span class="w">    </span><span class="n">linker</span><span class="p">.</span><span class="n">func_wrap</span><span class="p">(</span><span class="s">"wasi_snapshot_preview1"</span><span class="p">,</span><span class="w"> </span><span class="s">"random_get"</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">_</span><span class="p">:</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">:</span><span class="w"> </span><span class="kt">i32</span><span class="o">|</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="p">})</span><span class="o">?</span><span class="p">;</span><span class="w"> </span><span class="c1">// Errno::Io</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">instantiate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">(</span><span class="n">Store</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">TypedFunc</span><span class="o">&lt;</span><span class="p">(</span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">),</span><span class="w"> </span><span class="kt">i32</span><span class="o">&gt;</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Store</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="p">());</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">linker</span><span class="p">.</span><span class="n">instantiate</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">module</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">initialize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instance</span><span class="p">.</span><span class="n">get_typed_func</span><span class="p">::</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">"_initialize"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="n">initialize</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="p">())</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instance</span><span class="p">.</span><span class="n">get_typed_func</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">"memtest"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">((</span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="n">func</span><span class="p">))</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="n">store_a</span><span class="p">,</span><span class="w"> </span><span class="n">func_a</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instantiate</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="n">store_b</span><span class="p">,</span><span class="w"> </span><span class="n">func_b</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instantiate</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="mi">100</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">arg_a</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="p">:</span><span class="kt">i32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_a</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store_a</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">arg_a</span><span class="p">,</span><span class="w"> </span><span class="n">arg_x</span><span class="p">,</span><span class="w"> </span><span class="n">arg_y</span><span class="p">,</span><span class="w"> </span><span class="n">arg_z</span><span class="p">))</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">arg_b</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="p">:</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_b</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store_b</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">arg_b</span><span class="p">,</span><span class="w"> </span><span class="n">arg_x</span><span class="p">,</span><span class="w"> </span><span class="n">arg_y</span><span class="p">,</span><span class="w"> </span><span class="n">arg_z</span><span class="p">))</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>
<p>You can find the whole project (including original Kotlin code for the guest) here:<br>
<a href="https://github.com/id-ilych/wasmtime-bugreport/tree/3eddc3cab6fa">https://github.com/id-ilych/wasmtime-bugreport/tree/3eddc3cab6fa</a></p>
<h3>Steps to Reproduce</h3>
<p><span aria-label="warning" class="emoji emoji-26a0" role="img" title="warning">:warning:</span> Each command listed here fails (or hangs), particular panics for each case are listed in Actual Results section</p>
<ol>
<li><code>RUST_BACKTRACE=1 cargo run --release 10000 7500 1 1 1</code></li>
<li><code>RUST_BACKTRACE=1 cargo run --release 10000 11000 1 1 1</code></li>
<li><code>RUST_BACKTRACE=1 cargo run 10000 7500 1 1 1</code></li>
<li><code>RUST_BACKTRACE=1 cargo run 10000 11000 1 1 1</code></li>
<li><code>RUST_BACKTRACE=1 cargo run --release 10000 7500 3 2 1</code></li>
<li><code>RUST_BACKTRACE=1 cargo run --release 22000 0 1 2 3</code></li>
<li><code>RUST_BACKTRACE=1 cargo run --release 12025 17812 5 5 5</code></li>
<li><code>RUST_BACKTRACE=1 cargo run --release 15202 17813 2 1 1</code></li>
</ol>
<h3>Expected Results</h3>
<p>Program finishes successfully (prints numbers from 0 to 99 (incl))</p>
<h3>Actual Results</h3>
<p>Command 1 produces "<code>Option::unwrap()</code> on a <code>None</code> value" panic in <code>wasmtime-37.0.1/src/runtime/vm/gc/gc_runtime.rs:463:44 </code></p>
<p>Command 2 produces "range start index 6553700 out of range for slice of length 524288" panic in <code>wasmtime-37.0.1/src/runtime/vm/gc/gc_runtime.rs:466:47</code></p>
<p>Commands 3 and 4 each cause <code>self.is_in_over_approximated_stack_roots()</code> assertion failure in <code>wasmtime-37.0.1/src/runtime/vm/gc/enabled/drc.rs:596:9</code></p>
<p>Command 5 hands after printing "5" (meaning that first 5 iterations completed successfully, but on <code>i=5</code> it hanged)</p>
<p>Command 6 gives <code>zsh: bus error  RUST_BACKTRACE=1 cargo run --release 22000 0 1 2 3</code> (might be un-aligned memory access)</p>
<p>Command 7 produces "<code>Option::unwrap()</code> on a <code>None</code> value" panic in <code>wasmtime-environ-37.0.1/src/types.rs:1160:25</code></p>
<p>Command 8 produces ""should have inserted trace info for every GC type allocated in this heap" panic in <code>wasmtime-37.0.1/src/runtime/vm/gc/enabled/drc.rs:317:14</code></p>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: 37.0.1</p>
<p>Operating system: macOS 15.6.1 (build 24G90)</p>
<p>Architecture: arm64e (Apple M2 Max)</p>
<h3>Extra Info</h3>
<p>Anything else you'd like to add?<br>
</p>
</blockquote>



<a name="542016322"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311753%20GC-related%20panic%20and%20hangs/near/542016322" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311753.20GC-related.20panic.20and.20hangs.html#542016322">(Sep 29 2025 at 11:51)</a>:</h4>
<p><a href="https://github.com/id-ilych">id-ilych</a> added the bug label to <a href="https://github.com/bytecodealliance/wasmtime/issues/11753">Issue #11753</a>.</p>



<a name="542024953"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311753%20GC-related%20panic%20and%20hangs/near/542024953" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311753.20GC-related.20panic.20and.20hangs.html#542024953">(Sep 29 2025 at 12:28)</a>:</h4>
<p>tschneidereit <a href="https://github.com/bytecodealliance/wasmtime/issues/11753#issuecomment-3346665217">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11753">issue #11753</a>:</p>
<blockquote>
<p>@fitzgen relevant to your interests :)</p>
</blockquote>



<a name="542110425"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311753%20GC-related%20panic%20and%20hangs/near/542110425" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311753.20GC-related.20panic.20and.20hangs.html#542110425">(Sep 29 2025 at 18:22)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/issues/11753#issuecomment-3348405515">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11753">issue #11753</a>:</p>
<blockquote>
<p>Thanks for filing an issue!</p>
<blockquote>
<p>The form does not allow WASM attachments, so here is the link <a href="https://github.com/id-ilych/wasmtime-bugreport/raw/3eddc3cab6fa/host/guest.wasm">https://github.com/id-ilych/wasmtime-bugreport/raw/3eddc3cab6fa/host/guest.wasm</a></p>
</blockquote>
<p>This link 404s for me. FYI, github will allow you to attach gzip'd files, so you can attach <code>testcase.wasm.gz</code> here.</p>
<p>In general, I recommend filing separate issues with separate test cases for each bug you are hitting. Lumping multiple things together only makes it harder for maintainers to figure out what is or is not relevant to a particular bug, which slows down the whole process of diagnosing and fixing the bug.</p>
<p>See also <a href="https://docs.wasmtime.dev/contributing-reducing-test-cases.html">our documentation on shrinking test cases</a></p>
</blockquote>



<a name="542116167"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311753%20GC-related%20panic%20and%20hangs/near/542116167" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311753.20GC-related.20panic.20and.20hangs.html#542116167">(Sep 29 2025 at 18:53)</a>:</h4>
<p><a href="https://github.com/alexcrichton">alexcrichton</a> added the wasm-proposal:gc label to <a href="https://github.com/bytecodealliance/wasmtime/issues/11753">Issue #11753</a>.</p>



<a name="542122018"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311753%20GC-related%20panic%20and%20hangs/near/542122018" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311753.20GC-related.20panic.20and.20hangs.html#542122018">(Sep 29 2025 at 19:21)</a>:</h4>
<p>id-ilych <a href="https://github.com/bytecodealliance/wasmtime/issues/11753#issuecomment-3348697020">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11753">issue #11753</a>:</p>
<blockquote>
<p>Hello @fitzgen <span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span> My bad, forgot to make the repo public. Please try again now.</p>
<blockquote>
<p>In general, I recommend filing separate issues with separate test cases for each bug you are hitting</p>
</blockquote>
<p>In general I would agree, but in that case the code for all the cases is exactly the same, it's only the size of allocations it does that differ (passed as argument), so I thought they might be manifestations of the same root cause. For example, 3 and 4 is just a debug build of 1 and 2, and even though 1 and 2 cause different panics, in debug mode they both trigger the same assertion failure. Also, if the developer would dive into GC code and change something there, the other cases are unlikely to be triggered by exactly the same values as now, so I would have to do fuzzy testing again and thus it looks counterproductive for both parties.</p>
<p>Anyway, if you still think it would be helpful to file each case separately - I could do that.</p>
<blockquote>
<p>See also <a href="https://docs.wasmtime.dev/contributing-reducing-test-cases.html">our documentation on shrinking test cases</a></p>
</blockquote>
<p>I will check that out tomorrow, thanks.</p>
</blockquote>



<a name="542324208"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311753%20GC-related%20panic%20and%20hangs/near/542324208" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311753.20GC-related.20panic.20and.20hangs.html#542324208">(Sep 30 2025 at 16:49)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/issues/11753#issuecomment-3353027088">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11753">issue #11753</a>:</p>
<blockquote>
<blockquote>
<p>In general I would agree, but in that case the code for all the cases is exactly the same, it's only the size of allocations it does that differ (passed as argument), so I thought they might be manifestations of the same root cause.</p>
</blockquote>
<p>If the test case is literally identical, yeah that makes sense. Thanks.</p>
</blockquote>



<a name="542466610"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311753%20GC-related%20panic%20and%20hangs/near/542466610" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311753.20GC-related.20panic.20and.20hangs.html#542466610">(Oct 01 2025 at 11:07)</a>:</h4>
<p>id-ilych edited <a href="https://github.com/bytecodealliance/wasmtime/issues/11753">issue #11753</a>:</p>
<blockquote>
<h3>Test Case</h3>
<p>The form does not allow WASM attachments, so here is the link<br>
<a href="https://github.com/id-ilych/wasmtime-bugreport/raw/3eddc3cab6fa/host/guest.wasm">https://github.com/id-ilych/wasmtime-bugreport/raw/3eddc3cab6fa/host/guest.wasm</a></p>
<p><strong>UPD</strong><br>
Reduced WASM (see <a href="https://github.com/WebAssembly/binaryen?tab=readme-ov-file#tools">binaryen's wasm-reduce</a>)<br>
<a href="https://github.com/id-ilych/wasmtime-bugreport/raw/c93f146/host/guest.reduced.wasm">https://github.com/id-ilych/wasmtime-bugreport/raw/c93f146/host/guest.reduced.wasm</a></p>
<p>The host code</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">error</span><span class="p">::</span><span class="n">Error</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::</span><span class="o">*</span><span class="p">;</span>

<span class="k">fn</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">arg_a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">env</span><span class="p">::</span><span class="n">args</span><span class="p">().</span><span class="n">nth</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">unwrap</span><span class="p">().</span><span class="n">parse</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">arg_b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">env</span><span class="p">::</span><span class="n">args</span><span class="p">().</span><span class="n">nth</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="n">unwrap</span><span class="p">().</span><span class="n">parse</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">arg_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">env</span><span class="p">::</span><span class="n">args</span><span class="p">().</span><span class="n">nth</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="n">unwrap</span><span class="p">().</span><span class="n">parse</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">arg_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">env</span><span class="p">::</span><span class="n">args</span><span class="p">().</span><span class="n">nth</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span><span class="n">unwrap</span><span class="p">().</span><span class="n">parse</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">arg_z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">env</span><span class="p">::</span><span class="n">args</span><span class="p">().</span><span class="n">nth</span><span class="p">(</span><span class="mi">5</span><span class="p">).</span><span class="n">unwrap</span><span class="p">().</span><span class="n">parse</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Engine</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">Config</span><span class="p">::</span><span class="n">default</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">gc_support</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">wasm_gc</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">wasm_exceptions</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">wasm_reference_types</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">wasm_function_references</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">allocation_strategy</span><span class="p">(</span><span class="n">PoolingAllocationConfig</span><span class="p">::</span><span class="n">new</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="n">max_memory_size</span><span class="p">(</span><span class="mi">1_000_000</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">to_owned</span><span class="p">()</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">    </span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Module</span><span class="p">::</span><span class="n">from_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="s">"guest.wasm"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Linker</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">);</span>
<span class="w">    </span><span class="n">linker</span><span class="p">.</span><span class="n">func_wrap</span><span class="p">(</span><span class="s">"wasi_snapshot_preview1"</span><span class="p">,</span><span class="w"> </span><span class="s">"random_get"</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">_</span><span class="p">:</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">:</span><span class="w"> </span><span class="kt">i32</span><span class="o">|</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="p">})</span><span class="o">?</span><span class="p">;</span><span class="w"> </span><span class="c1">// Errno::Io</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">instantiate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">(</span><span class="n">Store</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">TypedFunc</span><span class="o">&lt;</span><span class="p">(</span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">),</span><span class="w"> </span><span class="kt">i32</span><span class="o">&gt;</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Store</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="p">());</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">linker</span><span class="p">.</span><span class="n">instantiate</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">module</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">initialize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instance</span><span class="p">.</span><span class="n">get_typed_func</span><span class="p">::</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="p">()</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">"_initialize"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="n">initialize</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="p">())</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instance</span><span class="p">.</span><span class="n">get_typed_func</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="s">"memtest"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">((</span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="n">func</span><span class="p">))</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="n">store_a</span><span class="p">,</span><span class="w"> </span><span class="n">func_a</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instantiate</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="n">store_b</span><span class="p">,</span><span class="w"> </span><span class="n">func_b</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instantiate</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="mi">100</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">arg_a</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="p">:</span><span class="kt">i32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_a</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store_a</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">arg_a</span><span class="p">,</span><span class="w"> </span><span class="n">arg_x</span><span class="p">,</span><span class="w"> </span><span class="n">arg_y</span><span class="p">,</span><span class="w"> </span><span class="n">arg_z</span><span class="p">))</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">arg_b</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">_</span><span class="p">:</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func_b</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store_b</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">arg_b</span><span class="p">,</span><span class="w"> </span><span class="n">arg_x</span><span class="p">,</span><span class="w"> </span><span class="n">arg_y</span><span class="p">,</span><span class="w"> </span><span class="n">arg_z</span><span class="p">))</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>
<p>You can find the whole project (including original Kotlin code for the guest) here:<br>
<a href="https://github.com/id-ilych/wasmtime-bugreport/tree/3eddc3cab6fa">https://github.com/id-ilych/wasmtime-bugreport/tree/3eddc3cab6fa</a></p>
<h3>Steps to Reproduce</h3>
<p><span aria-label="warning" class="emoji emoji-26a0" role="img" title="warning">:warning:</span> Each command listed here fails (or hangs), particular panics for each case are listed in Actual Results section</p>
<ol>
<li><code>RUST_BACKTRACE=1 cargo run --release 10000 7500 1 1 1</code></li>
<li><code>RUST_BACKTRACE=1 cargo run --release 10000 11000 1 1 1</code></li>
<li><code>RUST_BACKTRACE=1 cargo run 10000 7500 1 1 1</code></li>
<li><code>RUST_BACKTRACE=1 cargo run 10000 11000 1 1 1</code></li>
<li><code>RUST_BACKTRACE=1 cargo run --release 10000 7500 3 2 1</code></li>
<li><code>RUST_BACKTRACE=1 cargo run --release 22000 0 1 2 3</code></li>
<li><code>RUST_BACKTRACE=1 cargo run --release 12025 17812 5 5 5</code></li>
<li><code>RUST_BACKTRACE=1 cargo run --release 15202 17813 2 1 1</code></li>
</ol>
<h3>Expected Results</h3>
<p>Program finishes successfully (prints numbers from 0 to 99 (incl))</p>
<h3>Actual Results</h3>
<p>Command 1 produces "<code>Option::unwrap()</code> on a <code>None</code> value" panic in <code>wasmtime-37.0.1/src/runtime/vm/gc/gc_runtime.rs:463:44 </code></p>
<p>Command 2 produces "range start index 6553700 out of range for slice of length 524288" panic in <code>wasmtime-37.0.1/src/runtime/vm/gc/gc_runtime.rs:466:47</code></p>
<p>Commands 3 and 4 each cause <code>self.is_in_over_approximated_stack_roots()</code> assertion failure in <code>wasmtime-37.0.1/src/runtime/vm/gc/enabled/drc.rs:596:9</code></p>
<p>Command 5 hands after printing "5" (meaning that first 5 iterations completed successfully, but on <code>i=5</code> it hanged)</p>
<p>Command 6 gives <code>zsh: bus error  RUST_BACKTRACE=1 cargo run --release 22000 0 1 2 3</code> (might be un-aligned memory access)</p>
<p>Command 7 produces "<code>Option::unwrap()</code> on a <code>None</code> value" panic in <code>wasmtime-environ-37.0.1/src/types.rs:1160:25</code></p>
<p>Command 8 produces ""should have inserted trace info for every GC type allocated in this heap" panic in <code>wasmtime-37.0.1/src/runtime/vm/gc/enabled/drc.rs:317:14</code></p>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: 37.0.1</p>
<p>Operating system: macOS 15.6.1 (build 24G90)</p>
<p>Architecture: arm64e (Apple M2 Max)</p>
<h3>Extra Info</h3>
<p>Anything else you'd like to add?<br>
</p>
</blockquote>



<a name="542467133"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311753%20GC-related%20panic%20and%20hangs/near/542467133" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311753.20GC-related.20panic.20and.20hangs.html#542467133">(Oct 01 2025 at 11:11)</a>:</h4>
<p>id-ilych <a href="https://github.com/bytecodealliance/wasmtime/issues/11753#issuecomment-3355836150">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11753">issue #11753</a>:</p>
<blockquote>
<p>Hello @fitzgen <span aria-label="wave" class="emoji emoji-1f44b" role="img" title="wave">:wave:</span></p>
<blockquote>
<p>See also <a href="https://docs.wasmtime.dev/contributing-reducing-test-cases.html">our documentation on shrinking test cases</a></p>
</blockquote>
<p>I had no luck with <code>wasm-shrink</code>, so I used binaryen's <code>wasm-reduce</code> instead.</p>
<p><code>12802</code> -&gt; <code>2275</code></p>
<p>Reduced WASM is available here <a href="https://github.com/id-ilych/wasmtime-bugreport/raw/c93f146/host/guest.reduced.wasm">https://github.com/id-ilych/wasmtime-bugreport/raw/c93f146/host/guest.reduced.wasm</a><br>
(Description is updated too)</p>
</blockquote>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
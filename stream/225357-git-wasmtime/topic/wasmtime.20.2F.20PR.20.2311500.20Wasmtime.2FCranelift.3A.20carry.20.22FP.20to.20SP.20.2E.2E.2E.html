<html>
<head><meta charset="utf-8"><title>wasmtime / PR #11500 Wasmtime/Cranelift: carry &quot;FP to SP ... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311500.20Wasmtime.2FCranelift.3A.20carry.20.22FP.20to.20SP.20.2E.2E.2E.html">wasmtime / PR #11500 Wasmtime/Cranelift: carry &quot;FP to SP ...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="535583964"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311500%20Wasmtime/Cranelift%3A%20carry%20%22FP%20to%20SP%20.../near/535583964" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311500.20Wasmtime.2FCranelift.3A.20carry.20.22FP.20to.20SP.20.2E.2E.2E.html#535583964">(Aug 21 2025 at 21:50)</a>:</h4>
<p>cfallin opened <a href="https://github.com/bytecodealliance/wasmtime/pull/11500">PR #11500</a> from <code>cfallin:exception-sp-from-fp-with-offset</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>Currently Wasmtime unwinds stack frames to look for exception handlers by walking frames one-by-one, following the FP chain as usual, and assuming that <em>these frames are contiguous</em>: that is, that the SP in any given frame (bottom of that frame) is immediately above the FP of the next lower frame, plus the FP/return address pair (e.g. 16 bytes). This allows us to get the SP for any given frame in addition to FP. We need SP for two reasons:</p>
<ul>
<li>To look up dynamic context, to match Wasm tag instances for handlers against the thrown tag;</li>
<li>To actually set SP when we resume, if we do resume to a handler in this frame.</li>
</ul>
<p>This logic <em>almost but not quite</em> worked: I had forgotten that in our tail-call ABI, we need to clean up incoming stack args in the callee (because only the final callee in a parade of tail-calling functions that reuse the same stack frame location knows how many args it has, not the original caller). This implies that there is an "incoming args area" <em>above</em> the FP/return address pair. Thus, frames are not necessarily contiguous by the above definition.</p>
<p>In #11489 we see a case where a function of signature <code>(func)</code> tail-calls one of <code>(func (param i32 i32 i32 i32 i32))</code>, which on x86-64 (with four arg registers left for Wasm) is sufficient to create incoming stack args, which then trips up the unwinder, reading a bogus vmctx and segfaulting.</p>
<p>The most reasonable solution seems to be to embed the SP-to-FP offset in the exception metadata itself, so from only the FP (which is totally robust -- we rely on the FP chain for multiple kinds of stack-walking) we can get the SP, allowing us to read dynamic context and to reset SP during resume.</p>
<p>This PR does just that. Technically, in our ABI, the SP-to-FP offset is constant for an entire function, but it was simpler in the exception metadata to encode this per callsite instead (there is no other notion of "per-function" data, only "per-callsite", so it would be a separate binary search).</p>
<p>Fixes #11489.</p>
<p>prtest:full</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="535583966"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311500%20Wasmtime/Cranelift%3A%20carry%20%22FP%20to%20SP%20.../near/535583966" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311500.20Wasmtime.2FCranelift.3A.20carry.20.22FP.20to.20SP.20.2E.2E.2E.html#535583966">(Aug 21 2025 at 21:50)</a>:</h4>
<p><strong>cfallin</strong> requested <a href="https://github.com/alexcrichton">alexcrichton</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/11500">PR #11500</a>.</p>



<a name="535583967"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311500%20Wasmtime/Cranelift%3A%20carry%20%22FP%20to%20SP%20.../near/535583967" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311500.20Wasmtime.2FCranelift.3A.20carry.20.22FP.20to.20SP.20.2E.2E.2E.html#535583967">(Aug 21 2025 at 21:50)</a>:</h4>
<p><strong>cfallin</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/11500">PR #11500</a>.</p>



<a name="535583968"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311500%20Wasmtime/Cranelift%3A%20carry%20%22FP%20to%20SP%20.../near/535583968" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311500.20Wasmtime.2FCranelift.3A.20carry.20.22FP.20to.20SP.20.2E.2E.2E.html#535583968">(Aug 21 2025 at 21:50)</a>:</h4>
<p><strong>cfallin</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers">wasmtime-core-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/11500">PR #11500</a>.</p>



<a name="535584791"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311500%20Wasmtime/Cranelift%3A%20carry%20%22FP%20to%20SP%20.../near/535584791" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311500.20Wasmtime.2FCranelift.3A.20carry.20.22FP.20to.20SP.20.2E.2E.2E.html#535584791">(Aug 21 2025 at 21:58)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11500#pullrequestreview-3142389429">PR review</a>.</p>



<a name="535584792"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311500%20Wasmtime/Cranelift%3A%20carry%20%22FP%20to%20SP%20.../near/535584792" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311500.20Wasmtime.2FCranelift.3A.20carry.20.22FP.20to.20SP.20.2E.2E.2E.html#535584792">(Aug 21 2025 at 21:58)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/11500#discussion_r2292219764">PR review comment</a>:</p>
<blockquote>
<p>Could this (and below) expand documentation to explain what <code>None</code> means?</p>
</blockquote>



<a name="535584793"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311500%20Wasmtime/Cranelift%3A%20carry%20%22FP%20to%20SP%20.../near/535584793" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311500.20Wasmtime.2FCranelift.3A.20carry.20.22FP.20to.20SP.20.2E.2E.2E.html#535584793">(Aug 21 2025 at 21:58)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/11500#discussion_r2292224760">PR review comment</a>:</p>
<blockquote>
<p>Would it be worth it to add a disas test for <code>$throw</code> to ensure that it's handling the offset correctly?</p>
</blockquote>



<a name="535584794"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311500%20Wasmtime/Cranelift%3A%20carry%20%22FP%20to%20SP%20.../near/535584794" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311500.20Wasmtime.2FCranelift.3A.20carry.20.22FP.20to.20SP.20.2E.2E.2E.html#535584794">(Aug 21 2025 at 21:58)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/11500#discussion_r2292223472">PR review comment</a>:</p>
<blockquote>
<p>Could this have a comment as to why <code>unwrap_or</code> is ok here? Or otherwise, if <code>None</code> is the same as 0 should this be represented as a u32 instead of a <code>Option&lt;u32&gt;</code>?</p>
</blockquote>



<a name="535585576"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311500%20Wasmtime/Cranelift%3A%20carry%20%22FP%20to%20SP%20.../near/535585576" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311500.20Wasmtime.2FCranelift.3A.20carry.20.22FP.20to.20SP.20.2E.2E.2E.html#535585576">(Aug 21 2025 at 22:04)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11500">PR #11500</a>.</p>



<a name="535585688"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311500%20Wasmtime/Cranelift%3A%20carry%20%22FP%20to%20SP%20.../near/535585688" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311500.20Wasmtime.2FCranelift.3A.20carry.20.22FP.20to.20SP.20.2E.2E.2E.html#535585688">(Aug 21 2025 at 22:05)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11500">PR #11500</a>.</p>



<a name="535587091"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311500%20Wasmtime/Cranelift%3A%20carry%20%22FP%20to%20SP%20.../near/535587091" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311500.20Wasmtime.2FCranelift.3A.20carry.20.22FP.20to.20SP.20.2E.2E.2E.html#535587091">(Aug 21 2025 at 22:20)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11500">PR #11500</a>.</p>



<a name="535587095"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311500%20Wasmtime/Cranelift%3A%20carry%20%22FP%20to%20SP%20.../near/535587095" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311500.20Wasmtime.2FCranelift.3A.20carry.20.22FP.20to.20SP.20.2E.2E.2E.html#535587095">(Aug 21 2025 at 22:20)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11500#pullrequestreview-3142435777">PR review</a>.</p>



<a name="535587096"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311500%20Wasmtime/Cranelift%3A%20carry%20%22FP%20to%20SP%20.../near/535587096" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311500.20Wasmtime.2FCranelift.3A.20carry.20.22FP.20to.20SP.20.2E.2E.2E.html#535587096">(Aug 21 2025 at 22:20)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/11500#discussion_r2292252098">PR review comment</a>:</p>
<blockquote>
<p>The interesting new bit is actually the offset at the <code>try_table</code> site (callsite in <code>$start</code>), which is the same as the case in <code>exceptions.wat</code>, so I think we're covered already!</p>
</blockquote>



<a name="535587107"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311500%20Wasmtime/Cranelift%3A%20carry%20%22FP%20to%20SP%20.../near/535587107" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311500.20Wasmtime.2FCranelift.3A.20carry.20.22FP.20to.20SP.20.2E.2E.2E.html#535587107">(Aug 21 2025 at 22:20)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11500#pullrequestreview-3142435952">PR review</a>.</p>



<a name="535587108"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311500%20Wasmtime/Cranelift%3A%20carry%20%22FP%20to%20SP%20.../near/535587108" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311500.20Wasmtime.2FCranelift.3A.20carry.20.22FP.20to.20SP.20.2E.2E.2E.html#535587108">(Aug 21 2025 at 22:20)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/11500#discussion_r2292252219">PR review comment</a>:</p>
<blockquote>
<p>Updated to explicitly <code>.expect()</code> only when there are handlers. The subtlety is that <code>frame_offset</code> will be <code>None</code> if there are no handlers because we don't encode any metadata in that case.</p>
</blockquote>



<a name="535587117"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311500%20Wasmtime/Cranelift%3A%20carry%20%22FP%20to%20SP%20.../near/535587117" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311500.20Wasmtime.2FCranelift.3A.20carry.20.22FP.20to.20SP.20.2E.2E.2E.html#535587117">(Aug 21 2025 at 22:20)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11500#pullrequestreview-3142436046">PR review</a>.</p>



<a name="535587118"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311500%20Wasmtime/Cranelift%3A%20carry%20%22FP%20to%20SP%20.../near/535587118" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311500.20Wasmtime.2FCranelift.3A.20carry.20.22FP.20to.20SP.20.2E.2E.2E.html#535587118">(Aug 21 2025 at 22:20)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/11500#discussion_r2292252320">PR review comment</a>:</p>
<blockquote>
<p>Updated!</p>
</blockquote>



<a name="535588762"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311500%20Wasmtime/Cranelift%3A%20carry%20%22FP%20to%20SP%20.../near/535588762" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311500.20Wasmtime.2FCranelift.3A.20carry.20.22FP.20to.20SP.20.2E.2E.2E.html#535588762">(Aug 21 2025 at 22:40)</a>:</h4>
<p>alexcrichton has enabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/11500">PR #11500</a>.</p>



<a name="535591226"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311500%20Wasmtime/Cranelift%3A%20carry%20%22FP%20to%20SP%20.../near/535591226" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311500.20Wasmtime.2FCranelift.3A.20carry.20.22FP.20to.20SP.20.2E.2E.2E.html#535591226">(Aug 21 2025 at 23:10)</a>:</h4>
<p>alexcrichton merged <a href="https://github.com/bytecodealliance/wasmtime/pull/11500">PR #11500</a>.</p>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
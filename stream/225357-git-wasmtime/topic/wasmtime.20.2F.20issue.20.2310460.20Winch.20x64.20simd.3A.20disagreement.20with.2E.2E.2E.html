<html>
<head><meta charset="utf-8"><title>wasmtime / issue #10460 Winch x64 simd: disagreement with... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310460.20Winch.20x64.20simd.3A.20disagreement.20with.2E.2E.2E.html">wasmtime / issue #10460 Winch x64 simd: disagreement with...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="507472832"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310460%20Winch%20x64%20simd%3A%20disagreement%20with.../near/507472832" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310460.20Winch.20x64.20simd.3A.20disagreement.20with.2E.2E.2E.html#507472832">(Mar 22 2025 at 17:44)</a>:</h4>
<p><a href="https://github.com/alexcrichton">alexcrichton</a> added the fuzz-bug label to <a href="https://github.com/bytecodealliance/wasmtime/issues/10460">Issue #10460</a>.</p>



<a name="507472833"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310460%20Winch%20x64%20simd%3A%20disagreement%20with.../near/507472833" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310460.20Winch.20x64.20simd.3A.20disagreement.20with.2E.2E.2E.html#507472833">(Mar 22 2025 at 17:44)</a>:</h4>
<p><a href="https://github.com/alexcrichton">alexcrichton</a> added the wasm-proposal:simd label to <a href="https://github.com/bytecodealliance/wasmtime/issues/10460">Issue #10460</a>.</p>



<a name="507472834"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310460%20Winch%20x64%20simd%3A%20disagreement%20with.../near/507472834" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310460.20Winch.20x64.20simd.3A.20disagreement.20with.2E.2E.2E.html#507472834">(Mar 22 2025 at 17:44)</a>:</h4>
<p><a href="https://github.com/alexcrichton">alexcrichton</a> added the winch label to <a href="https://github.com/bytecodealliance/wasmtime/issues/10460">Issue #10460</a>.</p>



<a name="507472837"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310460%20Winch%20x64%20simd%3A%20disagreement%20with.../near/507472837" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310460.20Winch.20x64.20simd.3A.20disagreement.20with.2E.2E.2E.html#507472837">(Mar 22 2025 at 17:44)</a>:</h4>
<p>alexcrichton opened <a href="https://github.com/bytecodealliance/wasmtime/issues/10460">issue #10460</a>:</p>
<blockquote>
<p>This input:</p>
<div class="codehilite" data-code-language="wasm"><pre><span></span><code>(module
  (func (export "x")
    (param i32 v128 i32)
    (param v128 i32 v128 i32 v128)
    (param i32 v128 i32 v128 i32)
    (param v128 i32 v128 i32)
    (param $last v128)
    (result v128)
    local.get $last
  )
)

(assert_return
  (invoke "x"
    (i32.const 0)
    (v128.const i64x2 0 0)
    (i32.const 0)
    (v128.const i64x2 0 0)
    (i32.const 0)
    (v128.const i64x2 0 0)
    (i32.const 0)
    (v128.const i64x2 0 0)
    (i32.const 0)
    (v128.const i64x2 0 0)
    (i32.const 0)
    (v128.const i64x2 0 0)
    (i32.const 0)
    (v128.const i64x2 0 0)
    (i32.const 0)
    (v128.const i64x2 0 0)
    (i32.const 0)
    (v128.const i64x2 0 0)
  )
  (v128.const i64x2 0 0))
</code></pre></div>
<p>yields:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">-</span><span class="n">q</span><span class="w"> </span><span class="n">wast</span><span class="w"> </span><span class="o">-</span><span class="n">Ccompiler</span><span class="o">=</span><span class="n">winch</span><span class="w"> </span><span class="n">repro</span><span class="p">.</span><span class="n">wat</span>
<span class="n">Error</span><span class="p">:</span><span class="w"> </span><span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">script</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">'</span><span class="na">repro</span><span class="p">.</span><span class="n">wat</span><span class="o">'</span>

<span class="n">Caused</span><span class="w"> </span><span class="n">by</span><span class="p">:</span>
<span class="w">    </span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="nc">failed</span><span class="w"> </span><span class="n">directive</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">repro</span><span class="p">.</span><span class="n">wat</span><span class="p">:</span><span class="mi">13</span><span class="p">:</span><span class="mi">1</span>
<span class="w">    </span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="nc">result</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">didn</span><span class="o">'</span><span class="na">t</span><span class="w"> </span><span class="k">match</span>
<span class="w">    </span><span class="mi">2</span><span class="p">:</span><span class="w"> </span><span class="nc">expected</span><span class="w"> </span><span class="p">[</span><span class="w">                   </span><span class="mi">0</span><span class="p">,</span><span class="w">                    </span><span class="mi">0</span><span class="p">]</span>
<span class="w">       </span><span class="n">actual</span><span class="w">   </span><span class="p">[</span><span class="w">      </span><span class="mi">94750456038144</span><span class="p">,</span><span class="w">                    </span><span class="mi">0</span><span class="p">]</span>

<span class="w">       </span><span class="n">expected</span><span class="w"> </span><span class="p">(</span><span class="n">hex</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="mi">0000000000000000</span><span class="p">,</span><span class="w"> </span><span class="mi">0000000000000000</span><span class="p">]</span>
<span class="w">       </span><span class="n">actual</span><span class="w"> </span><span class="p">(</span><span class="n">hex</span><span class="p">)</span><span class="w">   </span><span class="p">[</span><span class="mi">0000562</span><span class="n">ccf464300</span><span class="p">,</span><span class="w"> </span><span class="mi">0000000000000000</span><span class="p">]</span>
</code></pre></div>
<p>cc @jeffcharles @saulecabrera </p>
</blockquote>



<a name="507709429"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310460%20Winch%20x64%20simd%3A%20disagreement%20with.../near/507709429" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310460.20Winch.20x64.20simd.3A.20disagreement.20with.2E.2E.2E.html#507709429">(Mar 24 2025 at 10:13)</a>:</h4>
<p>saulecabrera <a href="https://github.com/bytecodealliance/wasmtime/issues/10460#issuecomment-2747582126">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10460">issue #10460</a>:</p>
<blockquote>
<p>Thanks for the report! We'll take a look into it. </p>
</blockquote>



<a name="507884629"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310460%20Winch%20x64%20simd%3A%20disagreement%20with.../near/507884629" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310460.20Winch.20x64.20simd.3A.20disagreement.20with.2E.2E.2E.html#507884629">(Mar 24 2025 at 22:05)</a>:</h4>
<p>jeffcharles <a href="https://github.com/bytecodealliance/wasmtime/issues/10460#issuecomment-2749505345">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10460">issue #10460</a>:</p>
<blockquote>
<p>I wasn't able to resolve this today but I narrowed down the repro case to:</p>
<div class="codehilite" data-code-language="WebAssembly"><pre><span></span><code><span class="p">(</span><span class="k">module</span>
  <span class="p">(</span><span class="k">func</span> <span class="p">(</span><span class="k">export</span> <span class="s2">"x"</span><span class="p">)</span>
    <span class="p">(</span><span class="k">param</span> <span class="kt">f32</span> <span class="kt">f32</span> <span class="kt">f32</span> <span class="kt">f32</span> <span class="kt">f32</span> <span class="kt">f32</span> <span class="kt">f32</span> <span class="kt">f32</span> <span class="kt">f32</span><span class="p">)</span> <span class="p">(</span><span class="k">param</span> <span class="nv">$last</span> <span class="err">v</span><span class="mf">128</span><span class="p">)</span>
    <span class="p">(</span><span class="k">result</span> <span class="err">v</span><span class="mf">128</span><span class="p">)</span>
    <span class="nb">local.get</span> <span class="nv">$last</span>
  <span class="p">)</span>
<span class="p">)</span>

<span class="p">(</span><span class="err">assert_</span><span class="nb">return</span>
  <span class="p">(</span><span class="err">invoke</span> <span class="s2">"x"</span>
    <span class="p">(</span><span class="nb">f32.const</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">f32.const</span> <span class="mi">2</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">f32.const</span> <span class="mi">3</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">f32.const</span> <span class="mi">4</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">f32.const</span> <span class="mi">5</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">f32.const</span> <span class="mi">6</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">f32.const</span> <span class="mi">7</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">f32.const</span> <span class="mi">8</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">f32.const</span> <span class="mi">9</span><span class="p">)</span>
    <span class="p">(</span><span class="err">v</span><span class="mf">128</span><span class="err">.const</span> <span class="kt">i64</span><span class="err">x</span><span class="mf">2 10</span> <span class="mi">11</span><span class="p">)</span>
  <span class="p">)</span>
  <span class="p">(</span><span class="err">v</span><span class="mf">128</span><span class="err">.const</span> <span class="kt">i64</span><span class="err">x</span><span class="mf">2 10</span> <span class="mi">11</span><span class="p">))</span>
</code></pre></div>
<p>The key detail is there needs to be enough float/vector parameters to require using the stack for the last two and the last parameter must be a vector. Cranelift seems to be using offsets of 0 for the f32 and 16 for the v128 for the last two parameters whereas it'll use offsets of 0 and 8 for two f32 parameters. Winch uses offsets of 16 for the f32 and 24 for the v128 from the base pointer in both cases.  I'm not very familiar with exactly how Cranelift uses those offsets so I can't speak to whether there's an issue with the offsets being different for the different argument types.</p>
</blockquote>



<a name="509202384"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310460%20Winch%20x64%20simd%3A%20disagreement%20with.../near/509202384" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310460.20Winch.20x64.20simd.3A.20disagreement.20with.2E.2E.2E.html#509202384">(Mar 31 2025 at 13:32)</a>:</h4>
<p>saulecabrera assigned saulecabrera to <a href="https://github.com/bytecodealliance/wasmtime/issues/10460">issue #10460</a>.</p>



<a name="509783852"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310460%20Winch%20x64%20simd%3A%20disagreement%20with.../near/509783852" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310460.20Winch.20x64.20simd.3A.20disagreement.20with.2E.2E.2E.html#509783852">(Apr 02 2025 at 20:05)</a>:</h4>
<p>fitzgen closed <a href="https://github.com/bytecodealliance/wasmtime/issues/10460">issue #10460</a>:</p>
<blockquote>
<p>This input:</p>
<div class="codehilite" data-code-language="wasm"><pre><span></span><code>(module
  (func (export "x")
    (param i32 v128 i32)
    (param v128 i32 v128 i32 v128)
    (param i32 v128 i32 v128 i32)
    (param v128 i32 v128 i32)
    (param $last v128)
    (result v128)
    local.get $last
  )
)

(assert_return
  (invoke "x"
    (i32.const 0)
    (v128.const i64x2 0 0)
    (i32.const 0)
    (v128.const i64x2 0 0)
    (i32.const 0)
    (v128.const i64x2 0 0)
    (i32.const 0)
    (v128.const i64x2 0 0)
    (i32.const 0)
    (v128.const i64x2 0 0)
    (i32.const 0)
    (v128.const i64x2 0 0)
    (i32.const 0)
    (v128.const i64x2 0 0)
    (i32.const 0)
    (v128.const i64x2 0 0)
    (i32.const 0)
    (v128.const i64x2 0 0)
  )
  (v128.const i64x2 0 0))
</code></pre></div>
<p>yields:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">-</span><span class="n">q</span><span class="w"> </span><span class="n">wast</span><span class="w"> </span><span class="o">-</span><span class="n">Ccompiler</span><span class="o">=</span><span class="n">winch</span><span class="w"> </span><span class="n">repro</span><span class="p">.</span><span class="n">wat</span>
<span class="n">Error</span><span class="p">:</span><span class="w"> </span><span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">script</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">'</span><span class="na">repro</span><span class="p">.</span><span class="n">wat</span><span class="o">'</span>

<span class="n">Caused</span><span class="w"> </span><span class="n">by</span><span class="p">:</span>
<span class="w">    </span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="nc">failed</span><span class="w"> </span><span class="n">directive</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">repro</span><span class="p">.</span><span class="n">wat</span><span class="p">:</span><span class="mi">13</span><span class="p">:</span><span class="mi">1</span>
<span class="w">    </span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="nc">result</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">didn</span><span class="o">'</span><span class="na">t</span><span class="w"> </span><span class="k">match</span>
<span class="w">    </span><span class="mi">2</span><span class="p">:</span><span class="w"> </span><span class="nc">expected</span><span class="w"> </span><span class="p">[</span><span class="w">                   </span><span class="mi">0</span><span class="p">,</span><span class="w">                    </span><span class="mi">0</span><span class="p">]</span>
<span class="w">       </span><span class="n">actual</span><span class="w">   </span><span class="p">[</span><span class="w">      </span><span class="mi">94750456038144</span><span class="p">,</span><span class="w">                    </span><span class="mi">0</span><span class="p">]</span>

<span class="w">       </span><span class="n">expected</span><span class="w"> </span><span class="p">(</span><span class="n">hex</span><span class="p">)</span><span class="w"> </span><span class="p">[</span><span class="mi">0000000000000000</span><span class="p">,</span><span class="w"> </span><span class="mi">0000000000000000</span><span class="p">]</span>
<span class="w">       </span><span class="n">actual</span><span class="w"> </span><span class="p">(</span><span class="n">hex</span><span class="p">)</span><span class="w">   </span><span class="p">[</span><span class="mi">0000562</span><span class="n">ccf464300</span><span class="p">,</span><span class="w"> </span><span class="mi">0000000000000000</span><span class="p">]</span>
</code></pre></div>
<p>cc @jeffcharles @saulecabrera </p>
</blockquote>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
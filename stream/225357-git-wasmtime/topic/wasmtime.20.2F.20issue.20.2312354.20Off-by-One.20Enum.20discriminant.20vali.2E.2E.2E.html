<html>
<head><meta charset="utf-8"><title>wasmtime / issue #12354 Off-by-One Enum discriminant vali... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312354.20Off-by-One.20Enum.20discriminant.20vali.2E.2E.2E.html">wasmtime / issue #12354 Off-by-One Enum discriminant vali...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="568113008"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312354%20Off-by-One%20Enum%20discriminant%20vali.../near/568113008" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312354.20Off-by-One.20Enum.20discriminant.20vali.2E.2E.2E.html#568113008">(Jan 15 2026 at 01:55)</a>:</h4>
<p>zzjas opened <a href="https://github.com/bytecodealliance/wasmtime/issues/12354">issue #12354</a>:</p>
<blockquote>
<h3>Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">(</span><span class="n">assert_trap</span>
<span class="w">  </span><span class="p">(</span><span class="n">component</span>
<span class="w">    </span><span class="p">(</span><span class="k">type</span><span class="w"> </span><span class="cp">$enum</span><span class="w"> </span><span class="p">(</span><span class="k">enum</span><span class="w"> </span><span class="s">"case0"</span><span class="w"> </span><span class="s">"case1"</span><span class="w"> </span><span class="s">"case2"</span><span class="p">))</span>

<span class="w">    </span><span class="p">;;</span><span class="w"> </span><span class="n">Returns</span><span class="w"> </span><span class="n">invalid</span><span class="w"> </span><span class="n">discriminant</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="p">(</span><span class="n">valid</span><span class="w"> </span><span class="n">range</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">component</span><span class="w"> </span><span class="cp">$producer</span>
<span class="w">      </span><span class="p">(</span><span class="n">import</span><span class="w"> </span><span class="s">"enum"</span><span class="w"> </span><span class="p">(</span><span class="k">type</span><span class="w"> </span><span class="cp">$enum</span><span class="o">'</span><span class="w"> </span><span class="p">(</span><span class="n">eq</span><span class="w"> </span><span class="cp">$enum</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="n">core</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="cp">$core</span>
<span class="w">        </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="p">(</span><span class="n">export</span><span class="w"> </span><span class="s">"get"</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="kt">i32</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">i32</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">3</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="n">core</span><span class="w"> </span><span class="n">instance</span><span class="w"> </span><span class="cp">$inst</span><span class="w"> </span><span class="p">(</span><span class="n">instantiate</span><span class="w"> </span><span class="cp">$core</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="p">(</span><span class="n">export</span><span class="w"> </span><span class="s">"get"</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="cp">$enum</span><span class="o">'</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">canon</span><span class="w"> </span><span class="n">lift</span><span class="w"> </span><span class="p">(</span><span class="n">core</span><span class="w"> </span><span class="n">func</span><span class="w"> </span><span class="cp">$inst</span><span class="w"> </span><span class="s">"get"</span><span class="p">))))</span>

<span class="w">    </span><span class="p">;;</span><span class="w"> </span><span class="n">Calls</span><span class="w"> </span><span class="n">producer</span><span class="w"> </span><span class="n">through</span><span class="w"> </span><span class="n">adapter</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">validation</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">trap</span><span class="w"> </span><span class="n">here</span>
<span class="w">    </span><span class="p">(</span><span class="n">component</span><span class="w"> </span><span class="cp">$consumer</span>
<span class="w">      </span><span class="p">(</span><span class="n">import</span><span class="w"> </span><span class="s">"enum"</span><span class="w"> </span><span class="p">(</span><span class="k">type</span><span class="w"> </span><span class="cp">$enum</span><span class="o">'</span><span class="w"> </span><span class="p">(</span><span class="n">eq</span><span class="w"> </span><span class="cp">$enum</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="n">import</span><span class="w"> </span><span class="s">"get"</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="cp">$get</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="cp">$enum</span><span class="o">'</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="n">core</span><span class="w"> </span><span class="n">func</span><span class="w"> </span><span class="cp">$lowered</span><span class="w"> </span><span class="p">(</span><span class="n">canon</span><span class="w"> </span><span class="n">lower</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="cp">$get</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="n">core</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="cp">$core</span>
<span class="w">        </span><span class="p">(</span><span class="n">import</span><span class="w"> </span><span class="s">""</span><span class="w"> </span><span class="s">"get"</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="kt">i32</span><span class="p">)))</span>
<span class="w">        </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="cp">$start</span><span class="w"> </span><span class="p">(</span><span class="n">call</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="nb">drop</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="n">start</span><span class="w"> </span><span class="cp">$start</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="n">core</span><span class="w"> </span><span class="n">instance</span><span class="w"> </span><span class="p">(</span><span class="n">instantiate</span><span class="w"> </span><span class="cp">$core</span><span class="w"> </span><span class="p">(</span><span class="n">with</span><span class="w"> </span><span class="s">""</span><span class="w"> </span><span class="p">(</span><span class="n">instance</span><span class="w"> </span><span class="p">(</span><span class="n">export</span><span class="w"> </span><span class="s">"get"</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="cp">$lowered</span><span class="p">)))))))</span>

<span class="w">    </span><span class="p">(</span><span class="n">instance</span><span class="w"> </span><span class="cp">$prod</span><span class="w"> </span><span class="p">(</span><span class="n">instantiate</span><span class="w"> </span><span class="cp">$producer</span><span class="w"> </span><span class="p">(</span><span class="n">with</span><span class="w"> </span><span class="s">"enum"</span><span class="w"> </span><span class="p">(</span><span class="k">type</span><span class="w"> </span><span class="cp">$enum</span><span class="p">))))</span>
<span class="w">    </span><span class="p">(</span><span class="n">instance</span><span class="w"> </span><span class="p">(</span><span class="n">instantiate</span><span class="w"> </span><span class="cp">$consumer</span><span class="w"> </span><span class="p">(</span><span class="n">with</span><span class="w"> </span><span class="s">"enum"</span><span class="w"> </span><span class="p">(</span><span class="k">type</span><span class="w"> </span><span class="cp">$enum</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="n">with</span><span class="w"> </span><span class="s">"get"</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="cp">$prod</span><span class="w"> </span><span class="s">"get"</span><span class="p">)))))</span>
<span class="w">  </span><span class="s">"invalid variant discriminant"</span><span class="p">)</span>
</code></pre></div>
<p>Here the line <code>(func (export "get") (result $enum') (canon lift (core func $inst "get")))</code> tries to lift the <code>$inst."get"</code> (which returns the invalid discriminant) into a component function returning the enum with 3 variants.</p>
<h3>Steps to Reproduce</h3>
<p>Save the wast test somewhere (e.g. <code>tests/misc_testsuite/component-model/enum-discriminant-bug.wast</code>) and run</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">cargo</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="n">wasmtime</span><span class="o">-</span><span class="n">cli</span><span class="w"> </span><span class="o">--</span><span class="n">test</span><span class="w"> </span><span class="n">wast</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="k">enum</span><span class="o">-</span><span class="n">discriminant</span><span class="o">-</span><span class="n">bug</span>
</code></pre></div>
<p>will give:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Caused</span><span class="w"> </span><span class="n">by</span><span class="p">:</span>
<span class="w">    </span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="nc">failed</span><span class="w"> </span><span class="n">directive</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="o">/</span><span class="n">tests</span><span class="o">/</span><span class="n">misc_testsuite</span><span class="o">/</span><span class="n">component</span><span class="o">-</span><span class="n">model</span><span class="o">/</span><span class="k">enum</span><span class="o">-</span><span class="n">discriminant</span><span class="o">-</span><span class="n">bug</span><span class="p">.</span><span class="n">wast</span><span class="p">:</span><span class="mi">2</span>
<span class="w">    </span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="nc">expected</span><span class="w"> </span><span class="n">trap</span><span class="p">,</span><span class="w"> </span><span class="n">got</span><span class="w"> </span><span class="n">Component</span><span class="p">([])</span>
</code></pre></div>
<h3>Expected Results</h3>
<p>3 is an invalid discriminant so it should be trapped and pass the assertion.</p>
<h3>Actual Results</h3>
<p>Not trapped and failed the assertion.</p>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: 2e23e223c03543ee81344353e2d6418c0f3de47c</p>
<h3>Extra Info</h3>
<p>The discriminant check should have used <code>I32GeU</code> at line 3045:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/b856261dde3ea2624511fe4f48c3ed0790ddaa61/crates/environ/src/fact/trampoline.rs#L3043-L3048">https://github.com/bytecodealliance/wasmtime/blob/b856261dde3ea2624511fe4f48c3ed0790ddaa61/crates/environ/src/fact/trampoline.rs#L3043-L3048</a></p>
<p>I believe this doesn't enable any memory safety issues since other lifting locations have correct checks:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/b856261dde3ea2624511fe4f48c3ed0790ddaa61/crates/component-macro/src/component.rs#L653-L655">https://github.com/bytecodealliance/wasmtime/blob/b856261dde3ea2624511fe4f48c3ed0790ddaa61/crates/component-macro/src/component.rs#L653-L655</a><br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/b856261dde3ea2624511fe4f48c3ed0790ddaa61/crates/wasmtime/src/runtime/component/values.rs#L994-L996">https://github.com/bytecodealliance/wasmtime/blob/b856261dde3ea2624511fe4f48c3ed0790ddaa61/crates/wasmtime/src/runtime/component/values.rs#L994-L996</a></p>
<p>Thanks for looking into this! And as before, happy to submit a PR to fix if it's indeed a bug and the test looks ok.</p>
</blockquote>



<a name="568113010"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312354%20Off-by-One%20Enum%20discriminant%20vali.../near/568113010" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312354.20Off-by-One.20Enum.20discriminant.20vali.2E.2E.2E.html#568113010">(Jan 15 2026 at 01:55)</a>:</h4>
<p><a href="https://github.com/zzjas">zzjas</a> added the bug label to <a href="https://github.com/bytecodealliance/wasmtime/issues/12354">Issue #12354</a>.</p>



<a name="568114114"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312354%20Off-by-One%20Enum%20discriminant%20vali.../near/568114114" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312354.20Off-by-One.20Enum.20discriminant.20vali.2E.2E.2E.html#568114114">(Jan 15 2026 at 02:11)</a>:</h4>
<p>pchickey assigned alexcrichton to <a href="https://github.com/bytecodealliance/wasmtime/issues/12354">issue #12354</a>.</p>



<a name="568114244"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312354%20Off-by-One%20Enum%20discriminant%20vali.../near/568114244" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312354.20Off-by-One.20Enum.20discriminant.20vali.2E.2E.2E.html#568114244">(Jan 15 2026 at 02:13)</a>:</h4>
<p>pchickey <a href="https://github.com/bytecodealliance/wasmtime/issues/12354#issuecomment-3752551767">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12354">issue #12354</a>:</p>
<blockquote>
<p>Thanks for a really high quality bug report! I appreciate that you checked that this was not a memory safety issue before filing a public bug report, if you do discover those please do follow our security policy: <a href="https://github.com/bytecodealliance/wasmtime/blob/main/SECURITY.md">https://github.com/bytecodealliance/wasmtime/blob/main/SECURITY.md</a></p>
<p>I agree with your assessment of the bug but Alex knows this code better than anyone so I want his eyes on it too. Its a 1 character fix so you are welcome to send the PR or else one of us can make it trivially.<br>
</p>
</blockquote>



<a name="568114341"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312354%20Off-by-One%20Enum%20discriminant%20vali.../near/568114341" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312354.20Off-by-One.20Enum.20discriminant.20vali.2E.2E.2E.html#568114341">(Jan 15 2026 at 02:15)</a>:</h4>
<p>pchickey edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/12354#issuecomment-3752551767">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12354">issue #12354</a>:</p>
<blockquote>
<p>Thanks for a really high quality bug report! I appreciate that you checked that this was not a memory safety issue before filing a public bug report, if you do discover those please do follow our security policy: <a href="https://github.com/bytecodealliance/wasmtime/blob/main/SECURITY.md">https://github.com/bytecodealliance/wasmtime/blob/main/SECURITY.md</a></p>
<p>I agree with your assessment of the bug but Alex knows this code better than anyone so I want his eyes on it too. Its a 1 character fix so you are welcome to send the PR or else one of us can make it trivially.</p>
<p>Just curious, did you find this "manually" or did you use any tools to assist discovering this? If you did use tools that we might want to consider adding to our regular fuzzing or CI process, please talk to us about that on <a href="https://bytecodealliance.zulipchat.com/">https://bytecodealliance.zulipchat.com/</a></p>
</blockquote>



<a name="568114384"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312354%20Off-by-One%20Enum%20discriminant%20vali.../near/568114384" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312354.20Off-by-One.20Enum.20discriminant.20vali.2E.2E.2E.html#568114384">(Jan 15 2026 at 02:16)</a>:</h4>
<p>pchickey edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/12354#issuecomment-3752551767">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12354">issue #12354</a>:</p>
<blockquote>
<p>Thanks for a really high quality bug report! I appreciate that you checked that this was not a memory safety issue before filing a public bug report, if you do discover those please do follow our security policy: <a href="https://github.com/bytecodealliance/wasmtime/blob/main/SECURITY.md">https://github.com/bytecodealliance/wasmtime/blob/main/SECURITY.md</a></p>
<p>I agree with your assessment of the bug but Alex knows this code better than anyone so I want his eyes on it too. Its a 1 character fix (plus the nice regression test you wrote) so you are welcome to send the PR or else one of us can make it trivially.</p>
<p>Just curious, did you find this "manually" or did you use any tools to assist discovering this? If you did use tools that we might want to consider adding to our regular fuzzing or CI process, please talk to us about that on <a href="https://bytecodealliance.zulipchat.com/">https://bytecodealliance.zulipchat.com/</a></p>
</blockquote>



<a name="568117014"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312354%20Off-by-One%20Enum%20discriminant%20vali.../near/568117014" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312354.20Off-by-One.20Enum.20discriminant.20vali.2E.2E.2E.html#568117014">(Jan 15 2026 at 02:57)</a>:</h4>
<p>zzjas <a href="https://github.com/bytecodealliance/wasmtime/issues/12354#issuecomment-3752665174">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12354">issue #12354</a>:</p>
<blockquote>
<p>Thanks for looking into the report! I created a PR for it.</p>
<p>I did use automated tools to discover this bug (and a few others that I reported recently). Now the tool is still in its very early development phase. Hopefully we will make it public in a few weeks and I'd love to share the tool with you folks then!</p>
</blockquote>



<a name="568125889"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312354%20Off-by-One%20Enum%20discriminant%20vali.../near/568125889" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312354.20Off-by-One.20Enum.20discriminant.20vali.2E.2E.2E.html#568125889">(Jan 15 2026 at 04:59)</a>:</h4>
<p>alexcrichton closed <a href="https://github.com/bytecodealliance/wasmtime/issues/12354">issue #12354</a>:</p>
<blockquote>
<h3>Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">(</span><span class="n">assert_trap</span>
<span class="w">  </span><span class="p">(</span><span class="n">component</span>
<span class="w">    </span><span class="p">(</span><span class="k">type</span><span class="w"> </span><span class="cp">$enum</span><span class="w"> </span><span class="p">(</span><span class="k">enum</span><span class="w"> </span><span class="s">"case0"</span><span class="w"> </span><span class="s">"case1"</span><span class="w"> </span><span class="s">"case2"</span><span class="p">))</span>

<span class="w">    </span><span class="p">;;</span><span class="w"> </span><span class="n">Returns</span><span class="w"> </span><span class="n">invalid</span><span class="w"> </span><span class="n">discriminant</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="p">(</span><span class="n">valid</span><span class="w"> </span><span class="n">range</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="n">component</span><span class="w"> </span><span class="cp">$producer</span>
<span class="w">      </span><span class="p">(</span><span class="n">import</span><span class="w"> </span><span class="s">"enum"</span><span class="w"> </span><span class="p">(</span><span class="k">type</span><span class="w"> </span><span class="cp">$enum</span><span class="o">'</span><span class="w"> </span><span class="p">(</span><span class="n">eq</span><span class="w"> </span><span class="cp">$enum</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="n">core</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="cp">$core</span>
<span class="w">        </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="p">(</span><span class="n">export</span><span class="w"> </span><span class="s">"get"</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="kt">i32</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">i32</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">3</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="n">core</span><span class="w"> </span><span class="n">instance</span><span class="w"> </span><span class="cp">$inst</span><span class="w"> </span><span class="p">(</span><span class="n">instantiate</span><span class="w"> </span><span class="cp">$core</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="p">(</span><span class="n">export</span><span class="w"> </span><span class="s">"get"</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="cp">$enum</span><span class="o">'</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">canon</span><span class="w"> </span><span class="n">lift</span><span class="w"> </span><span class="p">(</span><span class="n">core</span><span class="w"> </span><span class="n">func</span><span class="w"> </span><span class="cp">$inst</span><span class="w"> </span><span class="s">"get"</span><span class="p">))))</span>

<span class="w">    </span><span class="p">;;</span><span class="w"> </span><span class="n">Calls</span><span class="w"> </span><span class="n">producer</span><span class="w"> </span><span class="n">through</span><span class="w"> </span><span class="n">adapter</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">validation</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="n">trap</span><span class="w"> </span><span class="n">here</span>
<span class="w">    </span><span class="p">(</span><span class="n">component</span><span class="w"> </span><span class="cp">$consumer</span>
<span class="w">      </span><span class="p">(</span><span class="n">import</span><span class="w"> </span><span class="s">"enum"</span><span class="w"> </span><span class="p">(</span><span class="k">type</span><span class="w"> </span><span class="cp">$enum</span><span class="o">'</span><span class="w"> </span><span class="p">(</span><span class="n">eq</span><span class="w"> </span><span class="cp">$enum</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="n">import</span><span class="w"> </span><span class="s">"get"</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="cp">$get</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="cp">$enum</span><span class="o">'</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="n">core</span><span class="w"> </span><span class="n">func</span><span class="w"> </span><span class="cp">$lowered</span><span class="w"> </span><span class="p">(</span><span class="n">canon</span><span class="w"> </span><span class="n">lower</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="cp">$get</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="n">core</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="cp">$core</span>
<span class="w">        </span><span class="p">(</span><span class="n">import</span><span class="w"> </span><span class="s">""</span><span class="w"> </span><span class="s">"get"</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="kt">i32</span><span class="p">)))</span>
<span class="w">        </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="cp">$start</span><span class="w"> </span><span class="p">(</span><span class="n">call</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="nb">drop</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="n">start</span><span class="w"> </span><span class="cp">$start</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="n">core</span><span class="w"> </span><span class="n">instance</span><span class="w"> </span><span class="p">(</span><span class="n">instantiate</span><span class="w"> </span><span class="cp">$core</span><span class="w"> </span><span class="p">(</span><span class="n">with</span><span class="w"> </span><span class="s">""</span><span class="w"> </span><span class="p">(</span><span class="n">instance</span><span class="w"> </span><span class="p">(</span><span class="n">export</span><span class="w"> </span><span class="s">"get"</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="cp">$lowered</span><span class="p">)))))))</span>

<span class="w">    </span><span class="p">(</span><span class="n">instance</span><span class="w"> </span><span class="cp">$prod</span><span class="w"> </span><span class="p">(</span><span class="n">instantiate</span><span class="w"> </span><span class="cp">$producer</span><span class="w"> </span><span class="p">(</span><span class="n">with</span><span class="w"> </span><span class="s">"enum"</span><span class="w"> </span><span class="p">(</span><span class="k">type</span><span class="w"> </span><span class="cp">$enum</span><span class="p">))))</span>
<span class="w">    </span><span class="p">(</span><span class="n">instance</span><span class="w"> </span><span class="p">(</span><span class="n">instantiate</span><span class="w"> </span><span class="cp">$consumer</span><span class="w"> </span><span class="p">(</span><span class="n">with</span><span class="w"> </span><span class="s">"enum"</span><span class="w"> </span><span class="p">(</span><span class="k">type</span><span class="w"> </span><span class="cp">$enum</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="n">with</span><span class="w"> </span><span class="s">"get"</span><span class="w"> </span><span class="p">(</span><span class="n">func</span><span class="w"> </span><span class="cp">$prod</span><span class="w"> </span><span class="s">"get"</span><span class="p">)))))</span>
<span class="w">  </span><span class="s">"invalid variant discriminant"</span><span class="p">)</span>
</code></pre></div>
<p>Here the line <code>(func (export "get") (result $enum') (canon lift (core func $inst "get")))</code> tries to lift the <code>$inst."get"</code> (which returns the invalid discriminant) into a component function returning the enum with 3 variants.</p>
<h3>Steps to Reproduce</h3>
<p>Save the wast test somewhere (e.g. <code>tests/misc_testsuite/component-model/enum-discriminant-bug.wast</code>) and run</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">cargo</span><span class="w"> </span><span class="n">test</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="n">wasmtime</span><span class="o">-</span><span class="n">cli</span><span class="w"> </span><span class="o">--</span><span class="n">test</span><span class="w"> </span><span class="n">wast</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="k">enum</span><span class="o">-</span><span class="n">discriminant</span><span class="o">-</span><span class="n">bug</span>
</code></pre></div>
<p>will give:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Caused</span><span class="w"> </span><span class="n">by</span><span class="p">:</span>
<span class="w">    </span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="nc">failed</span><span class="w"> </span><span class="n">directive</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="o">/</span><span class="n">tests</span><span class="o">/</span><span class="n">misc_testsuite</span><span class="o">/</span><span class="n">component</span><span class="o">-</span><span class="n">model</span><span class="o">/</span><span class="k">enum</span><span class="o">-</span><span class="n">discriminant</span><span class="o">-</span><span class="n">bug</span><span class="p">.</span><span class="n">wast</span><span class="p">:</span><span class="mi">2</span>
<span class="w">    </span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="nc">expected</span><span class="w"> </span><span class="n">trap</span><span class="p">,</span><span class="w"> </span><span class="n">got</span><span class="w"> </span><span class="n">Component</span><span class="p">([])</span>
</code></pre></div>
<h3>Expected Results</h3>
<p>3 is an invalid discriminant so it should be trapped and pass the assertion.</p>
<h3>Actual Results</h3>
<p>Not trapped and failed the assertion.</p>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: 2e23e223c03543ee81344353e2d6418c0f3de47c</p>
<h3>Extra Info</h3>
<p>The discriminant check should have used <code>I32GeU</code> at line 3045:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/b856261dde3ea2624511fe4f48c3ed0790ddaa61/crates/environ/src/fact/trampoline.rs#L3043-L3048">https://github.com/bytecodealliance/wasmtime/blob/b856261dde3ea2624511fe4f48c3ed0790ddaa61/crates/environ/src/fact/trampoline.rs#L3043-L3048</a></p>
<p>I believe this doesn't enable any memory safety issues since other lifting locations have correct checks:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/b856261dde3ea2624511fe4f48c3ed0790ddaa61/crates/component-macro/src/component.rs#L653-L655">https://github.com/bytecodealliance/wasmtime/blob/b856261dde3ea2624511fe4f48c3ed0790ddaa61/crates/component-macro/src/component.rs#L653-L655</a><br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/b856261dde3ea2624511fe4f48c3ed0790ddaa61/crates/wasmtime/src/runtime/component/values.rs#L994-L996">https://github.com/bytecodealliance/wasmtime/blob/b856261dde3ea2624511fe4f48c3ed0790ddaa61/crates/wasmtime/src/runtime/component/values.rs#L994-L996</a></p>
<p>Thanks for looking into this! And as before, happy to submit a PR to fix if it's indeed a bug and the test looks ok.</p>
</blockquote>



<hr><p>Last updated: Feb 22 2026 at 11:05 UTC</p>
</html>
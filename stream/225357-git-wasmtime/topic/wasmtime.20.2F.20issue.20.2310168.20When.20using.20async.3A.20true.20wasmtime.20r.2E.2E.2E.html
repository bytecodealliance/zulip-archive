<html>
<head><meta charset="utf-8"><title>wasmtime / issue #10168 When using async: true wasmtime r... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310168.20When.20using.20async.3A.20true.20wasmtime.20r.2E.2E.2E.html">wasmtime / issue #10168 When using async: true wasmtime r...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="497254912"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310168%20When%20using%20async%3A%20true%20wasmtime%20r.../near/497254912" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310168.20When.20using.20async.3A.20true.20wasmtime.20r.2E.2E.2E.html#497254912">(Feb 02 2025 at 12:35)</a>:</h4>
<p><a href="https://github.com/profitgrowinginnovator">profitgrowinginnovator</a> added the bug label to <a href="https://github.com/bytecodealliance/wasmtime/issues/10168">Issue #10168</a>.</p>



<a name="497254914"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310168%20When%20using%20async%3A%20true%20wasmtime%20r.../near/497254914" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310168.20When.20using.20async.3A.20true.20wasmtime.20r.2E.2E.2E.html#497254914">(Feb 02 2025 at 12:35)</a>:</h4>
<p>profitgrowinginnovator opened <a href="https://github.com/bytecodealliance/wasmtime/issues/10168">issue #10168</a>:</p>
<blockquote>
<h3>Test Case</h3>
<p>The wit file:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">package</span><span class="w"> </span><span class="n">sasync</span><span class="p">:</span><span class="nc">guest</span><span class="p">;</span>

<span class="n">interface</span><span class="w"> </span><span class="n">string</span><span class="o">-</span><span class="k">if</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="n">resource</span><span class="w"> </span><span class="n">string</span><span class="o">-</span><span class="n">rs</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="sd">/// Returns the name of the SaaS provider</span>
<span class="w">        </span><span class="n">string</span><span class="o">-</span><span class="k">fn</span><span class="p">:</span><span class="w"> </span><span class="nc">func</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">string</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">world</span><span class="w"> </span><span class="n">string</span><span class="o">-</span><span class="n">guest</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">export</span><span class="w"> </span><span class="n">string</span><span class="o">-</span><span class="k">if</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p><a href="http://main.rs">main.rs</a>:<br>
`</p>
<p>use bindings::exports::sasync::guest::string_if::{Guest, GuestStringRs};<br>
use wit_bindgen::generate;</p>
<p>mod bindings {<br>
    wit_bindgen::generate!({<br>
        path: "./wit/async-string.wit",<br>
        world: "string-guest",<br>
        async: true,<br>
    });</p>
<div class="codehilite"><pre><span></span><code>use super::AsyncString;
export!(AsyncString);
</code></pre></div>

<p>}</p>
<p>pub struct AsyncString;</p>
<p>// <span aria-label="check" class="emoji emoji-2705" role="img" title="check">:check:</span> Implement <code>GuestStringRs</code> for <code>AsyncString</code></p>
<p>impl GuestStringRs for AsyncString {</p>
<div class="codehilite"><pre><span></span><code>async fn string_fn(&amp;self) -&gt; String {
    &quot;success&quot;.to_string()
}
</code></pre></div>

<p>}</p>
<p>impl Guest for AsyncString {<br>
    type StringRs = AsyncString;<br>
}</p>
<p>fn main() {</p>
<div class="codehilite"><pre><span></span><code>println!(&quot;WASM executed successfully!&quot;);
</code></pre></div>

<p>}`</p>
<h3>Steps to Reproduce</h3>
<ul>
<li>cargo build --target wasm32-wasip2</li>
<li>wasmtime run target/wasm32-wasip2/debug/async-string.wasm</li>
</ul>
<h3>Expected Results</h3>
<p>WASM executed successfully! [This is what happens when async: false and async removed from fn string_fn]</p>
<h3>Actual Results</h3>
<p>Error: failed to parse WebAssembly module</p>
<p>Caused by:<br>
    invalid leading byte (0x9) for canonical function (at offset 0x3a8a7e)</p>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: <br>
wit-bindgen = { version= "0.38.0", features = ["async"] }<br>
wit-bindgen-rt = { version = "0.38.0", features = ["async"] }</p>
<p>Operating system: MacOS</p>
<p>Architecture: Arm</p>
<h3>Extra Info</h3>
<p>Here is a github with all the code:<br>
<a href="https://github.com/profitgrowinginnovator/async-string">https://github.com/profitgrowinginnovator/async-string</a></p>
<p>Similar module error is launched when an async wasm is read:<br>
Error: failed to parse WebAssembly module</p>
<p>Caused by:<br>
    invalid leading byte (0x9) for canonical function (at offset 0x3a8a7e)</p>
<p>#[tokio::main]  // Requires the "macros" feature<br>
async fn main() -&gt; anyhow::Result&lt;()&gt; {<br>
    let mut config = Config::new();<br>
    config.wasm_component_model(true);<br>
    config.async_support(true); // Enable async support<br>
    let engine = Engine::new(&amp;config)?;<br>
    //let mut linker = Linker::&lt;MyState&gt;::new(&amp;engine);</p>
<div class="codehilite"><pre><span></span><code>let state = MyString::default();
let mut store = Store::new(&amp;engine, state);
let linker = Linker::new(&amp;engine);
let component = Component::from_file(&amp;engine, &quot;../async-string/target/wasm32-wasip2/debug/async-string.wasm&quot;)?;

let command = Command::instantiate_async(&amp;mut store, &amp;component, &amp;linker).await?;
let result = command.wasi_cli_run().call_run(store);
println!(&quot;Result from WASM: {:?}&quot;, result.await);
Ok(())
</code></pre></div>

<p>}</p>
</blockquote>



<a name="497254949"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310168%20When%20using%20async%3A%20true%20wasmtime%20r.../near/497254949" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310168.20When.20using.20async.3A.20true.20wasmtime.20r.2E.2E.2E.html#497254949">(Feb 02 2025 at 12:35)</a>:</h4>
<p>profitgrowinginnovator edited <a href="https://github.com/bytecodealliance/wasmtime/issues/10168">issue #10168</a>:</p>
<blockquote>
<h3>Test Case</h3>
<p>The wit file:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">package</span><span class="w"> </span><span class="n">sasync</span><span class="p">:</span><span class="nc">guest</span><span class="p">;</span>

<span class="n">interface</span><span class="w"> </span><span class="n">string</span><span class="o">-</span><span class="k">if</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="n">resource</span><span class="w"> </span><span class="n">string</span><span class="o">-</span><span class="n">rs</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="sd">/// Returns the name of the SaaS provider</span>
<span class="w">        </span><span class="n">string</span><span class="o">-</span><span class="k">fn</span><span class="p">:</span><span class="w"> </span><span class="nc">func</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">string</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">world</span><span class="w"> </span><span class="n">string</span><span class="o">-</span><span class="n">guest</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">export</span><span class="w"> </span><span class="n">string</span><span class="o">-</span><span class="k">if</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p><a href="http://main.rs">main.rs</a>:</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">bindings</span><span class="p">::</span><span class="n">exports</span><span class="p">::</span><span class="n">sasync</span><span class="p">::</span><span class="n">guest</span><span class="p">::</span><span class="n">string_if</span><span class="p">::{</span><span class="n">Guest</span><span class="p">,</span><span class="w"> </span><span class="n">GuestStringRs</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">wit_bindgen</span><span class="p">::</span><span class="n">generate</span><span class="p">;</span>


<span class="k">mod</span><span class="w"> </span><span class="nn">bindings</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">wit_bindgen</span><span class="p">::</span><span class="n">generate</span><span class="o">!</span><span class="p">({</span>
<span class="w">        </span><span class="n">path</span><span class="p">:</span><span class="w"> </span><span class="s">"./wit/async-string.wit"</span><span class="p">,</span>
<span class="w">        </span><span class="n">world</span><span class="p">:</span><span class="w"> </span><span class="s">"string-guest"</span><span class="p">,</span>
<span class="w">        </span><span class="k">async</span><span class="p">:</span><span class="w"> </span><span class="nc">true</span><span class="p">,</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="k">super</span><span class="p">::</span><span class="n">AsyncString</span><span class="p">;</span>
<span class="w">    </span><span class="n">export</span><span class="o">!</span><span class="p">(</span><span class="n">AsyncString</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">AsyncString</span><span class="p">;</span>


<span class="c1">// ✅ Implement `GuestStringRs` for `AsyncString`</span>

<span class="k">impl</span><span class="w"> </span><span class="n">GuestStringRs</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">AsyncString</span><span class="w"> </span><span class="p">{</span>


<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">string_fn</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">String</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s">"success"</span><span class="p">.</span><span class="n">to_string</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>


<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">Guest</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">AsyncString</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">type</span><span class="w"> </span><span class="nc">StringRs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AsyncString</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">fn</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"WASM executed successfully!"</span><span class="p">);</span>
<span class="p">}</span><span class="err">```</span>


<span class="p">###</span><span class="w"> </span><span class="n">Steps</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">Reproduce</span>

<span class="o">*</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="o">--</span><span class="n">target</span><span class="w"> </span><span class="n">wasm32</span><span class="o">-</span><span class="n">wasip2</span>
<span class="o">*</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">target</span><span class="o">/</span><span class="n">wasm32</span><span class="o">-</span><span class="n">wasip2</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="k">async</span><span class="o">-</span><span class="n">string</span><span class="p">.</span><span class="n">wasm</span>

<span class="p">###</span><span class="w"> </span><span class="n">Expected</span><span class="w"> </span><span class="n">Results</span>

<span class="n">WASM</span><span class="w"> </span><span class="n">executed</span><span class="w"> </span><span class="n">successfully</span><span class="o">!</span><span class="w"> </span><span class="p">[</span><span class="n">This</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">what</span><span class="w"> </span><span class="n">happens</span><span class="w"> </span><span class="n">when</span><span class="w"> </span><span class="k">async</span><span class="p">:</span><span class="w"> </span><span class="nc">false</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="n">removed</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">string_fn</span><span class="p">]</span>

<span class="p">###</span><span class="w"> </span><span class="n">Actual</span><span class="w"> </span><span class="n">Results</span>

<span class="n">Error</span><span class="p">:</span><span class="w"> </span><span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">parse</span><span class="w"> </span><span class="n">WebAssembly</span><span class="w"> </span><span class="n">module</span>

<span class="n">Caused</span><span class="w"> </span><span class="n">by</span><span class="p">:</span>
<span class="w">    </span><span class="nc">invalid</span><span class="w"> </span><span class="n">leading</span><span class="w"> </span><span class="n">byte</span><span class="w"> </span><span class="p">(</span><span class="mh">0x9</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">canonical</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="p">(</span><span class="n">at</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="mh">0x3a8a7e</span><span class="p">)</span>

<span class="p">###</span><span class="w"> </span><span class="n">Versions</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">Environment</span>

<span class="n">Wasmtime</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">commit</span><span class="p">:</span>
<span class="nc">wit</span><span class="o">-</span><span class="n">bindgen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">version</span><span class="o">=</span><span class="w"> </span><span class="s">"0.38.0"</span><span class="p">,</span><span class="w"> </span><span class="n">features</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s">"async"</span><span class="p">]</span><span class="w"> </span><span class="p">}</span>
<span class="n">wit</span><span class="o">-</span><span class="n">bindgen</span><span class="o">-</span><span class="n">rt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"0.38.0"</span><span class="p">,</span><span class="w"> </span><span class="n">features</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s">"async"</span><span class="p">]</span><span class="w"> </span><span class="p">}</span>

<span class="n">Operating</span><span class="w"> </span><span class="n">system</span><span class="p">:</span><span class="w"> </span><span class="nc">MacOS</span>

<span class="n">Architecture</span><span class="p">:</span><span class="w"> </span><span class="nc">Arm</span>

<span class="p">###</span><span class="w"> </span><span class="n">Extra</span><span class="w"> </span><span class="n">Info</span>
<span class="n">Here</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">github</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">code</span><span class="p">:</span>
<span class="nc">https</span><span class="p">:</span><span class="c1">//github.com/profitgrowinginnovator/async-string</span>

<span class="n">Similar</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">launched</span><span class="w"> </span><span class="n">when</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="n">wasm</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">read</span><span class="p">:</span>
<span class="nc">Error</span><span class="p">:</span><span class="w"> </span><span class="nc">failed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">parse</span><span class="w"> </span><span class="n">WebAssembly</span><span class="w"> </span><span class="n">module</span>

<span class="n">Caused</span><span class="w"> </span><span class="n">by</span><span class="p">:</span>
<span class="w">    </span><span class="nc">invalid</span><span class="w"> </span><span class="n">leading</span><span class="w"> </span><span class="n">byte</span><span class="w"> </span><span class="p">(</span><span class="mh">0x9</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">canonical</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="p">(</span><span class="n">at</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="mh">0x3a8a7e</span><span class="p">)</span>

<span class="cp">#[tokio::main]</span><span class="w">  </span><span class="c1">// Requires the "macros" feature</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">anyhow</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="n">config</span><span class="p">.</span><span class="n">wasm_component_model</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">    </span><span class="n">config</span><span class="p">.</span><span class="n">async_support</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w"> </span><span class="c1">// Enable async support</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Engine</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">config</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//let mut linker = Linker::&lt;MyState&gt;::new(&amp;engine);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MyString</span><span class="p">::</span><span class="n">default</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Store</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">linker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Linker</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">component</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Component</span><span class="p">::</span><span class="n">from_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="s">"../async-string/target/wasm32-wasip2/debug/async-string.wasm"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">command</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Command</span><span class="p">::</span><span class="n">instantiate_async</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">component</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">linker</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">command</span><span class="p">.</span><span class="n">wasi_cli_run</span><span class="p">().</span><span class="n">call_run</span><span class="p">(</span><span class="n">store</span><span class="p">);</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Result from WASM: {:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="k">await</span><span class="p">);</span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>



<span class="o">~~~</span>
</code></pre></div><br>
</p>
</blockquote>



<a name="497255015"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310168%20When%20using%20async%3A%20true%20wasmtime%20r.../near/497255015" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310168.20When.20using.20async.3A.20true.20wasmtime.20r.2E.2E.2E.html#497255015">(Feb 02 2025 at 12:36)</a>:</h4>
<p>profitgrowinginnovator edited <a href="https://github.com/bytecodealliance/wasmtime/issues/10168">issue #10168</a>:</p>
<blockquote>
<h3>Test Case</h3>
<p>The wit file:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">package</span><span class="w"> </span><span class="n">sasync</span><span class="p">:</span><span class="nc">guest</span><span class="p">;</span>

<span class="n">interface</span><span class="w"> </span><span class="n">string</span><span class="o">-</span><span class="k">if</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="n">resource</span><span class="w"> </span><span class="n">string</span><span class="o">-</span><span class="n">rs</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="sd">/// Returns the name of the SaaS provider</span>
<span class="w">        </span><span class="n">string</span><span class="o">-</span><span class="k">fn</span><span class="p">:</span><span class="w"> </span><span class="nc">func</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">string</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">world</span><span class="w"> </span><span class="n">string</span><span class="o">-</span><span class="n">guest</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">export</span><span class="w"> </span><span class="n">string</span><span class="o">-</span><span class="k">if</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p><a href="http://main.rs">main.rs</a>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">bindings</span><span class="p">::</span><span class="n">exports</span><span class="p">::</span><span class="n">sasync</span><span class="p">::</span><span class="n">guest</span><span class="p">::</span><span class="n">string_if</span><span class="p">::{</span><span class="n">Guest</span><span class="p">,</span><span class="w"> </span><span class="n">GuestStringRs</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">wit_bindgen</span><span class="p">::</span><span class="n">generate</span><span class="p">;</span>


<span class="k">mod</span><span class="w"> </span><span class="nn">bindings</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">wit_bindgen</span><span class="p">::</span><span class="n">generate</span><span class="o">!</span><span class="p">({</span>
<span class="w">        </span><span class="n">path</span><span class="p">:</span><span class="w"> </span><span class="s">"./wit/async-string.wit"</span><span class="p">,</span>
<span class="w">        </span><span class="n">world</span><span class="p">:</span><span class="w"> </span><span class="s">"string-guest"</span><span class="p">,</span>
<span class="w">        </span><span class="k">async</span><span class="p">:</span><span class="w"> </span><span class="nc">true</span><span class="p">,</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="k">super</span><span class="p">::</span><span class="n">AsyncString</span><span class="p">;</span>
<span class="w">    </span><span class="n">export</span><span class="o">!</span><span class="p">(</span><span class="n">AsyncString</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">AsyncString</span><span class="p">;</span>


<span class="c1">// ✅ Implement `GuestStringRs` for `AsyncString`</span>

<span class="k">impl</span><span class="w"> </span><span class="n">GuestStringRs</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">AsyncString</span><span class="w"> </span><span class="p">{</span>


<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">string_fn</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">String</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s">"success"</span><span class="p">.</span><span class="n">to_string</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>


<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">Guest</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">AsyncString</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">type</span><span class="w"> </span><span class="nc">StringRs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AsyncString</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">fn</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"WASM executed successfully!"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<ul>
<li>cargo build --target wasm32-wasip2</li>
<li>wasmtime run target/wasm32-wasip2/debug/async-string.wasm</li>
</ul>
<h3>Expected Results</h3>
<p>WASM executed successfully! [This is what happens when async: false and async removed from fn string_fn]</p>
<h3>Actual Results</h3>
<p>Error: failed to parse WebAssembly module</p>
<p>Caused by:<br>
    invalid leading byte (0x9) for canonical function (at offset 0x3a8a7e)</p>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: <br>
wit-bindgen = { version= "0.38.0", features = ["async"] }<br>
wit-bindgen-rt = { version = "0.38.0", features = ["async"] }</p>
<p>Operating system: MacOS</p>
<p>Architecture: Arm</p>
<h3>Extra Info</h3>
<p>Here is a github with all the code:<br>
<a href="https://github.com/profitgrowinginnovator/async-string">https://github.com/profitgrowinginnovator/async-string</a></p>
<p>Similar module error is launched when an async wasm is read:<br>
Error: failed to parse WebAssembly module</p>
<p>Caused by:<br>
    invalid leading byte (0x9) for canonical function (at offset 0x3a8a7e)</p>
<p>#[tokio::main]  // Requires the "macros" feature<br>
async fn main() -&gt; anyhow::Result&lt;()&gt; {<br>
    let mut config = Config::new();<br>
    config.wasm_component_model(true);<br>
    config.async_support(true); // Enable async support<br>
    let engine = Engine::new(&amp;config)?;<br>
    //let mut linker = Linker::&lt;MyState&gt;::new(&amp;engine);</p>
<div class="codehilite"><pre><span></span><code>let state = MyString::default();
let mut store = Store::new(&amp;engine, state);
let linker = Linker::new(&amp;engine);
let component = Component::from_file(&amp;engine, &quot;../async-string/target/wasm32-wasip2/debug/async-string.wasm&quot;)?;

let command = Command::instantiate_async(&amp;mut store, &amp;component, &amp;linker).await?;
let result = command.wasi_cli_run().call_run(store);
println!(&quot;Result from WASM: {:?}&quot;, result.await);
Ok(())
</code></pre></div>

<p>}</p>
</blockquote>



<a name="497255041"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310168%20When%20using%20async%3A%20true%20wasmtime%20r.../near/497255041" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310168.20When.20using.20async.3A.20true.20wasmtime.20r.2E.2E.2E.html#497255041">(Feb 02 2025 at 12:36)</a>:</h4>
<p>profitgrowinginnovator edited <a href="https://github.com/bytecodealliance/wasmtime/issues/10168">issue #10168</a>:</p>
<blockquote>
<h3>Test Case</h3>
<p>The wit file:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">package</span><span class="w"> </span><span class="n">sasync</span><span class="p">:</span><span class="nc">guest</span><span class="p">;</span>

<span class="n">interface</span><span class="w"> </span><span class="n">string</span><span class="o">-</span><span class="k">if</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="n">resource</span><span class="w"> </span><span class="n">string</span><span class="o">-</span><span class="n">rs</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="sd">/// Returns the name of the SaaS provider</span>
<span class="w">        </span><span class="n">string</span><span class="o">-</span><span class="k">fn</span><span class="p">:</span><span class="w"> </span><span class="nc">func</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">string</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">world</span><span class="w"> </span><span class="n">string</span><span class="o">-</span><span class="n">guest</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">export</span><span class="w"> </span><span class="n">string</span><span class="o">-</span><span class="k">if</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p><a href="http://main.rs">main.rs</a>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">bindings</span><span class="p">::</span><span class="n">exports</span><span class="p">::</span><span class="n">sasync</span><span class="p">::</span><span class="n">guest</span><span class="p">::</span><span class="n">string_if</span><span class="p">::{</span><span class="n">Guest</span><span class="p">,</span><span class="w"> </span><span class="n">GuestStringRs</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">wit_bindgen</span><span class="p">::</span><span class="n">generate</span><span class="p">;</span>


<span class="k">mod</span><span class="w"> </span><span class="nn">bindings</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">wit_bindgen</span><span class="p">::</span><span class="n">generate</span><span class="o">!</span><span class="p">({</span>
<span class="w">        </span><span class="n">path</span><span class="p">:</span><span class="w"> </span><span class="s">"./wit/async-string.wit"</span><span class="p">,</span>
<span class="w">        </span><span class="n">world</span><span class="p">:</span><span class="w"> </span><span class="s">"string-guest"</span><span class="p">,</span>
<span class="w">        </span><span class="k">async</span><span class="p">:</span><span class="w"> </span><span class="nc">true</span><span class="p">,</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="k">super</span><span class="p">::</span><span class="n">AsyncString</span><span class="p">;</span>
<span class="w">    </span><span class="n">export</span><span class="o">!</span><span class="p">(</span><span class="n">AsyncString</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">AsyncString</span><span class="p">;</span>


<span class="c1">// ✅ Implement `GuestStringRs` for `AsyncString`</span>

<span class="k">impl</span><span class="w"> </span><span class="n">GuestStringRs</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">AsyncString</span><span class="w"> </span><span class="p">{</span>


<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">string_fn</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">String</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s">"success"</span><span class="p">.</span><span class="n">to_string</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>


<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">Guest</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">AsyncString</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">type</span><span class="w"> </span><span class="nc">StringRs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AsyncString</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">fn</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"WASM executed successfully!"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<ul>
<li>cargo build --target wasm32-wasip2</li>
<li>wasmtime run target/wasm32-wasip2/debug/async-string.wasm</li>
</ul>
<h3>Expected Results</h3>
<p>WASM executed successfully! [This is what happens when async: false and async removed from fn string_fn]</p>
<h3>Actual Results</h3>
<p>Error: failed to parse WebAssembly module</p>
<p>Caused by:<br>
    invalid leading byte (0x9) for canonical function (at offset 0x3a8a7e)</p>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: <br>
wit-bindgen = { version= "0.38.0", features = ["async"] }<br>
wit-bindgen-rt = { version = "0.38.0", features = ["async"] }</p>
<p>Operating system: MacOS</p>
<p>Architecture: Arm</p>
<h3>Extra Info</h3>
<p>Here is a github with all the code:<br>
<a href="https://github.com/profitgrowinginnovator/async-string">https://github.com/profitgrowinginnovator/async-string</a></p>
<p>Similar module error is launched when an async wasm is read:<br>
Error: failed to parse WebAssembly module</p>
<p>Caused by:<br>
    invalid leading byte (0x9) for canonical function (at offset 0x3a8a7e)</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[tokio::main]</span><span class="w">  </span><span class="c1">// Requires the "macros" feature</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">anyhow</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="n">config</span><span class="p">.</span><span class="n">wasm_component_model</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">    </span><span class="n">config</span><span class="p">.</span><span class="n">async_support</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w"> </span><span class="c1">// Enable async support</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Engine</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">config</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//let mut linker = Linker::&lt;MyState&gt;::new(&amp;engine);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MyString</span><span class="p">::</span><span class="n">default</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Store</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">linker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Linker</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">component</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Component</span><span class="p">::</span><span class="n">from_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="s">"../async-string/target/wasm32-wasip2/debug/async-string.wasm"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">command</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Command</span><span class="p">::</span><span class="n">instantiate_async</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">component</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">linker</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">command</span><span class="p">.</span><span class="n">wasi_cli_run</span><span class="p">().</span><span class="n">call_run</span><span class="p">(</span><span class="n">store</span><span class="p">);</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Result from WASM: {:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="k">await</span><span class="p">);</span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>
</blockquote>



<a name="497255290"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310168%20When%20using%20async%3A%20true%20wasmtime%20r.../near/497255290" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310168.20When.20using.20async.3A.20true.20wasmtime.20r.2E.2E.2E.html#497255290">(Feb 02 2025 at 12:40)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/10168#issuecomment-2629380327">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10168">issue #10168</a>:</p>
<blockquote>
<p>Support for the async ABI of the component model is not yet implemented in Wasmtime as it was only recently introduced in the component model. There is an open PR to implement it: <a href="https://github.com/bytecodealliance/wasmtime/pull/9582">https://github.com/bytecodealliance/wasmtime/pull/9582</a></p>
</blockquote>



<a name="497354690"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310168%20When%20using%20async%3A%20true%20wasmtime%20r.../near/497354690" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310168.20When.20using.20async.3A.20true.20wasmtime.20r.2E.2E.2E.html#497354690">(Feb 03 2025 at 07:59)</a>:</h4>
<p>profitgrowinginnovator <a href="https://github.com/bytecodealliance/wasmtime/issues/10168#issuecomment-2630216688">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10168">issue #10168</a>:</p>
<blockquote>
<p>Thanks for letting me know. I just found out about <a href="https://github.com/bytecodealliance/wrpc">https://github.com/bytecodealliance/wrpc</a> Hopefully this solves it.</p>
</blockquote>



<a name="497354834"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310168%20When%20using%20async%3A%20true%20wasmtime%20r.../near/497354834" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310168.20When.20using.20async.3A.20true.20wasmtime.20r.2E.2E.2E.html#497354834">(Feb 03 2025 at 08:00)</a>:</h4>
<p>profitgrowinginnovator closed <a href="https://github.com/bytecodealliance/wasmtime/issues/10168">issue #10168</a>:</p>
<blockquote>
<h3>Test Case</h3>
<p>The wit file:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">package</span><span class="w"> </span><span class="n">sasync</span><span class="p">:</span><span class="nc">guest</span><span class="p">;</span>

<span class="n">interface</span><span class="w"> </span><span class="n">string</span><span class="o">-</span><span class="k">if</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="n">resource</span><span class="w"> </span><span class="n">string</span><span class="o">-</span><span class="n">rs</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="sd">/// Returns the name of the SaaS provider</span>
<span class="w">        </span><span class="n">string</span><span class="o">-</span><span class="k">fn</span><span class="p">:</span><span class="w"> </span><span class="nc">func</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">string</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">world</span><span class="w"> </span><span class="n">string</span><span class="o">-</span><span class="n">guest</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">export</span><span class="w"> </span><span class="n">string</span><span class="o">-</span><span class="k">if</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p><a href="http://main.rs">main.rs</a>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">bindings</span><span class="p">::</span><span class="n">exports</span><span class="p">::</span><span class="n">sasync</span><span class="p">::</span><span class="n">guest</span><span class="p">::</span><span class="n">string_if</span><span class="p">::{</span><span class="n">Guest</span><span class="p">,</span><span class="w"> </span><span class="n">GuestStringRs</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">wit_bindgen</span><span class="p">::</span><span class="n">generate</span><span class="p">;</span>


<span class="k">mod</span><span class="w"> </span><span class="nn">bindings</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">wit_bindgen</span><span class="p">::</span><span class="n">generate</span><span class="o">!</span><span class="p">({</span>
<span class="w">        </span><span class="n">path</span><span class="p">:</span><span class="w"> </span><span class="s">"./wit/async-string.wit"</span><span class="p">,</span>
<span class="w">        </span><span class="n">world</span><span class="p">:</span><span class="w"> </span><span class="s">"string-guest"</span><span class="p">,</span>
<span class="w">        </span><span class="k">async</span><span class="p">:</span><span class="w"> </span><span class="nc">true</span><span class="p">,</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="k">super</span><span class="p">::</span><span class="n">AsyncString</span><span class="p">;</span>
<span class="w">    </span><span class="n">export</span><span class="o">!</span><span class="p">(</span><span class="n">AsyncString</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">AsyncString</span><span class="p">;</span>


<span class="c1">// ✅ Implement `GuestStringRs` for `AsyncString`</span>

<span class="k">impl</span><span class="w"> </span><span class="n">GuestStringRs</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">AsyncString</span><span class="w"> </span><span class="p">{</span>


<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">string_fn</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">String</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s">"success"</span><span class="p">.</span><span class="n">to_string</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>


<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">Guest</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">AsyncString</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">type</span><span class="w"> </span><span class="nc">StringRs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AsyncString</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">fn</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"WASM executed successfully!"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<ul>
<li>cargo build --target wasm32-wasip2</li>
<li>wasmtime run target/wasm32-wasip2/debug/async-string.wasm</li>
</ul>
<h3>Expected Results</h3>
<p>WASM executed successfully! [This is what happens when async: false and async removed from fn string_fn]</p>
<h3>Actual Results</h3>
<p>Error: failed to parse WebAssembly module</p>
<p>Caused by:<br>
    invalid leading byte (0x9) for canonical function (at offset 0x3a8a7e)</p>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: <br>
wit-bindgen = { version= "0.38.0", features = ["async"] }<br>
wit-bindgen-rt = { version = "0.38.0", features = ["async"] }</p>
<p>Operating system: MacOS</p>
<p>Architecture: Arm</p>
<h3>Extra Info</h3>
<p>Here is a github with all the code:<br>
<a href="https://github.com/profitgrowinginnovator/async-string">https://github.com/profitgrowinginnovator/async-string</a></p>
<p>Similar module error is launched when an async wasm is read:<br>
Error: failed to parse WebAssembly module</p>
<p>Caused by:<br>
    invalid leading byte (0x9) for canonical function (at offset 0x3a8a7e)</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[tokio::main]</span><span class="w">  </span><span class="c1">// Requires the "macros" feature</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">anyhow</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="n">config</span><span class="p">.</span><span class="n">wasm_component_model</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">    </span><span class="n">config</span><span class="p">.</span><span class="n">async_support</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w"> </span><span class="c1">// Enable async support</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Engine</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">config</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//let mut linker = Linker::&lt;MyState&gt;::new(&amp;engine);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MyString</span><span class="p">::</span><span class="n">default</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Store</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">linker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Linker</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">component</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Component</span><span class="p">::</span><span class="n">from_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="s">"../async-string/target/wasm32-wasip2/debug/async-string.wasm"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">command</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Command</span><span class="p">::</span><span class="n">instantiate_async</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">component</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">linker</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">command</span><span class="p">.</span><span class="n">wasi_cli_run</span><span class="p">().</span><span class="n">call_run</span><span class="p">(</span><span class="n">store</span><span class="p">);</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Result from WASM: {:?}"</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="k">await</span><span class="p">);</span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>
</blockquote>



<hr><p>Last updated: Feb 22 2026 at 11:05 UTC</p>
</html>
<html>
<head><meta charset="utf-8"><title>wasmtime / issue #11974 20% increase in component latency... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311974.2020.25.20increase.20in.20component.20latency.2E.2E.2E.html">wasmtime / issue #11974 20% increase in component latency...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="553503378"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311974%2020%25%20increase%20in%20component%20latency.../near/553503378" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311974.2020.25.20increase.20in.20component.20latency.2E.2E.2E.html#553503378">(Nov 04 2025 at 00:19)</a>:</h4>
<p>EthanBlackburn opened <a href="https://github.com/bytecodealliance/wasmtime/issues/11974">issue #11974</a>:</p>
<blockquote>
<p>I upgraded wasmtime from 34.0.2 to 35.0.0 and noticed the average latency of our wasm components increased by ~20%. On-CPU profiles look slightly cheaper in 35, but off-CPU shows a large increase in time parked in finish_task_switch.isra.0. The issue persists even when upgrading to wasmtime 38.0.3</p>
<p>34.0.2 vs 35.0.0 on-cpu<br>
![Image](<a href="https://github.com/user-attachments/assets/8d75e201-8329-42c8-9155-8dd5c1f3e382">https://github.com/user-attachments/assets/8d75e201-8329-42c8-9155-8dd5c1f3e382</a>)</p>
<p>34.0.2 vs 35.0.0 off-cpu<br>
![Image](<a href="https://github.com/user-attachments/assets/d51885cf-7354-4d62-a785-60f371548031">https://github.com/user-attachments/assets/d51885cf-7354-4d62-a785-60f371548031</a>)</p>
<p>34.0.2 vs 38.0.0 on-cpu<br>
![Image](<a href="https://github.com/user-attachments/assets/bce3db8f-7384-4344-9ed3-93af9b97d31f">https://github.com/user-attachments/assets/bce3db8f-7384-4344-9ed3-93af9b97d31f</a>)</p>
<p>34.0.2 vs 38.0.0 off-cpu<br>
![Image](<a href="https://github.com/user-attachments/assets/e1a45f84-db49-461f-843e-932ea91710f4">https://github.com/user-attachments/assets/e1a45f84-db49-461f-843e-932ea91710f4</a>)</p>
<h3>Test Case</h3>
<p><a href="https://telophase-public-terraform.s3.us-west-2.amazonaws.com/34.component.wasm">Compiled with 34.0.2</a><br>
<a href="https://telophase-public-terraform.s3.us-west-2.amazonaws.com/35.component.wasm">Compiled with 35.0.0</a><br>
<a href="https://telophase-public-terraform.s3.us-west-2.amazonaws.com/38.component.wasm">Compiled with 38.0.3</a></p>
<h3>Steps to Reproduce</h3>
<p>Benchmarking a wasm component compiled from <a href="https://github.com/telophasehq/tangent/blob/main/examples/golang/main.go">this go code</a></p>
<p><strong>Build on 34.0.2</strong></p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/telophasehq/tangent
<span class="nb">cd</span><span class="w"> </span>~/tangent/examples/golang
mkdir<span class="w"> </span>plugins

make<span class="w"> </span>run

<span class="o">(</span><span class="k">in</span><span class="w"> </span>a<span class="w"> </span>separate<span class="w"> </span>window<span class="o">)</span>
tangent<span class="w"> </span>bench<span class="w"> </span>--config<span class="w"> </span>tangent.yaml<span class="w"> </span>--seconds<span class="w"> </span><span class="m">30</span><span class="w"> </span>--payload<span class="w"> </span>tests/input.json
</code></pre></div>
<p>This will print some stats like</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">producer</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="p">(</span><span class="n">consumed</span><span class="p">):</span><span class="w"> </span><span class="mf">6861.75</span><span class="w"> </span><span class="n">MiB</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="mf">228.66</span><span class="w"> </span><span class="n">MiB</span><span class="o">/</span><span class="n">s</span>
<span class="n">guest</span><span class="p">:</span><span class="w"> </span><span class="nc">bytes_in</span><span class="o">=</span><span class="mf">6854.63</span><span class="w"> </span><span class="n">MiB</span><span class="p">,</span><span class="w"> </span><span class="n">avg_latency</span><span class="o">=</span><span class="mf">12.824</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="p">(</span><span class="n">over</span><span class="w"> </span><span class="mi">29179</span><span class="w"> </span><span class="n">calls</span><span class="p">)</span>
</code></pre></div>
<p><strong>Build on 38.0.3</strong></p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>git<span class="w"> </span>fetch<span class="w"> </span>origin<span class="w"> </span>wasmtime-38
git<span class="w"> </span>checkout<span class="w"> </span>wasmtime-38
make<span class="w"> </span>run

<span class="o">(</span><span class="k">in</span><span class="w"> </span>a<span class="w"> </span>separate<span class="w"> </span>window<span class="o">)</span>
tangent<span class="w"> </span>bench<span class="w"> </span>--config<span class="w"> </span>tangent.yaml<span class="w"> </span>--seconds<span class="w"> </span><span class="m">30</span><span class="w"> </span>--payload<span class="w"> </span>tests/input.json
</code></pre></div>
<p>This will print stats showing guest latency and throughput are lower</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">producer</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="p">(</span><span class="n">consumed</span><span class="p">):</span><span class="w"> </span><span class="mf">5855.87</span><span class="w"> </span><span class="n">MiB</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="mf">195.15</span><span class="w"> </span><span class="n">MiB</span><span class="o">/</span><span class="n">s</span>
<span class="n">guest</span><span class="p">:</span><span class="w"> </span><span class="nc">bytes_in</span><span class="o">=</span><span class="mf">5848.09</span><span class="w"> </span><span class="n">MiB</span><span class="p">,</span><span class="w"> </span><span class="n">avg_latency</span><span class="o">=</span><span class="mf">15.845</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="p">(</span><span class="n">over</span><span class="w"> </span><span class="mi">24617</span><span class="w"> </span><span class="n">calls</span><span class="p">)</span>
</code></pre></div>
<h3>Expected Results</h3>
<p>I expected guest latency to stay the say the same</p>
<h3>Actual Results</h3>
<p>average guest latency as reported by the the benchmark is ~20% higher in wasmtime version 35.0.0 or higher</p>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: 34.0.2 (good), 35.0.0 (bad), 38.0.3 (bad)</p>
<p>Operating system: Darwin</p>
<p>Architecture: arm64</p>
<p>I see the same issue on Linux aarch64</p>
<h3>Extra Info</h3>
<p>I feel like I've misconfigured something or am not using the async API correctly, but I'm not sure where to start looking.</p>
<p>Additionally, if y'all suspect there is an issue in wasmtime async I'm happy to poke around myself if I can get some pointers<br>
</p>
</blockquote>



<a name="553503379"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311974%2020%25%20increase%20in%20component%20latency.../near/553503379" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311974.2020.25.20increase.20in.20component.20latency.2E.2E.2E.html#553503379">(Nov 04 2025 at 00:19)</a>:</h4>
<p><a href="https://github.com/EthanBlackburn">EthanBlackburn</a> added the bug label to <a href="https://github.com/bytecodealliance/wasmtime/issues/11974">Issue #11974</a>.</p>



<a name="553504124"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311974%2020%25%20increase%20in%20component%20latency.../near/553504124" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311974.2020.25.20increase.20in.20component.20latency.2E.2E.2E.html#553504124">(Nov 04 2025 at 00:27)</a>:</h4>
<p>EthanBlackburn edited <a href="https://github.com/bytecodealliance/wasmtime/issues/11974">issue #11974</a>:</p>
<blockquote>
<p>I upgraded wasmtime from 34.0.2 to 35.0.0 and noticed the average latency of our wasm components increased by ~20%. On-CPU profiles look slightly cheaper in 35, but off-CPU shows a large increase in time parked in finish_task_switch.isra.0. The issue persists even when upgrading to wasmtime 38.0.3</p>
<p>34.0.2 vs 35.0.0 on-cpu<br>
![Image](<a href="https://github.com/user-attachments/assets/8d75e201-8329-42c8-9155-8dd5c1f3e382">https://github.com/user-attachments/assets/8d75e201-8329-42c8-9155-8dd5c1f3e382</a>)</p>
<p>34.0.2 vs 35.0.0 off-cpu<br>
![Image](<a href="https://github.com/user-attachments/assets/d51885cf-7354-4d62-a785-60f371548031">https://github.com/user-attachments/assets/d51885cf-7354-4d62-a785-60f371548031</a>)</p>
<p>34.0.2 vs 38.0.0 on-cpu<br>
![Image](<a href="https://github.com/user-attachments/assets/bce3db8f-7384-4344-9ed3-93af9b97d31f">https://github.com/user-attachments/assets/bce3db8f-7384-4344-9ed3-93af9b97d31f</a>)</p>
<p>34.0.2 vs 38.0.0 off-cpu<br>
![Image](<a href="https://github.com/user-attachments/assets/e1a45f84-db49-461f-843e-932ea91710f4">https://github.com/user-attachments/assets/e1a45f84-db49-461f-843e-932ea91710f4</a>)</p>
<h3>Test Case</h3>
<p><a href="https://telophase-public-terraform.s3.us-west-2.amazonaws.com/34.component.wasm">Compiled with 34.0.2</a><br>
<a href="https://telophase-public-terraform.s3.us-west-2.amazonaws.com/35.component.wasm">Compiled with 35.0.0</a><br>
<a href="https://telophase-public-terraform.s3.us-west-2.amazonaws.com/38.component.wasm">Compiled with 38.0.3</a></p>
<h3>Steps to Reproduce</h3>
<p>Benchmarking a wasm component compiled from <a href="https://github.com/telophasehq/tangent/blob/main/examples/golang/main.go">this go code</a></p>
<p><strong>Build on 34.0.2</strong></p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/telophasehq/tangent
<span class="nb">cd</span><span class="w"> </span>tangent<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>cargo<span class="w"> </span>build<span class="w"> </span>--bin<span class="w"> </span>tangent<span class="w"> </span>--release
<span class="nb">cd</span><span class="w"> </span>~/tangent/examples/golang
mkdir<span class="w"> </span>plugins

make<span class="w"> </span>run

<span class="o">(</span><span class="k">in</span><span class="w"> </span>a<span class="w"> </span>separate<span class="w"> </span>window<span class="o">)</span>
tangent<span class="w"> </span>bench<span class="w"> </span>--config<span class="w"> </span>tangent.yaml<span class="w"> </span>--seconds<span class="w"> </span><span class="m">30</span><span class="w"> </span>--payload<span class="w"> </span>tests/input.json
</code></pre></div>
<p>This will print some stats like</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">producer</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="p">(</span><span class="n">consumed</span><span class="p">):</span><span class="w"> </span><span class="mf">6861.75</span><span class="w"> </span><span class="n">MiB</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="mf">228.66</span><span class="w"> </span><span class="n">MiB</span><span class="o">/</span><span class="n">s</span>
<span class="n">guest</span><span class="p">:</span><span class="w"> </span><span class="nc">bytes_in</span><span class="o">=</span><span class="mf">6854.63</span><span class="w"> </span><span class="n">MiB</span><span class="p">,</span><span class="w"> </span><span class="n">avg_latency</span><span class="o">=</span><span class="mf">12.824</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="p">(</span><span class="n">over</span><span class="w"> </span><span class="mi">29179</span><span class="w"> </span><span class="n">calls</span><span class="p">)</span>
</code></pre></div>
<p><strong>Build on 38.0.3</strong></p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>git<span class="w"> </span>fetch<span class="w"> </span>origin<span class="w"> </span>wasmtime-38
git<span class="w"> </span>checkout<span class="w"> </span>wasmtime-38
make<span class="w"> </span>run

<span class="o">(</span><span class="k">in</span><span class="w"> </span>a<span class="w"> </span>separate<span class="w"> </span>window<span class="o">)</span>
tangent<span class="w"> </span>bench<span class="w"> </span>--config<span class="w"> </span>tangent.yaml<span class="w"> </span>--seconds<span class="w"> </span><span class="m">30</span><span class="w"> </span>--payload<span class="w"> </span>tests/input.json
</code></pre></div>
<p>This will print stats showing guest latency and throughput are lower</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">producer</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="p">(</span><span class="n">consumed</span><span class="p">):</span><span class="w"> </span><span class="mf">5855.87</span><span class="w"> </span><span class="n">MiB</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="mf">195.15</span><span class="w"> </span><span class="n">MiB</span><span class="o">/</span><span class="n">s</span>
<span class="n">guest</span><span class="p">:</span><span class="w"> </span><span class="nc">bytes_in</span><span class="o">=</span><span class="mf">5848.09</span><span class="w"> </span><span class="n">MiB</span><span class="p">,</span><span class="w"> </span><span class="n">avg_latency</span><span class="o">=</span><span class="mf">15.845</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="p">(</span><span class="n">over</span><span class="w"> </span><span class="mi">24617</span><span class="w"> </span><span class="n">calls</span><span class="p">)</span>
</code></pre></div>
<h3>Expected Results</h3>
<p>I expected guest latency to stay the say the same</p>
<h3>Actual Results</h3>
<p>average guest latency as reported by the the benchmark is ~20% higher in wasmtime version 35.0.0 or higher</p>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: 34.0.2 (good), 35.0.0 (bad), 38.0.3 (bad)</p>
<p>Operating system: Darwin</p>
<p>Architecture: arm64</p>
<p>I see the same issue on Linux aarch64</p>
<h3>Extra Info</h3>
<p>I feel like I've misconfigured something or am not using the async API correctly, but I'm not sure where to start looking.</p>
<p>Additionally, if y'all suspect there is an issue in wasmtime async I'm happy to poke around myself if I can get some pointers<br>
</p>
</blockquote>



<a name="553506379"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311974%2020%25%20increase%20in%20component%20latency.../near/553506379" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311974.2020.25.20increase.20in.20component.20latency.2E.2E.2E.html#553506379">(Nov 04 2025 at 00:52)</a>:</h4>
<p>EthanBlackburn edited <a href="https://github.com/bytecodealliance/wasmtime/issues/11974">issue #11974</a>:</p>
<blockquote>
<p>I upgraded wasmtime from 34.0.2 to 35.0.0 and noticed the average latency of our wasm components increased by ~20%. On-CPU profiles look slightly cheaper in 35, but off-CPU shows a large increase in time parked in finish_task_switch.isra.0. The issue persists even when upgrading to wasmtime 38.0.3</p>
<p>34.0.2 vs 35.0.0 on-cpu<br>
![Image](<a href="https://github.com/user-attachments/assets/8d75e201-8329-42c8-9155-8dd5c1f3e382">https://github.com/user-attachments/assets/8d75e201-8329-42c8-9155-8dd5c1f3e382</a>)</p>
<p>34.0.2 vs 35.0.0 off-cpu<br>
![Image](<a href="https://github.com/user-attachments/assets/d51885cf-7354-4d62-a785-60f371548031">https://github.com/user-attachments/assets/d51885cf-7354-4d62-a785-60f371548031</a>)</p>
<p>34.0.2 vs 38.0.0 on-cpu<br>
![Image](<a href="https://github.com/user-attachments/assets/bce3db8f-7384-4344-9ed3-93af9b97d31f">https://github.com/user-attachments/assets/bce3db8f-7384-4344-9ed3-93af9b97d31f</a>)</p>
<p>34.0.2 vs 38.0.3 off-cpu<br>
![Image](<a href="https://github.com/user-attachments/assets/e1a45f84-db49-461f-843e-932ea91710f4">https://github.com/user-attachments/assets/e1a45f84-db49-461f-843e-932ea91710f4</a>)</p>
<h3>Test Case</h3>
<p><a href="https://telophase-public-terraform.s3.us-west-2.amazonaws.com/34.component.wasm">Compiled with 34.0.2</a><br>
<a href="https://telophase-public-terraform.s3.us-west-2.amazonaws.com/35.component.wasm">Compiled with 35.0.0</a><br>
<a href="https://telophase-public-terraform.s3.us-west-2.amazonaws.com/38.component.wasm">Compiled with 38.0.3</a></p>
<h3>Steps to Reproduce</h3>
<p>Benchmarking a wasm component compiled from <a href="https://github.com/telophasehq/tangent/blob/main/examples/golang/main.go">this go code</a></p>
<p><strong>Build on 34.0.2</strong></p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/telophasehq/tangent
<span class="nb">cd</span><span class="w"> </span>tangent<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>cargo<span class="w"> </span>build<span class="w"> </span>--bin<span class="w"> </span>tangent<span class="w"> </span>--release
<span class="nb">cd</span><span class="w"> </span>~/tangent/examples/golang
mkdir<span class="w"> </span>plugins

make<span class="w"> </span>run

<span class="o">(</span><span class="k">in</span><span class="w"> </span>a<span class="w"> </span>separate<span class="w"> </span>window<span class="o">)</span>
tangent<span class="w"> </span>bench<span class="w"> </span>--config<span class="w"> </span>tangent.yaml<span class="w"> </span>--seconds<span class="w"> </span><span class="m">30</span><span class="w"> </span>--payload<span class="w"> </span>tests/input.json
</code></pre></div>
<p>This will print some stats like</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">producer</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="p">(</span><span class="n">consumed</span><span class="p">):</span><span class="w"> </span><span class="mf">6861.75</span><span class="w"> </span><span class="n">MiB</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="mf">228.66</span><span class="w"> </span><span class="n">MiB</span><span class="o">/</span><span class="n">s</span>
<span class="n">guest</span><span class="p">:</span><span class="w"> </span><span class="nc">bytes_in</span><span class="o">=</span><span class="mf">6854.63</span><span class="w"> </span><span class="n">MiB</span><span class="p">,</span><span class="w"> </span><span class="n">avg_latency</span><span class="o">=</span><span class="mf">12.824</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="p">(</span><span class="n">over</span><span class="w"> </span><span class="mi">29179</span><span class="w"> </span><span class="n">calls</span><span class="p">)</span>
</code></pre></div>
<p><strong>Build on 38.0.3</strong></p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>git<span class="w"> </span>fetch<span class="w"> </span>origin<span class="w"> </span>wasmtime-38
git<span class="w"> </span>checkout<span class="w"> </span>wasmtime-38
make<span class="w"> </span>run

<span class="o">(</span><span class="k">in</span><span class="w"> </span>a<span class="w"> </span>separate<span class="w"> </span>window<span class="o">)</span>
tangent<span class="w"> </span>bench<span class="w"> </span>--config<span class="w"> </span>tangent.yaml<span class="w"> </span>--seconds<span class="w"> </span><span class="m">30</span><span class="w"> </span>--payload<span class="w"> </span>tests/input.json
</code></pre></div>
<p>This will print stats showing guest latency and throughput are lower</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">producer</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="p">(</span><span class="n">consumed</span><span class="p">):</span><span class="w"> </span><span class="mf">5855.87</span><span class="w"> </span><span class="n">MiB</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="mf">195.15</span><span class="w"> </span><span class="n">MiB</span><span class="o">/</span><span class="n">s</span>
<span class="n">guest</span><span class="p">:</span><span class="w"> </span><span class="nc">bytes_in</span><span class="o">=</span><span class="mf">5848.09</span><span class="w"> </span><span class="n">MiB</span><span class="p">,</span><span class="w"> </span><span class="n">avg_latency</span><span class="o">=</span><span class="mf">15.845</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="p">(</span><span class="n">over</span><span class="w"> </span><span class="mi">24617</span><span class="w"> </span><span class="n">calls</span><span class="p">)</span>
</code></pre></div>
<h3>Expected Results</h3>
<p>I expected guest latency to stay the say the same</p>
<h3>Actual Results</h3>
<p>average guest latency as reported by the the benchmark is ~20% higher in wasmtime version 35.0.0 or higher</p>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: 34.0.2 (good), 35.0.0 (bad), 38.0.3 (bad)</p>
<p>Operating system: Darwin</p>
<p>Architecture: arm64</p>
<p>I see the same issue on Linux aarch64</p>
<h3>Extra Info</h3>
<p>I feel like I've misconfigured something or am not using the async API correctly, but I'm not sure where to start looking.</p>
<p>Additionally, if y'all suspect there is an issue in wasmtime async I'm happy to poke around myself if I can get some pointers<br>
</p>
</blockquote>



<a name="553506397"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311974%2020%25%20increase%20in%20component%20latency.../near/553506397" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311974.2020.25.20increase.20in.20component.20latency.2E.2E.2E.html#553506397">(Nov 04 2025 at 00:52)</a>:</h4>
<p>EthanBlackburn edited <a href="https://github.com/bytecodealliance/wasmtime/issues/11974">issue #11974</a>:</p>
<blockquote>
<p>I upgraded wasmtime from 34.0.2 to 35.0.0 and noticed the average latency of our wasm components increased by ~20%. On-CPU profiles look slightly cheaper in 35, but off-CPU shows a large increase in time parked in finish_task_switch.isra.0. The issue persists even when upgrading to wasmtime 38.0.3</p>
<p>34.0.2 vs 35.0.0 on-cpu<br>
![Image](<a href="https://github.com/user-attachments/assets/8d75e201-8329-42c8-9155-8dd5c1f3e382">https://github.com/user-attachments/assets/8d75e201-8329-42c8-9155-8dd5c1f3e382</a>)</p>
<p>34.0.2 vs 35.0.0 off-cpu<br>
![Image](<a href="https://github.com/user-attachments/assets/d51885cf-7354-4d62-a785-60f371548031">https://github.com/user-attachments/assets/d51885cf-7354-4d62-a785-60f371548031</a>)</p>
<p>34.0.2 vs 38.0.3 on-cpu<br>
![Image](<a href="https://github.com/user-attachments/assets/bce3db8f-7384-4344-9ed3-93af9b97d31f">https://github.com/user-attachments/assets/bce3db8f-7384-4344-9ed3-93af9b97d31f</a>)</p>
<p>34.0.2 vs 38.0.3 off-cpu<br>
![Image](<a href="https://github.com/user-attachments/assets/e1a45f84-db49-461f-843e-932ea91710f4">https://github.com/user-attachments/assets/e1a45f84-db49-461f-843e-932ea91710f4</a>)</p>
<h3>Test Case</h3>
<p><a href="https://telophase-public-terraform.s3.us-west-2.amazonaws.com/34.component.wasm">Compiled with 34.0.2</a><br>
<a href="https://telophase-public-terraform.s3.us-west-2.amazonaws.com/35.component.wasm">Compiled with 35.0.0</a><br>
<a href="https://telophase-public-terraform.s3.us-west-2.amazonaws.com/38.component.wasm">Compiled with 38.0.3</a></p>
<h3>Steps to Reproduce</h3>
<p>Benchmarking a wasm component compiled from <a href="https://github.com/telophasehq/tangent/blob/main/examples/golang/main.go">this go code</a></p>
<p><strong>Build on 34.0.2</strong></p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/telophasehq/tangent
<span class="nb">cd</span><span class="w"> </span>tangent<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>cargo<span class="w"> </span>build<span class="w"> </span>--bin<span class="w"> </span>tangent<span class="w"> </span>--release
<span class="nb">cd</span><span class="w"> </span>~/tangent/examples/golang
mkdir<span class="w"> </span>plugins

make<span class="w"> </span>run

<span class="o">(</span><span class="k">in</span><span class="w"> </span>a<span class="w"> </span>separate<span class="w"> </span>window<span class="o">)</span>
tangent<span class="w"> </span>bench<span class="w"> </span>--config<span class="w"> </span>tangent.yaml<span class="w"> </span>--seconds<span class="w"> </span><span class="m">30</span><span class="w"> </span>--payload<span class="w"> </span>tests/input.json
</code></pre></div>
<p>This will print some stats like</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">producer</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="p">(</span><span class="n">consumed</span><span class="p">):</span><span class="w"> </span><span class="mf">6861.75</span><span class="w"> </span><span class="n">MiB</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="mf">228.66</span><span class="w"> </span><span class="n">MiB</span><span class="o">/</span><span class="n">s</span>
<span class="n">guest</span><span class="p">:</span><span class="w"> </span><span class="nc">bytes_in</span><span class="o">=</span><span class="mf">6854.63</span><span class="w"> </span><span class="n">MiB</span><span class="p">,</span><span class="w"> </span><span class="n">avg_latency</span><span class="o">=</span><span class="mf">12.824</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="p">(</span><span class="n">over</span><span class="w"> </span><span class="mi">29179</span><span class="w"> </span><span class="n">calls</span><span class="p">)</span>
</code></pre></div>
<p><strong>Build on 38.0.3</strong></p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>git<span class="w"> </span>fetch<span class="w"> </span>origin<span class="w"> </span>wasmtime-38
git<span class="w"> </span>checkout<span class="w"> </span>wasmtime-38
make<span class="w"> </span>run

<span class="o">(</span><span class="k">in</span><span class="w"> </span>a<span class="w"> </span>separate<span class="w"> </span>window<span class="o">)</span>
tangent<span class="w"> </span>bench<span class="w"> </span>--config<span class="w"> </span>tangent.yaml<span class="w"> </span>--seconds<span class="w"> </span><span class="m">30</span><span class="w"> </span>--payload<span class="w"> </span>tests/input.json
</code></pre></div>
<p>This will print stats showing guest latency and throughput are lower</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">producer</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="p">(</span><span class="n">consumed</span><span class="p">):</span><span class="w"> </span><span class="mf">5855.87</span><span class="w"> </span><span class="n">MiB</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="mf">195.15</span><span class="w"> </span><span class="n">MiB</span><span class="o">/</span><span class="n">s</span>
<span class="n">guest</span><span class="p">:</span><span class="w"> </span><span class="nc">bytes_in</span><span class="o">=</span><span class="mf">5848.09</span><span class="w"> </span><span class="n">MiB</span><span class="p">,</span><span class="w"> </span><span class="n">avg_latency</span><span class="o">=</span><span class="mf">15.845</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="p">(</span><span class="n">over</span><span class="w"> </span><span class="mi">24617</span><span class="w"> </span><span class="n">calls</span><span class="p">)</span>
</code></pre></div>
<h3>Expected Results</h3>
<p>I expected guest latency to stay the say the same</p>
<h3>Actual Results</h3>
<p>average guest latency as reported by the the benchmark is ~20% higher in wasmtime version 35.0.0 or higher</p>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: 34.0.2 (good), 35.0.0 (bad), 38.0.3 (bad)</p>
<p>Operating system: Darwin</p>
<p>Architecture: arm64</p>
<p>I see the same issue on Linux aarch64</p>
<h3>Extra Info</h3>
<p>I feel like I've misconfigured something or am not using the async API correctly, but I'm not sure where to start looking.</p>
<p>Additionally, if y'all suspect there is an issue in wasmtime async I'm happy to poke around myself if I can get some pointers<br>
</p>
</blockquote>



<a name="553514429"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311974%2020%25%20increase%20in%20component%20latency.../near/553514429" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311974.2020.25.20increase.20in.20component.20latency.2E.2E.2E.html#553514429">(Nov 04 2025 at 02:14)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/11974#issuecomment-3483431780">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11974">issue #11974</a>:</p>
<blockquote>
<p>Bisection shows <a href="https://github.com/bytecodealliance/wasmtime/pull/10959">https://github.com/bytecodealliance/wasmtime/pull/10959</a> as the culprit. Local testing shows that <a href="https://github.com/bytecodealliance/wasmtime/blob/1ec866079720e573fc2aa06947c84f6132010993/crates/wasmtime/src/runtime/component/func/host.rs#L262">this clone</a> is the exact culprit.</p>
<p>I'm not sure how this factors in the on/off cpu graphs you're showing myself, but I've also never gotten a perf comparison to ever work before either. Nevertheless this makes sense to me because it's a highly contended atomic inc/dec which is plausible that it could cause a slowdown such as this. I'll see if I can poke around tomorrow and see what comes up.</p>
</blockquote>



<a name="553514441"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311974%2020%25%20increase%20in%20component%20latency.../near/553514441" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311974.2020.25.20increase.20in.20component.20latency.2E.2E.2E.html#553514441">(Nov 04 2025 at 02:14)</a>:</h4>
<p><a href="https://github.com/alexcrichton">alexcrichton</a> added the performance label to <a href="https://github.com/bytecodealliance/wasmtime/issues/11974">Issue #11974</a>.</p>



<a name="553514674"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311974%2020%25%20increase%20in%20component%20latency.../near/553514674" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311974.2020.25.20increase.20in.20component.20latency.2E.2E.2E.html#553514674">(Nov 04 2025 at 02:16)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/11974#issuecomment-3483438897">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11974">issue #11974</a>:</p>
<blockquote>
<p>Also, I should mention, thank you for the thorough report!</p>
</blockquote>



<a name="553531067"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311974%2020%25%20increase%20in%20component%20latency.../near/553531067" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311974.2020.25.20increase.20in.20component.20latency.2E.2E.2E.html#553531067">(Nov 04 2025 at 05:38)</a>:</h4>
<p>EthanBlackburn <a href="https://github.com/bytecodealliance/wasmtime/issues/11974#issuecomment-3483992559">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11974">issue #11974</a>:</p>
<blockquote>
<p>You got it. Thank you for the fast response! I'm also seeing the problem start on that commit. </p>
<p>I'll test the <code>Arc::clone</code> theory tomorrow as well and Im interested to see the result. My understanding is that clone would show up as on-cpu time instead of off-cpu time, but Im out of my depth here</p>
<p>Will report back</p>
</blockquote>



<a name="553694791"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311974%2020%25%20increase%20in%20component%20latency.../near/553694791" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311974.2020.25.20increase.20in.20component.20latency.2E.2E.2E.html#553694791">(Nov 04 2025 at 19:15)</a>:</h4>
<p>EthanBlackburn <a href="https://github.com/bytecodealliance/wasmtime/issues/11974#issuecomment-3487652247">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11974">issue #11974</a>:</p>
<blockquote>
<p>You were right!</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/pull/11979">https://github.com/bytecodealliance/wasmtime/pull/11979</a></p>
<p>Before change</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">producer</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="p">(</span><span class="n">consumed</span><span class="p">):</span><span class="w"> </span><span class="mf">2798.62</span><span class="w"> </span><span class="n">MiB</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="mf">93.28</span><span class="w"> </span><span class="n">MiB</span><span class="o">/</span><span class="n">s</span>
<span class="n">guest</span><span class="p">:</span><span class="w"> </span><span class="nc">bytes_in</span><span class="o">=</span><span class="mf">2794.94</span><span class="w"> </span><span class="n">MiB</span><span class="p">,</span><span class="w"> </span><span class="n">avg_latency</span><span class="o">=</span><span class="mf">19.490</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="p">(</span><span class="n">over</span><span class="w"> </span><span class="mi">12169</span><span class="w"> </span><span class="n">calls</span><span class="p">)</span>
</code></pre></div>
<p>After change</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">producer</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="p">(</span><span class="n">consumed</span><span class="p">):</span><span class="w"> </span><span class="mf">3731.03</span><span class="w"> </span><span class="n">MiB</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="mf">124.36</span><span class="w"> </span><span class="n">MiB</span><span class="o">/</span><span class="n">s</span>
<span class="n">guest</span><span class="p">:</span><span class="w"> </span><span class="nc">bytes_in</span><span class="o">=</span><span class="mf">3728.28</span><span class="w"> </span><span class="n">MiB</span><span class="p">,</span><span class="w"> </span><span class="n">avg_latency</span><span class="o">=</span><span class="mf">13.473</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="p">(</span><span class="n">over</span><span class="w"> </span><span class="mi">16252</span><span class="w"> </span><span class="n">calls</span><span class="p">)</span>
</code></pre></div><br>
</p>
</blockquote>



<a name="553957983"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311974%2020%25%20increase%20in%20component%20latency.../near/553957983" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311974.2020.25.20increase.20in.20component.20latency.2E.2E.2E.html#553957983">(Nov 05 2025 at 20:38)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/11974#issuecomment-3493292693">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11974">issue #11974</a>:</p>
<blockquote>
<p>Ok <a href="https://github.com/bytecodealliance/wasmtime/pull/11987">https://github.com/bytecodealliance/wasmtime/pull/11987</a> is what I came up with for this. Still uses <code>unsafe</code> but it's needed for a number of other locations other than this one and is something I've wanted to do for awhile as well. My hope is that it's encapsulated as well as the external interface is a safe one, it's "just" an unsafe implementation.</p>
</blockquote>



<a name="554108143"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311974%2020%25%20increase%20in%20component%20latency.../near/554108143" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311974.2020.25.20increase.20in.20component.20latency.2E.2E.2E.html#554108143">(Nov 06 2025 at 14:42)</a>:</h4>
<p>EthanBlackburn <a href="https://github.com/bytecodealliance/wasmtime/issues/11974#issuecomment-3497579003">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11974">issue #11974</a>:</p>
<blockquote>
<p>Let's gooo! Thanks for the fast turnaround.</p>
<p>BTW, since you mentioned you hadn't gotten a perf comparison to work before, here's what I did</p>
<p>On-CPU</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">(</span><span class="n">run</span><span class="w"> </span><span class="n">server</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"> </span><span class="mf">34.0.2</span><span class="p">)</span>
<span class="n">perf</span><span class="w"> </span><span class="n">record</span><span class="w"> </span><span class="o">-</span><span class="n">F</span><span class="w"> </span><span class="mi">999</span><span class="w"> </span><span class="o">-</span><span class="n">g</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="n">tangent</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">config</span><span class="w"> </span><span class="n">examples</span><span class="o">/</span><span class="n">golang</span><span class="o">/</span><span class="n">tangent</span><span class="p">.</span><span class="n">yaml</span>
<span class="n">perf</span><span class="w"> </span><span class="n">script</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">~/</span><span class="n">FlameGraph</span><span class="o">/</span><span class="n">stackcollapse</span><span class="o">-</span><span class="n">perf</span><span class="p">.</span><span class="n">pl</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">34.</span><span class="n">folded</span>

<span class="p">(</span><span class="n">run</span><span class="w"> </span><span class="n">server</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"> </span><span class="mf">38.0.3</span><span class="p">)</span>
<span class="n">perf</span><span class="w"> </span><span class="n">record</span><span class="w"> </span><span class="o">-</span><span class="n">F</span><span class="w"> </span><span class="mi">999</span><span class="w"> </span><span class="o">-</span><span class="n">g</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="n">tangent</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">config</span><span class="w"> </span><span class="n">examples</span><span class="o">/</span><span class="n">golang</span><span class="o">/</span><span class="n">tangent</span><span class="p">.</span><span class="n">yaml</span>
<span class="n">perf</span><span class="w"> </span><span class="n">script</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">~/</span><span class="n">FlameGraph</span><span class="o">/</span><span class="n">stackcollapse</span><span class="o">-</span><span class="n">perf</span><span class="p">.</span><span class="n">pl</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">38.</span><span class="n">folded</span>

<span class="o">~/</span><span class="n">FlameGraph</span><span class="o">/</span><span class="n">difffolded</span><span class="p">.</span><span class="n">pl</span><span class="w"> </span><span class="mf">34.</span><span class="n">folded</span><span class="w"> </span><span class="mf">38.</span><span class="n">folded</span><span class="w"> </span><span class="o">|</span><span class="w">   </span><span class="o">~/</span><span class="n">FlameGraph</span><span class="o">/</span><span class="n">flamegraph</span><span class="p">.</span><span class="n">pl</span><span class="w"> </span><span class="o">--</span><span class="n">negate</span><span class="w"> </span><span class="o">--</span><span class="n">title</span><span class="w"> </span><span class="s">"Wasmtime 38 vs 34 (red=regression)"</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">diff</span><span class="o">-</span><span class="mi">34</span><span class="o">-</span><span class="mf">38.</span><span class="n">svg</span>
</code></pre></div>
<p>Off-CPU</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">(</span><span class="k">while</span><span class="w"> </span><span class="n">our</span><span class="w"> </span><span class="n">server</span><span class="w"> </span><span class="n">was</span><span class="w"> </span><span class="n">running</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"> </span><span class="mf">34.0.2</span><span class="p">)</span>
<span class="n">sudo</span><span class="w"> </span><span class="n">offcputime</span><span class="w"> </span><span class="o">-</span><span class="n">f</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="cp">$(</span><span class="n">pgrep</span><span class="w"> </span><span class="o">-</span><span class="n">n</span><span class="w"> </span><span class="n">tangent</span><span class="p">)</span><span class="w"> </span><span class="mi">30</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">offcpu34</span><span class="p">.</span><span class="n">folded</span>

<span class="p">(</span><span class="k">while</span><span class="w"> </span><span class="n">our</span><span class="w"> </span><span class="n">server</span><span class="w"> </span><span class="n">was</span><span class="w"> </span><span class="n">running</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"> </span><span class="mf">38.0.3</span><span class="p">)</span>
<span class="n">sudo</span><span class="w"> </span><span class="n">offcputime</span><span class="w"> </span><span class="o">-</span><span class="n">f</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="cp">$(</span><span class="n">pgrep</span><span class="w"> </span><span class="o">-</span><span class="n">n</span><span class="w"> </span><span class="n">tangent</span><span class="p">)</span><span class="w"> </span><span class="mi">30</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">offcpu38</span><span class="p">.</span><span class="n">folded</span>

<span class="o">~/</span><span class="n">FlameGraph</span><span class="o">/</span><span class="n">difffolded</span><span class="p">.</span><span class="n">pl</span><span class="w"> </span><span class="n">offcpu34</span><span class="p">.</span><span class="n">folded</span><span class="w"> </span><span class="n">offcpu35</span><span class="p">.</span><span class="n">folded</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">~/</span><span class="n">FlameGraph</span><span class="o">/</span><span class="n">flamegraph</span><span class="p">.</span><span class="n">pl</span><span class="w"> </span><span class="o">--</span><span class="n">negate</span><span class="w"> </span><span class="o">--</span><span class="n">title</span><span class="w"> </span><span class="s">"Off-CPU diff: 35 vs 34 (red = more wait)"</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">offcpu</span><span class="o">-</span><span class="n">diff</span><span class="o">-</span><span class="mi">34</span><span class="o">-</span><span class="mf">35.</span><span class="n">svg</span>
</code></pre></div>
<p>Shoutout Brendan Gregg for <a href="https://github.com/brendangregg/FlameGraph">FlameGraph</a> and offcputime</p>
</blockquote>



<a name="554408520"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311974%2020%25%20increase%20in%20component%20latency.../near/554408520" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311974.2020.25.20increase.20in.20component.20latency.2E.2E.2E.html#554408520">(Nov 07 2025 at 20:13)</a>:</h4>
<p>alexcrichton closed <a href="https://github.com/bytecodealliance/wasmtime/issues/11974">issue #11974</a>:</p>
<blockquote>
<p>I upgraded wasmtime from 34.0.2 to 35.0.0 and noticed the average latency of our wasm components increased by ~20%. On-CPU profiles look slightly cheaper in 35, but off-CPU shows a large increase in time parked in finish_task_switch.isra.0. The issue persists even when upgrading to wasmtime 38.0.3</p>
<p>34.0.2 vs 35.0.0 on-cpu<br>
![Image](<a href="https://github.com/user-attachments/assets/8d75e201-8329-42c8-9155-8dd5c1f3e382">https://github.com/user-attachments/assets/8d75e201-8329-42c8-9155-8dd5c1f3e382</a>)</p>
<p>34.0.2 vs 35.0.0 off-cpu<br>
![Image](<a href="https://github.com/user-attachments/assets/d51885cf-7354-4d62-a785-60f371548031">https://github.com/user-attachments/assets/d51885cf-7354-4d62-a785-60f371548031</a>)</p>
<p>34.0.2 vs 38.0.3 on-cpu<br>
![Image](<a href="https://github.com/user-attachments/assets/bce3db8f-7384-4344-9ed3-93af9b97d31f">https://github.com/user-attachments/assets/bce3db8f-7384-4344-9ed3-93af9b97d31f</a>)</p>
<p>34.0.2 vs 38.0.3 off-cpu<br>
![Image](<a href="https://github.com/user-attachments/assets/e1a45f84-db49-461f-843e-932ea91710f4">https://github.com/user-attachments/assets/e1a45f84-db49-461f-843e-932ea91710f4</a>)</p>
<h3>Test Case</h3>
<p><a href="https://telophase-public-terraform.s3.us-west-2.amazonaws.com/34.component.wasm">Compiled with 34.0.2</a><br>
<a href="https://telophase-public-terraform.s3.us-west-2.amazonaws.com/35.component.wasm">Compiled with 35.0.0</a><br>
<a href="https://telophase-public-terraform.s3.us-west-2.amazonaws.com/38.component.wasm">Compiled with 38.0.3</a></p>
<h3>Steps to Reproduce</h3>
<p>Benchmarking a wasm component compiled from <a href="https://github.com/telophasehq/tangent/blob/main/examples/golang/main.go">this go code</a></p>
<p><strong>Build on 34.0.2</strong></p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/telophasehq/tangent
<span class="nb">cd</span><span class="w"> </span>tangent<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>cargo<span class="w"> </span>build<span class="w"> </span>--bin<span class="w"> </span>tangent<span class="w"> </span>--release
<span class="nb">cd</span><span class="w"> </span>~/tangent/examples/golang
mkdir<span class="w"> </span>plugins

make<span class="w"> </span>run

<span class="o">(</span><span class="k">in</span><span class="w"> </span>a<span class="w"> </span>separate<span class="w"> </span>window<span class="o">)</span>
tangent<span class="w"> </span>bench<span class="w"> </span>--config<span class="w"> </span>tangent.yaml<span class="w"> </span>--seconds<span class="w"> </span><span class="m">30</span><span class="w"> </span>--payload<span class="w"> </span>tests/input.json
</code></pre></div>
<p>This will print some stats like</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">producer</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="p">(</span><span class="n">consumed</span><span class="p">):</span><span class="w"> </span><span class="mf">6861.75</span><span class="w"> </span><span class="n">MiB</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="mf">228.66</span><span class="w"> </span><span class="n">MiB</span><span class="o">/</span><span class="n">s</span>
<span class="n">guest</span><span class="p">:</span><span class="w"> </span><span class="nc">bytes_in</span><span class="o">=</span><span class="mf">6854.63</span><span class="w"> </span><span class="n">MiB</span><span class="p">,</span><span class="w"> </span><span class="n">avg_latency</span><span class="o">=</span><span class="mf">12.824</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="p">(</span><span class="n">over</span><span class="w"> </span><span class="mi">29179</span><span class="w"> </span><span class="n">calls</span><span class="p">)</span>
</code></pre></div>
<p><strong>Build on 38.0.3</strong></p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>git<span class="w"> </span>fetch<span class="w"> </span>origin<span class="w"> </span>wasmtime-38
git<span class="w"> </span>checkout<span class="w"> </span>wasmtime-38
make<span class="w"> </span>run

<span class="o">(</span><span class="k">in</span><span class="w"> </span>a<span class="w"> </span>separate<span class="w"> </span>window<span class="o">)</span>
tangent<span class="w"> </span>bench<span class="w"> </span>--config<span class="w"> </span>tangent.yaml<span class="w"> </span>--seconds<span class="w"> </span><span class="m">30</span><span class="w"> </span>--payload<span class="w"> </span>tests/input.json
</code></pre></div>
<p>This will print stats showing guest latency and throughput are lower</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">producer</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="p">(</span><span class="n">consumed</span><span class="p">):</span><span class="w"> </span><span class="mf">5855.87</span><span class="w"> </span><span class="n">MiB</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="mf">195.15</span><span class="w"> </span><span class="n">MiB</span><span class="o">/</span><span class="n">s</span>
<span class="n">guest</span><span class="p">:</span><span class="w"> </span><span class="nc">bytes_in</span><span class="o">=</span><span class="mf">5848.09</span><span class="w"> </span><span class="n">MiB</span><span class="p">,</span><span class="w"> </span><span class="n">avg_latency</span><span class="o">=</span><span class="mf">15.845</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="p">(</span><span class="n">over</span><span class="w"> </span><span class="mi">24617</span><span class="w"> </span><span class="n">calls</span><span class="p">)</span>
</code></pre></div>
<h3>Expected Results</h3>
<p>I expected guest latency to stay the say the same</p>
<h3>Actual Results</h3>
<p>average guest latency as reported by the the benchmark is ~20% higher in wasmtime version 35.0.0 or higher</p>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: 34.0.2 (good), 35.0.0 (bad), 38.0.3 (bad)</p>
<p>Operating system: Darwin</p>
<p>Architecture: arm64</p>
<p>I see the same issue on Linux aarch64</p>
<h3>Extra Info</h3>
<p>I feel like I've misconfigured something or am not using the async API correctly, but I'm not sure where to start looking.</p>
<p>Additionally, if y'all suspect there is an issue in wasmtime async I'm happy to poke around myself if I can get some pointers<br>
</p>
</blockquote>



<hr><p>Last updated: Feb 22 2026 at 11:05 UTC</p>
</html>
<html>
<head><meta charset="utf-8"><title>wasmtime / PR #12629 fix `Pollable` impl for `OutgoingDat... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312629.20fix.20.60Pollable.60.20impl.20for.20.60OutgoingDat.2E.2E.2E.html">wasmtime / PR #12629 fix `Pollable` impl for `OutgoingDat...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="575014492"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312629%20fix%20%60Pollable%60%20impl%20for%20%60OutgoingDat.../near/575014492" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312629.20fix.20.60Pollable.60.20impl.20for.20.60OutgoingDat.2E.2E.2E.html#575014492">(Feb 20 2026 at 19:26)</a>:</h4>
<p>dicej requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-wasi-reviewers">wasmtime-wasi-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/12629">PR #12629</a>.</p>



<a name="575014493"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312629%20fix%20%60Pollable%60%20impl%20for%20%60OutgoingDat.../near/575014493" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312629.20fix.20.60Pollable.60.20impl.20for.20.60OutgoingDat.2E.2E.2E.html#575014493">(Feb 20 2026 at 19:26)</a>:</h4>
<p>dicej opened <a href="https://github.com/bytecodealliance/wasmtime/pull/12629">PR #12629</a> from <code>dicej:outgoing-datagram-stream-pollable-fix</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>Previously, <code>OutgoingDatagramStream</code> used its <code>send_state</code> field to determine whether the socket was ready for writing without necessarily polling the <code>tokio::net::UdpSocket</code>.  The underlying assumption was that a freshly-bound socket would be immediately ready for writing, but that's not true for <code>tokio</code>. <code>tokio</code> assumes a socket is not ready for _anything_ by default and relies on e.g. <code>epoll</code> to tell it otherwise.</p>
<p>In practice, this meant the <code>Pollable::ready</code> impl for <code>OutgoingDatagramStream</code> would resolve immediately for a fresh socket, leaving the guest to race with <code>tokio</code>'s use of <code>epoll</code>.  Usually, <code>tokio</code> won and all was well, but occasionally it lost and the <code>OutgoingDatagramStream::send</code> call would return <code>Ok(0)</code> (meaning "would block") leaving the guest confused since it was just told that the socket was ready for writing.</p>
<p>This commit removes <code>SendState</code> entirely, relying exclusively on <code>tokio::net::UdpSocket::ready</code> for the <code>Pollable</code> and <code>check_send</code> implementations.  As a side effect, we no longer attempt to prevent the guest from sending more datagrams than <code>check_send</code> indicated since the number returned by <code>check_send</code> is only a guess anyway, and <code>tokio</code> will push back if it needs to.  For <code>p3</code>, the whole <code>check_send</code>/<code>send</code> pattern is gone, so we won't need to concern ourselves with it going forward.</p>
<p>Fixes #12612</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="575014495"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312629%20fix%20%60Pollable%60%20impl%20for%20%60OutgoingDat.../near/575014495" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312629.20fix.20.60Pollable.60.20impl.20for.20.60OutgoingDat.2E.2E.2E.html#575014495">(Feb 20 2026 at 19:26)</a>:</h4>
<p>dicej requested <a href="https://github.com/cfallin">cfallin</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/12629">PR #12629</a>.</p>



<a name="575014496"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312629%20fix%20%60Pollable%60%20impl%20for%20%60OutgoingDat.../near/575014496" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312629.20fix.20.60Pollable.60.20impl.20for.20.60OutgoingDat.2E.2E.2E.html#575014496">(Feb 20 2026 at 19:26)</a>:</h4>
<p>dicej requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers">wasmtime-core-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/12629">PR #12629</a>.</p>



<a name="575014525"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312629%20fix%20%60Pollable%60%20impl%20for%20%60OutgoingDat.../near/575014525" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312629.20fix.20.60Pollable.60.20impl.20for.20.60OutgoingDat.2E.2E.2E.html#575014525">(Feb 20 2026 at 19:26)</a>:</h4>
<p>dicej requested <a href="https://github.com/alexcrichton">alexcrichton</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/12629">PR #12629</a>.</p>



<a name="575014577"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312629%20fix%20%60Pollable%60%20impl%20for%20%60OutgoingDat.../near/575014577" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312629.20fix.20.60Pollable.60.20impl.20for.20.60OutgoingDat.2E.2E.2E.html#575014577">(Feb 20 2026 at 19:27)</a>:</h4>
<p>dicej unassigned cfallin from <a href="https://github.com/bytecodealliance/wasmtime/pull/12629">PR #12629 fix <code>Pollable</code> impl for <code>OutgoingDatagramStream</code></a>.</p>



<a name="575014668"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312629%20fix%20%60Pollable%60%20impl%20for%20%60OutgoingDat.../near/575014668" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312629.20fix.20.60Pollable.60.20impl.20for.20.60OutgoingDat.2E.2E.2E.html#575014668">(Feb 20 2026 at 19:27)</a>:</h4>
<p>dicej <a href="https://github.com/bytecodealliance/wasmtime/pull/12629#issuecomment-3936690129">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/12629">PR #12629</a>:</p>
<blockquote>
<p>cc @badeend in case you're interested</p>
</blockquote>



<a name="575015060"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312629%20fix%20%60Pollable%60%20impl%20for%20%60OutgoingDat.../near/575015060" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312629.20fix.20.60Pollable.60.20impl.20for.20.60OutgoingDat.2E.2E.2E.html#575015060">(Feb 20 2026 at 19:30)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/12629#pullrequestreview-3833866243">PR review</a>.</p>



<a name="575015061"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312629%20fix%20%60Pollable%60%20impl%20for%20%60OutgoingDat.../near/575015061" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312629.20fix.20.60Pollable.60.20impl.20for.20.60OutgoingDat.2E.2E.2E.html#575015061">(Feb 20 2026 at 19:30)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/12629#discussion_r2834781343">PR review comment</a>:</p>
<blockquote>
<p>Could this additionally <code>debug_assert!</code> that <code>count == 0</code>?</p>
</blockquote>



<a name="575015105"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312629%20fix%20%60Pollable%60%20impl%20for%20%60OutgoingDat.../near/575015105" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312629.20fix.20.60Pollable.60.20impl.20for.20.60OutgoingDat.2E.2E.2E.html#575015105">(Feb 20 2026 at 19:30)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/12629#issuecomment-3936705261">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/12629">PR #12629</a>:</p>
<blockquote>
<p>Also, if you're up for it, I think it'd be good to test this on p3 too (semantically at least)</p>
</blockquote>



<a name="575021493"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312629%20fix%20%60Pollable%60%20impl%20for%20%60OutgoingDat.../near/575021493" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312629.20fix.20.60Pollable.60.20impl.20for.20.60OutgoingDat.2E.2E.2E.html#575021493">(Feb 20 2026 at 20:16)</a>:</h4>
<p>dicej updated <a href="https://github.com/bytecodealliance/wasmtime/pull/12629">PR #12629</a>.</p>



<a name="575021540"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312629%20fix%20%60Pollable%60%20impl%20for%20%60OutgoingDat.../near/575021540" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312629.20fix.20.60Pollable.60.20impl.20for.20.60OutgoingDat.2E.2E.2E.html#575021540">(Feb 20 2026 at 20:16)</a>:</h4>
<p>dicej has enabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/12629">PR #12629</a>.</p>



<a name="575023391"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312629%20fix%20%60Pollable%60%20impl%20for%20%60OutgoingDat.../near/575023391" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312629.20fix.20.60Pollable.60.20impl.20for.20.60OutgoingDat.2E.2E.2E.html#575023391">(Feb 20 2026 at 20:30)</a>:</h4>
<p>dicej added <a href="https://github.com/bytecodealliance/wasmtime/pull/12629">PR #12629 fix <code>Pollable</code> impl for <code>OutgoingDatagramStream</code></a> to the merge queue</p>



<a name="575026488"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312629%20fix%20%60Pollable%60%20impl%20for%20%60OutgoingDat.../near/575026488" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312629.20fix.20.60Pollable.60.20impl.20for.20.60OutgoingDat.2E.2E.2E.html#575026488">(Feb 20 2026 at 20:53)</a>:</h4>
<p>dicej merged <a href="https://github.com/bytecodealliance/wasmtime/pull/12629">PR #12629</a>.</p>



<a name="575026489"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312629%20fix%20%60Pollable%60%20impl%20for%20%60OutgoingDat.../near/575026489" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312629.20fix.20.60Pollable.60.20impl.20for.20.60OutgoingDat.2E.2E.2E.html#575026489">(Feb 20 2026 at 20:53)</a>:</h4>
<p>dicej removed <a href="https://github.com/bytecodealliance/wasmtime/pull/12629">PR #12629 fix <code>Pollable</code> impl for <code>OutgoingDatagramStream</code></a> from the merge queue</p>



<a name="575068978"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312629%20fix%20%60Pollable%60%20impl%20for%20%60OutgoingDat.../near/575068978" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312629.20fix.20.60Pollable.60.20impl.20for.20.60OutgoingDat.2E.2E.2E.html#575068978">(Feb 21 2026 at 07:49)</a>:</h4>
<p>badeend <a href="https://github.com/bytecodealliance/wasmtime/pull/12629#issuecomment-3938401148">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/12629">PR #12629</a>:</p>
<blockquote>
<blockquote>
<p>As a side effect, we no longer attempt to prevent the guest from sending more datagrams than check_send indicated since the number returned by check_send is only a guess anyway</p>
</blockquote>
<p>@dicej This violates the <a href="https://github.com/WebAssembly/WASI/blob/41d0de898ec7568e032129156a3bc567d7ebea5d/proposals/sockets/wit/udp.wit#L256C1-L257C111">P2 spec</a>:</p>
<blockquote>
<p>Each call to <code>send</code> must be permitted by a preceding <code>check-send</code>. Implementations must trap if either <code>check-send</code> was not called or <code>datagrams</code> contains more items than <code>check-send</code> permitted.</p>
</blockquote>
<p>Can the check be reintroduced?</p>
</blockquote>



<a name="575104150"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312629%20fix%20%60Pollable%60%20impl%20for%20%60OutgoingDat.../near/575104150" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312629.20fix.20.60Pollable.60.20impl.20for.20.60OutgoingDat.2E.2E.2E.html#575104150">(Feb 21 2026 at 18:06)</a>:</h4>
<p>dicej <a href="https://github.com/bytecodealliance/wasmtime/pull/12629#issuecomment-3939183415">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/12629">PR #12629</a>:</p>
<blockquote>
<blockquote>
<p>@dicej This violates the <a href="https://github.com/WebAssembly/WASI/blob/41d0de898ec7568e032129156a3bc567d7ebea5d/proposals/sockets/wit/udp.wit#L256C1-L257C111">P2 spec</a>:</p>
<blockquote>
<p>Each call to <code>send</code> must be permitted by a preceding <code>check-send</code>. Implementations must trap if either <code>check-send</code> was not called or <code>datagrams</code> contains more items than <code>check-send</code> permitted.</p>
</blockquote>
<p>Can the check be reintroduced?</p>
</blockquote>
<p><span aria-label="face palm" class="emoji emoji-1f926" role="img" title="face palm">:face_palm:</span> Yes, I'll do that on Monday.  Thanks for catching that.</p>
</blockquote>



<hr><p>Last updated: Feb 22 2026 at 11:05 UTC</p>
</html>
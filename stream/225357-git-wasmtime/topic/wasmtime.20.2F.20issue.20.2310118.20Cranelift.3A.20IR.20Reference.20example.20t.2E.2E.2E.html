<html>
<head><meta charset="utf-8"><title>wasmtime / issue #10118 Cranelift: IR Reference example t... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310118.20Cranelift.3A.20IR.20Reference.20example.20t.2E.2E.2E.html">wasmtime / issue #10118 Cranelift: IR Reference example t...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="496021889"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310118%20Cranelift%3A%20IR%20Reference%20example%20t.../near/496021889" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310118.20Cranelift.3A.20IR.20Reference.20example.20t.2E.2E.2E.html#496021889">(Jan 27 2025 at 01:52)</a>:</h4>
<p><a href="https://github.com/iwanders">iwanders</a> added the cranelift label to <a href="https://github.com/bytecodealliance/wasmtime/issues/10118">Issue #10118</a>.</p>



<a name="496021890"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310118%20Cranelift%3A%20IR%20Reference%20example%20t.../near/496021890" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310118.20Cranelift.3A.20IR.20Reference.20example.20t.2E.2E.2E.html#496021890">(Jan 27 2025 at 01:52)</a>:</h4>
<p><a href="https://github.com/iwanders">iwanders</a> added the bug label to <a href="https://github.com/bytecodealliance/wasmtime/issues/10118">Issue #10118</a>.</p>



<a name="496021891"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310118%20Cranelift%3A%20IR%20Reference%20example%20t.../near/496021891" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310118.20Cranelift.3A.20IR.20Reference.20example.20t.2E.2E.2E.html#496021891">(Jan 27 2025 at 01:52)</a>:</h4>
<p>iwanders opened <a href="https://github.com/bytecodealliance/wasmtime/issues/10118">issue #10118</a>:</p>
<blockquote>
<h3><code>.clif</code> Test Case</h3>
<p>The Cranelift IR <code>average</code> example code from the <a href="https://github.com/bytecodealliance/wasmtime/blob/5dfccc078bb3dcad152d37013dde8067f197e6e7/cranelift/docs/ir.md#overall-structure">docs/ir.md</a>. I've already added that to the filetests test directory in caeafe27c69804e14c10d28d25ce511488afd212. </p>
<p>Using <code>clif-util</code>;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">../</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">clif</span><span class="o">-</span><span class="n">util</span><span class="w">  </span><span class="n">bugpoint</span><span class="w">  </span><span class="n">filetests</span><span class="o">/</span><span class="n">filetests</span><span class="o">/</span><span class="n">isa</span><span class="o">/</span><span class="n">x64</span><span class="o">/</span><span class="n">average</span><span class="p">.</span><span class="n">clif</span><span class="w"> </span><span class="n">x86_64</span>
<span class="n">After</span><span class="w"> </span><span class="n">pass</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">remaining</span><span class="w"> </span><span class="n">insts</span><span class="o">/</span><span class="n">blocks</span><span class="p">:</span><span class="w"> </span><span class="mi">22</span><span class="o">/</span><span class="mi">3</span><span class="w"> </span><span class="p">(</span><span class="n">will</span><span class="w"> </span><span class="n">keep</span><span class="w"> </span><span class="n">reducing</span><span class="p">)</span>
<span class="n">After</span><span class="w"> </span><span class="n">pass</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">remaining</span><span class="w"> </span><span class="n">insts</span><span class="o">/</span><span class="n">blocks</span><span class="p">:</span><span class="w"> </span><span class="mi">13</span><span class="o">/</span><span class="mi">3</span><span class="w"> </span><span class="p">(</span><span class="n">will</span><span class="w"> </span><span class="n">keep</span><span class="w"> </span><span class="n">reducing</span><span class="p">)</span>
<span class="n">After</span><span class="w"> </span><span class="n">pass</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">remaining</span><span class="w"> </span><span class="n">insts</span><span class="o">/</span><span class="n">blocks</span><span class="p">:</span><span class="w"> </span><span class="mi">13</span><span class="o">/</span><span class="mi">3</span><span class="w"> </span><span class="p">(</span><span class="n">stop</span><span class="w"> </span><span class="n">reducing</span><span class="p">)</span>
<span class="err">████████████████████████████████████████████████████████████</span><span class="w"> </span><span class="n">pass</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">phase</span><span class="w"> </span><span class="n">merge</span><span class="w"> </span><span class="n">blocks</span><span class="w">                   </span><span class="mi">2</span><span class="o">/</span><span class="w">   </span><span class="mi">2</span><span class="w"> </span><span class="n">Remove</span><span class="w"> </span><span class="n">unused</span><span class="w"> </span><span class="n">global</span><span class="w"> </span><span class="n">values</span>
<span class="n">Crash</span><span class="w"> </span><span class="n">message</span><span class="p">:</span><span class="w"> </span><span class="nc">assertion</span><span class="w"> </span><span class="err">`</span><span class="n">left</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">right</span><span class="err">`</span><span class="w"> </span><span class="n">failed</span>
<span class="w">  </span><span class="n">left</span><span class="p">:</span><span class="w"> </span><span class="nc">types</span><span class="p">::</span><span class="n">I32</span>
<span class="w"> </span><span class="n">right</span><span class="p">:</span><span class="w"> </span><span class="nc">types</span><span class="p">::</span><span class="n">I64</span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">average</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="nc">system_v</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ss0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">8</span>

<span class="n">block1</span><span class="p">:</span>
<span class="w">    </span><span class="nc">v0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="n">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="n">v5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="n">v6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v5</span><span class="w">  </span><span class="p">;</span><span class="w"> </span><span class="n">v0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">v5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="n">v9</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f64const</span><span class="w"> </span><span class="mf">0.0</span>
<span class="w">    </span><span class="n">v100</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f32const</span><span class="w"> </span><span class="o">+</span><span class="n">NaN</span>
<span class="w">    </span><span class="n">brif</span><span class="w"> </span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="n">block2</span><span class="p">,</span><span class="w"> </span><span class="n">block5</span><span class="w">  </span><span class="p">;</span><span class="w"> </span><span class="n">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>

<span class="n">block2</span><span class="p">:</span>
<span class="w">    </span><span class="nc">v7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">f32</span><span class="w"> </span><span class="n">v6</span>
<span class="w">    </span><span class="n">v8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fpromote</span><span class="p">.</span><span class="kt">f64</span><span class="w"> </span><span class="n">v7</span>
<span class="w">    </span><span class="n">v10</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fadd</span><span class="w"> </span><span class="n">v8</span><span class="p">,</span><span class="w"> </span><span class="n">v9</span><span class="w">  </span><span class="p">;</span><span class="w"> </span><span class="n">v9</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span>
<span class="w">    </span><span class="n">stack_store</span><span class="w"> </span><span class="n">v10</span><span class="p">,</span><span class="w"> </span><span class="n">ss0</span>
<span class="w">    </span><span class="n">trap</span><span class="w"> </span><span class="n">user1</span>

<span class="n">block5</span><span class="p">:</span>
<span class="w">    </span><span class="nc">return</span><span class="w"> </span><span class="n">v100</span><span class="w">  </span><span class="p">;</span><span class="w"> </span><span class="n">v100</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">+</span><span class="n">NaN</span>
<span class="p">}</span>

<span class="mi">5</span><span class="w"> </span><span class="n">blocks</span><span class="w"> </span><span class="mi">22</span><span class="w"> </span><span class="n">insts</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">blocks</span><span class="w"> </span><span class="mi">13</span><span class="w"> </span><span class="n">insts</span>
</code></pre></div>
<p>Manually, I reduced it to the following:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">average</span><span class="p">(</span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="nc">system_v</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ss0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">8</span><span class="w">        </span><span class="p">;</span><span class="w"> </span><span class="n">Stack</span><span class="w"> </span><span class="n">slot</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="err">`</span><span class="n">sum</span><span class="err">`</span>

<span class="n">block1</span><span class="p">(</span><span class="n">v0</span><span class="p">:</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="p">:</span><span class="w"> </span><span class="kt">i32</span><span class="p">):</span>
<span class="w">    </span><span class="nc">v20</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f64const</span><span class="w"> </span><span class="mh">0x0</span><span class="p">.</span><span class="mi">0</span><span class="w">         </span><span class="p">;</span><span class="w"> </span><span class="n">Create</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="kt">f64</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="n">just</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">initialise</span><span class="w"> </span><span class="n">ss0</span><span class="p">.</span>
<span class="w">    </span><span class="n">stack_store</span><span class="w"> </span><span class="n">v20</span><span class="p">,</span><span class="w"> </span><span class="n">ss0</span><span class="w">         </span><span class="p">;</span><span class="w"> </span><span class="n">Store</span><span class="w"> </span><span class="kt">f64</span><span class="w"> </span><span class="n">into</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">ss0</span><span class="w"> </span><span class="n">stack</span><span class="w"> </span><span class="n">slot</span><span class="p">,</span><span class="w"> </span><span class="n">just</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">initialise</span><span class="w"> </span><span class="n">ss0</span><span class="p">.</span>
<span class="w">    </span><span class="n">v6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="w">             </span><span class="p">;</span><span class="w"> </span><span class="n">Adds</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">input</span><span class="w"> </span><span class="n">together</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">integers</span><span class="p">,</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="kt">i32</span><span class="o">?</span>
<span class="w">    </span><span class="n">v7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">f32</span><span class="w"> </span><span class="n">v6</span><span class="w">             </span><span class="p">;</span><span class="w"> </span><span class="n">Converts</span><span class="w"> </span><span class="n">v7</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="kt">i32</span><span class="p">.</span>
<span class="w">    </span><span class="n">v8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fpromote</span><span class="p">.</span><span class="kt">f64</span><span class="w"> </span><span class="n">v7</span><span class="w">         </span><span class="p">;</span><span class="w"> </span><span class="n">converts</span><span class="w"> </span><span class="n">v7</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="kt">f64</span><span class="w"> </span><span class="n">into</span><span class="w"> </span><span class="n">v8</span><span class="p">.</span>
<span class="w">    </span><span class="n">v9</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stack_load</span><span class="p">.</span><span class="kt">f64</span><span class="w"> </span><span class="n">ss0</span><span class="w">      </span><span class="p">;</span><span class="w"> </span><span class="n">Loads</span><span class="w"> </span><span class="n">ss0</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">stack</span><span class="w"> </span><span class="n">into</span><span class="w"> </span><span class="n">v9</span><span class="p">,</span><span class="w"> </span><span class="n">v9</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="kt">f64</span><span class="w"> </span><span class="n">that</span><span class="o">'</span><span class="na">s</span><span class="w"> </span><span class="mf">0.0</span>
<span class="w">    </span><span class="n">v10</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fadd</span><span class="p">.</span><span class="kt">f64</span><span class="w"> </span><span class="n">v8</span><span class="p">,</span><span class="w"> </span><span class="n">v9</span><span class="w">        </span><span class="p">;</span><span class="w"> </span><span class="n">Adds</span><span class="w"> </span><span class="n">v8</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">v9</span><span class="w"> </span><span class="n">together</span><span class="p">,</span><span class="w"> </span><span class="n">both</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="kt">f64</span><span class="o">'</span><span class="na">s</span><span class="p">,</span><span class="w"> </span><span class="n">so</span><span class="w"> </span><span class="n">v10</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="kt">f64</span><span class="p">.</span>
<span class="w">    </span><span class="n">stack_store</span><span class="w"> </span><span class="n">v10</span><span class="p">,</span><span class="w"> </span><span class="n">ss0</span><span class="w">         </span><span class="p">;</span><span class="w"> </span><span class="n">Write</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="n">back</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">ss0</span><span class="p">.</span>
<span class="w">    </span><span class="n">v100</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f32const</span><span class="w"> </span><span class="o">+</span><span class="n">NaN</span><span class="w">         </span><span class="p">;</span><span class="w"> </span><span class="n">Just</span><span class="w"> </span><span class="n">creating</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">dummy</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="k">return</span><span class="p">.</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v100</span><span class="w">                  </span><span class="p">;</span><span class="w"> </span><span class="n">Return</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">dummy</span><span class="p">.</span>
<span class="p">}</span>
</code></pre></div>
<p>Instructions themselves seem fine to me, but today is the first day I'm looking at Cranelift at all, so I absolutely may be missing something obvious.</p>
<h3>Steps to Reproduce</h3>
<ul>
<li>Cherrypick caeafe27c69804e14c10d28d25ce511488afd212</li>
<li><code>cd cranelift</code></li>
<li><code>cargo t</code> (note without <code>--release</code>, test will pass with <code>--release</code>).</li>
</ul>
<p>Note, the problem is with <code>x86_64</code>, this function compiles fine with <code>aarch64</code>.</p>
<h3>Expected Results</h3>
<p>I would expect the example function provided in the documentation to compile, it compiles on <code>aarch64</code>, which (to me at least) indicates the function is fine. I would expect this to also compile on <code>x86_64</code>.</p>
<h3>Actual Results</h3>
<p>A debug assert triggers on <a href="https://github.com/bytecodealliance/wasmtime/blob/5dfccc078bb3dcad152d37013dde8067f197e6e7/cranelift/codegen/src/isa/x64/lower.rs#L233">this line</a>;</p>
<p>&lt;details&gt;<br>
&lt;summary&gt;Backtrace&lt;/summary&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">----</span><span class="w"> </span><span class="n">filetests</span><span class="w"> </span><span class="n">stdout</span><span class="w"> </span><span class="o">----</span>
<span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">worker</span><span class="w"> </span><span class="p">#</span><span class="mi">7</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">cranelift</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">isa</span><span class="o">/</span><span class="n">x64</span><span class="o">/</span><span class="n">lower</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">233</span><span class="p">:</span><span class="mi">9</span><span class="p">:</span>
<span class="nc">assertion</span><span class="w"> </span><span class="err">`</span><span class="n">left</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">right</span><span class="err">`</span><span class="w"> </span><span class="n">failed</span>
<span class="w">  </span><span class="n">left</span><span class="p">:</span><span class="w"> </span><span class="nc">types</span><span class="p">::</span><span class="n">I32</span>
<span class="w"> </span><span class="n">right</span><span class="p">:</span><span class="w"> </span><span class="nc">types</span><span class="p">::</span><span class="n">I64</span>
<span class="n">stack</span><span class="w"> </span><span class="n">backtrace</span><span class="p">:</span>
<span class="w">   </span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="nc">rust_begin_unwind</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mi">9</span><span class="n">fc6b43126469e3858e2fe86cafb4f0fd5068869</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panicking</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">665</span><span class="p">:</span><span class="mi">5</span>
<span class="w">   </span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="nc">core</span><span class="p">::</span><span class="n">panicking</span><span class="p">::</span><span class="n">panic_fmt</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mi">9</span><span class="n">fc6b43126469e3858e2fe86cafb4f0fd5068869</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panicking</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">76</span><span class="p">:</span><span class="mi">14</span>
<span class="w">   </span><span class="mi">2</span><span class="p">:</span><span class="w"> </span><span class="nc">core</span><span class="p">::</span><span class="n">panicking</span><span class="p">::</span><span class="n">assert_failed_inner</span>
<span class="w">   </span><span class="mi">3</span><span class="p">:</span><span class="w"> </span><span class="nc">core</span><span class="p">::</span><span class="n">panicking</span><span class="p">::</span><span class="n">assert_failed</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">ivor</span><span class="o">/</span><span class="p">.</span><span class="n">rustup</span><span class="o">/</span><span class="n">toolchains</span><span class="o">/</span><span class="n">stable</span><span class="o">-</span><span class="n">x86_64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">rustlib</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">rust</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panicking</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">373</span><span class="p">:</span><span class="mi">5</span>
<span class="w">   </span><span class="mi">4</span><span class="p">:</span><span class="w"> </span><span class="nc">cranelift_codegen</span><span class="p">::</span><span class="n">isa</span><span class="p">::</span><span class="n">x64</span><span class="p">::</span><span class="n">lower</span><span class="p">::</span><span class="n">lower_to_amode</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">isa</span><span class="o">/</span><span class="n">x64</span><span class="o">/</span><span class="n">lower</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">233</span><span class="p">:</span><span class="mi">9</span>
<span class="w">   </span><span class="mi">5</span><span class="p">:</span><span class="w"> </span><span class="nc">cranelift_codegen</span><span class="p">::</span><span class="n">isa</span><span class="p">::</span><span class="n">x64</span><span class="p">::</span><span class="n">lower</span><span class="p">::</span><span class="n">isle</span><span class="p">::</span><span class="o">&lt;</span><span class="k">impl</span><span class="w"> </span><span class="n">cranelift_codegen</span><span class="p">::</span><span class="n">isa</span><span class="p">::</span><span class="n">x64</span><span class="p">::</span><span class="n">lower</span><span class="p">::</span><span class="n">isle</span><span class="p">::</span><span class="n">generated_code</span><span class="p">::</span><span class="n">Context</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">cranelift_codegen</span><span class="p">::</span><span class="n">machinst</span><span class="p">::</span><span class="n">isle</span><span class="p">::</span><span class="n">IsleContext</span><span class="o">&lt;</span><span class="n">cranelift_codegen</span><span class="p">::</span><span class="n">isa</span><span class="p">::</span><span class="n">x64</span><span class="p">::</span><span class="n">lower</span><span class="p">::</span><span class="n">isle</span><span class="p">::</span><span class="n">generated_code</span><span class="p">::</span><span class="n">MInst</span><span class="p">,</span><span class="n">cranelift_codegen</span><span class="p">::</span><span class="n">isa</span><span class="p">::</span><span class="n">x64</span><span class="p">::</span><span class="n">X64Backend</span><span class="o">&gt;&gt;</span><span class="p">::</span><span class="n">sink_load</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">isa</span><span class="o">/</span><span class="n">x64</span><span class="o">/</span><span class="n">lower</span><span class="o">/</span><span class="n">isle</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">313</span><span class="p">:</span><span class="mi">20</span>
<span class="w">   </span><span class="mi">6</span><span class="p">:</span><span class="w"> </span><span class="nc">cranelift_codegen</span><span class="p">::</span><span class="n">isa</span><span class="p">::</span><span class="n">x64</span><span class="p">::</span><span class="n">lower</span><span class="p">::</span><span class="n">isle</span><span class="p">::</span><span class="o">&lt;</span><span class="k">impl</span><span class="w"> </span><span class="n">cranelift_codegen</span><span class="p">::</span><span class="n">isa</span><span class="p">::</span><span class="n">x64</span><span class="p">::</span><span class="n">lower</span><span class="p">::</span><span class="n">isle</span><span class="p">::</span><span class="n">generated_code</span><span class="p">::</span><span class="n">Context</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">cranelift_codegen</span><span class="p">::</span><span class="n">machinst</span><span class="p">::</span><span class="n">isle</span><span class="p">::</span><span class="n">IsleContext</span><span class="o">&lt;</span><span class="n">cranelift_codegen</span><span class="p">::</span><span class="n">isa</span><span class="p">::</span><span class="n">x64</span><span class="p">::</span><span class="n">lower</span><span class="p">::</span><span class="n">isle</span><span class="p">::</span><span class="n">generated_code</span><span class="p">::</span><span class="n">MInst</span><span class="p">,</span><span class="n">cranelift_codegen</span><span class="p">::</span><span class="n">isa</span><span class="p">::</span><span class="n">x64</span><span class="p">::</span><span class="n">X64Backend</span><span class="o">&gt;&gt;</span><span class="p">::</span><span class="n">put_in_reg_mem</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">isa</span><span class="o">/</span><span class="n">x64</span><span class="o">/</span><span class="n">lower</span><span class="o">/</span><span class="n">isle</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">148</span><span class="p">:</span><span class="mi">23</span>
<span class="w">   </span><span class="mi">7</span><span class="p">:</span><span class="w"> </span><span class="nc">cranelift_codegen</span><span class="p">::</span><span class="n">isa</span><span class="p">::</span><span class="n">x64</span><span class="p">::</span><span class="n">lower</span><span class="p">::</span><span class="n">isle</span><span class="p">::</span><span class="o">&lt;</span><span class="k">impl</span><span class="w"> </span><span class="n">cranelift_codegen</span><span class="p">::</span><span class="n">isa</span><span class="p">::</span><span class="n">x64</span><span class="p">::</span><span class="n">lower</span><span class="p">::</span><span class="n">isle</span><span class="p">::</span><span class="n">generated_code</span><span class="p">::</span><span class="n">Context</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">cranelift_codegen</span><span class="p">::</span><span class="n">machinst</span><span class="p">::</span><span class="n">isle</span><span class="p">::</span><span class="n">IsleContext</span><span class="o">&lt;</span><span class="n">cranelift_codegen</span><span class="p">::</span><span class="n">isa</span><span class="p">::</span><span class="n">x64</span><span class="p">::</span><span class="n">lower</span><span class="p">::</span><span class="n">isle</span><span class="p">::</span><span class="n">generated_code</span><span class="p">::</span><span class="n">MInst</span><span class="p">,</span><span class="n">cranelift_codegen</span><span class="p">::</span><span class="n">isa</span><span class="p">::</span><span class="n">x64</span><span class="p">::</span><span class="n">X64Backend</span><span class="o">&gt;&gt;</span><span class="p">::</span><span class="n">put_in_xmm_mem</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">isa</span><span class="o">/</span><span class="n">x64</span><span class="o">/</span><span class="n">lower</span><span class="o">/</span><span class="n">isle</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">132</span><span class="p">:</span><span class="mi">28</span>
<span class="w">   </span><span class="mi">8</span><span class="p">:</span><span class="w"> </span><span class="nc">cranelift_codegen</span><span class="p">::</span><span class="n">isa</span><span class="p">::</span><span class="n">x64</span><span class="p">::</span><span class="n">lower</span><span class="p">::</span><span class="n">isle</span><span class="p">::</span><span class="n">generated_code</span><span class="p">::</span><span class="n">constructor_lower</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">ivor</span><span class="o">/</span><span class="n">Documents</span><span class="o">/</span><span class="n">Code</span><span class="o">/</span><span class="n">rust</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">cranelift</span><span class="o">-</span><span class="n">codegen</span><span class="o">-</span><span class="mi">8</span><span class="n">f3d42bba10fabf3</span><span class="o">/</span><span class="n">out</span><span class="o">/</span><span class="n">isle_x64</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">21098</span><span class="p">:</span><span class="mi">42</span>
<span class="w">   </span><span class="mi">9</span><span class="p">:</span><span class="w"> </span><span class="nc">cranelift_codegen</span><span class="p">::</span><span class="n">isa</span><span class="p">::</span><span class="n">x64</span><span class="p">::</span><span class="n">lower</span><span class="p">::</span><span class="n">isle</span><span class="p">::</span><span class="n">lower</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">isa</span><span class="o">/</span><span class="n">x64</span><span class="o">/</span><span class="n">lower</span><span class="o">/</span><span class="n">isle</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">55</span><span class="p">:</span><span class="mi">5</span>
<span class="w">  </span><span class="mi">10</span><span class="p">:</span><span class="w"> </span><span class="nc">cranelift_codegen</span><span class="p">::</span><span class="n">isa</span><span class="p">::</span><span class="n">x64</span><span class="p">::</span><span class="n">lower</span><span class="p">::</span><span class="o">&lt;</span><span class="k">impl</span><span class="w"> </span><span class="n">cranelift_codegen</span><span class="p">::</span><span class="n">machinst</span><span class="p">::</span><span class="n">lower</span><span class="p">::</span><span class="n">LowerBackend</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">cranelift_codegen</span><span class="p">::</span><span class="n">isa</span><span class="p">::</span><span class="n">x64</span><span class="p">::</span><span class="n">X64Backend</span><span class="o">&gt;</span><span class="p">::</span><span class="n">lower</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">isa</span><span class="o">/</span><span class="n">x64</span><span class="o">/</span><span class="n">lower</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">311</span><span class="p">:</span><span class="mi">9</span>
<span class="w">  </span><span class="mi">11</span><span class="p">:</span><span class="w"> </span><span class="nc">cranelift_codegen</span><span class="p">::</span><span class="n">machinst</span><span class="p">::</span><span class="n">lower</span><span class="p">::</span><span class="n">Lower</span><span class="o">&lt;</span><span class="n">I</span><span class="o">&gt;</span><span class="p">::</span><span class="n">lower_clif_block</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">machinst</span><span class="o">/</span><span class="n">lower</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">679</span><span class="p">:</span><span class="mi">39</span>
<span class="w">  </span><span class="mi">12</span><span class="p">:</span><span class="w"> </span><span class="nc">cranelift_codegen</span><span class="p">::</span><span class="n">machinst</span><span class="p">::</span><span class="n">lower</span><span class="p">::</span><span class="n">Lower</span><span class="o">&lt;</span><span class="n">I</span><span class="o">&gt;</span><span class="p">::</span><span class="n">lower</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">machinst</span><span class="o">/</span><span class="n">lower</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">1020</span><span class="p">:</span><span class="mi">17</span>
<span class="w">  </span><span class="mi">13</span><span class="p">:</span><span class="w"> </span><span class="nc">cranelift_codegen</span><span class="p">::</span><span class="n">machinst</span><span class="p">::</span><span class="n">compile</span><span class="p">::</span><span class="n">compile</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">machinst</span><span class="o">/</span><span class="n">compile</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">9</span>
<span class="w">  </span><span class="mi">14</span><span class="p">:</span><span class="w"> </span><span class="nc">cranelift_codegen</span><span class="p">::</span><span class="n">isa</span><span class="p">::</span><span class="n">x64</span><span class="p">::</span><span class="n">X64Backend</span><span class="p">::</span><span class="n">compile_vcode</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">isa</span><span class="o">/</span><span class="n">x64</span><span class="o">/</span><span class="k">mod</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">62</span><span class="p">:</span><span class="mi">9</span>
<span class="w">  </span><span class="mi">15</span><span class="p">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">cranelift_codegen</span><span class="p">::</span><span class="n">isa</span><span class="p">::</span><span class="n">x64</span><span class="p">::</span><span class="n">X64Backend</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">cranelift_codegen</span><span class="p">::</span><span class="n">isa</span><span class="p">::</span><span class="n">TargetIsa</span><span class="o">&gt;</span><span class="p">::</span><span class="n">compile_function</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">isa</span><span class="o">/</span><span class="n">x64</span><span class="o">/</span><span class="k">mod</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">74</span><span class="p">:</span><span class="mi">40</span>
<span class="w">  </span><span class="mi">16</span><span class="p">:</span><span class="w"> </span><span class="nc">cranelift_codegen</span><span class="p">::</span><span class="n">context</span><span class="p">::</span><span class="n">Context</span><span class="p">::</span><span class="n">compile_stencil</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">context</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">138</span><span class="p">:</span><span class="mi">9</span>
<span class="w">  </span><span class="mi">17</span><span class="p">:</span><span class="w"> </span><span class="nc">cranelift_codegen</span><span class="p">::</span><span class="n">context</span><span class="p">::</span><span class="n">Context</span><span class="p">::</span><span class="n">compile</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">context</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">204</span><span class="p">:</span><span class="mi">23</span>
<span class="w">  </span><span class="mi">18</span><span class="p">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">cranelift_filetests</span><span class="p">::</span><span class="n">test_compile</span><span class="p">::</span><span class="n">TestCompile</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">cranelift_filetests</span><span class="p">::</span><span class="n">subtest</span><span class="p">::</span><span class="n">SubTest</span><span class="o">&gt;</span><span class="p">::</span><span class="n">run</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">filetests</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">test_compile</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">29</span>
<span class="w">  </span><span class="mi">19</span><span class="p">:</span><span class="w"> </span><span class="nc">cranelift_filetests</span><span class="p">::</span><span class="n">subtest</span><span class="p">::</span><span class="n">SubTest</span><span class="p">::</span><span class="n">run_target</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">filetests</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">subtest</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">101</span><span class="p">:</span><span class="mi">13</span>
<span class="w">  </span><span class="mi">20</span><span class="p">:</span><span class="w"> </span><span class="nc">cranelift_filetests</span><span class="p">::</span><span class="n">runone</span><span class="p">::</span><span class="n">run</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">filetests</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runone</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">97</span><span class="p">:</span><span class="mi">9</span>
<span class="w">  </span><span class="mi">21</span><span class="p">:</span><span class="w"> </span><span class="nc">cranelift_filetests</span><span class="p">::</span><span class="n">concurrent</span><span class="p">::</span><span class="n">worker_thread</span><span class="p">::{{</span><span class="n">closure</span><span class="p">}}::{{</span><span class="n">closure</span><span class="p">}}</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">filetests</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">concurrent</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">149</span><span class="p">:</span><span class="mi">46</span>
<span class="w">  </span><span class="mi">22</span><span class="p">:</span><span class="w"> </span><span class="nc">std</span><span class="p">::</span><span class="n">panicking</span><span class="p">::</span><span class="kr">try</span><span class="p">::</span><span class="n">do_call</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">ivor</span><span class="o">/</span><span class="p">.</span><span class="n">rustup</span><span class="o">/</span><span class="n">toolchains</span><span class="o">/</span><span class="n">stable</span><span class="o">-</span><span class="n">x86_64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">rustlib</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">rust</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panicking</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">557</span><span class="p">:</span><span class="mi">40</span>
<span class="w">  </span><span class="mi">23</span><span class="p">:</span><span class="w"> </span><span class="nc">__rust_try</span>
<span class="w">  </span><span class="mi">24</span><span class="p">:</span><span class="w"> </span><span class="nc">std</span><span class="p">::</span><span class="n">panicking</span><span class="p">::</span><span class="kr">try</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">ivor</span><span class="o">/</span><span class="p">.</span><span class="n">rustup</span><span class="o">/</span><span class="n">toolchains</span><span class="o">/</span><span class="n">stable</span><span class="o">-</span><span class="n">x86_64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">rustlib</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">rust</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panicking</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">520</span><span class="p">:</span><span class="mi">19</span>
<span class="w">  </span><span class="mi">25</span><span class="p">:</span><span class="w"> </span><span class="nc">std</span><span class="p">::</span><span class="n">panic</span><span class="p">::</span><span class="n">catch_unwind</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">ivor</span><span class="o">/</span><span class="p">.</span><span class="n">rustup</span><span class="o">/</span><span class="n">toolchains</span><span class="o">/</span><span class="n">stable</span><span class="o">-</span><span class="n">x86_64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">rustlib</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">rust</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panic</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">358</span><span class="p">:</span><span class="mi">14</span>
<span class="w">  </span><span class="mi">26</span><span class="p">:</span><span class="w"> </span><span class="nc">cranelift_filetests</span><span class="p">::</span><span class="n">concurrent</span><span class="p">::</span><span class="n">worker_thread</span><span class="p">::{{</span><span class="n">closure</span><span class="p">}}</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">filetests</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">concurrent</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">149</span><span class="p">:</span><span class="mi">30</span>
<span class="n">note</span><span class="p">:</span><span class="w"> </span><span class="nb">Some</span><span class="w"> </span><span class="nc">details</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">omitted</span><span class="p">,</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="err">`</span><span class="n">RUST_BACKTRACE</span><span class="o">=</span><span class="n">full</span><span class="err">`</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">verbose</span><span class="w"> </span><span class="n">backtrace</span><span class="p">.</span>
</code></pre></div>
<p>&lt;/details&gt;</p>
<p>The relevant section from <code>isle_x64.rs</code>;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">&amp;</span><span class="n">Opcode</span><span class="p">::</span><span class="n">Fpromote</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">C</span><span class="p">::</span><span class="n">first_result</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">arg0</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v1</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">v3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">C</span><span class="p">::</span><span class="n">value_type</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">v2</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">v3</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">F64</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">v1809</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">constructor_xmm_zero</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">F64X2</span><span class="p">);</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">v1804</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">C</span><span class="p">::</span><span class="n">put_in_xmm_mem</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">v520</span><span class="p">);</span><span class="w">             </span><span class="c1">// &lt;- Line isle_x64.rs:21098:42</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">v1819</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">constructor_x64_cvtss2sd</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">v1809</span><span class="p">,</span><span class="w"> </span><span class="n">v1804</span><span class="p">);</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">v1820</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">constructor_output_xmm</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">v1819</span><span class="p">);</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">v1821</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">v1820</span><span class="p">);</span>
<span class="w">            </span><span class="c1">// Rule at src/isa/x64/lower.isle line 2661.</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">v1821</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Which seems to indicate the problem is originating from <code>Fpromote</code>.</p>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: Current released; <code>0.116.1</code>, also tested on current main; 5dfccc078bb3dcad152d37013dde8067f197e6e7.</p>
<p>Operating system: Ubuntu, stable rustc 1.84.0 (9fc6b4312 2025-01-07)</p>
<p>Architecture: x86_64</p>
<h3>Extra Info</h3>
<p>If I use a release build, target x86_64 and write the output to an object file using <code>cranelift_object::ObjectModule</code>. The provided symbol does work and correctly calculates averages.</p>
<p>&lt;details&gt;<br>
&lt;summary&gt;Disassembly of object and usage of it to calculate average&lt;/summary&gt;</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">objdump</span><span class="w"> </span><span class="o">-</span><span class="n">d</span><span class="w"> </span><span class="n">average</span><span class="p">.</span><span class="n">o</span>

<span class="n">average</span><span class="p">.</span><span class="n">o</span><span class="p">:</span><span class="w">     </span><span class="nc">file</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="n">elf64</span><span class="o">-</span><span class="n">x86</span><span class="o">-</span><span class="mi">64</span>


<span class="n">Disassembly</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">section</span><span class="w"> </span><span class="p">.</span><span class="n">text</span><span class="p">:</span>

<span class="mi">0000000000000000</span><span class="w"> </span><span class="o">&lt;</span><span class="n">average</span><span class="o">&gt;</span><span class="p">:</span>
<span class="w">   </span><span class="mi">0</span><span class="p">:</span><span class="w">   </span><span class="mi">55</span><span class="w">                      </span><span class="n">push</span><span class="w">   </span><span class="o">%</span><span class="n">rbp</span>
<span class="w">   </span><span class="mi">1</span><span class="p">:</span><span class="w">   </span><span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">e5</span><span class="w">                </span><span class="n">mov</span><span class="w">    </span><span class="o">%</span><span class="n">rsp</span><span class="p">,</span><span class="o">%</span><span class="n">rbp</span>
<span class="w">   </span><span class="mi">4</span><span class="p">:</span><span class="w">   </span><span class="mi">48</span><span class="w"> </span><span class="mi">83</span><span class="w"> </span><span class="n">ec</span><span class="w"> </span><span class="mi">10</span><span class="w">             </span><span class="n">sub</span><span class="w">    </span><span class="cp">$</span><span class="mh">0x10</span><span class="p">,</span><span class="o">%</span><span class="n">rsp</span>
<span class="w">   </span><span class="mi">8</span><span class="p">:</span><span class="w">   </span><span class="mi">66</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">57</span><span class="w"> </span><span class="n">e4</span><span class="w">             </span><span class="n">xorpd</span><span class="w">  </span><span class="o">%</span><span class="n">xmm4</span><span class="p">,</span><span class="o">%</span><span class="n">xmm4</span>
<span class="w">   </span><span class="n">c</span><span class="p">:</span><span class="w">   </span><span class="mi">48</span><span class="w"> </span><span class="mi">8</span><span class="n">d</span><span class="w"> </span><span class="mi">04</span><span class="w"> </span><span class="mi">24</span><span class="w">             </span><span class="n">lea</span><span class="w">    </span><span class="p">(</span><span class="o">%</span><span class="n">rsp</span><span class="p">),</span><span class="o">%</span><span class="n">rax</span>
<span class="w">  </span><span class="mi">10</span><span class="p">:</span><span class="w">   </span><span class="nc">f2</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="mi">20</span><span class="w">             </span><span class="n">movsd</span><span class="w">  </span><span class="o">%</span><span class="n">xmm4</span><span class="p">,(</span><span class="o">%</span><span class="n">rax</span><span class="p">)</span>
<span class="w">  </span><span class="mi">14</span><span class="p">:</span><span class="w">   </span><span class="mi">85</span><span class="w"> </span><span class="n">f6</span><span class="w">                   </span><span class="n">test</span><span class="w">   </span><span class="o">%</span><span class="n">esi</span><span class="p">,</span><span class="o">%</span><span class="n">esi</span>
<span class="w">  </span><span class="mi">16</span><span class="p">:</span><span class="w">   </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">85</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">       </span><span class="n">jne</span><span class="w">    </span><span class="mi">2</span><span class="n">e</span><span class="w"> </span><span class="o">&lt;</span><span class="n">average</span><span class="o">+</span><span class="mh">0x2e</span><span class="o">&gt;</span>
<span class="w">  </span><span class="mi">1</span><span class="n">c</span><span class="p">:</span><span class="w">   </span><span class="nc">b9</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="n">c0</span><span class="w"> </span><span class="mi">7</span><span class="n">f</span><span class="w">          </span><span class="n">mov</span><span class="w">    </span><span class="cp">$</span><span class="mh">0x7fc00000</span><span class="p">,</span><span class="o">%</span><span class="n">ecx</span>
<span class="w">  </span><span class="mi">21</span><span class="p">:</span><span class="w">   </span><span class="mi">66</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">6</span><span class="n">e</span><span class="w"> </span><span class="n">c1</span><span class="w">             </span><span class="n">movd</span><span class="w">   </span><span class="o">%</span><span class="n">ecx</span><span class="p">,</span><span class="o">%</span><span class="n">xmm0</span>
<span class="w">  </span><span class="mi">25</span><span class="p">:</span><span class="w">   </span><span class="mi">48</span><span class="w"> </span><span class="mi">83</span><span class="w"> </span><span class="n">c4</span><span class="w"> </span><span class="mi">10</span><span class="w">             </span><span class="n">add</span><span class="w">    </span><span class="cp">$</span><span class="mh">0x10</span><span class="p">,</span><span class="o">%</span><span class="n">rsp</span>
<span class="w">  </span><span class="mi">29</span><span class="p">:</span><span class="w">   </span><span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">ec</span><span class="w">                </span><span class="n">mov</span><span class="w">    </span><span class="o">%</span><span class="n">rbp</span><span class="p">,</span><span class="o">%</span><span class="n">rsp</span>
<span class="w">  </span><span class="mi">2</span><span class="n">c</span><span class="p">:</span><span class="w">   </span><span class="mi">5</span><span class="n">d</span><span class="w">                      </span><span class="n">pop</span><span class="w">    </span><span class="o">%</span><span class="n">rbp</span>
<span class="w">  </span><span class="mi">2</span><span class="n">d</span><span class="p">:</span><span class="w">   </span><span class="nc">c3</span><span class="w">                      </span><span class="n">retq</span>
<span class="w">  </span><span class="mi">2</span><span class="n">e</span><span class="p">:</span><span class="w">   </span><span class="mi">31</span><span class="w"> </span><span class="n">c9</span><span class="w">                   </span><span class="n">xor</span><span class="w">    </span><span class="o">%</span><span class="n">ecx</span><span class="p">,</span><span class="o">%</span><span class="n">ecx</span>
<span class="w">  </span><span class="mi">30</span><span class="p">:</span><span class="w">   </span><span class="mi">44</span><span class="w"> </span><span class="mi">6</span><span class="n">b</span><span class="w"> </span><span class="n">c9</span><span class="w"> </span><span class="mi">04</span><span class="w">             </span><span class="n">imul</span><span class="w">   </span><span class="cp">$</span><span class="mh">0x4</span><span class="p">,</span><span class="o">%</span><span class="n">ecx</span><span class="p">,</span><span class="o">%</span><span class="n">r9d</span>
<span class="w">  </span><span class="mi">34</span><span class="p">:</span><span class="w">   </span><span class="mi">66</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">57</span><span class="w"> </span><span class="n">ed</span><span class="w">             </span><span class="n">xorpd</span><span class="w">  </span><span class="o">%</span><span class="n">xmm5</span><span class="p">,</span><span class="o">%</span><span class="n">xmm5</span>
<span class="w">  </span><span class="mi">38</span><span class="p">:</span><span class="w">   </span><span class="nc">f3</span><span class="w"> </span><span class="mi">42</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">5</span><span class="n">a</span><span class="w"> </span><span class="mi">2</span><span class="n">c</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w">       </span><span class="n">cvtss2sd</span><span class="w"> </span><span class="p">(</span><span class="o">%</span><span class="n">rdi</span><span class="p">,</span><span class="o">%</span><span class="n">r9</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="o">%</span><span class="n">xmm5</span>
<span class="w">  </span><span class="mi">3</span><span class="n">e</span><span class="p">:</span><span class="w">   </span><span class="mi">4</span><span class="n">c</span><span class="w"> </span><span class="mi">8</span><span class="n">d</span><span class="w"> </span><span class="mi">0</span><span class="n">c</span><span class="w"> </span><span class="mi">24</span><span class="w">             </span><span class="n">lea</span><span class="w">    </span><span class="p">(</span><span class="o">%</span><span class="n">rsp</span><span class="p">),</span><span class="o">%</span><span class="n">r9</span>
<span class="w">  </span><span class="mi">42</span><span class="p">:</span><span class="w">   </span><span class="nc">f2</span><span class="w"> </span><span class="mi">41</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">58</span><span class="w"> </span><span class="mi">29</span><span class="w">          </span><span class="n">addsd</span><span class="w">  </span><span class="p">(</span><span class="o">%</span><span class="n">r9</span><span class="p">),</span><span class="o">%</span><span class="n">xmm5</span>
<span class="w">  </span><span class="mi">47</span><span class="p">:</span><span class="w">   </span><span class="mi">4</span><span class="n">c</span><span class="w"> </span><span class="mi">8</span><span class="n">d</span><span class="w"> </span><span class="mi">0</span><span class="n">c</span><span class="w"> </span><span class="mi">24</span><span class="w">             </span><span class="n">lea</span><span class="w">    </span><span class="p">(</span><span class="o">%</span><span class="n">rsp</span><span class="p">),</span><span class="o">%</span><span class="n">r9</span>
<span class="w">  </span><span class="mi">4</span><span class="n">b</span><span class="p">:</span>
<span class="p">[</span><span class="n">message</span><span class="w"> </span><span class="n">truncated</span><span class="p">]</span>
</code></pre></div><br>
</p>
</blockquote>



<a name="496023896"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310118%20Cranelift%3A%20IR%20Reference%20example%20t.../near/496023896" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310118.20Cranelift.3A.20IR.20Reference.20example.20t.2E.2E.2E.html#496023896">(Jan 27 2025 at 02:16)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/10118#issuecomment-2614733089">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10118">issue #10118</a>:</p>
<blockquote>
<p>In this snippet</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">block1</span><span class="p">(</span><span class="n">v0</span><span class="p">:</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="p">:</span><span class="w"> </span><span class="kt">i32</span><span class="p">):</span>
<span class="w">   </span><span class="nc">v20</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f64const</span><span class="w"> </span><span class="mh">0x0</span><span class="p">.</span><span class="mi">0</span><span class="w">         </span><span class="p">;</span><span class="w"> </span><span class="n">Create</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="kt">f64</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="n">just</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">initialise</span><span class="w"> </span><span class="n">ss0</span><span class="p">.</span>
<span class="w">   </span><span class="n">stack_store</span><span class="w"> </span><span class="n">v20</span><span class="p">,</span><span class="w"> </span><span class="n">ss0</span><span class="w">         </span><span class="p">;</span><span class="w"> </span><span class="n">Store</span><span class="w"> </span><span class="kt">f64</span><span class="w"> </span><span class="n">into</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">ss0</span><span class="w"> </span><span class="n">stack</span><span class="w"> </span><span class="n">slot</span><span class="p">,</span><span class="w"> </span><span class="n">just</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">initialise</span><span class="w"> </span><span class="n">ss0</span><span class="p">.</span>
<span class="w">   </span><span class="n">v6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="w">             </span><span class="p">;</span><span class="w"> </span><span class="n">Adds</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">input</span><span class="w"> </span><span class="n">together</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">integers</span><span class="p">,</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="kt">i32</span><span class="o">?</span>
<span class="w">   </span><span class="n">v7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">f32</span><span class="w"> </span><span class="n">v6</span><span class="w">             </span><span class="p">;</span><span class="w"> </span><span class="n">Converts</span><span class="w"> </span><span class="n">v7</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="kt">i32</span><span class="p">.</span>
</code></pre></div>
<p>you are loading from memory at address <code>v6</code>, but <code>v6</code> is an I32-typed value (<code>iadd</code> is polymorphic so the type is implicit from <code>v0</code> and <code>v1</code> args, which are both <code>i32</code>). Note that x86-64 is a 64-bit architecture, so we require addresses to be 64 bits wide. That this worked on aarch64 is a little surprising but I guess the lowering rules are more lenient in that backend (they probably auto-extend).</p>
<p>(The comments aren't load-bearing for the bug but I note too that you wrote "Converts ... to f32 from i32" which is inconsistent with a load -- usually I would reach for an int-to-float opcode to convert in the usual sense.)</p>
<p>Our assertion failure message could absolutely be better here -- perhaps we could add "address with unexpected" or something like that.</p>
<p>I'll note as well that the example IR you took from <code>ir.md</code> is written without a target in mind, and address width is one of the few ways in which CLIF is not totally target-independent -- it must match the target ISA. I suspect that example was written long ago when riscv32 was the original target of proto-Cranelift.</p>
<p>Hopefully this is a simple fix (use i64 types for addresses) -- let us know if that addresses your problem!</p>
</blockquote>



<a name="496121939"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310118%20Cranelift%3A%20IR%20Reference%20example%20t.../near/496121939" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310118.20Cranelift.3A.20IR.20Reference.20example.20t.2E.2E.2E.html#496121939">(Jan 27 2025 at 13:27)</a>:</h4>
<p>iwanders <a href="https://github.com/bytecodealliance/wasmtime/issues/10118#issuecomment-2615762425">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10118">issue #10118</a>:</p>
<blockquote>
<p>@cfallin , thank you for the detailed answer.</p>
<blockquote>
<p>Note that x86-64 is a 64-bit architecture, so we require addresses to be 64 bits wide.<br>
Hopefully this is a simple fix (use i64 types for addresses) -- let us know if that addresses your problem!</p>
</blockquote>
<p>Ah, I didn't think of that, but that does make sense!</p>
<p>I can indeed get the example from the documentation to work by changing <code>v0</code>, <code>v1</code>, <code>v3</code> and <code>v4</code> to <code>i64</code>. Would you like me to file a PR to change the documentation to use <code>i64</code>s for those variables? I expect most people who try to read through the docs and build something to use the <code>cranelift_native</code> crate and be on 64 bit architectures?</p>
<blockquote>
<p>Our assertion failure message could absolutely be better here -- perhaps we could add "address with unexpected" or something like that.</p>
</blockquote>
<p>Yeah, I think just something simple as changing <a href="https://github.com/bytecodealliance/wasmtime/blob/5dfccc078bb3dcad152d37013dde8067f197e6e7/cranelift/codegen/src/isa/x64/lower.rs#L233">that debug assert</a> to be;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">        </span><span class="fm">debug_assert_eq!</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">output_ty</span><span class="p">(</span><span class="n">add</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">types</span><span class="p">::</span><span class="n">I64</span><span class="p">,</span><span class="w"> </span><span class="s">"address width of 64 expected, got 32"</span><span class="p">);</span>
</code></pre></div>
<p>would go a long way towards steering people in the right direction? I can file a pr with this change if you'd like me to. The discrepancy between debug and release builds is also a bit surprising to me, but that may be less of an easy fix as it probably requires adding an explicit check.</p>
</blockquote>



<a name="496169993"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310118%20Cranelift%3A%20IR%20Reference%20example%20t.../near/496169993" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310118.20Cranelift.3A.20IR.20Reference.20example.20t.2E.2E.2E.html#496169993">(Jan 27 2025 at 16:56)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/10118#issuecomment-2616362456">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10118">issue #10118</a>:</p>
<blockquote>
<p>Yes, if you're willing, a PR to make both of those changes would be very much appreciated! Happy to review. Thanks!</p>
</blockquote>



<a name="496187770"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310118%20Cranelift%3A%20IR%20Reference%20example%20t.../near/496187770" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310118.20Cranelift.3A.20IR.20Reference.20example.20t.2E.2E.2E.html#496187770">(Jan 27 2025 at 18:30)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/10118#issuecomment-2616588821">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10118">issue #10118</a>:</p>
<blockquote>
<blockquote>
<p>The discrepancy between debug and release builds is also a bit surprising to me, but that may be less of an easy fix as it probably requires adding an explicit check.</p>
</blockquote>
<p>Does the clif ir verifier catch this mistake? You need to explicitly enable it as it is kinda slow.</p>
</blockquote>



<a name="496234658"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310118%20Cranelift%3A%20IR%20Reference%20example%20t.../near/496234658" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310118.20Cranelift.3A.20IR.20Reference.20example.20t.2E.2E.2E.html#496234658">(Jan 28 2025 at 00:21)</a>:</h4>
<p>iwanders <a href="https://github.com/bytecodealliance/wasmtime/issues/10118#issuecomment-2617248293">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10118">issue #10118</a>:</p>
<blockquote>
<blockquote>
<p>Does the clif ir verifier catch this mistake? You need to explicitly enable it as it is kinda slow.</p>
</blockquote>
<p>I tried adding the same <code>average.clif</code> file with an <code>test verifier</code> stanza at the top in e132b3bdbe4144800df54ac78a01c7473e62a927, this does not cause a unit test failure, so I don't think it does. I could not find a way to specify a <code>test verifier_fail</code> or something to indicate the verifier should report a failure in the test case, so I'm not sure how to really express this as a test.</p>
<p>My exact setup is available in 70af5ceb5122121a670181615fb733cc55bce571 on (branch <a href="https://github.com/iwanders/wasmtime/tree/issue-10118-reproduction">issue-10118-reproduction</a>), it adds a crate <code>cranelift/compile_average_ir</code> in the wasmtime repo for easy reproduction (function <code>attempt_two</code> in <code>main.rs</code>). This prints the flags as:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">enable_alias_analysis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<span class="n">enable_verifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<span class="n">enable_pcc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span>
</code></pre></div>
<p>Which I take to mean the verifier is enabled, the <a href="https://docs.rs/cranelift-codegen/0.116.1/cranelift_codegen/settings/struct.Flags.html#method.enable_verifier">documentation here</a> also states it is enabled by default? Reproduction should be a matter of going to the crate and doing <code>cargo r</code>, that gives the assert, while <code>cargo r --release</code> shows the object file bytes. </p>
<p>Context; I'm considering creating a toy compiler, just to learn more about compilers.  On Sunday I was exploring Cranelift to see how approachable it is and whether I'd like to use it as the frontend and share datastructures (effectively I think I would attempt making a <code>TargetIsa</code>). So that's why I ended up reading the IR documentation and tried to compile that function from the documentation. Overall though, the fact that I got working assembly within an hour or two of reading, experimenting, and in like 100 lines, makes it very approachable <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span> </p>
<blockquote>
<p>Yes, if you're willing, a PR to make both of those changes would be very much appreciated! Happy to review. Thanks!</p>
</blockquote>
<p>Cool, I'll put something together.</p>
</blockquote>



<a name="497309041"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310118%20Cranelift%3A%20IR%20Reference%20example%20t.../near/497309041" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310118.20Cranelift.3A.20IR.20Reference.20example.20t.2E.2E.2E.html#497309041">(Feb 03 2025 at 00:52)</a>:</h4>
<p>iwanders <a href="https://github.com/bytecodealliance/wasmtime/issues/10118#issuecomment-2629670684">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10118">issue #10118</a>:</p>
<blockquote>
<p>I took another look at this, now that I have a bit more understanding of the cranelift data structures.</p>
<p>In efd56cbfc6f068de82e0cbb4ebba014a584d5499 of the <a href="https://github.com/iwanders/wasmtime/tree/issue-10118-reproduction">issue-10118-reproduction</a> branch, I added some printing of the types that we get in the clif:</p>
<p>This indeed shows the problem with the load on I32.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">inst</span><span class="p">:</span><span class="w"> </span><span class="nc">inst2</span>
<span class="w">  </span><span class="n">instruction_data</span><span class="p">:</span><span class="w"> </span><span class="nc">Binary</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">opcode</span><span class="p">:</span><span class="w"> </span><span class="nc">Iadd</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="p">]</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="n">typevar_operand</span><span class="p">:</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">v0</span><span class="p">)</span>
<span class="w">  </span><span class="n">opcode</span><span class="p">:</span><span class="w"> </span><span class="nc">Iadd</span>
<span class="w">  </span><span class="n">args</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="p">]</span><span class="w"> </span><span class="n">types</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="n">types</span><span class="p">::</span><span class="n">I32</span><span class="p">,</span><span class="w"> </span><span class="n">types</span><span class="p">::</span><span class="n">I32</span><span class="p">]</span>
<span class="w">  </span><span class="n">results</span><span class="o">?</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">[</span><span class="n">v6</span><span class="p">]</span><span class="w">  </span><span class="p">(</span><span class="n">types</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="n">types</span><span class="p">::</span><span class="n">I32</span><span class="p">])</span>
<span class="n">inst</span><span class="p">:</span><span class="w"> </span><span class="nc">inst3</span>
<span class="w">  </span><span class="n">instruction_data</span><span class="p">:</span><span class="w"> </span><span class="nc">Load</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">opcode</span><span class="p">:</span><span class="w"> </span><span class="nc">Load</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="p">:</span><span class="w"> </span><span class="nc">v6</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">:</span><span class="w"> </span><span class="nc">MemFlags</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">bits</span><span class="p">:</span><span class="w"> </span><span class="mi">32384</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">offset</span><span class="p">:</span><span class="w"> </span><span class="nc">Offset32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="n">typevar_operand</span><span class="p">:</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">v6</span><span class="p">)</span>
<span class="w">  </span><span class="n">opcode</span><span class="p">:</span><span class="w"> </span><span class="nc">Load</span>
<span class="w">  </span><span class="n">args</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="n">v6</span><span class="p">]</span><span class="w"> </span><span class="n">types</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="n">types</span><span class="p">::</span><span class="n">I32</span><span class="p">]</span>
<span class="w">  </span><span class="n">results</span><span class="o">?</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">[</span><span class="n">v7</span><span class="p">]</span><span class="w">  </span><span class="p">(</span><span class="n">types</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="n">types</span><span class="p">::</span><span class="n">F32</span><span class="p">])</span>
</code></pre></div>
<p>So at first I looked at the <code>isle</code> files and tried to figure out if there needed to be a type constraint on the argument to prevent it from being used... but I think I was looking in the wrong place.</p>
<p>Next I looked at the verifier... so in <a href="https://github.com/bytecodealliance/wasmtime/blob/a0338af84f66cb452fdf4b692d4facb5d052c12d/cranelift/codegen/meta/src/shared/instructions.rs#L101">instructions.rs</a> the <code>iAddr</code> is defined, but this is just an int of 32 or 64 bits.</p>
<p>In d7e53eadae6e7933a20628750caca1757be0e0b2 I added some prints to the verifier, and this does indeed show that the int-set for the Value that's the argument has the 32 and 64 bit integers set;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">typecheck</span><span class="p">:</span><span class="w"> </span><span class="nc">inst3</span><span class="w">   </span><span class="n">Load</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">opcode</span><span class="p">:</span><span class="w"> </span><span class="nc">Load</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="p">:</span><span class="w"> </span><span class="nc">v6</span><span class="p">,</span><span class="w"> </span><span class="n">flags</span><span class="p">:</span><span class="w"> </span><span class="nc">MemFlags</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">bits</span><span class="p">:</span><span class="w"> </span><span class="mi">32384</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">offset</span><span class="p">:</span><span class="w"> </span><span class="nc">Offset32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="n">ctrl</span><span class="p">:</span><span class="w"> </span><span class="nc">types</span><span class="p">::</span><span class="n">F32</span>
<span class="w">   </span><span class="n">arg_type</span><span class="p">:</span><span class="w"> </span><span class="nc">types</span><span class="p">::</span><span class="n">I32</span>
<span class="w">   </span><span class="n">type_set</span><span class="p">:</span><span class="w"> </span><span class="nc">ValueTypeSet</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">lanes</span><span class="p">:</span><span class="w"> </span><span class="nc">cranelift_bitset</span><span class="p">::</span><span class="n">scalar</span><span class="p">::</span><span class="n">ScalarBitSet</span><span class="o">&lt;</span><span class="kt">u16</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="nc">true</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="nc">false</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span><span class="w"> </span><span class="nc">false</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">:</span><span class="w"> </span><span class="nc">false</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">:</span><span class="w"> </span><span class="nc">false</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">:</span><span class="w"> </span><span class="nc">false</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">:</span><span class="w"> </span><span class="nc">false</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">:</span><span class="w"> </span><span class="nc">false</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">:</span><span class="w"> </span><span class="nc">false</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">:</span><span class="w"> </span><span class="nc">false</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">:</span><span class="w"> </span><span class="nc">false</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">:</span><span class="w"> </span><span class="nc">false</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">:</span><span class="w"> </span><span class="nc">false</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span><span class="p">:</span><span class="w"> </span><span class="nc">false</span><span class="p">,</span><span class="w"> </span><span class="mi">14</span><span class="p">:</span><span class="w"> </span><span class="nc">false</span><span class="p">,</span><span class="w"> </span><span class="mi">15</span><span class="p">:</span><span class="w"> </span><span class="nc">false</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">ints</span><span class="p">:</span><span class="w"> </span><span class="nc">cranelift_bitset</span><span class="p">::</span><span class="n">scalar</span><span class="p">::</span><span class="n">ScalarBitSet</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="nc">false</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="nc">false</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span><span class="w"> </span><span class="nc">false</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">:</span><span class="w"> </span><span class="nc">false</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">:</span><span class="w"> </span><span class="nc">false</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">:</span><span class="w"> </span><span class="nc">true</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">:</span><span class="w"> </span><span class="nc">true</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">:</span><span class="w"> </span><span class="nc">false</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">floats</span><span class="p">:</span><span class="w"> </span><span class="nc">cranelift_bitset</span><span class="p">::</span><span class="n">scalar</span><span class="p">::</span><span class="n">ScalarBitSet</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="nc">false</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="nc">false</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span><span class="w"> </span><span class="nc">false</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">:</span><span class="w"> </span><span class="nc">false</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">:</span><span class="w"> </span><span class="nc">false</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">:</span><span class="w"> </span><span class="nc">false</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">:</span><span class="w"> </span><span class="nc">false</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">:</span><span class="w"> </span><span class="nc">false</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="n">dynamic_lanes</span><span class="p">:</span><span class="w"> </span><span class="nc">cranelift_bitset</span><span class="p">::</span><span class="n">scalar</span><span class="p">::</span><span class="n">ScalarBitSet</span><span class="o">&lt;</span><span class="kt">u16</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="nc">false</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="nc">false</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span><span class="w"> </span><span class="nc">false</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">:</span><span class="w"> </span><span class="nc">false</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">:</span><span class="w"> </span><span class="nc">false</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">:</span><span class="w"> </span><span class="nc">false</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">:</span><span class="w"> </span><span class="nc">false</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">:</span><span class="w"> </span><span class="nc">false</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">:</span><span class="w"> </span><span class="nc">false</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">:</span><span class="w"> </span><span class="nc">false</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">:</span><span class="w"> </span><span class="nc">false</span><span class="p">,</span><span class="w"> </span><span class="mi">11</span><span class="p">:</span><span class="w"> </span><span class="nc">false</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">:</span><span class="w"> </span><span class="nc">false</span><span class="p">,</span><span class="w"> </span><span class="mi">13</span><span class="p">:</span><span class="w"> </span><span class="nc">false</span><span class="p">,</span><span class="w"> </span><span class="mi">14</span><span class="p">:</span><span class="w"> </span><span class="nc">false</span><span class="p">,</span><span class="w"> </span><span class="mi">15</span><span class="p">:</span><span class="w"> </span><span class="nc">false</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="w">   </span><span class="n">arg_type</span><span class="p">:</span><span class="w"> </span><span class="nc">types</span><span class="p">::</span><span class="n">I32</span>
</code></pre></div>
<p>So I think this means that even though we are on a 64 bit architecture, the load can take a 32 or 64 bit argument according to the verifier.</p>
<p>I'm not sure what the best approach is here, by the time we reach the verifier, we cannot distinguish between an <code>i32</code>, <code>i64</code> and <code>iAddr</code> anymore, given my (limited) understanding the ideal would be to use a bit in the <code>ValueTypeSet</code> to denote something as an address integer, and then the verifier can confirm that that the value is of the appropriate type for the current isa.</p>
<p>In c75db15dd4a64ca71d245057be12aeaa08ff9400 I just added a <code>verify_is_address</code> method to the verifier, and call for load, that makes the verifier complain with this bad function;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Defining</span><span class="w"> </span><span class="n">function</span>
<span class="n">er</span><span class="p">:</span><span class="w"> </span><span class="nc">VerifierError</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">location</span><span class="p">:</span><span class="w"> </span><span class="nc">inst3</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">:</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="s">"v7 = load.f32 v6"</span><span class="p">),</span><span class="w"> </span><span class="n">message</span><span class="p">:</span><span class="w"> </span><span class="s">"invalid pointer width (got 32, expected 64) encountered v6"</span><span class="w"> </span><span class="p">}</span>
<span class="n">Error</span><span class="p">:</span><span class="w"> </span><span class="s">"Compilation error: Verifier errors"</span>
</code></pre></div>
<p>Unfortunately, that commit does not run the test suite cleanly, there are 5 tests that fail:</p>
<p>&lt;details&gt;<br>
&lt;summary&gt;Test failures with pointer width checking&lt;/summary&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">running</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">test</span>
<span class="n">test</span><span class="w"> </span><span class="n">filetests</span><span class="w"> </span><span class="o">..</span><span class="p">.</span><span class="w"> </span><span class="n">FAILED</span>

<span class="n">failures</span><span class="p">:</span>

<span class="o">----</span><span class="w"> </span><span class="n">filetests</span><span class="w"> </span><span class="n">stdout</span><span class="w"> </span><span class="o">----</span>
<span class="n">FAIL</span><span class="w"> </span><span class="n">filetests</span><span class="o">/</span><span class="n">filetests</span><span class="o">/</span><span class="n">runtests</span><span class="o">/</span><span class="n">simd</span><span class="o">-</span><span class="n">extractlane</span><span class="p">.</span><span class="n">clif</span><span class="p">:</span><span class="w"> </span><span class="nc">function</span><span class="w"> </span><span class="o">%</span><span class="n">extractlane_i8x16_through_stack</span><span class="p">(</span><span class="n">i8x16</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">i8</span><span class="w"> </span><span class="nc">system_v</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ss0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">8</span>

<span class="n">block0</span><span class="p">(</span><span class="n">v0</span><span class="p">:</span><span class="w"> </span><span class="nc">i8x16</span><span class="p">):</span>
<span class="w">    </span><span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stack_addr</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">ss0</span>
<span class="w">    </span><span class="n">v3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">extractlane</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="n">store</span><span class="w"> </span><span class="n">v3</span><span class="p">,</span><span class="w"> </span><span class="n">v2</span>
<span class="w">    </span><span class="n">v4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">i8</span><span class="w"> </span><span class="n">v2</span>
<span class="p">;</span><span class="w">   </span><span class="o">^~~~~~~~~~~~~~~</span>
<span class="p">;</span><span class="w"> </span><span class="n">error</span><span class="p">:</span><span class="w"> </span><span class="nc">inst3</span><span class="w"> </span><span class="p">(</span><span class="n">v4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">i8</span><span class="w"> </span><span class="n">v2</span><span class="p">):</span><span class="w"> </span><span class="nc">invalid</span><span class="w"> </span><span class="n">pointer</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="p">(</span><span class="n">got</span><span class="w"> </span><span class="mi">64</span><span class="p">,</span><span class="w"> </span><span class="n">expected</span><span class="w"> </span><span class="mi">32</span><span class="p">)</span><span class="w"> </span><span class="n">encountered</span><span class="w"> </span><span class="n">v2</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v4</span>
<span class="p">}</span>

<span class="p">;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">verifier</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">detected</span><span class="w"> </span><span class="p">(</span><span class="n">see</span><span class="w"> </span><span class="n">above</span><span class="p">).</span><span class="w"> </span><span class="n">Compilation</span><span class="w"> </span><span class="n">aborted</span><span class="p">.</span>


<span class="n">Stack</span><span class="w"> </span><span class="n">backtrace</span><span class="p">:</span>
<span class="w">   </span><span class="o">&lt;</span><span class="n">snip</span><span class="o">&gt;</span>
<span class="n">FAIL</span><span class="w"> </span><span class="n">filetests</span><span class="o">/</span><span class="n">filetests</span><span class="o">/</span><span class="n">runtests</span><span class="o">/</span><span class="n">fdemote</span><span class="p">.</span><span class="n">clif</span><span class="p">:</span><span class="w"> </span><span class="nc">function</span><span class="w"> </span><span class="o">%</span><span class="n">fdemote_load</span><span class="p">(</span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="kt">f64</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="nc">system_v</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ss0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">16</span>

<span class="n">block0</span><span class="p">(</span><span class="n">v1</span><span class="p">:</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v2</span><span class="p">:</span><span class="w"> </span><span class="kt">f64</span><span class="p">):</span>
<span class="w">    </span><span class="nc">v3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stack_addr</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">ss0</span>
<span class="w">    </span><span class="n">store</span><span class="w"> </span><span class="n">v2</span><span class="p">,</span><span class="w"> </span><span class="n">v3</span>
<span class="w">    </span><span class="n">v4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">f64</span><span class="w"> </span><span class="n">v3</span>
<span class="p">;</span><span class="w">   </span><span class="o">^~~~~~~~~~~~~~~~</span>
<span class="p">;</span><span class="w"> </span><span class="n">error</span><span class="p">:</span><span class="w"> </span><span class="nc">inst2</span><span class="w"> </span><span class="p">(</span><span class="n">v4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">f64</span><span class="w"> </span><span class="n">v3</span><span class="p">):</span><span class="w"> </span><span class="nc">invalid</span><span class="w"> </span><span class="n">pointer</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="p">(</span><span class="n">got</span><span class="w"> </span><span class="mi">64</span><span class="p">,</span><span class="w"> </span><span class="n">expected</span><span class="w"> </span><span class="mi">32</span><span class="p">)</span><span class="w"> </span><span class="n">encountered</span><span class="w"> </span><span class="n">v3</span>

<span class="w">    </span><span class="n">v5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fdemote</span><span class="p">.</span><span class="kt">f32</span><span class="w"> </span><span class="n">v4</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v5</span>
<span class="p">}</span>

<span class="p">;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">verifier</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">detected</span><span class="w"> </span><span class="p">(</span><span class="n">see</span><span class="w"> </span><span class="n">above</span><span class="p">).</span><span class="w"> </span><span class="n">Compilation</span><span class="w"> </span><span class="n">aborted</span><span class="p">.</span>


<span class="n">Stack</span><span class="w"> </span><span class="n">backtrace</span><span class="p">:</span>
<span class="w">   </span><span class="o">&lt;</span><span class="n">snip</span><span class="o">&gt;</span>

<span class="n">FAIL</span><span class="w"> </span><span class="n">filetests</span><span class="o">/</span><span class="n">filetests</span><span class="o">/</span><span class="n">runtests</span><span class="o">/</span><span class="n">simd</span><span class="o">-</span><span class="n">insertlane</span><span class="p">.</span><span class="n">clif</span><span class="p">:</span><span class="w"> </span><span class="nc">function</span><span class="w"> </span><span class="o">%</span><span class="n">insertlane_i8x16_through_stack</span><span class="p">(</span><span class="n">i8x16</span><span class="p">,</span><span class="w"> </span><span class="kt">i8</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">i8x16</span><span class="w"> </span><span class="n">system_v</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ss0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">8</span>

<span class="n">block0</span><span class="p">(</span><span class="n">v0</span><span class="p">:</span><span class="w"> </span><span class="nc">i8x16</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="p">:</span><span class="w"> </span><span class="kt">i8</span><span class="p">):</span>
<span class="w">    </span><span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stack_addr</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">ss0</span>
<span class="w">    </span><span class="n">store</span><span class="w"> </span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="n">v2</span>
<span class="w">    </span><span class="n">v3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">i8</span><span class="w"> </span><span class="n">v2</span>
<span class="p">;</span><span class="w">   </span><span class="o">^~~~~~~~~~~~~~~</span>
<span class="p">;</span><span class="w"> </span><span class="n">error</span><span class="p">:</span><span class="w"> </span><span class="nc">inst2</span><span class="w"> </span><span class="p">(</span><span class="n">v3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">i8</span><span class="w"> </span><span class="n">v2</span><span class="p">):</span><span class="w"> </span><span class="nc">invalid</span><span class="w"> </span><span class="n">pointer</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="p">(</span><span class="n">got</span><span class="w"> </span><span class="mi">64</span><span class="p">,</span><span class="w"> </span><span class="n">expected</span><span class="w"> </span><span class="mi">32</span><span class="p">)</span><span class="w"> </span><span class="n">encountered</span><span class="w"> </span><span class="n">v2</span>

<span class="w">    </span><span class="n">v4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">insertlane</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v3</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v4</span>
<span class="p">}</span>

<span class="p">;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">verifier</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">detected</span><span class="w"> </span><span class="p">(</span><span class="n">see</span><span class="w"> </span><span class="n">above</span><span class="p">).</span><span class="w"> </span><span class="n">Compilation</span><span class="w"> </span><span class="n">aborted</span><span class="p">.</span>


<span class="n">Stack</span><span class="w"> </span><span class="n">backtrace</span><span class="p">:</span>
<span class="w">   </span><span class="o">&lt;</span><span class="n">snip</span><span class="o">&gt;</span>
<span class="n">FAIL</span><span class="w"> </span><span class="n">filetests</span><span class="o">/</span><span class="n">filetests</span><span class="o">/</span><span class="n">runtests</span><span class="o">/</span><span class="n">fpromote</span><span class="p">.</span><span class="n">clif</span><span class="p">:</span><span class="w"> </span><span class="nc">function</span><span class="w"> </span><span class="o">%</span><span class="n">fpromote_load</span><span class="p">(</span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="kt">f32</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">f64</span><span class="w"> </span><span class="nc">system_v</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ss0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">16</span>

<span class="n">block0</span><span class="p">(</span><span class="n">v1</span><span class="p">:</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v2</span><span class="p">:</span><span class="w"> </span><span class="kt">f32</span><span class="p">):</span>
<span class="w">    </span><span class="nc">v3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stack_addr</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">ss0</span>
<span class="w">    </span><span class="n">store</span><span class="w"> </span><span class="n">v2</span><span class="p">,</span><span class="w"> </span><span class="n">v3</span>
<span class="w">    </span><span class="n">v4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">f32</span><span class="w"> </span><span class="n">v3</span>
<span class="p">;</span><span class="w">   </span><span class="o">^~~~~~~~~~~~~~~~</span>
<span class="p">;</span><span class="w"> </span><span class="n">error</span><span class="p">:</span><span class="w"> </span><span class="nc">inst2</span><span class="w"> </span><span class="p">(</span><span class="n">v4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">f32</span><span class="w"> </span><span class="n">v3</span><span class="p">):</span><span class="w"> </span><span class="nc">invalid</span><span class="w"> </span><span class="n">pointer</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="p">(</span><span class="n">got</span><span class="w"> </span><span class="mi">64</span><span class="p">,</span><span class="w"> </span><span class="n">expected</span><span class="w"> </span><span class="mi">32</span><span class="p">)</span><span class="w"> </span><span class="n">encountered</span><span class="w"> </span><span class="n">v3</span>

<span class="w">    </span><span class="n">v5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fpromote</span><span class="p">.</span><span class="kt">f64</span><span class="w"> </span><span class="n">v4</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v5</span>
<span class="p">}</span>

<span class="p">;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">verifier</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">detected</span><span class="w"> </span><span class="p">(</span><span class="n">see</span><span class="w"> </span><span class="n">above</span><span class="p">).</span><span class="w"> </span><span class="n">Compilation</span><span class="w"> </span><span class="n">aborted</span><span class="p">.</span>


<span class="n">Stack</span><span class="w"> </span><span class="n">backtrace</span><span class="p">:</span>
<span class="w">   </span><span class="o">&lt;</span><span class="n">snip</span><span class="o">&gt;</span>
<span class="n">FAIL</span><span class="w"> </span><span class="n">filetests</span><span class="o">/</span><span class="n">filetests</span><span class="o">/</span><span class="n">isa</span><span class="o">/</span><span class="n">x64</span><span class="o">/</span><span class="n">average</span><span class="p">.</span><span class="n">clif</span><span class="p">:</span><span class="w"> </span><span class="nc">function</span><span class="w"> </span><span class="o">%</span><span class="n">average</span><span class="p">(</span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="nc">system_v</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ss0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">8</span>

<span class="n">block1</span><span class="p">(</span><span class="n">v0</span><span class="p">:</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="p">:</span><span class="w"> </span><span class="kt">i32</span><span class="p">):</span>
<span class="w">    </span><span class="nc">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f64const</span><span class="w"> </span><span class="mf">0.0</span>
<span class="w">    </span><span class="n">stack_store</span><span class="w"> </span><span class="n">v2</span><span class="p">,</span><span class="w"> </span><span class="n">ss0</span><span class="w">  </span><span class="p">;</span><span class="w"> </span><span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span>
<span class="w">    </span><span class="n">brif</span><span class="w"> </span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="n">block2</span><span class="p">,</span><span class="w"> </span><span class="n">block5</span>

<span class="n">block2</span><span class="p">:</span>
<span class="w">    </span><span class="nc">v3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="n">jump</span><span class="w"> </span><span class="n">block3</span><span class="p">(</span><span class="n">v3</span><span class="p">)</span><span class="w">  </span><span class="p">;</span><span class="w"> </span><span class="n">v3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>

<span class="n">block3</span><span class="p">(</span><span class="n">v4</span><span class="p">:</span><span class="w"> </span><span class="kt">i32</span><span class="p">):</span>
<span class="w">    </span><span class="nc">v5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">imul_imm</span><span class="w"> </span><span class="n">v4</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span>
<span class="w">    </span><span class="n">v6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v5</span>
<span class="w">    </span><span class="n">v7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">f32</span><span class="w"> </span><span class="n">v6</span>
<span class="p">;</span><span class="w">   </span><span class="o">^~~~~~~~~~~~~~~~</span>
<span class="p">;</span><span class="w"> </span><span class="n">error</span><span class="p">:</span><span class="w"> </span><span class="nc">inst7</span><span class="w"> </span><span class="p">(</span><span class="n">v7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">f32</span><span class="w"> </span><span class="n">v6</span><span class="p">):</span><span class="w"> </span><span class="nc">invalid</span><span class="w"> </span><span class="n">pointer</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="p">(</span><span class="n">got</span><span class="w"> </span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="n">expected</span><span class="w"> </span><span class="mi">64</span><span class="p">)</span><span class="w"> </span><span class="n">encountered</span><span class="w"> </span><span class="n">v6</span>

<span class="w">    </span><span class="n">v8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fpromote</span><span class="p">.</span><span class="kt">f64</span><span class="w"> </span><span class="n">v7</span>
<span class="w">    </span><span class="n">v9</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stack_load</span><span class="p">.</span><span class="kt">f64</span><span class="w"> </span><span class="n">ss0</span>
<span class="w">    </span><span class="n">v10</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fadd</span><span class="w"> </span><span class="n">v8</span><span class="p">,</span><span class="w"> </span><span class="n">v9</span>
<span class="w">    </span><span class="n">stack_store</span><span class="w"> </span><span class="n">v10</span><span class="p">,</span><span class="w"> </span><span class="n">ss0</span>
<span class="w">    </span><span class="n">v11</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd_imm</span><span class="w"> </span><span class="n">v4</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="n">v12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">icmp</span><span class="w"> </span><span class="n">ult</span><span class="w"> </span><span class="n">v11</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>
<span class="w">    </span><span class="n">brif</span><span class="w"> </span><span class="n">v12</span><span class="p">,</span><span class="w"> </span><span class="n">block3</span><span class="p">(</span><span class="n">v11</span><span class="p">),</span><span class="w"> </span><span class="n">block4</span>

<span class="n">block4</span><span class="p">:</span>
<span class="w">    </span><span class="nc">v13</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stack_load</span><span class="p">.</span><span class="kt">f64</span><span class="w"> </span><span class="n">ss0</span>
<span class="w">    </span><span class="n">v14</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fcvt_from_uint</span><span class="p">.</span><span class="kt">f64</span><span class="w"> </span><span class="n">v1</span>
<span class="w">    </span><span class="n">v15</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fdiv</span><span class="w"> </span><span class="n">v13</span><span class="p">,</span><span class="w"> </span><span class="n">v14</span>
<span class="w">    </span><span class="n">v16</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fdemote</span><span class="p">.</span><span class="kt">f32</span><span class="w"> </span><span class="n">v15</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v16</span>

<span class="n">block5</span><span class="p">:</span>
<span class="w">    </span><span class="nc">v100</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f32const</span><span class="w"> </span><span class="o">+</span><span class="n">NaN</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v100</span><span class="w">  </span><span class="p">;</span><span class="w"> </span><span class="n">v100</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">+</span><span class="n">NaN</span>
<span class="p">}</span>

<span class="p">;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">verifier</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="n">detected</span><span class="w"> </span><span class="p">(</span><span class="n">see</span><span class="w"> </span><span class="n">above</span><span class="p">).</span><span class="w"> </span><span class="n">Compilation</span><span class="w"> </span><span class="n">aborted</span><span class="p">.</span>


<span class="n">Stack</span><span class="w"> </span><span class="n">backtrace</span><span class="p">:</span>
<span class="w">   </span><span class="o">&lt;</span><span class="n">snip</span><span class="o">&gt;</span>
<span class="mi">1065</span><span class="w"> </span><span class="n">tests</span>
<span class="n">Error</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">failures</span>

<span class="n">Stack</span><span class="w"> </span><span class="n">backtrace</span><span class="p">:</span>
<span class="w">   </span><span class="o">&lt;</span><span class="n">snip</span><span class="o">&gt;</span>


<span class="n">failures</span><span class="p">:</span>
<span class="w">    </span><span class="nc">filetests</span>

<span class="n">test</span><span class="w"> </span><span class="n">result</span><span class="p">:</span><span class="w"> </span><span class="nc">FAILED</span><span class="p">.</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">passed</span><span class="p">;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">failed</span><span class="p">;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">ignored</span><span class="p">;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">measured</span><span class="p">;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">filtered</span><span class="w"> </span><span class="n">out</span><span class="p">;</span><span class="w"> </span><span class="n">finished</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mf">0.82</span><span class="n">s</span>
</code></pre></div>
<p>&lt;/details&gt;</p>
<p>Problem here is, that that <a href="https://github.com/bytecodealliance/wasmtime/blob/a0338af84f66cb452fdf4b692d4facb5d052c12d/cranelift/filetests/filetests/runtests/simd-extractlane.clif#L12">simd-extractlane.clif</a> test file has <code>pulley32</code>, which probably creates an isa that uses 32 bits pointer widths, but then <a href="https://github.com/bytecodealliance/wasmtime/blob/a0338af84f66cb452fdf4b692d4facb5d052c12d/cranelift/filetests/filetests/runtests/simd-extractlane.clif#L49">line 49</a> presumably gets a 64 bit stack address, which is then passed to the load on line 52, where the verifier now raises that this is incorrect.</p>
<p>I can't really see a good solution for this that does not involve either introducing an address type, or having to split the clif files into 32 and 64 bit tests.</p>
</blockquote>



<a name="497550374"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310118%20Cranelift%3A%20IR%20Reference%20example%20t.../near/497550374" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310118.20Cranelift.3A.20IR.20Reference.20example.20t.2E.2E.2E.html#497550374">(Feb 03 2025 at 23:17)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/10118#issuecomment-2632393734">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10118">issue #10118</a>:</p>
<blockquote>
<blockquote>
<p>Problem here is, that that <a href="https://github.com/bytecodealliance/wasmtime/blob/a0338af84f66cb452fdf4b692d4facb5d052c12d/cranelift/filetests/filetests/runtests/simd-extractlane.clif#L12">simd-extractlane.clif</a> test file has pulley32, which probably creates an isa that uses 32 bits pointer widths, but then <a href="https://github.com/bytecodealliance/wasmtime/blob/a0338af84f66cb452fdf4b692d4facb5d052c12d/cranelift/filetests/filetests/runtests/simd-extractlane.clif#L49">line 49</a> presumably gets a 64 bit stack address, which is then passed to the load on line 52, where the verifier now raises that this is incorrect.</p>
<p>I can't really see a good solution for this that does not involve either introducing an address type, or having to split the clif files into 32 and 64 bit tests.</p>
</blockquote>
<p>It's fine in this case to remove <code>pulley32</code> from the test, I think -- given that the CLIF needs to be platform-pointer-width-aware, any fixed handwritten CLIF will necessarily be tied to one pointer width. For tests where loads and stores are an important part of the tested lowerings, we can split out 32-bit versions. And we should try to write tests in ways that minimize uses of loads and stores except where that is an essential part of the tested lowering (in this case it is, since we have extract-lane-from-memory lowerings on x86-64 at least).</p>
</blockquote>



<a name="497786026"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310118%20Cranelift%3A%20IR%20Reference%20example%20t.../near/497786026" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310118.20Cranelift.3A.20IR.20Reference.20example.20t.2E.2E.2E.html#497786026">(Feb 05 2025 at 00:53)</a>:</h4>
<p>iwanders <a href="https://github.com/bytecodealliance/wasmtime/issues/10118#issuecomment-2635464195">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10118">issue #10118</a>:</p>
<blockquote>
<p>Okay, interesting. Part of me was even wondering why it would be illegal to do a load from an i32, given that it's just pointing to a memory address. The <a href="https://docs.rs/cranelift-codegen/latest/cranelift_codegen/ir/trait.InstBuilder.html#method.load">docs</a> for it state <code>An integer address type</code>, I guess the <code>address type</code> also implies width must be equal to the pointer width?</p>
<p>@cfallin , given that you stated it would be okay to split out the clif files (where necessary) to 32 and 64 bits... should we consider doing that in combination with the (kind of hardcoded) improvement to the verifier I did in c75db15dd4a64ca71d245057be12aeaa08ff9400? I can probably find some time over the weekend to explore how that solution would end up looking. We may want to extend it to also check <code>store</code> to keep it symmetrical?</p>
</blockquote>



<a name="498386131"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310118%20Cranelift%3A%20IR%20Reference%20example%20t.../near/498386131" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310118.20Cranelift.3A.20IR.20Reference.20example.20t.2E.2E.2E.html#498386131">(Feb 07 2025 at 17:05)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/10118#issuecomment-2643498035">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10118">issue #10118</a>:</p>
<blockquote>
<p>Yes, updating the verifier and then updating tests that it finds violate the constraint is the right path here, I think (and for stores as well as loads; and make sure all the SIMD variants and atomics are covered, too). Thanks!</p>
<blockquote>
<p>The <a href="https://docs.rs/cranelift-codegen/latest/cranelift_codegen/ir/trait.InstBuilder.html#method.load">docs</a> for it state <code>An integer address type</code>, I guess the address type also implies width must be equal to the pointer width?</p>
</blockquote>
<p>Yes, the wording is somewhat ambiguous in that method documentation, but we've explicitly decided before (when adding the assert that you're hitting) that we define correct IR to use platform-width pointers only.</p>
</blockquote>



<a name="499870448"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310118%20Cranelift%3A%20IR%20Reference%20example%20t.../near/499870448" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310118.20Cranelift.3A.20IR.20Reference.20example.20t.2E.2E.2E.html#499870448">(Feb 15 2025 at 02:42)</a>:</h4>
<p>cfallin closed <a href="https://github.com/bytecodealliance/wasmtime/issues/10118">issue #10118</a>:</p>
<blockquote>
<h3><code>.clif</code> Test Case</h3>
<p>The Cranelift IR <code>average</code> example code from the <a href="https://github.com/bytecodealliance/wasmtime/blob/5dfccc078bb3dcad152d37013dde8067f197e6e7/cranelift/docs/ir.md#overall-structure">docs/ir.md</a>. I've already added that to the filetests test directory in caeafe27c69804e14c10d28d25ce511488afd212. </p>
<p>Using <code>clif-util</code>;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">../</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">clif</span><span class="o">-</span><span class="n">util</span><span class="w">  </span><span class="n">bugpoint</span><span class="w">  </span><span class="n">filetests</span><span class="o">/</span><span class="n">filetests</span><span class="o">/</span><span class="n">isa</span><span class="o">/</span><span class="n">x64</span><span class="o">/</span><span class="n">average</span><span class="p">.</span><span class="n">clif</span><span class="w"> </span><span class="n">x86_64</span>
<span class="n">After</span><span class="w"> </span><span class="n">pass</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">remaining</span><span class="w"> </span><span class="n">insts</span><span class="o">/</span><span class="n">blocks</span><span class="p">:</span><span class="w"> </span><span class="mi">22</span><span class="o">/</span><span class="mi">3</span><span class="w"> </span><span class="p">(</span><span class="n">will</span><span class="w"> </span><span class="n">keep</span><span class="w"> </span><span class="n">reducing</span><span class="p">)</span>
<span class="n">After</span><span class="w"> </span><span class="n">pass</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">remaining</span><span class="w"> </span><span class="n">insts</span><span class="o">/</span><span class="n">blocks</span><span class="p">:</span><span class="w"> </span><span class="mi">13</span><span class="o">/</span><span class="mi">3</span><span class="w"> </span><span class="p">(</span><span class="n">will</span><span class="w"> </span><span class="n">keep</span><span class="w"> </span><span class="n">reducing</span><span class="p">)</span>
<span class="n">After</span><span class="w"> </span><span class="n">pass</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">remaining</span><span class="w"> </span><span class="n">insts</span><span class="o">/</span><span class="n">blocks</span><span class="p">:</span><span class="w"> </span><span class="mi">13</span><span class="o">/</span><span class="mi">3</span><span class="w"> </span><span class="p">(</span><span class="n">stop</span><span class="w"> </span><span class="n">reducing</span><span class="p">)</span>
<span class="err">████████████████████████████████████████████████████████████</span><span class="w"> </span><span class="n">pass</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">phase</span><span class="w"> </span><span class="n">merge</span><span class="w"> </span><span class="n">blocks</span><span class="w">                   </span><span class="mi">2</span><span class="o">/</span><span class="w">   </span><span class="mi">2</span><span class="w"> </span><span class="n">Remove</span><span class="w"> </span><span class="n">unused</span><span class="w"> </span><span class="n">global</span><span class="w"> </span><span class="n">values</span>
<span class="n">Crash</span><span class="w"> </span><span class="n">message</span><span class="p">:</span><span class="w"> </span><span class="nc">assertion</span><span class="w"> </span><span class="err">`</span><span class="n">left</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">right</span><span class="err">`</span><span class="w"> </span><span class="n">failed</span>
<span class="w">  </span><span class="n">left</span><span class="p">:</span><span class="w"> </span><span class="nc">types</span><span class="p">::</span><span class="n">I32</span>
<span class="w"> </span><span class="n">right</span><span class="p">:</span><span class="w"> </span><span class="nc">types</span><span class="p">::</span><span class="n">I64</span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">average</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="nc">system_v</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ss0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">8</span>

<span class="n">block1</span><span class="p">:</span>
<span class="w">    </span><span class="nc">v0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="n">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="n">v5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="n">v6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v5</span><span class="w">  </span><span class="p">;</span><span class="w"> </span><span class="n">v0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">v5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="n">v9</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f64const</span><span class="w"> </span><span class="mf">0.0</span>
<span class="w">    </span><span class="n">v100</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f32const</span><span class="w"> </span><span class="o">+</span><span class="n">NaN</span>
<span class="w">    </span><span class="n">brif</span><span class="w"> </span><span class="n">v1</span><span class="p">,</span><span class="w"> </span><span class="n">block2</span><span class="p">,</span><span class="w"> </span><span class="n">block5</span><span class="w">  </span><span class="p">;</span><span class="w"> </span><span class="n">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>

<span class="n">block2</span><span class="p">:</span>
<span class="w">    </span><span class="nc">v7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">f32</span><span class="w"> </span><span class="n">v6</span>
<span class="w">    </span><span class="n">v8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fpromote</span><span class="p">.</span><span class="kt">f64</span><span class="w"> </span><span class="n">v7</span>
<span class="w">    </span><span class="n">v10</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fadd</span><span class="w"> </span><span class="n">v8</span><span class="p">,</span><span class="w"> </span><span class="n">v9</span><span class="w">  </span><span class="p">;</span><span class="w"> </span><span class="n">v9</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span>
<span class="w">    </span><span class="n">stack_store</span><span class="w"> </span><span class="n">v10</span><span class="p">,</span><span class="w"> </span><span class="n">ss0</span>
<span class="w">    </span><span class="n">trap</span><span class="w"> </span><span class="n">user1</span>

<span class="n">block5</span><span class="p">:</span>
<span class="w">    </span><span class="nc">return</span><span class="w"> </span><span class="n">v100</span><span class="w">  </span><span class="p">;</span><span class="w"> </span><span class="n">v100</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">+</span><span class="n">NaN</span>
<span class="p">}</span>

<span class="mi">5</span><span class="w"> </span><span class="n">blocks</span><span class="w"> </span><span class="mi">22</span><span class="w"> </span><span class="n">insts</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">blocks</span><span class="w"> </span><span class="mi">13</span><span class="w"> </span><span class="n">insts</span>
</code></pre></div>
<p>Manually, I reduced it to the following:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">average</span><span class="p">(</span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="nc">system_v</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">ss0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">explicit_slot</span><span class="w"> </span><span class="mi">8</span><span class="w">        </span><span class="p">;</span><span class="w"> </span><span class="n">Stack</span><span class="w"> </span><span class="n">slot</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="err">`</span><span class="n">sum</span><span class="err">`</span>

<span class="n">block1</span><span class="p">(</span><span class="n">v0</span><span class="p">:</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="p">:</span><span class="w"> </span><span class="kt">i32</span><span class="p">):</span>
<span class="w">    </span><span class="nc">v20</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f64const</span><span class="w"> </span><span class="mh">0x0</span><span class="p">.</span><span class="mi">0</span><span class="w">         </span><span class="p">;</span><span class="w"> </span><span class="n">Create</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="kt">f64</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="n">just</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">initialise</span><span class="w"> </span><span class="n">ss0</span><span class="p">.</span>
<span class="w">    </span><span class="n">stack_store</span><span class="w"> </span><span class="n">v20</span><span class="p">,</span><span class="w"> </span><span class="n">ss0</span><span class="w">         </span><span class="p">;</span><span class="w"> </span><span class="n">Store</span><span class="w"> </span><span class="kt">f64</span><span class="w"> </span><span class="n">into</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">ss0</span><span class="w"> </span><span class="n">stack</span><span class="w"> </span><span class="n">slot</span><span class="p">,</span><span class="w"> </span><span class="n">just</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">initialise</span><span class="w"> </span><span class="n">ss0</span><span class="p">.</span>
<span class="w">    </span><span class="n">v6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="w">             </span><span class="p">;</span><span class="w"> </span><span class="n">Adds</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">input</span><span class="w"> </span><span class="n">together</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">integers</span><span class="p">,</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="kt">i32</span><span class="o">?</span>
<span class="w">    </span><span class="n">v7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">f32</span><span class="w"> </span><span class="n">v6</span><span class="w">             </span><span class="p">;</span><span class="w"> </span><span class="n">Converts</span><span class="w"> </span><span class="n">v7</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="kt">f32</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="kt">i32</span><span class="p">.</span>
<span class="w">    </span><span class="n">v8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fpromote</span><span class="p">.</span><span class="kt">f64</span><span class="w"> </span><span class="n">v7</span><span class="w">         </span><span class="p">;</span><span class="w"> </span><span class="n">converts</span><span class="w"> </span><span class="n">v7</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="kt">f64</span><span class="w"> </span><span class="n">into</span><span class="w"> </span><span class="n">v8</span><span class="p">.</span>
<span class="w">    </span><span class="n">v9</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stack_load</span><span class="p">.</span><span class="kt">f64</span><span class="w"> </span><span class="n">ss0</span><span class="w">      </span><span class="p">;</span><span class="w"> </span><span class="n">Loads</span><span class="w"> </span><span class="n">ss0</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">stack</span><span class="w"> </span><span class="n">into</span><span class="w"> </span><span class="n">v9</span><span class="p">,</span><span class="w"> </span><span class="n">v9</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="kt">f64</span><span class="w"> </span><span class="n">that</span><span class="o">'</span><span class="na">s</span><span class="w"> </span><span class="mf">0.0</span>
<span class="w">    </span><span class="n">v10</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fadd</span><span class="p">.</span><span class="kt">f64</span><span class="w"> </span><span class="n">v8</span><span class="p">,</span><span class="w"> </span><span class="n">v9</span><span class="w">        </span><span class="p">;</span><span class="w"> </span><span class="n">Adds</span><span class="w"> </span><span class="n">v8</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">v9</span><span class="w"> </span><span class="n">together</span><span class="p">,</span><span class="w"> </span><span class="n">both</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="kt">f64</span><span class="o">'</span><span class="na">s</span><span class="p">,</span><span class="w"> </span><span class="n">so</span><span class="w"> </span><span class="n">v10</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">an</span><span class="w"> </span><span class="kt">f64</span><span class="p">.</span>
<span class="w">    </span><span class="n">stack_store</span><span class="w"> </span><span class="n">v10</span><span class="p">,</span><span class="w"> </span><span class="n">ss0</span><span class="w">         </span><span class="p">;</span><span class="w"> </span><span class="n">Write</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="n">back</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">ss0</span><span class="p">.</span>
<span class="w">    </span><span class="n">v100</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f32const</span><span class="w"> </span><span class="o">+</span><span class="n">NaN</span><span class="w">         </span><span class="p">;</span><span class="w"> </span><span class="n">Just</span><span class="w"> </span><span class="n">creating</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">dummy</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="k">return</span><span class="p">.</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v100</span><span class="w">                  </span><span class="p">;</span><span class="w"> </span><span class="n">Return</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">dummy</span><span class="p">.</span>
<span class="p">}</span>
</code></pre></div>
<p>Instructions themselves seem fine to me, but today is the first day I'm looking at Cranelift at all, so I absolutely may be missing something obvious.</p>
<h3>Steps to Reproduce</h3>
<ul>
<li>Cherrypick caeafe27c69804e14c10d28d25ce511488afd212</li>
<li><code>cd cranelift</code></li>
<li><code>cargo t</code> (note without <code>--release</code>, test will pass with <code>--release</code>).</li>
</ul>
<p>Note, the problem is with <code>x86_64</code>, this function compiles fine with <code>aarch64</code>.</p>
<h3>Expected Results</h3>
<p>I would expect the example function provided in the documentation to compile, it compiles on <code>aarch64</code>, which (to me at least) indicates the function is fine. I would expect this to also compile on <code>x86_64</code>.</p>
<h3>Actual Results</h3>
<p>A debug assert triggers on <a href="https://github.com/bytecodealliance/wasmtime/blob/5dfccc078bb3dcad152d37013dde8067f197e6e7/cranelift/codegen/src/isa/x64/lower.rs#L233">this line</a>;</p>
<p>&lt;details&gt;<br>
&lt;summary&gt;Backtrace&lt;/summary&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">----</span><span class="w"> </span><span class="n">filetests</span><span class="w"> </span><span class="n">stdout</span><span class="w"> </span><span class="o">----</span>
<span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">worker</span><span class="w"> </span><span class="p">#</span><span class="mi">7</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">cranelift</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">isa</span><span class="o">/</span><span class="n">x64</span><span class="o">/</span><span class="n">lower</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">233</span><span class="p">:</span><span class="mi">9</span><span class="p">:</span>
<span class="nc">assertion</span><span class="w"> </span><span class="err">`</span><span class="n">left</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">right</span><span class="err">`</span><span class="w"> </span><span class="n">failed</span>
<span class="w">  </span><span class="n">left</span><span class="p">:</span><span class="w"> </span><span class="nc">types</span><span class="p">::</span><span class="n">I32</span>
<span class="w"> </span><span class="n">right</span><span class="p">:</span><span class="w"> </span><span class="nc">types</span><span class="p">::</span><span class="n">I64</span>
<span class="n">stack</span><span class="w"> </span><span class="n">backtrace</span><span class="p">:</span>
<span class="w">   </span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="nc">rust_begin_unwind</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mi">9</span><span class="n">fc6b43126469e3858e2fe86cafb4f0fd5068869</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panicking</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">665</span><span class="p">:</span><span class="mi">5</span>
<span class="w">   </span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="nc">core</span><span class="p">::</span><span class="n">panicking</span><span class="p">::</span><span class="n">panic_fmt</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">rustc</span><span class="o">/</span><span class="mi">9</span><span class="n">fc6b43126469e3858e2fe86cafb4f0fd5068869</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panicking</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">76</span><span class="p">:</span><span class="mi">14</span>
<span class="w">   </span><span class="mi">2</span><span class="p">:</span><span class="w"> </span><span class="nc">core</span><span class="p">::</span><span class="n">panicking</span><span class="p">::</span><span class="n">assert_failed_inner</span>
<span class="w">   </span><span class="mi">3</span><span class="p">:</span><span class="w"> </span><span class="nc">core</span><span class="p">::</span><span class="n">panicking</span><span class="p">::</span><span class="n">assert_failed</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">ivor</span><span class="o">/</span><span class="p">.</span><span class="n">rustup</span><span class="o">/</span><span class="n">toolchains</span><span class="o">/</span><span class="n">stable</span><span class="o">-</span><span class="n">x86_64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">rustlib</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">rust</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">core</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panicking</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">373</span><span class="p">:</span><span class="mi">5</span>
<span class="w">   </span><span class="mi">4</span><span class="p">:</span><span class="w"> </span><span class="nc">cranelift_codegen</span><span class="p">::</span><span class="n">isa</span><span class="p">::</span><span class="n">x64</span><span class="p">::</span><span class="n">lower</span><span class="p">::</span><span class="n">lower_to_amode</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">isa</span><span class="o">/</span><span class="n">x64</span><span class="o">/</span><span class="n">lower</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">233</span><span class="p">:</span><span class="mi">9</span>
<span class="w">   </span><span class="mi">5</span><span class="p">:</span><span class="w"> </span><span class="nc">cranelift_codegen</span><span class="p">::</span><span class="n">isa</span><span class="p">::</span><span class="n">x64</span><span class="p">::</span><span class="n">lower</span><span class="p">::</span><span class="n">isle</span><span class="p">::</span><span class="o">&lt;</span><span class="k">impl</span><span class="w"> </span><span class="n">cranelift_codegen</span><span class="p">::</span><span class="n">isa</span><span class="p">::</span><span class="n">x64</span><span class="p">::</span><span class="n">lower</span><span class="p">::</span><span class="n">isle</span><span class="p">::</span><span class="n">generated_code</span><span class="p">::</span><span class="n">Context</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">cranelift_codegen</span><span class="p">::</span><span class="n">machinst</span><span class="p">::</span><span class="n">isle</span><span class="p">::</span><span class="n">IsleContext</span><span class="o">&lt;</span><span class="n">cranelift_codegen</span><span class="p">::</span><span class="n">isa</span><span class="p">::</span><span class="n">x64</span><span class="p">::</span><span class="n">lower</span><span class="p">::</span><span class="n">isle</span><span class="p">::</span><span class="n">generated_code</span><span class="p">::</span><span class="n">MInst</span><span class="p">,</span><span class="n">cranelift_codegen</span><span class="p">::</span><span class="n">isa</span><span class="p">::</span><span class="n">x64</span><span class="p">::</span><span class="n">X64Backend</span><span class="o">&gt;&gt;</span><span class="p">::</span><span class="n">sink_load</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">isa</span><span class="o">/</span><span class="n">x64</span><span class="o">/</span><span class="n">lower</span><span class="o">/</span><span class="n">isle</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">313</span><span class="p">:</span><span class="mi">20</span>
<span class="w">   </span><span class="mi">6</span><span class="p">:</span><span class="w"> </span><span class="nc">cranelift_codegen</span><span class="p">::</span><span class="n">isa</span><span class="p">::</span><span class="n">x64</span><span class="p">::</span><span class="n">lower</span><span class="p">::</span><span class="n">isle</span><span class="p">::</span><span class="o">&lt;</span><span class="k">impl</span><span class="w"> </span><span class="n">cranelift_codegen</span><span class="p">::</span><span class="n">isa</span><span class="p">::</span><span class="n">x64</span><span class="p">::</span><span class="n">lower</span><span class="p">::</span><span class="n">isle</span><span class="p">::</span><span class="n">generated_code</span><span class="p">::</span><span class="n">Context</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">cranelift_codegen</span><span class="p">::</span><span class="n">machinst</span><span class="p">::</span><span class="n">isle</span><span class="p">::</span><span class="n">IsleContext</span><span class="o">&lt;</span><span class="n">cranelift_codegen</span><span class="p">::</span><span class="n">isa</span><span class="p">::</span><span class="n">x64</span><span class="p">::</span><span class="n">lower</span><span class="p">::</span><span class="n">isle</span><span class="p">::</span><span class="n">generated_code</span><span class="p">::</span><span class="n">MInst</span><span class="p">,</span><span class="n">cranelift_codegen</span><span class="p">::</span><span class="n">isa</span><span class="p">::</span><span class="n">x64</span><span class="p">::</span><span class="n">X64Backend</span><span class="o">&gt;&gt;</span><span class="p">::</span><span class="n">put_in_reg_mem</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">isa</span><span class="o">/</span><span class="n">x64</span><span class="o">/</span><span class="n">lower</span><span class="o">/</span><span class="n">isle</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">148</span><span class="p">:</span><span class="mi">23</span>
<span class="w">   </span><span class="mi">7</span><span class="p">:</span><span class="w"> </span><span class="nc">cranelift_codegen</span><span class="p">::</span><span class="n">isa</span><span class="p">::</span><span class="n">x64</span><span class="p">::</span><span class="n">lower</span><span class="p">::</span><span class="n">isle</span><span class="p">::</span><span class="o">&lt;</span><span class="k">impl</span><span class="w"> </span><span class="n">cranelift_codegen</span><span class="p">::</span><span class="n">isa</span><span class="p">::</span><span class="n">x64</span><span class="p">::</span><span class="n">lower</span><span class="p">::</span><span class="n">isle</span><span class="p">::</span><span class="n">generated_code</span><span class="p">::</span><span class="n">Context</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">cranelift_codegen</span><span class="p">::</span><span class="n">machinst</span><span class="p">::</span><span class="n">isle</span><span class="p">::</span><span class="n">IsleContext</span><span class="o">&lt;</span><span class="n">cranelift_codegen</span><span class="p">::</span><span class="n">isa</span><span class="p">::</span><span class="n">x64</span><span class="p">::</span><span class="n">lower</span><span class="p">::</span><span class="n">isle</span><span class="p">::</span><span class="n">generated_code</span><span class="p">::</span><span class="n">MInst</span><span class="p">,</span><span class="n">cranelift_codegen</span><span class="p">::</span><span class="n">isa</span><span class="p">::</span><span class="n">x64</span><span class="p">::</span><span class="n">X64Backend</span><span class="o">&gt;&gt;</span><span class="p">::</span><span class="n">put_in_xmm_mem</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">isa</span><span class="o">/</span><span class="n">x64</span><span class="o">/</span><span class="n">lower</span><span class="o">/</span><span class="n">isle</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">132</span><span class="p">:</span><span class="mi">28</span>
<span class="w">   </span><span class="mi">8</span><span class="p">:</span><span class="w"> </span><span class="nc">cranelift_codegen</span><span class="p">::</span><span class="n">isa</span><span class="p">::</span><span class="n">x64</span><span class="p">::</span><span class="n">lower</span><span class="p">::</span><span class="n">isle</span><span class="p">::</span><span class="n">generated_code</span><span class="p">::</span><span class="n">constructor_lower</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">ivor</span><span class="o">/</span><span class="n">Documents</span><span class="o">/</span><span class="n">Code</span><span class="o">/</span><span class="n">rust</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">cranelift</span><span class="o">-</span><span class="n">codegen</span><span class="o">-</span><span class="mi">8</span><span class="n">f3d42bba10fabf3</span><span class="o">/</span><span class="n">out</span><span class="o">/</span><span class="n">isle_x64</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">21098</span><span class="p">:</span><span class="mi">42</span>
<span class="w">   </span><span class="mi">9</span><span class="p">:</span><span class="w"> </span><span class="nc">cranelift_codegen</span><span class="p">::</span><span class="n">isa</span><span class="p">::</span><span class="n">x64</span><span class="p">::</span><span class="n">lower</span><span class="p">::</span><span class="n">isle</span><span class="p">::</span><span class="n">lower</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">isa</span><span class="o">/</span><span class="n">x64</span><span class="o">/</span><span class="n">lower</span><span class="o">/</span><span class="n">isle</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">55</span><span class="p">:</span><span class="mi">5</span>
<span class="w">  </span><span class="mi">10</span><span class="p">:</span><span class="w"> </span><span class="nc">cranelift_codegen</span><span class="p">::</span><span class="n">isa</span><span class="p">::</span><span class="n">x64</span><span class="p">::</span><span class="n">lower</span><span class="p">::</span><span class="o">&lt;</span><span class="k">impl</span><span class="w"> </span><span class="n">cranelift_codegen</span><span class="p">::</span><span class="n">machinst</span><span class="p">::</span><span class="n">lower</span><span class="p">::</span><span class="n">LowerBackend</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">cranelift_codegen</span><span class="p">::</span><span class="n">isa</span><span class="p">::</span><span class="n">x64</span><span class="p">::</span><span class="n">X64Backend</span><span class="o">&gt;</span><span class="p">::</span><span class="n">lower</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">isa</span><span class="o">/</span><span class="n">x64</span><span class="o">/</span><span class="n">lower</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">311</span><span class="p">:</span><span class="mi">9</span>
<span class="w">  </span><span class="mi">11</span><span class="p">:</span><span class="w"> </span><span class="nc">cranelift_codegen</span><span class="p">::</span><span class="n">machinst</span><span class="p">::</span><span class="n">lower</span><span class="p">::</span><span class="n">Lower</span><span class="o">&lt;</span><span class="n">I</span><span class="o">&gt;</span><span class="p">::</span><span class="n">lower_clif_block</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">machinst</span><span class="o">/</span><span class="n">lower</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">679</span><span class="p">:</span><span class="mi">39</span>
<span class="w">  </span><span class="mi">12</span><span class="p">:</span><span class="w"> </span><span class="nc">cranelift_codegen</span><span class="p">::</span><span class="n">machinst</span><span class="p">::</span><span class="n">lower</span><span class="p">::</span><span class="n">Lower</span><span class="o">&lt;</span><span class="n">I</span><span class="o">&gt;</span><span class="p">::</span><span class="n">lower</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">machinst</span><span class="o">/</span><span class="n">lower</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">1020</span><span class="p">:</span><span class="mi">17</span>
<span class="w">  </span><span class="mi">13</span><span class="p">:</span><span class="w"> </span><span class="nc">cranelift_codegen</span><span class="p">::</span><span class="n">machinst</span><span class="p">::</span><span class="n">compile</span><span class="p">::</span><span class="n">compile</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">machinst</span><span class="o">/</span><span class="n">compile</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">42</span><span class="p">:</span><span class="mi">9</span>
<span class="w">  </span><span class="mi">14</span><span class="p">:</span><span class="w"> </span><span class="nc">cranelift_codegen</span><span class="p">::</span><span class="n">isa</span><span class="p">::</span><span class="n">x64</span><span class="p">::</span><span class="n">X64Backend</span><span class="p">::</span><span class="n">compile_vcode</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">isa</span><span class="o">/</span><span class="n">x64</span><span class="o">/</span><span class="k">mod</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">62</span><span class="p">:</span><span class="mi">9</span>
<span class="w">  </span><span class="mi">15</span><span class="p">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">cranelift_codegen</span><span class="p">::</span><span class="n">isa</span><span class="p">::</span><span class="n">x64</span><span class="p">::</span><span class="n">X64Backend</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">cranelift_codegen</span><span class="p">::</span><span class="n">isa</span><span class="p">::</span><span class="n">TargetIsa</span><span class="o">&gt;</span><span class="p">::</span><span class="n">compile_function</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">isa</span><span class="o">/</span><span class="n">x64</span><span class="o">/</span><span class="k">mod</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">74</span><span class="p">:</span><span class="mi">40</span>
<span class="w">  </span><span class="mi">16</span><span class="p">:</span><span class="w"> </span><span class="nc">cranelift_codegen</span><span class="p">::</span><span class="n">context</span><span class="p">::</span><span class="n">Context</span><span class="p">::</span><span class="n">compile_stencil</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">context</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">138</span><span class="p">:</span><span class="mi">9</span>
<span class="w">  </span><span class="mi">17</span><span class="p">:</span><span class="w"> </span><span class="nc">cranelift_codegen</span><span class="p">::</span><span class="n">context</span><span class="p">::</span><span class="n">Context</span><span class="p">::</span><span class="n">compile</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">codegen</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">context</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">204</span><span class="p">:</span><span class="mi">23</span>
<span class="w">  </span><span class="mi">18</span><span class="p">:</span><span class="w"> </span><span class="o">&lt;</span><span class="n">cranelift_filetests</span><span class="p">::</span><span class="n">test_compile</span><span class="p">::</span><span class="n">TestCompile</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">cranelift_filetests</span><span class="p">::</span><span class="n">subtest</span><span class="p">::</span><span class="n">SubTest</span><span class="o">&gt;</span><span class="p">::</span><span class="n">run</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">filetests</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">test_compile</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mi">29</span>
<span class="w">  </span><span class="mi">19</span><span class="p">:</span><span class="w"> </span><span class="nc">cranelift_filetests</span><span class="p">::</span><span class="n">subtest</span><span class="p">::</span><span class="n">SubTest</span><span class="p">::</span><span class="n">run_target</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">filetests</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">subtest</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">101</span><span class="p">:</span><span class="mi">13</span>
<span class="w">  </span><span class="mi">20</span><span class="p">:</span><span class="w"> </span><span class="nc">cranelift_filetests</span><span class="p">::</span><span class="n">runone</span><span class="p">::</span><span class="n">run</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">filetests</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">runone</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">97</span><span class="p">:</span><span class="mi">9</span>
<span class="w">  </span><span class="mi">21</span><span class="p">:</span><span class="w"> </span><span class="nc">cranelift_filetests</span><span class="p">::</span><span class="n">concurrent</span><span class="p">::</span><span class="n">worker_thread</span><span class="p">::{{</span><span class="n">closure</span><span class="p">}}::{{</span><span class="n">closure</span><span class="p">}}</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">filetests</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">concurrent</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">149</span><span class="p">:</span><span class="mi">46</span>
<span class="w">  </span><span class="mi">22</span><span class="p">:</span><span class="w"> </span><span class="nc">std</span><span class="p">::</span><span class="n">panicking</span><span class="p">::</span><span class="kr">try</span><span class="p">::</span><span class="n">do_call</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">ivor</span><span class="o">/</span><span class="p">.</span><span class="n">rustup</span><span class="o">/</span><span class="n">toolchains</span><span class="o">/</span><span class="n">stable</span><span class="o">-</span><span class="n">x86_64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">rustlib</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">rust</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panicking</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">557</span><span class="p">:</span><span class="mi">40</span>
<span class="w">  </span><span class="mi">23</span><span class="p">:</span><span class="w"> </span><span class="nc">__rust_try</span>
<span class="w">  </span><span class="mi">24</span><span class="p">:</span><span class="w"> </span><span class="nc">std</span><span class="p">::</span><span class="n">panicking</span><span class="p">::</span><span class="kr">try</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">ivor</span><span class="o">/</span><span class="p">.</span><span class="n">rustup</span><span class="o">/</span><span class="n">toolchains</span><span class="o">/</span><span class="n">stable</span><span class="o">-</span><span class="n">x86_64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">rustlib</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">rust</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panicking</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">520</span><span class="p">:</span><span class="mi">19</span>
<span class="w">  </span><span class="mi">25</span><span class="p">:</span><span class="w"> </span><span class="nc">std</span><span class="p">::</span><span class="n">panic</span><span class="p">::</span><span class="n">catch_unwind</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">ivor</span><span class="o">/</span><span class="p">.</span><span class="n">rustup</span><span class="o">/</span><span class="n">toolchains</span><span class="o">/</span><span class="n">stable</span><span class="o">-</span><span class="n">x86_64</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">rustlib</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">rust</span><span class="o">/</span><span class="n">library</span><span class="o">/</span><span class="n">std</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">panic</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">358</span><span class="p">:</span><span class="mi">14</span>
<span class="w">  </span><span class="mi">26</span><span class="p">:</span><span class="w"> </span><span class="nc">cranelift_filetests</span><span class="p">::</span><span class="n">concurrent</span><span class="p">::</span><span class="n">worker_thread</span><span class="p">::{{</span><span class="n">closure</span><span class="p">}}</span>
<span class="w">             </span><span class="n">at</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">filetests</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">concurrent</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">149</span><span class="p">:</span><span class="mi">30</span>
<span class="n">note</span><span class="p">:</span><span class="w"> </span><span class="nb">Some</span><span class="w"> </span><span class="nc">details</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">omitted</span><span class="p">,</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="err">`</span><span class="n">RUST_BACKTRACE</span><span class="o">=</span><span class="n">full</span><span class="err">`</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">verbose</span><span class="w"> </span><span class="n">backtrace</span><span class="p">.</span>
</code></pre></div>
<p>&lt;/details&gt;</p>
<p>The relevant section from <code>isle_x64.rs</code>;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">&amp;</span><span class="n">Opcode</span><span class="p">::</span><span class="n">Fpromote</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">C</span><span class="p">::</span><span class="n">first_result</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">arg0</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v1</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">v3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">C</span><span class="p">::</span><span class="n">value_type</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">v2</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">v3</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">F64</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">v1809</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">constructor_xmm_zero</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">F64X2</span><span class="p">);</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">v1804</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">C</span><span class="p">::</span><span class="n">put_in_xmm_mem</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">v520</span><span class="p">);</span><span class="w">             </span><span class="c1">// &lt;- Line isle_x64.rs:21098:42</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">v1819</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">constructor_x64_cvtss2sd</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">v1809</span><span class="p">,</span><span class="w"> </span><span class="n">v1804</span><span class="p">);</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">v1820</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">constructor_output_xmm</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">v1819</span><span class="p">);</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">v1821</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">v1820</span><span class="p">);</span>
<span class="w">            </span><span class="c1">// Rule at src/isa/x64/lower.isle line 2661.</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">v1821</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>Which seems to indicate the problem is originating from <code>Fpromote</code>.</p>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: Current released; <code>0.116.1</code>, also tested on current main; 5dfccc078bb3dcad152d37013dde8067f197e6e7.</p>
<p>Operating system: Ubuntu, stable rustc 1.84.0 (9fc6b4312 2025-01-07)</p>
<p>Architecture: x86_64</p>
<h3>Extra Info</h3>
<p>If I use a release build, target x86_64 and write the output to an object file using <code>cranelift_object::ObjectModule</code>. The provided symbol does work and correctly calculates averages.</p>
<p>&lt;details&gt;<br>
&lt;summary&gt;Disassembly of object and usage of it to calculate average&lt;/summary&gt;</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">objdump</span><span class="w"> </span><span class="o">-</span><span class="n">d</span><span class="w"> </span><span class="n">average</span><span class="p">.</span><span class="n">o</span>

<span class="n">average</span><span class="p">.</span><span class="n">o</span><span class="p">:</span><span class="w">     </span><span class="nc">file</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="n">elf64</span><span class="o">-</span><span class="n">x86</span><span class="o">-</span><span class="mi">64</span>


<span class="n">Disassembly</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">section</span><span class="w"> </span><span class="p">.</span><span class="n">text</span><span class="p">:</span>

<span class="mi">0000000000000000</span><span class="w"> </span><span class="o">&lt;</span><span class="n">average</span><span class="o">&gt;</span><span class="p">:</span>
<span class="w">   </span><span class="mi">0</span><span class="p">:</span><span class="w">   </span><span class="mi">55</span><span class="w">                      </span><span class="n">push</span><span class="w">   </span><span class="o">%</span><span class="n">rbp</span>
<span class="w">   </span><span class="mi">1</span><span class="p">:</span><span class="w">   </span><span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">e5</span><span class="w">                </span><span class="n">mov</span><span class="w">    </span><span class="o">%</span><span class="n">rsp</span><span class="p">,</span><span class="o">%</span><span class="n">rbp</span>
<span class="w">   </span><span class="mi">4</span><span class="p">:</span><span class="w">   </span><span class="mi">48</span><span class="w"> </span><span class="mi">83</span><span class="w"> </span><span class="n">ec</span><span class="w"> </span><span class="mi">10</span><span class="w">             </span><span class="n">sub</span><span class="w">    </span><span class="cp">$</span><span class="mh">0x10</span><span class="p">,</span><span class="o">%</span><span class="n">rsp</span>
<span class="w">   </span><span class="mi">8</span><span class="p">:</span><span class="w">   </span><span class="mi">66</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">57</span><span class="w"> </span><span class="n">e4</span><span class="w">             </span><span class="n">xorpd</span><span class="w">  </span><span class="o">%</span><span class="n">xmm4</span><span class="p">,</span><span class="o">%</span><span class="n">xmm4</span>
<span class="w">   </span><span class="n">c</span><span class="p">:</span><span class="w">   </span><span class="mi">48</span><span class="w"> </span><span class="mi">8</span><span class="n">d</span><span class="w"> </span><span class="mi">04</span><span class="w"> </span><span class="mi">24</span><span class="w">             </span><span class="n">lea</span><span class="w">    </span><span class="p">(</span><span class="o">%</span><span class="n">rsp</span><span class="p">),</span><span class="o">%</span><span class="n">rax</span>
<span class="w">  </span><span class="mi">10</span><span class="p">:</span><span class="w">   </span><span class="nc">f2</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="mi">20</span><span class="w">             </span><span class="n">movsd</span><span class="w">  </span><span class="o">%</span><span class="n">xmm4</span><span class="p">,(</span><span class="o">%</span><span class="n">rax</span><span class="p">)</span>
<span class="w">  </span><span class="mi">14</span><span class="p">:</span><span class="w">   </span><span class="mi">85</span><span class="w"> </span><span class="n">f6</span><span class="w">                   </span><span class="n">test</span><span class="w">   </span><span class="o">%</span><span class="n">esi</span><span class="p">,</span><span class="o">%</span><span class="n">esi</span>
<span class="w">  </span><span class="mi">16</span><span class="p">:</span><span class="w">   </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">85</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w">       </span><span class="n">jne</span><span class="w">    </span><span class="mi">2</span><span class="n">e</span><span class="w"> </span><span class="o">&lt;</span><span class="n">average</span><span class="o">+</span><span class="mh">0x2e</span><span class="o">&gt;</span>
<span class="w">  </span><span class="mi">1</span><span class="n">c</span><span class="p">:</span><span class="w">   </span><span class="nc">b9</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="mi">00</span><span class="w"> </span><span class="n">c0</span><span class="w"> </span><span class="mi">7</span><span class="n">f</span><span class="w">          </span><span class="n">mov</span><span class="w">    </span><span class="cp">$</span><span class="mh">0x7fc00000</span><span class="p">,</span><span class="o">%</span><span class="n">ecx</span>
<span class="w">  </span><span class="mi">21</span><span class="p">:</span><span class="w">   </span><span class="mi">66</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">6</span><span class="n">e</span><span class="w"> </span><span class="n">c1</span><span class="w">             </span><span class="n">movd</span><span class="w">   </span><span class="o">%</span><span class="n">ecx</span><span class="p">,</span><span class="o">%</span><span class="n">xmm0</span>
<span class="w">  </span><span class="mi">25</span><span class="p">:</span><span class="w">   </span><span class="mi">48</span><span class="w"> </span><span class="mi">83</span><span class="w"> </span><span class="n">c4</span><span class="w"> </span><span class="mi">10</span><span class="w">             </span><span class="n">add</span><span class="w">    </span><span class="cp">$</span><span class="mh">0x10</span><span class="p">,</span><span class="o">%</span><span class="n">rsp</span>
<span class="w">  </span><span class="mi">29</span><span class="p">:</span><span class="w">   </span><span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">ec</span><span class="w">                </span><span class="n">mov</span><span class="w">    </span><span class="o">%</span><span class="n">rbp</span><span class="p">,</span><span class="o">%</span><span class="n">rsp</span>
<span class="w">  </span><span class="mi">2</span><span class="n">c</span><span class="p">:</span><span class="w">   </span><span class="mi">5</span><span class="n">d</span><span class="w">                      </span><span class="n">pop</span><span class="w">    </span><span class="o">%</span><span class="n">rbp</span>
<span class="w">  </span><span class="mi">2</span><span class="n">d</span><span class="p">:</span><span class="w">   </span><span class="nc">c3</span><span class="w">                      </span><span class="n">retq</span>
<span class="w">  </span><span class="mi">2</span><span class="n">e</span><span class="p">:</span><span class="w">   </span><span class="mi">31</span><span class="w"> </span><span class="n">c9</span><span class="w">                   </span><span class="n">xor</span><span class="w">    </span><span class="o">%</span><span class="n">ecx</span><span class="p">,</span><span class="o">%</span><span class="n">ecx</span>
<span class="w">  </span><span class="mi">30</span><span class="p">:</span><span class="w">   </span><span class="mi">44</span><span class="w"> </span><span class="mi">6</span><span class="n">b</span><span class="w"> </span><span class="n">c9</span><span class="w"> </span><span class="mi">04</span><span class="w">             </span><span class="n">imul</span><span class="w">   </span><span class="cp">$</span><span class="mh">0x4</span><span class="p">,</span><span class="o">%</span><span class="n">ecx</span><span class="p">,</span><span class="o">%</span><span class="n">r9d</span>
<span class="w">  </span><span class="mi">34</span><span class="p">:</span><span class="w">   </span><span class="mi">66</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">57</span><span class="w"> </span><span class="n">ed</span><span class="w">             </span><span class="n">xorpd</span><span class="w">  </span><span class="o">%</span><span class="n">xmm5</span><span class="p">,</span><span class="o">%</span><span class="n">xmm5</span>
<span class="w">  </span><span class="mi">38</span><span class="p">:</span><span class="w">   </span><span class="nc">f3</span><span class="w"> </span><span class="mi">42</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">5</span><span class="n">a</span><span class="w"> </span><span class="mi">2</span><span class="n">c</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w">       </span><span class="n">cvtss2sd</span><span class="w"> </span><span class="p">(</span><span class="o">%</span><span class="n">rdi</span><span class="p">,</span><span class="o">%</span><span class="n">r9</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="o">%</span><span class="n">xmm5</span>
<span class="w">  </span><span class="mi">3</span><span class="n">e</span><span class="p">:</span><span class="w">   </span><span class="mi">4</span><span class="n">c</span><span class="w"> </span><span class="mi">8</span><span class="n">d</span><span class="w"> </span><span class="mi">0</span><span class="n">c</span><span class="w"> </span><span class="mi">24</span><span class="w">             </span><span class="n">lea</span><span class="w">    </span><span class="p">(</span><span class="o">%</span><span class="n">rsp</span><span class="p">),</span><span class="o">%</span><span class="n">r9</span>
<span class="w">  </span><span class="mi">42</span><span class="p">:</span><span class="w">   </span><span class="nc">f2</span><span class="w"> </span><span class="mi">41</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">58</span><span class="w"> </span><span class="mi">29</span><span class="w">          </span><span class="n">addsd</span><span class="w">  </span><span class="p">(</span><span class="o">%</span><span class="n">r9</span><span class="p">),</span><span class="o">%</span><span class="n">xmm5</span>
<span class="w">  </span><span class="mi">47</span><span class="p">:</span><span class="w">   </span><span class="mi">4</span><span class="n">c</span><span class="w"> </span><span class="mi">8</span><span class="n">d</span><span class="w"> </span><span class="mi">0</span><span class="n">c</span><span class="w"> </span><span class="mi">24</span><span class="w">             </span><span class="n">lea</span><span class="w">    </span><span class="p">(</span><span class="o">%</span><span class="n">rsp</span><span class="p">),</span><span class="o">%</span><span class="n">r9</span>
<span class="w">  </span><span class="mi">4</span><span class="n">b</span><span class="p">:</span>
<span class="p">[</span><span class="n">message</span><span class="w"> </span><span class="n">truncated</span><span class="p">]</span>
</code></pre></div><br>
</p>
</blockquote>



<hr><p>Last updated: Feb 22 2026 at 11:05 UTC</p>
</html>
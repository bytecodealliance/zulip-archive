<html>
<head><meta charset="utf-8"><title>wasmtime / issue #12139 Cranelift: ISLE mid-end performan... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312139.20Cranelift.3A.20ISLE.20mid-end.20performan.2E.2E.2E.html">wasmtime / issue #12139 Cranelift: ISLE mid-end performan...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="562467488"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312139%20Cranelift%3A%20ISLE%20mid-end%20performan.../near/562467488" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312139.20Cranelift.3A.20ISLE.20mid-end.20performan.2E.2E.2E.html#562467488">(Dec 08 2025 at 13:33)</a>:</h4>
<p>bongjunj opened <a href="https://github.com/bytecodealliance/wasmtime/issues/12139">issue #12139</a>:</p>
<blockquote>
<p>Hi,</p>
<p>this is a follow-up of <a href="https://github.com/bytecodealliance/wasmtime/issues/12106">https://github.com/bytecodealliance/wasmtime/issues/12106</a> .</p>
<p>Although we've removed two sorts of performance regressing mid-end ISLE rules,<br>
there still remains a significant performance degradation as well as other suspected cases.<br>
(There is, of course, a bright side: we have significant performance improvements for many cases!)</p>
<p>Performance Regression:</p>
<ul>
<li>shootout-switch</li>
<li>pulldown-cmark</li>
</ul>
<p>First, here is the backing data of the performance regression:</p>
<table>
<thead>
<tr>
<th>Benchmark</th>
<th style="text-align: right;">No Opt</th>
<th style="text-align: right;">Main</th>
<th style="text-align: right;">Main Speedup</th>
</tr>
</thead>
<tbody>
<tr>
<td>blake3-scalar</td>
<td style="text-align: right;">317,727</td>
<td style="text-align: right;">317,719</td>
<td style="text-align: right;">0.00%</td>
</tr>
<tr>
<td>blake3-simd</td>
<td style="text-align: right;">313,115</td>
<td style="text-align: right;">306,232</td>
<td style="text-align: right;">2.25%</td>
</tr>
<tr>
<td>bz2</td>
<td style="text-align: right;">87,201,400</td>
<td style="text-align: right;">86,337,330</td>
<td style="text-align: right;">1.00%</td>
</tr>
<tr>
<td>pulldown-cmark</td>
<td style="text-align: right;">6,580,174</td>
<td style="text-align: right;">6,905,992</td>
<td style="text-align: right;">-4.72%</td>
</tr>
<tr>
<td>regex</td>
<td style="text-align: right;">209,743,816</td>
<td style="text-align: right;">210,183,175</td>
<td style="text-align: right;">-0.21%</td>
</tr>
<tr>
<td>shootout-ackermann</td>
<td style="text-align: right;">8,498,140</td>
<td style="text-align: right;">7,764,439</td>
<td style="text-align: right;">9.45%</td>
</tr>
<tr>
<td>shootout-base64</td>
<td style="text-align: right;">381,721,177</td>
<td style="text-align: right;">352,724,661</td>
<td style="text-align: right;">8.22%</td>
</tr>
<tr>
<td>shootout-ctype</td>
<td style="text-align: right;">830,813,398</td>
<td style="text-align: right;">796,486,698</td>
<td style="text-align: right;">4.31%</td>
</tr>
<tr>
<td>shootout-ed25519</td>
<td style="text-align: right;">9,583,747,723</td>
<td style="text-align: right;">9,395,321,203</td>
<td style="text-align: right;">2.01%</td>
</tr>
<tr>
<td>shootout-fib2</td>
<td style="text-align: right;">3,009,269,670</td>
<td style="text-align: right;">3,010,509,565</td>
<td style="text-align: right;">-0.04%</td>
</tr>
<tr>
<td>shootout-gimli</td>
<td style="text-align: right;">5,338,258</td>
<td style="text-align: right;">5,401,697</td>
<td style="text-align: right;">-1.17%</td>
</tr>
<tr>
<td>shootout-heapsort</td>
<td style="text-align: right;">2,382,073,831</td>
<td style="text-align: right;">2,375,914,107</td>
<td style="text-align: right;">0.26%</td>
</tr>
<tr>
<td>shootout-keccak</td>
<td style="text-align: right;">25,168,386</td>
<td style="text-align: right;">21,112,482</td>
<td style="text-align: right;">19.21%</td>
</tr>
<tr>
<td>shootout-matrix</td>
<td style="text-align: right;">538,696,036</td>
<td style="text-align: right;">544,739,691</td>
<td style="text-align: right;">-1.11%</td>
</tr>
<tr>
<td>shootout-memmove</td>
<td style="text-align: right;">36,156,621</td>
<td style="text-align: right;">36,115,998</td>
<td style="text-align: right;">0.11%</td>
</tr>
<tr>
<td>shootout-minicsv</td>
<td style="text-align: right;">1,481,713,625</td>
<td style="text-align: right;">1,291,534,227</td>
<td style="text-align: right;">14.73%</td>
</tr>
<tr>
<td>shootout-nestedloop</td>
<td style="text-align: right;">449</td>
<td style="text-align: right;">442</td>
<td style="text-align: right;">1.43%</td>
</tr>
<tr>
<td>shootout-random</td>
<td style="text-align: right;">630,328,205</td>
<td style="text-align: right;">439,691,474</td>
<td style="text-align: right;">43.36%</td>
</tr>
<tr>
<td>shootout-ratelimit</td>
<td style="text-align: right;">39,148,817</td>
<td style="text-align: right;">39,956,714</td>
<td style="text-align: right;">-2.02%</td>
</tr>
<tr>
<td>shootout-seqhash</td>
<td style="text-align: right;">8,869,585,125</td>
<td style="text-align: right;">8,639,110,150</td>
<td style="text-align: right;">2.67%</td>
</tr>
<tr>
<td>shootout-sieve</td>
<td style="text-align: right;">905,404,028</td>
<td style="text-align: right;">840,777,681</td>
<td style="text-align: right;">7.69%</td>
</tr>
<tr>
<td>shootout-switch</td>
<td style="text-align: right;">139,525,474</td>
<td style="text-align: right;">153,663,682</td>
<td style="text-align: right;">-9.20%</td>
</tr>
<tr>
<td>shootout-xblabla20</td>
<td style="text-align: right;">2,891,404</td>
<td style="text-align: right;">2,907,369</td>
<td style="text-align: right;">-0.55%</td>
</tr>
<tr>
<td>shootout-xchacha20</td>
<td style="text-align: right;">4,384,703</td>
<td style="text-align: right;">4,395,319</td>
<td style="text-align: right;">-0.24%</td>
</tr>
<tr>
<td>spidermonkey</td>
<td style="text-align: right;">636,104,785</td>
<td style="text-align: right;">631,998,404</td>
<td style="text-align: right;">0.65%</td>
</tr>
</tbody>
</table>
<p>Unlike the previous cases, the cause is not obvious.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="mi">19245</span><span class="w"> </span><span class="n">clif</span><span class="o">/</span><span class="n">v</span><span class="o">-</span><span class="n">no</span><span class="o">-</span><span class="n">opts</span><span class="o">/</span><span class="n">shootout</span><span class="o">-</span><span class="n">switch</span><span class="o">/</span><span class="n">wasm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">--</span><span class="n">function</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">--</span><span class="n">__original_main</span><span class="p">.</span><span class="n">clif</span>
<span class="mi">19241</span><span class="w"> </span><span class="n">clif</span><span class="o">/</span><span class="n">v</span><span class="o">-</span><span class="n">main</span><span class="o">/</span><span class="n">shootout</span><span class="o">-</span><span class="n">switch</span><span class="o">/</span><span class="n">wasm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">--</span><span class="n">function</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">--</span><span class="n">__original_main</span><span class="p">.</span><span class="n">clif</span>
</code></pre></div>
<p>The number of instructions does not increase significantly from no-opt to main.<br>
However, the applied optimizations make the program use long-lived value:</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gd">--- /data/bongjun/clif/v-no-opts/shootout-switch/wasm[0]--function[9]--__original_main.clif 2025-12-08 12:43:58.406738645 +0000</span>
<span class="gi">+++ /data/bongjun/clif/v-main/shootout-switch/wasm[0]--function[9]--__original_main.clif    2025-12-08 12:49:01.961085326 +0000</span>

<span class="gd">-                                    v8572 = iconst.i32 1066</span>
<span class="gd">-                                    v8573 = iconst.i32 0</span>
<span class="gd">-@d20b                               v4324 = call fn1(v0, v0, v8572, v8573)  ; v8572 = 1066, v8573 = 0</span>
<span class="gd">-                                    v8574 = iadd.i64 v105, v106  ; v106 = 3584</span>
<span class="gd">-@d219                               v4333 = load.i32 little heap v8574</span>
<span class="gd">-                                    v8575 = iconst.i32 6</span>
<span class="gd">-                                    v8576 = icmp uge v4333, v8575  ; v8575 = 6</span>
<span class="gi">+                                    v8603 = iconst.i32 1066</span>
<span class="gi">+                                    v8604 = iconst.i32 0</span>
<span class="gi">+@d20b                               v4324 = call fn1(v0, v0, v8603, v8604)  ; v8603 = 1066, v8604 = 0</span>
<span class="gi">+                                    v8605 = iadd.i64 v11, v106  ; v106 = 3584</span>
<span class="gi">+@d219                               v4333 = load.i32 little heap v8605</span>
<span class="gi">+                                    v8606 = iconst.i32 6</span>
<span class="gi">+                                    v8607 = icmp uge v4333, v8606  ; v8606 = 6</span>
</code></pre></div>
<p>See <code>v8574</code> and <code>v8605</code> which uses <code>v105</code> and <code>v11</code>.<br>
<code>v11</code> is defined at the beginning, but <code>v105</code> is defined later than <code>v11</code>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">                                </span><span class="n">block0</span><span class="p">(</span><span class="n">v0</span><span class="p">:</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="p">:</span><span class="w"> </span><span class="kt">i64</span><span class="p">):</span>
<span class="o">@</span><span class="mi">01</span><span class="n">f0</span><span class="w">                               </span><span class="n">v5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">table</span><span class="w"> </span><span class="n">v0</span><span class="o">+</span><span class="mi">256</span>
<span class="o">@</span><span class="mi">01</span><span class="n">f6</span><span class="w">                               </span><span class="n">v6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="mi">16</span>
<span class="o">@</span><span class="mi">01</span><span class="n">f8</span><span class="w">                               </span><span class="n">v7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isub</span><span class="w"> </span><span class="n">v5</span><span class="p">,</span><span class="w"> </span><span class="n">v6</span><span class="w">  </span><span class="p">;</span><span class="w"> </span><span class="n">v6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">16</span>
<span class="o">@</span><span class="mi">01</span><span class="n">fb</span><span class="w">                               </span><span class="n">store</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">table</span><span class="w"> </span><span class="n">v7</span><span class="p">,</span><span class="w"> </span><span class="n">v0</span><span class="o">+</span><span class="mi">256</span>
<span class="o">@</span><span class="mi">0203</span><span class="w">                               </span><span class="n">v9</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="mh">0x2710</span>
<span class="o">@</span><span class="mi">0207</span><span class="w">                               </span><span class="n">v11</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">aligned</span><span class="w"> </span><span class="n">readonly</span><span class="w"> </span><span class="n">can_move</span><span class="w"> </span><span class="n">checked</span><span class="w"> </span><span class="n">v0</span><span class="o">+</span><span class="mi">56</span>

<span class="o">..</span><span class="p">.</span>

<span class="o">@</span><span class="mi">02</span><span class="n">d6</span><span class="w">                               </span><span class="n">v105</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">v11</span><span class="p">,</span><span class="w"> </span><span class="n">v4439</span>
</code></pre></div>
<p>This might increase the register pressure, causing more spills which can degrade the performance.</p>
</blockquote>



<a name="562487651"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312139%20Cranelift%3A%20ISLE%20mid-end%20performan.../near/562487651" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312139.20Cranelift.3A.20ISLE.20mid-end.20performan.2E.2E.2E.html#562487651">(Dec 08 2025 at 14:56)</a>:</h4>
<p><a href="https://github.com/alexcrichton">alexcrichton</a> added the cranelift label to <a href="https://github.com/bytecodealliance/wasmtime/issues/12139">Issue #12139</a>.</p>



<a name="562487652"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312139%20Cranelift%3A%20ISLE%20mid-end%20performan.../near/562487652" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312139.20Cranelift.3A.20ISLE.20mid-end.20performan.2E.2E.2E.html#562487652">(Dec 08 2025 at 14:56)</a>:</h4>
<p><a href="https://github.com/alexcrichton">alexcrichton</a> added the cranelift<span aria-label="goal" class="emoji emoji-1f945" role="img" title="goal">:goal:</span>optimize-speed label to <a href="https://github.com/bytecodealliance/wasmtime/issues/12139">Issue #12139</a>.</p>



<a name="562487655"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312139%20Cranelift%3A%20ISLE%20mid-end%20performan.../near/562487655" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312139.20Cranelift.3A.20ISLE.20mid-end.20performan.2E.2E.2E.html#562487655">(Dec 08 2025 at 14:56)</a>:</h4>
<p><a href="https://github.com/alexcrichton">alexcrichton</a> added the performance label to <a href="https://github.com/bytecodealliance/wasmtime/issues/12139">Issue #12139</a>.</p>



<a name="563452639"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312139%20Cranelift%3A%20ISLE%20mid-end%20performan.../near/563452639" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312139.20Cranelift.3A.20ISLE.20mid-end.20performan.2E.2E.2E.html#563452639">(Dec 12 2025 at 11:32)</a>:</h4>
<p>bongjunj <a href="https://github.com/bytecodealliance/wasmtime/issues/12139#issuecomment-3646112153">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12139">issue #12139</a>:</p>
<blockquote>
<p>Investigating the generated CLIF for <code>shootout-switch</code> case, I noticed there are <strong>over 2,500 unused constants</strong> in a block:<br>
<a href="https://gist.github.com/bongjunj/08cf48d4e5827cf8ed270f26442e2604#file-main-clif-L216-L240">https://gist.github.com/bongjunj/08cf48d4e5827cf8ed270f26442e2604#file-main-clif-L216-L240</a> .</p>
<p>The constants defined in the block are never referenced anywhere in the function.<br>
Is this a intended behavior for translating <code>switch</code>?</p>
<p>To repro this, run <code>wasmtime compile sightglass/benchmarks/shootout/shootut-switch.wasm --emit-clif &lt;dir&gt;</code> and look up the <code>shootout-switch/wasm\[0\]--function\[9\]--__original_main.clif</code> file.</p>
<p>cc @cfallin </p>
</blockquote>



<a name="563452753"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312139%20Cranelift%3A%20ISLE%20mid-end%20performan.../near/563452753" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312139.20Cranelift.3A.20ISLE.20mid-end.20performan.2E.2E.2E.html#563452753">(Dec 12 2025 at 11:32)</a>:</h4>
<p>bongjunj edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/12139#issuecomment-3646112153">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12139">issue #12139</a>:</p>
<blockquote>
<p>Investigating the generated CLIF for <code>shootout-switch</code> case, I noticed there are <strong>over 2,500 unused constants</strong> in a block:<br>
<a href="https://gist.github.com/bongjunj/08cf48d4e5827cf8ed270f26442e2604#file-main-clif-L216-L240">https://gist.github.com/bongjunj/08cf48d4e5827cf8ed270f26442e2604#file-main-clif-L216-L240</a> .<br>
For example, look up <code>v185</code> in the CLIF file. None are matched.</p>
<p>The constants defined in the block are never referenced anywhere in the function.<br>
Is this a intended behavior for translating <code>switch</code>?</p>
<p>To repro this, run <code>wasmtime compile sightglass/benchmarks/shootout/shootut-switch.wasm --emit-clif &lt;dir&gt;</code> and look up the <code>shootout-switch/wasm\[0\]--function\[9\]--__original_main.clif</code> file.</p>
<p>cc @cfallin </p>
</blockquote>



<a name="563457416"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312139%20Cranelift%3A%20ISLE%20mid-end%20performan.../near/563457416" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312139.20Cranelift.3A.20ISLE.20mid-end.20performan.2E.2E.2E.html#563457416">(Dec 12 2025 at 12:00)</a>:</h4>
<p>bongjunj edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/12139#issuecomment-3646112153">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12139">issue #12139</a>:</p>
<blockquote>
<p>Investigating the generated CLIF for <code>shootout-switch</code> case, I noticed there are <strong>over 2,500 unused constants</strong> in a block:<br>
<a href="https://gist.github.com/bongjunj/08cf48d4e5827cf8ed270f26442e2604#file-main-clif-L216-L240">https://gist.github.com/bongjunj/08cf48d4e5827cf8ed270f26442e2604#file-main-clif-L216-L240</a> .<br>
For example, look up <code>v185</code> in the CLIF file. None are matched.</p>
<p>This not only happens in the specified block, but also in another block too:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">                                </span><span class="n">block3</span><span class="p">:</span>
<span class="w">                                    </span><span class="nc">v4434</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="mi">16</span>
<span class="w">                                    </span><span class="n">v4435</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="n">v16</span><span class="p">,</span><span class="w"> </span><span class="n">v4434</span><span class="w">  </span><span class="p">;</span><span class="w"> </span><span class="n">v4434</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">16</span>
<span class="w">                                    </span><span class="n">v4436</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="mi">0</span>
<span class="o">@</span><span class="mi">0236</span><span class="w">                               </span><span class="n">v31</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="mi">7</span>
<span class="o">@</span><span class="mi">0231</span><span class="w">                               </span><span class="n">v28</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="mi">12</span>
<span class="o">@</span><span class="mi">0243</span><span class="w">                               </span><span class="n">v38</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="mi">6</span>
<span class="o">@</span><span class="mi">023</span><span class="n">e</span><span class="w">                               </span><span class="n">v36</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="mi">8</span>
<span class="o">@</span><span class="mi">0250</span><span class="w">                               </span><span class="n">v45</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="mi">5</span>
<span class="o">@</span><span class="mi">024</span><span class="n">b</span><span class="w">                               </span><span class="n">v43</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="mi">4</span>
<span class="o">@</span><span class="mi">0267</span><span class="w">                               </span><span class="n">v57</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="mi">3</span>
<span class="o">@</span><span class="mi">0262</span><span class="w">                               </span><span class="n">v55</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="o">-</span><span class="mi">4</span>
<span class="o">@</span><span class="mi">0274</span><span class="w">                               </span><span class="n">v64</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="mi">2</span>
<span class="o">@</span><span class="mi">026</span><span class="n">f</span><span class="w">                               </span><span class="n">v62</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="o">-</span><span class="mi">8</span>
<span class="o">@</span><span class="mi">0281</span><span class="w">                               </span><span class="n">v71</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="mi">1</span>
<span class="o">@</span><span class="mi">027</span><span class="n">c</span><span class="w">                               </span><span class="n">v69</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="o">-</span><span class="mi">12</span>
<span class="o">@</span><span class="mi">0289</span><span class="w">                               </span><span class="n">v76</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="o">-</span><span class="mi">16</span>
<span class="w">                                    </span><span class="n">v4409</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="mi">9992</span>
<span class="o">@</span><span class="mi">0293</span><span class="w">                               </span><span class="n">v81</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i32</span><span class="w"> </span><span class="mi">32</span>
<span class="o">@</span><span class="mi">022</span><span class="n">d</span><span class="w">                               </span><span class="n">jump</span><span class="w"> </span><span class="n">block4</span><span class="p">(</span><span class="n">v4435</span><span class="p">,</span><span class="w"> </span><span class="n">v4436</span><span class="p">)</span><span class="w">  </span><span class="p">;</span><span class="w"> </span><span class="n">v4436</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>

<span class="o">..</span><span class="p">.</span>

<span class="o">@</span><span class="mi">028</span><span class="n">e</span><span class="w">                               </span><span class="n">v78</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uextend</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">v4463</span>
<span class="o">@</span><span class="mi">028</span><span class="n">e</span><span class="w">                               </span><span class="n">v80</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iadd</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="n">v11</span><span class="p">,</span><span class="w"> </span><span class="n">v78</span>
<span class="o">@</span><span class="mi">028</span><span class="n">e</span><span class="w">                               </span><span class="n">store</span><span class="w"> </span><span class="n">little</span><span class="w"> </span><span class="n">heap</span><span class="w"> </span><span class="n">v30</span><span class="p">,</span><span class="w"> </span><span class="n">v80</span>
<span class="w">                                    </span><span class="n">v4413</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">icmp</span><span class="w"> </span><span class="n">ne</span><span class="w"> </span><span class="n">v30</span><span class="p">,</span><span class="w"> </span><span class="n">v4409</span><span class="w">  </span><span class="p">;</span><span class="w"> </span><span class="n">v4409</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">9992</span>
</code></pre></div>
<p>Surprisingly, none of the constants from <code>v31</code> to <code>v76</code> in the block are used anywhere in the function.<br>
The constants defined in the block are never referenced anywhere in the function.<br>
Is this a intended behavior for translating <code>switch</code>?</p>
<p>Furthermore, the constant <code>v4409</code> that is newly generated as a result of optimization is not placed close enough to its usage <code>v4413</code>. I see no valid reason to instantiate such constant distant from its only usage.</p>
<p>To repro this, run <code>wasmtime compile sightglass/benchmarks/shootout/shootut-switch.wasm --emit-clif &lt;dir&gt;</code> and look up the <code>shootout-switch/wasm\[0\]--function\[9\]--__original_main.clif</code> file.</p>
<p>cc @cfallin </p>
</blockquote>



<a name="563671830"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312139%20Cranelift%3A%20ISLE%20mid-end%20performan.../near/563671830" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312139.20Cranelift.3A.20ISLE.20mid-end.20performan.2E.2E.2E.html#563671830">(Dec 14 2025 at 08:06)</a>:</h4>
<p>bongjunj <a href="https://github.com/bytecodealliance/wasmtime/issues/12139#issuecomment-3650453592">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12139">issue #12139</a>:</p>
<blockquote>
<h2>Performance-regressing rules</h2>
<p>Removing the following rules, I observed the performance regression can be fixed.<br>
The performance gaps between the no-opt version (NO) and the latest version (Base) of Cranelift are -9.20% and zero before and after this removal.</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/ab030780b67ce79c8567cd245353a0e7f1e05d27/cranelift/codegen/src/opts/cprop.isle#L196-L211">https://github.com/bytecodealliance/wasmtime/blob/ab030780b67ce79c8567cd245353a0e7f1e05d27/cranelift/codegen/src/opts/cprop.isle#L196-L211</a></p>
<p>(1) Removing these, the gap between NO and Base is -6.97%.</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/ab030780b67ce79c8567cd245353a0e7f1e05d27/cranelift/codegen/src/opts/cprop.isle#L97-L102">https://github.com/bytecodealliance/wasmtime/blob/ab030780b67ce79c8567cd245353a0e7f1e05d27/cranelift/codegen/src/opts/cprop.isle#L97-L102</a></p>
<p>(2) Further removing these, the gap between NO and Base is -1.37%.</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/ab030780b67ce79c8567cd245353a0e7f1e05d27/cranelift/codegen/src/opts/arithmetic.isle#L241">https://github.com/bytecodealliance/wasmtime/blob/ab030780b67ce79c8567cd245353a0e7f1e05d27/cranelift/codegen/src/opts/arithmetic.isle#L241</a></p>
<p>(3) Further removing these, the gap between NO and Base is zero.</p>
<h2>Analysis</h2>
<p>The rules in (1) interferes the loop backedge.<br>
Let's take a detailed look on the generated IR and x86 machine code.</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="w"> </span>                                block4(v27: i32, v30: i32):
<span class="gd">-                                    v4432 = iadd v30, v4411  ; v4411 = 8</span>
<span class="gd">-                                    v4433 = iconst.i32 0x2710</span>
<span class="gd">-                                    v4434 = icmp ne v4432, v4433  ; v4433 = 0x2710</span>
<span class="gd">-@02a3                               v87 = uextend.i32 v4434</span>
<span class="gd">-                                    v4435 = iconst.i32 32</span>
<span class="gd">-                                    v4436 = iadd v27, v4435  ; v4435 = 32</span>
<span class="gd">-@02a4                               brif v87, block4(v4436, v4432), block6</span>
<span class="gi">+                                    v4413 = icmp ne v30, v4409  ; v4409 = 9992</span>
<span class="gi">+@02a3                               v87 = uextend.i32 v4413</span>
<span class="gi">+                                    v4464 = iconst.i32 32</span>
<span class="gi">+                                    v4465 = iadd v27, v4464  ; v4464 = 32</span>
<span class="gi">+                                    v4466 = iadd v30, v4443  ; v4443 = 8</span>
<span class="gi">+@02a4                               brif v87, block4(v4465, v4466), block6</span>
</code></pre></div>
<p>The IR transformation can be simplified into:</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gd">- a &lt;- x + 8</span>
<span class="gd">- c &lt;- a != 10,000 (0x2710)</span>
<span class="gd">- d &lt;- y + 32</span>
<span class="gd">- br_if c, block4(d, a), block6</span>
<span class="gi">+ c &lt;- x != 9,992</span>
<span class="gi">+ d &lt;- y + 32</span>
<span class="gi">+ a &lt;- x + 8</span>
<span class="gi">+ br_if c, block4(d, a), block6</span>
</code></pre></div>
<p>This degraded the quality of generated machine code. Although the comparison is simplified, the addition is now two-phase (compute and commit) and there are now two jumps.</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gd">- add    r8d,0x8</span>
<span class="gd">- add    ecx,0x20</span>
<span class="gd">- cmp    r8d,0x2710</span>
<span class="gd">- jne    fd &lt;__original_main+0x7d&gt;</span>
<span class="gi">+ add    ecx,0x20</span>
<span class="gi">+ lea    r11d,[r8+0x8]        ; r11d = x + 8 (compute next)</span>
<span class="gi">+ cmp    r8d,0x2708           ; compare *old* x to 9992</span>
<span class="gi">+ je     181 &lt;__original_main+0x101&gt;</span>
<span class="gi">+ mov    r8,r11               ; commit x = x + 8</span>
<span class="gi">+jmp    102 &lt;__original_main+0x82&gt;</span>
</code></pre></div>
<p>I couldn't decide to fix the mid-end or code-gen at the moment.</p>
</blockquote>



<a name="563672073"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312139%20Cranelift%3A%20ISLE%20mid-end%20performan.../near/563672073" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312139.20Cranelift.3A.20ISLE.20mid-end.20performan.2E.2E.2E.html#563672073">(Dec 14 2025 at 08:13)</a>:</h4>
<p>bongjunj edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/12139#issuecomment-3650453592">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12139">issue #12139</a>:</p>
<blockquote>
<h2>Performance-regressing rules</h2>
<p>Removing the following rules, I observed the performance regression can be fixed.<br>
The performance gaps between the no-opt version (NO) and the latest version (Base) of Cranelift are -9.20% and zero before and after this removal.</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/ab030780b67ce79c8567cd245353a0e7f1e05d27/cranelift/codegen/src/opts/cprop.isle#L196-L211">https://github.com/bytecodealliance/wasmtime/blob/ab030780b67ce79c8567cd245353a0e7f1e05d27/cranelift/codegen/src/opts/cprop.isle#L196-L211</a></p>
<p>(1) Removing these, the gap between NO and Base was -6.97%.</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/ab030780b67ce79c8567cd245353a0e7f1e05d27/cranelift/codegen/src/opts/cprop.isle#L97-L102">https://github.com/bytecodealliance/wasmtime/blob/ab030780b67ce79c8567cd245353a0e7f1e05d27/cranelift/codegen/src/opts/cprop.isle#L97-L102</a></p>
<p>(2) Further removing these, the gap between NO and Base was -1.37%.</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/ab030780b67ce79c8567cd245353a0e7f1e05d27/cranelift/codegen/src/opts/arithmetic.isle#L241">https://github.com/bytecodealliance/wasmtime/blob/ab030780b67ce79c8567cd245353a0e7f1e05d27/cranelift/codegen/src/opts/arithmetic.isle#L241</a></p>
<p>(3) Further removing these, the gap between NO and Base was zero.</p>
<h2>Analysis</h2>
<p>The rules in (1) interferes the loop backedge.<br>
Let's take a detailed look on the generated IR and x86 machine code.</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="w"> </span>                                block4(v27: i32, v30: i32):
<span class="gd">-                                    v4432 = iadd v30, v4411  ; v4411 = 8</span>
<span class="gd">-                                    v4433 = iconst.i32 0x2710</span>
<span class="gd">-                                    v4434 = icmp ne v4432, v4433  ; v4433 = 0x2710</span>
<span class="gd">-@02a3                               v87 = uextend.i32 v4434</span>
<span class="gd">-                                    v4435 = iconst.i32 32</span>
<span class="gd">-                                    v4436 = iadd v27, v4435  ; v4435 = 32</span>
<span class="gd">-@02a4                               brif v87, block4(v4436, v4432), block6</span>
<span class="gi">+                                    v4413 = icmp ne v30, v4409  ; v4409 = 9992</span>
<span class="gi">+@02a3                               v87 = uextend.i32 v4413</span>
<span class="gi">+                                    v4464 = iconst.i32 32</span>
<span class="gi">+                                    v4465 = iadd v27, v4464  ; v4464 = 32</span>
<span class="gi">+                                    v4466 = iadd v30, v4443  ; v4443 = 8</span>
<span class="gi">+@02a4                               brif v87, block4(v4465, v4466), block6</span>
</code></pre></div>
<p>The IR transformation can be simplified into:</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gd">- a &lt;- x + 8</span>
<span class="gd">- c &lt;- a != 10,000 (0x2710)</span>
<span class="gd">- d &lt;- y + 32</span>
<span class="gd">- br_if c, block4(d, a), block6</span>
<span class="gi">+ c &lt;- x != 9,992</span>
<span class="gi">+ d &lt;- y + 32</span>
<span class="gi">+ a &lt;- x + 8</span>
<span class="gi">+ br_if c, block4(d, a), block6</span>
</code></pre></div>
<p>This degraded the quality of generated machine code. Although the comparison is simplified, the addition is now two-phase (compute and commit) and there are now two jumps.</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gd">- add    r8d,0x8</span>
<span class="gd">- add    ecx,0x20</span>
<span class="gd">- cmp    r8d,0x2710</span>
<span class="gd">- jne    fd &lt;__original_main+0x7d&gt;</span>
<span class="gi">+ add    ecx,0x20</span>
<span class="gi">+ lea    r11d,[r8+0x8]        ; r11d = x + 8 (compute next)</span>
<span class="gi">+ cmp    r8d,0x2708           ; compare *old* x to 9992</span>
<span class="gi">+ je     181 &lt;__original_main+0x101&gt;</span>
<span class="gi">+ mov    r8,r11               ; commit x = x + 8</span>
<span class="gi">+jmp    102 &lt;__original_main+0x82&gt;</span>
</code></pre></div>
<p>I couldn't decide to fix the mid-end or code-gen at the moment.</p>
</blockquote>



<a name="563672104"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312139%20Cranelift%3A%20ISLE%20mid-end%20performan.../near/563672104" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312139.20Cranelift.3A.20ISLE.20mid-end.20performan.2E.2E.2E.html#563672104">(Dec 14 2025 at 08:14)</a>:</h4>
<p>bongjunj edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/12139#issuecomment-3650453592">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12139">issue #12139</a>:</p>
<blockquote>
<h2>Performance-regressing rules</h2>
<p>Removing the following rules, I observed the performance regression can be fixed.<br>
The performance gaps between the no-opt version (NO) and the latest version (Base) of Cranelift are -9.20% and zero before and after this removal.</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/ab030780b67ce79c8567cd245353a0e7f1e05d27/cranelift/codegen/src/opts/cprop.isle#L196-L211">https://github.com/bytecodealliance/wasmtime/blob/ab030780b67ce79c8567cd245353a0e7f1e05d27/cranelift/codegen/src/opts/cprop.isle#L196-L211</a></p>
<p>(1) Removing these, the gap between NO and Base was -6.97%.</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/ab030780b67ce79c8567cd245353a0e7f1e05d27/cranelift/codegen/src/opts/cprop.isle#L97-L102">https://github.com/bytecodealliance/wasmtime/blob/ab030780b67ce79c8567cd245353a0e7f1e05d27/cranelift/codegen/src/opts/cprop.isle#L97-L102</a></p>
<p>(2) Further removing these, the gap between NO and Base was -1.37%.</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/ab030780b67ce79c8567cd245353a0e7f1e05d27/cranelift/codegen/src/opts/arithmetic.isle#L241">https://github.com/bytecodealliance/wasmtime/blob/ab030780b67ce79c8567cd245353a0e7f1e05d27/cranelift/codegen/src/opts/arithmetic.isle#L241</a></p>
<p>(3) Further removing these, the gap between NO and Base was zero.</p>
<h2>Analysis</h2>
<p>My theory is that the rules in (1) interferes the loop back-edge.<br>
Let's take a detailed look on the generated IR and x86 machine code.</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="w"> </span>                                block4(v27: i32, v30: i32):
<span class="gd">-                                    v4432 = iadd v30, v4411  ; v4411 = 8</span>
<span class="gd">-                                    v4433 = iconst.i32 0x2710</span>
<span class="gd">-                                    v4434 = icmp ne v4432, v4433  ; v4433 = 0x2710</span>
<span class="gd">-@02a3                               v87 = uextend.i32 v4434</span>
<span class="gd">-                                    v4435 = iconst.i32 32</span>
<span class="gd">-                                    v4436 = iadd v27, v4435  ; v4435 = 32</span>
<span class="gd">-@02a4                               brif v87, block4(v4436, v4432), block6</span>
<span class="gi">+                                    v4413 = icmp ne v30, v4409  ; v4409 = 9992</span>
<span class="gi">+@02a3                               v87 = uextend.i32 v4413</span>
<span class="gi">+                                    v4464 = iconst.i32 32</span>
<span class="gi">+                                    v4465 = iadd v27, v4464  ; v4464 = 32</span>
<span class="gi">+                                    v4466 = iadd v30, v4443  ; v4443 = 8</span>
<span class="gi">+@02a4                               brif v87, block4(v4465, v4466), block6</span>
</code></pre></div>
<p>The IR transformation can be simplified into:</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gd">- a &lt;- x + 8</span>
<span class="gd">- c &lt;- a != 10,000 (0x2710)</span>
<span class="gd">- d &lt;- y + 32</span>
<span class="gd">- br_if c, block4(d, a), block6</span>
<span class="gi">+ c &lt;- x != 9,992</span>
<span class="gi">+ d &lt;- y + 32</span>
<span class="gi">+ a &lt;- x + 8</span>
<span class="gi">+ br_if c, block4(d, a), block6</span>
</code></pre></div>
<p>This degraded the quality of generated machine code. Although the comparison is simplified, the addition is now two-phase (compute and commit) and there are now two jumps.</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gd">- add    r8d,0x8</span>
<span class="gd">- add    ecx,0x20</span>
<span class="gd">- cmp    r8d,0x2710</span>
<span class="gd">- jne    fd &lt;__original_main+0x7d&gt;</span>
<span class="gi">+ add    ecx,0x20</span>
<span class="gi">+ lea    r11d,[r8+0x8]        ; r11d = x + 8 (compute next)</span>
<span class="gi">+ cmp    r8d,0x2708           ; compare *old* x to 9992</span>
<span class="gi">+ je     181 &lt;__original_main+0x101&gt;</span>
<span class="gi">+ mov    r8,r11               ; commit x = x + 8</span>
<span class="gi">+jmp    102 &lt;__original_main+0x82&gt;</span>
</code></pre></div>
<p>I couldn't decide to fix the mid-end or code-gen at the moment.</p>
</blockquote>



<a name="563672543"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312139%20Cranelift%3A%20ISLE%20mid-end%20performan.../near/563672543" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312139.20Cranelift.3A.20ISLE.20mid-end.20performan.2E.2E.2E.html#563672543">(Dec 14 2025 at 08:26)</a>:</h4>
<p>bongjunj edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/12139#issuecomment-3650453592">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12139">issue #12139</a>:</p>
<blockquote>
<h2>Performance-regressing rules</h2>
<p>Removing the following rules, I observed the performance regression can be fixed.<br>
The performance gaps in execution time between the no-opt version (NO) and the latest version (Base) of Cranelift are -9.20% and zero before and after this removal.</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/ab030780b67ce79c8567cd245353a0e7f1e05d27/cranelift/codegen/src/opts/cprop.isle#L196-L211">https://github.com/bytecodealliance/wasmtime/blob/ab030780b67ce79c8567cd245353a0e7f1e05d27/cranelift/codegen/src/opts/cprop.isle#L196-L211</a></p>
<p>(1) Removing these, the gap between NO and Base was -6.97%.</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/ab030780b67ce79c8567cd245353a0e7f1e05d27/cranelift/codegen/src/opts/cprop.isle#L97-L102">https://github.com/bytecodealliance/wasmtime/blob/ab030780b67ce79c8567cd245353a0e7f1e05d27/cranelift/codegen/src/opts/cprop.isle#L97-L102</a></p>
<p>(2) Further removing these, the gap between NO and Base was -1.37%.</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/ab030780b67ce79c8567cd245353a0e7f1e05d27/cranelift/codegen/src/opts/arithmetic.isle#L241">https://github.com/bytecodealliance/wasmtime/blob/ab030780b67ce79c8567cd245353a0e7f1e05d27/cranelift/codegen/src/opts/arithmetic.isle#L241</a></p>
<p>(3) Further removing these, the gap between NO and Base was zero.</p>
<h2>Analysis 1</h2>
<p>My theory is that the rules in (1) interferes the loop back-edge.<br>
Let's take a detailed look on the generated IR and x86 machine code.</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="w"> </span>                                block4(v27: i32, v30: i32):
<span class="gd">-                                    v4432 = iadd v30, v4411  ; v4411 = 8</span>
<span class="gd">-                                    v4433 = iconst.i32 0x2710</span>
<span class="gd">-                                    v4434 = icmp ne v4432, v4433  ; v4433 = 0x2710</span>
<span class="gd">-@02a3                               v87 = uextend.i32 v4434</span>
<span class="gd">-                                    v4435 = iconst.i32 32</span>
<span class="gd">-                                    v4436 = iadd v27, v4435  ; v4435 = 32</span>
<span class="gd">-@02a4                               brif v87, block4(v4436, v4432), block6</span>
<span class="gi">+                                    v4413 = icmp ne v30, v4409  ; v4409 = 9992</span>
<span class="gi">+@02a3                               v87 = uextend.i32 v4413</span>
<span class="gi">+                                    v4464 = iconst.i32 32</span>
<span class="gi">+                                    v4465 = iadd v27, v4464  ; v4464 = 32</span>
<span class="gi">+                                    v4466 = iadd v30, v4443  ; v4443 = 8</span>
<span class="gi">+@02a4                               brif v87, block4(v4465, v4466), block6</span>
</code></pre></div>
<p>The IR transformation can be simplified into:</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gd">- a &lt;- x + 8</span>
<span class="gd">- c &lt;- a != 10,000 (0x2710)</span>
<span class="gd">- d &lt;- y + 32</span>
<span class="gd">- br_if c, block4(d, a), block6</span>
<span class="gi">+ c &lt;- x != 9,992</span>
<span class="gi">+ d &lt;- y + 32</span>
<span class="gi">+ a &lt;- x + 8</span>
<span class="gi">+ br_if c, block4(d, a), block6</span>
</code></pre></div>
<p>This degraded the quality of generated machine code. Although the comparison is simplified, the addition is now two-phase (compute and commit) and there are now two jumps.</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gd">- add    r8d,0x8</span>
<span class="gd">- add    ecx,0x20</span>
<span class="gd">- cmp    r8d,0x2710</span>
<span class="gd">- jne    fd &lt;__original_main+0x7d&gt;</span>
<span class="gi">+ add    ecx,0x20</span>
<span class="gi">+ lea    r11d,[r8+0x8]        ; r11d = x + 8 (compute next)</span>
<span class="gi">+ cmp    r8d,0x2708           ; compare *old* x to 9992</span>
<span class="gi">+ je     181 &lt;__original_main+0x101&gt;</span>
<span class="gi">+ mov    r8,r11               ; commit x = x + 8</span>
<span class="gi">+jmp    102 &lt;__original_main+0x82&gt;</span>
</code></pre></div>
<h2>Analysis 2</h2>
<p>The rules in (2) and (3) are then now interesting. How did they "cure" the performance problem?<br>
In fact, the rules in (3) can interact with these rules in <code>icmp.isle</code>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="n">k</span><span class="p">)))</span><span class="w"> </span><span class="p">(</span><span class="n">subsume</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)))</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="n">b</span><span class="p">)))</span><span class="w"> </span><span class="p">(</span><span class="n">subsume</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)))</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="n">k</span><span class="p">)))</span><span class="w"> </span><span class="p">(</span><span class="n">subsume</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)))</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="n">b</span><span class="p">)))</span><span class="w"> </span><span class="p">(</span><span class="n">subsume</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)))</span>
</code></pre></div>
<p>Then, similar to Analysis 1, it can cause same problem in generating jump instructions.</p>
<h2>Conclusion</h2>
<ul>
<li>I don't have a theory how the removed rules in (2) increased the performance, yet.</li>
<li>I couldn't decide where to fix: the mid-end or code-gen? The mid-end rules definitely made the code-gen worse, but those rules "looks fine". They just make sense, decreasing the number of IR instructions.</li>
</ul>
</blockquote>



<a name="563672585"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312139%20Cranelift%3A%20ISLE%20mid-end%20performan.../near/563672585" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312139.20Cranelift.3A.20ISLE.20mid-end.20performan.2E.2E.2E.html#563672585">(Dec 14 2025 at 08:27)</a>:</h4>
<p>bongjunj edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/12139#issuecomment-3650453592">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12139">issue #12139</a>:</p>
<blockquote>
<h2>Performance-regressing rules</h2>
<p>Removing the following rules, I observed the performance regression can be fixed.<br>
The performance gaps in execution time between the no-opt version (NO) and the latest version (Base) of Cranelift are -9.20% and zero before and after this removal.</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/ab030780b67ce79c8567cd245353a0e7f1e05d27/cranelift/codegen/src/opts/cprop.isle#L196-L211">https://github.com/bytecodealliance/wasmtime/blob/ab030780b67ce79c8567cd245353a0e7f1e05d27/cranelift/codegen/src/opts/cprop.isle#L196-L211</a></p>
<p>(1) Removing these, the gap between NO and Base was -6.97%.</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/ab030780b67ce79c8567cd245353a0e7f1e05d27/cranelift/codegen/src/opts/cprop.isle#L97-L102">https://github.com/bytecodealliance/wasmtime/blob/ab030780b67ce79c8567cd245353a0e7f1e05d27/cranelift/codegen/src/opts/cprop.isle#L97-L102</a></p>
<p>(2) Further removing these, the gap between NO and Base was -1.37%.</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/ab030780b67ce79c8567cd245353a0e7f1e05d27/cranelift/codegen/src/opts/arithmetic.isle#L241">https://github.com/bytecodealliance/wasmtime/blob/ab030780b67ce79c8567cd245353a0e7f1e05d27/cranelift/codegen/src/opts/arithmetic.isle#L241</a></p>
<p>(3) Further removing these, the gap between NO and Base was zero.</p>
<h2>Analysis 1</h2>
<p>My theory is that the rules in (1) interferes the loop back-edge.<br>
Let's take a detailed look on the generated IR and x86 machine code.</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="w"> </span>                                block4(v27: i32, v30: i32):
<span class="gd">-                                    v4432 = iadd v30, v4411  ; v4411 = 8</span>
<span class="gd">-                                    v4433 = iconst.i32 0x2710</span>
<span class="gd">-                                    v4434 = icmp ne v4432, v4433  ; v4433 = 0x2710</span>
<span class="gd">-@02a3                               v87 = uextend.i32 v4434</span>
<span class="gd">-                                    v4435 = iconst.i32 32</span>
<span class="gd">-                                    v4436 = iadd v27, v4435  ; v4435 = 32</span>
<span class="gd">-@02a4                               brif v87, block4(v4436, v4432), block6</span>
<span class="gi">+                                    v4413 = icmp ne v30, v4409  ; v4409 = 9992</span>
<span class="gi">+@02a3                               v87 = uextend.i32 v4413</span>
<span class="gi">+                                    v4464 = iconst.i32 32</span>
<span class="gi">+                                    v4465 = iadd v27, v4464  ; v4464 = 32</span>
<span class="gi">+                                    v4466 = iadd v30, v4443  ; v4443 = 8</span>
<span class="gi">+@02a4                               brif v87, block4(v4465, v4466), block6</span>
</code></pre></div>
<p>The IR transformation can be simplified into:</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gd">- a &lt;- x + 8</span>
<span class="gd">- c &lt;- a != 10,000 (0x2710)</span>
<span class="gd">- d &lt;- y + 32</span>
<span class="gd">- br_if c, block4(d, a), block6</span>
<span class="gi">+ c &lt;- x != 9,992</span>
<span class="gi">+ d &lt;- y + 32</span>
<span class="gi">+ a &lt;- x + 8</span>
<span class="gi">+ br_if c, block4(d, a), block6</span>
</code></pre></div>
<p>This degraded the quality of generated machine code. Although the comparison is simplified, the addition is now two-phase (compute and commit) and there are now two jumps.</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gd">- add    r8d,0x8</span>
<span class="gd">- add    ecx,0x20</span>
<span class="gd">- cmp    r8d,0x2710</span>
<span class="gd">- jne    fd &lt;__original_main+0x7d&gt;</span>
<span class="gi">+ add    ecx,0x20</span>
<span class="gi">+ lea    r11d,[r8+0x8]        ; r11d = x + 8 (compute next)</span>
<span class="gi">+ cmp    r8d,0x2708           ; compare *old* x to 9992</span>
<span class="gi">+ je     181 &lt;__original_main+0x101&gt;</span>
<span class="gi">+ mov    r8,r11               ; commit x = x + 8</span>
<span class="gi">+jmp    102 &lt;__original_main+0x82&gt;</span>
</code></pre></div>
<h2>Analysis 2</h2>
<p>The rules in (2) and (3) are then now interesting. How did they "cure" the performance problem?<br>
In fact, the rules in (3) can interact with these rules in <code>icmp.isle</code>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="n">k</span><span class="p">)))</span><span class="w"> </span><span class="p">(</span><span class="n">subsume</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)))</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="n">b</span><span class="p">)))</span><span class="w"> </span><span class="p">(</span><span class="n">subsume</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)))</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="n">k</span><span class="p">)))</span><span class="w"> </span><span class="p">(</span><span class="n">subsume</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)))</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="n">b</span><span class="p">)))</span><span class="w"> </span><span class="p">(</span><span class="n">subsume</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)))</span>
</code></pre></div>
<p>Then, similar to Analysis 1, it can cause the same problem in generating jump instructions.</p>
<h2>Conclusion</h2>
<ul>
<li>I don't have a theory how the removed rules in (2) increased the performance, yet.</li>
<li>I couldn't decide where to fix: the mid-end or code-gen? The mid-end rules definitely made the code-gen worse, but those rules "looks fine". They just make sense, decreasing the number of IR instructions.<br>
</li>
</ul>
</blockquote>



<a name="563672665"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312139%20Cranelift%3A%20ISLE%20mid-end%20performan.../near/563672665" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312139.20Cranelift.3A.20ISLE.20mid-end.20performan.2E.2E.2E.html#563672665">(Dec 14 2025 at 08:29)</a>:</h4>
<p>bongjunj edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/12139#issuecomment-3650453592">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12139">issue #12139</a>:</p>
<blockquote>
<h2>Performance-regressing rules</h2>
<p>Removing the following rules, I observed the performance regression can be fixed.<br>
The performance gaps in execution time between the no-opt version (NO) and the latest version (Base) of Cranelift are -9.20% and zero before and after this removal.</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/ab030780b67ce79c8567cd245353a0e7f1e05d27/cranelift/codegen/src/opts/cprop.isle#L196-L211">https://github.com/bytecodealliance/wasmtime/blob/ab030780b67ce79c8567cd245353a0e7f1e05d27/cranelift/codegen/src/opts/cprop.isle#L196-L211</a></p>
<p>(1) Removing these, the gap between NO and Base was -6.97%.</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/ab030780b67ce79c8567cd245353a0e7f1e05d27/cranelift/codegen/src/opts/cprop.isle#L97-L102">https://github.com/bytecodealliance/wasmtime/blob/ab030780b67ce79c8567cd245353a0e7f1e05d27/cranelift/codegen/src/opts/cprop.isle#L97-L102</a></p>
<p>(2) Further removing these, the gap between NO and Base was -1.37%.</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/ab030780b67ce79c8567cd245353a0e7f1e05d27/cranelift/codegen/src/opts/arithmetic.isle#L241">https://github.com/bytecodealliance/wasmtime/blob/ab030780b67ce79c8567cd245353a0e7f1e05d27/cranelift/codegen/src/opts/arithmetic.isle#L241</a></p>
<p>(3) Further removing these, the gap between NO and Base was zero.</p>
<h2>Analysis 1</h2>
<p>My theory is that the rules in (1) interferes the loop back-edge.<br>
Let's take a detailed look on the generated IR and x86 machine code.</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="w"> </span>                                block4(v27: i32, v30: i32):
<span class="gd">-                                    v4432 = iadd v30, v4411  ; v4411 = 8</span>
<span class="gd">-                                    v4433 = iconst.i32 0x2710</span>
<span class="gd">-                                    v4434 = icmp ne v4432, v4433  ; v4433 = 0x2710</span>
<span class="gd">-@02a3                               v87 = uextend.i32 v4434</span>
<span class="gd">-                                    v4435 = iconst.i32 32</span>
<span class="gd">-                                    v4436 = iadd v27, v4435  ; v4435 = 32</span>
<span class="gd">-@02a4                               brif v87, block4(v4436, v4432), block6</span>
<span class="gi">+                                    v4413 = icmp ne v30, v4409  ; v4409 = 9992</span>
<span class="gi">+@02a3                               v87 = uextend.i32 v4413</span>
<span class="gi">+                                    v4464 = iconst.i32 32</span>
<span class="gi">+                                    v4465 = iadd v27, v4464  ; v4464 = 32</span>
<span class="gi">+                                    v4466 = iadd v30, v4443  ; v4443 = 8</span>
<span class="gi">+@02a4                               brif v87, block4(v4465, v4466), block6</span>
</code></pre></div>
<p>The IR transformation can be simplified into:</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gd">- a &lt;- x + 8</span>
<span class="gd">- c &lt;- a != 10,000 (0x2710)</span>
<span class="gd">- d &lt;- y + 32</span>
<span class="gd">- br_if c, block4(d, a), block6</span>
<span class="gi">+ c &lt;- x != 9,992</span>
<span class="gi">+ d &lt;- y + 32</span>
<span class="gi">+ a &lt;- x + 8</span>
<span class="gi">+ br_if c, block4(d, a), block6</span>
</code></pre></div>
<p>This degraded the quality of generated machine code. Although the comparison is simplified, the addition is now two-phase (compute and commit) and there are now two jumps.</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gd">- add    r8d,0x8</span>
<span class="gd">- add    ecx,0x20</span>
<span class="gd">- cmp    r8d,0x2710</span>
<span class="gd">- jne    fd &lt;__original_main+0x7d&gt;</span>
<span class="gi">+ add    ecx,0x20</span>
<span class="gi">+ lea    r11d,[r8+0x8]        ; r11d = x + 8 (compute next)</span>
<span class="gi">+ cmp    r8d,0x2708           ; compare *old* x to 9992</span>
<span class="gi">+ je     181 &lt;__original_main+0x101&gt;</span>
<span class="gi">+ mov    r8,r11               ; commit x = x + 8</span>
<span class="gi">+jmp    102 &lt;__original_main+0x82&gt;</span>
</code></pre></div>
<h2>Analysis 2</h2>
<p>The rules in (2) and (3) are then now interesting. How did they "cure" the performance problem?<br>
In fact, the rules in (3) can interact with these rules in <code>icmp.isle</code>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="n">k</span><span class="p">)))</span><span class="w"> </span><span class="p">(</span><span class="n">subsume</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)))</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="n">b</span><span class="p">)))</span><span class="w"> </span><span class="p">(</span><span class="n">subsume</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)))</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="n">k</span><span class="p">)))</span><span class="w"> </span><span class="p">(</span><span class="n">subsume</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)))</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="n">b</span><span class="p">)))</span><span class="w"> </span><span class="p">(</span><span class="n">subsume</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)))</span>
</code></pre></div>
<p>Then, similar to Analysis 1, it can cause the same problem in generating jump instructions.</p>
<h2>Conclusion</h2>
<ul>
<li>I don't have a theory how the removed rules in (2) increased the performance, yet.</li>
<li>I couldn't decide where to fix: the mid-end or code-gen? The mid-end rules definitely made the code-gen worse, but those rules "looks fine". They just make sense, decreasing the number of IR instructions. Probably we should be more careful when it comes to "jumping" instructions, assuming there would be a reason for the way in which the wasm assembly is produced.<br>
</li>
</ul>
</blockquote>



<a name="563686448"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312139%20Cranelift%3A%20ISLE%20mid-end%20performan.../near/563686448" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312139.20Cranelift.3A.20ISLE.20mid-end.20performan.2E.2E.2E.html#563686448">(Dec 14 2025 at 12:32)</a>:</h4>
<p>bongjunj edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/12139#issuecomment-3650453592">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12139">issue #12139</a>:</p>
<blockquote>
<h1><code>shootout-switch</code></h1>
<h2>Performance-regressing rules</h2>
<p>Removing the following rules, I observed the performance regression can be fixed.<br>
The performance gaps in execution time between the no-opt version (NO) and the latest version (Base) of Cranelift are -9.20% and zero before and after this removal.</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/ab030780b67ce79c8567cd245353a0e7f1e05d27/cranelift/codegen/src/opts/cprop.isle#L196-L211">https://github.com/bytecodealliance/wasmtime/blob/ab030780b67ce79c8567cd245353a0e7f1e05d27/cranelift/codegen/src/opts/cprop.isle#L196-L211</a></p>
<p>(1) Removing these, the gap between NO and Base was -6.97%.</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/ab030780b67ce79c8567cd245353a0e7f1e05d27/cranelift/codegen/src/opts/cprop.isle#L97-L102">https://github.com/bytecodealliance/wasmtime/blob/ab030780b67ce79c8567cd245353a0e7f1e05d27/cranelift/codegen/src/opts/cprop.isle#L97-L102</a></p>
<p>(2) Further removing these, the gap between NO and Base was -1.37%.</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/ab030780b67ce79c8567cd245353a0e7f1e05d27/cranelift/codegen/src/opts/arithmetic.isle#L241">https://github.com/bytecodealliance/wasmtime/blob/ab030780b67ce79c8567cd245353a0e7f1e05d27/cranelift/codegen/src/opts/arithmetic.isle#L241</a></p>
<p>(3) Further removing these, the gap between NO and Base was zero.</p>
<h2>Analysis 1</h2>
<p>My theory is that the rules in (1) interferes the loop back-edge.<br>
Let's take a detailed look on the generated IR and x86 machine code.</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="w"> </span>                                block4(v27: i32, v30: i32):
<span class="gd">-                                    v4432 = iadd v30, v4411  ; v4411 = 8</span>
<span class="gd">-                                    v4433 = iconst.i32 0x2710</span>
<span class="gd">-                                    v4434 = icmp ne v4432, v4433  ; v4433 = 0x2710</span>
<span class="gd">-@02a3                               v87 = uextend.i32 v4434</span>
<span class="gd">-                                    v4435 = iconst.i32 32</span>
<span class="gd">-                                    v4436 = iadd v27, v4435  ; v4435 = 32</span>
<span class="gd">-@02a4                               brif v87, block4(v4436, v4432), block6</span>
<span class="gi">+                                    v4413 = icmp ne v30, v4409  ; v4409 = 9992</span>
<span class="gi">+@02a3                               v87 = uextend.i32 v4413</span>
<span class="gi">+                                    v4464 = iconst.i32 32</span>
<span class="gi">+                                    v4465 = iadd v27, v4464  ; v4464 = 32</span>
<span class="gi">+                                    v4466 = iadd v30, v4443  ; v4443 = 8</span>
<span class="gi">+@02a4                               brif v87, block4(v4465, v4466), block6</span>
</code></pre></div>
<p>The IR transformation can be simplified into:</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gd">- a &lt;- x + 8</span>
<span class="gd">- c &lt;- a != 10,000 (0x2710)</span>
<span class="gd">- d &lt;- y + 32</span>
<span class="gd">- br_if c, block4(d, a), block6</span>
<span class="gi">+ c &lt;- x != 9,992</span>
<span class="gi">+ d &lt;- y + 32</span>
<span class="gi">+ a &lt;- x + 8</span>
<span class="gi">+ br_if c, block4(d, a), block6</span>
</code></pre></div>
<p>This degraded the quality of generated machine code. Although the comparison is simplified, the addition is now two-phase (compute and commit) and there are now two jumps.</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gd">- add    r8d,0x8</span>
<span class="gd">- add    ecx,0x20</span>
<span class="gd">- cmp    r8d,0x2710</span>
<span class="gd">- jne    fd &lt;__original_main+0x7d&gt;</span>
<span class="gi">+ add    ecx,0x20</span>
<span class="gi">+ lea    r11d,[r8+0x8]        ; r11d = x + 8 (compute next)</span>
<span class="gi">+ cmp    r8d,0x2708           ; compare *old* x to 9992</span>
<span class="gi">+ je     181 &lt;__original_main+0x101&gt;</span>
<span class="gi">+ mov    r8,r11               ; commit x = x + 8</span>
<span class="gi">+jmp    102 &lt;__original_main+0x82&gt;</span>
</code></pre></div>
<h2>Analysis 2</h2>
<p>The rules in (2) and (3) are then now interesting. How did they "cure" the performance problem?<br>
In fact, the rules in (3) can interact with these rules in <code>icmp.isle</code>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="n">k</span><span class="p">)))</span><span class="w"> </span><span class="p">(</span><span class="n">subsume</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)))</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="n">b</span><span class="p">)))</span><span class="w"> </span><span class="p">(</span><span class="n">subsume</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)))</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="n">k</span><span class="p">)))</span><span class="w"> </span><span class="p">(</span><span class="n">subsume</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)))</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="n">b</span><span class="p">)))</span><span class="w"> </span><span class="p">(</span><span class="n">subsume</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)))</span>
</code></pre></div>
<p>Then, similar to Analysis 1, it can cause the same problem in generating jump instructions.</p>
<h2>Conclusion</h2>
<ul>
<li>I don't have a theory how the removed rules in (2) increased the performance, yet.</li>
<li>I couldn't decide where to fix: the mid-end or code-gen? The mid-end rules definitely made the code-gen worse, but those rules "looks fine". They just make sense, decreasing the number of IR instructions. Probably we should be more careful when it comes to "jumping" instructions, assuming there would be a reason for the way in which the wasm assembly is produced.<br>
</li>
</ul>
</blockquote>



<a name="563693491"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312139%20Cranelift%3A%20ISLE%20mid-end%20performan.../near/563693491" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312139.20Cranelift.3A.20ISLE.20mid-end.20performan.2E.2E.2E.html#563693491">(Dec 14 2025 at 14:43)</a>:</h4>
<p>bongjunj <a href="https://github.com/bytecodealliance/wasmtime/issues/12139#issuecomment-3651273315">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12139">issue #12139</a>:</p>
<blockquote>
<h1><code>pulldown-cmark</code></h1>
<h2>Analysis</h2>
<p>The hottest function for this benchmark program is <code>pulldown_cmark::parse::FirstPass::parse_line</code>.<br>
For this function, the latest version of Cranelift (Base) generated 7% larger x86 assembly than the no-opt version (NO).</p>
<p>More "reading from the stack" instructions are there in Base.</p>
<ul>
<li>NO: <code>mov.*QWORD PTR.*rsp.*r.*</code> 511 lines</li>
<li>Base: <code>mov.*QWORD PTR.*rsp.*r.*</code> 637 lines</li>
</ul>
<p>This might be from the IR transformation below (notice the increased usage of <code>v8</code>, which can contribute to higher register pressure):</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gu">@@ -2600,9 +2586,7 @@</span>
<span class="w"> </span>@892d                               store little heap v3177, v3174
<span class="w"> </span>                                    v4298 = isub.i32 v8, v9  ; v9 = 64
...
<span class="w"> </span>@895c                               v3246 = uextend.i64 v3239
<span class="w"> </span>@895c                               v3248 = iadd.i64 v13, v3246
<span class="w"> </span>@895c                               istore8 little heap v3245, v3248
<span class="gd">-                                    v4308 = iconst.i32 64</span>
<span class="gd">-                                    v4309 = iadd v4298, v4308  ; v4308 = 64</span>
<span class="gd">-@8965                               store notrap aligned table v4309, v0+400</span>
<span class="gi">+@8965                               store.i32 notrap aligned table v8, v0+400</span>
<span class="w"> </span>@896b                               jump block1
</code></pre></div>
<p>This symptom repeats:</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="w"> </span>@752e                               v34 = iadd.i32 v3, v33  ; v33 = 92
<span class="gd">-@8917                               v3100 = iconst.i32 40</span>
<span class="gd">-                                    v3558 = iadd v3555, v3100  ; v3100 = 40</span>
<span class="gd">-@87b9                               v2349 = call fn11(v0, v0, v34, v3558)</span>
<span class="gi">+                                    v3602 = iconst.i32 -24</span>
<span class="gi">+                                    v3603 = iadd.i32 v8, v3602  ; v3602 = -24</span>
<span class="gi">+@87b9                               v2349 = call fn11(v0, v0, v34, v3603)</span>
<span class="w"> </span>@87c0                               jump block11
</code></pre></div>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gd">-@785a                               v315 = iadd v3567, v314  ; v314 = 44</span>
<span class="gd">-@8822                               store little heap v3571, v315</span>
<span class="gd">-                                    v3572 = iconst.i64 56</span>
<span class="gd">-                                    v3573 = iadd v3567, v3572  ; v3572 = 56</span>
<span class="gd">-@8829                               store.i32 little heap v47, v3573</span>
<span class="gd">-@8832                               v2402 = iadd v3571, v47</span>
<span class="gd">-                                    v3574 = iconst.i64 60</span>
<span class="gd">-                                    v3575 = iadd v3567, v3574  ; v3574 = 60</span>
<span class="gd">-@8835                               store little heap v2402, v3575</span>
<span class="gd">-                                    v3576 = iconst.i32 92</span>
<span class="gd">-                                    v3577 = iadd.i32 v3, v3576  ; v3576 = 92</span>
<span class="gd">-                                    v3578 = iconst.i32 40</span>
<span class="gd">-                                    v3579 = iadd v3565, v3578  ; v3578 = 40</span>
<span class="gd">-@883f                               v2413 = call fn11(v0, v0, v3577, v3579)</span>
<span class="gd">-@8846                               jump block10(v2387, v47, v2402, v259, v410, v1203, v3571)</span>
<span class="gi">+@785a                               v315 = iadd v3720, v314  ; v314 = 44</span>
<span class="gi">+@8822                               store little heap v3724, v315</span>
<span class="gi">+                                    v3725 = iconst.i64 56</span>
<span class="gi">+                                    v3726 = iadd v3720, v3725  ; v3725 = 56</span>
<span class="gi">+@8829                               store.i32 little heap v47, v3726</span>
<span class="gi">+@8832                               v2402 = iadd v3724, v47</span>
<span class="gi">+                                    v3727 = iconst.i64 60</span>
<span class="gi">+                                    v3728 = iadd v3720, v3727  ; v3727 = 60</span>
<span class="gi">+@8835                               store little heap v2402, v3728</span>
<span class="gi">+                                    v3729 = iconst.i32 92</span>
<span class="gi">+                                    v3730 = iadd.i32 v3, v3729  ; v3729 = 92</span>
<span class="gi">+                                    v3731 = iconst.i32 -24</span>
<span class="gi">+                                    v3732 = iadd.i32 v8, v3731  ; v3731 = -24</span>
<span class="gi">+@883f                               v2413 = call fn11(v0, v0, v3730, v3732)</span>
<span class="gi">+@8846                               jump block10(v2387, v47, v2402, v259, v410, v1203, v3724)</span>
</code></pre></div>
<h2>Sidenote</h2>
<p>I am not sure this is an optimizing transformation which is intended):</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gd">-          v3835 = iconst.i32 1</span>
<span class="gd">-          v3836 = iadd.i32 v1156, v3835  ; v3835 = 1</span>
<span class="gd">-          v3837 = iconst.i32 6</span>
<span class="gd">-@7fd7     v1163 = urem v3836, v3837  ; v3837 = 6</span>
<span class="gd">-@7fd8     br_table v1163, block201, [block200, block198, block199, block200, block199]</span>
<span class="gi">+          v3988 = iconst.i32 1</span>
<span class="gi">+          v3989 = iadd.i32 v1156, v3988  ; v3988 = 1</span>
<span class="gi">+          v3685 = iconst.i32 -1431655765</span>
<span class="gi">+          v3686 = umulhi v3989, v3685  ; v3685 = -1431655765</span>
<span class="gi">+          v3990 = iconst.i32 2</span>
<span class="gi">+          v3687 = ushr v3686, v3990  ; v3990 = 2</span>
<span class="gi">+          v3991 = iconst.i32 6</span>
<span class="gi">+          v3688 = imul v3687, v3991  ; v3991 = 6</span>
<span class="gi">+          v3689 = isub v3989, v3688</span>
<span class="gi">+          v1163 -&gt; v3689</span>
<span class="gi">+@7fd8     br_table v3689, block201, [block200, block198, block199, block200, block199]</span>
</code></pre></div>
</blockquote>



<a name="563693649"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312139%20Cranelift%3A%20ISLE%20mid-end%20performan.../near/563693649" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312139.20Cranelift.3A.20ISLE.20mid-end.20performan.2E.2E.2E.html#563693649">(Dec 14 2025 at 14:47)</a>:</h4>
<p>bongjunj edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/12139#issuecomment-3651273315">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12139">issue #12139</a>:</p>
<blockquote>
<h1><code>pulldown-cmark</code></h1>
<p>The execution performance is regressed by -4.38% from the no-opt version (NO) to the lastest version (Base).</p>
<h2>Analysis</h2>
<p>The hottest function for this benchmark program is <code>pulldown_cmark::parse::FirstPass::parse_line</code>.<br>
<strong>For this function, the latest version of Base generated 7% larger x86 assembly than the no-opt version NO.</strong><br>
In addition, more "reading from the stack" instructions are there in Base, indicating a register allocation problem.</p>
<ul>
<li>NO: <code>mov.*QWORD PTR.*rsp.*r.*</code> 511 lines</li>
<li>Base: <code>mov.*QWORD PTR.*rsp.*r.*</code> 637 lines</li>
</ul>
<p>This might be from the IR transformation below (notice the increased usage of <code>v8</code>, which can contribute to higher register pressure):</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gu">@@ -2600,9 +2586,7 @@</span>
<span class="w"> </span>@892d                               store little heap v3177, v3174
<span class="w"> </span>                                    v4298 = isub.i32 v8, v9  ; v9 = 64
...
<span class="w"> </span>@895c                               v3246 = uextend.i64 v3239
<span class="w"> </span>@895c                               v3248 = iadd.i64 v13, v3246
<span class="w"> </span>@895c                               istore8 little heap v3245, v3248
<span class="gd">-                                    v4308 = iconst.i32 64</span>
<span class="gd">-                                    v4309 = iadd v4298, v4308  ; v4308 = 64</span>
<span class="gd">-@8965                               store notrap aligned table v4309, v0+400</span>
<span class="gi">+@8965                               store.i32 notrap aligned table v8, v0+400</span>
<span class="w"> </span>@896b                               jump block1
</code></pre></div>
<p>This symptom repeats:</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="w"> </span>@752e                               v34 = iadd.i32 v3, v33  ; v33 = 92
<span class="gd">-@8917                               v3100 = iconst.i32 40</span>
<span class="gd">-                                    v3558 = iadd v3555, v3100  ; v3100 = 40</span>
<span class="gd">-@87b9                               v2349 = call fn11(v0, v0, v34, v3558)</span>
<span class="gi">+                                    v3602 = iconst.i32 -24</span>
<span class="gi">+                                    v3603 = iadd.i32 v8, v3602  ; v3602 = -24</span>
<span class="gi">+@87b9                               v2349 = call fn11(v0, v0, v34, v3603)</span>
<span class="w"> </span>@87c0                               jump block11
</code></pre></div>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gd">-@785a                               v315 = iadd v3567, v314  ; v314 = 44</span>
<span class="gd">-@8822                               store little heap v3571, v315</span>
<span class="gd">-                                    v3572 = iconst.i64 56</span>
<span class="gd">-                                    v3573 = iadd v3567, v3572  ; v3572 = 56</span>
<span class="gd">-@8829                               store.i32 little heap v47, v3573</span>
<span class="gd">-@8832                               v2402 = iadd v3571, v47</span>
<span class="gd">-                                    v3574 = iconst.i64 60</span>
<span class="gd">-                                    v3575 = iadd v3567, v3574  ; v3574 = 60</span>
<span class="gd">-@8835                               store little heap v2402, v3575</span>
<span class="gd">-                                    v3576 = iconst.i32 92</span>
<span class="gd">-                                    v3577 = iadd.i32 v3, v3576  ; v3576 = 92</span>
<span class="gd">-                                    v3578 = iconst.i32 40</span>
<span class="gd">-                                    v3579 = iadd v3565, v3578  ; v3578 = 40</span>
<span class="gd">-@883f                               v2413 = call fn11(v0, v0, v3577, v3579)</span>
<span class="gd">-@8846                               jump block10(v2387, v47, v2402, v259, v410, v1203, v3571)</span>
<span class="gi">+@785a                               v315 = iadd v3720, v314  ; v314 = 44</span>
<span class="gi">+@8822                               store little heap v3724, v315</span>
<span class="gi">+                                    v3725 = iconst.i64 56</span>
<span class="gi">+                                    v3726 = iadd v3720, v3725  ; v3725 = 56</span>
<span class="gi">+@8829                               store.i32 little heap v47, v3726</span>
<span class="gi">+@8832                               v2402 = iadd v3724, v47</span>
<span class="gi">+                                    v3727 = iconst.i64 60</span>
<span class="gi">+                                    v3728 = iadd v3720, v3727  ; v3727 = 60</span>
<span class="gi">+@8835                               store little heap v2402, v3728</span>
<span class="gi">+                                    v3729 = iconst.i32 92</span>
<span class="gi">+                                    v3730 = iadd.i32 v3, v3729  ; v3729 = 92</span>
<span class="gi">+                                    v3731 = iconst.i32 -24</span>
<span class="gi">+                                    v3732 = iadd.i32 v8, v3731  ; v3731 = -24</span>
<span class="gi">+@883f                               v2413 = call fn11(v0, v0, v3730, v3732)</span>
<span class="gi">+@8846                               jump block10(v2387, v47, v2402, v259, v410, v1203, v3724)</span>
</code></pre></div>
<h2>Sidenote</h2>
<p>I am not sure this is an optimizing transformation which is intended):</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gd">-          v3835 = iconst.i32 1</span>
<span class="gd">-          v3836 = iadd.i32 v1156, v3835  ; v3835 = 1</span>
<span class="gd">-          v3837 = iconst.i32 6</span>
<span class="gd">-@7fd7     v1163 = urem v3836, v3837  ; v3837 = 6</span>
<span class="gd">-@7fd8     br_table v1163, block201, [block200, block198, block199, block200, block199]</span>
<span class="gi">+          v3988 = iconst.i32 1</span>
<span class="gi">+          v3989 = iadd.i32 v1156, v3988  ; v3988 = 1</span>
<span class="gi">+          v3685 = iconst.i32 -1431655765</span>
<span class="gi">+          v3686 = umulhi v3989, v3685  ; v3685 = -1431655765</span>
<span class="gi">+          v3990 = iconst.i32 2</span>
<span class="gi">+          v3687 = ushr v3686, v3990  ; v3990 = 2</span>
<span class="gi">+          v3991 = iconst.i32 6</span>
<span class="gi">+          v3688 = imul v3687, v3991  ; v3991 = 6</span>
<span class="gi">+          v3689 = isub v3989, v3688</span>
<span class="gi">+          v1163 -&gt; v3689</span>
<span class="gi">+@7fd8     br_table v3689, block201, [block200, block198, block199, block200, block199]</span>
</code></pre></div>
</blockquote>



<a name="563707124"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312139%20Cranelift%3A%20ISLE%20mid-end%20performan.../near/563707124" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312139.20Cranelift.3A.20ISLE.20mid-end.20performan.2E.2E.2E.html#563707124">(Dec 14 2025 at 19:16)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/12139#issuecomment-3651849051">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12139">issue #12139</a>:</p>
<blockquote>
<p>@bongjunj thanks for this analysis! I'll think about it in more detail on Monday but I wonder if you could provide one more data point: you have found how to remove a regression on <code>shootout-switch</code> and <code>pulldown-cmark</code> but with the rules that cause this removed, how does performance look on the rest of the benchmarks?</p>
<p>Basically: I want to think about performance with two metrics of goodness, namely average/overall speedup, and negative outliers. We want to avoid outliers, and they may point the way toward deficiencies in our rules or algorithms. But I also don't want to regress compiler performance as a whole by removing rules -- so it'd be useful to know the overall impact.</p>
</blockquote>



<a name="563761510"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312139%20Cranelift%3A%20ISLE%20mid-end%20performan.../near/563761510" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312139.20Cranelift.3A.20ISLE.20mid-end.20performan.2E.2E.2E.html#563761510">(Dec 15 2025 at 08:44)</a>:</h4>
<p>bongjunj <a href="https://github.com/bytecodealliance/wasmtime/issues/12139#issuecomment-3654459431">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12139">issue #12139</a>:</p>
<blockquote>
<p>I delta-debugged to locate rules that is causing performance regression for <code>pulldown-cmark</code>  and found out a list of rules:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="n">k</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="n">subsume</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)))</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="n">b</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="n">subsume</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)))</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="n">k</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="n">subsume</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)))</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="n">b</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="n">subsume</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)))</span>

<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">isub</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">ishl</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">ishl</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">z</span><span class="p">)))</span><span class="w"> </span><span class="p">(</span><span class="n">ishl</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">isub</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>

<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">uextend</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">uextend</span><span class="w"> </span><span class="n">_intermediate_ty</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="n">uextend</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">sextend</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">sextend</span><span class="w"> </span><span class="n">_intermediate_ty</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="n">sextend</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>

<span class="p">;;</span><span class="w"> </span><span class="n">Reassociate</span><span class="w"> </span><span class="n">across</span><span class="w"> </span><span class="err">`</span><span class="o">==</span><span class="err">`</span><span class="o">/</span><span class="err">`</span><span class="o">!=</span><span class="err">`</span><span class="w"> </span><span class="n">when</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">simplify</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">constant</span>
<span class="p">;;</span><span class="w"> </span><span class="err">`</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">K1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">K2</span><span class="err">`</span><span class="w"> </span><span class="o">-</span><span class="p">-&gt;</span><span class="w"> </span><span class="err">`</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">K2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">K1</span><span class="err">`</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">eq</span><span class="w"> </span><span class="n">ty1</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">ty2</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">k1</span><span class="o">@</span><span class="p">(</span><span class="n">iconst</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">_</span><span class="p">))</span><span class="w"> </span><span class="n">k2</span><span class="o">@</span><span class="p">(</span><span class="n">iconst</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">_</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="n">eq</span><span class="w"> </span><span class="n">ty1</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="n">isub</span><span class="w"> </span><span class="n">ty2</span><span class="w"> </span><span class="n">k2</span><span class="w"> </span><span class="n">k1</span><span class="p">)))</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty1</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">ty2</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">k1</span><span class="o">@</span><span class="p">(</span><span class="n">iconst</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">_</span><span class="p">))</span><span class="w"> </span><span class="n">k2</span><span class="o">@</span><span class="p">(</span><span class="n">iconst</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">_</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty1</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="n">isub</span><span class="w"> </span><span class="n">ty2</span><span class="w"> </span><span class="n">k2</span><span class="w"> </span><span class="n">k1</span><span class="p">)))</span>
<span class="p">;;</span><span class="w"> </span><span class="err">`</span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">K1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">K2</span><span class="err">`</span><span class="w"> </span><span class="o">-</span><span class="p">-&gt;</span><span class="w"> </span><span class="err">`</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">K2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">K1</span><span class="err">`</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">eq</span><span class="w"> </span><span class="n">ty1</span><span class="w"> </span><span class="p">(</span><span class="n">isub</span><span class="w"> </span><span class="n">ty2</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">k1</span><span class="o">@</span><span class="p">(</span><span class="n">iconst</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">_</span><span class="p">))</span><span class="w"> </span><span class="n">k2</span><span class="o">@</span><span class="p">(</span><span class="n">iconst</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">_</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="n">eq</span><span class="w"> </span><span class="n">ty1</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">ty2</span><span class="w"> </span><span class="n">k2</span><span class="w"> </span><span class="n">k1</span><span class="p">)))</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty1</span><span class="w"> </span><span class="p">(</span><span class="n">isub</span><span class="w"> </span><span class="n">ty2</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">k1</span><span class="o">@</span><span class="p">(</span><span class="n">iconst</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">_</span><span class="p">))</span><span class="w"> </span><span class="n">k2</span><span class="o">@</span><span class="p">(</span><span class="n">iconst</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">_</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty1</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">ty2</span><span class="w"> </span><span class="n">k2</span><span class="w"> </span><span class="n">k1</span><span class="p">)))</span>
<span class="p">;;</span><span class="w"> </span><span class="err">`</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">K1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">K2</span><span class="err">`</span><span class="w"> </span><span class="o">-</span><span class="p">-&gt;</span><span class="w"> </span><span class="err">`</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">K2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">K1</span><span class="p">)</span><span class="err">`</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">eq</span><span class="w"> </span><span class="n">ty1</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">ty2</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">k1</span><span class="o">@</span><span class="p">(</span><span class="n">iconst</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">_</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">ty3</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">k2</span><span class="o">@</span><span class="p">(</span><span class="n">iconst</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">_</span><span class="p">))))</span>
<span class="w">      </span><span class="p">(</span><span class="n">eq</span><span class="w"> </span><span class="n">ty1</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">ty2</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="p">(</span><span class="n">isub</span><span class="w"> </span><span class="n">ty3</span><span class="w"> </span><span class="n">k2</span><span class="w"> </span><span class="n">k1</span><span class="p">))))</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty1</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">ty2</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">k1</span><span class="o">@</span><span class="p">(</span><span class="n">iconst</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">_</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">ty3</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">k2</span><span class="o">@</span><span class="p">(</span><span class="n">iconst</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">_</span><span class="p">))))</span>
<span class="w">      </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty1</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">ty2</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="p">(</span><span class="n">isub</span><span class="w"> </span><span class="n">ty3</span><span class="w"> </span><span class="n">k2</span><span class="w"> </span><span class="n">k1</span><span class="p">))))</span>

<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">ty</span>
<span class="w">                      </span><span class="p">(</span><span class="n">isub</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="n">iconst</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">u64_from_imm64</span><span class="w"> </span><span class="n">k1</span><span class="p">)))</span>
<span class="w">                      </span><span class="p">(</span><span class="n">iconst</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">u64_from_imm64</span><span class="w"> </span><span class="n">k2</span><span class="p">))))</span>
<span class="w">      </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="n">iconst</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">imm64_masked</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">u64_wrapping_sub</span><span class="w"> </span><span class="n">k2</span><span class="w"> </span><span class="n">k1</span><span class="p">)))))</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">ty</span>
<span class="w">                      </span><span class="p">(</span><span class="n">isub</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">iconst</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">u64_from_imm64</span><span class="w"> </span><span class="n">k1</span><span class="p">))</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">                      </span><span class="p">(</span><span class="n">iconst</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">u64_from_imm64</span><span class="w"> </span><span class="n">k2</span><span class="p">))))</span>
<span class="w">      </span><span class="p">(</span><span class="n">isub</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">iconst</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">imm64_masked</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">u64_wrapping_add</span><span class="w"> </span><span class="n">k1</span><span class="w"> </span><span class="n">k2</span><span class="p">)))</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>

<span class="p">;;</span><span class="w"> </span><span class="n">iconst_</span><span class="p">[</span><span class="n">su</span><span class="p">]</span><span class="w"> </span><span class="n">support</span><span class="w"> </span><span class="cp">$I128</span><span class="p">,</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="kr">do</span><span class="w"> </span><span class="n">so</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">extending</span><span class="p">,</span><span class="w"> </span><span class="n">so</span><span class="w"> </span><span class="n">restricting</span><span class="w"> </span><span class="n">to</span>
<span class="p">;;</span><span class="w"> </span><span class="mi">64</span><span class="o">-</span><span class="n">bit</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">smaller</span><span class="w"> </span><span class="n">keeps</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">just</span><span class="w"> </span><span class="n">remaking</span><span class="w"> </span><span class="n">essentially</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">same</span><span class="w"> </span><span class="n">thing</span><span class="p">.</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">uextend</span><span class="w"> </span><span class="p">(</span><span class="n">fits_in_64</span><span class="w"> </span><span class="n">wide</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">iconst_u</span><span class="w"> </span><span class="n">narrow</span><span class="w"> </span><span class="n">k</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="n">subsume</span><span class="w"> </span><span class="p">(</span><span class="n">iconst_u</span><span class="w"> </span><span class="n">wide</span><span class="w"> </span><span class="n">k</span><span class="p">)))</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">sextend</span><span class="w"> </span><span class="p">(</span><span class="n">fits_in_64</span><span class="w"> </span><span class="n">wide</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">iconst_s</span><span class="w"> </span><span class="n">narrow</span><span class="w"> </span><span class="n">k</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="n">subsume</span><span class="w"> </span><span class="p">(</span><span class="n">iconst_s</span><span class="w"> </span><span class="n">wide</span><span class="w"> </span><span class="n">k</span><span class="p">)))</span>

<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span>
<span class="w">       </span><span class="p">(</span><span class="n">isub</span><span class="w"> </span><span class="p">(</span><span class="n">fits_in_64</span><span class="w"> </span><span class="n">ty</span><span class="p">)</span>
<span class="w">             </span><span class="p">(</span><span class="n">iconst</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">u64_from_imm64</span><span class="w"> </span><span class="n">k1</span><span class="p">))</span>
<span class="w">             </span><span class="p">(</span><span class="n">iconst</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">u64_from_imm64</span><span class="w"> </span><span class="n">k2</span><span class="p">))))</span>
<span class="w">      </span><span class="p">(</span><span class="n">subsume</span><span class="w"> </span><span class="p">(</span><span class="n">iconst</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">imm64_masked</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">u64_wrapping_sub</span><span class="w"> </span><span class="n">k1</span><span class="w"> </span><span class="n">k2</span><span class="p">)))))</span>

<span class="p">;;</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">x</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">isub</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="n">y</span><span class="p">))</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="p">(</span><span class="n">isub</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)))</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>

<span class="p">;;</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">-</span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">x</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">isub</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="p">))</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">isub</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="n">y</span><span class="p">))</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>

<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify_skeleton</span><span class="w"> </span><span class="p">(</span><span class="n">urem</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="n">iconst_u</span><span class="w"> </span><span class="cp">$I32</span><span class="w"> </span><span class="p">(</span><span class="n">u64_extract_non_zero</span><span class="w"> </span><span class="p">(</span><span class="n">u32_from_u64</span><span class="w"> </span><span class="n">d</span><span class="p">)))))</span>
<span class="w">      </span><span class="p">(</span><span class="k">if</span><span class="o">-</span><span class="kd">let</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="p">(</span><span class="n">u32_is_power_of_two</span><span class="w"> </span><span class="n">d</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="n">apply_div_const_magic_u32</span><span class="w"> </span><span class="p">(</span><span class="n">Opcode</span><span class="p">.</span><span class="n">Urem</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">d</span><span class="p">))</span>

<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify_skeleton</span><span class="w"> </span><span class="p">(</span><span class="n">udiv</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="n">iconst_u</span><span class="w"> </span><span class="cp">$I32</span><span class="w"> </span><span class="p">(</span><span class="n">u64_extract_non_zero</span><span class="w"> </span><span class="p">(</span><span class="n">u32_from_u64</span><span class="w"> </span><span class="n">d</span><span class="p">)))))</span>
<span class="w">      </span><span class="p">(</span><span class="k">if</span><span class="o">-</span><span class="kd">let</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="p">(</span><span class="n">u32_is_power_of_two</span><span class="w"> </span><span class="n">d</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="n">apply_div_const_magic_u32</span><span class="w"> </span><span class="p">(</span><span class="n">Opcode</span><span class="p">.</span><span class="n">Udiv</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">d</span><span class="p">))</span>

<span class="p">;;</span><span class="w"> </span><span class="mi">0</span><span class="o">-</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">(</span><span class="n">ineg</span><span class="w"> </span><span class="n">x</span><span class="p">).</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">isub</span><span class="w"> </span><span class="n">ty</span>
<span class="w">                      </span><span class="p">(</span><span class="n">iconst_u</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">                      </span><span class="n">x</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="n">ineg</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
</code></pre></div>
<p>A performance regression is observed from the no-opt Cranelift with each of these rules.<br>
For experiment, I removed all of these rules, and could reduce the perf regression to -2.24% but failed to eliminate all.</p>
<p>Here are the overall data.</p>
<ul>
<li>Fix1 is the Cranelift version without the perf-regressing rules for <code>shootout-switch</code> (See <a href="https://github.com/bytecodealliance/wasmtime/issues/12139#issuecomment-3650453592">https://github.com/bytecodealliance/wasmtime/issues/12139#issuecomment-3650453592</a>)</li>
<li>Fix2 is the Cranelift version without the perf-regressing rules for <code>pulldown-cmark</code> (See above)</li>
</ul>
<table>
<thead>
<tr>
<th>Benchmark</th>
<th style="text-align: right;">Fix1 Speedup</th>
<th style="text-align: right;">Fix2 Speedup</th>
<th style="text-align: right;">Main Speedup</th>
</tr>
</thead>
<tbody>
<tr>
<td>blake3-scalar</td>
<td style="text-align: right;">-0.69%</td>
<td style="text-align: right;">-0.27%</td>
<td style="text-align: right;">0.11%</td>
</tr>
<tr>
<td>blake3-simd</td>
<td style="text-align: right;">0.64%</td>
<td style="text-align: right;">0.82%</td>
<td style="text-align: right;">2.51%</td>
</tr>
<tr>
<td>bz2</td>
<td style="text-align: right;">0.36%</td>
<td style="text-align: right;">0.22%</td>
<td style="text-align: right;">0.99%</td>
</tr>
<tr>
<td>pulldown-cmark</td>
<td style="text-align: right;">-5.08%</td>
<td style="text-align: right;">-2.24%</td>
<td style="text-align: right;">-5.28%</td>
</tr>
<tr>
<td>regex</td>
<td style="text-align: right;">-0.51%</td>
<td style="text-align: right;">0.77%</td>
<td style="text-align: right;">-0.11%</td>
</tr>
<tr>
<td>shootout-ackermann</td>
<td style="text-align: right;">-1.39%</td>
<td style="text-align: right;">-1.52%</td>
<td style="text-align: right;">9.63%</td>
</tr>
<tr>
<td>shootout-base64</td>
<td style="text-align: right;">8.93%</td>
<td style="text-align: right;">7.04%</td>
<td style="text-align: right;">8.23%</td>
</tr>
<tr>
<td>shootout-ctype</td>
<td style="text-align: right;">1.07%</td>
<td style="text-align: right;">1.06%</td>
<td style="text-align: right;">4.30%</td>
</tr>
<tr>
<td>shootout-ed25519</td>
<td style="text-align: right;">1.83%</td>
<td style="text-align: right;">0.70%</td>
<td style="text-align: right;">1.96%</td>
</tr>
<tr>
<td>shootout-fib2</td>
<td style="text-align: right;">0.06%</td>
<td style="text-align: right;">0.08%</td>
<td style="text-align: right;">0.03%</td>
</tr>
<tr>
<td>shootout-gimli</td>
<td style="text-align: right;">-0.27%</td>
<td style="text-align: right;">-0.16%</td>
<td style="text-align: right;">-1.33%</td>
</tr>
<tr>
<td>shootout-heapsort</td>
<td style="text-align: right;">-2.33%</td>
<td style="text-align: right;">-0.76%</td>
<td style="text-align: right;">0.08%</td>
</tr>
<tr>
<td>shootout-keccak</td>
<td style="text-align: right;">19.10%</td>
<td style="text-align: right;">19.11%</td>
<td style="text-align: right;">19.10%</td>
</tr>
<tr>
<td>shootout-matrix</td>
<td style="text-align: right;">0.17%</td>
<td style="text-align: right;">0.24%</td>
<td style="text-align: right;">-0.19%</td>
</tr>
<tr>
<td>shootout-memmove</td>
<td style="text-align: right;">-6.34%</td>
<td style="text-align: right;">-6.27%</td>
<td style="text-align: right;">-0.17%</td>
</tr>
<tr>
<td>shootout-minicsv</td>
<td style="text-align: right;">0.68%</td>
<td style="text-align: right;">0.69%</td>
<td style="text-align: right;">14.62%</td>
</tr>
<tr>
<td>shootout-nestedloop</td>
<td style="text-align: right;">-11.25%</td>
<td style="text-align: right;">4.71%</td>
<td style="text-align: right;">-4.75%</td>
</tr>
<tr>
<td>shootout-random</td>
<td style="text-align: right;">43.37%</td>
<td style="text-align: right;">0.00%</td>
<td style="text-align: right;">43.35%</td>
</tr>
<tr>
<td>shootout-ratelimit</td>
<td style="text-align: right;">-0.39%</td>
<td style="text-align: right;">-0.52%</td>
<td style="text-align: right;">-2.00%</td>
</tr>
<tr>
<td>shootout-seqhash</td>
<td style="text-align: right;">-0.85%</td>
<td style="text-align: right;">-1.55%</td>
<td style="text-align: right;">1.84%</td>
</tr>
<tr>
<td>shootout-sieve</td>
<td style="text-align: right;">0.07%</td>
<td style="text-align: right;">-0.03%</td>
<td style="text-align: right;">7.77%</td>
</tr>
<tr>
<td>shootout-switch</td>
<td style="text-align: right;">0.03%</td>
<td style="text-align: right;">0.00%</td>
<td style="text-align: right;">-9.20%</td>
</tr>
<tr>
<td>shootout-xblabla20</td>
<td style="text-align: right;">-3.06%</td>
<td style="text-align: right;">-3.14%</td>
<td style="text-align: right;">-0.34%</td>
</tr>
<tr>
<td>shootout-xchacha20</td>
<td style="text-align: right;">0.15%</td>
<td style="text-align: right;">-0.36%</td>
<td style="text-align: right;">0.00%</td>
</tr>
<tr>
<td>spidermonkey</td>
<td style="text-align: right;">-1.66%</td>
<td style="text-align: right;">-2.58%</td>
<td style="text-align: right;">0.58%</td>
</tr>
</tbody>
</table>
<p>You can see that the performance is restored completely  for <code>shootout-switch</code> and partially for <code>pulldown-cmark</code>.<br>
But we are losing at <code>shootout-ackermann</code>, <code>shootout-base64</code>, <code>shootout-heapsort</code>, <code>shootout-memmove</code>, <code>spidermonkey</code> and others.</p>
<p>Probably it is the time to tap in the backend codegen/instruction scheduling/register allocation because a subtle change in IR is causing a surprising performance regression. For example, the following IR transformation (no-opt to base) in <code>pulldown-cmark</code></p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="w"> </span>       v3555 = isub.i32 v8, v9
<span class="gd">-@8917  v3100 = iconst.i32 40</span>
<span class="gd">-       v3558 = iadd v3555, v3100  ; v3100 = 40</span>
<span class="gd">-@87b9  v2349 = call fn11(v0, v0, v34, v3558)</span>
<span class="gi">+       v3602 = iconst.i32 -24</span>
<span class="gi">+       v3603 = iadd.i32 v8, v3602  ; v3602 = -24</span>
<span class="gi">+@87b9  v2349 = call fn11(v0, v0, v34, v3603)</span>
</code></pre></div>
<p>changed</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="mi">3</span><span class="n">b9a</span><span class="p">:</span><span class="w">   </span><span class="nc">mov</span><span class="w">    </span><span class="n">r8</span><span class="p">,</span><span class="n">rcx</span>
<span class="mi">3</span><span class="n">b9d</span><span class="p">:</span><span class="w">   </span><span class="nc">sub</span><span class="w">    </span><span class="n">r8d</span><span class="p">,</span><span class="mh">0x40</span>
<span class="mi">3</span><span class="n">ba1</span><span class="p">:</span><span class="w">   </span><span class="nc">mov</span><span class="w">    </span><span class="n">rax</span><span class="p">,</span><span class="n">QWORD</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span><span class="p">[</span><span class="n">rsp</span><span class="o">+</span><span class="mh">0x30</span><span class="p">]</span>
<span class="mi">3</span><span class="n">ba6</span><span class="p">:</span><span class="w">   </span><span class="nc">mov</span><span class="w">    </span><span class="n">DWORD</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span><span class="p">[</span><span class="n">rbx</span><span class="o">+</span><span class="n">r8</span><span class="o">*</span><span class="mi">1</span><span class="o">+</span><span class="mh">0x3c</span><span class="p">],</span><span class="n">eax</span>
<span class="mi">3</span><span class="n">bab</span><span class="p">:</span><span class="w">   </span><span class="nc">mov</span><span class="w">    </span><span class="n">rcx</span><span class="p">,</span><span class="n">QWORD</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span><span class="p">[</span><span class="n">rsp</span><span class="o">+</span><span class="mh">0x48</span><span class="p">]</span>
<span class="mi">3</span><span class="n">bb0</span><span class="p">:</span><span class="w">   </span><span class="nc">mov</span><span class="w">    </span><span class="n">DWORD</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span><span class="p">[</span><span class="n">rbx</span><span class="o">+</span><span class="n">r8</span><span class="o">*</span><span class="mi">1</span><span class="o">+</span><span class="mh">0x38</span><span class="p">],</span><span class="n">ecx</span>
<span class="mi">3</span><span class="n">bb5</span><span class="p">:</span><span class="w">   </span><span class="nc">mov</span><span class="w">    </span><span class="n">r10d</span><span class="p">,</span><span class="mh">0x1</span>
<span class="mi">3</span><span class="n">bbb</span><span class="p">:</span><span class="w">   </span><span class="nc">mov</span><span class="w">    </span><span class="n">BYTE</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span><span class="p">[</span><span class="n">rbx</span><span class="o">+</span><span class="n">r8</span><span class="o">*</span><span class="mi">1</span><span class="o">+</span><span class="mh">0x28</span><span class="p">],</span><span class="n">r10b</span>
<span class="mi">3</span><span class="n">bc0</span><span class="p">:</span><span class="w">   </span><span class="nc">mov</span><span class="w">    </span><span class="n">r11</span><span class="p">,</span><span class="n">QWORD</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span><span class="p">[</span><span class="n">rsp</span><span class="o">+</span><span class="mh">0x20</span><span class="p">]</span>
<span class="mi">3</span><span class="n">bc5</span><span class="p">:</span><span class="w">   </span><span class="nc">lea</span><span class="w">    </span><span class="n">edx</span><span class="p">,[</span><span class="n">r11</span><span class="o">+</span><span class="mh">0x5c</span><span class="p">]</span>
<span class="mi">3</span><span class="n">bc9</span><span class="p">:</span><span class="w">   </span><span class="nc">lea</span><span class="w">    </span><span class="n">ecx</span><span class="p">,[</span><span class="n">r8</span><span class="o">+</span><span class="mh">0x28</span><span class="p">]</span>
<span class="o">..</span><span class="p">.</span>
</code></pre></div>
<p>to</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="mf">3e8</span><span class="n">b</span><span class="p">:</span><span class="w">   </span><span class="nc">sub</span><span class="w">    </span><span class="n">r9d</span><span class="p">,</span><span class="mh">0x40</span>
<span class="mf">3e8</span><span class="n">f</span><span class="p">:</span><span class="w">   </span><span class="nc">mov</span><span class="w">    </span><span class="n">rdi</span><span class="p">,</span><span class="n">QWORD</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span><span class="p">[</span><span class="n">rsp</span><span class="o">+</span><span class="mh">0xc8</span><span class="p">]</span>
<span class="mf">3e97</span><span class="p">:</span><span class="w">   </span><span class="nc">mov</span><span class="w">    </span><span class="n">r8</span><span class="p">,</span><span class="n">QWORD</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span><span class="p">[</span><span class="n">rsp</span><span class="o">+</span><span class="mh">0x30</span><span class="p">]</span>
<span class="mf">3e9</span><span class="n">c</span><span class="p">:</span><span class="w">   </span><span class="nc">mov</span><span class="w">    </span><span class="n">DWORD</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span><span class="p">[</span><span class="n">rdi</span><span class="o">+</span><span class="n">r9</span><span class="o">*</span><span class="mi">1</span><span class="o">+</span><span class="mh">0x3c</span><span class="p">],</span><span class="n">r8d</span>
<span class="mi">3</span><span class="n">ea1</span><span class="p">:</span><span class="w">   </span><span class="nc">mov</span><span class="w">    </span><span class="n">rcx</span><span class="p">,</span><span class="n">QWORD</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span><span class="p">[</span><span class="n">rsp</span><span class="o">+</span><span class="mh">0x48</span><span class="p">]</span>
<span class="mi">3</span><span class="n">ea6</span><span class="p">:</span><span class="w">   </span><span class="nc">mov</span><span class="w">    </span><span class="n">DWORD</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span><span class="p">[</span><span class="n">rdi</span><span class="o">+</span><span class="n">r9</span><span class="o">*</span><span class="mi">1</span><span class="o">+</span><span class="mh">0x38</span><span class="p">],</span><span class="n">ecx</span>
<span class="mi">3</span><span class="n">eab</span><span class="p">:</span><span class="w">   </span><span class="nc">mov</span><span class="w">    </span><span class="n">r11d</span><span class="p">,</span><span class="mh">0x1</span>
<span class="mi">3</span><span class="n">eb1</span><span class="p">:</span><span class="w">   </span><span class="nc">mov</span><span class="w">    </span><span class="n">BYTE</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span><span class="p">[</span><span class="n">rdi</span><span class="o">+</span><span class="n">r9</span><span class="o">*</span><span class="mi">1</span><span class="o">+</span><span class="mh">0x28</span><span class="p">],</span><span class="n">r11b</span>
<span class="mi">3</span><span class="n">eb6</span><span class="p">:</span><span class="w">   </span><span class="nc">mov</span><span class="w">    </span><span class="n">r8</span><span class="p">,</span><span class="n">QWORD</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span><span class="p">[</span><span class="n">rsp</span><span class="o">+</span><span class="mh">0x20</span><span class="p">]</span>
<span class="mi">3</span><span class="n">ebb</span><span class="p">:</span><span class="w">   </span><span class="nc">lea</span><span class="w">    </span><span class="n">edx</span><span class="p">,[</span><span class="n">r8</span><span class="o">+</span><span class="mh">0x5c</span><span class="p">]</span>
<span class="mi">3</span><span class="n">ebf</span><span class="p">:</span><span class="w">   </span><span class="nc">mov</span><span class="w">    </span><span class="n">r9</span><span class="p">,</span><span class="n">QWORD</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span><span class="p">[</span><span class="n">rsp</span><span class="o">+</span><span class="mh">0xd0</span><span class="p">]</span>
<span class="mi">3</span><span class="n">ec7</span><span class="p">:</span><span class="w">   </span><span class="nc">lea</span><span class="w">    </span><span class="n">ecx</span><span class="p">,[</span><span class="n">r9</span><span class="o">-</span><span class="mh">0x18</span><span class="p">]</span>
<span class="o">..</span><span class="p">.</span>
</code></pre></div>
<p>Notice that there are more spills/loads.<br>
Similar regression happens for <code>shootout-switch</code> (one jump to two jumps) with a slight change in IR.</p>
</blockquote>



<a name="563762159"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312139%20Cranelift%3A%20ISLE%20mid-end%20performan.../near/563762159" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312139.20Cranelift.3A.20ISLE.20mid-end.20performan.2E.2E.2E.html#563762159">(Dec 15 2025 at 08:47)</a>:</h4>
<p>bongjunj edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/12139#issuecomment-3654459431">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12139">issue #12139</a>:</p>
<blockquote>
<p>I delta-debugged to locate rules that is causing performance regression for <code>pulldown-cmark</code>  and found out a list of rules:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="n">k</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="n">subsume</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)))</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="n">b</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="n">subsume</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)))</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="n">k</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="n">subsume</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)))</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="n">b</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="n">subsume</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)))</span>

<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">isub</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">ishl</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">ishl</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">z</span><span class="p">)))</span><span class="w"> </span><span class="p">(</span><span class="n">ishl</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">isub</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>

<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">uextend</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">uextend</span><span class="w"> </span><span class="n">_intermediate_ty</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="n">uextend</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">sextend</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">sextend</span><span class="w"> </span><span class="n">_intermediate_ty</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="n">sextend</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>

<span class="p">;;</span><span class="w"> </span><span class="n">Reassociate</span><span class="w"> </span><span class="n">across</span><span class="w"> </span><span class="err">`</span><span class="o">==</span><span class="err">`</span><span class="o">/</span><span class="err">`</span><span class="o">!=</span><span class="err">`</span><span class="w"> </span><span class="n">when</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">simplify</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">constant</span>
<span class="p">;;</span><span class="w"> </span><span class="err">`</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">K1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">K2</span><span class="err">`</span><span class="w"> </span><span class="o">-</span><span class="p">-&gt;</span><span class="w"> </span><span class="err">`</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">K2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">K1</span><span class="err">`</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">eq</span><span class="w"> </span><span class="n">ty1</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">ty2</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">k1</span><span class="o">@</span><span class="p">(</span><span class="n">iconst</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">_</span><span class="p">))</span><span class="w"> </span><span class="n">k2</span><span class="o">@</span><span class="p">(</span><span class="n">iconst</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">_</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="n">eq</span><span class="w"> </span><span class="n">ty1</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="n">isub</span><span class="w"> </span><span class="n">ty2</span><span class="w"> </span><span class="n">k2</span><span class="w"> </span><span class="n">k1</span><span class="p">)))</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty1</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">ty2</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">k1</span><span class="o">@</span><span class="p">(</span><span class="n">iconst</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">_</span><span class="p">))</span><span class="w"> </span><span class="n">k2</span><span class="o">@</span><span class="p">(</span><span class="n">iconst</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">_</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty1</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="n">isub</span><span class="w"> </span><span class="n">ty2</span><span class="w"> </span><span class="n">k2</span><span class="w"> </span><span class="n">k1</span><span class="p">)))</span>
<span class="p">;;</span><span class="w"> </span><span class="err">`</span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">K1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">K2</span><span class="err">`</span><span class="w"> </span><span class="o">-</span><span class="p">-&gt;</span><span class="w"> </span><span class="err">`</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">K2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">K1</span><span class="err">`</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">eq</span><span class="w"> </span><span class="n">ty1</span><span class="w"> </span><span class="p">(</span><span class="n">isub</span><span class="w"> </span><span class="n">ty2</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">k1</span><span class="o">@</span><span class="p">(</span><span class="n">iconst</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">_</span><span class="p">))</span><span class="w"> </span><span class="n">k2</span><span class="o">@</span><span class="p">(</span><span class="n">iconst</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">_</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="n">eq</span><span class="w"> </span><span class="n">ty1</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">ty2</span><span class="w"> </span><span class="n">k2</span><span class="w"> </span><span class="n">k1</span><span class="p">)))</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty1</span><span class="w"> </span><span class="p">(</span><span class="n">isub</span><span class="w"> </span><span class="n">ty2</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">k1</span><span class="o">@</span><span class="p">(</span><span class="n">iconst</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">_</span><span class="p">))</span><span class="w"> </span><span class="n">k2</span><span class="o">@</span><span class="p">(</span><span class="n">iconst</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">_</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty1</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">ty2</span><span class="w"> </span><span class="n">k2</span><span class="w"> </span><span class="n">k1</span><span class="p">)))</span>
<span class="p">;;</span><span class="w"> </span><span class="err">`</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">K1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">K2</span><span class="err">`</span><span class="w"> </span><span class="o">-</span><span class="p">-&gt;</span><span class="w"> </span><span class="err">`</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">K2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">K1</span><span class="p">)</span><span class="err">`</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">eq</span><span class="w"> </span><span class="n">ty1</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">ty2</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">k1</span><span class="o">@</span><span class="p">(</span><span class="n">iconst</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">_</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">ty3</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">k2</span><span class="o">@</span><span class="p">(</span><span class="n">iconst</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">_</span><span class="p">))))</span>
<span class="w">      </span><span class="p">(</span><span class="n">eq</span><span class="w"> </span><span class="n">ty1</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">ty2</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="p">(</span><span class="n">isub</span><span class="w"> </span><span class="n">ty3</span><span class="w"> </span><span class="n">k2</span><span class="w"> </span><span class="n">k1</span><span class="p">))))</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty1</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">ty2</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">k1</span><span class="o">@</span><span class="p">(</span><span class="n">iconst</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">_</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">ty3</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">k2</span><span class="o">@</span><span class="p">(</span><span class="n">iconst</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">_</span><span class="p">))))</span>
<span class="w">      </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty1</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">ty2</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="p">(</span><span class="n">isub</span><span class="w"> </span><span class="n">ty3</span><span class="w"> </span><span class="n">k2</span><span class="w"> </span><span class="n">k1</span><span class="p">))))</span>

<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">ty</span>
<span class="w">                      </span><span class="p">(</span><span class="n">isub</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="n">iconst</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">u64_from_imm64</span><span class="w"> </span><span class="n">k1</span><span class="p">)))</span>
<span class="w">                      </span><span class="p">(</span><span class="n">iconst</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">u64_from_imm64</span><span class="w"> </span><span class="n">k2</span><span class="p">))))</span>
<span class="w">      </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="n">iconst</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">imm64_masked</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">u64_wrapping_sub</span><span class="w"> </span><span class="n">k2</span><span class="w"> </span><span class="n">k1</span><span class="p">)))))</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">ty</span>
<span class="w">                      </span><span class="p">(</span><span class="n">isub</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">iconst</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">u64_from_imm64</span><span class="w"> </span><span class="n">k1</span><span class="p">))</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">                      </span><span class="p">(</span><span class="n">iconst</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">u64_from_imm64</span><span class="w"> </span><span class="n">k2</span><span class="p">))))</span>
<span class="w">      </span><span class="p">(</span><span class="n">isub</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">iconst</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">imm64_masked</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">u64_wrapping_add</span><span class="w"> </span><span class="n">k1</span><span class="w"> </span><span class="n">k2</span><span class="p">)))</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>

<span class="p">;;</span><span class="w"> </span><span class="n">iconst_</span><span class="p">[</span><span class="n">su</span><span class="p">]</span><span class="w"> </span><span class="n">support</span><span class="w"> </span><span class="cp">$I128</span><span class="p">,</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="kr">do</span><span class="w"> </span><span class="n">so</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">extending</span><span class="p">,</span><span class="w"> </span><span class="n">so</span><span class="w"> </span><span class="n">restricting</span><span class="w"> </span><span class="n">to</span>
<span class="p">;;</span><span class="w"> </span><span class="mi">64</span><span class="o">-</span><span class="n">bit</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">smaller</span><span class="w"> </span><span class="n">keeps</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">just</span><span class="w"> </span><span class="n">remaking</span><span class="w"> </span><span class="n">essentially</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">same</span><span class="w"> </span><span class="n">thing</span><span class="p">.</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">uextend</span><span class="w"> </span><span class="p">(</span><span class="n">fits_in_64</span><span class="w"> </span><span class="n">wide</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">iconst_u</span><span class="w"> </span><span class="n">narrow</span><span class="w"> </span><span class="n">k</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="n">subsume</span><span class="w"> </span><span class="p">(</span><span class="n">iconst_u</span><span class="w"> </span><span class="n">wide</span><span class="w"> </span><span class="n">k</span><span class="p">)))</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">sextend</span><span class="w"> </span><span class="p">(</span><span class="n">fits_in_64</span><span class="w"> </span><span class="n">wide</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">iconst_s</span><span class="w"> </span><span class="n">narrow</span><span class="w"> </span><span class="n">k</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="n">subsume</span><span class="w"> </span><span class="p">(</span><span class="n">iconst_s</span><span class="w"> </span><span class="n">wide</span><span class="w"> </span><span class="n">k</span><span class="p">)))</span>

<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span>
<span class="w">       </span><span class="p">(</span><span class="n">isub</span><span class="w"> </span><span class="p">(</span><span class="n">fits_in_64</span><span class="w"> </span><span class="n">ty</span><span class="p">)</span>
<span class="w">             </span><span class="p">(</span><span class="n">iconst</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">u64_from_imm64</span><span class="w"> </span><span class="n">k1</span><span class="p">))</span>
<span class="w">             </span><span class="p">(</span><span class="n">iconst</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">u64_from_imm64</span><span class="w"> </span><span class="n">k2</span><span class="p">))))</span>
<span class="w">      </span><span class="p">(</span><span class="n">subsume</span><span class="w"> </span><span class="p">(</span><span class="n">iconst</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">imm64_masked</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">u64_wrapping_sub</span><span class="w"> </span><span class="n">k1</span><span class="w"> </span><span class="n">k2</span><span class="p">)))))</span>

<span class="p">;;</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">x</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">isub</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="n">y</span><span class="p">))</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="p">(</span><span class="n">isub</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)))</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>

<span class="p">;;</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">-</span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">x</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">isub</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="p">))</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">isub</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="n">y</span><span class="p">))</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>

<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify_skeleton</span><span class="w"> </span><span class="p">(</span><span class="n">urem</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="n">iconst_u</span><span class="w"> </span><span class="cp">$I32</span><span class="w"> </span><span class="p">(</span><span class="n">u64_extract_non_zero</span><span class="w"> </span><span class="p">(</span><span class="n">u32_from_u64</span><span class="w"> </span><span class="n">d</span><span class="p">)))))</span>
<span class="w">      </span><span class="p">(</span><span class="k">if</span><span class="o">-</span><span class="kd">let</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="p">(</span><span class="n">u32_is_power_of_two</span><span class="w"> </span><span class="n">d</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="n">apply_div_const_magic_u32</span><span class="w"> </span><span class="p">(</span><span class="n">Opcode</span><span class="p">.</span><span class="n">Urem</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">d</span><span class="p">))</span>

<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify_skeleton</span><span class="w"> </span><span class="p">(</span><span class="n">udiv</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="n">iconst_u</span><span class="w"> </span><span class="cp">$I32</span><span class="w"> </span><span class="p">(</span><span class="n">u64_extract_non_zero</span><span class="w"> </span><span class="p">(</span><span class="n">u32_from_u64</span><span class="w"> </span><span class="n">d</span><span class="p">)))))</span>
<span class="w">      </span><span class="p">(</span><span class="k">if</span><span class="o">-</span><span class="kd">let</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="p">(</span><span class="n">u32_is_power_of_two</span><span class="w"> </span><span class="n">d</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="n">apply_div_const_magic_u32</span><span class="w"> </span><span class="p">(</span><span class="n">Opcode</span><span class="p">.</span><span class="n">Udiv</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">d</span><span class="p">))</span>

<span class="p">;;</span><span class="w"> </span><span class="mi">0</span><span class="o">-</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">(</span><span class="n">ineg</span><span class="w"> </span><span class="n">x</span><span class="p">).</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">isub</span><span class="w"> </span><span class="n">ty</span>
<span class="w">                      </span><span class="p">(</span><span class="n">iconst_u</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">                      </span><span class="n">x</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="n">ineg</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
</code></pre></div>
<p>A performance regression is observed from the no-opt Cranelift with each of these rules.<br>
For experiment, I removed all of these rules, and could reduce the perf regression to -2.24% but failed to eliminate all.</p>
<p>Here are the overall data.</p>
<ul>
<li>Fix1 is the Cranelift version without the perf-regressing rules for <code>shootout-switch</code> (See <a href="https://github.com/bytecodealliance/wasmtime/issues/12139#issuecomment-3650453592">https://github.com/bytecodealliance/wasmtime/issues/12139#issuecomment-3650453592</a>)</li>
<li>Fix2 is the Cranelift version without the perf-regressing rules for <code>pulldown-cmark</code> (See above)</li>
</ul>
<table>
<thead>
<tr>
<th>Benchmark</th>
<th style="text-align: right;">Fix1 Speedup</th>
<th style="text-align: right;">Fix2 Speedup</th>
<th style="text-align: right;">Main Speedup</th>
</tr>
</thead>
<tbody>
<tr>
<td>blake3-scalar</td>
<td style="text-align: right;">-0.69%</td>
<td style="text-align: right;">-0.27%</td>
<td style="text-align: right;">0.11%</td>
</tr>
<tr>
<td>blake3-simd</td>
<td style="text-align: right;">0.64%</td>
<td style="text-align: right;">0.82%</td>
<td style="text-align: right;">2.51%</td>
</tr>
<tr>
<td>bz2</td>
<td style="text-align: right;">0.36%</td>
<td style="text-align: right;">0.22%</td>
<td style="text-align: right;">0.99%</td>
</tr>
<tr>
<td>pulldown-cmark</td>
<td style="text-align: right;">-5.08%</td>
<td style="text-align: right;">-2.24%</td>
<td style="text-align: right;">-5.28%</td>
</tr>
<tr>
<td>regex</td>
<td style="text-align: right;">-0.51%</td>
<td style="text-align: right;">0.77%</td>
<td style="text-align: right;">-0.11%</td>
</tr>
<tr>
<td>shootout-ackermann</td>
<td style="text-align: right;">-1.39%</td>
<td style="text-align: right;">-1.52%</td>
<td style="text-align: right;">9.63%</td>
</tr>
<tr>
<td>shootout-base64</td>
<td style="text-align: right;">8.93%</td>
<td style="text-align: right;">7.04%</td>
<td style="text-align: right;">8.23%</td>
</tr>
<tr>
<td>shootout-ctype</td>
<td style="text-align: right;">1.07%</td>
<td style="text-align: right;">1.06%</td>
<td style="text-align: right;">4.30%</td>
</tr>
<tr>
<td>shootout-ed25519</td>
<td style="text-align: right;">1.83%</td>
<td style="text-align: right;">0.70%</td>
<td style="text-align: right;">1.96%</td>
</tr>
<tr>
<td>shootout-fib2</td>
<td style="text-align: right;">0.06%</td>
<td style="text-align: right;">0.08%</td>
<td style="text-align: right;">0.03%</td>
</tr>
<tr>
<td>shootout-gimli</td>
<td style="text-align: right;">-0.27%</td>
<td style="text-align: right;">-0.16%</td>
<td style="text-align: right;">-1.33%</td>
</tr>
<tr>
<td>shootout-heapsort</td>
<td style="text-align: right;">-2.33%</td>
<td style="text-align: right;">-0.76%</td>
<td style="text-align: right;">0.08%</td>
</tr>
<tr>
<td>shootout-keccak</td>
<td style="text-align: right;">19.10%</td>
<td style="text-align: right;">19.11%</td>
<td style="text-align: right;">19.10%</td>
</tr>
<tr>
<td>shootout-matrix</td>
<td style="text-align: right;">0.17%</td>
<td style="text-align: right;">0.24%</td>
<td style="text-align: right;">-0.19%</td>
</tr>
<tr>
<td>shootout-memmove</td>
<td style="text-align: right;">-6.34%</td>
<td style="text-align: right;">-6.27%</td>
<td style="text-align: right;">-0.17%</td>
</tr>
<tr>
<td>shootout-minicsv</td>
<td style="text-align: right;">0.68%</td>
<td style="text-align: right;">0.69%</td>
<td style="text-align: right;">14.62%</td>
</tr>
<tr>
<td>shootout-nestedloop</td>
<td style="text-align: right;">-11.25%</td>
<td style="text-align: right;">4.71%</td>
<td style="text-align: right;">-4.75%</td>
</tr>
<tr>
<td>shootout-random</td>
<td style="text-align: right;">43.37%</td>
<td style="text-align: right;">0.00%</td>
<td style="text-align: right;">43.35%</td>
</tr>
<tr>
<td>shootout-ratelimit</td>
<td style="text-align: right;">-0.39%</td>
<td style="text-align: right;">-0.52%</td>
<td style="text-align: right;">-2.00%</td>
</tr>
<tr>
<td>shootout-seqhash</td>
<td style="text-align: right;">-0.85%</td>
<td style="text-align: right;">-1.55%</td>
<td style="text-align: right;">1.84%</td>
</tr>
<tr>
<td>shootout-sieve</td>
<td style="text-align: right;">0.07%</td>
<td style="text-align: right;">-0.03%</td>
<td style="text-align: right;">7.77%</td>
</tr>
<tr>
<td>shootout-switch</td>
<td style="text-align: right;">0.03%</td>
<td style="text-align: right;">0.00%</td>
<td style="text-align: right;">-9.20%</td>
</tr>
<tr>
<td>shootout-xblabla20</td>
<td style="text-align: right;">-3.06%</td>
<td style="text-align: right;">-3.14%</td>
<td style="text-align: right;">-0.34%</td>
</tr>
<tr>
<td>shootout-xchacha20</td>
<td style="text-align: right;">0.15%</td>
<td style="text-align: right;">-0.36%</td>
<td style="text-align: right;">0.00%</td>
</tr>
<tr>
<td>spidermonkey</td>
<td style="text-align: right;">-1.66%</td>
<td style="text-align: right;">-2.58%</td>
<td style="text-align: right;">0.58%</td>
</tr>
</tbody>
</table>
<p>You can see that the performance is restored completely  for <code>shootout-switch</code> and partially for <code>pulldown-cmark</code>.<br>
But we are losing at <code>shootout-ackermann</code>, <code>shootout-base64</code>, <code>shootout-heapsort</code>, <code>shootout-memmove</code>, <code>spidermonkey</code> and others.</p>
<p>Probably it is the time to tap in the backend codegen/instruction scheduling/register allocation because a subtle change in IR is causing a surprising performance regression. I suspect the codegen is not handling IRs transformed by the mid-end optimizations and can produce a quality code only for non-optimized codes. For example, the following IR transformation (no-opt to base) in <code>pulldown-cmark</code></p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="w"> </span>       v3555 = isub.i32 v8, v9
<span class="gd">-@8917  v3100 = iconst.i32 40</span>
<span class="gd">-       v3558 = iadd v3555, v3100  ; v3100 = 40</span>
<span class="gd">-@87b9  v2349 = call fn11(v0, v0, v34, v3558)</span>
<span class="gi">+       v3602 = iconst.i32 -24</span>
<span class="gi">+       v3603 = iadd.i32 v8, v3602  ; v3602 = -24</span>
<span class="gi">+@87b9  v2349 = call fn11(v0, v0, v34, v3603)</span>
</code></pre></div>
<p>changed</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="mi">3</span><span class="n">b9a</span><span class="p">:</span><span class="w">   </span><span class="nc">mov</span><span class="w">    </span><span class="n">r8</span><span class="p">,</span><span class="n">rcx</span>
<span class="mi">3</span><span class="n">b9d</span><span class="p">:</span><span class="w">   </span><span class="nc">sub</span><span class="w">    </span><span class="n">r8d</span><span class="p">,</span><span class="mh">0x40</span>
<span class="mi">3</span><span class="n">ba1</span><span class="p">:</span><span class="w">   </span><span class="nc">mov</span><span class="w">    </span><span class="n">rax</span><span class="p">,</span><span class="n">QWORD</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span><span class="p">[</span><span class="n">rsp</span><span class="o">+</span><span class="mh">0x30</span><span class="p">]</span>
<span class="mi">3</span><span class="n">ba6</span><span class="p">:</span><span class="w">   </span><span class="nc">mov</span><span class="w">    </span><span class="n">DWORD</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span><span class="p">[</span><span class="n">rbx</span><span class="o">+</span><span class="n">r8</span><span class="o">*</span><span class="mi">1</span><span class="o">+</span><span class="mh">0x3c</span><span class="p">],</span><span class="n">eax</span>
<span class="mi">3</span><span class="n">bab</span><span class="p">:</span><span class="w">   </span><span class="nc">mov</span><span class="w">    </span><span class="n">rcx</span><span class="p">,</span><span class="n">QWORD</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span><span class="p">[</span><span class="n">rsp</span><span class="o">+</span><span class="mh">0x48</span><span class="p">]</span>
<span class="mi">3</span><span class="n">bb0</span><span class="p">:</span><span class="w">   </span><span class="nc">mov</span><span class="w">    </span><span class="n">DWORD</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span><span class="p">[</span><span class="n">rbx</span><span class="o">+</span><span class="n">r8</span><span class="o">*</span><span class="mi">1</span><span class="o">+</span><span class="mh">0x38</span><span class="p">],</span><span class="n">ecx</span>
<span class="mi">3</span><span class="n">bb5</span><span class="p">:</span><span class="w">   </span><span class="nc">mov</span><span class="w">    </span><span class="n">r10d</span><span class="p">,</span><span class="mh">0x1</span>
<span class="mi">3</span><span class="n">bbb</span><span class="p">:</span><span class="w">   </span><span class="nc">mov</span><span class="w">    </span><span class="n">BYTE</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span><span class="p">[</span><span class="n">rbx</span><span class="o">+</span><span class="n">r8</span><span class="o">*</span><span class="mi">1</span><span class="o">+</span><span class="mh">0x28</span><span class="p">],</span><span class="n">r10b</span>
<span class="mi">3</span><span class="n">bc0</span><span class="p">:</span><span class="w">   </span><span class="nc">mov</span><span class="w">    </span><span class="n">r11</span><span class="p">,</span><span class="n">QWORD</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span><span class="p">[</span><span class="n">rsp</span><span class="o">+</span><span class="mh">0x20</span><span class="p">]</span>
<span class="mi">3</span><span class="n">bc5</span><span class="p">:</span><span class="w">   </span><span class="nc">lea</span><span class="w">    </span><span class="n">edx</span><span class="p">,[</span><span class="n">r11</span><span class="o">+</span><span class="mh">0x5c</span><span class="p">]</span>
<span class="mi">3</span><span class="n">bc9</span><span class="p">:</span><span class="w">   </span><span class="nc">lea</span><span class="w">    </span><span class="n">ecx</span><span class="p">,[</span><span class="n">r8</span><span class="o">+</span><span class="mh">0x28</span><span class="p">]</span>
<span class="o">..</span><span class="p">.</span>
</code></pre></div>
<p>to</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="mf">3e8</span><span class="n">b</span><span class="p">:</span><span class="w">   </span><span class="nc">sub</span><span class="w">    </span><span class="n">r9d</span><span class="p">,</span><span class="mh">0x40</span>
<span class="mf">3e8</span><span class="n">f</span><span class="p">:</span><span class="w">   </span><span class="nc">mov</span><span class="w">    </span><span class="n">rdi</span><span class="p">,</span><span class="n">QWORD</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span><span class="p">[</span><span class="n">rsp</span><span class="o">+</span><span class="mh">0xc8</span><span class="p">]</span>
<span class="mf">3e97</span><span class="p">:</span><span class="w">   </span><span class="nc">mov</span><span class="w">    </span><span class="n">r8</span><span class="p">,</span><span class="n">QWORD</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span><span class="p">[</span><span class="n">rsp</span><span class="o">+</span><span class="mh">0x30</span><span class="p">]</span>
<span class="mf">3e9</span><span class="n">c</span><span class="p">:</span><span class="w">   </span><span class="nc">mov</span><span class="w">    </span><span class="n">DWORD</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span><span class="p">[</span><span class="n">rdi</span><span class="o">+</span><span class="n">r9</span><span class="o">*</span><span class="mi">1</span><span class="o">+</span><span class="mh">0x3c</span><span class="p">],</span><span class="n">r8d</span>
<span class="mi">3</span><span class="n">ea1</span><span class="p">:</span><span class="w">   </span><span class="nc">mov</span><span class="w">    </span><span class="n">rcx</span><span class="p">,</span><span class="n">QWORD</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span><span class="p">[</span><span class="n">rsp</span><span class="o">+</span><span class="mh">0x48</span><span class="p">]</span>
<span class="mi">3</span><span class="n">ea6</span><span class="p">:</span><span class="w">   </span><span class="nc">mov</span><span class="w">    </span><span class="n">DWORD</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span><span class="p">[</span><span class="n">rdi</span><span class="o">+</span><span class="n">r9</span><span class="o">*</span><span class="mi">1</span><span class="o">+</span><span class="mh">0x38</span><span class="p">],</span><span class="n">ecx</span>
<span class="mi">3</span><span class="n">eab</span><span class="p">:</span><span class="w">   </span><span class="nc">mov</span><span class="w">    </span><span class="n">r11d</span><span class="p">,</span><span class="mh">0x1</span>
<span class="mi">3</span><span class="n">eb1</span><span class="p">:</span><span class="w">   </span><span class="nc">mov</span><span class="w">    </span><span class="n">BYTE</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span><span class="p">[</span><span class="n">rdi</span><span class="o">+</span><span class="n">r9</span><span class="o">*</span><span class="mi">1</span><span class="o">+</span><span class="mh">0x28</span><span class="p">],</span><span class="n">r11b</span>
<span class="mi">3</span><span class="n">eb6</span><span class="p">:</span><span class="w">   </span><span class="nc">mov</span><span class="w">    </span><span class="n">r8</span><span class="p">,</span><span class="n">QWORD</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span><span class="p">[</span><span class="n">rsp</span><span class="o">+</span><span class="mh">0x20</span><span class="p">]</span>
<span class="mi">3</span><span class="n">ebb</span><span class="p">:</span><span class="w">   </span><span class="nc">lea</span><span class="w">    </span><span class="n">edx</span><span class="p">,[</span><span class="n">r8</span><span class="o">+</span><span class="mh">0x5c</span><span class="p">]</span>
<span class="mi">3</span><span class="n">ebf</span><span class="p">:</span><span class="w">   </span><span class="nc">mov</span><span class="w">    </span><span class="n">r9</span><span class="p">,</span><span class="n">QWORD</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span><span class="p">[</span><span class="n">rsp</span><span class="o">+</span><span class="mh">0xd0</span><span class="p">]</span>
<span class="mi">3</span><span class="n">ec7</span><span class="p">:</span><span class="w">   </span><span class="nc">lea</span><span class="w">    </span><span class="n">ecx</span><span class="p">,[</span><span class="n">r9</span><span class="o">-</span><span class="mh">0x18</span><span class="p">]</span>
<span class="o">..</span><span class="p">.</span>
</code></pre></div>
<p>Notice that there are more spills/loads.<br>
Similar regression happens for <code>shootout-switch</code> (one jump to two jumps) with a slight change in IR.</p>
</blockquote>



<a name="563763508"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312139%20Cranelift%3A%20ISLE%20mid-end%20performan.../near/563763508" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312139.20Cranelift.3A.20ISLE.20mid-end.20performan.2E.2E.2E.html#563763508">(Dec 15 2025 at 08:53)</a>:</h4>
<p>bongjunj edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/12139#issuecomment-3654459431">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12139">issue #12139</a>:</p>
<blockquote>
<p>I delta-debugged to locate rules that is causing performance regression for <code>pulldown-cmark</code>  and found out a list of rules:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="n">k</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="n">subsume</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)))</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="n">b</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="n">subsume</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)))</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="n">k</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="n">subsume</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)))</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="n">b</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="n">subsume</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)))</span>

<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">isub</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">ishl</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">z</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">ishl</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">z</span><span class="p">)))</span><span class="w"> </span><span class="p">(</span><span class="n">ishl</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">isub</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="n">z</span><span class="p">))</span>

<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">uextend</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">uextend</span><span class="w"> </span><span class="n">_intermediate_ty</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="n">uextend</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">sextend</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">sextend</span><span class="w"> </span><span class="n">_intermediate_ty</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="n">sextend</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>

<span class="p">;;</span><span class="w"> </span><span class="n">Reassociate</span><span class="w"> </span><span class="n">across</span><span class="w"> </span><span class="err">`</span><span class="o">==</span><span class="err">`</span><span class="o">/</span><span class="err">`</span><span class="o">!=</span><span class="err">`</span><span class="w"> </span><span class="n">when</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">simplify</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">constant</span>
<span class="p">;;</span><span class="w"> </span><span class="err">`</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">K1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">K2</span><span class="err">`</span><span class="w"> </span><span class="o">-</span><span class="p">-&gt;</span><span class="w"> </span><span class="err">`</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">K2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">K1</span><span class="err">`</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">eq</span><span class="w"> </span><span class="n">ty1</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">ty2</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">k1</span><span class="o">@</span><span class="p">(</span><span class="n">iconst</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">_</span><span class="p">))</span><span class="w"> </span><span class="n">k2</span><span class="o">@</span><span class="p">(</span><span class="n">iconst</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">_</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="n">eq</span><span class="w"> </span><span class="n">ty1</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="n">isub</span><span class="w"> </span><span class="n">ty2</span><span class="w"> </span><span class="n">k2</span><span class="w"> </span><span class="n">k1</span><span class="p">)))</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty1</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">ty2</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">k1</span><span class="o">@</span><span class="p">(</span><span class="n">iconst</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">_</span><span class="p">))</span><span class="w"> </span><span class="n">k2</span><span class="o">@</span><span class="p">(</span><span class="n">iconst</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">_</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty1</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="n">isub</span><span class="w"> </span><span class="n">ty2</span><span class="w"> </span><span class="n">k2</span><span class="w"> </span><span class="n">k1</span><span class="p">)))</span>
<span class="p">;;</span><span class="w"> </span><span class="err">`</span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">K1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">K2</span><span class="err">`</span><span class="w"> </span><span class="o">-</span><span class="p">-&gt;</span><span class="w"> </span><span class="err">`</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">K2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">K1</span><span class="err">`</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">eq</span><span class="w"> </span><span class="n">ty1</span><span class="w"> </span><span class="p">(</span><span class="n">isub</span><span class="w"> </span><span class="n">ty2</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">k1</span><span class="o">@</span><span class="p">(</span><span class="n">iconst</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">_</span><span class="p">))</span><span class="w"> </span><span class="n">k2</span><span class="o">@</span><span class="p">(</span><span class="n">iconst</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">_</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="n">eq</span><span class="w"> </span><span class="n">ty1</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">ty2</span><span class="w"> </span><span class="n">k2</span><span class="w"> </span><span class="n">k1</span><span class="p">)))</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty1</span><span class="w"> </span><span class="p">(</span><span class="n">isub</span><span class="w"> </span><span class="n">ty2</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">k1</span><span class="o">@</span><span class="p">(</span><span class="n">iconst</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">_</span><span class="p">))</span><span class="w"> </span><span class="n">k2</span><span class="o">@</span><span class="p">(</span><span class="n">iconst</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">_</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty1</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">ty2</span><span class="w"> </span><span class="n">k2</span><span class="w"> </span><span class="n">k1</span><span class="p">)))</span>
<span class="p">;;</span><span class="w"> </span><span class="err">`</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">K1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">K2</span><span class="err">`</span><span class="w"> </span><span class="o">-</span><span class="p">-&gt;</span><span class="w"> </span><span class="err">`</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">K2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">K1</span><span class="p">)</span><span class="err">`</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">eq</span><span class="w"> </span><span class="n">ty1</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">ty2</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">k1</span><span class="o">@</span><span class="p">(</span><span class="n">iconst</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">_</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">ty3</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">k2</span><span class="o">@</span><span class="p">(</span><span class="n">iconst</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">_</span><span class="p">))))</span>
<span class="w">      </span><span class="p">(</span><span class="n">eq</span><span class="w"> </span><span class="n">ty1</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">ty2</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="p">(</span><span class="n">isub</span><span class="w"> </span><span class="n">ty3</span><span class="w"> </span><span class="n">k2</span><span class="w"> </span><span class="n">k1</span><span class="p">))))</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty1</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">ty2</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">k1</span><span class="o">@</span><span class="p">(</span><span class="n">iconst</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">_</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">ty3</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">k2</span><span class="o">@</span><span class="p">(</span><span class="n">iconst</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="n">_</span><span class="p">))))</span>
<span class="w">      </span><span class="p">(</span><span class="n">ne</span><span class="w"> </span><span class="n">ty1</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">ty2</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="p">(</span><span class="n">isub</span><span class="w"> </span><span class="n">ty3</span><span class="w"> </span><span class="n">k2</span><span class="w"> </span><span class="n">k1</span><span class="p">))))</span>

<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">ty</span>
<span class="w">                      </span><span class="p">(</span><span class="n">isub</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="n">iconst</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">u64_from_imm64</span><span class="w"> </span><span class="n">k1</span><span class="p">)))</span>
<span class="w">                      </span><span class="p">(</span><span class="n">iconst</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">u64_from_imm64</span><span class="w"> </span><span class="n">k2</span><span class="p">))))</span>
<span class="w">      </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="n">iconst</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">imm64_masked</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">u64_wrapping_sub</span><span class="w"> </span><span class="n">k2</span><span class="w"> </span><span class="n">k1</span><span class="p">)))))</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">ty</span>
<span class="w">                      </span><span class="p">(</span><span class="n">isub</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">iconst</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">u64_from_imm64</span><span class="w"> </span><span class="n">k1</span><span class="p">))</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="w">                      </span><span class="p">(</span><span class="n">iconst</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">u64_from_imm64</span><span class="w"> </span><span class="n">k2</span><span class="p">))))</span>
<span class="w">      </span><span class="p">(</span><span class="n">isub</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">iconst</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">imm64_masked</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">u64_wrapping_add</span><span class="w"> </span><span class="n">k1</span><span class="w"> </span><span class="n">k2</span><span class="p">)))</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>

<span class="p">;;</span><span class="w"> </span><span class="n">iconst_</span><span class="p">[</span><span class="n">su</span><span class="p">]</span><span class="w"> </span><span class="n">support</span><span class="w"> </span><span class="cp">$I128</span><span class="p">,</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="kr">do</span><span class="w"> </span><span class="n">so</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">extending</span><span class="p">,</span><span class="w"> </span><span class="n">so</span><span class="w"> </span><span class="n">restricting</span><span class="w"> </span><span class="n">to</span>
<span class="p">;;</span><span class="w"> </span><span class="mi">64</span><span class="o">-</span><span class="n">bit</span><span class="w"> </span><span class="n">or</span><span class="w"> </span><span class="n">smaller</span><span class="w"> </span><span class="n">keeps</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">just</span><span class="w"> </span><span class="n">remaking</span><span class="w"> </span><span class="n">essentially</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">same</span><span class="w"> </span><span class="n">thing</span><span class="p">.</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">uextend</span><span class="w"> </span><span class="p">(</span><span class="n">fits_in_64</span><span class="w"> </span><span class="n">wide</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">iconst_u</span><span class="w"> </span><span class="n">narrow</span><span class="w"> </span><span class="n">k</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="n">subsume</span><span class="w"> </span><span class="p">(</span><span class="n">iconst_u</span><span class="w"> </span><span class="n">wide</span><span class="w"> </span><span class="n">k</span><span class="p">)))</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">sextend</span><span class="w"> </span><span class="p">(</span><span class="n">fits_in_64</span><span class="w"> </span><span class="n">wide</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">iconst_s</span><span class="w"> </span><span class="n">narrow</span><span class="w"> </span><span class="n">k</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="n">subsume</span><span class="w"> </span><span class="p">(</span><span class="n">iconst_s</span><span class="w"> </span><span class="n">wide</span><span class="w"> </span><span class="n">k</span><span class="p">)))</span>

<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span>
<span class="w">       </span><span class="p">(</span><span class="n">isub</span><span class="w"> </span><span class="p">(</span><span class="n">fits_in_64</span><span class="w"> </span><span class="n">ty</span><span class="p">)</span>
<span class="w">             </span><span class="p">(</span><span class="n">iconst</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">u64_from_imm64</span><span class="w"> </span><span class="n">k1</span><span class="p">))</span>
<span class="w">             </span><span class="p">(</span><span class="n">iconst</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">u64_from_imm64</span><span class="w"> </span><span class="n">k2</span><span class="p">))))</span>
<span class="w">      </span><span class="p">(</span><span class="n">subsume</span><span class="w"> </span><span class="p">(</span><span class="n">iconst</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">imm64_masked</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">u64_wrapping_sub</span><span class="w"> </span><span class="n">k1</span><span class="w"> </span><span class="n">k2</span><span class="p">)))))</span>

<span class="p">;;</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">x</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">isub</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="n">y</span><span class="p">))</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="p">(</span><span class="n">isub</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)))</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>

<span class="p">;;</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">-</span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">x</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">isub</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="p">))</span><span class="w"> </span><span class="n">y</span><span class="p">)</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">isub</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">iadd</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="n">y</span><span class="p">))</span><span class="w"> </span><span class="n">x</span><span class="p">)</span>

<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify_skeleton</span><span class="w"> </span><span class="p">(</span><span class="n">urem</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="n">iconst_u</span><span class="w"> </span><span class="cp">$I32</span><span class="w"> </span><span class="p">(</span><span class="n">u64_extract_non_zero</span><span class="w"> </span><span class="p">(</span><span class="n">u32_from_u64</span><span class="w"> </span><span class="n">d</span><span class="p">)))))</span>
<span class="w">      </span><span class="p">(</span><span class="k">if</span><span class="o">-</span><span class="kd">let</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="p">(</span><span class="n">u32_is_power_of_two</span><span class="w"> </span><span class="n">d</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="n">apply_div_const_magic_u32</span><span class="w"> </span><span class="p">(</span><span class="n">Opcode</span><span class="p">.</span><span class="n">Urem</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">d</span><span class="p">))</span>

<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify_skeleton</span><span class="w"> </span><span class="p">(</span><span class="n">udiv</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="n">iconst_u</span><span class="w"> </span><span class="cp">$I32</span><span class="w"> </span><span class="p">(</span><span class="n">u64_extract_non_zero</span><span class="w"> </span><span class="p">(</span><span class="n">u32_from_u64</span><span class="w"> </span><span class="n">d</span><span class="p">)))))</span>
<span class="w">      </span><span class="p">(</span><span class="k">if</span><span class="o">-</span><span class="kd">let</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="p">(</span><span class="n">u32_is_power_of_two</span><span class="w"> </span><span class="n">d</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="n">apply_div_const_magic_u32</span><span class="w"> </span><span class="p">(</span><span class="n">Opcode</span><span class="p">.</span><span class="n">Udiv</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">d</span><span class="p">))</span>

<span class="p">;;</span><span class="w"> </span><span class="mi">0</span><span class="o">-</span><span class="n">x</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">(</span><span class="n">ineg</span><span class="w"> </span><span class="n">x</span><span class="p">).</span>
<span class="p">(</span><span class="n">rule</span><span class="w"> </span><span class="p">(</span><span class="n">simplify</span><span class="w"> </span><span class="p">(</span><span class="n">isub</span><span class="w"> </span><span class="n">ty</span>
<span class="w">                      </span><span class="p">(</span><span class="n">iconst_u</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">                      </span><span class="n">x</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="n">ineg</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="n">x</span><span class="p">))</span>
</code></pre></div>
<p>A performance regression is observed from the no-opt Cranelift with each of these rules.<br>
For experiment, I removed all of these rules, and could reduce the perf regression to -2.24% but failed to eliminate all.</p>
<p>Here are the overall data.</p>
<ul>
<li>Fix1 is the Cranelift version without the perf-regressing rules for <code>shootout-switch</code> (See <a href="https://github.com/bytecodealliance/wasmtime/issues/12139#issuecomment-3650453592">https://github.com/bytecodealliance/wasmtime/issues/12139#issuecomment-3650453592</a>)</li>
<li>Fix2 is the Cranelift version without the perf-regressing rules for <code>pulldown-cmark</code> (See above)</li>
</ul>
<table>
<thead>
<tr>
<th>Benchmark</th>
<th style="text-align: right;">Fix1 Speedup</th>
<th style="text-align: right;">Fix2 Speedup</th>
<th style="text-align: right;">Main Speedup</th>
</tr>
</thead>
<tbody>
<tr>
<td>blake3-scalar</td>
<td style="text-align: right;">-0.69%</td>
<td style="text-align: right;">-0.27%</td>
<td style="text-align: right;">0.55%</td>
</tr>
<tr>
<td>blake3-simd</td>
<td style="text-align: right;">0.64%</td>
<td style="text-align: right;">0.82%</td>
<td style="text-align: right;">2.35%</td>
</tr>
<tr>
<td>bz2</td>
<td style="text-align: right;">0.36%</td>
<td style="text-align: right;">0.22%</td>
<td style="text-align: right;">1.05%</td>
</tr>
<tr>
<td>pulldown-cmark</td>
<td style="text-align: right;">-5.08%</td>
<td style="text-align: right;">-2.24%</td>
<td style="text-align: right;">0.59%</td>
</tr>
<tr>
<td>regex</td>
<td style="text-align: right;">-0.51%</td>
<td style="text-align: right;">0.77%</td>
<td style="text-align: right;">-0.22%</td>
</tr>
<tr>
<td>shootout-ackermann</td>
<td style="text-align: right;">-1.39%</td>
<td style="text-align: right;">-1.52%</td>
<td style="text-align: right;">9.74%</td>
</tr>
<tr>
<td>shootout-base64</td>
<td style="text-align: right;">8.93%</td>
<td style="text-align: right;">7.04%</td>
<td style="text-align: right;">8.22%</td>
</tr>
<tr>
<td>shootout-ctype</td>
<td style="text-align: right;">1.07%</td>
<td style="text-align: right;">1.06%</td>
<td style="text-align: right;">4.27%</td>
</tr>
<tr>
<td>shootout-ed25519</td>
<td style="text-align: right;">1.83%</td>
<td style="text-align: right;">0.70%</td>
<td style="text-align: right;">1.96%</td>
</tr>
<tr>
<td>shootout-fib2</td>
<td style="text-align: right;">0.06%</td>
<td style="text-align: right;">0.08%</td>
<td style="text-align: right;">0.08%</td>
</tr>
<tr>
<td>shootout-gimli</td>
<td style="text-align: right;">-0.27%</td>
<td style="text-align: right;">-0.16%</td>
<td style="text-align: right;">-1.46%</td>
</tr>
<tr>
<td>shootout-heapsort</td>
<td style="text-align: right;">-2.33%</td>
<td style="text-align: right;">-0.76%</td>
<td style="text-align: right;">0.11%</td>
</tr>
<tr>
<td>shootout-keccak</td>
<td style="text-align: right;">19.10%</td>
<td style="text-align: right;">19.11%</td>
<td style="text-align: right;">19.12%</td>
</tr>
<tr>
<td>shootout-matrix</td>
<td style="text-align: right;">0.17%</td>
<td style="text-align: right;">0.24%</td>
<td style="text-align: right;">0.81%</td>
</tr>
<tr>
<td>shootout-memmove</td>
<td style="text-align: right;">-6.34%</td>
<td style="text-align: right;">-6.27%</td>
<td style="text-align: right;">-0.60%</td>
</tr>
<tr>
<td>shootout-minicsv</td>
<td style="text-align: right;">0.68%</td>
<td style="text-align: right;">0.69%</td>
<td style="text-align: right;">15.46%</td>
</tr>
<tr>
<td>shootout-nestedloop</td>
<td style="text-align: right;">-11.25%</td>
<td style="text-align: right;">4.71%</td>
<td style="text-align: right;">3.71%</td>
</tr>
<tr>
<td>shootout-random</td>
<td style="text-align: right;">43.37%</td>
<td style="text-align: right;">0.00%</td>
<td style="text-align: right;">43.37%</td>
</tr>
<tr>
<td>shootout-ratelimit</td>
<td style="text-align: right;">-0.39%</td>
<td style="text-align: right;">-0.52%</td>
<td style="text-align: right;">-1.89%</td>
</tr>
<tr>
<td>shootout-seqhash</td>
<td style="text-align: right;">-0.85%</td>
<td style="text-align: right;">-1.55%</td>
<td style="text-align: right;">1.86%</td>
</tr>
<tr>
<td>shootout-sieve</td>
<td style="text-align: right;">0.07%</td>
<td style="text-align: right;">-0.03%</td>
<td style="text-align: right;">7.67%</td>
</tr>
<tr>
<td>shootout-switch</td>
<td style="text-align: right;">0.03%</td>
<td style="text-align: right;">0.00%</td>
<td style="text-align: right;">-9.16%</td>
</tr>
<tr>
<td>shootout-xblabla20</td>
<td style="text-align: right;">-3.06%</td>
<td style="text-align: right;">-3.14%</td>
<td style="text-align: right;">-0.31%</td>
</tr>
<tr>
<td>shootout-xchacha20</td>
<td style="text-align: right;">0.15%</td>
<td style="text-align: right;">-0.36%</td>
<td style="text-align: right;">0.07%</td>
</tr>
<tr>
<td>spidermonkey</td>
<td style="text-align: right;">-1.66%</td>
<td style="text-align: right;">-2.58%</td>
<td style="text-align: right;">0.24%</td>
</tr>
</tbody>
</table>
<p>You can see that the performance is restored completely  for <code>shootout-switch</code> and partially for <code>pulldown-cmark</code>.<br>
But we are losing at <code>shootout-ackermann</code>, <code>shootout-base64</code>, <code>shootout-heapsort</code>, <code>shootout-memmove</code>, <code>spidermonkey</code> and others.</p>
<p>Probably it is the time to tap in the backend codegen/instruction scheduling/register allocation because a subtle change in IR is causing a surprising performance regression. I suspect the codegen is not handling IRs transformed by the mid-end optimizations and can produce a quality code only for non-optimized codes. For example, the following IR transformation (no-opt to base) in <code>pulldown-cmark</code></p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="w"> </span>       v3555 = isub.i32 v8, v9
<span class="gd">-@8917  v3100 = iconst.i32 40</span>
<span class="gd">-       v3558 = iadd v3555, v3100  ; v3100 = 40</span>
<span class="gd">-@87b9  v2349 = call fn11(v0, v0, v34, v3558)</span>
<span class="gi">+       v3602 = iconst.i32 -24</span>
<span class="gi">+       v3603 = iadd.i32 v8, v3602  ; v3602 = -24</span>
<span class="gi">+@87b9  v2349 = call fn11(v0, v0, v34, v3603)</span>
</code></pre></div>
<p>changed</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="mi">3</span><span class="n">b9a</span><span class="p">:</span><span class="w">   </span><span class="nc">mov</span><span class="w">    </span><span class="n">r8</span><span class="p">,</span><span class="n">rcx</span>
<span class="mi">3</span><span class="n">b9d</span><span class="p">:</span><span class="w">   </span><span class="nc">sub</span><span class="w">    </span><span class="n">r8d</span><span class="p">,</span><span class="mh">0x40</span>
<span class="mi">3</span><span class="n">ba1</span><span class="p">:</span><span class="w">   </span><span class="nc">mov</span><span class="w">    </span><span class="n">rax</span><span class="p">,</span><span class="n">QWORD</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span><span class="p">[</span><span class="n">rsp</span><span class="o">+</span><span class="mh">0x30</span><span class="p">]</span>
<span class="mi">3</span><span class="n">ba6</span><span class="p">:</span><span class="w">   </span><span class="nc">mov</span><span class="w">    </span><span class="n">DWORD</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span><span class="p">[</span><span class="n">rbx</span><span class="o">+</span><span class="n">r8</span><span class="o">*</span><span class="mi">1</span><span class="o">+</span><span class="mh">0x3c</span><span class="p">],</span><span class="n">eax</span>
<span class="mi">3</span><span class="n">bab</span><span class="p">:</span><span class="w">   </span><span class="nc">mov</span><span class="w">    </span><span class="n">rcx</span><span class="p">,</span><span class="n">QWORD</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span><span class="p">[</span><span class="n">rsp</span><span class="o">+</span><span class="mh">0x48</span><span class="p">]</span>
<span class="mi">3</span><span class="n">bb0</span><span class="p">:</span><span class="w">   </span><span class="nc">mov</span><span class="w">    </span><span class="n">DWORD</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span><span class="p">[</span><span class="n">rbx</span><span class="o">+</span><span class="n">r8</span><span class="o">*</span><span class="mi">1</span><span class="o">+</span><span class="mh">0x38</span><span class="p">],</span><span class="n">ecx</span>
<span class="mi">3</span><span class="n">bb5</span><span class="p">:</span><span class="w">   </span><span class="nc">mov</span><span class="w">    </span><span class="n">r10d</span><span class="p">,</span><span class="mh">0x1</span>
<span class="mi">3</span><span class="n">bbb</span><span class="p">:</span><span class="w">   </span><span class="nc">mov</span><span class="w">    </span><span class="n">BYTE</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span><span class="p">[</span><span class="n">rbx</span><span class="o">+</span><span class="n">r8</span><span class="o">*</span><span class="mi">1</span><span class="o">+</span><span class="mh">0x28</span><span class="p">],</span><span class="n">r10b</span>
<span class="mi">3</span><span class="n">bc0</span><span class="p">:</span><span class="w">   </span><span class="nc">mov</span><span class="w">    </span><span class="n">r11</span><span class="p">,</span><span class="n">QWORD</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span><span class="p">[</span><span class="n">rsp</span><span class="o">+</span><span class="mh">0x20</span><span class="p">]</span>
<span class="mi">3</span><span class="n">bc5</span><span class="p">:</span><span class="w">   </span><span class="nc">lea</span><span class="w">    </span><span class="n">edx</span><span class="p">,[</span><span class="n">r11</span><span class="o">+</span><span class="mh">0x5c</span><span class="p">]</span>
<span class="mi">3</span><span class="n">bc9</span><span class="p">:</span><span class="w">   </span><span class="nc">lea</span><span class="w">    </span><span class="n">ecx</span><span class="p">,[</span><span class="n">r8</span><span class="o">+</span><span class="mh">0x28</span><span class="p">]</span>
<span class="o">..</span><span class="p">.</span>
</code></pre></div>
<p>to</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="mf">3e8</span><span class="n">b</span><span class="p">:</span><span class="w">   </span><span class="nc">sub</span><span class="w">    </span><span class="n">r9d</span><span class="p">,</span><span class="mh">0x40</span>
<span class="mf">3e8</span><span class="n">f</span><span class="p">:</span><span class="w">   </span><span class="nc">mov</span><span class="w">    </span><span class="n">rdi</span><span class="p">,</span><span class="n">QWORD</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span><span class="p">[</span><span class="n">rsp</span><span class="o">+</span><span class="mh">0xc8</span><span class="p">]</span>
<span class="mf">3e97</span><span class="p">:</span><span class="w">   </span><span class="nc">mov</span><span class="w">    </span><span class="n">r8</span><span class="p">,</span><span class="n">QWORD</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span><span class="p">[</span><span class="n">rsp</span><span class="o">+</span><span class="mh">0x30</span><span class="p">]</span>
<span class="mf">3e9</span><span class="n">c</span><span class="p">:</span><span class="w">   </span><span class="nc">mov</span><span class="w">    </span><span class="n">DWORD</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span><span class="p">[</span><span class="n">rdi</span><span class="o">+</span><span class="n">r9</span><span class="o">*</span><span class="mi">1</span><span class="o">+</span><span class="mh">0x3c</span><span class="p">],</span><span class="n">r8d</span>
<span class="mi">3</span><span class="n">ea1</span><span class="p">:</span><span class="w">   </span><span class="nc">mov</span><span class="w">    </span><span class="n">rcx</span><span class="p">,</span><span class="n">QWORD</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span><span class="p">[</span><span class="n">rsp</span><span class="o">+</span><span class="mh">0x48</span><span class="p">]</span>
<span class="mi">3</span><span class="n">ea6</span><span class="p">:</span><span class="w">   </span><span class="nc">mov</span><span class="w">    </span><span class="n">DWORD</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span><span class="p">[</span><span class="n">rdi</span><span class="o">+</span><span class="n">r9</span><span class="o">*</span><span class="mi">1</span><span class="o">+</span><span class="mh">0x38</span><span class="p">],</span><span class="n">ecx</span>
<span class="mi">3</span><span class="n">eab</span><span class="p">:</span><span class="w">   </span><span class="nc">mov</span><span class="w">    </span><span class="n">r11d</span><span class="p">,</span><span class="mh">0x1</span>
<span class="mi">3</span><span class="n">eb1</span><span class="p">:</span><span class="w">   </span><span class="nc">mov</span><span class="w">    </span><span class="n">BYTE</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span><span class="p">[</span><span class="n">rdi</span><span class="o">+</span><span class="n">r9</span><span class="o">*</span><span class="mi">1</span><span class="o">+</span><span class="mh">0x28</span><span class="p">],</span><span class="n">r11b</span>
<span class="mi">3</span><span class="n">eb6</span><span class="p">:</span><span class="w">   </span><span class="nc">mov</span><span class="w">    </span><span class="n">r8</span><span class="p">,</span><span class="n">QWORD</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span><span class="p">[</span><span class="n">rsp</span><span class="o">+</span><span class="mh">0x20</span><span class="p">]</span>
<span class="mi">3</span><span class="n">ebb</span><span class="p">:</span><span class="w">   </span><span class="nc">lea</span><span class="w">    </span><span class="n">edx</span><span class="p">,[</span><span class="n">r8</span><span class="o">+</span><span class="mh">0x5c</span><span class="p">]</span>
<span class="mi">3</span><span class="n">ebf</span><span class="p">:</span><span class="w">   </span><span class="nc">mov</span><span class="w">    </span><span class="n">r9</span><span class="p">,</span><span class="n">QWORD</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span><span class="p">[</span><span class="n">rsp</span><span class="o">+</span><span class="mh">0xd0</span><span class="p">]</span>
<span class="mi">3</span><span class="n">ec7</span><span class="p">:</span><span class="w">   </span><span class="nc">lea</span><span class="w">    </span><span class="n">ecx</span><span class="p">,[</span><span class="n">r9</span><span class="o">-</span><span class="mh">0x18</span><span class="p">]</span>
<span class="o">..</span><span class="p">.</span>
</code></pre></div>
<p>Notice that there are more spills/loads.<br>
Similar regression happens for <code>shootout-switch</code> (one jump to two jumps) with a slight change in IR.</p>
</blockquote>



<a name="563916675"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312139%20Cranelift%3A%20ISLE%20mid-end%20performan.../near/563916675" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312139.20Cranelift.3A.20ISLE.20mid-end.20performan.2E.2E.2E.html#563916675">(Dec 15 2025 at 20:18)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/issues/12139#issuecomment-3657421232">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12139">issue #12139</a>:</p>
<blockquote>
<p>Thanks (as always) for investigating and sharing your results with us, @bongjunj!</p>
<blockquote>
<p>My theory is that the rules in (1) interferes the loop back-edge.</p>
</blockquote>
<p>For (1) I suspect we just need to either</p>
<ul>
<li>remove the <code>subsume</code> from those canonicalizing rules, or</li>
<li>add missing x64 lowering rules that recognize the canonicalized form</li>
</ul>
<p>Probably the latter? Because it doesn't grow the number of enodes and lets us continue to do the most canonicalizing we can (and therefore the most const propagation we can).</p>
<p>Anyways, that CLIF snippet you isolated seems like it would be a great little filetest to add (even before we have a fix) and then we can have confidence that (a) whatever fix we implement does indeed fix that example code and (b) the codegen for this input pattern won't regress in the future.</p>
</blockquote>



<a name="563918866"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312139%20Cranelift%3A%20ISLE%20mid-end%20performan.../near/563918866" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312139.20Cranelift.3A.20ISLE.20mid-end.20performan.2E.2E.2E.html#563918866">(Dec 15 2025 at 20:30)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/issues/12139#issuecomment-3657466500">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12139">issue #12139</a>:</p>
<blockquote>
<blockquote>
<p>I am not sure this is an optimizing transformation which is intended):</p>
<p><code>diff
-          v3835 = iconst.i32 1
-          v3836 = iadd.i32 v1156, v3835  ; v3835 = 1
-          v3837 = iconst.i32 6
-@7fd7     v1163 = urem v3836, v3837  ; v3837 = 6
-@7fd8     br_table v1163, block201, [block200, block198, block199, block200, block199]
+          v3988 = iconst.i32 1
+          v3989 = iadd.i32 v1156, v3988  ; v3988 = 1
+          v3685 = iconst.i32 -1431655765
+          v3686 = umulhi v3989, v3685  ; v3685 = -1431655765
+          v3990 = iconst.i32 2
+          v3687 = ushr v3686, v3990  ; v3990 = 2
+          v3991 = iconst.i32 6
+          v3688 = imul v3687, v3991  ; v3991 = 6
+          v3689 = isub v3989, v3688
+          v1163 -&gt; v3689
+@7fd8     br_table v3689, block201, [block200, block198, block199, block200, block199]
</code></p>
</blockquote>
<p>This is almost definitely the result of our division/remainder to magic-sequence rules.</p>
<ul>
<li><a href="https://github.com/bytecodealliance/wasmtime/blob/ab030780b67ce79c8567cd245353a0e7f1e05d27/cranelift/codegen/src/opts/arithmetic.isle#L113-L127">https://github.com/bytecodealliance/wasmtime/blob/ab030780b67ce79c8567cd245353a0e7f1e05d27/cranelift/codegen/src/opts/arithmetic.isle#L113-L127</a></li>
<li><a href="https://github.com/bytecodealliance/wasmtime/blob/ab030780b67ce79c8567cd245353a0e7f1e05d27/cranelift/codegen/src/opts/div_const.rs">https://github.com/bytecodealliance/wasmtime/blob/ab030780b67ce79c8567cd245353a0e7f1e05d27/cranelift/codegen/src/opts/div_const.rs</a></li>
</ul>
<p>It produces more native instructions, but they <em>should</em> take less cycles in practice because there is no division/mod/rem operation anymore. Unless you can observe actual slowdowns to motivate otherwise, I think we do want to keep this rewrite.</p>
</blockquote>



<a name="563920238"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312139%20Cranelift%3A%20ISLE%20mid-end%20performan.../near/563920238" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312139.20Cranelift.3A.20ISLE.20mid-end.20performan.2E.2E.2E.html#563920238">(Dec 15 2025 at 20:37)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/issues/12139#issuecomment-3657504343">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12139">issue #12139</a>:</p>
<blockquote>
<blockquote>
<p>This might be from the IR transformation below (notice the increased usage of <code>v8</code>, which can contribute to higher register pressure):</p>
</blockquote>
<p>Addressing this specifically requires support for rematerializing values. The best place to do this is probably in the register allocator (where we can keep reusing values <em>until</em> we get register pressure and can then rematerialize rather than spilling and reloading), although we can also do it in the mid-end (and in fact will rematerialize constants oncer-per-block IIRC in the mid-end). The problem with doing more remat in the mid-end is that it doesn't know about register pressure or even the number of available registers that the backend has. Seems like the kind of thing that would be best to do during regalloc.</p>
<p>Anyways, we have a couple issues related to rematerialization on file:</p>
<ul>
<li><a href="https://github.com/bytecodealliance/regalloc2/issues/8">https://github.com/bytecodealliance/regalloc2/issues/8</a></li>
<li><a href="https://github.com/bytecodealliance/wasmtime/issues/7313">https://github.com/bytecodealliance/wasmtime/issues/7313</a></li>
</ul>
</blockquote>



<a name="563923896"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312139%20Cranelift%3A%20ISLE%20mid-end%20performan.../near/563923896" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312139.20Cranelift.3A.20ISLE.20mid-end.20performan.2E.2E.2E.html#563923896">(Dec 15 2025 at 21:00)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/issues/12139#issuecomment-3657585315">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12139">issue #12139</a>:</p>
<blockquote>
<blockquote>
<p>Probably it is the time to tap in the backend codegen/instruction scheduling/register allocation because a subtle change in IR is causing a surprising performance regression. I suspect the codegen is not handling IRs transformed by the mid-end optimizations and can produce a quality code only for non-optimized codes. For example, the following IR transformation (no-opt to base) in <code>pulldown-cmark</code></p>
</blockquote>
<p>An interesting performance/codegen fuzzing experiment would be to do something like:</p>
<ul>
<li>Start with some small initial snippet of CLIF/Wasm.<ul>
<li>Ideally something like a single value that flows into a store, call, branch condition, etc... instead of like a whole function body consisting of many side effectful instructions and lots of control flow.</li>
<li>Perhaps by looking at the LHSes of our lowering rules (similar to <a href="https://insuyun.github.io/pubs/2025/park:rgfuzz.pdf">this paper</a>)</li>
<li>Perhaps by extracting snippets from Sightglass benchmarks.</li>
<li>Perhaps generating arbitrary snippets (e.g. via <code>wasm-smith</code>).</li>
</ul>
</li>
<li>Make a semantics-preserving mutation to that input snippet.<ul>
<li>Perhaps using e-graphs, like <code>wasm-mutate</code> does <a href="https://github.com/bytecodealliance/wasm-tools/blob/ba826b896e2d13999d955cab6ccedf9e9ed88829/crates/wasm-mutate/src/mutators/peephole/rules.rs#L19">0</a> <a href="https://arxiv.org/pdf/2309.07638">1</a></li>
</ul>
</li>
<li>Compile both the original and mutated snippet to native code</li>
<li>Assert that the generated code is the same<ul>
<li>If they are not the same, then either<ul>
<li>we are missing <em>some</em> kind of rewrite/simplification in our mid-end, or</li>
<li>we are missing lowering rules for canonicalized IR patterns in our backend (or they are not general enough or something)</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>I suspect that we would find <em>a lot</em> of stuff this way. Probably more than we realistically have spare cycles to evaluate. Would need to put effort into prioritizing bugs (so extracting from benchmarks / existing lowering rules is nice because it would implicitly find higher-priority bugs than starting from an arbitrary sequence would).</p>
<p>We would also have to take care to keep the snippets small enough that we don't run into <a href="https://github.com/bytecodealliance/wasmtime/issues/12156">https://github.com/bytecodealliance/wasmtime/issues/12156</a>, as that would lead to uninteresting results (we already know that our cost function has issues with large expressions that have lots of shared structure and know we need to fix that, and it is a separate issue from our actual rewrite/lowering rule set).</p>
</blockquote>



<a name="563931995"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312139%20Cranelift%3A%20ISLE%20mid-end%20performan.../near/563931995" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312139.20Cranelift.3A.20ISLE.20mid-end.20performan.2E.2E.2E.html#563931995">(Dec 15 2025 at 21:53)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/12139#issuecomment-3657762519">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12139">issue #12139</a>:</p>
<blockquote>
<p>Thanks, @bongjunj, for this analysis. To add my take on the immediate issue first: your data makes clear that fixing one outlier creates several more; and on balance it seems better to keep the rules the way they are. Regressing SpiderMonkey by 2% is a far bigger deal than one of the shootout benchmarks -- the latter are very small "kernels" (single hot loops doing one thing) so are sensitive to particular cases of heuristics gone bad, while the SpiderMonkey case is more representative of real workloads.</p>
<p>I think it is worth setting expectations here: while it would be ideal for the compiler to never have optimizations that make results worse, in practice once we widen the scope of optimizations large enough, with the NP-complete multidimensional optimization problem, there will inevitably be outliers. Studying those outliers is helpful, but they are not the same as, say, correctness bugs that must be fixed.</p>
<p>I'll echo @fitzgen's point as well that more canonicalization is better, as a general principle. Removing rules that canonicalize might avoid some case in some outlier but could have many unseen effects later -- we aren't measuring the opportunity cost. It'd be better to "complete the work" and make the rest of the pipeline work well with the canonicalized form.</p>
<p>Rematerialization in regalloc is a holy-grail if we can achieve it but is very hard to do because it crosses abstraction layers in the compiler: it would mean that we would somehow need to represent the multiple possibilities to compute (or reuse) a value in VCode, and we'd need to reason about the indirect effects of liveranges on register pressure. The simplest case is a pure instruction that can be re-executed, but even that is nontrivial from a regalloc point of view because it could extend the liveranges of the inputs of <em>that</em> rematerialized instruction, force more register pressure elsewhere, and cascade into evictions and other rematerialization decisions. The most principled way to deal with all of this is to encode the whole thing -- lowering, code scheduling, and regalloc -- into an ILP (integer linear programming) problem and solve it, but that's essentially a rewrite of Cranelift's whole backend and also not compatible with the compiler-performance corner we inhabit. All of that to say: we can point in that direction and say that that is an eventual possible solution, but it's not clear to me that it's practical or solvable.</p>
</blockquote>



<a name="563968524"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312139%20Cranelift%3A%20ISLE%20mid-end%20performan.../near/563968524" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312139.20Cranelift.3A.20ISLE.20mid-end.20performan.2E.2E.2E.html#563968524">(Dec 16 2025 at 05:42)</a>:</h4>
<p>bongjunj <a href="https://github.com/bytecodealliance/wasmtime/issues/12139#issuecomment-3658935889">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12139">issue #12139</a>:</p>
<blockquote>
<blockquote>
<p>add missing x64 lowering rules that recognize the canonicalized form</p>
</blockquote>
<blockquote>
<p>I'll echo @fitzgen's point as well that more canonicalization is better, as a general principle. Removing rules that canonicalize might avoid some case in some outlier but could have many unseen effects later -- we aren't measuring the opportunity cost. It'd be better to "complete the work" and make the rest of the pipeline work well with the canonicalized form.</p>
</blockquote>
<p>Yes, I also think this is the right direction. Because some of the rules I removed are so general such as <code>(x - y) + y =&gt; x</code>, getting rid of them does not make much sense. We have to work on using them properly to boost performance. The downside of removing such rules is already observed in the spidermonkey case in the data above.</p>
<blockquote>
<p>An interesting performance/codegen fuzzing experiment would be to do something like:</p>
<ul>
<li>
<p>Start with some small initial snippet of CLIF/Wasm.</p>
<ul>
<li>Ideally something like a single value that flows into a store, call, branch condition, etc... instead of like a whole function body consisting of many side effectful instructions and lots of control flow.</li>
<li>Perhaps by looking at the LHSes of our lowering rules (similar to <a href="https://insuyun.github.io/pubs/2025/park:rgfuzz.pdf">this paper</a>)</li>
<li>Perhaps by extracting snippets from Sightglass benchmarks.</li>
<li>Perhaps generating arbitrary snippets (e.g. via <code>wasm-smith</code>).</li>
<li>Make a semantics-preserving mutation to that input snippet.<br>
</li>
</ul>
</li>
</ul>
</blockquote>
<p>I think this can be a good microbenchmark to track code generation quality. Asserting the equality between the before- and after- mutations can be too strong. We could otherwise calculate the estimated number of CPU cycles using some tools like <code>llvm-mca</code> (<a href="https://llvm.org/docs/CommandGuide/llvm-mca.html">https://llvm.org/docs/CommandGuide/llvm-mca.html</a>). This can automatically detect performance regression of generated codes and withstand minor changes due to backend updates in the future.</p>
<hr>
<p>P.S.</p>
<p>I was investigating this problem because it was surprising that some rules I have submitted here was degrading performance in some cases. I think it is clear that optimized IR can degrade performance, affecting further code-gen processes. But it seems like the problem can be solved later with an improved reg-alloc and code-gens!</p>
</blockquote>



<a name="564138494"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312139%20Cranelift%3A%20ISLE%20mid-end%20performan.../near/564138494" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312139.20Cranelift.3A.20ISLE.20mid-end.20performan.2E.2E.2E.html#564138494">(Dec 16 2025 at 21:46)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/issues/12139#issuecomment-3662532044">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12139">issue #12139</a>:</p>
<blockquote>
<blockquote>
<p>Asserting the equality between the before- and after- mutations can be too strong. We could otherwise calculate the estimated number of CPU cycles using some tools like <code>llvm-mca</code> (<a href="https://llvm.org/docs/CommandGuide/llvm-mca.html">https://llvm.org/docs/CommandGuide/llvm-mca.html</a>). This can automatically detect performance regression of generated codes and withstand minor changes due to backend updates in the future.</p>
</blockquote>
<p>Indeed, I was originally thinking something similar, but then realized that (so long as we didn't introduce any null side effects in the mutation, like reading a value from memory and writing it back to the same place, which we won't ever be able to optimize away in the limit in Cranelift) then it doesn't really matter whether the codegen for the initial or mutated snippet is better. We should be generating whichever code is better when given either the initial or mutated snippet. <code>llvm-mca</code> would be good for determining which version of code we should generate for both snippets, given that we've already found a divergence between them.</p>
<blockquote>
<p>P.S.</p>
<p>I was investigating this problem because it was surprising that some rules I have submitted here was degrading performance in some cases. I think it is clear that optimized IR can degrade performance, affecting further code-gen processes. But it seems like the problem can be solved later with an improved reg-alloc and code-gens!</p>
</blockquote>
<p>It is true that these problems can and often should be solved at the regalloc or instruction selection levels, rather than in the mid-end, but that doesn't mean we shouldn't worry about performance regressions at all when adding new mid-end rules. Sometimes fixing the problem in the right place is pretty difficult and unlikely to happen soon (e.g. regalloc rematerialization). In general, we should strive not to regress <a href="https://github.com/bytecodealliance/sightglass/blob/main/benchmarks/default.suite">the "default" suite</a> of Sightglass benchmarks, which represent Real World programs; it can be okay, on the other hand, to regress the micro-benchmarks, like shootout, if we understand why the regression is happening and have other, higher-priority motivations to outweigh the micro-benchmark regression.</p>
</blockquote>



<hr><p>Last updated: Feb 22 2026 at 11:05 UTC</p>
</html>
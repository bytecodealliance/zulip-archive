<html>
<head><meta charset="utf-8"><title>wasmtime / PR #10468 `cranelift-frontend`: Propagate need... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310468.20.60cranelift-frontend.60.3A.20Propagate.20need.2E.2E.2E.html">wasmtime / PR #10468 `cranelift-frontend`: Propagate need...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="508082900"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310468%20%60cranelift-frontend%60%3A%20Propagate%20need.../near/508082900" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310468.20.60cranelift-frontend.60.3A.20Propagate.20need.2E.2E.2E.html#508082900">(Mar 25 2025 at 17:13)</a>:</h4>
<p>fitzgen opened <a href="https://github.com/bytecodealliance/wasmtime/pull/10468">PR #10468</a> from <code>fitzgen:stack-map-var-to-val-during-finalization</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>Rather than trying to propagate the needs-stack-map bit from variables to values online, while we are building the IR and defining and using variables, wait until the function is being finalized, and then propagate everything all at once. This avoids potential repeated work and is easier to ensure that it is complete and covers all values associated with a variable, since by the time we are finalizing the function, we won't add any new values for a variable that we will need to keep track of and propagate this information to.</p>
<p>This also means that we can remove the <code>params_added_to_blocks</code> vector from the SSA side effects structure, since it was only used to online-update the <code>stack_map_values</code> set.</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="508082902"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310468%20%60cranelift-frontend%60%3A%20Propagate%20need.../near/508082902" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310468.20.60cranelift-frontend.60.3A.20Propagate.20need.2E.2E.2E.html#508082902">(Mar 25 2025 at 17:13)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/alexcrichton">alexcrichton</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/10468">PR #10468</a>.</p>



<a name="508082904"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310468%20%60cranelift-frontend%60%3A%20Propagate%20need.../near/508082904" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310468.20.60cranelift-frontend.60.3A.20Propagate.20need.2E.2E.2E.html#508082904">(Mar 25 2025 at 17:13)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-fuzz-reviewers">wasmtime-fuzz-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/10468">PR #10468</a>.</p>



<a name="508082905"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310468%20%60cranelift-frontend%60%3A%20Propagate%20need.../near/508082905" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310468.20.60cranelift-frontend.60.3A.20Propagate.20need.2E.2E.2E.html#508082905">(Mar 25 2025 at 17:13)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/cfallin">cfallin</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/10468">PR #10468</a>.</p>



<a name="508082907"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310468%20%60cranelift-frontend%60%3A%20Propagate%20need.../near/508082907" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310468.20.60cranelift-frontend.60.3A.20Propagate.20need.2E.2E.2E.html#508082907">(Mar 25 2025 at 17:13)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/10468">PR #10468</a>.</p>



<a name="508083744"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310468%20%60cranelift-frontend%60%3A%20Propagate%20need.../near/508083744" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310468.20.60cranelift-frontend.60.3A.20Propagate.20need.2E.2E.2E.html#508083744">(Mar 25 2025 at 17:17)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/10468#pullrequestreview-2714575106">PR review</a>.</p>



<a name="508083753"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310468%20%60cranelift-frontend%60%3A%20Propagate%20need.../near/508083753" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310468.20.60cranelift-frontend.60.3A.20Propagate.20need.2E.2E.2E.html#508083753">(Mar 25 2025 at 17:17)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/10468#discussion_r2012576169">PR review comment</a>:</p>
<blockquote>
<p>This is quadratic, right? <code>O(#vars * #vals)</code></p>
</blockquote>



<a name="508089069"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310468%20%60cranelift-frontend%60%3A%20Propagate%20need.../near/508089069" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310468.20.60cranelift-frontend.60.3A.20Propagate.20need.2E.2E.2E.html#508089069">(Mar 25 2025 at 17:40)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/10468#pullrequestreview-2714639550">PR review</a>.</p>



<a name="508089075"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310468%20%60cranelift-frontend%60%3A%20Propagate%20need.../near/508089075" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310468.20.60cranelift-frontend.60.3A.20Propagate.20need.2E.2E.2E.html#508089075">(Mar 25 2025 at 17:40)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/10468#discussion_r2012615497">PR review comment</a>:</p>
<blockquote>
<p>The <code>values_for_var</code> function is not <code>O(vars * vals)</code> but the loop calling <code>values_for_vars</code> in finalization is. I'm unsure which part of the code you are referring to with this comment.</p>
<p>And while that finalization loop is <code>O(vars * vals)</code> in the worse case where every variable is marked as needing a stack map and every value is associated with not just one but every single variable, I wouldn't really call that quadratic because <code>vars</code> and <code>vals</code> are two independent big-O variables. Similarly, I wouldn't really call an <code>O(edges * vertices)</code> graph algorithm quadratic.</p>
<p>Either way, I don't think it actually matters in this case. It shouldn't be possible to write a Wasm program that constructs that worst case input or anything like it. And it would be pretty difficult to accidentally generate this code with any typical <code>cranelift_frontend</code> usage (even in the face of translating untrusted code to CLIF). It would require using the <code>cranelift_frontend</code> API directly in a fairly malicious way to create that worst case.</p>
</blockquote>



<a name="508092272"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310468%20%60cranelift-frontend%60%3A%20Propagate%20need.../near/508092272" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310468.20.60cranelift-frontend.60.3A.20Propagate.20need.2E.2E.2E.html#508092272">(Mar 25 2025 at 17:56)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/10468#pullrequestreview-2714688360">PR review</a>:</p>
<blockquote>
<p>LGTM; this is simpler as well as fixing the issue, so thanks for revisiting!</p>
</blockquote>



<a name="508092274"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310468%20%60cranelift-frontend%60%3A%20Propagate%20need.../near/508092274" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310468.20.60cranelift-frontend.60.3A.20Propagate.20need.2E.2E.2E.html#508092274">(Mar 25 2025 at 17:56)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/10468#discussion_r2012645730">PR review comment</a>:</p>
<blockquote>
<p>Maybe one way of seeing this is that values are subordinate to variables: so we aren't taking a cross-product of all vars with all vals, but performing some work for each value, and we get to all the values by traversing the per-var bins of values.</p>
<p>Said more simply: this is linear in the size of the IR; but all of compilation is already at least linear in the size of the IR, so we aren't introducing any additional blowup here, I think.</p>
</blockquote>



<a name="508094992"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310468%20%60cranelift-frontend%60%3A%20Propagate%20need.../near/508094992" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310468.20.60cranelift-frontend.60.3A.20Propagate.20need.2E.2E.2E.html#508094992">(Mar 25 2025 at 18:08)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/10468#pullrequestreview-2714735415">PR review</a>.</p>



<a name="508094994"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310468%20%60cranelift-frontend%60%3A%20Propagate%20need.../near/508094994" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310468.20.60cranelift-frontend.60.3A.20Propagate.20need.2E.2E.2E.html#508094994">(Mar 25 2025 at 18:08)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/10468#discussion_r2012673304">PR review comment</a>:</p>
<blockquote>
<p>When I saw the use of filter while quickly looking at it, for some reason I mistakenly thought each values_for_var call iterated over the full list of values in the function filtering just those applicable to the given variable. Reading it again, this is indeed not what happens.</p>
</blockquote>



<a name="508109816"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310468%20%60cranelift-frontend%60%3A%20Propagate%20need.../near/508109816" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310468.20.60cranelift-frontend.60.3A.20Propagate.20need.2E.2E.2E.html#508109816">(Mar 25 2025 at 19:25)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/10468">PR #10468</a>.</p>



<a name="508109818"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310468%20%60cranelift-frontend%60%3A%20Propagate%20need.../near/508109818" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310468.20.60cranelift-frontend.60.3A.20Propagate.20need.2E.2E.2E.html#508109818">(Mar 25 2025 at 19:25)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers">wasmtime-core-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/10468">PR #10468</a>.</p>



<a name="508109916"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310468%20%60cranelift-frontend%60%3A%20Propagate%20need.../near/508109916" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310468.20.60cranelift-frontend.60.3A.20Propagate.20need.2E.2E.2E.html#508109916">(Mar 25 2025 at 19:25)</a>:</h4>
<p>fitzgen has enabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/10468">PR #10468</a>.</p>



<a name="508116608"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310468%20%60cranelift-frontend%60%3A%20Propagate%20need.../near/508116608" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310468.20.60cranelift-frontend.60.3A.20Propagate.20need.2E.2E.2E.html#508116608">(Mar 25 2025 at 20:02)</a>:</h4>
<p>fitzgen merged <a href="https://github.com/bytecodealliance/wasmtime/pull/10468">PR #10468</a>.</p>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
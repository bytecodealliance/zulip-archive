<html>
<head><meta charset="utf-8"><title>wasmtime / PR #12051 Debugging: implement private copies ... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312051.20Debugging.3A.20implement.20private.20copies.20.2E.2E.2E.html">wasmtime / PR #12051 Debugging: implement private copies ...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="558329646"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312051%20Debugging%3A%20implement%20private%20copies%20.../near/558329646" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312051.20Debugging.3A.20implement.20private.20copies.20.2E.2E.2E.html#558329646">(Nov 20 2025 at 00:36)</a>:</h4>
<p>cfallin opened <a href="https://github.com/bytecodealliance/wasmtime/pull/12051">PR #12051</a> from <code>cfallin:you-get-a-code-segment-you-get-a-code-segment-everyone-gets-a-code-segment</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>This will be needed to allow code-patching for our basic breakpoint strategy (see #11964). The idea is that when we have guest-debugging enabled in an engine's configuration, each store in that engine needs its own copy of each <code>CodeMemory</code> that executes any code with that store so that we can patch breakpoints.</p>
<p>This PR first adds "deep-cloning" to the <code>MmapVec</code> and <code>CodeMemory</code> abstractions: the idea is that when possible, we re-map the underlying file with another private mapping, and otherwise, in the worst case (when we don't know the underlying file or when the image was provided to us as an external slice), we make a full copy into a new allocation.</p>
<p>It then updates the per-store registry to track private copies of each <code>CodeMemory</code>, identified by <code>CompiledModuleId</code>, and deep-clone when it sees a new one for the first time. This is slightly subtle because of the way that components share a single CodeMemory (and do not have a CompiledModule) for all internal modules.</p>
<p>This CodeMemory is then threaded through to the appropriate places that feed back pointers to the code: e.g., accessors for trampolines and Wasm function pointers require the specific code memory to be specified.</p>
<p>Finally, at the instance level, we keep the instantiated CodeMemory alongside the Module in the <code>ModuleRuntimeInfo</code>.</p>
<p>I went back and forth between a few different ways to plumb all this together. I'm not completely happy with the "give me the CodeMemory you mean" API for getting functions -- that could be a footgun. On the other hand, pushing the cloning upward causes a lot more churn, and bifurcates the core-module vs. component situation more. This still seems reasonably manageable in the sense that only a few specific accessors are affected and they are used only internally, in places where we have the <code>CodeMemory</code> right at hand from the particular instance or from the (updated) "lookup module by PC" helper on the store's registry. Happy to take ideas for a better design here if one occurs to someone!</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="558329648"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312051%20Debugging%3A%20implement%20private%20copies%20.../near/558329648" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312051.20Debugging.3A.20implement.20private.20copies.20.2E.2E.2E.html#558329648">(Nov 20 2025 at 00:36)</a>:</h4>
<p><strong>cfallin</strong> requested <a href="https://github.com/fitzgen">fitzgen</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/12051">PR #12051</a>.</p>



<a name="558329650"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312051%20Debugging%3A%20implement%20private%20copies%20.../near/558329650" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312051.20Debugging.3A.20implement.20private.20copies.20.2E.2E.2E.html#558329650">(Nov 20 2025 at 00:36)</a>:</h4>
<p><strong>cfallin</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers">wasmtime-core-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/12051">PR #12051</a>.</p>



<a name="558331846"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312051%20Debugging%3A%20implement%20private%20copies%20.../near/558331846" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312051.20Debugging.3A.20implement.20private.20copies.20.2E.2E.2E.html#558331846">(Nov 20 2025 at 01:04)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/12051">PR #12051</a>.</p>



<a name="558331965"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312051%20Debugging%3A%20implement%20private%20copies%20.../near/558331965" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312051.20Debugging.3A.20implement.20private.20copies.20.2E.2E.2E.html#558331965">(Nov 20 2025 at 01:06)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/12051">PR #12051</a>.</p>



<a name="558332789"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312051%20Debugging%3A%20implement%20private%20copies%20.../near/558332789" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312051.20Debugging.3A.20implement.20private.20copies.20.2E.2E.2E.html#558332789">(Nov 20 2025 at 01:14)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/12051">PR #12051</a>.</p>



<a name="558686509"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312051%20Debugging%3A%20implement%20private%20copies%20.../near/558686509" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312051.20Debugging.3A.20implement.20private.20copies.20.2E.2E.2E.html#558686509">(Nov 21 2025 at 15:22)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/12051#discussion_r2550006143">PR review comment</a>:</p>
<blockquote>
<p>Technically the trampoline accessors don't need a <code>CodeMemory</code> argument, right? We'll only be patching/changing "finished functions" so the new argument here and for wasm-&gt;array trampolines below might be able to be dropped?</p>
</blockquote>



<a name="558686510"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312051%20Debugging%3A%20implement%20private%20copies%20.../near/558686510" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312051.20Debugging.3A.20implement.20private.20copies.20.2E.2E.2E.html#558686510">(Nov 21 2025 at 15:22)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/12051#discussion_r2550017977">PR review comment</a>:</p>
<blockquote>
<p>Since this doesn't actually use <code>&amp;self</code> at all here any more, maybe this could move to <code>CodeMemory</code> directly?</p>
</blockquote>



<a name="558686511"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312051%20Debugging%3A%20implement%20private%20copies%20.../near/558686511" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312051.20Debugging.3A.20implement.20private.20copies.20.2E.2E.2E.html#558686511">(Nov 21 2025 at 15:22)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/12051#pullrequestreview-3493050175">PR review</a>:</p>
<blockquote>
<p>I've left a few comments here and there, but a high-level thought I had here is that I was originally hoping that it would be possible to use <code>Arc::get_mut</code> to dynamically prove that it's safe to mutate the memory. In reading over this though we have quite a lot of clones in quite a lot of places so I'm realizing that it may not be quite as applicable as previously thought. </p>
<p>Another high-level thought though is that there's a fair bit of juggling of trying to make sure we're using the right code memory in the right context and it feels relatively cumbersome to maintain that everywhere.</p>
<p>Would it be possible to maybe do the deep clone of-a-sort on the <code>Module</code> itself to avoid having to juggle one-vs-the-other? I'd ideally like to keep the self-contained nature of <code>Module</code> as-is where callers don't have to worry about passing in the right object or making sure they're dynamically selecting the right object. One semi-rough idea is that we could change the representation of <code>Module</code> to be an <code>enum</code> which is either "pointer to the stuff" or "private code plus pointer to the stuff"</p>
</blockquote>



<a name="558686513"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312051%20Debugging%3A%20implement%20private%20copies%20.../near/558686513" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312051.20Debugging.3A.20implement.20private.20copies.20.2E.2E.2E.html#558686513">(Nov 21 2025 at 15:22)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/12051#discussion_r2550025726">PR review comment</a>:</p>
<blockquote>
<p>Technically I think this'll be wrong for private code memories? This sould use the "active" code as opposed to the default one, right?</p>
</blockquote>



<a name="558686514"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312051%20Debugging%3A%20implement%20private%20copies%20.../near/558686514" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312051.20Debugging.3A.20implement.20private.20copies.20.2E.2E.2E.html#558686514">(Nov 21 2025 at 15:22)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/12051#discussion_r2550001187">PR review comment</a>:</p>
<blockquote>
<p>Although as I say we try to reduce clones... there's another map lookup here for <code>Instance::new</code>-style constructors and then there's also <code>module.clone()</code> below. So maybe we have some refactoring to do to reduce all the clones here...</p>
</blockquote>



<a name="558686515"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312051%20Debugging%3A%20implement%20private%20copies%20.../near/558686515" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312051.20Debugging.3A.20implement.20private.20copies.20.2E.2E.2E.html#558686515">(Nov 21 2025 at 15:22)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/12051#discussion_r2549988607">PR review comment</a>:</p>
<blockquote>
<p>Similar comment to components above -- I think this new argument to <code>register_module</code> can be dropped and the engine can be derived from the module itself</p>
</blockquote>



<a name="558686516"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312051%20Debugging%3A%20implement%20private%20copies%20.../near/558686516" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312051.20Debugging.3A.20implement.20private.20copies.20.2E.2E.2E.html#558686516">(Nov 21 2025 at 15:22)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/12051#discussion_r2550105634">PR review comment</a>:</p>
<blockquote>
<p>To avoid having to re-guess what the alignment is here, could the alignment be passed in to more constructors?</p>
</blockquote>



<a name="558686517"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312051%20Debugging%3A%20implement%20private%20copies%20.../near/558686517" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312051.20Debugging.3A.20implement.20private.20copies.20.2E.2E.2E.html#558686517">(Nov 21 2025 at 15:22)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/12051#discussion_r2549985789">PR review comment</a>:</p>
<blockquote>
<p>Given that this is the hot path of instantiation I'd like to try to keep clones out of this path where possible. For this I think the engine is reachable via the <code>component</code> in addition to the store, so could the new <code>engine</code> argument to <code>register_component</code> come from <code>component.engine()</code> instead? (may not end up needing a new argument in that case)</p>
</blockquote>



<a name="558704043"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312051%20Debugging%3A%20implement%20private%20copies%20.../near/558704043" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312051.20Debugging.3A.20implement.20private.20copies.20.2E.2E.2E.html#558704043">(Nov 21 2025 at 16:33)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/12051#issuecomment-3563798362">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/12051">PR #12051</a>:</p>
<blockquote>
<p>Thanks for your comments @alexcrichton! A high-level discussion point:</p>
<blockquote>
<p>Another high-level thought though is that there's a fair bit of juggling of trying to make sure we're using the right code memory in the right context and it feels relatively cumbersome to maintain that everywhere.</p>
<p>Would it be possible to maybe do the deep clone of-a-sort on the Module itself to avoid having to juggle one-vs-the-other? I'd ideally like to keep the self-contained nature of Module as-is where callers don't have to worry about passing in the right object or making sure they're dynamically selecting the right object. One semi-rough idea is that we could change the representation of Module to be an enum which is either "pointer to the stuff" or "private code plus pointer to the stuff"</p>
</blockquote>
<p>I think this is the <a href="https://github.com/cfallin/wasmtime/blob/36e1bc64f9c3231f659965ed7c3b62a9d8c17958/crates/wasmtime/src/runtime/vm.rs#L303-L313"><code>ModuleRuntimeInfo</code></a> with my changes -- it goes from a simple <code>Module</code> to a <code>Module</code> plus <code>Arc&lt;CodeMemory&gt;</code>.</p>
<p>In a little more detail: I did explore the "clone all the way up" approach before taking the current direction, and the main issue I came across was that (to say it bluntly) "it's a lie": in the presence of introspection APIs, e.g. the ability to get a module from an <code>Instance</code> handle (and for one to get all instances via debugging introspection APIs), we want the same module to be the same. It also adds a lot more cloning cost obviously, which can be mitigated with a bunch of internal <code>Arc</code>s, but that's not great either. (It puts most of the cost in the debugging case rather than base case, but does mean there are more indirections in the base case.)</p>
<p>My thought was that the <code>ModuleRuntimeInfo</code> would be the place where a module is joined together with a particular copy of its code. The most proper ("most truthful") refactor from there would be to remove all code-related accessors from <code>Module</code> and put them on <code>ModuleRuntimeInfo</code> instead, but that's also a large refactor that affects a bunch of callsites. Actually now that I think about it, though -- I had been worried about the accessors that fetch data from the image rather than return pointers to code (Wasm data, exception table, ...) and what they would do, but we could create an ad-hoc <code>ModuleRuntimeInfo</code> at that point. Or describe the abstraction as a new <code>ModuleWithCode</code>, replace <code>ModuleRuntimeInfo::Module</code>'s payload with that, and hang all the accessors that need code off <code>ModuleWithCode</code>. Then we can get a "module with default code" from the <code>Module</code> itself if we know we aren't going to return pointers to it.</p>
<p>What do you think?</p>
</blockquote>



<a name="558711991"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312051%20Debugging%3A%20implement%20private%20copies%20.../near/558711991" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312051.20Debugging.3A.20implement.20private.20copies.20.2E.2E.2E.html#558711991">(Nov 21 2025 at 17:10)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/12051#issuecomment-3563931829">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/12051">PR #12051</a>:</p>
<blockquote>
<blockquote>
<p>Then we can get a "module with default code" from the Module itself if we know we aren't going to return pointers to it.</p>
</blockquote>
<p>And, actually, as a refinement on that: we could do some type-system shenanigans so that a "module with default code" is not allowed to return raw code pointers, only other (meta)data from the image, while a "module with code" obtained from an instance is.</p>
</blockquote>



<a name="558712368"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312051%20Debugging%3A%20implement%20private%20copies%20.../near/558712368" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312051.20Debugging.3A.20implement.20private.20copies.20.2E.2E.2E.html#558712368">(Nov 21 2025 at 17:13)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/pull/12051#issuecomment-3563939319">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/12051">PR #12051</a>:</p>
<blockquote>
<blockquote>
<p>but that's also a large refactor that affects a bunch of callsites.</p>
</blockquote>
<p>But it also sounds really nice...</p>
<p>Spitballing without having dug into the PR yet: is it possible that some lsp actions could help make this mass refactor easier?</p>
</blockquote>



<a name="558713713"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312051%20Debugging%3A%20implement%20private%20copies%20.../near/558713713" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312051.20Debugging.3A.20implement.20private.20copies.20.2E.2E.2E.html#558713713">(Nov 21 2025 at 17:20)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/12051#issuecomment-3563964529">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/12051">PR #12051</a>:</p>
<blockquote>
<p>Yeah, I guess "large refactor that affects a lot of callsites" was my reason for not doing it so far, but I'm happy to do it to get the right conceptual model.</p>
<p>To be clear, that's <code>ModuleWithCode</code> and moving image-related accessors onto that (and getting at them from the <code>ModuleRuntimeInfo</code>), not clone-<code>Module</code>-all-the-way-up. @alexcrichton does this sound good to you? I want to make sure you're onboard before I spend a day doing this :-)</p>
</blockquote>



<a name="558727648"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312051%20Debugging%3A%20implement%20private%20copies%20.../near/558727648" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312051.20Debugging.3A.20implement.20private.20copies.20.2E.2E.2E.html#558727648">(Nov 21 2025 at 18:32)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/12051#discussion_r2550527225">PR review comment</a>:</p>
<blockquote>
<p>I originally expected this to be an assert that the entry was not occupied, but I double checked and we do in fact potentially register the same code multiple times (e.g. we register a module's code on each <code>Instance::new</code> call and you can obviously instantiate the same module multiple times in the same store).</p>
<p>This subtlety pushes me towards asking for some kind of assertion that the existing private code object matches our <code>code_object</code> parameter, but I don't see how that is really possible without a full byte-for-byte comparison of the whole mmap, which seems like it is probably too expensive.</p>
<p>So ultimately maybe we just expand this method's doc comment to note that the method is idempotent and that modules will be registered multiple times in certain scenarios? That reminder/context probably would have let me avoid going down this rabbit hole.</p>
<p>Or maybe we should invert some logic here, and <em>always</em> use <code>self.private_code</code> (after renaming it to something like <code>self.registered_code</code>) so that we can super easily tell if a code object is already registered and return early if so, without needing to actually do the careful text range queries below? I think this inversion would make the idempotency logic much clearer. Thoughts?</p>
</blockquote>



<a name="558727649"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312051%20Debugging%3A%20implement%20private%20copies%20.../near/558727649" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312051.20Debugging.3A.20implement.20private.20copies.20.2E.2E.2E.html#558727649">(Nov 21 2025 at 18:32)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/12051#pullrequestreview-3493711812">PR review</a>:</p>
<blockquote>
<p>To briefly repeat some comments from DM: I am in favor of the refactor discussed in this PR's main thread where</p>
<ul>
<li>we create a type separation between the shared code at the engine level and the (potentially private copy) code used at the store level</li>
<li>all accessors for function pointers and such move to the store-level code type (or a <code>Module</code> and store-level code pair type)</li>
<li>the act of creating the store-level code is the thing one place we are making a private copy or reusing the shared copy</li>
</ul>
<p>bikeshedding names for these two new types:</p>
<ul>
<li><code>EngineCode</code> and <code>StoreCode</code></li>
<li><code>CodeModule</code> and <code>CodeInstance</code></li>
<li><code>CodeFactory</code> and <code>CodeInstance</code> lol</li>
</ul>
</blockquote>



<a name="558727651"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312051%20Debugging%3A%20implement%20private%20copies%20.../near/558727651" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312051.20Debugging.3A.20implement.20private.20copies.20.2E.2E.2E.html#558727651">(Nov 21 2025 at 18:32)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/12051#discussion_r2550472860">PR review comment</a>:</p>
<blockquote>
<p>We should probably have tests for non-aligned inputs to <code>deserialize_raw</code> if we don't already.</p>
<p>But also, this seems like the kind of thing where we can simply update the invariants of <code>deserialize_raw</code> if it becomes overly constraining. <em>shrug</em></p>
</blockquote>



<a name="558727652"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312051%20Debugging%3A%20implement%20private%20copies%20.../near/558727652" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312051.20Debugging.3A.20implement.20private.20copies.20.2E.2E.2E.html#558727652">(Nov 21 2025 at 18:32)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/12051#discussion_r2550539555">PR review comment</a>:</p>
<blockquote>
<p>I know this bit might go away after the refactoring we have been discussing in the main comment thread for this PR, but if not:</p>
<p>It would be good to clarify <em>why</em> it is okay to do this for trampolines to host functions (we never have private copies of host functions so we don't need to worry about which copy of the code we are using) because it is <em>not</em> okay to use the default code memory for trampolines to Wasm functions (and a reader might otherwise mistakenly believe it is okay to use the default code memory for all trampolines, without the suggested context added to the comment).</p>
</blockquote>



<a name="560492692"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312051%20Debugging%3A%20implement%20private%20copies%20.../near/560492692" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312051.20Debugging.3A.20implement.20private.20copies.20.2E.2E.2E.html#560492692">(Nov 26 2025 at 23:28)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/12051#issuecomment-3583534384">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/12051">PR #12051</a>:</p>
<blockquote>
<p>Just an update on progress here: I'm <a href="https://github.com/cfallin/wasmtime/tree/code-segments-for-everyone">midway through the refactor</a>, and it's proving quite a lot more invasive than I had hoped. On the positive side, I've worked out a way to have truly unique ownership of a <code>StoreCode</code>, so mutation can be proved to be safe given a mut borrow of the <code>Store</code>. But in terms of impact, this is very deeply invasive, and I worry that (for example) indirect function calls are going to be penalized: lazily setting up the funcref now requires looking up the <code>StoreCode</code> for the module in question, so rather than a few fast array accesses in the <code>CompiledModule</code>, we have a BTree lookup. The impact on the guest profiler is pretty deep (it handles all its metadata regarding PCs at the module level) and <code>InstancePre</code> (though the latter may be OK only if we allow executing Wasm-to-array trampolines in the <em>engine</em> code rather than the <em>store</em> code, allowing pre-resolution of host funcrefs; this breaks a desirable invariant that we never execute engine code directly though).</p>
<p>I'll keep plugging away at this, but just wanted to surface the cost of the above requested refactor :-) I will say that with the types as now defined, I feel much more reasonable about having not missed any place that would execute the wrong copy of code.</p>
</blockquote>



<a name="560954296"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312051%20Debugging%3A%20implement%20private%20copies%20.../near/560954296" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312051.20Debugging.3A.20implement.20private.20copies.20.2E.2E.2E.html#560954296">(Nov 29 2025 at 23:53)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/12051">PR #12051</a>.</p>



<a name="560954373"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312051%20Debugging%3A%20implement%20private%20copies%20.../near/560954373" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312051.20Debugging.3A.20implement.20private.20copies.20.2E.2E.2E.html#560954373">(Nov 29 2025 at 23:54)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/12051#pullrequestreview-3520875313">PR review</a>.</p>



<a name="560954374"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312051%20Debugging%3A%20implement%20private%20copies%20.../near/560954374" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312051.20Debugging.3A.20implement.20private.20copies.20.2E.2E.2E.html#560954374">(Nov 29 2025 at 23:54)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/12051#discussion_r2573255806">PR review comment</a>:</p>
<blockquote>
<p>Yes, the logic here is pre-existing and a little weird, but appears to be necessary because of the way that modules within a component share one compiled artifact (or at least, without a deeper refactor of the whole components runtime). I've added more doc-comments in the refactor on the <code>ModuleRegistry</code> that hopefully address this (most of this file is new now as well).</p>
</blockquote>



<a name="560954458"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312051%20Debugging%3A%20implement%20private%20copies%20.../near/560954458" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312051.20Debugging.3A.20implement.20private.20copies.20.2E.2E.2E.html#560954458">(Nov 29 2025 at 23:56)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/12051#pullrequestreview-3520875595">PR review</a>.</p>



<a name="560954459"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312051%20Debugging%3A%20implement%20private%20copies%20.../near/560954459" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312051.20Debugging.3A.20implement.20private.20copies.20.2E.2E.2E.html#560954459">(Nov 29 2025 at 23:56)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/12051#discussion_r2573256319">PR review comment</a>:</p>
<blockquote>
<p>Yep, I've added some more comments to this effect, and also had to add a <code>store_invariant_func(..)</code> accessor and a notion of <code>FuncKey::is_store_invariant</code> to make this concept explicit. I've documented it more in the appropriate comment locations as well as the new commit message -- basically the structure of the component runtime and also <code>InstancePre</code> both require us to use engine-wide trampoline pointers in some places currently, and that's fine for trampolines that go out of Wasm (Wasm-to-array and Wasm-to-builtin).</p>
</blockquote>



<a name="560954524"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312051%20Debugging%3A%20implement%20private%20copies%20.../near/560954524" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312051.20Debugging.3A.20implement.20private.20copies.20.2E.2E.2E.html#560954524">(Nov 29 2025 at 23:57)</a>:</h4>
<p>cfallin edited <a href="https://github.com/bytecodealliance/wasmtime/pull/12051">PR #12051</a>:</p>
<blockquote>
<p>This will allow patching code to implement e.g. breakpoints. (That is, for now the copies are redundant, but soon they will not be.)</p>
<p>This change follows the discussion [here] and offline to define a few types that better encapsulate the distinction we want to enforce. Basically, there is almost never a bare <code>CodeMemory</code>; they are always wrapped in an <code>EngineCode</code> or <code>StoreCode</code>, the latter being a per-store instance of the former. Accessors are moved to the relevant place so that, for example, one cannot get a pointer to a Wasm function's body without being in the context of a <code>Store</code> where the containing module has been registered. The registry then returns a <code>ModuleWithCode</code> that boxes up a <code>Module</code> reference and <code>StoreCode</code> together for cases where we need both the metadata from the module and the raw code to derive something.</p>
<p>The only case where we return raw code pointers to the <code>EngineCode</code> directly have to do with Wasm-to-array trampolines: in some cases, e.g. <code>InstancePre</code> pre-creating data structures with references to host functions, it breaks our expected performance characteristics to make the function pointers store-specific. This is fine as long as the Wasm-to-array trampolines never bake in direct calls to Wasm functions; the strong invariant is that Wasm functions never execute from <code>EngineCode</code> directly. Some parts of the component runtime would also have to be substantially refactored if we wanted to do away with this exception.</p>
<p>The per-<code>Store</code> module registry is substantially refactored in this PR. I got rid of the modules-without-code distinction (the case where a module only has trampolines and no defined functions still works fine), and organized the BTreeMaps to key on start address rather than end address, which I find a little more intuitive (one then queries with the dual to the range -- 0-up-to-PC and last entry found).</p>
<p>[here]: <a href="https://github.com/bytecodealliance/wasmtime/pull/12051#pullrequestreview-3493711812">https://github.com/bytecodealliance/wasmtime/pull/12051#pullrequestreview-3493711812</a></p>
</blockquote>



<hr><p>Last updated: Feb 22 2026 at 11:05 UTC</p>
</html>
<html>
<head><meta charset="utf-8"><title>wasmtime / PR #10073 refactor: introduce `p2` module · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310073.20refactor.3A.20introduce.20.60p2.60.20module.html">wasmtime / PR #10073 refactor: introduce `p2` module</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="495252054"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310073%20refactor%3A%20introduce%20%60p2%60%20module/near/495252054" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310073.20refactor.3A.20introduce.20.60p2.60.20module.html#495252054">(Jan 22 2025 at 10:50)</a>:</h4>
<p>rvolosatovs opened <a href="https://github.com/bytecodealliance/wasmtime/pull/10073">PR #10073</a> from <code>rvolosatovs:feat/p2-module</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>Introduce a <code>p2</code> module in WASI crates as suggested in <a href="https://github.com/bytecodealliance/wasmtime/pull/10061#pullrequestreview-2565638530">https://github.com/bytecodealliance/wasmtime/pull/10061#pullrequestreview-2565638530</a></p>
<p>This will allow us to iterate on wasip3 without breaking changes</p>
<p>I tried to minimize the diff and only moved the WIT files, generated bindings and host implementations to <code>p2</code> modules.<br>
Abstractions (like <code>WasiCtx</code>) are left in place, since it's likely that <code>p3</code> modules will reuse the same abstractions.</p>
</blockquote>



<a name="495254116"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310073%20refactor%3A%20introduce%20%60p2%60%20module/near/495254116" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310073.20refactor.3A.20introduce.20.60p2.60.20module.html#495254116">(Jan 22 2025 at 11:00)</a>:</h4>
<p>rvolosatovs updated <a href="https://github.com/bytecodealliance/wasmtime/pull/10073">PR #10073</a>.</p>



<a name="495254520"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310073%20refactor%3A%20introduce%20%60p2%60%20module/near/495254520" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310073.20refactor.3A.20introduce.20.60p2.60.20module.html#495254520">(Jan 22 2025 at 11:02)</a>:</h4>
<p>rvolosatovs edited <a href="https://github.com/bytecodealliance/wasmtime/pull/10073">PR #10073</a>:</p>
<blockquote>
<p>Introduce a <code>p2</code> module in WASI crates as suggested in <a href="https://github.com/bytecodealliance/wasmtime/pull/10061#pullrequestreview-2565638530">https://github.com/bytecodealliance/wasmtime/pull/10061#pullrequestreview-2565638530</a></p>
<p>This will allow us to iterate on wasip3 without breaking changes</p>
<p>I tried to minimize the diff and only moved the WIT files, generated bindings and host implementations to <code>p2</code> modules.<br>
Abstractions (like <code>WasiCtx</code>) are left in place, since it's likely that <code>p3</code> modules will (mostly) reuse the same abstractions.</p>
</blockquote>



<a name="495254828"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310073%20refactor%3A%20introduce%20%60p2%60%20module/near/495254828" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310073.20refactor.3A.20introduce.20.60p2.60.20module.html#495254828">(Jan 22 2025 at 11:03)</a>:</h4>
<p>rvolosatovs updated <a href="https://github.com/bytecodealliance/wasmtime/pull/10073">PR #10073</a>.</p>



<a name="495255190"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310073%20refactor%3A%20introduce%20%60p2%60%20module/near/495255190" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310073.20refactor.3A.20introduce.20.60p2.60.20module.html#495255190">(Jan 22 2025 at 11:05)</a>:</h4>
<p>rvolosatovs updated <a href="https://github.com/bytecodealliance/wasmtime/pull/10073">PR #10073</a>.</p>



<a name="495255522"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310073%20refactor%3A%20introduce%20%60p2%60%20module/near/495255522" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310073.20refactor.3A.20introduce.20.60p2.60.20module.html#495255522">(Jan 22 2025 at 11:07)</a>:</h4>
<p>rvolosatovs updated <a href="https://github.com/bytecodealliance/wasmtime/pull/10073">PR #10073</a>.</p>



<a name="495255777"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310073%20refactor%3A%20introduce%20%60p2%60%20module/near/495255777" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310073.20refactor.3A.20introduce.20.60p2.60.20module.html#495255777">(Jan 22 2025 at 11:08)</a>:</h4>
<p><strong>rvolosatovs</strong> has marked <a href="https://github.com/bytecodealliance/wasmtime/pull/10073">PR #10073</a> as ready for review.</p>



<a name="495255779"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310073%20refactor%3A%20introduce%20%60p2%60%20module/near/495255779" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310073.20refactor.3A.20introduce.20.60p2.60.20module.html#495255779">(Jan 22 2025 at 11:08)</a>:</h4>
<p><strong>rvolosatovs</strong> requested <a href="https://github.com/fitzgen">fitzgen</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/10073">PR #10073</a>.</p>



<a name="495255781"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310073%20refactor%3A%20introduce%20%60p2%60%20module/near/495255781" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310073.20refactor.3A.20introduce.20.60p2.60.20module.html#495255781">(Jan 22 2025 at 11:08)</a>:</h4>
<p><strong>rvolosatovs</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers">wasmtime-core-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/10073">PR #10073</a>.</p>



<a name="495255783"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310073%20refactor%3A%20introduce%20%60p2%60%20module/near/495255783" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310073.20refactor.3A.20introduce.20.60p2.60.20module.html#495255783">(Jan 22 2025 at 11:08)</a>:</h4>
<p><strong>rvolosatovs</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-default-reviewers">wasmtime-default-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/10073">PR #10073</a>.</p>



<a name="495255851"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310073%20refactor%3A%20introduce%20%60p2%60%20module/near/495255851" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310073.20refactor.3A.20introduce.20.60p2.60.20module.html#495255851">(Jan 22 2025 at 11:08)</a>:</h4>
<p>rvolosatovs edited <a href="https://github.com/bytecodealliance/wasmtime/pull/10073">PR #10073</a>:</p>
<blockquote>
<p>Introduce a <code>p2</code> module in WASI crates as suggested in <a href="https://github.com/bytecodealliance/wasmtime/pull/10061#pullrequestreview-2565638530">https://github.com/bytecodealliance/wasmtime/pull/10061#pullrequestreview-2565638530</a></p>
<p>This will allow us to iterate on wasip3 without breaking changes</p>
<p>I tried to minimize the diff and only moved the WIT files, generated bindings and host implementations to <code>p2</code> modules.<br>
Abstractions (like <code>WasiCtx</code>) are left in place, since it's likely that <code>p3</code> modules will (mostly) reuse the same abstractions.</p>
<p>cc @pchickey </p>
</blockquote>



<a name="495256694"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310073%20refactor%3A%20introduce%20%60p2%60%20module/near/495256694" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310073.20refactor.3A.20introduce.20.60p2.60.20module.html#495256694">(Jan 22 2025 at 11:12)</a>:</h4>
<p>rvolosatovs edited <a href="https://github.com/bytecodealliance/wasmtime/pull/10073">PR #10073</a>:</p>
<blockquote>
<p>Introduce a <code>p2</code> module in WASI crates as suggested in <a href="https://github.com/bytecodealliance/wasmtime/pull/10061#pullrequestreview-2565638530">https://github.com/bytecodealliance/wasmtime/pull/10061#pullrequestreview-2565638530</a></p>
<p>This will allow us to iterate on wasip3 without breaking changes</p>
<p>I tried to minimize the diff and only moved the WIT files, generated bindings and host implementations to <code>p2</code> modules.<br>
Abstractions (like <code>WasiCtx</code>) are left in place, since it's likely that <code>p3</code> modules will (mostly) reuse the same abstractions.</p>
<p>Since <code>wasi-nn</code> seemed a bit different from other crates, I left it as-is. I'm also not aware of any plans of introducing a new version of it for wasip3.<br>
cc @pchickey </p>
</blockquote>



<a name="495262755"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310073%20refactor%3A%20introduce%20%60p2%60%20module/near/495262755" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310073.20refactor.3A.20introduce.20.60p2.60.20module.html#495262755">(Jan 22 2025 at 11:44)</a>:</h4>
<p>rvolosatovs updated <a href="https://github.com/bytecodealliance/wasmtime/pull/10073">PR #10073</a>.</p>



<a name="495263234"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310073%20refactor%3A%20introduce%20%60p2%60%20module/near/495263234" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310073.20refactor.3A.20introduce.20.60p2.60.20module.html#495263234">(Jan 22 2025 at 11:46)</a>:</h4>
<p>rvolosatovs updated <a href="https://github.com/bytecodealliance/wasmtime/pull/10073">PR #10073</a>.</p>



<a name="495263645"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310073%20refactor%3A%20introduce%20%60p2%60%20module/near/495263645" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310073.20refactor.3A.20introduce.20.60p2.60.20module.html#495263645">(Jan 22 2025 at 11:48)</a>:</h4>
<p>rvolosatovs edited <a href="https://github.com/bytecodealliance/wasmtime/pull/10073">PR #10073</a>:</p>
<blockquote>
<p>Introduce a <code>p2</code> module in WASI crates as suggested in <a href="https://github.com/bytecodealliance/wasmtime/pull/10061#pullrequestreview-2565638530">https://github.com/bytecodealliance/wasmtime/pull/10061#pullrequestreview-2565638530</a></p>
<p>This will allow us to iterate on wasip3 without breaking changes</p>
<p>I tried to minimize the diff and only moved the WIT files, generated bindings and host implementations to <code>p2</code> modules.<br>
Abstractions (like <code>WasiCtx</code>) are left in place, since it's likely that <code>p3</code> modules will (mostly) reuse the same abstractions.</p>
<p>Since <code>wasi-nn</code> seemed a bit different from other crates, I left it as-is. I'm also not aware of any plans of introducing a new version of it for wasip3.</p>
<p>I also opted not to rename existing <code>preview1</code> and <code>preview0</code> modules/features to avoid breaking changes.<br>
cc @pchickey </p>
</blockquote>



<a name="495336794"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310073%20refactor%3A%20introduce%20%60p2%60%20module/near/495336794" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310073.20refactor.3A.20introduce.20.60p2.60.20module.html#495336794">(Jan 22 2025 at 17:34)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/alexcrichton">alexcrichton</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/10073">PR #10073</a>.</p>



<a name="495337897"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310073%20refactor%3A%20introduce%20%60p2%60%20module/near/495337897" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310073.20refactor.3A.20introduce.20.60p2.60.20module.html#495337897">(Jan 22 2025 at 17:41)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/10073#issuecomment-2607872021">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/10073">PR #10073</a>:</p>
<blockquote>
<p>Thanks for this! I'm going to continue the discussion from <a href="https://github.com/bytecodealliance/wasmtime/pull/10061">https://github.com/bytecodealliance/wasmtime/pull/10061</a> over here since this looks like it's going to be first. I'll note that whatever we end up doing here for p3 is a relatively big change to consider depending on how it ends up which sort of borders along the lines of "maybe this should have an RFC". For example upon reading reading <a href="https://github.com/bytecodealliance/wasmtime/pull/10061#pullrequestreview-2565638530">Pat's comment</a> I initially reacted thinking that we should instead do something else. After thinking more though this seems like a more reasonable approach.</p>
<p>That being said though I'd at least personally still have thoughts on this, for example:</p>
<ul>
<li>I'm not sure if we want to keep a <code>pub use p2::*</code> reexport myself.</li>
<li>This probably wants to (eventually, not necessarily here), come with a rename of the <code>preview0</code> and <code>preview1</code> modules to <code>p0</code> and <code>p1</code>.</li>
<li>We might want to hold off on changing other <code>wasmtime-wasi-*</code> crates for now until APIs are ready for those. Basically pave a path with the core <code>wasmtime-wasi</code> crate but otherwise defer the actual changes to future crates to when we've shaken out all the issues here.</li>
</ul>
<p>I'll also note though that I'm not necessarily saying this requires an RFC. I find though that it's not always the greatest medium to have a design discussion when there's a PR because it's easy to get into the mindset of "well the PR does it this way so I guess we'll just go with that". RFCs have their own downsides of course though.</p>
<p>In the abstract though I think we should ideally design for where we want to end up a year or two from now. At that point WASIp3 is stable and will be the "primary" APIs that folks use. Given our destination end point first then I think we can work backwards and consider things like breaking changes, refactorings, migration paths, etc. I've historically found that only designing in incremental steps from where we are today, for example trying to minimize breaking changes, doesn't always result in the best design.</p>
</blockquote>



<a name="495380491"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310073%20refactor%3A%20introduce%20%60p2%60%20module/near/495380491" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310073.20refactor.3A.20introduce.20.60p2.60.20module.html#495380491">(Jan 22 2025 at 21:53)</a>:</h4>
<p>pchickey <a href="https://github.com/bytecodealliance/wasmtime/pull/10073#issuecomment-2608348665">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/10073">PR #10073</a>:</p>
<blockquote>
<p>I agree with all of Alex's broad strokes here.</p>
<p>I also want to point out that landing PRs to support wasip3 in wasmtime <code>main</code> doesn't feel urgent to me. In the corresponding point in the p2 development process, we forked off a prototyping repo where we could thrash things around a bunch and not worry about compatibility as we iterated on the specs and implementations towards working code. So, aside from benefiting from more discussion of our desired end state and working backwards to figure out the changes and migrations to get there, I personally would benefit from seeing a more fleshed out implementation of p3 looks like. Currently it is spread among several different authors, repos, and PRs. Additionally, right now my employer is asking me to solve a totally different set of problems, so I don't have the bandwidth to engage with the p3 implementation process deep enough to collect all that context.</p>
<blockquote>
<p>I'm not sure if we want to keep a pub use p2::* reexport myself.<br>
Agree, I don't like <code>use *</code>. Please list all of the identifiers re-exported. (Is that the aspect @alexcrichton objects to?)</p>
</blockquote>
<blockquote>
<p>This probably wants to (eventually, not necessarily here), come with a rename of the preview0 and preview1 modules to p0 and p1.<br>
Eventually to never would also be my prioritization. Consistency is nice in the abstract, but in this case I don't think its very important, since the interfaces being exposed by preview0 and 1 are for witx, and the rest are for components anyway. And its definitely not urgent to change this, since it would break existing users.</p>
</blockquote>
<blockquote>
<p>We might want to hold off on changing other wasmtime-wasi-* crates for now until APIs are ready for those. Basically pave a path with the core wasmtime-wasi crate but otherwise defer the actual changes to future crates to when we've shaken out all the issues here.</p>
</blockquote>
<p>Agree - lets come up with a repeatable pattern that can be applied to other crates as needed, but lets start by only applying it to wasmtime-wasi now and apply it to others immediately before landing a 0.3-draft impl in those. That way, if we discover in the buildout of wasmtime-wasi that the pattern isnt quite right, we can course-correct with a minimum of thrash.</p>
</blockquote>



<a name="495380507"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310073%20refactor%3A%20introduce%20%60p2%60%20module/near/495380507" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310073.20refactor.3A.20introduce.20.60p2.60.20module.html#495380507">(Jan 22 2025 at 21:53)</a>:</h4>
<p>pchickey edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/10073#issuecomment-2608348665">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/10073">PR #10073</a>:</p>
<blockquote>
<p>I agree with all of Alex's broad strokes here.</p>
<p>I also want to point out that landing PRs to support wasip3 in wasmtime <code>main</code> doesn't feel urgent to me. In the corresponding point in the p2 development process, we forked off a prototyping repo where we could thrash things around a bunch and not worry about compatibility as we iterated on the specs and implementations towards working code. So, aside from benefiting from more discussion of our desired end state and working backwards to figure out the changes and migrations to get there, I personally would benefit from seeing a more fleshed out implementation of p3 looks like. Currently it is spread among several different authors, repos, and PRs. Additionally, right now my employer is asking me to solve a totally different set of problems, so I don't have the bandwidth to engage with the p3 implementation process deep enough to collect all that context.</p>
<blockquote>
<p>I'm not sure if we want to keep a pub use p2::* reexport myself.</p>
</blockquote>
<p>Agree, I don't like <code>use *</code>. Please list all of the identifiers re-exported. (Is that the aspect @alexcrichton objects to?)</p>
<blockquote>
<p>This probably wants to (eventually, not necessarily here), come with a rename of the preview0 and preview1 modules to p0 and p1.</p>
</blockquote>
<p>Eventually to never would also be my prioritization. Consistency is nice in the abstract, but in this case I don't think its very important, since the interfaces being exposed by preview0 and 1 are for witx, and the rest are for components anyway. And its definitely not urgent to change this, since it would break existing users.</p>
<blockquote>
<p>We might want to hold off on changing other wasmtime-wasi-* crates for now until APIs are ready for those. Basically pave a path with the core wasmtime-wasi crate but otherwise defer the actual changes to future crates to when we've shaken out all the issues here.</p>
</blockquote>
<p>Agree - lets come up with a repeatable pattern that can be applied to other crates as needed, but lets start by only applying it to wasmtime-wasi now and apply it to others immediately before landing a 0.3-draft impl in those. That way, if we discover in the buildout of wasmtime-wasi that the pattern isnt quite right, we can course-correct with a minimum of thrash.</p>
</blockquote>



<a name="495595384"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310073%20refactor%3A%20introduce%20%60p2%60%20module/near/495595384" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310073.20refactor.3A.20introduce.20.60p2.60.20module.html#495595384">(Jan 23 2025 at 22:18)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/10073#issuecomment-2611132020">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/10073">PR #10073</a>:</p>
<blockquote>
<p>Oh to clarify for the pub use personally I prefer names to only be in one location as opposed to multiple, so I would advocate for moving most of the preexisting crate to <code>pub mod p2</code> and leaving out the top level re-export. </p>
<p>Roman would you be up for making that change and reverting other crates to their original state? That I think should create enough space to start experimenting with p3 in the main crate would be my hope.</p>
</blockquote>



<a name="496104177"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310073%20refactor%3A%20introduce%20%60p2%60%20module/near/496104177" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310073.20refactor.3A.20introduce.20.60p2.60.20module.html#496104177">(Jan 27 2025 at 11:55)</a>:</h4>
<p>rvolosatovs <a href="https://github.com/bytecodealliance/wasmtime/pull/10073#issuecomment-2615559720">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/10073">PR #10073</a>:</p>
<blockquote>
<blockquote>
<p>Oh to clarify for the pub use personally I prefer names to only be in one location as opposed to multiple, so I would advocate for moving most of the preexisting crate to <code>pub mod p2</code> and leaving out the top level re-export.</p>
<p>Roman would you be up for making that change and reverting other crates to their original state? That I think should create enough space to start experimenting with p3 in the main crate would be my hope.</p>
</blockquote>
<p>For my third attempt starting from <code>main</code>, I've went with a slightly different approach, which <em>may</em> eventually converge with the approach we're discussing here. In particular, I've split out each WASI package implementation into a separate crate:</p>
<ul>
<li><code>wasmtime-wasi-clocks</code></li>
<li><code>wasmtime-wasi-random</code></li>
<li><code>wasmtime-wasi-filesystem</code></li>
<li><code>wasmtime-wasi-sockets</code></li>
<li><code>wasmtime-wasi-cli</code></li>
</ul>
<p>Each of the crates contains <code>p3</code> module with generated bindings and implementation. Eventually, <code>p2</code> modules could be introduced to these crates as well.</p>
<p>From the embedder's perspective:</p>
<ul>
<li><code>wasmtime_wasi_cli::p2::add_to_linker</code> would function analogous to existing <code>wasmtime_wasi::add_to_linker</code>, linking in all <code>wasi:cli/imports@0.2.x</code> (<code>clocks</code>,  <code>random</code> etc.), it's gated behind <code>p2</code> feature flag</li>
<li><code>wasmtime_wasi_cli::p3::add_to_linker</code> would link in all <code>wasi:cli/imports@0.3.x</code> (behind <code>p3</code> feature flag)</li>
<li><code>wasmtime_wasi_cli::add_to_linker</code> would link in <em>both</em> <code>wasi:cli/imports@0.2.x</code> and <code>wasi:cli/imports@0.3.x</code> (behavior can be configured with crate feature flags)</li>
</ul>
<p>The exact same strategy is taken for other proposals, like clocks, random etc.</p>
<p>The benefit is that embedders can select which WASI interface implementations to link in as opposed to all-or-nothing approach (or, all/nothing/wasi:io now that <a href="https://github.com/bytecodealliance/wasmtime/pull/10036">https://github.com/bytecodealliance/wasmtime/pull/10036</a> is merged).</p>
<p>This approach also insulates the p3 work from changes in <code>wasmtime_wasi</code> (like #10036) and, in fact, avoids any breaking changes for users.</p>
<p>With the above in mind, I feel like it may be premature to break all downstream <code>wasmtime_wasi</code> users at this point by <em>moving</em> (as opposed to duplicating) current bindings into a <code>p2</code> namespace.<br>
I feel like <code>wasmtime-wasi-cli</code> crate could instead serve as a <em>replacement</em> for <code>wasmtime_wasi</code> crate in it's current shape. In that scenario <code>wasmtime_wasi</code> crate may still serve a purpose of a minimal "utility" crate (however I'd rather find a way to deprecate it altogether) and <em>most</em> downstream users would still only need to import a <em>single</em> crate (like <code>wasmtime_wasi_cli</code>)</p>
<p>I'll add an agenda item to next Wasmtime bi-weekly meeting to discuss this proposal in more detail.</p>
<p>For now I'll continue with crate-per-package approach.</p>
</blockquote>



<a name="496209299"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310073%20refactor%3A%20introduce%20%60p2%60%20module/near/496209299" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310073.20refactor.3A.20introduce.20.60p2.60.20module.html#496209299">(Jan 27 2025 at 20:48)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/10073#issuecomment-2616859748">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/10073">PR #10073</a>:</p>
<blockquote>
<p>I'm not sure I'm sold on the idea of multiple crates here, but if you'd prefer to discuss in a meeting I think that's reasonable too. The <code>wasmtime-wasi-io</code> split was some work @pchickey did for <code>no_std</code> compat which I think is still ongoing. In that sense I wouldn't necessarily consider it "final" in the sense of all other crates should look like that. In retrospect one other alternative design would be for a <code>std</code> feature that gates most of the crate except the <code>wasmtime-wasi-io</code> bits. In general I'm not sure if there's much use case for slicing and dicing WASI impls so much given how tightly coupled everything is right now (e.g. if you have <code>cap-std</code> you have the entirety of all these crates)</p>
<p>I'm also not personally sold on an <code>add_to_linker</code> which adds 0.2 and 0.3 functionality just yet. In the future I could see 0.2 becoming legacy and not desired by default, so it'd need a way to opt-out anyway.</p>
</blockquote>



<a name="511220917"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310073%20refactor%3A%20introduce%20%60p2%60%20module/near/511220917" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310073.20refactor.3A.20introduce.20.60p2.60.20module.html#511220917">(Apr 09 2025 at 16:43)</a>:</h4>
<p>rvolosatovs updated <a href="https://github.com/bytecodealliance/wasmtime/pull/10073">PR #10073</a>.</p>



<a name="511227853"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310073%20refactor%3A%20introduce%20%60p2%60%20module/near/511227853" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310073.20refactor.3A.20introduce.20.60p2.60.20module.html#511227853">(Apr 09 2025 at 17:20)</a>:</h4>
<p>rvolosatovs updated <a href="https://github.com/bytecodealliance/wasmtime/pull/10073">PR #10073</a>.</p>



<a name="511231399"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310073%20refactor%3A%20introduce%20%60p2%60%20module/near/511231399" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310073.20refactor.3A.20introduce.20.60p2.60.20module.html#511231399">(Apr 09 2025 at 17:40)</a>:</h4>
<p>rvolosatovs updated <a href="https://github.com/bytecodealliance/wasmtime/pull/10073">PR #10073</a>.</p>



<a name="511233496"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310073%20refactor%3A%20introduce%20%60p2%60%20module/near/511233496" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310073.20refactor.3A.20introduce.20.60p2.60.20module.html#511233496">(Apr 09 2025 at 17:52)</a>:</h4>
<p>rvolosatovs updated <a href="https://github.com/bytecodealliance/wasmtime/pull/10073">PR #10073</a>.</p>



<a name="511418075"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310073%20refactor%3A%20introduce%20%60p2%60%20module/near/511418075" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310073.20refactor.3A.20introduce.20.60p2.60.20module.html#511418075">(Apr 10 2025 at 13:55)</a>:</h4>
<p>rvolosatovs updated <a href="https://github.com/bytecodealliance/wasmtime/pull/10073">PR #10073</a>.</p>



<a name="511419998"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310073%20refactor%3A%20introduce%20%60p2%60%20module/near/511419998" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310073.20refactor.3A.20introduce.20.60p2.60.20module.html#511419998">(Apr 10 2025 at 14:03)</a>:</h4>
<p>rvolosatovs updated <a href="https://github.com/bytecodealliance/wasmtime/pull/10073">PR #10073</a>.</p>



<a name="511425931"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310073%20refactor%3A%20introduce%20%60p2%60%20module/near/511425931" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310073.20refactor.3A.20introduce.20.60p2.60.20module.html#511425931">(Apr 10 2025 at 14:25)</a>:</h4>
<p>rvolosatovs updated <a href="https://github.com/bytecodealliance/wasmtime/pull/10073">PR #10073</a>.</p>



<a name="511428770"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310073%20refactor%3A%20introduce%20%60p2%60%20module/near/511428770" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310073.20refactor.3A.20introduce.20.60p2.60.20module.html#511428770">(Apr 10 2025 at 14:35)</a>:</h4>
<p>rvolosatovs updated <a href="https://github.com/bytecodealliance/wasmtime/pull/10073">PR #10073</a>.</p>



<a name="511431148"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310073%20refactor%3A%20introduce%20%60p2%60%20module/near/511431148" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310073.20refactor.3A.20introduce.20.60p2.60.20module.html#511431148">(Apr 10 2025 at 14:46)</a>:</h4>
<p>rvolosatovs updated <a href="https://github.com/bytecodealliance/wasmtime/pull/10073">PR #10073</a>.</p>



<a name="511431262"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310073%20refactor%3A%20introduce%20%60p2%60%20module/near/511431262" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310073.20refactor.3A.20introduce.20.60p2.60.20module.html#511431262">(Apr 10 2025 at 14:46)</a>:</h4>
<p>rvolosatovs updated <a href="https://github.com/bytecodealliance/wasmtime/pull/10073">PR #10073</a>.</p>



<a name="511433000"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310073%20refactor%3A%20introduce%20%60p2%60%20module/near/511433000" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310073.20refactor.3A.20introduce.20.60p2.60.20module.html#511433000">(Apr 10 2025 at 14:53)</a>:</h4>
<p>rvolosatovs edited <a href="https://github.com/bytecodealliance/wasmtime/pull/10073">PR #10073</a>:</p>
<blockquote>
<p>Introduce a <code>p2</code> module in WASI crates as suggested in <a href="https://github.com/bytecodealliance/wasmtime/pull/10061#pullrequestreview-2565638530">https://github.com/bytecodealliance/wasmtime/pull/10061#pullrequestreview-2565638530</a></p>
<p>I've moved to <code>wasmtime_wasi::p2</code> submodule:</p>
<ul>
<li>wasip2 WIT files</li>
<li>generated wasip2 bindings</li>
<li>wasip2 host implementations</li>
<li>wasip2 context, view and impl structs</li>
</ul>
<p>I've left a few non-p2 specific things in <code>wasmtime_wasi</code> top-level, which I was able to reuse for p3 impl in <a href="https://github.com/bytecodealliance/wasip3-prototyping/pull/115">https://github.com/bytecodealliance/wasip3-prototyping/pull/115</a></p>
<p>I've added 3 more commits on top of the move, which seemed to make sense for consistency:</p>
<ul>
<li>rename <code>WasiCtx</code> -&gt; <code>WasiP2Ctx</code></li>
<li>rename <code>WasiView</code> -&gt; <code>WasiP2View</code></li>
<li>rename <code>WasiImpl</code> -&gt; <code>WasiP2Impl</code></li>
</ul>
<p>I opted not to rename existing <code>preview1</code> and <code>preview0</code> modules/features to avoid breaking changes.<br>
cc @pchickey </p>
</blockquote>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
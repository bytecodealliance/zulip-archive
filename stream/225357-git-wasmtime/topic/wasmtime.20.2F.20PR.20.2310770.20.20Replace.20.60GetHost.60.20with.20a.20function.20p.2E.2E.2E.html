<html>
<head><meta charset="utf-8"><title>wasmtime / PR #10770  Replace `GetHost` with a function p... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310770.20.20Replace.20.60GetHost.60.20with.20a.20function.20p.2E.2E.2E.html">wasmtime / PR #10770  Replace `GetHost` with a function p...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="517450221"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310770%20%20Replace%20%60GetHost%60%20with%20a%20function%20p.../near/517450221" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310770.20.20Replace.20.60GetHost.60.20with.20a.20function.20p.2E.2E.2E.html#517450221">(May 12 2025 at 07:23)</a>:</h4>
<p>alexcrichton opened <a href="https://github.com/bytecodealliance/wasmtime/pull/10770">PR #10770</a> from <code>alexcrichton:has-data</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>This commit is a refactoring to the fundamentals of the <code>bindgen!</code> macro<br>
and the functions that it generates. Prior to this change the<br>
fundamental entrypoint generated by <code>bindgen!</code> was a function<br>
<code>add_to_linker_get_host</code> which takes a value of type <code>G: GetHost</code>. This<br>
<code>GetHost</code> implementation is effectively an alias for a closure whose<br>
return value is able to close over the parameter given lfietime-wise.</p>
<p>The <code>GetHost</code> abstraction was added to Wasmtime originally to enable<br>
using any type that implements <code>Host</code> traits, not just <code>&amp;mut U</code> as was<br>
originally supported. The definition of <code>GetHost</code> was _just_ right to<br>
enable a type such as <code>MyThing&lt;&amp;mut T&gt;</code> to implement <code>Host</code> and a<br>
closure could be provided that could return it. At the time that<br>
<code>GetHost</code> was added it was known to be problematic from an<br>
understandability point of view, namely:</p>
<ul>
<li>It has a non-obvious definition.</li>
<li>
<p>It's pretty advanced Rust voodoo to understand what it's actually<br>
  doing</p>
</li>
<li>
<p>Using <code>GetHost</code> required lots of <code>for&lt;'a&gt; ...</code> in places which is<br>
  unfamiliar syntax for many.</p>
</li>
<li>
<p><code>GetHost</code> values couldn't be type-erased (e.g. put in a trait object)<br>
  as we couldn't figure out the lifetime syntax to do so.</p>
</li>
</ul>
<p>Despite these issues it was the only known solution at hand so we landed<br>
it and kept the previous <code>add_to_linker</code> style (<code>&amp;mut T -&gt; &amp;mut U</code>) as a<br>
convenience. While this has worked reasonable well (most folks just try<br>
to not look at <code>GetHost</code>) it has reached a breaking point in the WASIp3<br>
work.</p>
<p>In the WASIp3 work it's effectively now going to be required that the<br>
<code>G: GetHost</code> value is packaged up and actually stored inside of<br>
accessors provided to host functions. This means that <code>GetHost</code> values<br>
now need to not only be taken in <code>add_to_linker</code> but additionally<br>
provided to the rest of the system through an "accessor". This was made<br>
possible in <a href="https://github.com/bytecodealliance/wasmtime/pull/10746">https://github.com/bytecodealliance/wasmtime/pull/10746</a> by moving the <code>GetHost</code> type into Wasmtime itself (as<br>
opposed to generated code where it lived prior).</p>
<p>While this worked with WASIp3 and it was possible to plumb <code>G: GetHost</code><br>
safely around, this ended up surfacing more issues. Namely all<br>
"concurrent" host functions started getting significantly more<br>
complicated <code>where</code> clauses and type signatures. At the end of the day I<br>
felt that we had reached the end of the road to <code>GetHost</code> and wanted to<br>
search for alternatives, hence this change.</p>
<p>The fundamental purpose of <code>GetHost</code> was to be able to express, in a<br>
generic fashion:</p>
<ul>
<li>Give me a closure that takes <code>&amp;mut T</code> and returns <code>D</code>.</li>
<li>The <code>D</code> type can close over the lifetime in <code>&amp;mut T</code>.</li>
<li>The <code>D</code> type must implement <code>bindgen!</code>-generated traits.</li>
</ul>
<p>A realization I had was that we could model this with a generic<br>
associated type in Rust. Rust support for generic associated types is<br>
relatively new and not something I've used much before, but it ended up<br>
being a perfect model for this. The definition of the new <code>HasData</code><br>
trait is deceptively simple:</p>
<div class="codehilite"><pre><span></span><code>trait HasData {
    type Data&lt;&#39;a&gt;;
}
</code></pre></div>

<p>What this enables us to do though is to generate <code>add_to_linker</code><br>
functions that look like this:</p>
<div class="codehilite"><pre><span></span><code>fn add_to_linker&lt;T, D&gt;(
    linker: &amp;mut Linker&lt;T&gt;,
    getter: fn(&amp;mut T) -&gt; D::Data&lt;&#39;_&gt;,
) -&gt; Result&lt;()&gt;
  where
    D: HasData,
    for&lt;&#39;a&gt; D::Data&lt;&#39;a&gt;: Host;
</code></pre></div>

<p>This definition here models <code>G: GetHost</code> as a literal function pointer,<br>
and the ability to close over the <code>&amp;mut T</code> lifetime with type (not just<br>
<code>&amp;mut U</code>) is expressed through the type constructor <code>type Data&lt;'a&gt;</code>).<br>
Ideally we could take a generic generic associated type (I'm not even<br>
sure what to call that), but that's not something Rust has today.</p>
<p>Overall this felt like a much simpler way of modeling <code>GetHost</code> and its<br>
requirements. This plumbed well throughout the WASIp3 work and the<br>
signatures for concurrent functions felt much more appropriate in terms<br>
of complexity after this change. Taking this change to the limit means<br>
that <code>GetHost</code> in its entirety could be purged since all usages of it<br>
could be replaced with <code>fn(&amp;mut T) -&gt; D::Data&lt;'a&gt;</code>, a hopefully much<br>
more understandable type.</p>
<p>This change is not all rainbows however, there are some gotchas that<br>
remain:</p>
<ul>
<li>
<p>One is that all <code>add_to_linker</code> generated functions have a <code>D:
  HasData</code> type parameter. This type parameter cannot be inferred and<br>
  must always be explicitly specified, and it's not easy to know what to<br>
  supply here without reading documentation. Actually supplying the type<br>
  parameter is quite easy once you know what to do (and what to fill<br>
  in), but it may involve defining a small struct with a custom<br>
<code>HasData</code> implementation which can be non-obvious.</p>
</li>
<li>
<p>Another is that the <code>G: GetHost</code> value was previously a full Rust<br>
  closure, but now it's transitioning to a function pointer. This is<br>
  done in preparation for WASIp3 work where the function needs to be<br>
  passed around, and doing that behind a generic parameter is more<br>
  effort than it's worth. This means that embedders relying on the true<br>
  closure-like nature here will have to update to using a function<br>
  pointer instead.</p>
</li>
<li>
<p>The function pointer is stored in locations that require <code>'static</code>,<br>
  and while <code>fn(T)</code> might be expected to be <code>'static</code> regardless of <code>T</code><br>
  is is, in fact, not. This means that practically <code>add_to_linker</code><br>
  requires <code>T: 'static</code>. Relative to just before this change this is a<br>
  possible regression in functionality, but there orthogonal reasons<br>
  beyond just this that we want to start requiring <code>T: 'static</code> anyway.<br>
  That means that this isn't actually a regression relative to <a href="https://github.com/bytecodealliance/wasmtime/pull/10760">https://github.com/bytecodealliance/wasmtime/pull/10760</a>, a<br>
  related change.</p>
</li>
</ul>
<p>The first point is partially ameliorated with WASIp3 work insofar that<br>
the <code>D</code> type parameter will start serving as a location to specify where<br>
concurrent implementations are found. These concurrent methods don't<br>
take <code>&amp;mut self</code> but instead are implemented for <code>T: HasData</code> types. In<br>
that sense it's more justified to have this weird type parameter, but in<br>
the meantime without this support it'll feel a bit odd to have this<br>
little type parameter hanging off the side.</p>
<p>This change has been integrated into the WASIp3 prototyping repository<br>
with success. This has additionally been integrated into the Spin<br>
embedding which has one of the more complicated reliances on<br>
<code>*_get_host</code> functions known. Given that it's expected that while this<br>
is not necessarily a trivial change to rebase over it should at least be<br>
possible.</p>
<p>Finally the <code>HasData</code> trait here has been included with what I'm hoping<br>
is a sufficient amount of documentation to at least give folks a spring<br>
board to understand it. If folks have confusion about this <code>D</code> type<br>
parameter my hope is they'll make their way to <code>HasData</code> which showcases<br>
various patterns for "librarifying" host implementations of WIT<br>
interfaces. These patterns are all used throughout Wasmtime and WASI<br>
currently in crates and tests and such.</p>
</blockquote>



<a name="517450222"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310770%20%20Replace%20%60GetHost%60%20with%20a%20function%20p.../near/517450222" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310770.20.20Replace.20.60GetHost.60.20with.20a.20function.20p.2E.2E.2E.html#517450222">(May 12 2025 at 07:23)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/pchickey">pchickey</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/10770">PR #10770</a>.</p>



<a name="517450223"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310770%20%20Replace%20%60GetHost%60%20with%20a%20function%20p.../near/517450223" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310770.20.20Replace.20.60GetHost.60.20with.20a.20function.20p.2E.2E.2E.html#517450223">(May 12 2025 at 07:23)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers">wasmtime-core-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/10770">PR #10770</a>.</p>



<a name="517450224"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310770%20%20Replace%20%60GetHost%60%20with%20a%20function%20p.../near/517450224" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310770.20.20Replace.20.60GetHost.60.20with.20a.20function.20p.2E.2E.2E.html#517450224">(May 12 2025 at 07:23)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-default-reviewers">wasmtime-default-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/10770">PR #10770</a>.</p>



<a name="517450427"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310770%20%20Replace%20%60GetHost%60%20with%20a%20function%20p.../near/517450427" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310770.20.20Replace.20.60GetHost.60.20with.20a.20function.20p.2E.2E.2E.html#517450427">(May 12 2025 at 07:24)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/10770#issuecomment-2871204570">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/10770">PR #10770</a>:</p>
<blockquote>
<p>cc @lann on this as well as it relates to Spin factors and such</p>
</blockquote>



<a name="517466012"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310770%20%20Replace%20%60GetHost%60%20with%20a%20function%20p.../near/517466012" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310770.20.20Replace.20.60GetHost.60.20with.20a.20function.20p.2E.2E.2E.html#517466012">(May 12 2025 at 08:28)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/10770">PR #10770</a>.</p>



<a name="517682735"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310770%20%20Replace%20%60GetHost%60%20with%20a%20function%20p.../near/517682735" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310770.20.20Replace.20.60GetHost.60.20with.20a.20function.20p.2E.2E.2E.html#517682735">(May 12 2025 at 22:45)</a>:</h4>
<p>pchickey submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/10770#pullrequestreview-2834783645">PR review</a>:</p>
<blockquote>
<p>Thanks. I greatly prefer this to GetHost. Every time I had to use GetHost I had to look at other use sites and think hard about how to get it right, whereas this is immediately obvious. Also, changing from a closure to a function pointer should hopefully make it more clear that the purpose is projection, rather than causing a side effect, as it has been misused at least once in the past.</p>
</blockquote>



<a name="517740395"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310770%20%20Replace%20%60GetHost%60%20with%20a%20function%20p.../near/517740395" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310770.20.20Replace.20.60GetHost.60.20with.20a.20function.20p.2E.2E.2E.html#517740395">(May 13 2025 at 05:33)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/10770">PR #10770</a>.</p>



<a name="517740495"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310770%20%20Replace%20%60GetHost%60%20with%20a%20function%20p.../near/517740495" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310770.20.20Replace.20.60GetHost.60.20with.20a.20function.20p.2E.2E.2E.html#517740495">(May 13 2025 at 05:34)</a>:</h4>
<p>alexcrichton has enabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/10770">PR #10770</a>.</p>



<a name="517744231"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310770%20%20Replace%20%60GetHost%60%20with%20a%20function%20p.../near/517744231" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310770.20.20Replace.20.60GetHost.60.20with.20a.20function.20p.2E.2E.2E.html#517744231">(May 13 2025 at 06:08)</a>:</h4>
<p>alexcrichton merged <a href="https://github.com/bytecodealliance/wasmtime/pull/10770">PR #10770</a>.</p>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
<html>
<head><meta charset="utf-8"><title>wasmtime / PR #10880 Merge `vm::Instance::vmctx_plus_offs... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310880.20Merge.20.60vm.3A.3AInstance.3A.3Avmctx_plus_offs.2E.2E.2E.html">wasmtime / PR #10880 Merge `vm::Instance::vmctx_plus_offs...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="521383417"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310880%20Merge%20%60vm%3A%3AInstance%3A%3Avmctx_plus_offs.../near/521383417" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310880.20Merge.20.60vm.3A.3AInstance.3A.3Avmctx_plus_offs.2E.2E.2E.html#521383417">(May 30 2025 at 23:05)</a>:</h4>
<p>alexcrichton opened <a href="https://github.com/bytecodealliance/wasmtime/pull/10880">PR #10880</a> from <code>alexcrichton:refactor-vmctx-plus-offset</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>This commit merges two helper methods to calculate an internal pointer with a <code>VMContext</code>. Historically these two methods mapped different levels of mutability but nowadays there's no need for this. The provenance/mutability of <code>VMContext</code> memory is independent of <code>&amp;self</code> meaning that it's safe to create/mutate through a <code>NonNull</code> in the vmctx area through a <code>&amp;self</code>-derived pointer.</p>
<p>The purpose of this commit is to avoid needlessly requiring <code>&amp;mut self</code> throughout methods on <code>Instance</code>. Currently many of them require mutability to only create a pointer, and this mutability is a burden that need not be required.</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="521383419"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310880%20Merge%20%60vm%3A%3AInstance%3A%3Avmctx_plus_offs.../near/521383419" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310880.20Merge.20.60vm.3A.3AInstance.3A.3Avmctx_plus_offs.2E.2E.2E.html#521383419">(May 30 2025 at 23:05)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/fitzgen">fitzgen</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/10880">PR #10880</a>.</p>



<a name="521383421"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310880%20Merge%20%60vm%3A%3AInstance%3A%3Avmctx_plus_offs.../near/521383421" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310880.20Merge.20.60vm.3A.3AInstance.3A.3Avmctx_plus_offs.2E.2E.2E.html#521383421">(May 30 2025 at 23:05)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers">wasmtime-core-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/10880">PR #10880</a>.</p>



<a name="521384115"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310880%20Merge%20%60vm%3A%3AInstance%3A%3Avmctx_plus_offs.../near/521384115" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310880.20Merge.20.60vm.3A.3AInstance.3A.3Avmctx_plus_offs.2E.2E.2E.html#521384115">(May 30 2025 at 23:13)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/10880#issuecomment-2923699654">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/10880">PR #10880</a>:</p>
<blockquote>
<p>Hm ok thinking more about this is mainly means that <code>Sync</code> is no longer correctly inferred, as <code>Instance</code> should no longer be <code>Sync</code>. I feel like we probably do want to keep it <code>Sync</code>, though, so now I'm souring a bit on this approach.</p>
<p>I think I have an idea of how to tackle this, improve safety, and keep <code>Sync</code>, so converting this to a draft.</p>
</blockquote>



<a name="521394147"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310880%20Merge%20%60vm%3A%3AInstance%3A%3Avmctx_plus_offs.../near/521394147" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310880.20Merge.20.60vm.3A.3AInstance.3A.3Avmctx_plus_offs.2E.2E.2E.html#521394147">(May 31 2025 at 01:27)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/10880">PR #10880</a>.</p>



<a name="521394164"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310880%20Merge%20%60vm%3A%3AInstance%3A%3Avmctx_plus_offs.../near/521394164" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310880.20Merge.20.60vm.3A.3AInstance.3A.3Avmctx_plus_offs.2E.2E.2E.html#521394164">(May 31 2025 at 01:27)</a>:</h4>
<p>alexcrichton edited <a href="https://github.com/bytecodealliance/wasmtime/pull/10880">PR #10880</a>:</p>
<blockquote>
<p>Currently acquiring a mutable pointer to <code>VMContext</code> memory requires<br>
<code>&amp;mut Instance</code> which for many methods is a tall ask. Some methods are<br>
basically just reading data structures and shuffling bits around, but<br>
requiring a mutable instance prohibits their use in some contexts. The<br>
general goal of this commit is to make it possible to read, but not<br>
necessarily manipulate data structures with <code>&amp;self</code> instead of requiring<br>
<code>&amp;mut</code>.</p>
<p>Specifically this commit redefines the preexisting<br>
<code>vmctx_plus_offset{,_mut}</code> methods as returning a safe reference, not a<br>
raw reference. This ensures that the lifetime of the returned reference<br>
is scoped properly and it inherits the mutability of <code>self</code> to retain<br>
being <code>Send</code> and <code>Sync</code> by default. To make up for lost ground though<br>
this commit additionally adds a new <code>vmctx_plus_offset_raw</code> method which<br>
these prior two methods delegate to. This new method returns a<br>
<code>NonNull&lt;T&gt;</code> and is the primary way of acquiring a raw pointer to<br>
<code>VMContext</code> fields. This new method notably takes <code>&amp;self</code> as an<br>
argument.</p>
<p>The end result is that small/quick mutations of a <code>VMContext</code> are able<br>
to keep using <code>vmctx_plus_offset{,_mut}</code> with a little extra safety, but<br>
many callers have migrated to the <code>*_raw</code> variant which no longer<br>
requires <code>&amp;mut self</code>. This will end up being used in further commits and<br>
methods aren't switched over just yet.</p>
<p>It's worth noting the relevance to <a href="https://github.com/advisories/GHSA-ch89-5g45-qwc7">https://github.com/advisories/GHSA-ch89-5g45-qwc7</a> in this commit as<br>
well. Historically the acquisition of a mutable pointer from <code>&amp;self</code> led<br>
to true undefined behavior at runtime resulting in incorrect execution.<br>
This is naively moving right back to such a model where a <code>&amp;self</code>-based<br>
method is returning a pointer through which a mutation is happening, but<br>
this is crucially different in how the base <code>vmctx</code> pointer is created.<br>
Previously it was calculated as an offset from <code>&amp;self</code>, but now the<br>
<em>address</em> is calculated from <code>&amp;self</code> but the <em>provenance</em> comes from a<br>
known-mutable pointer. This construction means that annotations on<br>
<code>&amp;self</code> are not applicable to the <code>vmctx</code> pointer itself and thus not<br>
applicable to the returned pointer. In the end this means that it should<br>
be safe to acquire mutable pointers to vmctx memory from <code>&amp;self</code> on an<br>
instance.</p>
</blockquote>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
<html>
<head><meta charset="utf-8"><title>wasmtime / PR #11684 async: add stream/future producers a... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311684.20async.3A.20add.20stream.2Ffuture.20producers.20a.2E.2E.2E.html">wasmtime / PR #11684 async: add stream/future producers a...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="538920218"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311684%20async%3A%20add%20stream/future%20producers%20a.../near/538920218" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311684.20async.3A.20add.20stream.2Ffuture.20producers.20a.2E.2E.2E.html#538920218">(Sep 11 2025 at 18:24)</a>:</h4>
<p>rvolosatovs edited <a href="https://github.com/bytecodealliance/wasmtime/pull/11684">PR #11684</a>.</p>



<a name="538922424"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311684%20async%3A%20add%20stream/future%20producers%20a.../near/538922424" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311684.20async.3A.20add.20stream.2Ffuture.20producers.20a.2E.2E.2E.html#538922424">(Sep 11 2025 at 18:40)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11684#pullrequestreview-3213194623">PR review</a>.</p>



<a name="538922428"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311684%20async%3A%20add%20stream/future%20producers%20a.../near/538922428" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311684.20async.3A.20add.20stream.2Ffuture.20producers.20a.2E.2E.2E.html#538922428">(Sep 11 2025 at 18:40)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/11684#discussion_r2342032880">PR review comment</a>:</p>
<blockquote>
<p>I realize that this is optional, but it's something I've been hesitant about adding in the past (a tokio dep, even optional, in Wasmtime). If possible I'd prefer to avoid this myself (and commented below about the impl)</p>
</blockquote>



<a name="538922430"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311684%20async%3A%20add%20stream/future%20producers%20a.../near/538922430" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311684.20async.3A.20add.20stream.2Ffuture.20producers.20a.2E.2E.2E.html#538922430">(Sep 11 2025 at 18:40)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/11684#discussion_r2342031421">PR review comment</a>:</p>
<blockquote>
<p>These feel a bit surprising to me where a drop on the host is a trap in the guest, instead I might say we should remove these and instead rely on <code>impl&lt;T, D, Fut&gt; FutureProducer&lt;D&gt; for Fut</code> below. In my mind it's more appropriate to map a channel closure to <code>None</code> in components as opposed to a trap?</p>
</blockquote>



<a name="538940644"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311684%20async%3A%20add%20stream/future%20producers%20a.../near/538940644" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311684.20async.3A.20add.20stream.2Ffuture.20producers.20a.2E.2E.2E.html#538940644">(Sep 11 2025 at 20:48)</a>:</h4>
<p>rvolosatovs submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11684#pullrequestreview-3213586600">PR review</a>.</p>



<a name="538940645"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311684%20async%3A%20add%20stream/future%20producers%20a.../near/538940645" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311684.20async.3A.20add.20stream.2Ffuture.20producers.20a.2E.2E.2E.html#538940645">(Sep 11 2025 at 20:48)</a>:</h4>
<p>rvolosatovs created <a href="https://github.com/bytecodealliance/wasmtime/pull/11684#discussion_r2342305935">PR review comment</a>:</p>
<blockquote>
<p>From what I understand futures <em>must</em> produce a value and the <code>FutureProducer</code> can only ever return <code>None</code> when the poll is cancelled (i.e. <code>finish</code> is true)</p>
<p>@dicej is my understanding correct?</p>
</blockquote>



<a name="538941195"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311684%20async%3A%20add%20stream/future%20producers%20a.../near/538941195" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311684.20async.3A.20add.20stream.2Ffuture.20producers.20a.2E.2E.2E.html#538941195">(Sep 11 2025 at 20:53)</a>:</h4>
<p>rvolosatovs created <a href="https://github.com/bytecodealliance/wasmtime/pull/11684#discussion_r2342317026">PR review comment</a>:</p>
<blockquote>
<p>Other than causing a trap on host drop we could just never resolve the future, i.e. return <code>Pending</code> without ever waking the runtime or produce <code>T::default()</code><br>
Perhaps these implementations are fairly WASI-specific and should just stay in <code>wasmtime-wasi</code>, at least for now</p>
</blockquote>



<a name="538941198"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311684%20async%3A%20add%20stream/future%20producers%20a.../near/538941198" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311684.20async.3A.20add.20stream.2Ffuture.20producers.20a.2E.2E.2E.html#538941198">(Sep 11 2025 at 20:53)</a>:</h4>
<p>rvolosatovs submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11684#pullrequestreview-3213604804">PR review</a>.</p>



<a name="538957893"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311684%20async%3A%20add%20stream/future%20producers%20a.../near/538957893" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311684.20async.3A.20add.20stream.2Ffuture.20producers.20a.2E.2E.2E.html#538957893">(Sep 11 2025 at 23:53)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11684#pullrequestreview-3214037339">PR review</a>.</p>



<a name="538957894"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311684%20async%3A%20add%20stream/future%20producers%20a.../near/538957894" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311684.20async.3A.20add.20stream.2Ffuture.20producers.20a.2E.2E.2E.html#538957894">(Sep 11 2025 at 23:53)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/11684#discussion_r2342601112">PR review comment</a>:</p>
<blockquote>
<p>That's right yeah, so this would map to <code>type Item = Option&lt;T&gt;</code>, not <code>type Item = T</code> like it does now. Basically the mismatch in Rust channel semantics and component-model channel semantics I think should show up at the type-level, not the runtime 'this trapped' level</p>
</blockquote>



<a name="539024242"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311684%20async%3A%20add%20stream/future%20producers%20a.../near/539024242" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311684.20async.3A.20add.20stream.2Ffuture.20producers.20a.2E.2E.2E.html#539024242">(Sep 12 2025 at 09:49)</a>:</h4>
<p>rvolosatovs updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11684">PR #11684</a>.</p>



<a name="539026131"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311684%20async%3A%20add%20stream/future%20producers%20a.../near/539026131" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311684.20async.3A.20add.20stream.2Ffuture.20producers.20a.2E.2E.2E.html#539026131">(Sep 12 2025 at 09:59)</a>:</h4>
<p>rvolosatovs submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11684#pullrequestreview-3215863562">PR review</a>.</p>



<a name="539026134"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311684%20async%3A%20add%20stream/future%20producers%20a.../near/539026134" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311684.20async.3A.20add.20stream.2Ffuture.20producers.20a.2E.2E.2E.html#539026134">(Sep 12 2025 at 09:59)</a>:</h4>
<p>rvolosatovs created <a href="https://github.com/bytecodealliance/wasmtime/pull/11684#discussion_r2343711927">PR review comment</a>:</p>
<blockquote>
<p>I've reworked this by requiring the blanket impl futures to handle trapping directly. Although it seemed a bit dangerous to me when I originally did that, since embedders could cause a trap "on accident", I think that's fine, since these futures will actually be type bound in practice, e.g. embedders will not be able to accidentally cause a trap passing an <code>async { Err(String::from("interface-level error")) }</code> to <code>FutureReader::new</code> corresponding to <code>future&lt;result&lt;_, string&gt;&gt;</code>, since the Rust type system would require:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Future</span><span class="o">&lt;</span><span class="n">Output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">anyhow</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="nb">String</span><span class="o">&gt;&gt;&gt;</span>
</code></pre></div>
<p>With this we don't need specialized producer wrappers, but rather can use <code>Future</code>s directly</p>
</blockquote>



<a name="539573855"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311684%20async%3A%20add%20stream/future%20producers%20a.../near/539573855" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311684.20async.3A.20add.20stream.2Ffuture.20producers.20a.2E.2E.2E.html#539573855">(Sep 15 2025 at 14:25)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11684#pullrequestreview-3224926663">PR review</a>:</p>
<blockquote>
<p>Sounds good to me, thanks!</p>
</blockquote>



<a name="539579958"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311684%20async%3A%20add%20stream/future%20producers%20a.../near/539579958" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311684.20async.3A.20add.20stream.2Ffuture.20producers.20a.2E.2E.2E.html#539579958">(Sep 15 2025 at 14:48)</a>:</h4>
<p>alexcrichton merged <a href="https://github.com/bytecodealliance/wasmtime/pull/11684">PR #11684</a>.</p>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
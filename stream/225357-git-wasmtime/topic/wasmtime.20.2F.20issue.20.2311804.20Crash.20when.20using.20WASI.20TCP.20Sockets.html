<html>
<head><meta charset="utf-8"><title>wasmtime / issue #11804 Crash when using WASI TCP Sockets · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311804.20Crash.20when.20using.20WASI.20TCP.20Sockets.html">wasmtime / issue #11804 Crash when using WASI TCP Sockets</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="543589118"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311804%20Crash%20when%20using%20WASI%20TCP%20Sockets/near/543589118" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311804.20Crash.20when.20using.20WASI.20TCP.20Sockets.html#543589118">(Oct 07 2025 at 17:38)</a>:</h4>
<p>dan-bishopfox opened <a href="https://github.com/bytecodealliance/wasmtime/issues/11804">issue #11804</a>:</p>
<blockquote>
<p>I can reliably reproduce a crash in wasmtime wasi p2 sockets. </p>
<p>The setup for it is a bit complex, so I made a minimal repo to reproduce it. Instructions are there in the readme.<br>
<a href="https://github.com/dan-bishopfox/crash_wasi">https://github.com/dan-bishopfox/crash_wasi</a></p>
<p>Basically, we just use TCP sockets from within Wasm WASI p2 code and it crashes. Nothing special beyond that. The scaffolding in the repo is just there to setup some sample code that loads and runs the Wasm.</p>
<p>Let me know if there's anything else you need or if you have any issue reproducing it. <br>
Thanks!</p>
</blockquote>



<a name="543589123"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311804%20Crash%20when%20using%20WASI%20TCP%20Sockets/near/543589123" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311804.20Crash.20when.20using.20WASI.20TCP.20Sockets.html#543589123">(Oct 07 2025 at 17:38)</a>:</h4>
<p><a href="https://github.com/dan-bishopfox">dan-bishopfox</a> added the bug label to <a href="https://github.com/bytecodealliance/wasmtime/issues/11804">Issue #11804</a>.</p>



<a name="543591317"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311804%20Crash%20when%20using%20WASI%20TCP%20Sockets/near/543591317" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311804.20Crash.20when.20using.20WASI.20TCP.20Sockets.html#543591317">(Oct 07 2025 at 17:51)</a>:</h4>
<p>tschneidereit <a href="https://github.com/bytecodealliance/wasmtime/issues/11804#issuecomment-3377960050">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11804">issue #11804</a>:</p>
<blockquote>
<p>@dan-bishopfox thank you for reporting this. The Repo with the PoC isn't public it seems, PLEASE KEEP IT THAT WAY!</p>
<p>Process crashes are <a href="https://docs.wasmtime.dev/security-what-is-considered-a-security-vulnerability.html">denial-of-service attack vectors</a>, so we'd like to be able to <a href="https://bytecodealliance.org/security#disclosure-policy">disclose them responsibly</a>.</p>
<p>If you could give the @bytecodealliance/wasmtime-core team access to the repo or otherwise share it privately with us, that'd greatly appreciated!</p>
</blockquote>



<a name="543591639"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311804%20Crash%20when%20using%20WASI%20TCP%20Sockets/near/543591639" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311804.20Crash.20when.20using.20WASI.20TCP.20Sockets.html#543591639">(Oct 07 2025 at 17:53)</a>:</h4>
<p>dan-bishopfox <a href="https://github.com/bytecodealliance/wasmtime/issues/11804#issuecomment-3377966609">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11804">issue #11804</a>:</p>
<blockquote>
<p>Sure thing! I didn't notice you considered that a security issue sorry. </p>
</blockquote>



<a name="543592224"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311804%20Crash%20when%20using%20WASI%20TCP%20Sockets/near/543592224" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311804.20Crash.20when.20using.20WASI.20TCP.20Sockets.html#543592224">(Oct 07 2025 at 17:56)</a>:</h4>
<p>tschneidereit <a href="https://github.com/bytecodealliance/wasmtime/issues/11804#issuecomment-3377978906">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11804">issue #11804</a>:</p>
<blockquote>
<p>Nothing to be sorry about: while that'd make our lives easier, we certainly don't have the expectation that everyone knows our exact definition of security issues :)</p>
<p>And again, thank you for the report!</p>
</blockquote>



<a name="543592490"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311804%20Crash%20when%20using%20WASI%20TCP%20Sockets/near/543592490" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311804.20Crash.20when.20using.20WASI.20TCP.20Sockets.html#543592490">(Oct 07 2025 at 17:58)</a>:</h4>
<p>dan-bishopfox <a href="https://github.com/bytecodealliance/wasmtime/issues/11804#issuecomment-3377984409">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11804">issue #11804</a>:</p>
<blockquote>
<p>@tschneidereit I don't see the <code>@bytecodealliance/wasmtime-core</code> team in github...</p>
<p>&lt;img width="869" height="344" alt="Image" src="<a href="https://github.com/user-attachments/assets/e13b1ce0-8065-44bf-8d9d-d156b06ff072">https://github.com/user-attachments/assets/e13b1ce0-8065-44bf-8d9d-d156b06ff072</a>" /&gt;</p>
</blockquote>



<a name="543593218"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311804%20Crash%20when%20using%20WASI%20TCP%20Sockets/near/543593218" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311804.20Crash.20when.20using.20WASI.20TCP.20Sockets.html#543593218">(Oct 07 2025 at 18:01)</a>:</h4>
<p>tschneidereit <a href="https://github.com/bytecodealliance/wasmtime/issues/11804#issuecomment-3377994192">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11804">issue #11804</a>:</p>
<blockquote>
<p>oh, apparently teams are only visible within an organization, my apologies. Maybe you can invite me, @alexcrichton, and @pchickey and we do anything else necessary?</p>
</blockquote>



<a name="543593744"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311804%20Crash%20when%20using%20WASI%20TCP%20Sockets/near/543593744" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311804.20Crash.20when.20using.20WASI.20TCP.20Sockets.html#543593744">(Oct 07 2025 at 18:04)</a>:</h4>
<p>dan-bishopfox <a href="https://github.com/bytecodealliance/wasmtime/issues/11804#issuecomment-3378002009">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11804">issue #11804</a>:</p>
<blockquote>
<p>Added the three of you</p>
</blockquote>



<a name="543594301"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311804%20Crash%20when%20using%20WASI%20TCP%20Sockets/near/543594301" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311804.20Crash.20when.20using.20WASI.20TCP.20Sockets.html#543594301">(Oct 07 2025 at 18:07)</a>:</h4>
<p>pchickey <a href="https://github.com/bytecodealliance/wasmtime/issues/11804#issuecomment-3378011309">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11804">issue #11804</a>:</p>
<blockquote>
<p>Thanks I will take a look today</p>
</blockquote>



<a name="543594625"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311804%20Crash%20when%20using%20WASI%20TCP%20Sockets/near/543594625" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311804.20Crash.20when.20using.20WASI.20TCP.20Sockets.html#543594625">(Oct 07 2025 at 18:09)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/11804#issuecomment-3378018570">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11804">issue #11804</a>:</p>
<blockquote>
<p>I took a look and this isn't a security issue, so @dan-bishopfox  feel free to go ahead and make the repo public. "Crash" for us typically means a panic in the host or similar, but the crash in this case is a trap in the guest, which while it may indicate a bug is not a security issue.</p>
<p>At a cursory glance it looks like this is a bug in the guest, but we can dig in more later.</p>
</blockquote>



<a name="543604039"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311804%20Crash%20when%20using%20WASI%20TCP%20Sockets/near/543604039" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311804.20Crash.20when.20using.20WASI.20TCP.20Sockets.html#543604039">(Oct 07 2025 at 19:09)</a>:</h4>
<p>tschneidereit <a href="https://github.com/bytecodealliance/wasmtime/issues/11804#issuecomment-3378342475">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11804">issue #11804</a>:</p>
<blockquote>
<p>Thank you for investigating, Alex! And again, even if this turns out not to be a bug in Wasmtime at all, we appreciate you taking the time to put together the report and reproducer, @dan-bishopfox!</p>
</blockquote>



<a name="543604161"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311804%20Crash%20when%20using%20WASI%20TCP%20Sockets/near/543604161" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311804.20Crash.20when.20using.20WASI.20TCP.20Sockets.html#543604161">(Oct 07 2025 at 19:10)</a>:</h4>
<p>dan-bishopfox <a href="https://github.com/bytecodealliance/wasmtime/issues/11804#issuecomment-3378345543">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11804">issue #11804</a>:</p>
<blockquote>
<p>Backtrace:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">guest</span><span class="w"> </span><span class="n">error</span><span class="p">:</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">error</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="n">executing</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">wasm</span><span class="w"> </span><span class="n">backtrace</span><span class="p">:</span>
<span class="w">    </span><span class="mi">0</span><span class="p">:</span><span class="w">   </span><span class="mh">0x4a18</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">guest</span><span class="o">-</span><span class="mi">7</span><span class="n">a94999886812cfa</span><span class="p">.</span><span class="n">wasm</span><span class="o">!&lt;</span><span class="n">wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">wasi</span><span class="p">::</span><span class="n">sockets</span><span class="p">::</span><span class="n">tcp</span><span class="p">::</span><span class="n">TcpSocket</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">_rt</span><span class="p">::</span><span class="n">WasmResource</span><span class="o">&gt;</span><span class="p">::</span><span class="nb">drop</span><span class="p">::</span><span class="n">hbd600976671ef7ed</span>
<span class="w">    </span><span class="mi">1</span><span class="p">:</span><span class="w">   </span><span class="mh">0x35e9</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">guest</span><span class="o">-</span><span class="mi">7</span><span class="n">a94999886812cfa</span><span class="p">.</span><span class="n">wasm</span><span class="o">!&lt;</span><span class="n">wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">_rt</span><span class="p">::</span><span class="n">Resource</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">core</span><span class="p">::</span><span class="n">ops</span><span class="p">::</span><span class="nb">drop</span><span class="p">::</span><span class="nb">Drop</span><span class="o">&gt;</span><span class="p">::</span><span class="nb">drop</span><span class="p">::</span><span class="n">hc26cd29c2e86015f</span>
<span class="w">    </span><span class="mi">2</span><span class="p">:</span><span class="w">   </span><span class="mh">0x3564</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">guest</span><span class="o">-</span><span class="mi">7</span><span class="n">a94999886812cfa</span><span class="p">.</span><span class="n">wasm</span><span class="o">!</span><span class="n">core</span><span class="p">::</span><span class="n">ptr</span><span class="p">::</span><span class="n">drop_in_place</span><span class="o">&lt;</span><span class="n">wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">_rt</span><span class="p">::</span><span class="n">Resource</span><span class="o">&lt;</span><span class="n">wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">wasi</span><span class="p">::</span><span class="n">sockets</span><span class="p">::</span><span class="n">tcp</span><span class="p">::</span><span class="n">TcpSocket</span><span class="o">&gt;&gt;</span><span class="p">::</span><span class="n">he71c56c6c7df9336</span>
<span class="w">    </span><span class="mi">3</span><span class="p">:</span><span class="w">   </span><span class="mh">0x3b89</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">guest</span><span class="o">-</span><span class="mi">7</span><span class="n">a94999886812cfa</span><span class="p">.</span><span class="n">wasm</span><span class="o">!</span><span class="n">core</span><span class="p">::</span><span class="n">ptr</span><span class="p">::</span><span class="n">drop_in_place</span><span class="o">&lt;</span><span class="n">wasi</span><span class="p">::</span><span class="n">bindings</span><span class="p">::</span><span class="n">wasi</span><span class="p">::</span><span class="n">sockets</span><span class="p">::</span><span class="n">tcp</span><span class="p">::</span><span class="n">TcpSocket</span><span class="o">&gt;</span><span class="p">::</span><span class="n">hc04eeeba95d43492</span>
<span class="w">    </span><span class="mi">4</span><span class="p">:</span><span class="w">   </span><span class="mh">0x2542</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">guest</span><span class="o">-</span><span class="mi">7</span><span class="n">a94999886812cfa</span><span class="p">.</span><span class="n">wasm</span><span class="o">!</span><span class="n">guest</span><span class="p">::</span><span class="n">run</span><span class="p">::</span><span class="n">hd31b4c5c8b2f2f83</span>
<span class="w">    </span><span class="mi">5</span><span class="p">:</span><span class="w">   </span><span class="mh">0x1e59</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">guest</span><span class="o">-</span><span class="mi">7</span><span class="n">a94999886812cfa</span><span class="p">.</span><span class="n">wasm</span><span class="o">!</span><span class="n">guest</span><span class="p">::</span><span class="n">main</span><span class="p">::</span><span class="n">hda5a2cfc9bf0b36d</span>
<span class="w">    </span><span class="mi">6</span><span class="p">:</span><span class="w">   </span><span class="mh">0x3463</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">guest</span><span class="o">-</span><span class="mi">7</span><span class="n">a94999886812cfa</span><span class="p">.</span><span class="n">wasm</span><span class="o">!</span><span class="n">core</span><span class="p">::</span><span class="n">ops</span><span class="p">::</span><span class="n">function</span><span class="p">::</span><span class="nb">FnOnce</span><span class="p">::</span><span class="n">call_once</span><span class="p">::</span><span class="n">ha3371c02f905880a</span>
<span class="w">    </span><span class="mi">7</span><span class="p">:</span><span class="w">   </span><span class="mh">0x4308</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">guest</span><span class="o">-</span><span class="mi">7</span><span class="n">a94999886812cfa</span><span class="p">.</span><span class="n">wasm</span><span class="o">!</span><span class="n">std</span><span class="p">::</span><span class="n">sys</span><span class="p">::</span><span class="n">backtrace</span><span class="p">::</span><span class="n">__rust_begin_short_backtrace</span><span class="p">::</span><span class="n">h9a0efd7171e138ad</span>
<span class="w">    </span><span class="mi">8</span><span class="p">:</span><span class="w">   </span><span class="mh">0x40ca</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">guest</span><span class="o">-</span><span class="mi">7</span><span class="n">a94999886812cfa</span><span class="p">.</span><span class="n">wasm</span><span class="o">!</span><span class="n">std</span><span class="p">::</span><span class="n">rt</span><span class="p">::</span><span class="n">lang_start</span><span class="p">::{{</span><span class="n">closure</span><span class="p">}}::</span><span class="n">h850807c2aa8d5152</span>
<span class="w">    </span><span class="mi">9</span><span class="p">:</span><span class="w">  </span><span class="mh">0x1069b</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">guest</span><span class="o">-</span><span class="mi">7</span><span class="n">a94999886812cfa</span><span class="p">.</span><span class="n">wasm</span><span class="o">!</span><span class="n">std</span><span class="p">::</span><span class="n">rt</span><span class="p">::</span><span class="n">lang_start_internal</span><span class="p">::</span><span class="n">hd8f43a585ee7e12a</span>
<span class="w">   </span><span class="mi">10</span><span class="p">:</span><span class="w">   </span><span class="mh">0x407c</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">guest</span><span class="o">-</span><span class="mi">7</span><span class="n">a94999886812cfa</span><span class="p">.</span><span class="n">wasm</span><span class="o">!</span><span class="n">std</span><span class="p">::</span><span class="n">rt</span><span class="p">::</span><span class="n">lang_start</span><span class="p">::</span><span class="n">hcc01919a26f87998</span>
<span class="w">   </span><span class="mi">11</span><span class="p">:</span><span class="w">   </span><span class="mh">0x2fcb</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">guest</span><span class="o">-</span><span class="mi">7</span><span class="n">a94999886812cfa</span><span class="p">.</span><span class="n">wasm</span><span class="o">!</span><span class="n">__main_void</span>
<span class="w">   </span><span class="mi">12</span><span class="p">:</span><span class="w">   </span><span class="mh">0x1840</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">guest</span><span class="o">-</span><span class="mi">7</span><span class="n">a94999886812cfa</span><span class="p">.</span><span class="n">wasm</span><span class="o">!</span><span class="n">_start</span>
<span class="w">   </span><span class="mi">13</span><span class="p">:</span><span class="w"> </span><span class="mh">0x306b42</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">wit</span><span class="o">-</span><span class="n">component</span><span class="p">:</span><span class="nc">adapter</span><span class="p">:</span><span class="nc">wasi_snapshot_preview1</span><span class="o">!</span><span class="n">wasi</span><span class="p">:</span><span class="nc">cli</span><span class="o">/</span><span class="n">run</span><span class="o">@</span><span class="mf">0.2.3</span><span class="p">#</span><span class="n">run</span>
<span class="n">note</span><span class="p">:</span><span class="w"> </span><span class="nc">using</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="err">`</span><span class="n">WASMTIME_BACKTRACE_DETAILS</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="n">show</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">debugging</span><span class="w"> </span><span class="n">information</span>

<span class="n">Caused</span><span class="w"> </span><span class="n">by</span><span class="p">:</span>
<span class="w">    </span><span class="nc">resource</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">children</span><span class="p">)</span>
</code></pre></div>
<p>Also, I updated the sample code to print the backtrace. (should have done that from the start)</p>
</blockquote>



<a name="543622469"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311804%20Crash%20when%20using%20WASI%20TCP%20Sockets/near/543622469" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311804.20Crash.20when.20using.20WASI.20TCP.20Sockets.html#543622469">(Oct 07 2025 at 21:11)</a>:</h4>
<p>pchickey <a href="https://github.com/bytecodealliance/wasmtime/issues/11804#issuecomment-3378737141">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11804">issue #11804</a>:</p>
<blockquote>
<p>Instead of creating your own host, this should be reproducible using wasmtime-cli, which would make things easier for us.</p>
<p>I haven't tried to debug it, but based on the <code>resource has children</code> error my suspicion is that Rust's automatic dropping order of the <code>in_stream</code>, <code>out_stream</code>, and <code>socket</code> bindings are not in the order that wasi-sockets requires, which is for <code>in_stream</code> and <code>out_stream</code> to be dropped before the <code>socket</code> is dropped, so you could try to manually write <code>drop(in_stream); drop(out_stream); drop(socket);</code> at the end of this function to resolve that.</p>
</blockquote>



<a name="543623613"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311804%20Crash%20when%20using%20WASI%20TCP%20Sockets/near/543623613" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311804.20Crash.20when.20using.20WASI.20TCP.20Sockets.html#543623613">(Oct 07 2025 at 21:20)</a>:</h4>
<p>dan-bishopfox <a href="https://github.com/bytecodealliance/wasmtime/issues/11804#issuecomment-3378760975">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11804">issue #11804</a>:</p>
<blockquote>
<p>You might be right. I added:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="nb">drop</span><span class="p">(</span><span class="n">in_stream</span><span class="p">);</span>
<span class="nb">drop</span><span class="p">(</span><span class="n">out_stream</span><span class="p">);</span>
<span class="nb">drop</span><span class="p">(</span><span class="n">socket</span><span class="p">);</span>
</code></pre></div>
<p>And the crash doesn't seem to reproduce anymore. I hit the:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">This</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">never</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">printed</span><span class="p">.</span><span class="w"> </span><span class="n">Because</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">crashes</span><span class="w"> </span><span class="n">before</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">get</span><span class="w"> </span><span class="n">here</span><span class="p">.</span>
</code></pre></div>
<p>line.</p>
<p>It's a good workaround for the time-being anyway</p>
</blockquote>



<a name="543624992"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311804%20Crash%20when%20using%20WASI%20TCP%20Sockets/near/543624992" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311804.20Crash.20when.20using.20WASI.20TCP.20Sockets.html#543624992">(Oct 07 2025 at 21:31)</a>:</h4>
<p>pchickey <a href="https://github.com/bytecodealliance/wasmtime/issues/11804#issuecomment-3378786975">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11804">issue #11804</a>:</p>
<blockquote>
<p>That drop order restriction goes away in wasip3, but you'll have to live with it in wasip2 for now.</p>
<p>I'd suggest that you use wstd, which papers over a lot of the not so great parts of the wasip2 bindings, but it doesn't actually have support for tcp connect right now. It could be added, but I'm in the middle of various other things on it currently.</p>
</blockquote>



<a name="543631012"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311804%20Crash%20when%20using%20WASI%20TCP%20Sockets/near/543631012" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311804.20Crash.20when.20using.20WASI.20TCP.20Sockets.html#543631012">(Oct 07 2025 at 22:24)</a>:</h4>
<p>alexcrichton closed <a href="https://github.com/bytecodealliance/wasmtime/issues/11804">issue #11804</a>:</p>
<blockquote>
<p>I can reliably reproduce a crash in wasmtime wasi p2 sockets. </p>
<p>The setup for it is a bit complex, so I made a minimal repo to reproduce it. Instructions are there in the readme.<br>
<a href="https://github.com/dan-bishopfox/crash_wasi">https://github.com/dan-bishopfox/crash_wasi</a></p>
<p>Basically, we just use TCP sockets from within Wasm WASI p2 code and it crashes. Nothing special beyond that. The scaffolding in the repo is just there to setup some sample code that loads and runs the Wasm.</p>
<p>Let me know if there's anything else you need or if you have any issue reproducing it. <br>
Thanks!</p>
</blockquote>



<a name="543631014"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311804%20Crash%20when%20using%20WASI%20TCP%20Sockets/near/543631014" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311804.20Crash.20when.20using.20WASI.20TCP.20Sockets.html#543631014">(Oct 07 2025 at 22:24)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/11804#issuecomment-3378918196">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11804">issue #11804</a>:</p>
<blockquote>
<p>Ah ok, yes indeed! In that case I don't believe that this is a bug in Wasmtime, so I'm going to close this.</p>
</blockquote>



<a name="543631627"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311804%20Crash%20when%20using%20WASI%20TCP%20Sockets/near/543631627" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311804.20Crash.20when.20using.20WASI.20TCP.20Sockets.html#543631627">(Oct 07 2025 at 22:30)</a>:</h4>
<p>dan-bishopfox <a href="https://github.com/bytecodealliance/wasmtime/issues/11804#issuecomment-3378929430">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11804">issue #11804</a>:</p>
<blockquote>
<p>Where should I report this to then? For tracking until it's properly fixed? Or is the answer that it's likely to just not be fixed in wasi p2?</p>
</blockquote>



<a name="543631801"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311804%20Crash%20when%20using%20WASI%20TCP%20Sockets/near/543631801" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311804.20Crash.20when.20using.20WASI.20TCP.20Sockets.html#543631801">(Oct 07 2025 at 22:31)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/11804#issuecomment-3378932015">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11804">issue #11804</a>:</p>
<blockquote>
<p>Yeah wasip2 won't be changing at this point so the bug is in the guest mostly, where it needs to interface with APIs differently.</p>
</blockquote>



<a name="543632074"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311804%20Crash%20when%20using%20WASI%20TCP%20Sockets/near/543632074" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311804.20Crash.20when.20using.20WASI.20TCP.20Sockets.html#543632074">(Oct 07 2025 at 22:34)</a>:</h4>
<p>dan-bishopfox <a href="https://github.com/bytecodealliance/wasmtime/issues/11804#issuecomment-3378937761">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11804">issue #11804</a>:</p>
<blockquote>
<p>Perhaps just a documentation change to <code>create_tcp_socket</code> to make it clear that the TcpSocket object has to be drop'ed last (after the in/out streams). Since otherwise that fact's not obvious. </p>
</blockquote>



<a name="543632306"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311804%20Crash%20when%20using%20WASI%20TCP%20Sockets/near/543632306" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311804.20Crash.20when.20using.20WASI.20TCP.20Sockets.html#543632306">(Oct 07 2025 at 22:37)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/11804#issuecomment-3378941558">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11804">issue #11804</a>:</p>
<blockquote>
<p>Sure yeah! For doc updates to WASI APIs you can send PRs to the repositories themselves, such as <a href="https://github.com/WebAssembly/wasi-sockets/">https://github.com/WebAssembly/wasi-sockets/</a></p>
</blockquote>



<a name="544244063"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311804%20Crash%20when%20using%20WASI%20TCP%20Sockets/near/544244063" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311804.20Crash.20when.20using.20WASI.20TCP.20Sockets.html#544244063">(Oct 10 2025 at 20:40)</a>:</h4>
<p>dan-bishopfox <a href="https://github.com/bytecodealliance/wasmtime/issues/11804#issuecomment-3392255730">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11804">issue #11804</a>:</p>
<blockquote>
<p>Hey, sorry to bug you all again but I ran into another crash that looks related. I added the manual <code>drop</code> code in the order of <code>InputStream</code> -&gt; <code>OutputStream</code> -&gt; <code>TcpSocket</code>. But it's the <code>InputStream</code> this time that's complaining. </p>
<div class="codehilite" data-code-language="component"><pre><span></span><code>    0:  0x4199e - guest-561fe04e002e2417.wasm!_ZN100_$LT$wasi..bindings..wasi..io..streams..InputStream$u20$as$u20$wasi..bindings.._rt..WasmResource$GT$4drop17ha956dcecfc0cbaa7E
    1:  0x291ff - guest-561fe04e002e2417.wasm!_ZN80_$LT$wasi..bindings.._rt..Resource$LT$T$GT$$u20$as$u20$core..ops..drop..Drop$GT$4drop17he5627ea0b2554dd0E
    2:  0x291ad - guest-561fe04e002e2417.wasm!_ZN4core3ptr104drop_in_place$LT$wasi..bindings.._rt..Resource$LT$wasi..bindings..wasi..io..streams..InputStream$GT$$GT$17h65226a4f2f498a40E
    3:  0x2ab16 - guest-561fe04e002e2417.wasm!_ZN4core3ptr67drop_in_place$LT$wasi..bindings..wasi..io..streams..InputStream$GT$17hd1a71f0212bef4d7E
    4:  0x2a5fe - guest-561fe04e002e2417.wasm!_ZN4core3ptr95drop_in_place$LT$core..option..Option$LT$wasi..bindings..wasi..io..streams..InputStream$GT$$GT$17hc491081ad7572c7fE
    5:  0x2a572 - guest-561fe04e002e2417.wasm!_ZN4core3ptr63drop_in_place$LT$guest..commands..core..proxy..SocksProxy$GT$17ha2600ea8687860acE
    6:  0x2b61c - guest-561fe04e002e2417.wasm!_ZN4core3ptr91drop_in_place$LT$core..option..Option$LT$guest..commands..core..proxy..SocksProxy$GT$$GT$17h3ce2633f2d544ea0E
&gt; This is my business logic function here.    7:  0x14d3d - guest-561fe04e002e2417.wasm!_ZN7guest23handle_async_proxy_data17h35916648c6278204E
    8:  0x17072 - guest-561fe04e002e2417.wasm!_ZN7guest3run17h035dd1919c4b29b8E
    9:  0x17c35 - guest-561fe04e002e2417.wasm!_ZN7guest4main17h355a4d4b6be6a3aeE
   10:  0x28f4c - guest-561fe04e002e2417.wasm!_ZN4core3ops8function6FnOnce9call_once17h665b2f14ac85f0eaE
   11:  0x1ddee - guest-561fe04e002e2417.wasm!_ZN3std3sys9backtrace28__rust_begin_short_backtrace17h973638772f410a9eE
   12:   0x7cdf - guest-561fe04e002e2417.wasm!_ZN3std2rt10lang_start28_$u7b$$u7b$closure$u7d$$u7d$17h8206f535aef5eeb8E
   13: 0x262d03 - guest-561fe04e002e2417.wasm!_ZN3std2rt19lang_start_internal17h606819bf9b1f641dE
   14:   0x7ca5 - guest-561fe04e002e2417.wasm!_ZN3std2rt10lang_start17hd5c9a870f35d74dcE
   15:  0x17c5c - guest-561fe04e002e2417.wasm!__main_void
   16:   0x7a12 - guest-561fe04e002e2417.wasm!_start
   17: 0x20bd16d - wit-component:adapter:wasi_snapshot_preview1!wasi:cli/run@0.2.6#run
</code></pre></div>
<p>Is there something obvious in this that I might be doing wrong? Some other resource that needs to be cleaned up in a potentially undocumented way?</p>
</blockquote>



<a name="544246896"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311804%20Crash%20when%20using%20WASI%20TCP%20Sockets/near/544246896" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311804.20Crash.20when.20using.20WASI.20TCP.20Sockets.html#544246896">(Oct 10 2025 at 21:02)</a>:</h4>
<p>pchickey <a href="https://github.com/bytecodealliance/wasmtime/issues/11804#issuecomment-3392302351">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11804">issue #11804</a>:</p>
<blockquote>
<p>The Pollable associated with the InputStream needs to be dropped before the InputStream</p>
</blockquote>



<a name="544246945"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311804%20Crash%20when%20using%20WASI%20TCP%20Sockets/near/544246945" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311804.20Crash.20when.20using.20WASI.20TCP.20Sockets.html#544246945">(Oct 10 2025 at 21:03)</a>:</h4>
<p>pchickey edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/11804#issuecomment-3392302351">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11804">issue #11804</a>:</p>
<blockquote>
<p>The Pollable associated with the InputStream (got from InputStream::subscribe) needs to be dropped before the InputStream</p>
</blockquote>



<a name="544250230"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311804%20Crash%20when%20using%20WASI%20TCP%20Sockets/near/544250230" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311804.20Crash.20when.20using.20WASI.20TCP.20Sockets.html#544250230">(Oct 10 2025 at 21:27)</a>:</h4>
<p>dan-bishopfox <a href="https://github.com/bytecodealliance/wasmtime/issues/11804#issuecomment-3392348363">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11804">issue #11804</a>:</p>
<blockquote>
<p>That did the trick! Thanks a lot!</p>
</blockquote>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
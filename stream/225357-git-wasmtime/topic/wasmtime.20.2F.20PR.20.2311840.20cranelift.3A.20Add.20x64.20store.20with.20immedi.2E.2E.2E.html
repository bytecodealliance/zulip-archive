<html>
<head><meta charset="utf-8"><title>wasmtime / PR #11840 cranelift: Add x64 store with immedi... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311840.20cranelift.3A.20Add.20x64.20store.20with.20immedi.2E.2E.2E.html">wasmtime / PR #11840 cranelift: Add x64 store with immedi...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="544383465"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311840%20cranelift%3A%20Add%20x64%20store%20with%20immedi.../near/544383465" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311840.20cranelift.3A.20Add.20x64.20store.20with.20immedi.2E.2E.2E.html#544383465">(Oct 12 2025 at 08:54)</a>:</h4>
<p>jiang1997 opened <a href="https://github.com/bytecodealliance/wasmtime/pull/11840">PR #11840</a> from <code>jiang1997:x64-store-imm-zero-optimization</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>Add support for generating efficient <code>mov [mem], imm</code> instructions for immediate values, eliminating the need for temporary registers when storing constants.</p>
<p>Changes:</p>
<ul>
<li>Add <code>Inst::store_imm()</code> function supporting immediate values for I8/I16/I32/I64 types with proper range checking</li>
<li>Update stack probing to use direct immediate store</li>
<li>Add comprehensive test coverage for all integer types and edge cases:<ul>
<li>I8: full range (-128 to 127)</li>
<li>I16: full range (-32768 to 32767)</li>
<li>I32: full range (i32::MIN to i32::MAX)</li>
<li>I64: sign-extended i32 range (hardware limitation)</li>
</ul>
</li>
</ul>
<p>The I64 type is limited to sign-extended i32 values (-2^31 to 2^31-1) due to x86-64 MOV instruction encoding constraints. Values outside this range will panic with a clear error message.</p>
<p>Before: mov r10, 0x42; mov [rsp], r10  (2 instructions, needs register)<br>
After:  mov dword ptr [rsp], 0x42      (1 instruction, no register)</p>
<p>This addresses the TODO comment in <a href="http://abi.rs">abi.rs</a> about wanting to store immediate values directly to memory without temporary registers.</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="544383467"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311840%20cranelift%3A%20Add%20x64%20store%20with%20immedi.../near/544383467" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311840.20cranelift.3A.20Add.20x64.20store.20with.20immedi.2E.2E.2E.html#544383467">(Oct 12 2025 at 08:54)</a>:</h4>
<p><strong>jiang1997</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/11840">PR #11840</a>.</p>



<a name="544383468"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311840%20cranelift%3A%20Add%20x64%20store%20with%20immedi.../near/544383468" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311840.20cranelift.3A.20Add.20x64.20store.20with.20immedi.2E.2E.2E.html#544383468">(Oct 12 2025 at 08:54)</a>:</h4>
<p><strong>jiang1997</strong> requested <a href="https://github.com/alexcrichton">alexcrichton</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/11840">PR #11840</a>.</p>



<a name="544384401"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311840%20cranelift%3A%20Add%20x64%20store%20with%20immedi.../near/544384401" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311840.20cranelift.3A.20Add.20x64.20store.20with.20immedi.2E.2E.2E.html#544384401">(Oct 12 2025 at 09:09)</a>:</h4>
<p>jiang1997 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11840">PR #11840</a>.</p>



<a name="544384960"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311840%20cranelift%3A%20Add%20x64%20store%20with%20immedi.../near/544384960" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311840.20cranelift.3A.20Add.20x64.20store.20with.20immedi.2E.2E.2E.html#544384960">(Oct 12 2025 at 09:19)</a>:</h4>
<p>jiang1997 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11840">PR #11840</a>.</p>



<a name="544386603"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311840%20cranelift%3A%20Add%20x64%20store%20with%20immedi.../near/544386603" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311840.20cranelift.3A.20Add.20x64.20store.20with.20immedi.2E.2E.2E.html#544386603">(Oct 12 2025 at 09:50)</a>:</h4>
<p>jiang1997 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11840">PR #11840</a>.</p>



<a name="544567431"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311840%20cranelift%3A%20Add%20x64%20store%20with%20immedi.../near/544567431" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311840.20cranelift.3A.20Add.20x64.20store.20with.20immedi.2E.2E.2E.html#544567431">(Oct 13 2025 at 14:27)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11840#pullrequestreview-3331865081">PR review</a>:</p>
<blockquote>
<p>Thanks for the PR!  What I might recommend instead though is that we've generally been moving away from <code>Inst</code>-style helpers to construct instructions with the advent of the x64 assembler crate. The one use case for <code>Inst::store_imm</code>, for example, can unconditionally use the <code>movl_mi</code> variant and there's no need for encoding tests or making API design decisions about whether out-of-bounds integers panic or such. </p>
<p>What would you think about replacing the store on the stack here with <code>movl_mi</code> directly, and dropping the new <code>store_imm</code> helper?</p>
</blockquote>



<a name="544607902"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311840%20cranelift%3A%20Add%20x64%20store%20with%20immedi.../near/544607902" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311840.20cranelift.3A.20Add.20x64.20store.20with.20immedi.2E.2E.2E.html#544607902">(Oct 13 2025 at 18:58)</a>:</h4>
<p>jiang1997 updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11840">PR #11840</a>.</p>



<a name="544608152"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311840%20cranelift%3A%20Add%20x64%20store%20with%20immedi.../near/544608152" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311840.20cranelift.3A.20Add.20x64.20store.20with.20immedi.2E.2E.2E.html#544608152">(Oct 13 2025 at 19:00)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11840#pullrequestreview-3332706205">PR review</a>.</p>



<a name="544608173"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311840%20cranelift%3A%20Add%20x64%20store%20with%20immedi.../near/544608173" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311840.20cranelift.3A.20Add.20x64.20store.20with.20immedi.2E.2E.2E.html#544608173">(Oct 13 2025 at 19:00)</a>:</h4>
<p>alexcrichton has enabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/11840">PR #11840</a>.</p>



<a name="544608254"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311840%20cranelift%3A%20Add%20x64%20store%20with%20immedi.../near/544608254" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311840.20cranelift.3A.20Add.20x64.20store.20with.20immedi.2E.2E.2E.html#544608254">(Oct 13 2025 at 19:01)</a>:</h4>
<p>jiang1997 edited <a href="https://github.com/bytecodealliance/wasmtime/pull/11840">PR #11840</a>:</p>
<blockquote>
<ul>
<li>Switch the probestack store to mov [rsp], 0 via movl_mi, still touching the page without writing %rsp back to memory.</li>
<li>Updated the corresponding inline probestack filetests.</li>
</ul>
</blockquote>



<a name="544610203"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311840%20cranelift%3A%20Add%20x64%20store%20with%20immedi.../near/544610203" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311840.20cranelift.3A.20Add.20x64.20store.20with.20immedi.2E.2E.2E.html#544610203">(Oct 13 2025 at 19:21)</a>:</h4>
<p>jiang1997 <a href="https://github.com/bytecodealliance/wasmtime/pull/11840#issuecomment-3398766891">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11840">PR #11840</a>:</p>
<blockquote>
<p>@alexcrichton<br>
Hey, just noticed that changing from <code>mov [rsp], esp</code> to <code>mov [rsp], 0</code> increases the instruction size from 3 bytes to 7 bytes.<br>
Is this code size increase acceptable? Alternatively, we could keep <code>mov [rsp], rsp</code> and just document it in a comment (resolves the TODO while avoiding the size increase).</p>
</blockquote>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
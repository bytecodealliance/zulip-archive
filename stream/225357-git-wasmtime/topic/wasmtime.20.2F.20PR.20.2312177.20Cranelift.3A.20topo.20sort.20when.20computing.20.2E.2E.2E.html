<html>
<head><meta charset="utf-8"><title>wasmtime / PR #12177 Cranelift: topo sort when computing ... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312177.20Cranelift.3A.20topo.20sort.20when.20computing.20.2E.2E.2E.html">wasmtime / PR #12177 Cranelift: topo sort when computing ...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="564343005"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312177%20Cranelift%3A%20topo%20sort%20when%20computing%20.../near/564343005" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312177.20Cranelift.3A.20topo.20sort.20when.20computing.20.2E.2E.2E.html#564343005">(Dec 17 2025 at 21:09)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/cfallin">cfallin</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/12177">PR #12177</a>.</p>



<a name="564343007"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312177%20Cranelift%3A%20topo%20sort%20when%20computing%20.../near/564343007" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312177.20Cranelift.3A.20topo.20sort.20when.20computing.20.2E.2E.2E.html#564343007">(Dec 17 2025 at 21:09)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/12177">PR #12177</a>.</p>



<a name="564343009"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312177%20Cranelift%3A%20topo%20sort%20when%20computing%20.../near/564343009" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312177.20Cranelift.3A.20topo.20sort.20when.20computing.20.2E.2E.2E.html#564343009">(Dec 17 2025 at 21:09)</a>:</h4>
<p>fitzgen opened <a href="https://github.com/bytecodealliance/wasmtime/pull/12177">PR #12177</a> from <code>fitzgen:egraph-cost-function-topo-sort</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>This lets us avoid a fixpoint loop. In practice, the fixpoint loop almost always converged after only one or two iterations (plus one more iteration to learn that we did in fact converge) but we do see as high as fourteen iterations in Sightglass's <code>pulldown-cmark</code> and 12 in <code>spidermonkey.wasm</code>.</p>
<p>A topo sort is effectively one pass over the IR, after which we know that we converge after a single iteration of the loop that used to be inside the fixpoint. The fixpoint loop did two iterations at best (one to converge, and one to learn that it converged) so this is basically no worse in the best case for the fixpoint loop. However, the new approach's worst case is the same as its best case, which is definitely not true for the fixpoint loop (becomes quadratic at worse).</p>
<p>This does not affect the best costs we compute for each value at all, and therefore does not affect our generated code at all (e.g. note that the filetests and disas tests are unmodified in this commit).</p>
<p>Despite improving worst-case algorithmic complexity, it does not seem to have any statistically significant affect on compilation time for Sightglass's default benchmark suite either:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">compilation</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">instructions</span><span class="o">-</span><span class="n">retired</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">benchmarks</span><span class="o">/</span><span class="n">pulldown</span><span class="o">-</span><span class="n">cmark</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="n">No</span><span class="w"> </span><span class="n">difference</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">performance</span><span class="p">.</span>

<span class="w">  </span><span class="p">[</span><span class="mi">14272577</span><span class="w"> </span><span class="mf">14343801.70</span><span class="w"> </span><span class="mi">14428315</span><span class="p">]</span><span class="w"> </span><span class="n">main</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="p">(</span><span class="o">-</span><span class="n">Cparallel</span><span class="o">-</span><span class="n">compilation</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
<span class="w">  </span><span class="p">[</span><span class="mi">14332259</span><span class="w"> </span><span class="mf">14376054.10</span><span class="w"> </span><span class="mi">14452731</span><span class="p">]</span><span class="w"> </span><span class="n">topo</span><span class="o">-</span><span class="n">sort</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="p">(</span><span class="o">-</span><span class="n">Cparallel</span><span class="o">-</span><span class="n">compilation</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>

<span class="n">compilation</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">instructions</span><span class="o">-</span><span class="n">retired</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">benchmarks</span><span class="o">/</span><span class="n">spidermonkey</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="n">No</span><span class="w"> </span><span class="n">difference</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">performance</span><span class="p">.</span>

<span class="w">  </span><span class="p">[</span><span class="mi">494880425</span><span class="w"> </span><span class="mf">497004543.50</span><span class="w"> </span><span class="mi">497423796</span><span class="p">]</span><span class="w"> </span><span class="n">main</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="p">(</span><span class="o">-</span><span class="n">Cparallel</span><span class="o">-</span><span class="n">compilation</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
<span class="w">  </span><span class="p">[</span><span class="mi">496100425</span><span class="w"> </span><span class="mf">496346205.40</span><span class="w"> </span><span class="mi">496691007</span><span class="p">]</span><span class="w"> </span><span class="n">topo</span><span class="o">-</span><span class="n">sort</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="p">(</span><span class="o">-</span><span class="n">Cparallel</span><span class="o">-</span><span class="n">compilation</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>

<span class="n">compilation</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">instructions</span><span class="o">-</span><span class="n">retired</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="nc">benchmarks</span><span class="o">/</span><span class="n">bz2</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">wasm</span>

<span class="w">  </span><span class="n">No</span><span class="w"> </span><span class="n">difference</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">performance</span><span class="p">.</span>

<span class="w">  </span><span class="p">[</span><span class="mi">3499081</span><span class="w"> </span><span class="mf">3517541.70</span><span class="w"> </span><span class="mi">3552882</span><span class="p">]</span><span class="w"> </span><span class="n">main</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="p">(</span><span class="o">-</span><span class="n">Cparallel</span><span class="o">-</span><span class="n">compilation</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
<span class="w">  </span><span class="p">[</span><span class="mi">3498186</span><span class="w"> </span><span class="mf">3514863.90</span><span class="w"> </span><span class="mi">3531898</span><span class="p">]</span><span class="w"> </span><span class="n">topo</span><span class="o">-</span><span class="n">sort</span><span class="p">.</span><span class="n">so</span><span class="w"> </span><span class="p">(</span><span class="o">-</span><span class="n">Cparallel</span><span class="o">-</span><span class="n">compilation</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
</code></pre></div>
<p>cc <a href="https://github.com/bytecodealliance/wasmtime/issues/12156">https://github.com/bytecodealliance/wasmtime/issues/12156</a></p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="564344085"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312177%20Cranelift%3A%20topo%20sort%20when%20computing%20.../near/564344085" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312177.20Cranelift.3A.20topo.20sort.20when.20computing.20.2E.2E.2E.html#564344085">(Dec 17 2025 at 21:18)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/12177">PR #12177</a>.</p>



<a name="564345025"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312177%20Cranelift%3A%20topo%20sort%20when%20computing%20.../near/564345025" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312177.20Cranelift.3A.20topo.20sort.20when.20computing.20.2E.2E.2E.html#564345025">(Dec 17 2025 at 21:24)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/12177#pullrequestreview-3589736861">PR review</a>:</p>
<blockquote>
<p>Nice -- thanks for this improvement!</p>
</blockquote>



<a name="564345068"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312177%20Cranelift%3A%20topo%20sort%20when%20computing%20.../near/564345068" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312177.20Cranelift.3A.20topo.20sort.20when.20computing.20.2E.2E.2E.html#564345068">(Dec 17 2025 at 21:25)</a>:</h4>
<p>cfallin has enabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/12177">PR #12177</a>.</p>



<a name="564349067"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312177%20Cranelift%3A%20topo%20sort%20when%20computing%20.../near/564349067" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312177.20Cranelift.3A.20topo.20sort.20when.20computing.20.2E.2E.2E.html#564349067">(Dec 17 2025 at 21:54)</a>:</h4>
<p>cfallin merged <a href="https://github.com/bytecodealliance/wasmtime/pull/12177">PR #12177</a>.</p>



<hr><p>Last updated: Feb 22 2026 at 11:05 UTC</p>
</html>
<html>
<head><meta charset="utf-8"><title>wasmtime / issue #11927 Cranelift: `opt_level=speed` brea... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311927.20Cranelift.3A.20.60opt_level.3Dspeed.60.20brea.2E.2E.2E.html">wasmtime / issue #11927 Cranelift: `opt_level=speed` brea...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="546730101"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311927%20Cranelift%3A%20%60opt_level%3Dspeed%60%20brea.../near/546730101" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311927.20Cranelift.3A.20.60opt_level.3Dspeed.60.20brea.2E.2E.2E.html#546730101">(Oct 23 2025 at 17:01)</a>:</h4>
<p>emturner opened <a href="https://github.com/bytecodealliance/wasmtime/issues/11927">issue #11927</a>:</p>
<blockquote>
<p>When compiling with <code>opt_level=speed</code>, <code>sdiv i64::MIN, i64::MIN</code> returns <code>-1</code> instead of <code>1</code>.</p>
<p>The same occurs with <code>opt_level=speed_and_size</code>.</p>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">test</span><span class="w"> </span><span class="n">interpret</span>
<span class="n">test</span><span class="w"> </span><span class="n">run</span>
<span class="n">set</span><span class="w"> </span><span class="n">opt_level</span><span class="o">=</span><span class="n">speed</span>
<span class="n">target</span><span class="w"> </span><span class="n">x86_64</span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">sdiv_by_const_neg_i64min_i64</span><span class="p">(</span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="p">{</span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span><span class="p">:</span><span class="w"> </span><span class="kt">i64</span><span class="p">):</span>
<span class="w">    </span><span class="nc">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="o">-</span><span class="mi">9223372036854775808</span>
<span class="w">    </span><span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sdiv</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v2</span>
<span class="p">}</span>

<span class="p">;</span><span class="w"> </span><span class="n">run</span><span class="p">:</span><span class="w"> </span><span class="o">%</span><span class="n">sdiv_by_const_neg_i64min_i64</span><span class="p">(</span><span class="o">-</span><span class="mi">9223372036854775808</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<ul>
<li>add the above in <code>cranelift/filetests/filetests/runtests/sdiv-broken.clif</code></li>
<li><code>cd cranelift</code></li>
<li><code>cargo +1.88.0 run -- test filetests/filetests/runtests/sdiv-broken.clif</code></li>
</ul>
<h3>Expected Results</h3>
<p>The test should pass. <code>i64::MIN / i64::MIN == 1</code>.</p>
<h3>Actual Results</h3>
<p>We get an incorrect result: <code>i64::MIN / i64::MIN == -1</code></p>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: f678260bb3b2fa07ae10737f581b2d395d3349da is the first commit that causes the issue.</p>
<p>All cranelift versions from then on (1.22.0 -&gt; current @ 1.25.1) are affected.</p>
<p>Operating system: Guix Linux @ 6.16.7,   Ubuntu 24.04.3 LTS. Mac M2 possibly also affected (will confirm).</p>
<p>Architecture: AMD64, x86_64</p>
<h3>Extra Info</h3>
<p>As far as I can tell, the algorithm for the 'const denominator division' is correct. Indeed the proptests are correct. There appears to be some issue in how the constants are all inligned from the <code>smulhi</code> and the various shifts in the fast algorithm. All other values appear to work correctly.<br>
</p>
</blockquote>



<a name="546730102"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311927%20Cranelift%3A%20%60opt_level%3Dspeed%60%20brea.../near/546730102" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311927.20Cranelift.3A.20.60opt_level.3Dspeed.60.20brea.2E.2E.2E.html#546730102">(Oct 23 2025 at 17:01)</a>:</h4>
<p><a href="https://github.com/emturner">emturner</a> added the bug label to <a href="https://github.com/bytecodealliance/wasmtime/issues/11927">Issue #11927</a>.</p>



<a name="546730104"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311927%20Cranelift%3A%20%60opt_level%3Dspeed%60%20brea.../near/546730104" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311927.20Cranelift.3A.20.60opt_level.3Dspeed.60.20brea.2E.2E.2E.html#546730104">(Oct 23 2025 at 17:01)</a>:</h4>
<p><a href="https://github.com/emturner">emturner</a> added the cranelift label to <a href="https://github.com/bytecodealliance/wasmtime/issues/11927">Issue #11927</a>.</p>



<a name="546737548"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311927%20Cranelift%3A%20%60opt_level%3Dspeed%60%20brea.../near/546737548" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311927.20Cranelift.3A.20.60opt_level.3Dspeed.60.20brea.2E.2E.2E.html#546737548">(Oct 23 2025 at 17:43)</a>:</h4>
<p>emturner edited <a href="https://github.com/bytecodealliance/wasmtime/issues/11927">issue #11927</a>:</p>
<blockquote>
<p>When compiling with <code>opt_level=speed</code>, <code>sdiv i64::MIN, i64::MIN</code> returns <code>-1</code> instead of <code>1</code>.</p>
<p>The same occurs with <code>opt_level=speed_and_size</code>.</p>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">test</span><span class="w"> </span><span class="n">interpret</span>
<span class="n">test</span><span class="w"> </span><span class="n">run</span>
<span class="n">set</span><span class="w"> </span><span class="n">opt_level</span><span class="o">=</span><span class="n">speed</span>
<span class="n">target</span><span class="w"> </span><span class="n">x86_64</span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">sdiv_by_const_neg_i64min_i64</span><span class="p">(</span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="p">{</span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span><span class="p">:</span><span class="w"> </span><span class="kt">i64</span><span class="p">):</span>
<span class="w">    </span><span class="nc">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="o">-</span><span class="mi">9223372036854775808</span>
<span class="w">    </span><span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sdiv</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v2</span>
<span class="p">}</span>

<span class="p">;</span><span class="w"> </span><span class="n">run</span><span class="p">:</span><span class="w"> </span><span class="o">%</span><span class="n">sdiv_by_const_neg_i64min_i64</span><span class="p">(</span><span class="o">-</span><span class="mi">9223372036854775808</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<ul>
<li>add the above in <code>cranelift/filetests/filetests/runtests/sdiv-broken.clif</code></li>
<li><code>cd cranelift</code></li>
<li><code>cargo +1.88.0 run -- test filetests/filetests/runtests/sdiv-broken.clif</code></li>
</ul>
<h3>Expected Results</h3>
<p>The test should pass. <code>i64::MIN / i64::MIN == 1</code>.</p>
<h3>Actual Results</h3>
<p>We get an incorrect result: <code>i64::MIN / i64::MIN == -1</code></p>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: f678260bb3b2fa07ae10737f581b2d395d3349da is the first commit that causes the issue.</p>
<p>All cranelift versions from then on (1.22.0 -&gt; current @ 1.25.1) are affected.</p>
<p>Operating system: Guix Linux @ 6.16.7,   Ubuntu 24.04.3 LTS. Mac M2 possibly also affected (will confirm).</p>
<p>Architecture: AMD64, x86_64</p>
<h3>Extra Info</h3>
<p>As far as I can tell, the algorithm for the 'const denominator division' is correct. Indeed the proptests cover this case. </p>
<p>My best guess is that there could be some issue in how the constants are all inlined from the <code>smulhi</code> and the various other shifts in the fast algorithm. All other values appear to work correctly.<br>
</p>
</blockquote>



<a name="546849237"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311927%20Cranelift%3A%20%60opt_level%3Dspeed%60%20brea.../near/546849237" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311927.20Cranelift.3A.20.60opt_level.3Dspeed.60.20brea.2E.2E.2E.html#546849237">(Oct 24 2025 at 09:18)</a>:</h4>
<p>emturner <a href="https://github.com/bytecodealliance/wasmtime/issues/11927#issuecomment-3442053987">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11927">issue #11927</a>:</p>
<blockquote>
<p>This also happens with <code>i32</code> signed division.</p>
</blockquote>



<a name="546875644"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311927%20Cranelift%3A%20%60opt_level%3Dspeed%60%20brea.../near/546875644" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311927.20Cranelift.3A.20.60opt_level.3Dspeed.60.20brea.2E.2E.2E.html#546875644">(Oct 24 2025 at 11:42)</a>:</h4>
<p>emturner edited <a href="https://github.com/bytecodealliance/wasmtime/issues/11927">issue #11927</a>:</p>
<blockquote>
<p>When compiling with <code>opt_level=speed</code>, <code>sdiv i64::MIN, i64::MIN</code> returns <code>-1</code> instead of <code>1</code>.</p>
<p>The same occurs with <code>opt_level=speed_and_size</code>.</p>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">test</span><span class="w"> </span><span class="n">interpret</span>
<span class="n">test</span><span class="w"> </span><span class="n">run</span>
<span class="n">set</span><span class="w"> </span><span class="n">opt_level</span><span class="o">=</span><span class="n">speed</span>
<span class="n">target</span><span class="w"> </span><span class="n">x86_64</span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">sdiv_by_const_neg_i64min_i64</span><span class="p">(</span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="p">{</span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span><span class="p">:</span><span class="w"> </span><span class="kt">i64</span><span class="p">):</span>
<span class="w">    </span><span class="nc">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="o">-</span><span class="mi">9223372036854775808</span>
<span class="w">    </span><span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sdiv</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v2</span>
<span class="p">}</span>

<span class="p">;</span><span class="w"> </span><span class="n">run</span><span class="p">:</span><span class="w"> </span><span class="o">%</span><span class="n">sdiv_by_const_neg_i64min_i64</span><span class="p">(</span><span class="o">-</span><span class="mi">9223372036854775808</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<ul>
<li>add the above in <code>cranelift/filetests/filetests/runtests/sdiv-broken.clif</code></li>
<li><code>cd cranelift</code></li>
<li><code>cargo +1.88.0 run -- test filetests/filetests/runtests/sdiv-broken.clif</code></li>
</ul>
<h3>Expected Results</h3>
<p>The test should pass. <code>i64::MIN / i64::MIN == 1</code>.</p>
<h3>Actual Results</h3>
<p>We get an incorrect result: <code>i64::MIN / i64::MIN == -1</code></p>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: f678260bb3b2fa07ae10737f581b2d395d3349da is the first commit that causes the issue.</p>
<p>All cranelift versions from then on (1.22.0 -&gt; current @ 1.25.1) are affected.</p>
<p>Operating system: Guix Linux @ 6.16.7,  Ubuntu 24.04.3 LTS, Mac M2.</p>
<p>Architecture: AMD64, x86_64</p>
<h3>Extra Info</h3>
<p>As far as I can tell, the algorithm for the 'const denominator division' is correct. Indeed the proptests cover this case. </p>
<p>My best guess is that there could be some issue in how the constants are all inlined from the <code>smulhi</code> and the various other shifts in the fast algorithm. All other values appear to work correctly.<br>
</p>
</blockquote>



<a name="546875712"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311927%20Cranelift%3A%20%60opt_level%3Dspeed%60%20brea.../near/546875712" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311927.20Cranelift.3A.20.60opt_level.3Dspeed.60.20brea.2E.2E.2E.html#546875712">(Oct 24 2025 at 11:42)</a>:</h4>
<p>emturner edited <a href="https://github.com/bytecodealliance/wasmtime/issues/11927">issue #11927</a>:</p>
<blockquote>
<p>When compiling with <code>opt_level=speed</code>, <code>sdiv i64::MIN, i64::MIN</code> returns <code>-1</code> instead of <code>1</code>.</p>
<p>The same occurs with <code>opt_level=speed_and_size</code>.</p>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">test</span><span class="w"> </span><span class="n">interpret</span>
<span class="n">test</span><span class="w"> </span><span class="n">run</span>
<span class="n">set</span><span class="w"> </span><span class="n">opt_level</span><span class="o">=</span><span class="n">speed</span>
<span class="n">target</span><span class="w"> </span><span class="n">x86_64</span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">sdiv_by_const_neg_i64min_i64</span><span class="p">(</span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="p">{</span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span><span class="p">:</span><span class="w"> </span><span class="kt">i64</span><span class="p">):</span>
<span class="w">    </span><span class="nc">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="o">-</span><span class="mi">9223372036854775808</span>
<span class="w">    </span><span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sdiv</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v2</span>
<span class="p">}</span>

<span class="p">;</span><span class="w"> </span><span class="n">run</span><span class="p">:</span><span class="w"> </span><span class="o">%</span><span class="n">sdiv_by_const_neg_i64min_i64</span><span class="p">(</span><span class="o">-</span><span class="mi">9223372036854775808</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<ul>
<li>add the above in <code>cranelift/filetests/filetests/runtests/sdiv-broken.clif</code></li>
<li><code>cd cranelift</code></li>
<li><code>cargo +1.88.0 run -- test filetests/filetests/runtests/sdiv-broken.clif</code></li>
</ul>
<h3>Expected Results</h3>
<p>The test should pass. <code>i64::MIN / i64::MIN == 1</code>.</p>
<h3>Actual Results</h3>
<p>We get an incorrect result: <code>i64::MIN / i64::MIN == -1</code></p>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: f678260bb3b2fa07ae10737f581b2d395d3349da is the first commit that causes the issue.</p>
<p>All cranelift versions from then on (1.22.0 -&gt; current @ 1.25.1) are affected.</p>
<p>Operating system: Guix Linux @ 6.16.7,  Ubuntu 24.04.3 LTS, MacOS.</p>
<p>Architecture: AMD64, x86_64, Mac M2.</p>
<h3>Extra Info</h3>
<p>As far as I can tell, the algorithm for the 'const denominator division' is correct. Indeed the proptests cover this case. </p>
<p>My best guess is that there could be some issue in how the constants are all inlined from the <code>smulhi</code> and the various other shifts in the fast algorithm. All other values appear to work correctly.<br>
</p>
</blockquote>



<a name="546877891"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311927%20Cranelift%3A%20%60opt_level%3Dspeed%60%20brea.../near/546877891" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311927.20Cranelift.3A.20.60opt_level.3Dspeed.60.20brea.2E.2E.2E.html#546877891">(Oct 24 2025 at 11:55)</a>:</h4>
<p>emturner edited <a href="https://github.com/bytecodealliance/wasmtime/issues/11927">issue #11927</a>:</p>
<blockquote>
<p>When compiling with <code>opt_level=speed</code>, <code>sdiv i64::MIN, i64::MIN</code> returns <code>-1</code> instead of <code>1</code>.</p>
<p>The same occurs with <code>opt_level=speed_and_size</code>.</p>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">test</span><span class="w"> </span><span class="n">interpret</span>
<span class="n">test</span><span class="w"> </span><span class="n">run</span>
<span class="n">set</span><span class="w"> </span><span class="n">opt_level</span><span class="o">=</span><span class="n">speed</span>
<span class="n">target</span><span class="w"> </span><span class="n">x86_64</span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">sdiv_by_const_neg_i64min_i64</span><span class="p">(</span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="p">{</span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span><span class="p">:</span><span class="w"> </span><span class="kt">i64</span><span class="p">):</span>
<span class="w">    </span><span class="nc">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="o">-</span><span class="mi">9223372036854775808</span>
<span class="w">    </span><span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sdiv</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v2</span>
<span class="p">}</span>

<span class="p">;</span><span class="w"> </span><span class="n">run</span><span class="p">:</span><span class="w"> </span><span class="o">%</span><span class="n">sdiv_by_const_neg_i64min_i64</span><span class="p">(</span><span class="o">-</span><span class="mi">9223372036854775808</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<ul>
<li>add the above in <code>cranelift/filetests/filetests/runtests/sdiv-broken.clif</code></li>
<li><code>cd cranelift</code></li>
<li><code>cargo +1.88.0 run -- test filetests/filetests/runtests/sdiv-broken.clif</code></li>
</ul>
<h3>Expected Results</h3>
<p>The test should pass. <code>i64::MIN / i64::MIN == 1</code>.</p>
<h3>Actual Results</h3>
<p>We get an incorrect result: <code>i64::MIN / i64::MIN == -1</code></p>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: f678260bb3b2fa07ae10737f581b2d395d3349da is the first commit that causes the issue.</p>
<p>All cranelift versions from then on (1.22.0 -&gt; current @ 1.25.1) are affected.</p>
<p>Operating system: Guix Linux @ 6.16.7,  Ubuntu 24.04.3 LTS, MacOS.</p>
<p>Architecture: AMD64, x86_64, Mac M2.</p>
<h3>Extra Info</h3>
<p>As far as I can tell, the algorithm for the 'const denominator division' is correct. Indeed the proptests cover this case. </p>
<p>~My best guess is that there could be some issue in how the constants are all inlined from the <code>smulhi</code> and the various other shifts in the fast algorithm. All other values appear to work correctly.~</p>
<p>EDIT: the incorrect rule fires in the case of <code>sdiv</code> where <code>d == ty::MIN</code>. Namely, the rule for _positive_ power of two fires instead of _negative_ power of two.<br>
</p>
</blockquote>



<a name="547741220"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311927%20Cranelift%3A%20%60opt_level%3Dspeed%60%20brea.../near/547741220" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311927.20Cranelift.3A.20.60opt_level.3Dspeed.60.20brea.2E.2E.2E.html#547741220">(Oct 29 2025 at 15:05)</a>:</h4>
<p>cfallin closed <a href="https://github.com/bytecodealliance/wasmtime/issues/11927">issue #11927</a>:</p>
<blockquote>
<p>When compiling with <code>opt_level=speed</code>, <code>sdiv i64::MIN, i64::MIN</code> returns <code>-1</code> instead of <code>1</code>.</p>
<p>The same occurs with <code>opt_level=speed_and_size</code>.</p>
<h3><code>.clif</code> Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">test</span><span class="w"> </span><span class="n">interpret</span>
<span class="n">test</span><span class="w"> </span><span class="n">run</span>
<span class="n">set</span><span class="w"> </span><span class="n">opt_level</span><span class="o">=</span><span class="n">speed</span>
<span class="n">target</span><span class="w"> </span><span class="n">x86_64</span>

<span class="n">function</span><span class="w"> </span><span class="o">%</span><span class="n">sdiv_by_const_neg_i64min_i64</span><span class="p">(</span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="p">{</span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span><span class="p">:</span><span class="w"> </span><span class="kt">i64</span><span class="p">):</span>
<span class="w">    </span><span class="nc">v1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">iconst</span><span class="p">.</span><span class="kt">i64</span><span class="w"> </span><span class="o">-</span><span class="mi">9223372036854775808</span>
<span class="w">    </span><span class="n">v2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sdiv</span><span class="w"> </span><span class="n">v0</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v2</span>
<span class="p">}</span>

<span class="p">;</span><span class="w"> </span><span class="n">run</span><span class="p">:</span><span class="w"> </span><span class="o">%</span><span class="n">sdiv_by_const_neg_i64min_i64</span><span class="p">(</span><span class="o">-</span><span class="mi">9223372036854775808</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<ul>
<li>add the above in <code>cranelift/filetests/filetests/runtests/sdiv-broken.clif</code></li>
<li><code>cd cranelift</code></li>
<li><code>cargo +1.88.0 run -- test filetests/filetests/runtests/sdiv-broken.clif</code></li>
</ul>
<h3>Expected Results</h3>
<p>The test should pass. <code>i64::MIN / i64::MIN == 1</code>.</p>
<h3>Actual Results</h3>
<p>We get an incorrect result: <code>i64::MIN / i64::MIN == -1</code></p>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: f678260bb3b2fa07ae10737f581b2d395d3349da is the first commit that causes the issue.</p>
<p>All cranelift versions from then on (1.22.0 -&gt; current @ 1.25.1) are affected.</p>
<p>Operating system: Guix Linux @ 6.16.7,  Ubuntu 24.04.3 LTS, MacOS.</p>
<p>Architecture: AMD64, x86_64, Mac M2.</p>
<h3>Extra Info</h3>
<p>As far as I can tell, the algorithm for the 'const denominator division' is correct. Indeed the proptests cover this case. </p>
<p>~My best guess is that there could be some issue in how the constants are all inlined from the <code>smulhi</code> and the various other shifts in the fast algorithm. All other values appear to work correctly.~</p>
<p>EDIT: the incorrect rule fires in the case of <code>sdiv</code> where <code>d == ty::MIN</code>. Namely, the rule for _positive_ power of two fires instead of _negative_ power of two.<br>
</p>
</blockquote>



<hr><p>Last updated: Feb 22 2026 at 11:05 UTC</p>
</html>
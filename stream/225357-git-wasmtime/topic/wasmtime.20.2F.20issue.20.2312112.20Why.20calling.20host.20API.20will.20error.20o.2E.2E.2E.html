<html>
<head><meta charset="utf-8"><title>wasmtime / issue #12112 Why calling host API will error o... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312112.20Why.20calling.20host.20API.20will.20error.20o.2E.2E.2E.html">wasmtime / issue #12112 Why calling host API will error o...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="561556617"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312112%20Why%20calling%20host%20API%20will%20error%20o.../near/561556617" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312112.20Why.20calling.20host.20API.20will.20error.20o.2E.2E.2E.html#561556617">(Dec 03 2025 at 03:27)</a>:</h4>
<p>sammyne opened <a href="https://github.com/bytecodealliance/wasmtime/issues/12112">issue #12112</a>:</p>
<blockquote>
<p>It's broken to run wasm component model using wrapped <code>realloc</code> with host call.</p>
<p>The full reproduction repository goes as <a href="https://github.com/sammyne/broken-memory-inspector-with-host-call">https://github.com/sammyne/broken-memory-inspector-with-host-call</a></p>
<h2>Environment</h2>
<ul>
<li>wasmtime v39.0.1</li>
<li>wasi-sdk v29.0</li>
<li>wasm-tools v1.243.0</li>
<li>wit-bindgen v0.48.1</li>
</ul>
<h2>Project layout</h2>
<table>
<thead>
<tr>
<th>folder</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>guest</td>
<td>C++-written wasm component</td>
</tr>
<tr>
<td>host-rs</td>
<td>Rust-written embedded wasmtime host, exposing a <code>inspect</code> api to called by guest's <code>__wrap_realloc</code></td>
</tr>
</tbody>
</table>
<h2>Core logic</h2>
<p><strong>Guest</strong>: <code>__wrap_realloc</code> will call the real <code>realloc</code> and then call <code>inspect</code> to recorded the allocated ptr</p>
<div class="codehilite" data-code-language="C++"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">inspect</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">alloc_or_free</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">sammyne_hellohost_api_inspect</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">(</span><span class="n">p</span><span class="p">),</span><span class="w"> </span><span class="n">alloc_or_free</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="nf">__wrap_realloc</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 不能直接调用 realloc，否则递归导致栈溢出。</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__real_realloc</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// TODO: 排查清楚加这行代码会导致失败的原因</span>
<span class="w">  </span><span class="c1">// printf("realloc(%zu)=%p\n", size, p);</span>
<span class="w">  </span><span class="n">inspect</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p><strong>Host</strong>: <code>MyHost</code> will be injected into wasmtime's <code>Store</code></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">impl</span><span class="w"> </span><span class="n">Host</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">MyHost</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">inspect</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">:</span><span class="w"> </span><span class="kt">u64</span><span class="p">,</span><span class="w"> </span><span class="n">alloc_or_free</span><span class="p">:</span><span class="w"> </span><span class="kt">bool</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"addr={addr},alloc-or-free={alloc_or_free}"</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h2>Reproduction</h2>
<p>Using the host to load the guest wasm to tiggering call of <code>realloc</code> as</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>make<span class="w"> </span>run
</code></pre></div>
<p>Error output as</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>Error:<span class="w"> </span>call

Caused<span class="w"> </span>by:
<span class="w">    </span><span class="m">0</span>:<span class="w"> </span>error<span class="w"> </span><span class="k">while</span><span class="w"> </span>executing<span class="w"> </span>at<span class="w"> </span>wasm<span class="w"> </span>backtrace:
<span class="w">           </span><span class="m">0</span>:<span class="w">   </span>0x1e58<span class="w"> </span>-<span class="w"> </span>greeter.wasm!sammyne_hellohost_api_inspect
<span class="w">           </span><span class="m">1</span>:<span class="w">    </span>0xe28<span class="w"> </span>-<span class="w"> </span>greeter.wasm!inspect<span class="o">(</span>void*,<span class="w"> </span>bool<span class="o">)</span>
<span class="w">           </span><span class="m">2</span>:<span class="w">    </span>0xf49<span class="w"> </span>-<span class="w"> </span>greeter.wasm!__wrap_realloc
<span class="w">           </span><span class="m">3</span>:<span class="w">   </span>0x1d40<span class="w"> </span>-<span class="w"> </span>greeter.wasm!cabi_realloc
<span class="w">       </span>note:<span class="w"> </span>using<span class="w"> </span>the<span class="w"> </span><span class="sb">`</span><span class="nv">WASMTIME_BACKTRACE_DETAILS</span><span class="o">=</span><span class="m">1</span><span class="sb">`</span><span class="w"> </span>environment<span class="w"> </span>variable<span class="w"> </span>may<span class="w"> </span>show<span class="w"> </span>more<span class="w"> </span>debugging<span class="w"> </span>information
<span class="w">    </span><span class="m">1</span>:<span class="w"> </span>wasm<span class="w"> </span>trap:<span class="w"> </span>cannot<span class="w"> </span>leave<span class="w"> </span>component<span class="w"> </span>instance
make:<span class="w"> </span>***<span class="w"> </span><span class="o">[</span>Makefile:13:<span class="w"> </span>run<span class="o">]</span><span class="w"> </span>Error<span class="w"> </span><span class="m">1</span>
</code></pre></div>
<p>Really appreciate if someone could help me out~</p>
<h2>References</h2>
<ul>
<li><a href="https://stackoverflow.com/a/46446749/10878967">How to wrap functions with the <code>--wrap</code> option correctly?</a></li>
<li><a href="https://sourceware.org/binutils/docs/ld/Options.html#index-g_t_002d_002dwrap">https://sourceware.org/binutils/docs/ld/Options.html#index-g_t_002d_002dwrap</a></li>
<li><a href="https://component-model.bytecodealliance.org/language-support/c.html">https://component-model.bytecodealliance.org/language-support/c.html</a></li>
</ul>
</blockquote>



<a name="561573236"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312112%20Why%20calling%20host%20API%20will%20error%20o.../near/561573236" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312112.20Why.20calling.20host.20API.20will.20error.20o.2E.2E.2E.html#561573236">(Dec 03 2025 at 06:53)</a>:</h4>
<p>cfallin closed <a href="https://github.com/bytecodealliance/wasmtime/issues/12112">issue #12112</a>:</p>
<blockquote>
<p>It's broken to run wasm component model using wrapped <code>realloc</code> with host call.</p>
<p>The full reproduction repository goes as <a href="https://github.com/sammyne/broken-memory-inspector-with-host-call">https://github.com/sammyne/broken-memory-inspector-with-host-call</a></p>
<h2>Environment</h2>
<ul>
<li>wasmtime v39.0.1</li>
<li>wasi-sdk v29.0</li>
<li>wasm-tools v1.243.0</li>
<li>wit-bindgen v0.48.1</li>
</ul>
<h2>Project layout</h2>
<table>
<thead>
<tr>
<th>folder</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>guest</td>
<td>C++-written wasm component</td>
</tr>
<tr>
<td>host-rs</td>
<td>Rust-written embedded wasmtime host, exposing a <code>inspect</code> api to called by guest's <code>__wrap_realloc</code></td>
</tr>
</tbody>
</table>
<h2>Core logic</h2>
<p><strong>Guest</strong>: <code>__wrap_realloc</code> will call the real <code>realloc</code> and then call <code>inspect</code> to recorded the allocated ptr</p>
<div class="codehilite" data-code-language="C++"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">inspect</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">alloc_or_free</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">sammyne_hellohost_api_inspect</span><span class="p">(</span><span class="kt">uint64_t</span><span class="p">(</span><span class="n">p</span><span class="p">),</span><span class="w"> </span><span class="n">alloc_or_free</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="nf">__wrap_realloc</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// 不能直接调用 realloc，否则递归导致栈溢出。</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">__real_realloc</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// TODO: 排查清楚加这行代码会导致失败的原因</span>
<span class="w">  </span><span class="c1">// printf("realloc(%zu)=%p\n", size, p);</span>
<span class="w">  </span><span class="n">inspect</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">p</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p><strong>Host</strong>: <code>MyHost</code> will be injected into wasmtime's <code>Store</code></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">impl</span><span class="w"> </span><span class="n">Host</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">MyHost</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">inspect</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">:</span><span class="w"> </span><span class="kt">u64</span><span class="p">,</span><span class="w"> </span><span class="n">alloc_or_free</span><span class="p">:</span><span class="w"> </span><span class="kt">bool</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="fm">println!</span><span class="p">(</span><span class="s">"addr={addr},alloc-or-free={alloc_or_free}"</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h2>Reproduction</h2>
<p>Using the host to load the guest wasm to tiggering call of <code>realloc</code> as</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>make<span class="w"> </span>run
</code></pre></div>
<p>Error output as</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>Error:<span class="w"> </span>call

Caused<span class="w"> </span>by:
<span class="w">    </span><span class="m">0</span>:<span class="w"> </span>error<span class="w"> </span><span class="k">while</span><span class="w"> </span>executing<span class="w"> </span>at<span class="w"> </span>wasm<span class="w"> </span>backtrace:
<span class="w">           </span><span class="m">0</span>:<span class="w">   </span>0x1e58<span class="w"> </span>-<span class="w"> </span>greeter.wasm!sammyne_hellohost_api_inspect
<span class="w">           </span><span class="m">1</span>:<span class="w">    </span>0xe28<span class="w"> </span>-<span class="w"> </span>greeter.wasm!inspect<span class="o">(</span>void*,<span class="w"> </span>bool<span class="o">)</span>
<span class="w">           </span><span class="m">2</span>:<span class="w">    </span>0xf49<span class="w"> </span>-<span class="w"> </span>greeter.wasm!__wrap_realloc
<span class="w">           </span><span class="m">3</span>:<span class="w">   </span>0x1d40<span class="w"> </span>-<span class="w"> </span>greeter.wasm!cabi_realloc
<span class="w">       </span>note:<span class="w"> </span>using<span class="w"> </span>the<span class="w"> </span><span class="sb">`</span><span class="nv">WASMTIME_BACKTRACE_DETAILS</span><span class="o">=</span><span class="m">1</span><span class="sb">`</span><span class="w"> </span>environment<span class="w"> </span>variable<span class="w"> </span>may<span class="w"> </span>show<span class="w"> </span>more<span class="w"> </span>debugging<span class="w"> </span>information
<span class="w">    </span><span class="m">1</span>:<span class="w"> </span>wasm<span class="w"> </span>trap:<span class="w"> </span>cannot<span class="w"> </span>leave<span class="w"> </span>component<span class="w"> </span>instance
make:<span class="w"> </span>***<span class="w"> </span><span class="o">[</span>Makefile:13:<span class="w"> </span>run<span class="o">]</span><span class="w"> </span>Error<span class="w"> </span><span class="m">1</span>
</code></pre></div>
<p>Really appreciate if someone could help me out~</p>
<h2>References</h2>
<ul>
<li><a href="https://stackoverflow.com/a/46446749/10878967">How to wrap functions with the <code>--wrap</code> option correctly?</a></li>
<li><a href="https://sourceware.org/binutils/docs/ld/Options.html#index-g_t_002d_002dwrap">https://sourceware.org/binutils/docs/ld/Options.html#index-g_t_002d_002dwrap</a></li>
<li><a href="https://component-model.bytecodealliance.org/language-support/c.html">https://component-model.bytecodealliance.org/language-support/c.html</a></li>
</ul>
</blockquote>



<a name="561573239"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312112%20Why%20calling%20host%20API%20will%20error%20o.../near/561573239" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312112.20Why.20calling.20host.20API.20will.20error.20o.2E.2E.2E.html#561573239">(Dec 03 2025 at 06:53)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/12112#issuecomment-3605359310">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12112">issue #12112</a>:</p>
<blockquote>
<p>Unfortunately, the <a href="https://github.com/WebAssembly/component-model/blob/main/design/mvp/CanonicalABI.md">spec</a> says that realloc cannot call out of the component; so this behavior in Wasmtime is correct. Look for <code>may_leave</code> in that document for details.</p>
<p>If you need to debug memory allocations, one workaround might be to record some log internally (e.g. in some fixed buffer) and then dump the information via another call into the component.</p>
<p>I'll close this since there is no Wasmtime bug, but best of luck and feel free to ask on our <a href="https://bytecodealliance.zulipchat.com/">Zulip</a> if you need more tips on debugging your system.</p>
</blockquote>



<a name="561640404"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312112%20Why%20calling%20host%20API%20will%20error%20o.../near/561640404" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312112.20Why.20calling.20host.20API.20will.20error.20o.2E.2E.2E.html#561640404">(Dec 03 2025 at 12:40)</a>:</h4>
<p>tschneidereit <a href="https://github.com/bytecodealliance/wasmtime/issues/12112#issuecomment-3606671835">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12112">issue #12112</a>:</p>
<blockquote>
<p>One thing to look forward here is a <a href="https://github.com/WebAssembly/component-model/issues/383">planned spec change</a> that will make the <code>realloc</code> calls go away. At a very high level, the idea is that instead of the host calling <code>realloc</code> for a lowered value, it'll provide the required information to the guest on values that can be lowered, and the guest can then decide where to place them (and whether to do the lowering at all).</p>
</blockquote>



<hr><p>Last updated: Feb 22 2026 at 11:05 UTC</p>
</html>
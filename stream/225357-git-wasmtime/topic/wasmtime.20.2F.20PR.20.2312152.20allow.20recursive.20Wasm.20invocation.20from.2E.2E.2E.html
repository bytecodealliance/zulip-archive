<html>
<head><meta charset="utf-8"><title>wasmtime / PR #12152 allow recursive Wasm invocation from... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312152.20allow.20recursive.20Wasm.20invocation.20from.2E.2E.2E.html">wasmtime / PR #12152 allow recursive Wasm invocation from...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="563017403"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312152%20allow%20recursive%20Wasm%20invocation%20from.../near/563017403" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312152.20allow.20recursive.20Wasm.20invocation.20from.2E.2E.2E.html#563017403">(Dec 10 2025 at 17:58)</a>:</h4>
<p><strong>dicej</strong> requested <a href="https://github.com/alexcrichton">alexcrichton</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/12152">PR #12152</a>.</p>



<a name="563017405"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312152%20allow%20recursive%20Wasm%20invocation%20from.../near/563017405" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312152.20allow.20recursive.20Wasm.20invocation.20from.2E.2E.2E.html#563017405">(Dec 10 2025 at 17:58)</a>:</h4>
<p>dicej opened <a href="https://github.com/bytecodealliance/wasmtime/pull/12152">PR #12152</a> from <code>dicej:fix-12098</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>The core changes here are:</p>
<ul>
<li>remove an unnecessary assertion from <code>concurrent::prepare_call</code></li>
<li>track instance states (e.g. backpressure, etc.) on a per <code>(Instance, RuntimeComponentInstanceIndex)</code> basis<br>
    - both parts of that key are needed now that concurrent state is tracked on a per-store basis rather than a per-instance basis since <code>RuntimeComponentInstanceIndex</code>es are not globally unique</li>
</ul>
<p>While discussing the above with Alex, we realized the use of a <code>HashMap</code> to track per-instance states was both pessimal and unnecessary.  Consequently, I've folded that state into <code>ComponentInstance::instance_handle_tables</code>, renaming it to <code>instance_states</code>.  That involved a fair amount of code churn, but doesn't change behavior except as described in the second bullet point above.</p>
<p>Thanks to Alex for the test case!</p>
<p>Fixes #12098</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="563017406"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312152%20allow%20recursive%20Wasm%20invocation%20from.../near/563017406" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312152.20allow.20recursive.20Wasm.20invocation.20from.2E.2E.2E.html#563017406">(Dec 10 2025 at 17:58)</a>:</h4>
<p><strong>dicej</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers">wasmtime-core-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/12152">PR #12152</a>.</p>



<a name="563256075"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312152%20allow%20recursive%20Wasm%20invocation%20from.../near/563256075" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312152.20allow.20recursive.20Wasm.20invocation.20from.2E.2E.2E.html#563256075">(Dec 11 2025 at 18:18)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/12152#pullrequestreview-3564178878">PR review</a>:</p>
<blockquote>
<p>This all looks reasonable to me but I think it would be worth trying to clean up the use of tuples here and/or make it a bit more formal. For example given how frequently this tuple is created, passed around, and accessed I think it would make more sense to put it in a <code>struct</code> with named fields. It might be worth hanging methods off that as well? </p>
<p>Overall the <code>concurrent.rs</code> file feels a bit disorganized as over time methods have moved around to various different <code>&amp;self</code> receivers based on the needs at the time, but I feel like it's pretty difficult to understand the various layers of abstractions there. To that extent I feel like this is moving the needle more towards the complicated side of things due to making the definition of "what's an instance" a bit murkier as there's sort of two definitions now instead of one.</p>
<p>I don't really have a concrete suggestion though  unfortunate. "Just" replacing the tuple with a <code>struct</code> won't really do anything or move the needle on things, it just inches towards a local optima a bit more. I feel like this file is becoming more and more in need of a restructuring, refactoring, or something like that to make it more clear what methods go where, how context is passed around, and making various abstractions more first class.</p>
<p>Do you have any ideas about how to improve the structure internally and/or disagree about how I feel about the organization though?</p>
</blockquote>



<a name="563256076"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312152%20allow%20recursive%20Wasm%20invocation%20from.../near/563256076" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312152.20allow.20recursive.20Wasm.20invocation.20from.2E.2E.2E.html#563256076">(Dec 11 2025 at 18:18)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/12152#discussion_r2607962526">PR review comment</a>:</p>
<blockquote>
<p>For this almost all other <code>*Index</code>-based accessors panic internally on out-of-bounds, so I think it's reasonable to return <code>&amp;mut</code> here instead of `Option&lt;&amp;mut T&gt;</p>
</blockquote>



<a name="563264896"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312152%20allow%20recursive%20Wasm%20invocation%20from.../near/563264896" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312152.20allow.20recursive.20Wasm.20invocation.20from.2E.2E.2E.html#563264896">(Dec 11 2025 at 19:12)</a>:</h4>
<p>dicej <a href="https://github.com/bytecodealliance/wasmtime/pull/12152#issuecomment-3643398347">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/12152">PR #12152</a>:</p>
<blockquote>
<blockquote>
<p>For example given how frequently this tuple is created, passed around, and accessed I think it would make more sense to put it in a <code>struct</code> with named fields. It might be worth hanging methods off that as well?</p>
</blockquote>
<p>Will do.</p>
<blockquote>
<p>Do you have any ideas about how to improve the structure internally and/or disagree about how I feel about the organization though?</p>
</blockquote>
<p>Yeah, I think some of the awkwardness stems from:</p>
<ul>
<li>Each function needing access to some combination of <code>StoreContextMut</code>/<code>StoreOpaque</code>/<code>VMStore</code>, <code>Instance</code>, <code>RuntimeComponentInstance</code>, etc., and it's rarely obvious which one of those should be <code>self</code>, i.e. which <code>impl</code> to put the method on.  Personally, I'd be fine with just making them all freestanding functions and ditching any semblance of object-orientation (except for trait impls, of course), but that's the FP part of my brain talking, and I don't think it would be idiomatic with respect to the rest of the codebase.</li>
<li>I've been pretty careful to ensure that each function takes only the parameters it needs, with the most specific types possible.  Later, when a given function ends up needing more or less than it used to, that often means moving the function elsewhere because <code>self</code> is now either too narrow or too broad.</li>
<li>Having gone through several iterations of the above, everything feels pretty haphazard</li>
</ul>
<p>I don't have any brilliant ideas to address that, but one thing we could do is establish some guidelines about where to put a given method, e.g.:</p>
<ul>
<li>Every function that takes both a <code>&amp;mut StoreOpaque</code> and an <code>Instance</code> should be a method of <code>StoreOpaque</code> (and _not_ of <code>Instance</code>)</li>
<li>Every function that takes a <code>&amp;mut ConcurrentState</code> should be a method of <code>ConcurrentState</code></li>
<li>etc.</li>
</ul>
<p>I'm just making up the above, and don't care too much what the guidelines are, but having any guidelines at all could help.</p>
</blockquote>



<a name="563265455"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312152%20allow%20recursive%20Wasm%20invocation%20from.../near/563265455" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312152.20allow.20recursive.20Wasm.20invocation.20from.2E.2E.2E.html#563265455">(Dec 11 2025 at 19:15)</a>:</h4>
<p>dicej <a href="https://github.com/bytecodealliance/wasmtime/pull/12152#issuecomment-3643409184">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/12152">PR #12152</a>:</p>
<blockquote>
<p>Also, we could consider splitting <code>concurrent.rs</code> into several, smaller modules, each of which would be easier to navigate.</p>
</blockquote>



<a name="563267305"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312152%20allow%20recursive%20Wasm%20invocation%20from.../near/563267305" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312152.20allow.20recursive.20Wasm.20invocation.20from.2E.2E.2E.html#563267305">(Dec 11 2025 at 19:26)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/12152#pullrequestreview-3568978570">PR review</a>:</p>
<blockquote>
<p>Oh, and to clarify, I don't think a large-scale refactor should block this.</p>
<p>You've helped me articulate something though:</p>
<blockquote>
<p>I've been pretty careful to ensure that each function takes only the parameters it needs</p>
</blockquote>
<p>I'm realizing now that, with the benefit of hindsight, we should undo some of this. For example <code>thing: Instance</code> may want to entirely go away in favor of <code>thing: InstanceAndRuntimeComponentInstanceIndex</code>. Except maybe as stored in structures in-memory, there it should retain the minimal size necessary. But things like that where with the benefit of hindsight we've got a better sense now of what pieces of state/options need to be plumbed around to various locations so we can consolidate. </p>
<p>Overall I think it's worth having a convention for passing state around, even when not all of the state is used in every function. If it's just function arguments that's not really costly and the only time we need to think a bit harder is when it's in runtime data structures.</p>
<p>Well, put another way, the way I'd phrase it is that I think we should use our experience of developing this module over the past year or so to refactor/clean it up. I don't think we need to go so far as documenting conventions, but more consistently using one <code>impl</code> vs another, passing state, smaller files, etc, I think will all help a lot.</p>
</blockquote>



<a name="563294834"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312152%20allow%20recursive%20Wasm%20invocation%20from.../near/563294834" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312152.20allow.20recursive.20Wasm.20invocation.20from.2E.2E.2E.html#563294834">(Dec 11 2025 at 22:39)</a>:</h4>
<p>dicej updated <a href="https://github.com/bytecodealliance/wasmtime/pull/12152">PR #12152</a>.</p>



<a name="563299635"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312152%20allow%20recursive%20Wasm%20invocation%20from.../near/563299635" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312152.20allow.20recursive.20Wasm.20invocation.20from.2E.2E.2E.html#563299635">(Dec 11 2025 at 23:27)</a>:</h4>
<p>dicej merged <a href="https://github.com/bytecodealliance/wasmtime/pull/12152">PR #12152</a>.</p>



<a name="563573447"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312152%20allow%20recursive%20Wasm%20invocation%20from.../near/563573447" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312152.20allow.20recursive.20Wasm.20invocation.20from.2E.2E.2E.html#563573447">(Dec 12 2025 at 22:55)</a>:</h4>
<p>dicej submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/12152#pullrequestreview-3573851676">PR review</a>.</p>



<a name="563573448"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312152%20allow%20recursive%20Wasm%20invocation%20from.../near/563573448" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312152.20allow.20recursive.20Wasm.20invocation.20from.2E.2E.2E.html#563573448">(Dec 12 2025 at 22:55)</a>:</h4>
<p>dicej created <a href="https://github.com/bytecodealliance/wasmtime/pull/12152#discussion_r2615788337">PR review comment</a>:</p>
<blockquote>
<p>Ugh, I forgot to address this before merging.  I'll address it in a follow-up.</p>
</blockquote>



<hr><p>Last updated: Feb 22 2026 at 11:05 UTC</p>
</html>
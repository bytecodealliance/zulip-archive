<html>
<head><meta charset="utf-8"><title>wasmtime / issue #11330 The Different Performances of Cra... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311330.20The.20Different.20Performances.20of.20Cra.2E.2E.2E.html">wasmtime / issue #11330 The Different Performances of Cra...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="531094166"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311330%20The%20Different%20Performances%20of%20Cra.../near/531094166" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311330.20The.20Different.20Performances.20of.20Cra.2E.2E.2E.html#531094166">(Jul 27 2025 at 08:26)</a>:</h4>
<p>gaaraw opened <a href="https://github.com/bytecodealliance/wasmtime/issues/11330">issue #11330</a>:</p>
<blockquote>
<h3>Phenomenon description</h3>
<p>Hello, I have observed different temporal variations between different runtime tools, related to the backend they are using. The specific performance is as follows:</p>
<table>
<thead>
<tr>
<th></th>
<th style="text-align: center;">pr19005.wasm</th>
<th style="text-align: center;">pr19005_test.wasm</th>
<th style="text-align: center;">multiple</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>wasmtime</strong></td>
<td style="text-align: center;"><strong>0.007931</strong></td>
<td style="text-align: center;"><strong>0.250915</strong></td>
<td style="text-align: center;"><strong>31.6x</strong></td>
</tr>
<tr>
<td><strong>wasmer_cranelift</strong></td>
<td style="text-align: center;"><strong>0.013363</strong></td>
<td style="text-align: center;"><strong>0.262407</strong></td>
<td style="text-align: center;"><strong>19.6x</strong></td>
</tr>
<tr>
<td>wasmer_llvm</td>
<td style="text-align: center;">0.014017</td>
<td style="text-align: center;">0.018488</td>
<td style="text-align: center;">1.3x</td>
</tr>
<tr>
<td>wasmedge_jit</td>
<td style="text-align: center;">0.020752</td>
<td style="text-align: center;">0.027414</td>
<td style="text-align: center;">1.3x</td>
</tr>
<tr>
<td>wamr_llvm_jit</td>
<td style="text-align: center;">0.016472</td>
<td style="text-align: center;">0.024946</td>
<td style="text-align: center;">1.5x</td>
</tr>
</tbody>
</table>
<p>The data is in seconds, and each data is the result of ten executions and averages.</p>
<p>The first two use <code>cranelift</code> as the backend, and the last three use <code>llvm</code> as the backend.<br>
There are five files in the <code>test_case.zip</code>, and when you execute <code>pr19005.wasm</code> compiled from C source code and <code>pr19005_test.wasm</code> obtained after simple modifications, the results are shown in the table, and the time increase multiple is marked in the last column.</p>
<p>&lt;details&gt;<br>
&lt;summary&gt; Modification process: &lt;/summary&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">#</span><span class="w"> </span><span class="n">pr19005</span><span class="p">.</span><span class="n">wat</span><span class="w"> </span><span class="n">Lines</span><span class="w"> </span><span class="mi">17</span><span class="o">-</span><span class="mi">26</span>
<span class="mi">17</span><span class="w">          </span><span class="p">(</span><span class="k">loop</span><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="mi">3</span>
<span class="mi">18</span><span class="w">            </span><span class="p">(</span><span class="n">br_if</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">(;</span><span class="o">@</span><span class="mi">2</span><span class="p">;)</span>
<span class="mi">19</span><span class="w">              </span><span class="p">(</span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span>
<span class="mi">20</span><span class="w">            </span><span class="p">(</span><span class="n">br_if</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">(;</span><span class="o">@</span><span class="mi">3</span><span class="p">;)</span>
<span class="mi">21</span><span class="w">              </span><span class="p">(</span><span class="kt">i32</span><span class="p">.</span><span class="n">ne</span>
<span class="mi">22</span><span class="w">                </span><span class="p">(</span><span class="n">local</span><span class="p">.</span><span class="n">tee</span><span class="w"> </span><span class="mi">0</span>
<span class="mi">23</span><span class="w">                  </span><span class="p">(</span><span class="kt">i32</span><span class="p">.</span><span class="n">add</span>
<span class="mi">24</span><span class="w">                    </span><span class="p">(</span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="mi">25</span><span class="w">                    </span><span class="p">(</span><span class="kt">i32</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">12</span><span class="p">)))</span>
<span class="mi">26</span><span class="w">                </span><span class="p">(</span><span class="kt">i32</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">266</span><span class="p">))))</span>
</code></pre></div>
<p>Copy the loop and paste right next to it</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">#</span><span class="w"> </span><span class="n">pr19005_test</span><span class="p">.</span><span class="n">wat</span><span class="w"> </span><span class="n">Lines</span><span class="w"> </span><span class="mi">17</span><span class="o">-</span><span class="mi">36</span>
<span class="mi">17</span><span class="w">          </span><span class="p">(</span><span class="k">loop</span><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="mi">3</span>
<span class="mi">18</span><span class="w">            </span><span class="p">(</span><span class="n">br_if</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">(;</span><span class="o">@</span><span class="mi">2</span><span class="p">;)</span>
<span class="mi">19</span><span class="w">              </span><span class="p">(</span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span>
<span class="mi">20</span><span class="w">            </span><span class="p">(</span><span class="n">br_if</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">(;</span><span class="o">@</span><span class="mi">3</span><span class="p">;)</span>
<span class="mi">21</span><span class="w">              </span><span class="p">(</span><span class="kt">i32</span><span class="p">.</span><span class="n">ne</span>
<span class="mi">22</span><span class="w">                </span><span class="p">(</span><span class="n">local</span><span class="p">.</span><span class="n">tee</span><span class="w"> </span><span class="mi">0</span>
<span class="mi">23</span><span class="w">                  </span><span class="p">(</span><span class="kt">i32</span><span class="p">.</span><span class="n">add</span>
<span class="mi">24</span><span class="w">                    </span><span class="p">(</span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="mi">25</span><span class="w">                    </span><span class="p">(</span><span class="kt">i32</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">12</span><span class="p">)))</span>
<span class="mi">26</span><span class="w">                </span><span class="p">(</span><span class="kt">i32</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">266</span><span class="p">))))</span>
<span class="mi">27</span><span class="w">          </span><span class="p">(</span><span class="k">loop</span><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="mi">3</span>
<span class="mi">28</span><span class="w">            </span><span class="p">(</span><span class="n">br_if</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">(;</span><span class="o">@</span><span class="mi">2</span><span class="p">;)</span>
<span class="mi">29</span><span class="w">              </span><span class="p">(</span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span>
<span class="mi">30</span><span class="w">            </span><span class="p">(</span><span class="n">br_if</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">(;</span><span class="o">@</span><span class="mi">3</span><span class="p">;)</span>
<span class="mi">31</span><span class="w">              </span><span class="p">(</span><span class="kt">i32</span><span class="p">.</span><span class="n">ne</span>
<span class="mi">32</span><span class="w">                </span><span class="p">(</span><span class="n">local</span><span class="p">.</span><span class="n">tee</span><span class="w"> </span><span class="mi">0</span>
<span class="mi">33</span><span class="w">                  </span><span class="p">(</span><span class="kt">i32</span><span class="p">.</span><span class="n">add</span>
<span class="mi">34</span><span class="w">                    </span><span class="p">(</span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="mi">35</span><span class="w">                    </span><span class="p">(</span><span class="kt">i32</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">12</span><span class="p">)))</span>
<span class="mi">36</span><span class="w">                </span><span class="p">(</span><span class="kt">i32</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">266</span><span class="p">))))</span>
</code></pre></div>
<p>&lt;/details&gt;</p>
<h3>Test Case</h3>
<p><a href="https://github.com/user-attachments/files/21452657/test_case.zip">test_case.zip</a></p>
<h3>Steps to Reproduce</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">#</span><span class="w"> </span><span class="n">Compile</span><span class="w"> </span><span class="n">C</span><span class="w"> </span><span class="n">files</span>
<span class="n">emcc</span><span class="w"> </span><span class="n">pr19005</span><span class="p">.</span><span class="n">c</span><span class="w"> </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="n">pr19005</span><span class="p">.</span><span class="n">wasm</span><span class="w"> </span><span class="o">-</span><span class="n">O2</span><span class="w"> </span><span class="o">-</span><span class="n">s</span><span class="w"> </span><span class="n">WASM</span><span class="o">=</span><span class="mi">1</span>

<span class="n">wasm2wat</span><span class="w"> </span><span class="o">-</span><span class="n">f</span><span class="w"> </span><span class="n">pr19005</span><span class="p">.</span><span class="n">wasm</span><span class="w"> </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="n">pr19005</span><span class="p">.</span><span class="n">wat</span>

<span class="n">wat2wasm</span><span class="w"> </span><span class="n">pr19005_test</span><span class="p">.</span><span class="n">wat</span><span class="w"> </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="n">pr19005_test</span><span class="p">.</span><span class="n">wasm</span>

<span class="p">#</span><span class="w"> </span><span class="n">Execute</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">wasm</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">collect</span><span class="w"> </span><span class="n">data</span>
<span class="n">perf</span><span class="w"> </span><span class="n">stat</span><span class="w"> </span><span class="o">-</span><span class="n">r</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">-</span><span class="n">e</span><span class="w"> </span><span class="o">'</span><span class="na">task</span><span class="o">-</span><span class="n">clock</span><span class="o">'</span><span class="w"> </span><span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">wasmtime</span><span class="w"> </span><span class="n">pr19005</span><span class="p">.</span><span class="n">wasm</span>
<span class="n">perf</span><span class="w"> </span><span class="n">stat</span><span class="w"> </span><span class="o">-</span><span class="n">r</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">-</span><span class="n">e</span><span class="w"> </span><span class="o">'</span><span class="na">task</span><span class="o">-</span><span class="n">clock</span><span class="o">'</span><span class="w"> </span><span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">wasmer</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">pr19005</span><span class="p">.</span><span class="n">wasm</span>
<span class="n">perf</span><span class="w"> </span><span class="n">stat</span><span class="w"> </span><span class="o">-</span><span class="n">r</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">-</span><span class="n">e</span><span class="w"> </span><span class="o">'</span><span class="na">task</span><span class="o">-</span><span class="n">clock</span><span class="o">'</span><span class="w"> </span><span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">wasmer</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">llvm</span><span class="w"> </span><span class="n">pr19005</span><span class="p">.</span><span class="n">wasm</span>
<span class="n">perf</span><span class="w"> </span><span class="n">stat</span><span class="w"> </span><span class="o">-</span><span class="n">r</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">-</span><span class="n">e</span><span class="w"> </span><span class="o">'</span><span class="na">task</span><span class="o">-</span><span class="n">clock</span><span class="o">'</span><span class="w"> </span><span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">wasmedge</span><span class="w"> </span><span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">jit</span><span class="w"> </span><span class="n">pr19005</span><span class="p">.</span><span class="n">wasm</span>
<span class="n">perf</span><span class="w"> </span><span class="n">stat</span><span class="w"> </span><span class="o">-</span><span class="n">r</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">-</span><span class="n">e</span><span class="w"> </span><span class="o">'</span><span class="na">task</span><span class="o">-</span><span class="n">clock</span><span class="o">'</span><span class="w"> </span><span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">build_llvm_jit</span><span class="o">/</span><span class="n">iwasm</span><span class="w"> </span><span class="n">pr19005</span><span class="p">.</span><span class="n">wasm</span>
<span class="p">#</span><span class="w"> </span><span class="n">pr19005_test</span><span class="p">.</span><span class="n">wasm</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">same</span>
</code></pre></div>
<h3>Analysis</h3>
<p>The added second loop doesn't really work in the use case. Before the second loop is executed, the value of <code>local 0</code> is equal to 266, so <code>local 0</code> in the second loop can only exit the loop after the loop exceeds 2&lt;sup&gt;32&lt;/sup&gt; and returns to itself. <br>
For this change, I observed that the time change was not noticeable when using <code>LLVM</code> as the backend, but there was a significant increase in time when using <code>cranelift</code> as the backend.</p>
<p>I suspect this may involve two backend optimization strategies for the code.</p>
<h3>Versions and Environment</h3>
<p>The runtime tools are all built on release and use <code>JIT</code>mode.</p>
<ul>
<li>wasmtime: 35.0.0 (9c2e6f17c 2025-06-17)</li>
<li>wasmer: 6.0.1</li>
<li>wasmedge: 0.14.1</li>
<li>WAMR: iwasm 2.4.0</li>
<li>emcc: 4.0.10 (b7dc6e5747465580df5984e723b9d1f10d8e804b)</li>
<li>wabt: 1.0.27</li>
<li>llvm: 18.1.8</li>
<li>Host OS: Ubuntu 22.04.5 LTS x64</li>
<li>CPU: 12th Gen Intel® Core™ i7-12700 × 20</li>
</ul>
<h3>Extra Info</h3>
<p>If you need any other relevant information, please let me know and I will do my best to provide it. Looking forward to your reply! Thank you!<br>
</p>
</blockquote>



<a name="531388693"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311330%20The%20Different%20Performances%20of%20Cra.../near/531388693" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311330.20The.20Different.20Performances.20of.20Cra.2E.2E.2E.html#531388693">(Jul 28 2025 at 14:43)</a>:</h4>
<p>alexcrichton closed <a href="https://github.com/bytecodealliance/wasmtime/issues/11330">issue #11330</a>:</p>
<blockquote>
<h3>Phenomenon description</h3>
<p>Hello, I have observed different temporal variations between different runtime tools, related to the backend they are using. The specific performance is as follows:</p>
<table>
<thead>
<tr>
<th></th>
<th style="text-align: center;">pr19005.wasm</th>
<th style="text-align: center;">pr19005_test.wasm</th>
<th style="text-align: center;">multiple</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>wasmtime</strong></td>
<td style="text-align: center;"><strong>0.007931</strong></td>
<td style="text-align: center;"><strong>0.250915</strong></td>
<td style="text-align: center;"><strong>31.6x</strong></td>
</tr>
<tr>
<td><strong>wasmer_cranelift</strong></td>
<td style="text-align: center;"><strong>0.013363</strong></td>
<td style="text-align: center;"><strong>0.262407</strong></td>
<td style="text-align: center;"><strong>19.6x</strong></td>
</tr>
<tr>
<td>wasmer_llvm</td>
<td style="text-align: center;">0.014017</td>
<td style="text-align: center;">0.018488</td>
<td style="text-align: center;">1.3x</td>
</tr>
<tr>
<td>wasmedge_jit</td>
<td style="text-align: center;">0.020752</td>
<td style="text-align: center;">0.027414</td>
<td style="text-align: center;">1.3x</td>
</tr>
<tr>
<td>wamr_llvm_jit</td>
<td style="text-align: center;">0.016472</td>
<td style="text-align: center;">0.024946</td>
<td style="text-align: center;">1.5x</td>
</tr>
</tbody>
</table>
<p>The data is in seconds, and each data is the result of ten executions and averages.</p>
<p>The first two use <code>cranelift</code> as the backend, and the last three use <code>llvm</code> as the backend.<br>
There are five files in the <code>test_case.zip</code>, and when you execute <code>pr19005.wasm</code> compiled from C source code and <code>pr19005_test.wasm</code> obtained after simple modifications, the results are shown in the table, and the time increase multiple is marked in the last column.</p>
<p>&lt;details&gt;<br>
&lt;summary&gt; Modification process: &lt;/summary&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">#</span><span class="w"> </span><span class="n">pr19005</span><span class="p">.</span><span class="n">wat</span><span class="w"> </span><span class="n">Lines</span><span class="w"> </span><span class="mi">17</span><span class="o">-</span><span class="mi">26</span>
<span class="mi">17</span><span class="w">          </span><span class="p">(</span><span class="k">loop</span><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="mi">3</span>
<span class="mi">18</span><span class="w">            </span><span class="p">(</span><span class="n">br_if</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">(;</span><span class="o">@</span><span class="mi">2</span><span class="p">;)</span>
<span class="mi">19</span><span class="w">              </span><span class="p">(</span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span>
<span class="mi">20</span><span class="w">            </span><span class="p">(</span><span class="n">br_if</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">(;</span><span class="o">@</span><span class="mi">3</span><span class="p">;)</span>
<span class="mi">21</span><span class="w">              </span><span class="p">(</span><span class="kt">i32</span><span class="p">.</span><span class="n">ne</span>
<span class="mi">22</span><span class="w">                </span><span class="p">(</span><span class="n">local</span><span class="p">.</span><span class="n">tee</span><span class="w"> </span><span class="mi">0</span>
<span class="mi">23</span><span class="w">                  </span><span class="p">(</span><span class="kt">i32</span><span class="p">.</span><span class="n">add</span>
<span class="mi">24</span><span class="w">                    </span><span class="p">(</span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="mi">25</span><span class="w">                    </span><span class="p">(</span><span class="kt">i32</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">12</span><span class="p">)))</span>
<span class="mi">26</span><span class="w">                </span><span class="p">(</span><span class="kt">i32</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">266</span><span class="p">))))</span>
</code></pre></div>
<p>Copy the loop and paste right next to it</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">#</span><span class="w"> </span><span class="n">pr19005_test</span><span class="p">.</span><span class="n">wat</span><span class="w"> </span><span class="n">Lines</span><span class="w"> </span><span class="mi">17</span><span class="o">-</span><span class="mi">36</span>
<span class="mi">17</span><span class="w">          </span><span class="p">(</span><span class="k">loop</span><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="mi">3</span>
<span class="mi">18</span><span class="w">            </span><span class="p">(</span><span class="n">br_if</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">(;</span><span class="o">@</span><span class="mi">2</span><span class="p">;)</span>
<span class="mi">19</span><span class="w">              </span><span class="p">(</span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span>
<span class="mi">20</span><span class="w">            </span><span class="p">(</span><span class="n">br_if</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">(;</span><span class="o">@</span><span class="mi">3</span><span class="p">;)</span>
<span class="mi">21</span><span class="w">              </span><span class="p">(</span><span class="kt">i32</span><span class="p">.</span><span class="n">ne</span>
<span class="mi">22</span><span class="w">                </span><span class="p">(</span><span class="n">local</span><span class="p">.</span><span class="n">tee</span><span class="w"> </span><span class="mi">0</span>
<span class="mi">23</span><span class="w">                  </span><span class="p">(</span><span class="kt">i32</span><span class="p">.</span><span class="n">add</span>
<span class="mi">24</span><span class="w">                    </span><span class="p">(</span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="mi">25</span><span class="w">                    </span><span class="p">(</span><span class="kt">i32</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">12</span><span class="p">)))</span>
<span class="mi">26</span><span class="w">                </span><span class="p">(</span><span class="kt">i32</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">266</span><span class="p">))))</span>
<span class="mi">27</span><span class="w">          </span><span class="p">(</span><span class="k">loop</span><span class="w">  </span><span class="p">;;</span><span class="w"> </span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="mi">3</span>
<span class="mi">28</span><span class="w">            </span><span class="p">(</span><span class="n">br_if</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">(;</span><span class="o">@</span><span class="mi">2</span><span class="p">;)</span>
<span class="mi">29</span><span class="w">              </span><span class="p">(</span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span>
<span class="mi">30</span><span class="w">            </span><span class="p">(</span><span class="n">br_if</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">(;</span><span class="o">@</span><span class="mi">3</span><span class="p">;)</span>
<span class="mi">31</span><span class="w">              </span><span class="p">(</span><span class="kt">i32</span><span class="p">.</span><span class="n">ne</span>
<span class="mi">32</span><span class="w">                </span><span class="p">(</span><span class="n">local</span><span class="p">.</span><span class="n">tee</span><span class="w"> </span><span class="mi">0</span>
<span class="mi">33</span><span class="w">                  </span><span class="p">(</span><span class="kt">i32</span><span class="p">.</span><span class="n">add</span>
<span class="mi">34</span><span class="w">                    </span><span class="p">(</span><span class="n">local</span><span class="p">.</span><span class="n">get</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="mi">35</span><span class="w">                    </span><span class="p">(</span><span class="kt">i32</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">12</span><span class="p">)))</span>
<span class="mi">36</span><span class="w">                </span><span class="p">(</span><span class="kt">i32</span><span class="p">.</span><span class="k">const</span><span class="w"> </span><span class="mi">266</span><span class="p">))))</span>
</code></pre></div>
<p>&lt;/details&gt;</p>
<h3>Test Case</h3>
<p><a href="https://github.com/user-attachments/files/21452657/test_case.zip">test_case.zip</a></p>
<h3>Steps to Reproduce</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">#</span><span class="w"> </span><span class="n">Compile</span><span class="w"> </span><span class="n">C</span><span class="w"> </span><span class="n">files</span>
<span class="n">emcc</span><span class="w"> </span><span class="n">pr19005</span><span class="p">.</span><span class="n">c</span><span class="w"> </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="n">pr19005</span><span class="p">.</span><span class="n">wasm</span><span class="w"> </span><span class="o">-</span><span class="n">O2</span><span class="w"> </span><span class="o">-</span><span class="n">s</span><span class="w"> </span><span class="n">WASM</span><span class="o">=</span><span class="mi">1</span>

<span class="n">wasm2wat</span><span class="w"> </span><span class="o">-</span><span class="n">f</span><span class="w"> </span><span class="n">pr19005</span><span class="p">.</span><span class="n">wasm</span><span class="w"> </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="n">pr19005</span><span class="p">.</span><span class="n">wat</span>

<span class="n">wat2wasm</span><span class="w"> </span><span class="n">pr19005_test</span><span class="p">.</span><span class="n">wat</span><span class="w"> </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="n">pr19005_test</span><span class="p">.</span><span class="n">wasm</span>

<span class="p">#</span><span class="w"> </span><span class="n">Execute</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">wasm</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">collect</span><span class="w"> </span><span class="n">data</span>
<span class="n">perf</span><span class="w"> </span><span class="n">stat</span><span class="w"> </span><span class="o">-</span><span class="n">r</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">-</span><span class="n">e</span><span class="w"> </span><span class="o">'</span><span class="na">task</span><span class="o">-</span><span class="n">clock</span><span class="o">'</span><span class="w"> </span><span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">wasmtime</span><span class="w"> </span><span class="n">pr19005</span><span class="p">.</span><span class="n">wasm</span>
<span class="n">perf</span><span class="w"> </span><span class="n">stat</span><span class="w"> </span><span class="o">-</span><span class="n">r</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">-</span><span class="n">e</span><span class="w"> </span><span class="o">'</span><span class="na">task</span><span class="o">-</span><span class="n">clock</span><span class="o">'</span><span class="w"> </span><span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">wasmer</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">pr19005</span><span class="p">.</span><span class="n">wasm</span>
<span class="n">perf</span><span class="w"> </span><span class="n">stat</span><span class="w"> </span><span class="o">-</span><span class="n">r</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">-</span><span class="n">e</span><span class="w"> </span><span class="o">'</span><span class="na">task</span><span class="o">-</span><span class="n">clock</span><span class="o">'</span><span class="w"> </span><span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">wasmer</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">llvm</span><span class="w"> </span><span class="n">pr19005</span><span class="p">.</span><span class="n">wasm</span>
<span class="n">perf</span><span class="w"> </span><span class="n">stat</span><span class="w"> </span><span class="o">-</span><span class="n">r</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">-</span><span class="n">e</span><span class="w"> </span><span class="o">'</span><span class="na">task</span><span class="o">-</span><span class="n">clock</span><span class="o">'</span><span class="w"> </span><span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">wasmedge</span><span class="w"> </span><span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">jit</span><span class="w"> </span><span class="n">pr19005</span><span class="p">.</span><span class="n">wasm</span>
<span class="n">perf</span><span class="w"> </span><span class="n">stat</span><span class="w"> </span><span class="o">-</span><span class="n">r</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">-</span><span class="n">e</span><span class="w"> </span><span class="o">'</span><span class="na">task</span><span class="o">-</span><span class="n">clock</span><span class="o">'</span><span class="w"> </span><span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">build_llvm_jit</span><span class="o">/</span><span class="n">iwasm</span><span class="w"> </span><span class="n">pr19005</span><span class="p">.</span><span class="n">wasm</span>
<span class="p">#</span><span class="w"> </span><span class="n">pr19005_test</span><span class="p">.</span><span class="n">wasm</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">same</span>
</code></pre></div>
<h3>Analysis</h3>
<p>The added second loop doesn't really work in the use case. Before the second loop is executed, the value of <code>local 0</code> is equal to 266, so <code>local 0</code> in the second loop can only exit the loop after the loop exceeds 2&lt;sup&gt;32&lt;/sup&gt; and returns to itself. <br>
For this change, I observed that the time change was not noticeable when using <code>LLVM</code> as the backend, but there was a significant increase in time when using <code>cranelift</code> as the backend.</p>
<p>I suspect this may involve two backend optimization strategies for the code.</p>
<h3>Versions and Environment</h3>
<p>The runtime tools are all built on release and use <code>JIT</code>mode.</p>
<ul>
<li>wasmtime: 35.0.0 (9c2e6f17c 2025-06-17)</li>
<li>wasmer: 6.0.1</li>
<li>wasmedge: 0.14.1</li>
<li>WAMR: iwasm 2.4.0</li>
<li>emcc: 4.0.10 (b7dc6e5747465580df5984e723b9d1f10d8e804b)</li>
<li>wabt: 1.0.27</li>
<li>llvm: 18.1.8</li>
<li>Host OS: Ubuntu 22.04.5 LTS x64</li>
<li>CPU: 12th Gen Intel® Core™ i7-12700 × 20</li>
</ul>
<h3>Extra Info</h3>
<p>If you need any other relevant information, please let me know and I will do my best to provide it. Looking forward to your reply! Thank you!<br>
</p>
</blockquote>



<a name="531388696"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311330%20The%20Different%20Performances%20of%20Cra.../near/531388696" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311330.20The.20Different.20Performances.20of.20Cra.2E.2E.2E.html#531388696">(Jul 28 2025 at 14:43)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/11330#issuecomment-3127565089">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11330">issue #11330</a>:</p>
<blockquote>
<p>Thanks for the report, but Wasmtime and Cranelift, like peer runtimes on the web, are designed to efficiently run ahead-of-time optimized WebAssembly code. It's expected that you can craft modules that natively-optimized code will perform much better on. Cranelift does not attempt to be as optimizing of a compiler as LLVM, instead we rely on LLVM to do said optimizations and Cranelift takes it the "final mile" to machine code.</p>
<p>I'm going to close this because arbitrary modifications of WebAssembly files are known to produce un-optimized code. I understand that LLVM can see through these modifications and make things fast, but it's not a bug that Cranelift does not. Cranelift is intended to compiler-optimized code, and in this situation you're generating non-compiler-optimized code.</p>
<p>It's also worth noting that the reason Cranelift has this approach is that all modules in practice are optimized by LLVM. There is no use case we are aware of for intentionally not running an optimizing compiler like LLVM while also expecting the code to rust fast in Wasmtime.</p>
</blockquote>



<a name="531499067"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311330%20The%20Different%20Performances%20of%20Cra.../near/531499067" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311330.20The.20Different.20Performances.20of.20Cra.2E.2E.2E.html#531499067">(Jul 29 2025 at 02:44)</a>:</h4>
<p>gaaraw <a href="https://github.com/bytecodealliance/wasmtime/issues/11330#issuecomment-3130395147">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11330">issue #11330</a>:</p>
<blockquote>
<p>Thank you for your answer, it has deepened my understanding of cranelift.</p>
</blockquote>



<a name="531511995"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311330%20The%20Different%20Performances%20of%20Cra.../near/531511995" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311330.20The.20Different.20Performances.20of.20Cra.2E.2E.2E.html#531511995">(Jul 29 2025 at 04:55)</a>:</h4>
<p>pchickey edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/11330#issuecomment-3127565089">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11330">issue #11330</a>:</p>
<blockquote>
<p>Thanks for the report, but Wasmtime and Cranelift, like peer runtimes on the web, are designed to efficiently run ahead-of-time optimized WebAssembly code. It's expected that you can craft modules that natively-optimized code will perform much better on. Cranelift does not attempt to be as optimizing of a compiler as LLVM, instead we rely on LLVM to do said optimizations and Cranelift takes it the "final mile" to machine code.</p>
<p>I'm going to close this because arbitrary modifications of WebAssembly files are known to produce un-optimized code. I understand that LLVM can see through these modifications and make things fast, but it's not a bug that Cranelift does not. Cranelift is intended to compiler-optimized code, and in this situation you're generating non-compiler-optimized code.</p>
<p>It's also worth noting that the reason Cranelift has this approach is that all modules in practice are optimized by LLVM. There is no use case we are aware of for intentionally not running an optimizing compiler like LLVM while also expecting the code to run fast in Wasmtime.</p>
</blockquote>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
<html>
<head><meta charset="utf-8"><title>wasmtime / issue #12141 `wasmtime_wasi_http` call_handle ... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312141.20.60wasmtime_wasi_http.60.20call_handle.20.2E.2E.2E.html">wasmtime / issue #12141 `wasmtime_wasi_http` call_handle ...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="562502314"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312141%20%60wasmtime_wasi_http%60%20call_handle%20.../near/562502314" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312141.20.60wasmtime_wasi_http.60.20call_handle.20.2E.2E.2E.html#562502314">(Dec 08 2025 at 15:49)</a>:</h4>
<p>if0ne opened <a href="https://github.com/bytecodealliance/wasmtime/issues/12141">issue #12141</a>:</p>
<blockquote>
<p>Hi there!</p>
<p>If I try to return an array with a size of 2 MB, everything works fine:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">wasmcloud_component</span><span class="p">::</span><span class="n">http</span><span class="p">;</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">Component</span><span class="p">;</span>

<span class="k">impl</span><span class="w"> </span><span class="n">http</span><span class="p">::</span><span class="n">Server</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Component</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">handle</span><span class="p">(</span>
<span class="w">        </span><span class="n">_request</span><span class="p">:</span><span class="w"> </span><span class="nc">http</span><span class="p">::</span><span class="n">IncomingRequest</span><span class="p">,</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">http</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">http</span><span class="p">::</span><span class="n">Response</span><span class="o">&lt;</span><span class="k">impl</span><span class="w"> </span><span class="n">http</span><span class="p">::</span><span class="n">OutgoingBody</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="mi">0</span><span class="k">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1024</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1024</span><span class="p">];</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">http</span><span class="p">::</span><span class="n">Response</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">bytes</span><span class="p">))</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">http</span><span class="p">::</span><span class="n">export</span><span class="o">!</span><span class="p">(</span><span class="n">Component</span><span class="p">);</span>
</code></pre></div>
<p>Output:</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>curl<span class="w"> </span>localhost:8000<span class="w"> </span>--output<span class="w"> </span>output.txt
<span class="w">  </span>%<span class="w"> </span>Total<span class="w">    </span>%<span class="w"> </span>Received<span class="w"> </span>%<span class="w"> </span>Xferd<span class="w">  </span>Average<span class="w"> </span>Speed<span class="w">   </span>Time<span class="w">    </span>Time<span class="w">     </span>Time<span class="w">  </span>Current
<span class="w">                                 </span>Dload<span class="w">  </span>Upload<span class="w">   </span>Total<span class="w">   </span>Spent<span class="w">    </span>Left<span class="w">  </span>Speed
<span class="m">100</span><span class="w"> </span>2048k<span class="w">    </span><span class="m">0</span><span class="w"> </span>2048k<span class="w">    </span><span class="m">0</span><span class="w">     </span><span class="m">0</span><span class="w">  </span><span class="m">81</span>.7M<span class="w">      </span><span class="m">0</span><span class="w"> </span>--:--:--<span class="w"> </span>--:--:--<span class="w"> </span>--:--:--<span class="w"> </span><span class="m">83</span>.3M
</code></pre></div>
<p>But if I make the vector larger than 2 MB:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">wasmcloud_component</span><span class="p">::</span><span class="n">http</span><span class="p">;</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">Component</span><span class="p">;</span>

<span class="k">impl</span><span class="w"> </span><span class="n">http</span><span class="p">::</span><span class="n">Server</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Component</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">handle</span><span class="p">(</span>
<span class="w">        </span><span class="n">_request</span><span class="p">:</span><span class="w"> </span><span class="nc">http</span><span class="p">::</span><span class="n">IncomingRequest</span><span class="p">,</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">http</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">http</span><span class="p">::</span><span class="n">Response</span><span class="o">&lt;</span><span class="k">impl</span><span class="w"> </span><span class="n">http</span><span class="p">::</span><span class="n">OutgoingBody</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="mi">0</span><span class="k">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1024</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1024</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">http</span><span class="p">::</span><span class="n">Response</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">bytes</span><span class="p">))</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">http</span><span class="p">::</span><span class="n">export</span><span class="o">!</span><span class="p">(</span><span class="n">Component</span><span class="p">);</span>
</code></pre></div>
<p>Output:</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>curl<span class="w"> </span>localhost:8000<span class="w"> </span>--output<span class="w"> </span>output.txt
<span class="w">  </span>%<span class="w"> </span>Total<span class="w">    </span>%<span class="w"> </span>Received<span class="w"> </span>%<span class="w"> </span>Xferd<span class="w">  </span>Average<span class="w"> </span>Speed<span class="w">   </span>Time<span class="w">    </span>Time<span class="w">     </span>Time<span class="w">  </span>Current
<span class="w">                                 </span>Dload<span class="w">  </span>Upload<span class="w">   </span>Total<span class="w">   </span>Spent<span class="w">    </span>Left<span class="w">  </span>Speed
<span class="w">  </span><span class="m">0</span><span class="w">     </span><span class="m">0</span><span class="w">    </span><span class="m">0</span><span class="w">     </span><span class="m">0</span><span class="w">    </span><span class="m">0</span><span class="w">     </span><span class="m">0</span><span class="w">      </span><span class="m">0</span><span class="w">      </span><span class="m">0</span><span class="w"> </span>--:--:--<span class="w">  </span><span class="m">0</span>:01:55<span class="w"> </span>--:--:--<span class="w">     </span><span class="m">0</span>
</code></pre></div>
<p>I debugged the wasmCloud runtime and found that the code freezes on <code>call_handle</code>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">sender</span><span class="p">,</span><span class="w"> </span><span class="n">receiver</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tokio</span><span class="p">::</span><span class="n">sync</span><span class="p">::</span><span class="n">oneshot</span><span class="p">::</span><span class="n">channel</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">scheme</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">req</span><span class="p">.</span><span class="n">uri</span><span class="p">().</span><span class="n">scheme</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">Some</span><span class="p">(</span><span class="n">scheme</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">scheme</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">&amp;</span><span class="n">hyper</span><span class="p">::</span><span class="n">http</span><span class="p">::</span><span class="n">uri</span><span class="p">::</span><span class="n">Scheme</span><span class="p">::</span><span class="n">HTTP</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">Scheme</span><span class="p">::</span><span class="n">Http</span><span class="p">,</span>
<span class="w">        </span><span class="nb">Some</span><span class="p">(</span><span class="n">scheme</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">scheme</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">&amp;</span><span class="n">hyper</span><span class="p">::</span><span class="n">http</span><span class="p">::</span><span class="n">uri</span><span class="p">::</span><span class="n">Scheme</span><span class="p">::</span><span class="n">HTTPS</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">Scheme</span><span class="p">::</span><span class="n">Https</span><span class="p">,</span>
<span class="w">        </span><span class="nb">Some</span><span class="p">(</span><span class="n">scheme</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">Scheme</span><span class="p">::</span><span class="n">Other</span><span class="p">(</span><span class="n">scheme</span><span class="p">.</span><span class="n">as_str</span><span class="p">().</span><span class="n">to_string</span><span class="p">()),</span>
<span class="w">        </span><span class="c1">// Fallback to HTTP if no scheme is present</span>
<span class="w">        </span><span class="nb">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">Scheme</span><span class="p">::</span><span class="n">Http</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">req</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">store</span><span class="p">.</span><span class="n">data_mut</span><span class="p">().</span><span class="n">new_incoming_request</span><span class="p">(</span><span class="n">scheme</span><span class="p">,</span><span class="w"> </span><span class="n">req</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">store</span><span class="p">.</span><span class="n">data_mut</span><span class="p">().</span><span class="n">new_response_outparam</span><span class="p">(</span><span class="n">sender</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">pre</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ProxyPre</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">pre</span><span class="p">).</span><span class="n">context</span><span class="p">(</span><span class="s">"failed to instantiate proxy pre"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Run the http request itself by instantiating and calling the component</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">proxy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pre</span><span class="p">.</span><span class="n">instantiate_async</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="n">proxy</span>
<span class="w">        </span><span class="p">.</span><span class="n">wasi_http_incoming_handler</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">call_handle</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="n">req</span><span class="p">,</span><span class="w"> </span><span class="n">out</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
</code></pre></div>
<p>I use default <code>outgoing_body_buffer_chunks</code> and <code>outgoing_body_chunk_size</code> in examples above</p>
<h3>Expected Results</h3>
<p>I think that if the body exceeds the outgoing parameter limits, <code>call_handle</code> should return an error instead of freezing.</p>
<h3>Actual Results</h3>
<p>TODO: What actually happens? Panic? Segfault? Incorrect result?</p>
<h3>Versions and Environment</h3>
<p>wasmtime = { version = "38", default-features = false }<br>
wasmtime-wasi = { version = "38", default-features = false }<br>
wasmtime-wasi-io = { version = "38", default-features = false }<br>
wasmtime-wasi-http = { version = "38", default-features = false }</p>
<h3>Extra Info</h3>
<p>Anything else you'd like to add?<br>
</p>
</blockquote>



<a name="562502315"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312141%20%60wasmtime_wasi_http%60%20call_handle%20.../near/562502315" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312141.20.60wasmtime_wasi_http.60.20call_handle.20.2E.2E.2E.html#562502315">(Dec 08 2025 at 15:49)</a>:</h4>
<p><a href="https://github.com/if0ne">if0ne</a> added the bug label to <a href="https://github.com/bytecodealliance/wasmtime/issues/12141">Issue #12141</a>.</p>



<a name="562531934"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312141%20%60wasmtime_wasi_http%60%20call_handle%20.../near/562531934" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312141.20.60wasmtime_wasi_http.60.20call_handle.20.2E.2E.2E.html#562531934">(Dec 08 2025 at 18:11)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/12141#issuecomment-3628377665">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12141">issue #12141</a>:</p>
<blockquote>
<p>Thanks for the report! Would you be able to reduce this to a component which you could upload + a <code>wasmtime serve</code> invocation + a <code>curl</code> invocation? If the bug lies in Wasmtime I believe that should be a possible reproduction path.</p>
</blockquote>



<a name="562561521"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312141%20%60wasmtime_wasi_http%60%20call_handle%20.../near/562561521" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312141.20.60wasmtime_wasi_http.60.20call_handle.20.2E.2E.2E.html#562561521">(Dec 08 2025 at 21:29)</a>:</h4>
<p>if0ne closed <a href="https://github.com/bytecodealliance/wasmtime/issues/12141">issue #12141</a>:</p>
<blockquote>
<p>Hi there!</p>
<p>If I try to return an array with a size of 2 MB, everything works fine:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">wasmcloud_component</span><span class="p">::</span><span class="n">http</span><span class="p">;</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">Component</span><span class="p">;</span>

<span class="k">impl</span><span class="w"> </span><span class="n">http</span><span class="p">::</span><span class="n">Server</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Component</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">handle</span><span class="p">(</span>
<span class="w">        </span><span class="n">_request</span><span class="p">:</span><span class="w"> </span><span class="nc">http</span><span class="p">::</span><span class="n">IncomingRequest</span><span class="p">,</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">http</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">http</span><span class="p">::</span><span class="n">Response</span><span class="o">&lt;</span><span class="k">impl</span><span class="w"> </span><span class="n">http</span><span class="p">::</span><span class="n">OutgoingBody</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="mi">0</span><span class="k">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1024</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1024</span><span class="p">];</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">http</span><span class="p">::</span><span class="n">Response</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">bytes</span><span class="p">))</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">http</span><span class="p">::</span><span class="n">export</span><span class="o">!</span><span class="p">(</span><span class="n">Component</span><span class="p">);</span>
</code></pre></div>
<p>Output:</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>curl<span class="w"> </span>localhost:8000<span class="w"> </span>--output<span class="w"> </span>output.txt
<span class="w">  </span>%<span class="w"> </span>Total<span class="w">    </span>%<span class="w"> </span>Received<span class="w"> </span>%<span class="w"> </span>Xferd<span class="w">  </span>Average<span class="w"> </span>Speed<span class="w">   </span>Time<span class="w">    </span>Time<span class="w">     </span>Time<span class="w">  </span>Current
<span class="w">                                 </span>Dload<span class="w">  </span>Upload<span class="w">   </span>Total<span class="w">   </span>Spent<span class="w">    </span>Left<span class="w">  </span>Speed
<span class="m">100</span><span class="w"> </span>2048k<span class="w">    </span><span class="m">0</span><span class="w"> </span>2048k<span class="w">    </span><span class="m">0</span><span class="w">     </span><span class="m">0</span><span class="w">  </span><span class="m">81</span>.7M<span class="w">      </span><span class="m">0</span><span class="w"> </span>--:--:--<span class="w"> </span>--:--:--<span class="w"> </span>--:--:--<span class="w"> </span><span class="m">83</span>.3M
</code></pre></div>
<p>But if I make the vector larger than 2 MB:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">wasmcloud_component</span><span class="p">::</span><span class="n">http</span><span class="p">;</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">Component</span><span class="p">;</span>

<span class="k">impl</span><span class="w"> </span><span class="n">http</span><span class="p">::</span><span class="n">Server</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Component</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">handle</span><span class="p">(</span>
<span class="w">        </span><span class="n">_request</span><span class="p">:</span><span class="w"> </span><span class="nc">http</span><span class="p">::</span><span class="n">IncomingRequest</span><span class="p">,</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">http</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">http</span><span class="p">::</span><span class="n">Response</span><span class="o">&lt;</span><span class="k">impl</span><span class="w"> </span><span class="n">http</span><span class="p">::</span><span class="n">OutgoingBody</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="mi">0</span><span class="k">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1024</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1024</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">http</span><span class="p">::</span><span class="n">Response</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">bytes</span><span class="p">))</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">http</span><span class="p">::</span><span class="n">export</span><span class="o">!</span><span class="p">(</span><span class="n">Component</span><span class="p">);</span>
</code></pre></div>
<p>Output:</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>curl<span class="w"> </span>localhost:8000<span class="w"> </span>--output<span class="w"> </span>output.txt
<span class="w">  </span>%<span class="w"> </span>Total<span class="w">    </span>%<span class="w"> </span>Received<span class="w"> </span>%<span class="w"> </span>Xferd<span class="w">  </span>Average<span class="w"> </span>Speed<span class="w">   </span>Time<span class="w">    </span>Time<span class="w">     </span>Time<span class="w">  </span>Current
<span class="w">                                 </span>Dload<span class="w">  </span>Upload<span class="w">   </span>Total<span class="w">   </span>Spent<span class="w">    </span>Left<span class="w">  </span>Speed
<span class="w">  </span><span class="m">0</span><span class="w">     </span><span class="m">0</span><span class="w">    </span><span class="m">0</span><span class="w">     </span><span class="m">0</span><span class="w">    </span><span class="m">0</span><span class="w">     </span><span class="m">0</span><span class="w">      </span><span class="m">0</span><span class="w">      </span><span class="m">0</span><span class="w"> </span>--:--:--<span class="w">  </span><span class="m">0</span>:01:55<span class="w"> </span>--:--:--<span class="w">     </span><span class="m">0</span>
</code></pre></div>
<p>I debugged the wasmCloud runtime and found that the code freezes on <code>call_handle</code>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">sender</span><span class="p">,</span><span class="w"> </span><span class="n">receiver</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tokio</span><span class="p">::</span><span class="n">sync</span><span class="p">::</span><span class="n">oneshot</span><span class="p">::</span><span class="n">channel</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">scheme</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">req</span><span class="p">.</span><span class="n">uri</span><span class="p">().</span><span class="n">scheme</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">Some</span><span class="p">(</span><span class="n">scheme</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">scheme</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">&amp;</span><span class="n">hyper</span><span class="p">::</span><span class="n">http</span><span class="p">::</span><span class="n">uri</span><span class="p">::</span><span class="n">Scheme</span><span class="p">::</span><span class="n">HTTP</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">Scheme</span><span class="p">::</span><span class="n">Http</span><span class="p">,</span>
<span class="w">        </span><span class="nb">Some</span><span class="p">(</span><span class="n">scheme</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">scheme</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">&amp;</span><span class="n">hyper</span><span class="p">::</span><span class="n">http</span><span class="p">::</span><span class="n">uri</span><span class="p">::</span><span class="n">Scheme</span><span class="p">::</span><span class="n">HTTPS</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">Scheme</span><span class="p">::</span><span class="n">Https</span><span class="p">,</span>
<span class="w">        </span><span class="nb">Some</span><span class="p">(</span><span class="n">scheme</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">Scheme</span><span class="p">::</span><span class="n">Other</span><span class="p">(</span><span class="n">scheme</span><span class="p">.</span><span class="n">as_str</span><span class="p">().</span><span class="n">to_string</span><span class="p">()),</span>
<span class="w">        </span><span class="c1">// Fallback to HTTP if no scheme is present</span>
<span class="w">        </span><span class="nb">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">Scheme</span><span class="p">::</span><span class="n">Http</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">req</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">store</span><span class="p">.</span><span class="n">data_mut</span><span class="p">().</span><span class="n">new_incoming_request</span><span class="p">(</span><span class="n">scheme</span><span class="p">,</span><span class="w"> </span><span class="n">req</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">store</span><span class="p">.</span><span class="n">data_mut</span><span class="p">().</span><span class="n">new_response_outparam</span><span class="p">(</span><span class="n">sender</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">pre</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ProxyPre</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">pre</span><span class="p">).</span><span class="n">context</span><span class="p">(</span><span class="s">"failed to instantiate proxy pre"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// Run the http request itself by instantiating and calling the component</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">proxy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pre</span><span class="p">.</span><span class="n">instantiate_async</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="n">proxy</span>
<span class="w">        </span><span class="p">.</span><span class="n">wasi_http_incoming_handler</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">call_handle</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="n">req</span><span class="p">,</span><span class="w"> </span><span class="n">out</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
</code></pre></div>
<p>I use default <code>outgoing_body_buffer_chunks</code> and <code>outgoing_body_chunk_size</code> in examples above</p>
<h3>Expected Results</h3>
<p>I think that if the body exceeds the outgoing parameter limits, <code>call_handle</code> should return an error instead of freezing.</p>
<h3>Actual Results</h3>
<p>TODO: What actually happens? Panic? Segfault? Incorrect result?</p>
<h3>Versions and Environment</h3>
<p>wasmtime = { version = "38", default-features = false }<br>
wasmtime-wasi = { version = "38", default-features = false }<br>
wasmtime-wasi-io = { version = "38", default-features = false }<br>
wasmtime-wasi-http = { version = "38", default-features = false }</p>
<h3>Extra Info</h3>
<p>Anything else you'd like to add?<br>
</p>
</blockquote>



<a name="562561522"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312141%20%60wasmtime_wasi_http%60%20call_handle%20.../near/562561522" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312141.20.60wasmtime_wasi_http.60.20call_handle.20.2E.2E.2E.html#562561522">(Dec 08 2025 at 21:29)</a>:</h4>
<p>if0ne <a href="https://github.com/bytecodealliance/wasmtime/issues/12141#issuecomment-3629082069">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12141">issue #12141</a>:</p>
<blockquote>
<p>I tested it using wasmtime serve. Everything works.</p>
</blockquote>



<a name="562660002"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312141%20%60wasmtime_wasi_http%60%20call_handle%20.../near/562660002" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312141.20.60wasmtime_wasi_http.60.20call_handle.20.2E.2E.2E.html#562660002">(Dec 09 2025 at 11:30)</a>:</h4>
<p>if0ne <a href="https://github.com/bytecodealliance/wasmtime/issues/12141#issuecomment-3631769876">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12141">issue #12141</a>:</p>
<blockquote>
<p>@alexcrichton the solution is to call call_handle in a separate <code>tokio::task</code>.</p>
</blockquote>



<hr><p>Last updated: Feb 22 2026 at 11:05 UTC</p>
</html>
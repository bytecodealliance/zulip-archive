<html>
<head><meta charset="utf-8"><title>wasmtime / PR #11942 cranelift: ISLE wrapper for construc... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311942.20cranelift.3A.20ISLE.20wrapper.20for.20construc.2E.2E.2E.html">wasmtime / PR #11942 cranelift: ISLE wrapper for construc...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="547110023"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311942%20cranelift%3A%20ISLE%20wrapper%20for%20construc.../near/547110023" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311942.20cranelift.3A.20ISLE.20wrapper.20for.20construc.2E.2E.2E.html#547110023">(Oct 26 2025 at 07:25)</a>:</h4>
<p>efJerryYang opened <a href="https://github.com/bytecodealliance/wasmtime/pull/11942">PR #11942</a> from <code>efJerryYang:jerrys-fix-for-6038</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
<h2>Description</h2>
<p>This should close #6038.</p>
<p>This PR builds on top of PR #10528, but replaces the <code>ty_vec</code> type with <code>ty_vec128</code>, which is the only one that's actually used in those productions (e.g., <a href="https://github.com/bytecodealliance/wasmtime/blob/311bf0f3dcae521a808401148219cf1f16515ee5/cranelift/codegen/src/opts/cprop.isle#L227-L230">https://github.com/bytecodealliance/wasmtime/blob/311bf0f3dcae521a808401148219cf1f16515ee5/cranelift/codegen/src/opts/cprop.isle#L227-L230</a>, and adds float handling on top of the draft in issue #6038.</p>
<h2>Testing</h2>
<ul>
<li><code>cranelift/filetests/filetests/egraph/cprop-splat.clif</code> - Added <code>%f16x8</code>.</li>
<li><code>cranelift/filetests/filetests/egraph/cprop.clif</code> - Added <code>%f16_fneg_const</code>, covering <code>f16const</code> usage.</li>
<li><code>cranelift/filetests/filetests/egraph/cprop.clif</code> – Added <code>%u64_to_f64_const</code>, covering the integer-to-float conversion.</li>
</ul>
<p>All tests pass for <code>cranelift-tools</code> according to the instructions at <a href="https://docs.wasmtime.dev/contributing-testing.html">https://docs.wasmtime.dev/contributing-testing.html</a></p>
<h2>Notes</h2>
<p>A few additional clarifications:</p>
<ol>
<li>Using <code>const</code> with float types incurs an extra <code>Ieee64 -&gt; Imm64 -&gt; Ieee64</code> round trip. This is unavoidable because <code>decl const</code> cannot be overloaded, so it cannot accept <code>const (Type Ieee64)</code> or other float types directly (e.g., <code>Ieee32</code> or <code>Ieee16</code>). I also tried passing <code>DataValue</code> to allow a generic holder for types like <code>Imm64</code> and <code>Ieee64</code>, but that likewise caused problems and would require larger changes (the core issue is that <code>Type</code> is a struct rather than an enum; if <code>Type</code> were an enum like <code>DataValue</code> this would be much simpler, but as it stands we can't leverage it directly). After consideration, I'm submitting the <code>Imm64</code>-based version. The discarded <code>DataValue</code> version can be found at <a href="https://github.com/efJerryYang/wasmtime/commit/d0df1133c45722df5011ba61d682af0b6bb7724d">https://github.com/efJerryYang/wasmtime/commit/d0df1133c45722df5011ba61d682af0b6bb7724d</a>.</li>
<li>I additionally added support for <code>F16</code>, along with test cases. I noticed the previous inconsistency but wasn't sure whether it was intentional or an oversight. Adding this rule does not break any existing tests, and I also added test cases for <code>F16</code>. Also, <code>(subsume (f16const $F32 r))</code> in <a href="https://github.com/bytecodealliance/wasmtime/blob/311bf0f3dcae521a808401148219cf1f16515ee5/cranelift/codegen/src/opts/cprop.isle#L395-L395">https://github.com/bytecodealliance/wasmtime/blob/311bf0f3dcae521a808401148219cf1f16515ee5/cranelift/codegen/src/opts/cprop.isle#L395-L395</a> appears to be a typo, so I fixed it (<code>$F32</code> -&gt; <code>$F16</code>).</li>
<li>As suggested in <a href="https://github.com/bytecodealliance/wasmtime/pull/10528#issuecomment-2784280332">https://github.com/bytecodealliance/wasmtime/pull/10528#issuecomment-2784280332</a>, i replaced the RHS usages of <code>iconst</code>, <code>vconst</code>, <code>f16const</code>, <code>f32const</code> and <code>f64const</code> to <code>const</code> and ran the <code>cargo test -p cranelift-tools</code> with all test cases pass.</li>
</ol>
</blockquote>



<a name="547110024"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311942%20cranelift%3A%20ISLE%20wrapper%20for%20construc.../near/547110024" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311942.20cranelift.3A.20ISLE.20wrapper.20for.20construc.2E.2E.2E.html#547110024">(Oct 26 2025 at 07:25)</a>:</h4>
<p><strong>efJerryYang</strong> requested <a href="https://github.com/alexcrichton">alexcrichton</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/11942">PR #11942</a>.</p>



<a name="547110025"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311942%20cranelift%3A%20ISLE%20wrapper%20for%20construc.../near/547110025" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311942.20cranelift.3A.20ISLE.20wrapper.20for.20construc.2E.2E.2E.html#547110025">(Oct 26 2025 at 07:25)</a>:</h4>
<p><strong>efJerryYang</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/11942">PR #11942</a>.</p>



<a name="547110158"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311942%20cranelift%3A%20ISLE%20wrapper%20for%20construc.../near/547110158" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311942.20cranelift.3A.20ISLE.20wrapper.20for.20construc.2E.2E.2E.html#547110158">(Oct 26 2025 at 07:28)</a>:</h4>
<p>efJerryYang edited <a href="https://github.com/bytecodealliance/wasmtime/pull/11942">PR #11942</a>:</p>
<blockquote>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
<h2>Description</h2>
<p>This should close #6038.</p>
<p>This PR builds on top of PR #10528, but replaces the <code>ty_vec</code> type with <code>ty_vec128</code>, which is the only one that's actually used in those productions (e.g., <a href="https://github.com/bytecodealliance/wasmtime/blob/311bf0f3dcae521a808401148219cf1f16515ee5/cranelift/codegen/src/opts/cprop.isle#L227-L230">https://github.com/bytecodealliance/wasmtime/blob/311bf0f3dcae521a808401148219cf1f16515ee5/cranelift/codegen/src/opts/cprop.isle#L227-L230</a>, and adds float handling on top of the draft in issue #6038. Note, many functions are not pure, we cannot use <code>(decl pure const (Type u64) Value)</code> as by #6038.</p>
<h2>Testing</h2>
<ul>
<li><code>cranelift/filetests/filetests/egraph/cprop-splat.clif</code> - Added <code>%f16x8</code>.</li>
<li><code>cranelift/filetests/filetests/egraph/cprop.clif</code> - Added <code>%f16_fneg_const</code>, covering <code>f16const</code> usage.</li>
<li><code>cranelift/filetests/filetests/egraph/cprop.clif</code> – Added <code>%u64_to_f64_const</code>, covering the integer-to-float conversion.</li>
</ul>
<p>All tests pass for <code>cranelift-tools</code> according to the instructions at <a href="https://docs.wasmtime.dev/contributing-testing.html">https://docs.wasmtime.dev/contributing-testing.html</a></p>
<h2>Notes</h2>
<p>A few additional clarifications:</p>
<ol>
<li>Using <code>const</code> with float types incurs an extra <code>Ieee64 -&gt; Imm64 -&gt; Ieee64</code> round trip. This is unavoidable because <code>decl const</code> cannot be overloaded, so it cannot accept <code>const (Type Ieee64)</code> or other float types directly (e.g., <code>Ieee32</code> or <code>Ieee16</code>). I also tried passing <code>DataValue</code> to allow a generic holder for types like <code>Imm64</code> and <code>Ieee64</code>, but that likewise caused problems and would require larger changes (the core issue is that <code>Type</code> is a struct rather than an enum; if <code>Type</code> were an enum like <code>DataValue</code> this would be much simpler, but as it stands we can't leverage it directly). After consideration, I'm submitting the <code>Imm64</code>-based version. The discarded <code>DataValue</code> version can be found at <a href="https://github.com/efJerryYang/wasmtime/commit/d0df1133c45722df5011ba61d682af0b6bb7724d">https://github.com/efJerryYang/wasmtime/commit/d0df1133c45722df5011ba61d682af0b6bb7724d</a>.</li>
<li>I additionally added support for <code>F16</code>, along with test cases. I noticed the previous inconsistency but wasn't sure whether it was intentional or an oversight. Adding this rule does not break any existing tests, and I also added test cases for <code>F16</code>. Also, <code>(subsume (f16const $F32 r))</code> in <a href="https://github.com/bytecodealliance/wasmtime/blob/311bf0f3dcae521a808401148219cf1f16515ee5/cranelift/codegen/src/opts/cprop.isle#L395-L395">https://github.com/bytecodealliance/wasmtime/blob/311bf0f3dcae521a808401148219cf1f16515ee5/cranelift/codegen/src/opts/cprop.isle#L395-L395</a> appears to be a typo, so I fixed it (<code>$F32</code> -&gt; <code>$F16</code>).</li>
<li>As suggested in <a href="https://github.com/bytecodealliance/wasmtime/pull/10528#issuecomment-2784280332">https://github.com/bytecodealliance/wasmtime/pull/10528#issuecomment-2784280332</a>, i replaced the RHS usages of <code>iconst</code>, <code>vconst</code>, <code>f16const</code>, <code>f32const</code> and <code>f64const</code> to <code>const</code> and ran the <code>cargo test -p cranelift-tools</code> with all test cases pass.</li>
</ol>
</blockquote>



<a name="547114568"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311942%20cranelift%3A%20ISLE%20wrapper%20for%20construc.../near/547114568" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311942.20cranelift.3A.20ISLE.20wrapper.20for.20construc.2E.2E.2E.html#547114568">(Oct 26 2025 at 08:45)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/11942#issuecomment-3448216704">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11942">PR #11942</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @cfallin, @fitzgen</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "cranelift", "isle"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>cfallin: isle</li>
<li>fitzgen: isle</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="547139780"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311942%20cranelift%3A%20ISLE%20wrapper%20for%20construc.../near/547139780" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311942.20cranelift.3A.20ISLE.20wrapper.20for.20construc.2E.2E.2E.html#547139780">(Oct 26 2025 at 15:40)</a>:</h4>
<p>efJerryYang edited <a href="https://github.com/bytecodealliance/wasmtime/pull/11942">PR #11942</a>:</p>
<blockquote>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
<h2>Description</h2>
<p>This should close #6038.</p>
<p>This PR builds on top of PR #10528, but replaces the <code>ty_vec</code> type with <code>ty_vec128</code>, which is the only one that's actually used in those productions (e.g., <a href="https://github.com/bytecodealliance/wasmtime/blob/311bf0f3dcae521a808401148219cf1f16515ee5/cranelift/codegen/src/opts/cprop.isle#L227-L230">https://github.com/bytecodealliance/wasmtime/blob/311bf0f3dcae521a808401148219cf1f16515ee5/cranelift/codegen/src/opts/cprop.isle#L227-L230</a>, and adds float handling on top of the draft in issue #6038. Note, many functions are not pure, we cannot use <code>(decl pure const (Type u64) Value)</code> as by #6038.</p>
<h2>Testing</h2>
<ul>
<li><code>cranelift/filetests/filetests/egraph/cprop-splat.clif</code> - Added <code>%f16x8</code>.</li>
<li><code>cranelift/filetests/filetests/egraph/cprop.clif</code> - Added <code>%f16_fneg_const</code>, covering <code>f16const</code> usage.</li>
<li><code>cranelift/filetests/filetests/egraph/cprop.clif</code> – Added <code>%u64_to_f64_const</code>, covering the integer-to-float conversion.</li>
</ul>
<p>All tests pass for <code>cranelift-tools</code> according to the instructions at <a href="https://docs.wasmtime.dev/contributing-testing.html">https://docs.wasmtime.dev/contributing-testing.html</a></p>
<h2>Notes</h2>
<p>A few additional clarifications:</p>
<ol>
<li>Using <code>const</code> with float types incurs an extra <code>Ieee64 -&gt; Imm64 -&gt; Ieee64</code> round trip. This is unavoidable because <code>decl const</code> cannot be overloaded, so it cannot accept <code>const (Type Ieee64)</code> or other float types directly (e.g., <code>Ieee32</code> or <code>Ieee16</code>). I also tried passing <code>DataValue</code> to allow a generic holder for types like <code>Imm64</code> and <code>Ieee64</code>, but that likewise caused problems and would require larger changes (the core issue is that <code>Type</code> is a struct rather than an enum; if <code>Type</code> were an enum like <code>DataValue</code> this would be much simpler, but as it stands we can't leverage it directly). After consideration, I'm submitting the <code>Imm64</code>-based version. The discarded <code>DataValue</code> version can be found at <a href="https://github.com/efJerryYang/wasmtime/commit/d0df1133c45722df5011ba61d682af0b6bb7724d">https://github.com/efJerryYang/wasmtime/commit/d0df1133c45722df5011ba61d682af0b6bb7724d</a>.</li>
<li>I additionally added support for <code>F16</code>, along with test cases. I noticed the previous inconsistency but wasn't sure whether it was intentional or an oversight, see <a href="https://github.com/bytecodealliance/wasmtime/blob/8e22ff89f6affe4f79fcebdb416d0ab401d43c97/cranelift/codegen/src/opts/cprop.isle#L233-L248">https://github.com/bytecodealliance/wasmtime/blob/8e22ff89f6affe4f79fcebdb416d0ab401d43c97/cranelift/codegen/src/opts/cprop.isle#L233-L248</a> the Constant rules code below it has F16 but this simplify rule doesn't, and I added the F16 rule production. Adding this rule does not break any existing tests, and I also added test cases for <code>F16</code>. Also, <code>(subsume (f16const $F32 r))</code> in <a href="https://github.com/bytecodealliance/wasmtime/blob/311bf0f3dcae521a808401148219cf1f16515ee5/cranelift/codegen/src/opts/cprop.isle#L395-L395">https://github.com/bytecodealliance/wasmtime/blob/311bf0f3dcae521a808401148219cf1f16515ee5/cranelift/codegen/src/opts/cprop.isle#L395-L395</a> appears to be a typo, so I fixed it (<code>$F32</code> -&gt; <code>$F16</code>).</li>
<li>As suggested in <a href="https://github.com/bytecodealliance/wasmtime/pull/10528#issuecomment-2784280332">https://github.com/bytecodealliance/wasmtime/pull/10528#issuecomment-2784280332</a>, i replaced the RHS usages of <code>iconst</code>, <code>vconst</code>, <code>f16const</code>, <code>f32const</code> and <code>f64const</code> to <code>const</code> and ran the <code>cargo test -p cranelift-tools</code> with all test cases pass.</li>
</ol>
</blockquote>



<a name="547292566"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311942%20cranelift%3A%20ISLE%20wrapper%20for%20construc.../near/547292566" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311942.20cranelift.3A.20ISLE.20wrapper.20for.20construc.2E.2E.2E.html#547292566">(Oct 27 2025 at 14:33)</a>:</h4>
<p>efJerryYang edited <a href="https://github.com/bytecodealliance/wasmtime/pull/11942">PR #11942</a>:</p>
<blockquote>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
<h2>Description</h2>
<p>This should close #6038.</p>
<p>This PR builds on top of PR #10528, but replaces the <code>ty_vec</code> type with <code>ty_vec128</code>, which is the only one that's actually used in those productions (e.g., <a href="https://github.com/bytecodealliance/wasmtime/blob/311bf0f3dcae521a808401148219cf1f16515ee5/cranelift/codegen/src/opts/cprop.isle#L227-L230">https://github.com/bytecodealliance/wasmtime/blob/311bf0f3dcae521a808401148219cf1f16515ee5/cranelift/codegen/src/opts/cprop.isle#L227-L230</a>, and adds float handling on top of the draft in issue #6038. Note, many functions are not pure, we cannot use <code>(decl pure const (Type u64) Value)</code> as by #6038.</p>
<p>Note: <code>f128const</code> support is missing at the moment, will include it if maintainers are happy with this PR.</p>
<h2>Testing</h2>
<ul>
<li><code>cranelift/filetests/filetests/egraph/cprop-splat.clif</code> - Added <code>%f16x8</code>.</li>
<li><code>cranelift/filetests/filetests/egraph/cprop.clif</code> - Added <code>%f16_fneg_const</code>, covering <code>f16const</code> usage.</li>
<li><code>cranelift/filetests/filetests/egraph/cprop.clif</code> – Added <code>%u64_to_f64_const</code>, covering the integer-to-float conversion.</li>
</ul>
<p>All tests pass for <code>cranelift-tools</code> according to the instructions at <a href="https://docs.wasmtime.dev/contributing-testing.html">https://docs.wasmtime.dev/contributing-testing.html</a></p>
<h2>Notes</h2>
<p>A few additional clarifications:</p>
<ol>
<li>Using <code>const</code> with float types incurs an extra <code>Ieee64 -&gt; Imm64 -&gt; Ieee64</code> round trip. This is unavoidable because <code>decl const</code> cannot be overloaded, so it cannot accept <code>const (Type Ieee64)</code> or other float types directly (e.g., <code>Ieee32</code> or <code>Ieee16</code>). I also tried passing <code>DataValue</code> to allow a generic holder for types like <code>Imm64</code> and <code>Ieee64</code>, but that likewise caused problems and would require larger changes (the core issue is that <code>Type</code> is a struct rather than an enum; if <code>Type</code> were an enum like <code>DataValue</code> this would be much simpler, but as it stands we can't leverage it directly). After consideration, I'm submitting the <code>Imm64</code>-based version. The discarded <code>DataValue</code> version can be found at <a href="https://github.com/efJerryYang/wasmtime/commit/d0df1133c45722df5011ba61d682af0b6bb7724d">https://github.com/efJerryYang/wasmtime/commit/d0df1133c45722df5011ba61d682af0b6bb7724d</a>.</li>
<li>I additionally added support for <code>F16</code>, along with test cases. I noticed the previous inconsistency but wasn't sure whether it was intentional or an oversight, see <a href="https://github.com/bytecodealliance/wasmtime/blob/8e22ff89f6affe4f79fcebdb416d0ab401d43c97/cranelift/codegen/src/opts/cprop.isle#L233-L248">https://github.com/bytecodealliance/wasmtime/blob/8e22ff89f6affe4f79fcebdb416d0ab401d43c97/cranelift/codegen/src/opts/cprop.isle#L233-L248</a> the Constant rules code below it has F16 but this simplify rule doesn't, and I added the F16 rule production. Adding this rule does not break any existing tests, and I also added test cases for <code>F16</code>. Also, <code>(subsume (f16const $F32 r))</code> in <a href="https://github.com/bytecodealliance/wasmtime/blob/311bf0f3dcae521a808401148219cf1f16515ee5/cranelift/codegen/src/opts/cprop.isle#L395-L395">https://github.com/bytecodealliance/wasmtime/blob/311bf0f3dcae521a808401148219cf1f16515ee5/cranelift/codegen/src/opts/cprop.isle#L395-L395</a> appears to be a typo, so I fixed it (<code>$F32</code> -&gt; <code>$F16</code>).</li>
<li>As suggested in <a href="https://github.com/bytecodealliance/wasmtime/pull/10528#issuecomment-2784280332">https://github.com/bytecodealliance/wasmtime/pull/10528#issuecomment-2784280332</a>, i replaced the RHS usages of <code>iconst</code>, <code>vconst</code>, <code>f16const</code>, <code>f32const</code> and <code>f64const</code> to <code>const</code> and ran the <code>cargo test -p cranelift-tools</code> with all test cases pass.</li>
</ol>
</blockquote>



<a name="548324888"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311942%20cranelift%3A%20ISLE%20wrapper%20for%20construc.../near/548324888" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311942.20cranelift.3A.20ISLE.20wrapper.20for.20construc.2E.2E.2E.html#548324888">(Nov 01 2025 at 17:31)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/fitzgen">fitzgen</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/11942">PR #11942</a>.</p>



<a name="548324934"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311942%20cranelift%3A%20ISLE%20wrapper%20for%20construc.../near/548324934" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311942.20cranelift.3A.20ISLE.20wrapper.20for.20construc.2E.2E.2E.html#548324934">(Nov 01 2025 at 17:31)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/11942#issuecomment-3476585167">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11942">PR #11942</a>:</p>
<blockquote>
<p>I don't feel the best to review this so I'm going to move over to @fitzgen, but thanks for the PR @efJerryYang!</p>
<p>(sorry for the delay, we were all at the wasm CG meeting last week)</p>
</blockquote>



<a name="553504985"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311942%20cranelift%3A%20ISLE%20wrapper%20for%20construc.../near/553504985" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311942.20cranelift.3A.20ISLE.20wrapper.20for.20construc.2E.2E.2E.html#553504985">(Nov 04 2025 at 00:37)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/11942#discussion_r2488250691">PR review comment</a>:</p>
<blockquote>
<p>Here is a simple example of how the updated usage doesn't really seem to be an improvement. We are still passing the unwieldy <code>Imm64</code> type around and explicitly masking to the relevant type, the only difference is we are doing <code>const</code> instead of <code>iconst</code>.</p>
<p>For this kind of change to be an actual improvement, rather than just moving deck chairs around and being size-of-one and half-a-dozen-of-another, I think we would want to have this rule's RHS be something like this:</p>
<div class="codehilite" data-code-language="Common Lisp"><pre><span></span><code><span class="p">(</span><span class="nv">subsume</span><span class="w"> </span><span class="p">(</span><span class="nv">my_const</span><span class="w"> </span><span class="nv">ty</span><span class="w"> </span><span class="p">(</span><span class="nv">u64_wrapping_sub</span><span class="w"> </span><span class="nv">k1</span><span class="w"> </span><span class="nv">k2</span><span class="p">)))</span>
</code></pre></div>
<p>Where <code>my_const</code> is whatever the new constant constructor for integer types is called.</p>
<p>Specifically, this folds the <code>imm64_masked</code> call into the helper, which gives us two benefits over the current status quo:</p>
<ol>
<li>We are dealing with <code>u64</code> instead of <code>Imm64</code>, which is what all of the cprop intermediate computations actually use.</li>
<li>We don't need to think about type masking as much ourselves nor repeatedly pass <code>ty</code> around in multiple places.</li>
</ol>
</blockquote>



<a name="553504986"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311942%20cranelift%3A%20ISLE%20wrapper%20for%20construc.../near/553504986" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311942.20cranelift.3A.20ISLE.20wrapper.20for.20construc.2E.2E.2E.html#553504986">(Nov 04 2025 at 00:37)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/11942#discussion_r2488222657">PR review comment</a>:</p>
<blockquote>
<p>Can we avoid <code>as</code> casts here? Instead, we should use <code>.cast_[un]signed()</code> and <code>{i,u}64::try_from(...).unwrap()</code> as necessary. This makes the behavior we intend explicit.</p>
<p>If we expect that the high bits might be set, and we want to ignore them anyways, then we should explicitly mask them away via <a href="https://docs.rs/cranelift-codegen/latest/cranelift_codegen/ir/immediates/struct.Imm64.html#method.sign_extend_from_width"><code>Imm64::{zero,sign}_extend_from_width</code></a> before calling <code>i64::try_from(...).unwrap()</code> and then feeding the bits into <code>Ieee64::with_bits</code> et al.</p>
<p>Otherwise, if the high bits should never be set, then we should just use <code>i64::try_from(...).unwrap()</code> directly.</p>
</blockquote>



<a name="553504988"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311942%20cranelift%3A%20ISLE%20wrapper%20for%20construc.../near/553504988" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311942.20cranelift.3A.20ISLE.20wrapper.20for.20construc.2E.2E.2E.html#553504988">(Nov 04 2025 at 00:37)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/11942#discussion_r2488260861">PR review comment</a>:</p>
<blockquote>
<p>Probably makes sense to leave these vector rules as they were as well. Not clear to me that splatting is the best default for vectors, or if we should always take a 128-bit value and reinterpret it as the vector type, or even if we should have a default constant constructor for vector types. Either way, I think the explicit splatting in the old version was clearer here.</p>
</blockquote>



<a name="553504989"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311942%20cranelift%3A%20ISLE%20wrapper%20for%20construc.../near/553504989" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311942.20cranelift.3A.20ISLE.20wrapper.20for.20construc.2E.2E.2E.html#553504989">(Nov 04 2025 at 00:37)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11942#pullrequestreview-3413432399">PR review</a>:</p>
<blockquote>
<p>Thanks for sending this PR!</p>
<p>After looking at these changes, I'm not sure that using the same constructor for all of {ints, floats, vectors} is worth it. Some of the updated usage sites don't really seem like an improvement. It is also strange to have to create float and vector consts from <code>Imm64</code>s and such.</p>
<p>I think it would be better if we had a unified constructor for just ints and didn't try to also unify floats and vector types under that as well. See my comments below.</p>
</blockquote>



<a name="553504990"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311942%20cranelift%3A%20ISLE%20wrapper%20for%20construc.../near/553504990" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311942.20cranelift.3A.20ISLE.20wrapper.20for.20construc.2E.2E.2E.html#553504990">(Nov 04 2025 at 00:37)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/11942#discussion_r2488255657">PR review comment</a>:</p>
<blockquote>
<p>And all of the float constants can remain as <code>{f32,f64}const</code> usages because the ergonomics are better and it doesn't make sense to me why we would want a single constant constructor for both integers and floats, given that a constructor has a single type signature for all rules.</p>
</blockquote>



<a name="553727891"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311942%20cranelift%3A%20ISLE%20wrapper%20for%20construc.../near/553727891" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311942.20cranelift.3A.20ISLE.20wrapper.20for.20construc.2E.2E.2E.html#553727891">(Nov 04 2025 at 22:27)</a>:</h4>
<p>efJerryYang submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11942#pullrequestreview-3418831349">PR review</a>.</p>



<a name="553727896"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311942%20cranelift%3A%20ISLE%20wrapper%20for%20construc.../near/553727896" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311942.20cranelift.3A.20ISLE.20wrapper.20for.20construc.2E.2E.2E.html#553727896">(Nov 04 2025 at 22:27)</a>:</h4>
<p>efJerryYang created <a href="https://github.com/bytecodealliance/wasmtime/pull/11942#discussion_r2492211381">PR review comment</a>:</p>
<blockquote>
<p>Thanks for this comment! I will keep in mind to use the correct cast later when contributing to this repo, but according to what you have mentioned at the very beginning comment, we will not include the changes for float/vec, is that correct?</p>
</blockquote>



<a name="553728056"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311942%20cranelift%3A%20ISLE%20wrapper%20for%20construc.../near/553728056" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311942.20cranelift.3A.20ISLE.20wrapper.20for.20construc.2E.2E.2E.html#553728056">(Nov 04 2025 at 22:29)</a>:</h4>
<p>efJerryYang <a href="https://github.com/bytecodealliance/wasmtime/pull/11942#issuecomment-3488230233">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11942">PR #11942</a>:</p>
<blockquote>
<blockquote>
<p>Thanks for sending this PR!</p>
<p>After looking at these changes, I'm not sure that using the same constructor for all of {ints, floats, vectors} is worth it. Some of the updated usage sites don't really seem like an improvement. It is also strange to have to create float and vector consts from <code>Imm64</code>s and such.</p>
<p>I think it would be better if we had a unified constructor for just ints and didn't try to also unify floats and vector types under that as well. See my comments below.</p>
</blockquote>
<p>Thanks for your review on this @fitzgen ! Given that the purpose of #6038 is to unify the usage of different constant types, but we observed the unnecessary complexity in this PR if we include float/vec, do you think our goal will need to be changed to: replace <code>iconst</code> to some general int type or just change the <code>iconst</code> usage to allow handling different ints like you demonstrated here, to avoid working on <code>u64</code> directly?</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">(</span><span class="n">subsume</span><span class="w"> </span><span class="p">(</span><span class="n">my_const</span><span class="w"> </span><span class="n">ty</span><span class="w"> </span><span class="p">(</span><span class="n">u64_wrapping_sub</span><span class="w"> </span><span class="n">k1</span><span class="w"> </span><span class="n">k2</span><span class="p">)))</span>
</code></pre></div>
<p>I will take a closer look soon. And the description of #6038 would then be a bit misleading in this situation.</p>
</blockquote>



<a name="554389402"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311942%20cranelift%3A%20ISLE%20wrapper%20for%20construc.../near/554389402" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311942.20cranelift.3A.20ISLE.20wrapper.20for.20construc.2E.2E.2E.html#554389402">(Nov 07 2025 at 18:22)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/pull/11942#issuecomment-3504106605">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11942">PR #11942</a>:</p>
<blockquote>
<blockquote>
<p>do you think our goal will need to be changed to: replace <code>iconst</code> to some general int type or just change the <code>iconst</code> usage to allow handling different ints like you demonstrated here, to avoid working on <code>u64</code> directly?</p>
</blockquote>
<p>Yes, although I think that <code>iconst</code> itself will remain the same and we will want to define a new helper in practice. This is because we generate the constructors for all CLIF opcodes in <code>build.rs</code> and <code>iconst</code> is one of those, so it is not easy to change in practice. Easier to add a new helper that calls out to <code>iconst</code> under the covers.</p>
</blockquote>



<a name="554389600"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311942%20cranelift%3A%20ISLE%20wrapper%20for%20construc.../near/554389600" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311942.20cranelift.3A.20ISLE.20wrapper.20for.20construc.2E.2E.2E.html#554389600">(Nov 07 2025 at 18:23)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11942#pullrequestreview-3435616591">PR review</a>.</p>



<a name="554389603"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311942%20cranelift%3A%20ISLE%20wrapper%20for%20construc.../near/554389603" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311942.20cranelift.3A.20ISLE.20wrapper.20for.20construc.2E.2E.2E.html#554389603">(Nov 07 2025 at 18:23)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/11942#discussion_r2504908994">PR review comment</a>:</p>
<blockquote>
<blockquote>
<p>we will not include the changes for float/vec, is that correct?</p>
</blockquote>
<p>Correct. The review has my thoughts at a couple of different points in time, apologies for that.</p>
</blockquote>



<hr><p>Last updated: Feb 22 2026 at 11:05 UTC</p>
</html>
<html>
<head><meta charset="utf-8"><title>wasmtime / PR #12512 fix: make GLOBAL_CODE register/unreg... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312512.20fix.3A.20make.20GLOBAL_CODE.20register.2Funreg.2E.2E.2E.html">wasmtime / PR #12512 fix: make GLOBAL_CODE register/unreg...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="571797837"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312512%20fix%3A%20make%20GLOBAL_CODE%20register/unreg.../near/571797837" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312512.20fix.3A.20make.20GLOBAL_CODE.20register.2Funreg.2E.2E.2E.html#571797837">(Feb 04 2026 at 00:57)</a>:</h4>
<p>zacharywhitley opened <a href="https://github.com/bytecodealliance/wasmtime/pull/12512">PR #12512</a> from <code>tegmentum:fix/global-code-registry-idempotent</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<h2>Summary</h2>
<p>This PR makes <code>register_code</code> and <code>unregister_code</code> operations idempotent to prevent SIGABRT crashes caused by virtual address reuse in long-running processes.</p>
<p>Fixes #12511</p>
<h2>Problem</h2>
<p>When creating and destroying many <code>Engine</code> and <code>Module</code> instances, the OS can reuse virtual addresses before all <code>Arc&lt;CodeMemory&gt;</code> references are fully released. This causes:</p>
<ol>
<li>
<p><strong>Duplicate registration</strong>: New engine gets same address as old engine whose Arc hasn't been deallocated yet</p>
<ul>
<li><code>assert!(prev.is_none())</code> fails → SIGABRT</li>
</ul>
</li>
<li>
<p><strong>Double unregistration</strong>: Old Arc finally deallocates after new engine re-registered at same address</p>
<ul>
<li><code>assert!(code.is_some())</code> fails → SIGABRT</li>
</ul>
</li>
</ol>
<p>This consistently crashes after ~350-400 engine/module creations in a single process.</p>
<h2>Solution</h2>
<p>Add a <code>BTreeSet</code> to track registered addresses and check before performing operations:</p>
<ul>
<li><code>register_code</code>: Skip if address already registered</li>
<li><code>unregister_code</code>: Skip if address not registered</li>
</ul>
<p>This makes both operations safe to call multiple times with the same address.</p>
<h2>Changes</h2>
<ul>
<li>Added <code>registered_addresses()</code> function returning a static <code>RwLock&lt;BTreeSet&lt;usize&gt;&gt;</code></li>
<li>Modified <code>register_code</code> to check tracking set before inserting</li>
<li>Modified <code>unregister_code</code> to check tracking set before removing</li>
<li>Added debug logging (only in debug builds) for skipped operations</li>
</ul>
<h2>Testing</h2>
<ul>
<li>Ran stress test creating 500+ engines/modules in a loop - passes without crash</li>
<li>Full wasmtime test suite passes</li>
<li>No performance regression (BTreeSet lookup is O(log n), same as existing BTreeMap)</li>
</ul>
<h2>Impact</h2>
<p>This fix enables:</p>
<ul>
<li>JVM integrations (where <code>signals_based_traps(false)</code> is required)</li>
<li>Long-running servers dynamically loading/unloading WASM modules  </li>
<li>Large test suites with many engine/module tests</li>
<li>Any application creating 350+ engines/modules</li>
</ul>
<h2>Backward Compatibility</h2>
<ul>
<li>No API changes</li>
<li>No behavior changes for correctly behaving code</li>
<li>Only affects edge case of address reuse with deferred Arc deallocation</li>
</ul>
</blockquote>



<a name="571797839"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312512%20fix%3A%20make%20GLOBAL_CODE%20register/unreg.../near/571797839" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312512.20fix.3A.20make.20GLOBAL_CODE.20register.2Funreg.2E.2E.2E.html#571797839">(Feb 04 2026 at 00:57)</a>:</h4>
<p><strong>zacharywhitley</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/12512">PR #12512</a>.</p>



<a name="571797840"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312512%20fix%3A%20make%20GLOBAL_CODE%20register/unreg.../near/571797840" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312512.20fix.3A.20make.20GLOBAL_CODE.20register.2Funreg.2E.2E.2E.html#571797840">(Feb 04 2026 at 00:57)</a>:</h4>
<p><strong>zacharywhitley</strong> requested <a href="https://github.com/fitzgen">fitzgen</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/12512">PR #12512</a>.</p>



<a name="571797843"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312512%20fix%3A%20make%20GLOBAL_CODE%20register/unreg.../near/571797843" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312512.20fix.3A.20make.20GLOBAL_CODE.20register.2Funreg.2E.2E.2E.html#571797843">(Feb 04 2026 at 00:57)</a>:</h4>
<p><strong>zacharywhitley</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-wasi-reviewers">wasmtime-wasi-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/12512">PR #12512</a>.</p>



<a name="571797844"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312512%20fix%3A%20make%20GLOBAL_CODE%20register/unreg.../near/571797844" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312512.20fix.3A.20make.20GLOBAL_CODE.20register.2Funreg.2E.2E.2E.html#571797844">(Feb 04 2026 at 00:57)</a>:</h4>
<p><strong>zacharywhitley</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers">wasmtime-core-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/12512">PR #12512</a>.</p>



<a name="571797845"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312512%20fix%3A%20make%20GLOBAL_CODE%20register/unreg.../near/571797845" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312512.20fix.3A.20make.20GLOBAL_CODE.20register.2Funreg.2E.2E.2E.html#571797845">(Feb 04 2026 at 00:57)</a>:</h4>
<p><strong>zacharywhitley</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-default-reviewers">wasmtime-default-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/12512">PR #12512</a>.</p>



<a name="571798813"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312512%20fix%3A%20make%20GLOBAL_CODE%20register/unreg.../near/571798813" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312512.20fix.3A.20make.20GLOBAL_CODE.20register.2Funreg.2E.2E.2E.html#571798813">(Feb 04 2026 at 01:07)</a>:</h4>
<p>zacharywhitley updated <a href="https://github.com/bytecodealliance/wasmtime/pull/12512">PR #12512</a>.</p>



<a name="571801266"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312512%20fix%3A%20make%20GLOBAL_CODE%20register/unreg.../near/571801266" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312512.20fix.3A.20make.20GLOBAL_CODE.20register.2Funreg.2E.2E.2E.html#571801266">(Feb 04 2026 at 01:39)</a>:</h4>
<p>alexcrichton closed without merge <a href="https://github.com/bytecodealliance/wasmtime/pull/12512">PR #12512</a>.</p>



<a name="571801269"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312512%20fix%3A%20make%20GLOBAL_CODE%20register/unreg.../near/571801269" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312512.20fix.3A.20make.20GLOBAL_CODE.20register.2Funreg.2E.2E.2E.html#571801269">(Feb 04 2026 at 01:39)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/12512#issuecomment-3844751894">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/12512">PR #12512</a>:</p>
<blockquote>
<p>I don't believe that this fix is correct, so I'm going to close this in favor of continuing discussion on <a href="https://github.com/bytecodealliance/wasmtime/issues/12511">https://github.com/bytecodealliance/wasmtime/issues/12511</a>.</p>
</blockquote>



<hr><p>Last updated: Feb 22 2026 at 11:05 UTC</p>
</html>
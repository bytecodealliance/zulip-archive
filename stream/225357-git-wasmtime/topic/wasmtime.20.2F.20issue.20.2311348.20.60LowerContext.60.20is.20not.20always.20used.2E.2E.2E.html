<html>
<head><meta charset="utf-8"><title>wasmtime / issue #11348 `LowerContext` is not always used... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311348.20.60LowerContext.60.20is.20not.20always.20used.2E.2E.2E.html">wasmtime / issue #11348 `LowerContext` is not always used...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="531886251"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311348%20%60LowerContext%60%20is%20not%20always%20used.../near/531886251" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311348.20.60LowerContext.60.20is.20not.20always.20used.2E.2E.2E.html#531886251">(Jul 30 2025 at 16:44)</a>:</h4>
<p>alexcrichton assigned dicej to <a href="https://github.com/bytecodealliance/wasmtime/issues/11348">issue #11348</a>.</p>



<a name="531886258"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311348%20%60LowerContext%60%20is%20not%20always%20used.../near/531886258" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311348.20.60LowerContext.60.20is.20not.20always.20used.2E.2E.2E.html#531886258">(Jul 30 2025 at 16:44)</a>:</h4>
<p>alexcrichton opened <a href="https://github.com/bytecodealliance/wasmtime/issues/11348">issue #11348</a>:</p>
<blockquote>
<p>Lowering into WebAssembly may require calling the <code>realloc</code> component model abi option to allocate space for a returned list, for example. WebAssembly in async mode must always be invoked on a fiber to support suspension at any time, for example with epochs or fuel injecting yields. Currently the component-model-async implementation does not always create and use a <code>LowerContext</code> on a fiber which will result in panics that fiber-related contextual information is unavailable.</p>
<p>This was discovered in review of <a href="https://github.com/bytecodealliance/wasmtime/pull/11325">https://github.com/bytecodealliance/wasmtime/pull/11325</a> and while that has an attempted solution for futures and streams it was also discovered that the solution isn't complete. I'm opening issue to keep track of this and take notes over time as necessary. </p>
<p>I shared with @dicej a small patch:</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gh">diff --git a/crates/wasmtime/src/runtime/component/func/options.rs b/crates/wasmtime/src/runtime/component/func/options.rs</span>
<span class="gh">index 620e5a71d5..a839772824 100644</span>
<span class="gd">--- a/crates/wasmtime/src/runtime/component/func/options.rs</span>
<span class="gi">+++ b/crates/wasmtime/src/runtime/component/func/options.rs</span>
<span class="gu">@@ -241,6 +241,11 @@ impl&lt;'a, T: 'static&gt; LowerContext&lt;'a, T&gt; {</span>
<span class="w"> </span>        types: &amp;'a ComponentTypes,
<span class="w"> </span>        instance: Instance,
<span class="w"> </span>    ) -&gt; LowerContext&lt;'a, T&gt; {
<span class="gi">+        if cfg!(debug_assertions) {</span>
<span class="gi">+            if store.engine().config().async_support {</span>
<span class="gi">+                store.0.with_blocking(|_, _| {});</span>
<span class="gi">+            }</span>
<span class="gi">+        }</span>
<span class="w"> </span>        LowerContext {
<span class="w"> </span>            store,
<span class="w"> </span>            options,
</code></pre></div>
<p>which can be used to assert that <code>LowerContext</code> is created on a fiber. This currently panics many tests in the <code>component-async-tests</code> crate (and probably others). The current plan is to fix these panics then perhaps move this assertion to <code>realloc</code> instead to have a fast path where "flat" types can skip the fiber if they don't need realloc.</p>
</blockquote>



<a name="531886261"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311348%20%60LowerContext%60%20is%20not%20always%20used.../near/531886261" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311348.20.60LowerContext.60.20is.20not.20always.20used.2E.2E.2E.html#531886261">(Jul 30 2025 at 16:44)</a>:</h4>
<p><a href="https://github.com/alexcrichton">alexcrichton</a> added the wasm-proposal:component-model-async label to <a href="https://github.com/bytecodealliance/wasmtime/issues/11348">Issue #11348</a>.</p>



<a name="531947185"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311348%20%60LowerContext%60%20is%20not%20always%20used.../near/531947185" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311348.20.60LowerContext.60.20is.20not.20always.20used.2E.2E.2E.html#531947185">(Jul 30 2025 at 23:01)</a>:</h4>
<p>dicej closed <a href="https://github.com/bytecodealliance/wasmtime/issues/11348">issue #11348</a>:</p>
<blockquote>
<p>Lowering into WebAssembly may require calling the <code>realloc</code> component model abi option to allocate space for a returned list, for example. WebAssembly in async mode must always be invoked on a fiber to support suspension at any time, for example with epochs or fuel injecting yields. Currently the component-model-async implementation does not always create and use a <code>LowerContext</code> on a fiber which will result in panics that fiber-related contextual information is unavailable.</p>
<p>This was discovered in review of <a href="https://github.com/bytecodealliance/wasmtime/pull/11325">https://github.com/bytecodealliance/wasmtime/pull/11325</a> and while that has an attempted solution for futures and streams it was also discovered that the solution isn't complete. I'm opening issue to keep track of this and take notes over time as necessary. </p>
<p>I shared with @dicej a small patch:</p>
<div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gh">diff --git a/crates/wasmtime/src/runtime/component/func/options.rs b/crates/wasmtime/src/runtime/component/func/options.rs</span>
<span class="gh">index 620e5a71d5..a839772824 100644</span>
<span class="gd">--- a/crates/wasmtime/src/runtime/component/func/options.rs</span>
<span class="gi">+++ b/crates/wasmtime/src/runtime/component/func/options.rs</span>
<span class="gu">@@ -241,6 +241,11 @@ impl&lt;'a, T: 'static&gt; LowerContext&lt;'a, T&gt; {</span>
<span class="w"> </span>        types: &amp;'a ComponentTypes,
<span class="w"> </span>        instance: Instance,
<span class="w"> </span>    ) -&gt; LowerContext&lt;'a, T&gt; {
<span class="gi">+        if cfg!(debug_assertions) {</span>
<span class="gi">+            if store.engine().config().async_support {</span>
<span class="gi">+                store.0.with_blocking(|_, _| {});</span>
<span class="gi">+            }</span>
<span class="gi">+        }</span>
<span class="w"> </span>        LowerContext {
<span class="w"> </span>            store,
<span class="w"> </span>            options,
</code></pre></div>
<p>which can be used to assert that <code>LowerContext</code> is created on a fiber. This currently panics many tests in the <code>component-async-tests</code> crate (and probably others). The current plan is to fix these panics then perhaps move this assertion to <code>realloc</code> instead to have a fast path where "flat" types can skip the fiber if they don't need realloc.</p>
</blockquote>



<a name="531947188"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311348%20%60LowerContext%60%20is%20not%20always%20used.../near/531947188" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311348.20.60LowerContext.60.20is.20not.20always.20used.2E.2E.2E.html#531947188">(Jul 30 2025 at 23:01)</a>:</h4>
<p>dicej <a href="https://github.com/bytecodealliance/wasmtime/issues/11348#issuecomment-3138060124">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11348">issue #11348</a>:</p>
<blockquote>
<p>Fixed by #11353 </p>
</blockquote>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
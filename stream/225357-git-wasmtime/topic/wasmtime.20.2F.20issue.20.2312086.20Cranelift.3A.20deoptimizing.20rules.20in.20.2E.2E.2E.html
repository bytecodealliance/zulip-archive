<html>
<head><meta charset="utf-8"><title>wasmtime / issue #12086 Cranelift: deoptimizing rules in ... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312086.20Cranelift.3A.20deoptimizing.20rules.20in.20.2E.2E.2E.html">wasmtime / issue #12086 Cranelift: deoptimizing rules in ...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="560086562"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312086%20Cranelift%3A%20deoptimizing%20rules%20in%20.../near/560086562" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312086.20Cranelift.3A.20deoptimizing.20rules.20in.20.2E.2E.2E.html#560086562">(Nov 25 2025 at 07:49)</a>:</h4>
<p>bongjunj opened <a href="https://github.com/bytecodealliance/wasmtime/issues/12086">issue #12086</a>:</p>
<blockquote>
<p>Hi, this is a follow up from <a href="#narrow/channel/217117-cranelift/topic/Deoptimizing.20ISLE.20rules.3F/with/560043751">#cranelift &gt; Deoptimizing ISLE rules?</a>.</p>
<p>As mentioned in the Zulip topic above,<br>
I suspect <a href="https://github.com/bytecodealliance/wasmtime/blob/68a6afd4f925724fd359c13a27fac5a6163d12f4/cranelift/codegen/src/opts/bitops.isle#L44-L50">these ISLE rules</a> can degrade performance, since it can increase the number of instructions and thus the overall computation cost.</p>
<p>I evaluated the impact of the rule on the <a href="https://github.com/bytecodealliance/sightglass">sightglass benchmark</a>.<br>
From the main branch of cranelift, I removed the rule to instantiate <code>no-demorgan</code> version,<br>
and compared the execution and compilation performance using <code>sightglass-cli</code> in CPU cycles.<br>
The average value for 10 repetitions are presented in the table below.</p>
<p><strong>Removing the rules lowers the execution time by 22.82% and the compilation overhead by 13.34% for <code>shootout-keccak</code>, the impact of which being negligible for other cases.</strong></p>
<ul>
<li><code>speedup = (main - nodemorgan ) / nodemorgan </code></li>
<li><code>overhead = (nodemorgan - main) / main</code></li>
</ul>
<p>The rules exist for normalization, pushing <code>bnot</code> instructions down the tree and further exploiting it via other simplification rules and GVN.<br>
However, this data says the normalization is under-exploited and can degrade performance for <code>keccak</code>.</p>
<table>
<thead>
<tr>
<th>Benchmark  </th>
<th>Execution (main)</th>
<th>Execution (no-demorgan)</th>
<th>Speedup</th>
<th>Compilation (main)</th>
<th>Compilation (no-demorgan)</th>
<th>Overhead</th>
</tr>
</thead>
<tbody>
<tr>
<td>blake3-scalar</td>
<td>821,287</td>
<td>820,526</td>
<td>0.09%</td>
<td>334,025,595</td>
<td>335,494,881</td>
<td>0.44%</td>
</tr>
<tr>
<td>blake3-simd</td>
<td>904,391</td>
<td>902,968</td>
<td>0.16%</td>
<td>215,000,060</td>
<td>216,887,637</td>
<td>0.88%</td>
</tr>
<tr>
<td>bz2</td>
<td>123,375,319</td>
<td>123,972,237</td>
<td>-0.48%</td>
<td>323,600,329</td>
<td>325,059,640</td>
<td>0.45%</td>
</tr>
<tr>
<td>pulldown-cmark</td>
<td>7,527,276</td>
<td>7,528,312</td>
<td>-0.01%</td>
<td>685,357,632</td>
<td>687,241,047</td>
<td>0.27%</td>
</tr>
<tr>
<td>regex</td>
<td>287,113,532</td>
<td>287,013,209</td>
<td>0.03%</td>
<td>1,623,122,606</td>
<td>1,628,150,390</td>
<td>0.31%</td>
</tr>
<tr>
<td>shootout-ackermann</td>
<td>7,766,207</td>
<td>7,769,915</td>
<td>-0.05%</td>
<td>98,442,831</td>
<td>99,049,461</td>
<td>0.62%</td>
</tr>
<tr>
<td>shootout-base64</td>
<td>377,876,186</td>
<td>377,986,725</td>
<td>-0.03%</td>
<td>94,119,875</td>
<td>94,616,896</td>
<td>0.53%</td>
</tr>
<tr>
<td>shootout-ctype</td>
<td>796,212,604</td>
<td>796,195,661</td>
<td>0.00%</td>
<td>90,769,795</td>
<td>90,728,785</td>
<td>-0.05%</td>
</tr>
<tr>
<td>shootout-ed25519</td>
<td>11,062,252,786</td>
<td>11,041,529,973</td>
<td>0.19%</td>
<td>505,160,708</td>
<td>511,230,333</td>
<td>1.20%</td>
</tr>
<tr>
<td>shootout-fib2</td>
<td>2,991,817,344</td>
<td>2,991,783,776</td>
<td>0.00%</td>
<td>67,992,267</td>
<td>68,207,110</td>
<td>0.32%</td>
</tr>
<tr>
<td>shootout-gimli</td>
<td>5,143,297</td>
<td>5,153,384</td>
<td>-0.20%</td>
<td>5,846,157</td>
<td>5,843,358</td>
<td>-0.05%</td>
</tr>
<tr>
<td>shootout-heapsort</td>
<td>2,374,978,997</td>
<td>2,375,615,158</td>
<td>-0.03%</td>
<td>29,560,353</td>
<td>29,690,677</td>
<td>0.44%</td>
</tr>
<tr>
<td>shootout-keccak</td>
<td>48,797,823</td>
<td>39,731,401</td>
<td>22.82%</td>
<td>292,241,108</td>
<td>253,254,413</td>
<td>-13.34%</td>
</tr>
<tr>
<td>shootout-matrix</td>
<td>697,653,531</td>
<td>697,060,503</td>
<td>0.09%</td>
<td>93,389,415</td>
<td>93,786,432</td>
<td>0.43%</td>
</tr>
<tr>
<td>shootout-memmove</td>
<td>37,572,864</td>
<td>37,679,507</td>
<td>-0.28%</td>
<td>95,438,341</td>
<td>95,867,972</td>
<td>0.45%</td>
</tr>
<tr>
<td>shootout-minicsv</td>
<td>1,239,552,532</td>
<td>1,241,534,405</td>
<td>-0.16%</td>
<td>15,630,009</td>
<td>15,681,735</td>
<td>0.33%</td>
</tr>
<tr>
<td>shootout-nestedloop</td>
<td>645</td>
<td>621</td>
<td>3.93%</td>
<td>66,921,453</td>
<td>67,062,411</td>
<td>0.21%</td>
</tr>
<tr>
<td>shootout-random</td>
<td>439,552,157</td>
<td>439,582,225</td>
<td>-0.01%</td>
<td>67,809,477</td>
<td>68,091,002</td>
<td>0.42%</td>
</tr>
<tr>
<td>shootout-ratelimit</td>
<td>50,251,247</td>
<td>50,384,183</td>
<td>-0.26%</td>
<td>92,983,888</td>
<td>92,922,059</td>
<td>-0.07%</td>
</tr>
<tr>
<td>shootout-seqhash</td>
<td>15,249,759,981</td>
<td>15,255,584,809</td>
<td>-0.04%</td>
<td>126,530,505</td>
<td>127,360,907</td>
<td>0.66%</td>
</tr>
<tr>
<td>shootout-sieve</td>
<td>844,263,240</td>
<td>844,508,149</td>
<td>-0.03%</td>
<td>67,092,099</td>
<td>67,628,053</td>
<td>0.80%</td>
</tr>
<tr>
<td>shootout-switch</td>
<td>153,597,929</td>
<td>153,627,912</td>
<td>-0.02%</td>
<td>144,493,947</td>
<td>144,955,423</td>
<td>0.32%</td>
</tr>
<tr>
<td>shootout-xblabla20</td>
<td>4,924,967</td>
<td>4,926,304</td>
<td>-0.03%</td>
<td>96,463,543</td>
<td>96,976,115</td>
<td>0.53%</td>
</tr>
<tr>
<td>shootout-xchacha20</td>
<td>6,468,729</td>
<td>6,467,746</td>
<td>0.02%</td>
<td>96,534,043</td>
<td>96,825,264</td>
<td>0.30%</td>
</tr>
<tr>
<td>spidermonkey</td>
<td>742,879,491</td>
<td>744,941,257</td>
<td>-0.28%</td>
<td>23,687,766,691</td>
<td>23,749,945,287</td>
<td>0.26%</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
</blockquote>



<a name="560087066"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312086%20Cranelift%3A%20deoptimizing%20rules%20in%20.../near/560087066" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312086.20Cranelift.3A.20deoptimizing.20rules.20in.20.2E.2E.2E.html#560087066">(Nov 25 2025 at 07:53)</a>:</h4>
<p>bongjunj edited <a href="https://github.com/bytecodealliance/wasmtime/issues/12086">issue #12086</a>:</p>
<blockquote>
<p>Hi, this is a follow up from <a href="#narrow/channel/217117-cranelift/topic/Deoptimizing.20ISLE.20rules.3F/with/560043751">#cranelift &gt; Deoptimizing ISLE rules?</a>.</p>
<p>As mentioned in the Zulip topic above,<br>
I suspect <a href="https://github.com/bytecodealliance/wasmtime/blob/68a6afd4f925724fd359c13a27fac5a6163d12f4/cranelift/codegen/src/opts/bitops.isle#L44-L50">these ISLE rules</a> can degrade performance, since it can increase the number of instructions and thus the overall computation cost.</p>
<p>I evaluated the impact of the rule on the <a href="https://github.com/bytecodealliance/sightglass">sightglass benchmark</a>.<br>
From the main branch of cranelift, I removed the rule to instantiate <code>no-demorgan</code> version,<br>
and compared the execution and compilation performance using <code>sightglass-cli</code> in CPU cycles.<br>
The average value for 10 repetitions are presented in the table below.<br>
My machine is x86-64, and runs with 64-Core and 512GB memory.</p>
<p><strong>Removing the rules lowers the execution time by 22.82% and the compilation overhead by 13.34% for <code>shootout-keccak</code>, the impact of which being negligible for other cases.</strong></p>
<ul>
<li><code>speedup = (main - nodemorgan ) / nodemorgan </code></li>
<li><code>overhead = (nodemorgan - main) / main</code></li>
</ul>
<p>The rules exist for normalization, pushing <code>bnot</code> instructions down the tree and further exploiting it via other simplification rules and GVN.<br>
However, this data says the normalization is under-exploited and can degrade performance for <code>keccak</code>.</p>
<table>
<thead>
<tr>
<th>Benchmark  </th>
<th>Execution (main)</th>
<th>Execution (no-demorgan)</th>
<th>Speedup</th>
<th>Compilation (main)</th>
<th>Compilation (no-demorgan)</th>
<th>Overhead</th>
</tr>
</thead>
<tbody>
<tr>
<td>blake3-scalar</td>
<td>821,287</td>
<td>820,526</td>
<td>0.09%</td>
<td>334,025,595</td>
<td>335,494,881</td>
<td>0.44%</td>
</tr>
<tr>
<td>blake3-simd</td>
<td>904,391</td>
<td>902,968</td>
<td>0.16%</td>
<td>215,000,060</td>
<td>216,887,637</td>
<td>0.88%</td>
</tr>
<tr>
<td>bz2</td>
<td>123,375,319</td>
<td>123,972,237</td>
<td>-0.48%</td>
<td>323,600,329</td>
<td>325,059,640</td>
<td>0.45%</td>
</tr>
<tr>
<td>pulldown-cmark</td>
<td>7,527,276</td>
<td>7,528,312</td>
<td>-0.01%</td>
<td>685,357,632</td>
<td>687,241,047</td>
<td>0.27%</td>
</tr>
<tr>
<td>regex</td>
<td>287,113,532</td>
<td>287,013,209</td>
<td>0.03%</td>
<td>1,623,122,606</td>
<td>1,628,150,390</td>
<td>0.31%</td>
</tr>
<tr>
<td>shootout-ackermann</td>
<td>7,766,207</td>
<td>7,769,915</td>
<td>-0.05%</td>
<td>98,442,831</td>
<td>99,049,461</td>
<td>0.62%</td>
</tr>
<tr>
<td>shootout-base64</td>
<td>377,876,186</td>
<td>377,986,725</td>
<td>-0.03%</td>
<td>94,119,875</td>
<td>94,616,896</td>
<td>0.53%</td>
</tr>
<tr>
<td>shootout-ctype</td>
<td>796,212,604</td>
<td>796,195,661</td>
<td>0.00%</td>
<td>90,769,795</td>
<td>90,728,785</td>
<td>-0.05%</td>
</tr>
<tr>
<td>shootout-ed25519</td>
<td>11,062,252,786</td>
<td>11,041,529,973</td>
<td>0.19%</td>
<td>505,160,708</td>
<td>511,230,333</td>
<td>1.20%</td>
</tr>
<tr>
<td>shootout-fib2</td>
<td>2,991,817,344</td>
<td>2,991,783,776</td>
<td>0.00%</td>
<td>67,992,267</td>
<td>68,207,110</td>
<td>0.32%</td>
</tr>
<tr>
<td>shootout-gimli</td>
<td>5,143,297</td>
<td>5,153,384</td>
<td>-0.20%</td>
<td>5,846,157</td>
<td>5,843,358</td>
<td>-0.05%</td>
</tr>
<tr>
<td>shootout-heapsort</td>
<td>2,374,978,997</td>
<td>2,375,615,158</td>
<td>-0.03%</td>
<td>29,560,353</td>
<td>29,690,677</td>
<td>0.44%</td>
</tr>
<tr>
<td>shootout-keccak</td>
<td>48,797,823</td>
<td>39,731,401</td>
<td>22.82%</td>
<td>292,241,108</td>
<td>253,254,413</td>
<td>-13.34%</td>
</tr>
<tr>
<td>shootout-matrix</td>
<td>697,653,531</td>
<td>697,060,503</td>
<td>0.09%</td>
<td>93,389,415</td>
<td>93,786,432</td>
<td>0.43%</td>
</tr>
<tr>
<td>shootout-memmove</td>
<td>37,572,864</td>
<td>37,679,507</td>
<td>-0.28%</td>
<td>95,438,341</td>
<td>95,867,972</td>
<td>0.45%</td>
</tr>
<tr>
<td>shootout-minicsv</td>
<td>1,239,552,532</td>
<td>1,241,534,405</td>
<td>-0.16%</td>
<td>15,630,009</td>
<td>15,681,735</td>
<td>0.33%</td>
</tr>
<tr>
<td>shootout-nestedloop</td>
<td>645</td>
<td>621</td>
<td>3.93%</td>
<td>66,921,453</td>
<td>67,062,411</td>
<td>0.21%</td>
</tr>
<tr>
<td>shootout-random</td>
<td>439,552,157</td>
<td>439,582,225</td>
<td>-0.01%</td>
<td>67,809,477</td>
<td>68,091,002</td>
<td>0.42%</td>
</tr>
<tr>
<td>shootout-ratelimit</td>
<td>50,251,247</td>
<td>50,384,183</td>
<td>-0.26%</td>
<td>92,983,888</td>
<td>92,922,059</td>
<td>-0.07%</td>
</tr>
<tr>
<td>shootout-seqhash</td>
<td>15,249,759,981</td>
<td>15,255,584,809</td>
<td>-0.04%</td>
<td>126,530,505</td>
<td>127,360,907</td>
<td>0.66%</td>
</tr>
<tr>
<td>shootout-sieve</td>
<td>844,263,240</td>
<td>844,508,149</td>
<td>-0.03%</td>
<td>67,092,099</td>
<td>67,628,053</td>
<td>0.80%</td>
</tr>
<tr>
<td>shootout-switch</td>
<td>153,597,929</td>
<td>153,627,912</td>
<td>-0.02%</td>
<td>144,493,947</td>
<td>144,955,423</td>
<td>0.32%</td>
</tr>
<tr>
<td>shootout-xblabla20</td>
<td>4,924,967</td>
<td>4,926,304</td>
<td>-0.03%</td>
<td>96,463,543</td>
<td>96,976,115</td>
<td>0.53%</td>
</tr>
<tr>
<td>shootout-xchacha20</td>
<td>6,468,729</td>
<td>6,467,746</td>
<td>0.02%</td>
<td>96,534,043</td>
<td>96,825,264</td>
<td>0.30%</td>
</tr>
<tr>
<td>spidermonkey</td>
<td>742,879,491</td>
<td>744,941,257</td>
<td>-0.28%</td>
<td>23,687,766,691</td>
<td>23,749,945,287</td>
<td>0.26%</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
</blockquote>



<a name="560087087"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312086%20Cranelift%3A%20deoptimizing%20rules%20in%20.../near/560087087" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312086.20Cranelift.3A.20deoptimizing.20rules.20in.20.2E.2E.2E.html#560087087">(Nov 25 2025 at 07:53)</a>:</h4>
<p>bongjunj edited <a href="https://github.com/bytecodealliance/wasmtime/issues/12086">issue #12086</a>:</p>
<blockquote>
<p>Hi, this is a follow up from <a href="#narrow/channel/217117-cranelift/topic/Deoptimizing.20ISLE.20rules.3F/with/560043751">#cranelift &gt; Deoptimizing ISLE rules?</a>.</p>
<p>As mentioned in the Zulip topic above,<br>
I suspect <a href="https://github.com/bytecodealliance/wasmtime/blob/68a6afd4f925724fd359c13a27fac5a6163d12f4/cranelift/codegen/src/opts/bitops.isle#L44-L50">these ISLE rules</a> can degrade performance, since it can increase the number of instructions and thus the overall computation cost.</p>
<p>I evaluated the impact of the rule on the <a href="https://github.com/bytecodealliance/sightglass">sightglass benchmark</a>.<br>
From the main branch of cranelift, I removed the rule to instantiate <code>no-demorgan</code> version,<br>
and compared the execution and compilation performance using <code>sightglass-cli</code> in CPU cycles.<br>
The average value for 10 repetitions are presented in the table below.<br>
My machine is x86-64 and runs with 64-Core and 512GB memory.</p>
<p><strong>Removing the rules lowers the execution time by 22.82% and the compilation overhead by 13.34% for <code>shootout-keccak</code>, the impact of which being negligible for other cases.</strong></p>
<ul>
<li><code>speedup = (main - nodemorgan ) / nodemorgan </code></li>
<li><code>overhead = (nodemorgan - main) / main</code></li>
</ul>
<p>The rules exist for normalization, pushing <code>bnot</code> instructions down the tree and further exploiting it via other simplification rules and GVN.<br>
However, this data says the normalization is under-exploited and can degrade performance for <code>keccak</code>.</p>
<table>
<thead>
<tr>
<th>Benchmark  </th>
<th>Execution (main)</th>
<th>Execution (no-demorgan)</th>
<th>Speedup</th>
<th>Compilation (main)</th>
<th>Compilation (no-demorgan)</th>
<th>Overhead</th>
</tr>
</thead>
<tbody>
<tr>
<td>blake3-scalar</td>
<td>821,287</td>
<td>820,526</td>
<td>0.09%</td>
<td>334,025,595</td>
<td>335,494,881</td>
<td>0.44%</td>
</tr>
<tr>
<td>blake3-simd</td>
<td>904,391</td>
<td>902,968</td>
<td>0.16%</td>
<td>215,000,060</td>
<td>216,887,637</td>
<td>0.88%</td>
</tr>
<tr>
<td>bz2</td>
<td>123,375,319</td>
<td>123,972,237</td>
<td>-0.48%</td>
<td>323,600,329</td>
<td>325,059,640</td>
<td>0.45%</td>
</tr>
<tr>
<td>pulldown-cmark</td>
<td>7,527,276</td>
<td>7,528,312</td>
<td>-0.01%</td>
<td>685,357,632</td>
<td>687,241,047</td>
<td>0.27%</td>
</tr>
<tr>
<td>regex</td>
<td>287,113,532</td>
<td>287,013,209</td>
<td>0.03%</td>
<td>1,623,122,606</td>
<td>1,628,150,390</td>
<td>0.31%</td>
</tr>
<tr>
<td>shootout-ackermann</td>
<td>7,766,207</td>
<td>7,769,915</td>
<td>-0.05%</td>
<td>98,442,831</td>
<td>99,049,461</td>
<td>0.62%</td>
</tr>
<tr>
<td>shootout-base64</td>
<td>377,876,186</td>
<td>377,986,725</td>
<td>-0.03%</td>
<td>94,119,875</td>
<td>94,616,896</td>
<td>0.53%</td>
</tr>
<tr>
<td>shootout-ctype</td>
<td>796,212,604</td>
<td>796,195,661</td>
<td>0.00%</td>
<td>90,769,795</td>
<td>90,728,785</td>
<td>-0.05%</td>
</tr>
<tr>
<td>shootout-ed25519</td>
<td>11,062,252,786</td>
<td>11,041,529,973</td>
<td>0.19%</td>
<td>505,160,708</td>
<td>511,230,333</td>
<td>1.20%</td>
</tr>
<tr>
<td>shootout-fib2</td>
<td>2,991,817,344</td>
<td>2,991,783,776</td>
<td>0.00%</td>
<td>67,992,267</td>
<td>68,207,110</td>
<td>0.32%</td>
</tr>
<tr>
<td>shootout-gimli</td>
<td>5,143,297</td>
<td>5,153,384</td>
<td>-0.20%</td>
<td>5,846,157</td>
<td>5,843,358</td>
<td>-0.05%</td>
</tr>
<tr>
<td>shootout-heapsort</td>
<td>2,374,978,997</td>
<td>2,375,615,158</td>
<td>-0.03%</td>
<td>29,560,353</td>
<td>29,690,677</td>
<td>0.44%</td>
</tr>
<tr>
<td>shootout-keccak</td>
<td>48,797,823</td>
<td>39,731,401</td>
<td>22.82%</td>
<td>292,241,108</td>
<td>253,254,413</td>
<td>-13.34%</td>
</tr>
<tr>
<td>shootout-matrix</td>
<td>697,653,531</td>
<td>697,060,503</td>
<td>0.09%</td>
<td>93,389,415</td>
<td>93,786,432</td>
<td>0.43%</td>
</tr>
<tr>
<td>shootout-memmove</td>
<td>37,572,864</td>
<td>37,679,507</td>
<td>-0.28%</td>
<td>95,438,341</td>
<td>95,867,972</td>
<td>0.45%</td>
</tr>
<tr>
<td>shootout-minicsv</td>
<td>1,239,552,532</td>
<td>1,241,534,405</td>
<td>-0.16%</td>
<td>15,630,009</td>
<td>15,681,735</td>
<td>0.33%</td>
</tr>
<tr>
<td>shootout-nestedloop</td>
<td>645</td>
<td>621</td>
<td>3.93%</td>
<td>66,921,453</td>
<td>67,062,411</td>
<td>0.21%</td>
</tr>
<tr>
<td>shootout-random</td>
<td>439,552,157</td>
<td>439,582,225</td>
<td>-0.01%</td>
<td>67,809,477</td>
<td>68,091,002</td>
<td>0.42%</td>
</tr>
<tr>
<td>shootout-ratelimit</td>
<td>50,251,247</td>
<td>50,384,183</td>
<td>-0.26%</td>
<td>92,983,888</td>
<td>92,922,059</td>
<td>-0.07%</td>
</tr>
<tr>
<td>shootout-seqhash</td>
<td>15,249,759,981</td>
<td>15,255,584,809</td>
<td>-0.04%</td>
<td>126,530,505</td>
<td>127,360,907</td>
<td>0.66%</td>
</tr>
<tr>
<td>shootout-sieve</td>
<td>844,263,240</td>
<td>844,508,149</td>
<td>-0.03%</td>
<td>67,092,099</td>
<td>67,628,053</td>
<td>0.80%</td>
</tr>
<tr>
<td>shootout-switch</td>
<td>153,597,929</td>
<td>153,627,912</td>
<td>-0.02%</td>
<td>144,493,947</td>
<td>144,955,423</td>
<td>0.32%</td>
</tr>
<tr>
<td>shootout-xblabla20</td>
<td>4,924,967</td>
<td>4,926,304</td>
<td>-0.03%</td>
<td>96,463,543</td>
<td>96,976,115</td>
<td>0.53%</td>
</tr>
<tr>
<td>shootout-xchacha20</td>
<td>6,468,729</td>
<td>6,467,746</td>
<td>0.02%</td>
<td>96,534,043</td>
<td>96,825,264</td>
<td>0.30%</td>
</tr>
<tr>
<td>spidermonkey</td>
<td>742,879,491</td>
<td>744,941,257</td>
<td>-0.28%</td>
<td>23,687,766,691</td>
<td>23,749,945,287</td>
<td>0.26%</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
</blockquote>



<a name="560087096"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312086%20Cranelift%3A%20deoptimizing%20rules%20in%20.../near/560087096" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312086.20Cranelift.3A.20deoptimizing.20rules.20in.20.2E.2E.2E.html#560087096">(Nov 25 2025 at 07:53)</a>:</h4>
<p>bongjunj edited <a href="https://github.com/bytecodealliance/wasmtime/issues/12086">issue #12086</a>:</p>
<blockquote>
<p>Hi, this is a follow up from <a href="#narrow/channel/217117-cranelift/topic/Deoptimizing.20ISLE.20rules.3F/with/560043751">#cranelift &gt; Deoptimizing ISLE rules?</a>.</p>
<p>As mentioned in the Zulip topic above,<br>
I suspect <a href="https://github.com/bytecodealliance/wasmtime/blob/68a6afd4f925724fd359c13a27fac5a6163d12f4/cranelift/codegen/src/opts/bitops.isle#L44-L50">these ISLE rules</a> can degrade performance, since it can increase the number of instructions and thus the overall computation cost.</p>
<p>I evaluated the impact of the rule on the <a href="https://github.com/bytecodealliance/sightglass">sightglass benchmark</a>.<br>
From the main branch of cranelift, I removed the rule to instantiate <code>no-demorgan</code> version,<br>
and compared the execution and compilation performance using <code>sightglass-cli</code> in CPU cycles.<br>
The average value for 10 repetitions are presented in the table below.<br>
My machine is x86-64 linux and runs with 64-Core and 512GB memory.</p>
<p><strong>Removing the rules lowers the execution time by 22.82% and the compilation overhead by 13.34% for <code>shootout-keccak</code>, the impact of which being negligible for other cases.</strong></p>
<ul>
<li><code>speedup = (main - nodemorgan ) / nodemorgan </code></li>
<li><code>overhead = (nodemorgan - main) / main</code></li>
</ul>
<p>The rules exist for normalization, pushing <code>bnot</code> instructions down the tree and further exploiting it via other simplification rules and GVN.<br>
However, this data says the normalization is under-exploited and can degrade performance for <code>keccak</code>.</p>
<table>
<thead>
<tr>
<th>Benchmark  </th>
<th>Execution (main)</th>
<th>Execution (no-demorgan)</th>
<th>Speedup</th>
<th>Compilation (main)</th>
<th>Compilation (no-demorgan)</th>
<th>Overhead</th>
</tr>
</thead>
<tbody>
<tr>
<td>blake3-scalar</td>
<td>821,287</td>
<td>820,526</td>
<td>0.09%</td>
<td>334,025,595</td>
<td>335,494,881</td>
<td>0.44%</td>
</tr>
<tr>
<td>blake3-simd</td>
<td>904,391</td>
<td>902,968</td>
<td>0.16%</td>
<td>215,000,060</td>
<td>216,887,637</td>
<td>0.88%</td>
</tr>
<tr>
<td>bz2</td>
<td>123,375,319</td>
<td>123,972,237</td>
<td>-0.48%</td>
<td>323,600,329</td>
<td>325,059,640</td>
<td>0.45%</td>
</tr>
<tr>
<td>pulldown-cmark</td>
<td>7,527,276</td>
<td>7,528,312</td>
<td>-0.01%</td>
<td>685,357,632</td>
<td>687,241,047</td>
<td>0.27%</td>
</tr>
<tr>
<td>regex</td>
<td>287,113,532</td>
<td>287,013,209</td>
<td>0.03%</td>
<td>1,623,122,606</td>
<td>1,628,150,390</td>
<td>0.31%</td>
</tr>
<tr>
<td>shootout-ackermann</td>
<td>7,766,207</td>
<td>7,769,915</td>
<td>-0.05%</td>
<td>98,442,831</td>
<td>99,049,461</td>
<td>0.62%</td>
</tr>
<tr>
<td>shootout-base64</td>
<td>377,876,186</td>
<td>377,986,725</td>
<td>-0.03%</td>
<td>94,119,875</td>
<td>94,616,896</td>
<td>0.53%</td>
</tr>
<tr>
<td>shootout-ctype</td>
<td>796,212,604</td>
<td>796,195,661</td>
<td>0.00%</td>
<td>90,769,795</td>
<td>90,728,785</td>
<td>-0.05%</td>
</tr>
<tr>
<td>shootout-ed25519</td>
<td>11,062,252,786</td>
<td>11,041,529,973</td>
<td>0.19%</td>
<td>505,160,708</td>
<td>511,230,333</td>
<td>1.20%</td>
</tr>
<tr>
<td>shootout-fib2</td>
<td>2,991,817,344</td>
<td>2,991,783,776</td>
<td>0.00%</td>
<td>67,992,267</td>
<td>68,207,110</td>
<td>0.32%</td>
</tr>
<tr>
<td>shootout-gimli</td>
<td>5,143,297</td>
<td>5,153,384</td>
<td>-0.20%</td>
<td>5,846,157</td>
<td>5,843,358</td>
<td>-0.05%</td>
</tr>
<tr>
<td>shootout-heapsort</td>
<td>2,374,978,997</td>
<td>2,375,615,158</td>
<td>-0.03%</td>
<td>29,560,353</td>
<td>29,690,677</td>
<td>0.44%</td>
</tr>
<tr>
<td>shootout-keccak</td>
<td>48,797,823</td>
<td>39,731,401</td>
<td>22.82%</td>
<td>292,241,108</td>
<td>253,254,413</td>
<td>-13.34%</td>
</tr>
<tr>
<td>shootout-matrix</td>
<td>697,653,531</td>
<td>697,060,503</td>
<td>0.09%</td>
<td>93,389,415</td>
<td>93,786,432</td>
<td>0.43%</td>
</tr>
<tr>
<td>shootout-memmove</td>
<td>37,572,864</td>
<td>37,679,507</td>
<td>-0.28%</td>
<td>95,438,341</td>
<td>95,867,972</td>
<td>0.45%</td>
</tr>
<tr>
<td>shootout-minicsv</td>
<td>1,239,552,532</td>
<td>1,241,534,405</td>
<td>-0.16%</td>
<td>15,630,009</td>
<td>15,681,735</td>
<td>0.33%</td>
</tr>
<tr>
<td>shootout-nestedloop</td>
<td>645</td>
<td>621</td>
<td>3.93%</td>
<td>66,921,453</td>
<td>67,062,411</td>
<td>0.21%</td>
</tr>
<tr>
<td>shootout-random</td>
<td>439,552,157</td>
<td>439,582,225</td>
<td>-0.01%</td>
<td>67,809,477</td>
<td>68,091,002</td>
<td>0.42%</td>
</tr>
<tr>
<td>shootout-ratelimit</td>
<td>50,251,247</td>
<td>50,384,183</td>
<td>-0.26%</td>
<td>92,983,888</td>
<td>92,922,059</td>
<td>-0.07%</td>
</tr>
<tr>
<td>shootout-seqhash</td>
<td>15,249,759,981</td>
<td>15,255,584,809</td>
<td>-0.04%</td>
<td>126,530,505</td>
<td>127,360,907</td>
<td>0.66%</td>
</tr>
<tr>
<td>shootout-sieve</td>
<td>844,263,240</td>
<td>844,508,149</td>
<td>-0.03%</td>
<td>67,092,099</td>
<td>67,628,053</td>
<td>0.80%</td>
</tr>
<tr>
<td>shootout-switch</td>
<td>153,597,929</td>
<td>153,627,912</td>
<td>-0.02%</td>
<td>144,493,947</td>
<td>144,955,423</td>
<td>0.32%</td>
</tr>
<tr>
<td>shootout-xblabla20</td>
<td>4,924,967</td>
<td>4,926,304</td>
<td>-0.03%</td>
<td>96,463,543</td>
<td>96,976,115</td>
<td>0.53%</td>
</tr>
<tr>
<td>shootout-xchacha20</td>
<td>6,468,729</td>
<td>6,467,746</td>
<td>0.02%</td>
<td>96,534,043</td>
<td>96,825,264</td>
<td>0.30%</td>
</tr>
<tr>
<td>spidermonkey</td>
<td>742,879,491</td>
<td>744,941,257</td>
<td>-0.28%</td>
<td>23,687,766,691</td>
<td>23,749,945,287</td>
<td>0.26%</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
</blockquote>



<a name="560088503"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312086%20Cranelift%3A%20deoptimizing%20rules%20in%20.../near/560088503" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312086.20Cranelift.3A.20deoptimizing.20rules.20in.20.2E.2E.2E.html#560088503">(Nov 25 2025 at 08:01)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/12086#issuecomment-3574233807">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12086">issue #12086</a>:</p>
<blockquote>
<p>Thanks for this analysis!</p>
<p>I am reading the data as: small but positive impact on most benchmarks; with one large negative outlier (<code>keccak</code>) as you mention. To me that suggests some adverse impact in an inner loop; perhaps we can fix it. Would you be able to dig a bit deeper on the benchmark (e.g. by profiling and comparing the hottest basic blocks before and after) to see if you can narrow down the cause?</p>
</blockquote>



<a name="560128570"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312086%20Cranelift%3A%20deoptimizing%20rules%20in%20.../near/560128570" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312086.20Cranelift.3A.20deoptimizing.20rules.20in.20.2E.2E.2E.html#560128570">(Nov 25 2025 at 11:27)</a>:</h4>
<p>bongjunj <a href="https://github.com/bytecodealliance/wasmtime/issues/12086#issuecomment-3575184010">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12086">issue #12086</a>:</p>
<blockquote>
<p>Thanks for the suggestion! Gonna run those analysis.</p>
</blockquote>



<a name="562388793"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312086%20Cranelift%3A%20deoptimizing%20rules%20in%20.../near/562388793" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312086.20Cranelift.3A.20deoptimizing.20rules.20in.20.2E.2E.2E.html#562388793">(Dec 08 2025 at 05:22)</a>:</h4>
<p>bongjunj closed <a href="https://github.com/bytecodealliance/wasmtime/issues/12086">issue #12086</a>:</p>
<blockquote>
<p>Hi, this is a follow up from <a href="#narrow/channel/217117-cranelift/topic/Deoptimizing.20ISLE.20rules.3F/with/560043751">#cranelift &gt; Deoptimizing ISLE rules?</a>.</p>
<p>As mentioned in the Zulip topic above,<br>
I suspect <a href="https://github.com/bytecodealliance/wasmtime/blob/68a6afd4f925724fd359c13a27fac5a6163d12f4/cranelift/codegen/src/opts/bitops.isle#L44-L50">these ISLE rules</a> can degrade performance, since it can increase the number of instructions and thus the overall computation cost.</p>
<p>I evaluated the impact of the rule on the <a href="https://github.com/bytecodealliance/sightglass">sightglass benchmark</a>.<br>
From the main branch of cranelift, I removed the rule to instantiate <code>no-demorgan</code> version,<br>
and compared the execution and compilation performance using <code>sightglass-cli</code> in CPU cycles.<br>
The average value for 10 repetitions are presented in the table below.<br>
My machine is x86-64 linux and runs with 64-Core and 512GB memory.</p>
<p><strong>Removing the rules lowers the execution time by 22.82% and the compilation overhead by 13.34% for <code>shootout-keccak</code>, the impact of which being negligible for other cases.</strong></p>
<ul>
<li><code>speedup = (main - nodemorgan ) / nodemorgan </code></li>
<li><code>overhead = (nodemorgan - main) / main</code></li>
</ul>
<p>The rules exist for normalization, pushing <code>bnot</code> instructions down the tree and further exploiting it via other simplification rules and GVN.<br>
However, this data says the normalization is under-exploited and can degrade performance for <code>keccak</code>.</p>
<table>
<thead>
<tr>
<th>Benchmark  </th>
<th>Execution (main)</th>
<th>Execution (no-demorgan)</th>
<th>Speedup</th>
<th>Compilation (main)</th>
<th>Compilation (no-demorgan)</th>
<th>Overhead</th>
</tr>
</thead>
<tbody>
<tr>
<td>blake3-scalar</td>
<td>821,287</td>
<td>820,526</td>
<td>0.09%</td>
<td>334,025,595</td>
<td>335,494,881</td>
<td>0.44%</td>
</tr>
<tr>
<td>blake3-simd</td>
<td>904,391</td>
<td>902,968</td>
<td>0.16%</td>
<td>215,000,060</td>
<td>216,887,637</td>
<td>0.88%</td>
</tr>
<tr>
<td>bz2</td>
<td>123,375,319</td>
<td>123,972,237</td>
<td>-0.48%</td>
<td>323,600,329</td>
<td>325,059,640</td>
<td>0.45%</td>
</tr>
<tr>
<td>pulldown-cmark</td>
<td>7,527,276</td>
<td>7,528,312</td>
<td>-0.01%</td>
<td>685,357,632</td>
<td>687,241,047</td>
<td>0.27%</td>
</tr>
<tr>
<td>regex</td>
<td>287,113,532</td>
<td>287,013,209</td>
<td>0.03%</td>
<td>1,623,122,606</td>
<td>1,628,150,390</td>
<td>0.31%</td>
</tr>
<tr>
<td>shootout-ackermann</td>
<td>7,766,207</td>
<td>7,769,915</td>
<td>-0.05%</td>
<td>98,442,831</td>
<td>99,049,461</td>
<td>0.62%</td>
</tr>
<tr>
<td>shootout-base64</td>
<td>377,876,186</td>
<td>377,986,725</td>
<td>-0.03%</td>
<td>94,119,875</td>
<td>94,616,896</td>
<td>0.53%</td>
</tr>
<tr>
<td>shootout-ctype</td>
<td>796,212,604</td>
<td>796,195,661</td>
<td>0.00%</td>
<td>90,769,795</td>
<td>90,728,785</td>
<td>-0.05%</td>
</tr>
<tr>
<td>shootout-ed25519</td>
<td>11,062,252,786</td>
<td>11,041,529,973</td>
<td>0.19%</td>
<td>505,160,708</td>
<td>511,230,333</td>
<td>1.20%</td>
</tr>
<tr>
<td>shootout-fib2</td>
<td>2,991,817,344</td>
<td>2,991,783,776</td>
<td>0.00%</td>
<td>67,992,267</td>
<td>68,207,110</td>
<td>0.32%</td>
</tr>
<tr>
<td>shootout-gimli</td>
<td>5,143,297</td>
<td>5,153,384</td>
<td>-0.20%</td>
<td>5,846,157</td>
<td>5,843,358</td>
<td>-0.05%</td>
</tr>
<tr>
<td>shootout-heapsort</td>
<td>2,374,978,997</td>
<td>2,375,615,158</td>
<td>-0.03%</td>
<td>29,560,353</td>
<td>29,690,677</td>
<td>0.44%</td>
</tr>
<tr>
<td>shootout-keccak</td>
<td>48,797,823</td>
<td>39,731,401</td>
<td>22.82%</td>
<td>292,241,108</td>
<td>253,254,413</td>
<td>-13.34%</td>
</tr>
<tr>
<td>shootout-matrix</td>
<td>697,653,531</td>
<td>697,060,503</td>
<td>0.09%</td>
<td>93,389,415</td>
<td>93,786,432</td>
<td>0.43%</td>
</tr>
<tr>
<td>shootout-memmove</td>
<td>37,572,864</td>
<td>37,679,507</td>
<td>-0.28%</td>
<td>95,438,341</td>
<td>95,867,972</td>
<td>0.45%</td>
</tr>
<tr>
<td>shootout-minicsv</td>
<td>1,239,552,532</td>
<td>1,241,534,405</td>
<td>-0.16%</td>
<td>15,630,009</td>
<td>15,681,735</td>
<td>0.33%</td>
</tr>
<tr>
<td>shootout-nestedloop</td>
<td>645</td>
<td>621</td>
<td>3.93%</td>
<td>66,921,453</td>
<td>67,062,411</td>
<td>0.21%</td>
</tr>
<tr>
<td>shootout-random</td>
<td>439,552,157</td>
<td>439,582,225</td>
<td>-0.01%</td>
<td>67,809,477</td>
<td>68,091,002</td>
<td>0.42%</td>
</tr>
<tr>
<td>shootout-ratelimit</td>
<td>50,251,247</td>
<td>50,384,183</td>
<td>-0.26%</td>
<td>92,983,888</td>
<td>92,922,059</td>
<td>-0.07%</td>
</tr>
<tr>
<td>shootout-seqhash</td>
<td>15,249,759,981</td>
<td>15,255,584,809</td>
<td>-0.04%</td>
<td>126,530,505</td>
<td>127,360,907</td>
<td>0.66%</td>
</tr>
<tr>
<td>shootout-sieve</td>
<td>844,263,240</td>
<td>844,508,149</td>
<td>-0.03%</td>
<td>67,092,099</td>
<td>67,628,053</td>
<td>0.80%</td>
</tr>
<tr>
<td>shootout-switch</td>
<td>153,597,929</td>
<td>153,627,912</td>
<td>-0.02%</td>
<td>144,493,947</td>
<td>144,955,423</td>
<td>0.32%</td>
</tr>
<tr>
<td>shootout-xblabla20</td>
<td>4,924,967</td>
<td>4,926,304</td>
<td>-0.03%</td>
<td>96,463,543</td>
<td>96,976,115</td>
<td>0.53%</td>
</tr>
<tr>
<td>shootout-xchacha20</td>
<td>6,468,729</td>
<td>6,467,746</td>
<td>0.02%</td>
<td>96,534,043</td>
<td>96,825,264</td>
<td>0.30%</td>
</tr>
<tr>
<td>spidermonkey</td>
<td>742,879,491</td>
<td>744,941,257</td>
<td>-0.28%</td>
<td>23,687,766,691</td>
<td>23,749,945,287</td>
<td>0.26%</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
</blockquote>



<a name="562388795"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312086%20Cranelift%3A%20deoptimizing%20rules%20in%20.../near/562388795" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312086.20Cranelift.3A.20deoptimizing.20rules.20in.20.2E.2E.2E.html#562388795">(Dec 08 2025 at 05:22)</a>:</h4>
<p>bongjunj <a href="https://github.com/bytecodealliance/wasmtime/issues/12086#issuecomment-3624980931">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12086">issue #12086</a>:</p>
<blockquote>
<p><a href="https://github.com/bytecodealliance/wasmtime/pull/12127">https://github.com/bytecodealliance/wasmtime/pull/12127</a></p>
</blockquote>



<hr><p>Last updated: Feb 22 2026 at 11:05 UTC</p>
</html>
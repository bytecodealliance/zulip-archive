<html>
<head><meta charset="utf-8"><title>wasmtime / PR #11658 fix(p3-http): flaky `content-length`... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311658.20fix.28p3-http.29.3A.20flaky.20.60content-length.60.2E.2E.2E.html">wasmtime / PR #11658 fix(p3-http): flaky `content-length`...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="538484324"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311658%20fix%28p3-http%29%3A%20flaky%20%60content-length%60.../near/538484324" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311658.20fix.28p3-http.29.3A.20flaky.20.60content-length.60.2E.2E.2E.html#538484324">(Sep 09 2025 at 17:01)</a>:</h4>
<p>rvolosatovs opened <a href="https://github.com/bytecodealliance/wasmtime/pull/11658">PR #11658</a> from <code>rvolosatovs:fix/flaky-content-length-test</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>Closes #11656 </p>
</blockquote>



<a name="538484938"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311658%20fix%28p3-http%29%3A%20flaky%20%60content-length%60.../near/538484938" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311658.20fix.28p3-http.29.3A.20flaky.20.60content-length.60.2E.2E.2E.html#538484938">(Sep 09 2025 at 17:03)</a>:</h4>
<p>rvolosatovs updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11658">PR #11658</a>.</p>



<a name="538496517"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311658%20fix%28p3-http%29%3A%20flaky%20%60content-length%60.../near/538496517" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311658.20fix.28p3-http.29.3A.20flaky.20.60content-length.60.2E.2E.2E.html#538496517">(Sep 09 2025 at 17:48)</a>:</h4>
<p>rvolosatovs updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11658">PR #11658</a>.</p>



<a name="538497093"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311658%20fix%28p3-http%29%3A%20flaky%20%60content-length%60.../near/538497093" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311658.20fix.28p3-http.29.3A.20flaky.20.60content-length.60.2E.2E.2E.html#538497093">(Sep 09 2025 at 17:52)</a>:</h4>
<p>rvolosatovs updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11658">PR #11658</a>.</p>



<a name="538498361"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311658%20fix%28p3-http%29%3A%20flaky%20%60content-length%60.../near/538498361" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311658.20fix.28p3-http.29.3A.20flaky.20.60content-length.60.2E.2E.2E.html#538498361">(Sep 09 2025 at 17:59)</a>:</h4>
<p>rvolosatovs updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11658">PR #11658</a>.</p>



<a name="538500554"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311658%20fix%28p3-http%29%3A%20flaky%20%60content-length%60.../near/538500554" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311658.20fix.28p3-http.29.3A.20flaky.20.60content-length.60.2E.2E.2E.html#538500554">(Sep 09 2025 at 18:10)</a>:</h4>
<p>rvolosatovs updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11658">PR #11658</a>.</p>



<a name="538500706"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311658%20fix%28p3-http%29%3A%20flaky%20%60content-length%60.../near/538500706" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311658.20fix.28p3-http.29.3A.20flaky.20.60content-length.60.2E.2E.2E.html#538500706">(Sep 09 2025 at 18:11)</a>:</h4>
<p>rvolosatovs updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11658">PR #11658</a>.</p>



<a name="538505035"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311658%20fix%28p3-http%29%3A%20flaky%20%60content-length%60.../near/538505035" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311658.20fix.28p3-http.29.3A.20flaky.20.60content-length.60.2E.2E.2E.html#538505035">(Sep 09 2025 at 18:36)</a>:</h4>
<p>rvolosatovs updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11658">PR #11658</a>.</p>



<a name="538605789"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311658%20fix%28p3-http%29%3A%20flaky%20%60content-length%60.../near/538605789" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311658.20fix.28p3-http.29.3A.20flaky.20.60content-length.60.2E.2E.2E.html#538605789">(Sep 10 2025 at 09:33)</a>:</h4>
<p>rvolosatovs updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11658">PR #11658</a>.</p>



<a name="538608085"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311658%20fix%28p3-http%29%3A%20flaky%20%60content-length%60.../near/538608085" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311658.20fix.28p3-http.29.3A.20flaky.20.60content-length.60.2E.2E.2E.html#538608085">(Sep 10 2025 at 09:45)</a>:</h4>
<p>rvolosatovs updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11658">PR #11658</a>.</p>



<a name="538614405"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311658%20fix%28p3-http%29%3A%20flaky%20%60content-length%60.../near/538614405" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311658.20fix.28p3-http.29.3A.20flaky.20.60content-length.60.2E.2E.2E.html#538614405">(Sep 10 2025 at 10:23)</a>:</h4>
<p>rvolosatovs updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11658">PR #11658</a>.</p>



<a name="538614572"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311658%20fix%28p3-http%29%3A%20flaky%20%60content-length%60.../near/538614572" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311658.20fix.28p3-http.29.3A.20flaky.20.60content-length.60.2E.2E.2E.html#538614572">(Sep 10 2025 at 10:24)</a>:</h4>
<p>rvolosatovs edited <a href="https://github.com/bytecodealliance/wasmtime/pull/11658">PR #11658</a>:</p>
<blockquote>
<p>Closes #11656 </p>
<p>The reason for the flakiness was an issue in implementation of the test HTTP server logic - short write of the 2nd connection would <em>sometimes</em> cause an error and the 3rd connection would fail to get established, since the server would stop accepting connections.<br>
The reason for this is that there is a race condition for the "short write" case in which the client might not even have started sending the request body to the server yet when the error is caught by the consumer and consequently the I/O driver task is dropped. The cases where the body was not started to be transmitted yet would be treated as success by Hyper and so the 3rd connection would be accepted, however in the rare cases where the request body has already started being streamed, connection handling would fail server-side due to the short write, aborting the accept loop and causing "connection refused" error in the guest for the 3rd connection never triggering the <code>content-length</code> check for the 3rd case and therefore causing a panic on the <code>transmit.expect_err</code>, since from <code>wasi:http</code> perspective transmission future did not encounter errors as it has never started. To address the last part, I've also pushed <a href="https://github.com/bytecodealliance/wasmtime/pull/11658/commits/db3cbac35da23760997cf4ba44964bf7a357af26">https://github.com/bytecodealliance/wasmtime/pull/11658/commits/db3cbac35da23760997cf4ba44964bf7a357af26</a> to make sure <code>content-length</code> check happens early and even if the <code>GuestBody</code> is already dropped by the time guest is trying to write</p>
</blockquote>



<a name="538614928"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311658%20fix%28p3-http%29%3A%20flaky%20%60content-length%60.../near/538614928" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311658.20fix.28p3-http.29.3A.20flaky.20.60content-length.60.2E.2E.2E.html#538614928">(Sep 10 2025 at 10:26)</a>:</h4>
<p>rvolosatovs edited <a href="https://github.com/bytecodealliance/wasmtime/pull/11658">PR #11658</a>:</p>
<blockquote>
<p>Closes #11656 </p>
<p>We paired with @alexcrichton yesterday debugging this (thank you, @alexcrichton!) and here's the summary of what we've found out:<br>
The reason for the flakiness was an issue in implementation of the test HTTP server logic - short write of the 2nd connection would <em>sometimes</em> cause an error and the 3rd connection would fail to get established, since the server would stop accepting connections.<br>
The reason for this is that there is a race condition for the "short write" case in which the client might not even have started sending the request body to the server yet when the error is caught by the consumer and consequently the I/O driver task is dropped. The cases where the body was not started to be transmitted yet would be treated as success by Hyper and so the 3rd connection would be accepted, however in the rare cases where the request body has already started being streamed, connection handling would fail server-side due to the short write, aborting the accept loop and causing "connection refused" error in the guest for the 3rd connection never triggering the <code>content-length</code> check for the 3rd case and therefore causing a panic on the <code>transmit.expect_err</code>, since from <code>wasi:http</code> perspective transmission future did not encounter errors as it has never even began. To address the last part, I've also pushed <a href="https://github.com/bytecodealliance/wasmtime/pull/11658/commits/db3cbac35da23760997cf4ba44964bf7a357af26">https://github.com/bytecodealliance/wasmtime/pull/11658/commits/db3cbac35da23760997cf4ba44964bf7a357af26</a> to make sure <code>content-length</code> check happens early and even if the <code>GuestBody</code> is already dropped by the time guest is trying to write</p>
</blockquote>



<a name="538615357"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311658%20fix%28p3-http%29%3A%20flaky%20%60content-length%60.../near/538615357" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311658.20fix.28p3-http.29.3A.20flaky.20.60content-length.60.2E.2E.2E.html#538615357">(Sep 10 2025 at 10:29)</a>:</h4>
<p><strong>rvolosatovs</strong> has marked <a href="https://github.com/bytecodealliance/wasmtime/pull/11658">PR #11658</a> as ready for review.</p>



<a name="538615359"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311658%20fix%28p3-http%29%3A%20flaky%20%60content-length%60.../near/538615359" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311658.20fix.28p3-http.29.3A.20flaky.20.60content-length.60.2E.2E.2E.html#538615359">(Sep 10 2025 at 10:29)</a>:</h4>
<p><strong>rvolosatovs</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-wasi-reviewers">wasmtime-wasi-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/11658">PR #11658</a>.</p>



<a name="538615360"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311658%20fix%28p3-http%29%3A%20flaky%20%60content-length%60.../near/538615360" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311658.20fix.28p3-http.29.3A.20flaky.20.60content-length.60.2E.2E.2E.html#538615360">(Sep 10 2025 at 10:29)</a>:</h4>
<p><strong>rvolosatovs</strong> requested <a href="https://github.com/fitzgen">fitzgen</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/11658">PR #11658</a>.</p>



<a name="538615361"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311658%20fix%28p3-http%29%3A%20flaky%20%60content-length%60.../near/538615361" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311658.20fix.28p3-http.29.3A.20flaky.20.60content-length.60.2E.2E.2E.html#538615361">(Sep 10 2025 at 10:29)</a>:</h4>
<p><strong>rvolosatovs</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers">wasmtime-core-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/11658">PR #11658</a>.</p>



<a name="538615391"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311658%20fix%28p3-http%29%3A%20flaky%20%60content-length%60.../near/538615391" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311658.20fix.28p3-http.29.3A.20flaky.20.60content-length.60.2E.2E.2E.html#538615391">(Sep 10 2025 at 10:29)</a>:</h4>
<p><strong>rvolosatovs</strong> requested <a href="https://github.com/alexcrichton">alexcrichton</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/11658">PR #11658</a>.</p>



<a name="538615428"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311658%20fix%28p3-http%29%3A%20flaky%20%60content-length%60.../near/538615428" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311658.20fix.28p3-http.29.3A.20flaky.20.60content-length.60.2E.2E.2E.html#538615428">(Sep 10 2025 at 10:29)</a>:</h4>
<p>rvolosatovs has enabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/11658">PR #11658</a>.</p>



<a name="538623552"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311658%20fix%28p3-http%29%3A%20flaky%20%60content-length%60.../near/538623552" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311658.20fix.28p3-http.29.3A.20flaky.20.60content-length.60.2E.2E.2E.html#538623552">(Sep 10 2025 at 11:10)</a>:</h4>
<p>rvolosatovs updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11658">PR #11658</a>.</p>



<a name="538623761"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311658%20fix%28p3-http%29%3A%20flaky%20%60content-length%60.../near/538623761" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311658.20fix.28p3-http.29.3A.20flaky.20.60content-length.60.2E.2E.2E.html#538623761">(Sep 10 2025 at 11:11)</a>:</h4>
<p>rvolosatovs updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11658">PR #11658</a>.</p>



<a name="538650631"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311658%20fix%28p3-http%29%3A%20flaky%20%60content-length%60.../near/538650631" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311658.20fix.28p3-http.29.3A.20flaky.20.60content-length.60.2E.2E.2E.html#538650631">(Sep 10 2025 at 13:22)</a>:</h4>
<p>rvolosatovs updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11658">PR #11658</a>.</p>



<a name="538650916"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311658%20fix%28p3-http%29%3A%20flaky%20%60content-length%60.../near/538650916" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311658.20fix.28p3-http.29.3A.20flaky.20.60content-length.60.2E.2E.2E.html#538650916">(Sep 10 2025 at 13:24)</a>:</h4>
<p>rvolosatovs <a href="https://github.com/bytecodealliance/wasmtime/pull/11658#issuecomment-3274973122">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11658">PR #11658</a>:</p>
<blockquote>
<p>I've been working on some refactoring and addition of <code>content-length</code> validation for requests carrying bodies originating from the host as well as some refactoring, since it's all related to <code>content-length</code>, I went ahead and just pushed it to this PR to simplify review/merge process</p>
</blockquote>



<a name="538651210"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311658%20fix%28p3-http%29%3A%20flaky%20%60content-length%60.../near/538651210" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311658.20fix.28p3-http.29.3A.20flaky.20.60content-length.60.2E.2E.2E.html#538651210">(Sep 10 2025 at 13:25)</a>:</h4>
<p>rvolosatovs edited <a href="https://github.com/bytecodealliance/wasmtime/pull/11658">PR #11658</a>:</p>
<blockquote>
<p>Closes #11656 </p>
<p>We paired with @alexcrichton yesterday debugging this (thank you, @alexcrichton!) and here's the summary of what we've found out:<br>
The reason for the flakiness was an issue in implementation of the test HTTP server logic - short write of the 2nd connection would <em>sometimes</em> cause an error and the 3rd connection would fail to get established, since the server would stop accepting connections.<br>
The reason for this is that there is a race condition for the "short write" case in which the client might not even have started sending the request body to the server yet when the error is caught by the consumer and consequently the I/O driver task is dropped. The cases where the body was not started to be transmitted yet would be treated as success by Hyper and so the 3rd connection would be accepted, however in the rare cases where the request body has already started being streamed, connection handling would fail server-side due to the short write, aborting the accept loop and causing "connection refused" error in the guest for the 3rd connection never triggering the <code>content-length</code> check for the 3rd case and therefore causing a panic on the <code>transmit.expect_err</code>, since from <code>wasi:http</code> perspective transmission future did not encounter errors as it has never even began. To address the last part, I've also pushed <a href="https://github.com/bytecodealliance/wasmtime/pull/11658/commits/db3cbac35da23760997cf4ba44964bf7a357af26">https://github.com/bytecodealliance/wasmtime/pull/11658/commits/db3cbac35da23760997cf4ba44964bf7a357af26</a> to make sure <code>content-length</code> check happens early and even if the <code>GuestBody</code> is already dropped by the time guest is trying to write</p>
<p>In this PR I've also:</p>
<ul>
<li>added <code>content-length</code> validation for requests carrying bodies originating from the host</li>
<li>did some refactoring of the guest body functionality</li>
<li>added a bit more docs</li>
</ul>
</blockquote>



<a name="538653602"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311658%20fix%28p3-http%29%3A%20flaky%20%60content-length%60.../near/538653602" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311658.20fix.28p3-http.29.3A.20flaky.20.60content-length.60.2E.2E.2E.html#538653602">(Sep 10 2025 at 13:34)</a>:</h4>
<p>rvolosatovs updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11658">PR #11658</a>.</p>



<a name="538655756"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311658%20fix%28p3-http%29%3A%20flaky%20%60content-length%60.../near/538655756" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311658.20fix.28p3-http.29.3A.20flaky.20.60content-length.60.2E.2E.2E.html#538655756">(Sep 10 2025 at 13:43)</a>:</h4>
<p>rvolosatovs updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11658">PR #11658</a>.</p>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
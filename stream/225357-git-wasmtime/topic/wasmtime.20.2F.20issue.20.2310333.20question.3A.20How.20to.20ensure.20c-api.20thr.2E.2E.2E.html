<html>
<head><meta charset="utf-8"><title>wasmtime / issue #10333 question: How to ensure c-api thr... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310333.20question.3A.20How.20to.20ensure.20c-api.20thr.2E.2E.2E.html">wasmtime / issue #10333 question: How to ensure c-api thr...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="503445700"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310333%20question%3A%20How%20to%20ensure%20c-api%20thr.../near/503445700" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310333.20question.3A.20How.20to.20ensure.20c-api.20thr.2E.2E.2E.html#503445700">(Mar 05 2025 at 08:02)</a>:</h4>
<p>liupeidong0620 opened <a href="https://github.com/bytecodealliance/wasmtime/issues/10333">issue #10333</a>:</p>
<blockquote>
<h1>question</h1>
<ol>
<li>I created multiple wasm_wasmtime_plugin_t</li>
<li>Each thread runs a wasm_wasmtime_plugin_t</li>
<li>Is this thread safe?</li>
<li>The wasmtime_func_call function calls the malloc function exported by wasm. Is this thread safe?</li>
</ol>
<div class="codehilite" data-code-language="C++"><pre><span></span><code><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// Load the same wasm program and create multiple wasm_wasmtime_plugin_t instances</span>
<span class="w">    </span><span class="n">wasm_engine_t</span><span class="w">           </span><span class="o">*</span><span class="n">vm_engine</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_module_t</span><span class="w">       </span><span class="o">*</span><span class="k">module</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_store_t</span><span class="w">        </span><span class="o">*</span><span class="n">store</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_context_t</span><span class="w">      </span><span class="o">*</span><span class="n">context</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_linker_t</span><span class="w">       </span><span class="o">*</span><span class="n">linker</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_instance_t</span><span class="w">      </span><span class="n">instance</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_memory_t</span><span class="w">        </span><span class="n">memory</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">wasm_wasmtime_plugin_t</span><span class="p">;</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="p">....</span>
<span class="n">wasm_wasmtime_plugin_t</span><span class="w"> </span><span class="n">plugins</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
<span class="c1">// Load the same wasm program and create multiple wasm_wasmtime_plugin_t instances</span>

<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">6</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="w"> </span><span class="n">t</span><span class="p">([</span><span class="n">plugin_num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
<span class="w">       </span><span class="c1">//  Is it thread safe?</span>
<span class="w">        </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime_func_call</span><span class="p">(</span><span class="n">plugins</span><span class="p">[</span><span class="n">plugin_num</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">func</span><span class="p">.</span><span class="n">of</span><span class="p">.</span><span class="n">func</span><span class="p">,</span><span class="w"> </span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="n">param_num</span><span class="p">,</span><span class="w"> </span><span class="n">results</span><span class="p">,</span>
<span class="w">                               </span><span class="n">has_result</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">trap</span><span class="p">);</span>
<span class="w">    </span><span class="p">});</span>
<span class="p">}</span>
<span class="c1">// wait thread ok</span>
<span class="p">....</span>


<span class="p">}</span>
</code></pre></div>
<h1>code (wasm_wasmtime_plugin_t initialization process, specific code)</h1>
<p><div class="codehilite" data-code-language="C++"><pre><span></span><code><span class="c1">// wasmtime_vm.h</span>

<span class="cp">#pragma once</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;wasi.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;wasm.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;wasmtime.h&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">"wasm_base.h"</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">"wasm_api.h"</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string&gt;</span>

<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">wasm_engine_t</span><span class="w">           </span><span class="o">*</span><span class="n">vm_engine</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_module_t</span><span class="w">       </span><span class="o">*</span><span class="k">module</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_store_t</span><span class="w">        </span><span class="o">*</span><span class="n">store</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_context_t</span><span class="w">      </span><span class="o">*</span><span class="n">context</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_linker_t</span><span class="w">       </span><span class="o">*</span><span class="n">linker</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_instance_t</span><span class="w">      </span><span class="n">instance</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_memory_t</span><span class="w">        </span><span class="n">memory</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">wasm_wasmtime_plugin_t</span><span class="p">;</span>

<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w">                </span><span class="n">name</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_func_callback_t</span><span class="w"> </span><span class="n">cb</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int8_t</span><span class="w">                   </span><span class="n">param_num</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasm_valkind_t</span><span class="w">           </span><span class="n">param_type</span><span class="p">[</span><span class="n">MAX_WASM_API_ARG</span><span class="p">];</span>
<span class="p">}</span><span class="w"> </span><span class="n">wasm_wasmtime_host_api_t</span><span class="p">;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">WasmtimeVM</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">WasmBaseVM</span><span class="w"> </span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">WasmtimeVM</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">load</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">wasm_file</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">wasm_name</span><span class="p">);</span><span class="w"> </span><span class="c1">// load wasm and init</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">int32_t</span><span class="w"> </span><span class="nf">wasm_call</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">func_name</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">has_result</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">param_type</span><span class="p">,</span><span class="w"> </span><span class="p">...);</span><span class="w"> </span><span class="c1">// call wasm func</span>

<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">int32_t</span><span class="w"> </span><span class="nf">wasm_memory_alloc</span><span class="p">(</span><span class="kt">int32_t</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="nf">wasm_get_memory</span><span class="p">(</span><span class="kt">int32_t</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="kt">int32_t</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>

<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="o">~</span><span class="n">WasmtimeVM</span><span class="p">();</span>


<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setCtxId</span><span class="p">(</span><span class="kt">int32_t</span><span class="w"> </span><span class="n">wasm_ctx_id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">wasm_ctx_id_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasm_ctx_id</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">int32_t</span><span class="w"> </span><span class="nf">getCtxId</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">wasm_ctx_id_</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="nf">get_wasm_name</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">wasm_name_</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">int32_t</span><span class="w"> </span><span class="nf">get_wasm_id</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">id_</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">set_wasm_id</span><span class="p">(</span><span class="kt">int32_t</span><span class="w"> </span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">id_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">id</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="n">wasm_functype_t</span><span class="w"> </span><span class="o">*</span><span class="n">wasmtime_host_api_func</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">wasm_wasmtime_host_api_t</span><span class="w"> </span><span class="o">*</span><span class="n">api</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">wasmtime_report_error</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">wasmtime_error_t</span><span class="w"> </span><span class="o">*</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">wasm_trap_t</span><span class="w"> </span><span class="o">*</span><span class="n">trap</span><span class="p">);</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="nf">wasm_wasmtime_has</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">name</span><span class="p">);</span>

<span class="w">    </span><span class="n">wasm_wasmtime_plugin_t</span><span class="o">*</span><span class="w"> </span><span class="n">plugin</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int32_t</span><span class="w"> </span><span class="n">wasm_ctx_id_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">wasm_name_</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int32_t</span><span class="w"> </span><span class="n">id_</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">// wasmtime_vm.cc</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">"wasmtime_vm.h"</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span>

<span class="cp">#define DEFINE_WASM_API(NAME, ARG_CHECK) \</span>
<span class="cp">    static wasm_trap_t* wasmtime_##NAME( \</span>
<span class="cp">        void *env, \</span>
<span class="cp">        wasmtime_caller_t *caller, \</span>
<span class="cp">        const wasmtime_val_t *args, \</span>
<span class="cp">        size_t nargs, \</span>
<span class="cp">        wasmtime_val_t *results, \</span>
<span class="cp">        size_t nresults \</span>
<span class="cp">    ) { \</span>
<span class="cp">        ARG_CHECK \</span>
<span class="cp">        results[0].kind = WASMTIME_I32; \</span>
<span class="cp">        results[0].of.i32 = res; \</span>
<span class="cp">        return NULL; \</span>
<span class="cp">    }</span>
<span class="cp">#define DEFINE_WASM_NAME(NAME, ARG) \</span>
<span class="cp">    {#NAME, wasmtime_##NAME, ARG},</span>

<span class="cp">#define DEFINE_WASM_NAME_ARG_VOID \</span>
<span class="cp">    0, {}</span>
<span class="cp">#define DEFINE_WASM_API_ARG_CHECK_VOID(NAME) \</span>
<span class="cp">    int32_t res = NAME();</span>

<span class="cp">#define DEFINE_WASM_NAME_ARG_I32_1 \</span>
<span class="cp">    1, { \</span>
<span class="cp">    WASM_I32, }</span>
<span class="cp">#define DEFINE_WASM_API_ARG_CHECK_I32_1(NAME) \</span>
<span class="cp">    int32_t p0 = args[0].of.i32; \</span>
<span class="cp">    int32_t res = NAME(p0);</span>

<span class="cp">#define DEFINE_WASM_NAME_ARG_I32_2 \</span>
<span class="cp">    2, { \</span>
<span class="cp">    WASM_I32, WASM_I32, }</span>
<span class="cp">#define DEFINE_WASM_API_ARG_CHECK_I32_2(NAME) \</span>
<span class="cp">    int32_t p0 = args[0].of.i32; \</span>
<span class="cp">    int32_t p1 = args[1].of.i32; \</span>
<span class="cp">    int32_t res = NAME(p0, p1);</span>

<span class="cp">#define DEFINE_WASM_NAME_ARG_I32_3 \</span>
<span class="cp">    3, { \</span>
<span class="cp">    WASM_I32, WASM_I32, WASM_I32, }</span>
<span class="cp">#define DEFINE_WASM_API_ARG_CHECK_I32_3(NAME) \</span>
<span class="cp">    int32_t p0 = args[0].of.i32; \</span>
<span class="cp">    int32_t p1 = args[1].of.i32; \</span>
<span class="cp">    int32_t p2 = args[2].of.i32; \</span>
<span class="cp">    int32_t res = NAME(p0, p1, p2);</span>

<span class="cp">#define DEFINE_WASM_NAME_ARG_I32_4 \</span>
<span class="cp">    4, { \</span>
<span class="cp">    WASM_I32, WASM_I32, WASM_I32, WASM_I32, }</span>
<span class="cp">#define DEFINE_WASM_API_ARG_CHECK_I32_4(NAME) \</span>
<span class="cp">    int32_t p0 = args[0].of.i32; \</span>
<span class="cp">    int32_t p1 = args[1].of.i32; \</span>
<span class="cp">    int32_t p2 = args[2].of.i32; \</span>
<span class="cp">    int32_t p3 = args[3].of.i32; \</span>
<span class="cp">    int32_t res = NAME(p0, p1, p2, p3);</span>

<span class="cp">#define DEFINE_WASM_NAME_ARG_I32_5 \</span>
<span class="cp">    5, { \</span>
<span class="cp">    WASM_I32, WASM_I32, WASM_I32, WASM_I32, WASM_I32,  \</span>
<span class="cp">}</span>
<span class="cp">#define DEFINE_WASM_API_ARG_CHECK_I32_5(NAME) \</span>
<span class="cp">    int32_t p0 = args[0].of.i32; \</span>
<span class="cp">    int32_t p1 = args[1].of.i32; \</span>
<span class="cp">    int32_t p2 = args[2].of.i32; \</span>
<span class="cp">    int32_t p3 = args[3].of.i32; \</span>
<span class="cp">    int32_t p4 = args[4].of.i32; \</span>
<span class="cp">    int32_t res = NAME(p0, p1, p2, p3, p4);</span>

<span class="cp">#define DEFINE_WASM_NAME_ARG_I32_6 \</span>
<span class="cp">    6, { \</span>
<span class="cp">    WASM_I32, WASM_I32, WASM_I32, WASM_I32, WASM_I32,  \</span>
<span class="cp">    WASM_I32, }</span>
<span class="cp">#define DEFINE_WASM_API_ARG_CHECK_I32_6(NAME) \</span>
<span class="cp">    int32_t p0 = args[0].of.i32; \</span>
<span class="cp">    int32_t p1 = args[1].of.i32; \</span>
<span class="cp">    int32_t p2 = args[2].of.i32; \</span>
<span class="cp">    int32_t p3 = args[3].of.i32; \</span>
<span class="cp">    int32_t p4 = args[4].of.i32; \</span>
<span class="cp">    int32_t p5 = args[5].of.i32; \</span>
<span class="cp">    int32_t res = NAME(p0, p1, p2, p3, p4, p5);</span>

<span class="cp">#define DEFINE_WASM_NAME_ARG_I32_7 \</span>
<span class="cp">    7, { \</span>
<span class="cp">    WASM_I32, WASM_I32, WASM_I32, WASM_I32, WASM_I32,  \</span>
<span class="cp">    WASM_I32, WASM_I32, }</span>
<span class="cp">#define DEFINE_WASM_API_ARG_CHECK_I32_7(NAME) \</span>
<span class="cp">    int32_t p0 = args[0].of.i32; \</span>
<span class="cp">    int32_t p1 = args[1].of.i32; \</span>
<span class="cp">    int32_t p2 = args[2].of.i32; \</span>
<span class="cp">    int32_t p3 = args[3].of.i32; \</span>
<span class="cp">    int32_t p4 = args[4].of.i32; \</span>
<span class="cp">    int32_t p5 = args[5].of.i32; \</span>
<span class="cp">    int32_t p6 = args[6].of.i32; \</span>
<span class="cp">    int32_t res = NAME(p0, p1, p2, p3, p4, p5, p6);</span>

<span class="n">DEFINE_WASM_API</span><span class="p">(</span><span class="n">tendis_get_buffer_bytes</span><span class="p">,</span>
<span class="w">                </span><span class="n">DEFINE_WASM_API_ARG_CHECK_I32_4</span><span class="p">(</span><span class="n">tendis_get_buffer_bytes</span><span class="p">))</span>

<span class="n">DEFINE_WASM_API</span><span class="p">(</span><span class="n">tendis_set_buffer_bytes</span><span class="p">,</span>
<span class="w">                </span><span class="n">DEFINE_WASM_API_ARG_CHECK_I32_4</span><span class="p">(</span><span class="n">tendis_set_buffer_bytes</span><span class="p">))</span>


<span class="k">static</span><span class="w"> </span><span class="n">wasm_wasmtime_host_api_t</span><span class="w"> </span><span class="n">host_apis</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">DEFINE_WASM_NAME</span><span class="p">(</span><span class="n">tendis_get_buffer_bytes</span><span class="p">,</span><span class="w"> </span><span class="n">DEFINE_WASM_NAME_ARG_I32_4</span><span class="p">)</span>
<span class="w">    </span><span class="n">DEFINE_WASM_NAME</span><span class="p">(</span><span class="n">tendis_set_buffer_bytes</span><span class="p">,</span><span class="w"> </span><span class="n">DEFINE_WASM_NAME_ARG_I32_4</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="s">""</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span><span class="w"> </span><span class="n">wasmtime_val_t</span><span class="w">   </span><span class="n">param_int32</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{{</span><span class="w"> </span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WASMTIME_I32</span><span class="w"> </span><span class="p">}};</span>
<span class="k">static</span><span class="w"> </span><span class="n">wasmtime_val_t</span><span class="w">   </span><span class="n">param_int32_int32</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{{</span><span class="w"> </span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WASMTIME_I32</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WASMTIME_I32</span><span class="w"> </span><span class="p">}};</span>
<span class="k">static</span><span class="w"> </span><span class="n">wasmtime_val_t</span><span class="w">   </span><span class="n">param_int32_int32_int32</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WASMTIME_I32</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WASMTIME_I32</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WASMTIME_I32</span><span class="w"> </span><span class="p">},</span>
<span class="p">};</span>
<span class="k">static</span><span class="w"> </span><span class="n">wasmtime_val_t</span><span class="w">   </span><span class="n">param_int32_int32_int32_int32</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WASMTIME_I32</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WASMTIME_I32</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WASMTIME_I32</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WASMTIME_I32</span><span class="w"> </span><span class="p">},</span>
<span class="p">};</span>
<span class="k">static</span><span class="w"> </span><span class="n">wasmtime_val_t</span><span class="w">   </span><span class="n">param_int32_int32_int32_int32_int32</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WASMTIME_I32</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WASMTIME_I32</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WASMTIME_I32</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WASMTIME_I32</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WASMTIME_I32</span><span class="w"> </span><span class="p">},</span>
<span class="p">};</span>

<span class="n">wasm_functype_t</span><span class="w"> </span><span class="o">*</span>
<span class="nf">WasmtimeVM::wasmtime_host_api_func</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">wasm_wasmtime_host_api_t</span><span class="w"> </span><span class="o">*</span><span class="n">api</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w">                </span><span class="n">i</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasm_valtype_vec_t</span><span class="w"> </span><span class="n">param_vec</span><span class="p">,</span><span class="w"> </span><span class="n">result_vec</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasm_valtype_t</span><span class="w">    </span><span class="o">*</span><span class="n">param</span><span class="p">[</span><span class="n">MAX_WASM_API_ARG</span><span class="p">];</span>
<span class="w">    </span><span class="n">wasm_valtype_t</span><span class="w">    </span><span class="o">*</span><span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="w">    </span><span class="n">wasm_functype_t</span><span class="w">   </span><span class="o">*</span><span class="n">f</span><span class="p">;</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">api</span><span class="o">-&gt;</span><span class="n">param_num</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasm_valtype_new</span><span class="p">(</span><span class="n">api</span><span class="o">-&gt;</span><span class="n">param_type</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasm_valtype_new</span><span class="p">(</span><span class="n">WASM_I32</span><span class="p">);</span>
<span class="w">    </span><span class="n">wasm_valtype_vec_new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">param_vec</span><span class="p">,</span><span class="w"> </span><span class="n">api</span><span class="o">-&gt;</span><span class="n">param_num</span><span class="p">,</span><span class="w"> </span><span class="n">param</span><span class="p">);</span>
<span class="w">    </span><span class="n">wasm_valtype_vec_new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result_vec</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">);</span>

<span class="w">    </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasm_functype_new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">param_vec</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">result_vec</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">f</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">WasmtimeVM::wasmtime_report_error</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">message</span><span class="p">,</span>
<span class="w">    </span><span class="n">wasmtime_error_t</span><span class="w"> </span><span class="o">*</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">wasm_trap_t</span><span class="w"> </span><span class="o">*</span><span class="n">trap</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">wasm_byte_vec_t</span><span class="w"> </span><span class="n">error_message</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">wasmtime_error_message</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">error_message</span><span class="p">);</span>
<span class="w">        </span><span class="n">wasmtime_error_delete</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">wasm_trap_message</span><span class="p">(</span><span class="n">trap</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">error_message</span><span class="p">);</span>
<span class="w">        </span><span class="n">wasm_trap_delete</span><span class="p">(</span><span class="n">trap</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">error_message</span><span class="p">.</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">error_message</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasm_byte_vec_delete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">error_message</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">WasmtimeVM::load</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">bytecode</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">wasm_name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w">                        </span><span class="n">i</span><span class="p">;</span>
<span class="w">    </span><span class="kt">bool</span><span class="w">                          </span><span class="n">ok</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasm_engine_t</span><span class="w">                </span><span class="o">*</span><span class="n">vm_engine</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasm_trap_t</span><span class="w">                  </span><span class="o">*</span><span class="n">trap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_module_t</span><span class="w">            </span><span class="o">*</span><span class="k">module</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_store_t</span><span class="w">             </span><span class="o">*</span><span class="n">store</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_context_t</span><span class="w">           </span><span class="o">*</span><span class="n">context</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_linker_t</span><span class="w">            </span><span class="o">*</span><span class="n">linker</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasi_config_t</span><span class="w">                </span><span class="o">*</span><span class="n">wasi_config</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_error_t</span><span class="w">             </span><span class="o">*</span><span class="n">error</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_extern_t</span><span class="w">             </span><span class="n">item</span><span class="p">;</span>

<span class="w">    </span><span class="n">plugin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">wasm_wasmtime_plugin_t</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasm_name_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasm_name</span><span class="p">;</span>

<span class="w">    </span><span class="n">vm_engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasm_engine_new</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vm_engine</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">"failed to new engine"</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">//wasmtime_module_deserialize();</span>
<span class="w">    </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime_module_new</span><span class="p">(</span><span class="n">vm_engine</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">bytecode</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="n">bytecode</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span><span class="w"> </span><span class="o">&amp;</span><span class="k">module</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//error = wasmtime_module_deserialize(vm_engine, (const uint8_t*) bytecode.c_str(), bytecode.size(), &amp;module);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">wasmtime_report_error</span><span class="p">(</span><span class="s">"failed to new module: "</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-2</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime_store_new</span><span class="p">(</span><span class="n">vm_engine</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">store</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-3</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime_store_context</span><span class="p">(</span><span class="n">store</span><span class="p">);</span>

<span class="w">    </span><span class="n">wasi_config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasi_config_new</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">wasi_config</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-4</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">wasi_config_inherit_env</span><span class="p">(</span><span class="n">wasi_config</span><span class="p">);</span>
<span class="w">    </span><span class="n">wasi_config_inherit_stdin</span><span class="p">(</span><span class="n">wasi_config</span><span class="p">);</span>
<span class="w">    </span><span class="n">wasi_config_inherit_stdout</span><span class="p">(</span><span class="n">wasi_config</span><span class="p">);</span>
<span class="w">    </span><span class="n">wasi_config_inherit_stderr</span><span class="p">(</span><span class="n">wasi_config</span><span class="p">);</span>

<span class="w">    </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime_context_set_wasi</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">wasi_config</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">wasmtime_report_error</span><span class="p">(</span><span class="s">"failed to init</span>
<span class="p">[</span><span class="n">message</span><span class="w"> </span><span class="n">truncated</span><span class="p">]</span>
</code></pre></div><br>
</p>
</blockquote>



<a name="503469928"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310333%20question%3A%20How%20to%20ensure%20c-api%20thr.../near/503469928" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310333.20question.3A.20How.20to.20ensure.20c-api.20thr.2E.2E.2E.html#503469928">(Mar 05 2025 at 10:06)</a>:</h4>
<p>liupeidong0620 edited <a href="https://github.com/bytecodealliance/wasmtime/issues/10333">issue #10333</a>:</p>
<blockquote>
<h1>question</h1>
<ol>
<li>I created multiple wasm_wasmtime_plugin_t</li>
<li>Each thread runs a wasm_wasmtime_plugin_t</li>
<li>Is this thread safe?</li>
<li>The wasmtime_func_call function calls the malloc function exported by wasm. Is this thread safe?</li>
</ol>
<div class="codehilite" data-code-language="C++"><pre><span></span><code><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// Load the same wasm program and create multiple wasm_wasmtime_plugin_t instances</span>
<span class="w">    </span><span class="n">wasm_engine_t</span><span class="w">           </span><span class="o">*</span><span class="n">vm_engine</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_module_t</span><span class="w">       </span><span class="o">*</span><span class="k">module</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_store_t</span><span class="w">        </span><span class="o">*</span><span class="n">store</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_context_t</span><span class="w">      </span><span class="o">*</span><span class="n">context</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_linker_t</span><span class="w">       </span><span class="o">*</span><span class="n">linker</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_instance_t</span><span class="w">      </span><span class="n">instance</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_memory_t</span><span class="w">        </span><span class="n">memory</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">wasm_wasmtime_plugin_t</span><span class="p">;</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="p">....</span>
<span class="n">wasm_wasmtime_plugin_t</span><span class="w"> </span><span class="n">plugins</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
<span class="c1">// Load the same wasm program and create multiple wasm_wasmtime_plugin_t instances</span>

<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">6</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="w"> </span><span class="n">t</span><span class="p">([</span><span class="n">plugin_num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
<span class="w">       </span><span class="c1">//  Is it thread safe?</span>
<span class="w">        </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime_func_call</span><span class="p">(</span><span class="n">plugins</span><span class="p">[</span><span class="n">plugin_num</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">func</span><span class="p">.</span><span class="n">of</span><span class="p">.</span><span class="n">func</span><span class="p">,</span><span class="w"> </span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="n">param_num</span><span class="p">,</span><span class="w"> </span><span class="n">results</span><span class="p">,</span>
<span class="w">                               </span><span class="n">has_result</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">trap</span><span class="p">);</span>
<span class="w">    </span><span class="p">});</span>
<span class="p">}</span>
<span class="c1">// wait thread ok</span>
<span class="p">....</span>


<span class="p">}</span>
</code></pre></div>
<h1>code (wasm_wasmtime_plugin_t initialization process, specific code)</h1>
<p><div class="codehilite" data-code-language="C++"><pre><span></span><code><span class="c1">// wasmtime_vm.h</span>

<span class="cp">#pragma once</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;wasi.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;wasm.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;wasmtime.h&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">"wasm_base.h"</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">"wasm_api.h"</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string&gt;</span>

<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">wasm_engine_t</span><span class="w">           </span><span class="o">*</span><span class="n">vm_engine</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_module_t</span><span class="w">       </span><span class="o">*</span><span class="k">module</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_store_t</span><span class="w">        </span><span class="o">*</span><span class="n">store</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_context_t</span><span class="w">      </span><span class="o">*</span><span class="n">context</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_linker_t</span><span class="w">       </span><span class="o">*</span><span class="n">linker</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_instance_t</span><span class="w">      </span><span class="n">instance</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_memory_t</span><span class="w">        </span><span class="n">memory</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">wasm_wasmtime_plugin_t</span><span class="p">;</span>

<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w">                </span><span class="n">name</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_func_callback_t</span><span class="w"> </span><span class="n">cb</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int8_t</span><span class="w">                   </span><span class="n">param_num</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasm_valkind_t</span><span class="w">           </span><span class="n">param_type</span><span class="p">[</span><span class="n">MAX_WASM_API_ARG</span><span class="p">];</span>
<span class="p">}</span><span class="w"> </span><span class="n">wasm_wasmtime_host_api_t</span><span class="p">;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">WasmtimeVM</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">WasmBaseVM</span><span class="w"> </span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">WasmtimeVM</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">load</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">wasm_file</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">wasm_name</span><span class="p">);</span><span class="w"> </span><span class="c1">// load wasm and init</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">int32_t</span><span class="w"> </span><span class="nf">wasm_call</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">func_name</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">has_result</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">param_type</span><span class="p">,</span><span class="w"> </span><span class="p">...);</span><span class="w"> </span><span class="c1">// call wasm func</span>

<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">int32_t</span><span class="w"> </span><span class="nf">wasm_memory_alloc</span><span class="p">(</span><span class="kt">int32_t</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="nf">wasm_get_memory</span><span class="p">(</span><span class="kt">int32_t</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="kt">int32_t</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>

<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="o">~</span><span class="n">WasmtimeVM</span><span class="p">();</span>


<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setCtxId</span><span class="p">(</span><span class="kt">int32_t</span><span class="w"> </span><span class="n">wasm_ctx_id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">wasm_ctx_id_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasm_ctx_id</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">int32_t</span><span class="w"> </span><span class="nf">getCtxId</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">wasm_ctx_id_</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="nf">get_wasm_name</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">wasm_name_</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">int32_t</span><span class="w"> </span><span class="nf">get_wasm_id</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">id_</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">set_wasm_id</span><span class="p">(</span><span class="kt">int32_t</span><span class="w"> </span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">id_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">id</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="n">wasm_functype_t</span><span class="w"> </span><span class="o">*</span><span class="n">wasmtime_host_api_func</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">wasm_wasmtime_host_api_t</span><span class="w"> </span><span class="o">*</span><span class="n">api</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">wasmtime_report_error</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">wasmtime_error_t</span><span class="w"> </span><span class="o">*</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">wasm_trap_t</span><span class="w"> </span><span class="o">*</span><span class="n">trap</span><span class="p">);</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="nf">wasm_wasmtime_has</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">name</span><span class="p">);</span>

<span class="w">    </span><span class="n">wasm_wasmtime_plugin_t</span><span class="o">*</span><span class="w"> </span><span class="n">plugin</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int32_t</span><span class="w"> </span><span class="n">wasm_ctx_id_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">wasm_name_</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int32_t</span><span class="w"> </span><span class="n">id_</span><span class="p">;</span>

<span class="w">  </span><span class="n">wasmtime_val_t</span><span class="w">   </span><span class="n">param_int32</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{{</span><span class="w"> </span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WASMTIME_I32</span><span class="w"> </span><span class="p">}};</span>
<span class="w">    </span><span class="n">wasmtime_val_t</span><span class="w">   </span><span class="n">param_int32_int32</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{{</span><span class="w"> </span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WASMTIME_I32</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WASMTIME_I32</span><span class="w"> </span><span class="p">}};</span>
<span class="w">    </span><span class="n">wasmtime_val_t</span><span class="w">   </span><span class="n">param_int32_int32_int32</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WASMTIME_I32</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WASMTIME_I32</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WASMTIME_I32</span><span class="w"> </span><span class="p">},</span>
<span class="p">};</span>
<span class="w">    </span><span class="n">wasmtime_val_t</span><span class="w">   </span><span class="n">param_int32_int32_int32_int32</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WASMTIME_I32</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WASMTIME_I32</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WASMTIME_I32</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WASMTIME_I32</span><span class="w"> </span><span class="p">},</span>
<span class="p">};</span>
<span class="w">    </span><span class="n">wasmtime_val_t</span><span class="w">   </span><span class="n">param_int32_int32_int32_int32_int32</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WASMTIME_I32</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WASMTIME_I32</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WASMTIME_I32</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WASMTIME_I32</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WASMTIME_I32</span><span class="w"> </span><span class="p">},</span>
<span class="p">};</span>
<span class="p">};</span>

<span class="c1">// wasmtime_vm.cc</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">"wasmtime_vm.h"</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span>

<span class="cp">#define DEFINE_WASM_API(NAME, ARG_CHECK) \</span>
<span class="cp">    static wasm_trap_t* wasmtime_##NAME( \</span>
<span class="cp">        void *env, \</span>
<span class="cp">        wasmtime_caller_t *caller, \</span>
<span class="cp">        const wasmtime_val_t *args, \</span>
<span class="cp">        size_t nargs, \</span>
<span class="cp">        wasmtime_val_t *results, \</span>
<span class="cp">        size_t nresults \</span>
<span class="cp">    ) { \</span>
<span class="cp">        ARG_CHECK \</span>
<span class="cp">        results[0].kind = WASMTIME_I32; \</span>
<span class="cp">        results[0].of.i32 = res; \</span>
<span class="cp">        return NULL; \</span>
<span class="cp">    }</span>
<span class="cp">#define DEFINE_WASM_NAME(NAME, ARG) \</span>
<span class="cp">    {#NAME, wasmtime_##NAME, ARG},</span>

<span class="cp">#define DEFINE_WASM_NAME_ARG_VOID \</span>
<span class="cp">    0, {}</span>
<span class="cp">#define DEFINE_WASM_API_ARG_CHECK_VOID(NAME) \</span>
<span class="cp">    int32_t res = NAME();</span>

<span class="cp">#define DEFINE_WASM_NAME_ARG_I32_1 \</span>
<span class="cp">    1, { \</span>
<span class="cp">    WASM_I32, }</span>
<span class="cp">#define DEFINE_WASM_API_ARG_CHECK_I32_1(NAME) \</span>
<span class="cp">    int32_t p0 = args[0].of.i32; \</span>
<span class="cp">    int32_t res = NAME(p0);</span>

<span class="cp">#define DEFINE_WASM_NAME_ARG_I32_2 \</span>
<span class="cp">    2, { \</span>
<span class="cp">    WASM_I32, WASM_I32, }</span>
<span class="cp">#define DEFINE_WASM_API_ARG_CHECK_I32_2(NAME) \</span>
<span class="cp">    int32_t p0 = args[0].of.i32; \</span>
<span class="cp">    int32_t p1 = args[1].of.i32; \</span>
<span class="cp">    int32_t res = NAME(p0, p1);</span>

<span class="cp">#define DEFINE_WASM_NAME_ARG_I32_3 \</span>
<span class="cp">    3, { \</span>
<span class="cp">    WASM_I32, WASM_I32, WASM_I32, }</span>
<span class="cp">#define DEFINE_WASM_API_ARG_CHECK_I32_3(NAME) \</span>
<span class="cp">    int32_t p0 = args[0].of.i32; \</span>
<span class="cp">    int32_t p1 = args[1].of.i32; \</span>
<span class="cp">    int32_t p2 = args[2].of.i32; \</span>
<span class="cp">    int32_t res = NAME(p0, p1, p2);</span>

<span class="cp">#define DEFINE_WASM_NAME_ARG_I32_4 \</span>
<span class="cp">    4, { \</span>
<span class="cp">    WASM_I32, WASM_I32, WASM_I32, WASM_I32, }</span>
<span class="cp">#define DEFINE_WASM_API_ARG_CHECK_I32_4(NAME) \</span>
<span class="cp">    int32_t p0 = args[0].of.i32; \</span>
<span class="cp">    int32_t p1 = args[1].of.i32; \</span>
<span class="cp">    int32_t p2 = args[2].of.i32; \</span>
<span class="cp">    int32_t p3 = args[3].of.i32; \</span>
<span class="cp">    int32_t res = NAME(p0, p1, p2, p3);</span>

<span class="cp">#define DEFINE_WASM_NAME_ARG_I32_5 \</span>
<span class="cp">    5, { \</span>
<span class="cp">    WASM_I32, WASM_I32, WASM_I32, WASM_I32, WASM_I32,  \</span>
<span class="cp">}</span>
<span class="cp">#define DEFINE_WASM_API_ARG_CHECK_I32_5(NAME) \</span>
<span class="cp">    int32_t p0 = args[0].of.i32; \</span>
<span class="cp">    int32_t p1 = args[1].of.i32; \</span>
<span class="cp">    int32_t p2 = args[2].of.i32; \</span>
<span class="cp">    int32_t p3 = args[3].of.i32; \</span>
<span class="cp">    int32_t p4 = args[4].of.i32; \</span>
<span class="cp">    int32_t res = NAME(p0, p1, p2, p3, p4);</span>

<span class="cp">#define DEFINE_WASM_NAME_ARG_I32_6 \</span>
<span class="cp">    6, { \</span>
<span class="cp">    WASM_I32, WASM_I32, WASM_I32, WASM_I32, WASM_I32,  \</span>
<span class="cp">    WASM_I32, }</span>
<span class="cp">#define DEFINE_WASM_API_ARG_CHECK_I32_6(NAME) \</span>
<span class="cp">    int32_t p0 = args[0].of.i32; \</span>
<span class="cp">    int32_t p1 = args[1].of.i32; \</span>
<span class="cp">    int32_t p2 = args[2].of.i32; \</span>
<span class="cp">    int32_t p3 = args[3].of.i32; \</span>
<span class="cp">    int32_t p4 = args[4].of.i32; \</span>
<span class="cp">    int32_t p5 = args[5].of.i32; \</span>
<span class="cp">    int32_t res = NAME(p0, p1, p2, p3, p4, p5);</span>

<span class="cp">#define DEFINE_WASM_NAME_ARG_I32_7 \</span>
<span class="cp">    7, { \</span>
<span class="cp">    WASM_I32, WASM_I32, WASM_I32, WASM_I32, WASM_I32,  \</span>
<span class="cp">    WASM_I32, WASM_I32, }</span>
<span class="cp">#define DEFINE_WASM_API_ARG_CHECK_I32_7(NAME) \</span>
<span class="cp">    int32_t p0 = args[0].of.i32; \</span>
<span class="cp">    int32_t p1 = args[1].of.i32; \</span>
<span class="cp">    int32_t p2 = args[2].of.i32; \</span>
<span class="cp">    int32_t p3 = args[3].of.i32; \</span>
<span class="cp">    int32_t p4 = args[4].of.i32; \</span>
<span class="cp">    int32_t p5 = args[5].of.i32; \</span>
<span class="cp">    int32_t p6 = args[6].of.i32; \</span>
<span class="cp">    int32_t res = NAME(p0, p1, p2, p3, p4, p5, p6);</span>

<span class="n">DEFINE_WASM_API</span><span class="p">(</span><span class="n">tendis_get_buffer_bytes</span><span class="p">,</span>
<span class="w">                </span><span class="n">DEFINE_WASM_API_ARG_CHECK_I32_4</span><span class="p">(</span><span class="n">tendis_get_buffer_bytes</span><span class="p">))</span>

<span class="n">DEFINE_WASM_API</span><span class="p">(</span><span class="n">tendis_set_buffer_bytes</span><span class="p">,</span>
<span class="w">                </span><span class="n">DEFINE_WASM_API_ARG_CHECK_I32_4</span><span class="p">(</span><span class="n">tendis_set_buffer_bytes</span><span class="p">))</span>


<span class="k">static</span><span class="w"> </span><span class="n">wasm_wasmtime_host_api_t</span><span class="w"> </span><span class="n">host_apis</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">DEFINE_WASM_NAME</span><span class="p">(</span><span class="n">tendis_get_buffer_bytes</span><span class="p">,</span><span class="w"> </span><span class="n">DEFINE_WASM_NAME_ARG_I32_4</span><span class="p">)</span>
<span class="w">    </span><span class="n">DEFINE_WASM_NAME</span><span class="p">(</span><span class="n">tendis_set_buffer_bytes</span><span class="p">,</span><span class="w"> </span><span class="n">DEFINE_WASM_NAME_ARG_I32_4</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="s">""</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="p">}</span>
<span class="p">};</span>

<span class="n">wasm_functype_t</span><span class="w"> </span><span class="o">*</span>
<span class="nf">WasmtimeVM::wasmtime_host_api_func</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">wasm_wasmtime_host_api_t</span><span class="w"> </span><span class="o">*</span><span class="n">api</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w">                </span><span class="n">i</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasm_valtype_vec_t</span><span class="w"> </span><span class="n">param_vec</span><span class="p">,</span><span class="w"> </span><span class="n">result_vec</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasm_valtype_t</span><span class="w">    </span><span class="o">*</span><span class="n">param</span><span class="p">[</span><span class="n">MAX_WASM_API_ARG</span><span class="p">];</span>
<span class="w">    </span><span class="n">wasm_valtype_t</span><span class="w">    </span><span class="o">*</span><span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="w">    </span><span class="n">wasm_functype_t</span><span class="w">   </span><span class="o">*</span><span class="n">f</span><span class="p">;</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">api</span><span class="o">-&gt;</span><span class="n">param_num</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasm_valtype_new</span><span class="p">(</span><span class="n">api</span><span class="o">-&gt;</span><span class="n">param_type</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasm_valtype_new</span><span class="p">(</span><span class="n">WASM_I32</span><span class="p">);</span>
<span class="w">    </span><span class="n">wasm_valtype_vec_new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">param_vec</span><span class="p">,</span><span class="w"> </span><span class="n">api</span><span class="o">-&gt;</span><span class="n">param_num</span><span class="p">,</span><span class="w"> </span><span class="n">param</span><span class="p">);</span>
<span class="w">    </span><span class="n">wasm_valtype_vec_new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result_vec</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">);</span>

<span class="w">    </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasm_functype_new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">param_vec</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">result_vec</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">f</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">WasmtimeVM::wasmtime_report_error</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">message</span><span class="p">,</span>
<span class="w">    </span><span class="n">wasmtime_error_t</span><span class="w"> </span><span class="o">*</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">wasm_trap_t</span><span class="w"> </span><span class="o">*</span><span class="n">trap</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">wasm_byte_vec_t</span><span class="w"> </span><span class="n">error_message</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">wasmtime_error_message</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">error_message</span><span class="p">);</span>
<span class="w">        </span><span class="n">wasmtime_error_delete</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">wasm_trap_message</span><span class="p">(</span><span class="n">trap</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">error_message</span><span class="p">);</span>
<span class="w">        </span><span class="n">wasm_trap_delete</span><span class="p">(</span><span class="n">trap</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">error_message</span><span class="p">.</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">error_message</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasm_byte_vec_delete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">error_message</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">WasmtimeVM::load</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">bytecode</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">wasm_name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w">                        </span><span class="n">i</span><span class="p">;</span>
<span class="w">    </span><span class="kt">bool</span><span class="w">                          </span><span class="n">ok</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasm_engine_t</span><span class="w">                </span><span class="o">*</span><span class="n">vm_engine</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasm_trap_t</span><span class="w">                  </span><span class="o">*</span><span class="n">trap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_module_t</span><span class="w">            </span><span class="o">*</span><span class="k">module</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_store_t</span><span class="w">             </span><span class="o">*</span><span class="n">store</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_context_t</span><span class="w">           </span><span class="o">*</span><span class="n">context</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_linker_t</span><span class="w">            </span><span class="o">*</span><span class="n">linker</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasi_config_t</span><span class="w">                </span><span class="o">*</span><span class="n">wasi_config</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_error_t</span><span class="w">             </span><span class="o">*</span><span class="n">error</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_extern_t</span><span class="w">             </span><span class="n">item</span><span class="p">;</span>

<span class="w">    </span><span class="n">plugin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">wasm_wasmtime_plugin_t</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasm_name_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasm_name</span><span class="p">;</span>

<span class="w">    </span><span class="n">vm_engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasm_engine_new</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vm_engine</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">"failed to new engine"</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">//wasmtime_module_deserialize();</span>
<span class="w">    </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime_module_new</span><span class="p">(</span><span class="n">vm_engine</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">bytecode</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="n">bytecode</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span><span class="w"> </span><span class="o">&amp;</span><span class="k">module</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//error = wasmtime_module_deserialize(vm_engine, (const uint8_t*) bytecode.c_str(), bytecode.size(), &amp;module);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">wasmtime_report_error</span><span class="p">(</span><span class="s">"failed to new module: "</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-2</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime_store_new</span><span class="p">(</span><span class="n">vm_engine</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">store</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-3</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime_store_context</span><span class="p">(</span><span class="n">store</span><span class="p">);</span>

<span class="w">    </span><span class="n">wasi_config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasi_config_new</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">wasi_config</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-4</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">wasi_config_inherit_env</span><span class="p">(</span><span class="n">wasi_config</span><span class="p">);</span>
<span class="w">    </span><span class="n">wasi_config_inherit_stdin</span><span class="p">(</span><span class="n">wasi_config</span><span class="p">);</span>
<span class="w">    </span><span class="n">wasi_config_inherit_stdout</span><span class="p">(</span><span class="n">wasi_config</span><span class="p">);</span>
<span class="w">    </span><span class="n">wasi_config_inherit_stderr</span><span class="p">(</span><span class="n">wasi_config</span><span class="p">);</span>

<span class="w">    </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime_context_set_wasi</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">wasi_config</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">wasmtime_report_error</span><span class="p">(</span><span class="s">"failed to init WASI: "</span><span class="p">,</span><span class="w"> </span><span class="n">err</span>
<span class="p">[</span><span class="n">message</span><span class="w"> </span><span class="n">truncated</span><span class="p">]</span>
</code></pre></div><br>
</p>
</blockquote>



<a name="503548715"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310333%20question%3A%20How%20to%20ensure%20c-api%20thr.../near/503548715" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310333.20question.3A.20How.20to.20ensure.20c-api.20thr.2E.2E.2E.html#503548715">(Mar 05 2025 at 15:28)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/10333#issuecomment-2701277687">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10333">issue #10333</a>:</p>
<blockquote>
<p>When it comes to thread safety and the C/C++ API (and/or C/C++ in general) you're sort of in the wild west where you'll have to start from basics and build everything up yourself. There is <a href="https://docs.wasmtime.dev/c-api/wasmtime_8h.html">basic documentation</a> of thread safety in the C API and you can also browse the <a href="https://docs.rs/wasmtime/latest/wasmtime/">Rust API documentation</a> to better understand thread safety.</p>
<p>tl;dr; "engine" is threadsafe, "store", and everything that refers to it, must only be used in one thread at a time. Your example at the top is only safe so long as nothing else on the main thread uses the store while it's in use by a child thread.</p>
</blockquote>



<a name="503672779"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310333%20question%3A%20How%20to%20ensure%20c-api%20thr.../near/503672779" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310333.20question.3A.20How.20to.20ensure.20c-api.20thr.2E.2E.2E.html#503672779">(Mar 06 2025 at 01:35)</a>:</h4>
<p>liupeidong0620 closed <a href="https://github.com/bytecodealliance/wasmtime/issues/10333">issue #10333</a>:</p>
<blockquote>
<h1>question</h1>
<ol>
<li>I created multiple wasm_wasmtime_plugin_t</li>
<li>Each thread runs a wasm_wasmtime_plugin_t</li>
<li>Is this thread safe?</li>
<li>The wasmtime_func_call function calls the malloc function exported by wasm. Is this thread safe?</li>
</ol>
<div class="codehilite" data-code-language="C++"><pre><span></span><code><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// Load the same wasm program and create multiple wasm_wasmtime_plugin_t instances</span>
<span class="w">    </span><span class="n">wasm_engine_t</span><span class="w">           </span><span class="o">*</span><span class="n">vm_engine</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_module_t</span><span class="w">       </span><span class="o">*</span><span class="k">module</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_store_t</span><span class="w">        </span><span class="o">*</span><span class="n">store</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_context_t</span><span class="w">      </span><span class="o">*</span><span class="n">context</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_linker_t</span><span class="w">       </span><span class="o">*</span><span class="n">linker</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_instance_t</span><span class="w">      </span><span class="n">instance</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_memory_t</span><span class="w">        </span><span class="n">memory</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">wasm_wasmtime_plugin_t</span><span class="p">;</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="p">....</span>
<span class="n">wasm_wasmtime_plugin_t</span><span class="w"> </span><span class="n">plugins</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
<span class="c1">// Load the same wasm program and create multiple wasm_wasmtime_plugin_t instances</span>

<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">6</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="w"> </span><span class="n">t</span><span class="p">([</span><span class="n">plugin_num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
<span class="w">       </span><span class="c1">//  Is it thread safe?</span>
<span class="w">        </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime_func_call</span><span class="p">(</span><span class="n">plugins</span><span class="p">[</span><span class="n">plugin_num</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">func</span><span class="p">.</span><span class="n">of</span><span class="p">.</span><span class="n">func</span><span class="p">,</span><span class="w"> </span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="n">param_num</span><span class="p">,</span><span class="w"> </span><span class="n">results</span><span class="p">,</span>
<span class="w">                               </span><span class="n">has_result</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">trap</span><span class="p">);</span>
<span class="w">    </span><span class="p">});</span>
<span class="p">}</span>
<span class="c1">// wait thread ok</span>
<span class="p">....</span>


<span class="p">}</span>
</code></pre></div>
<h1>code (wasm_wasmtime_plugin_t initialization process, specific code)</h1>
<p><div class="codehilite" data-code-language="C++"><pre><span></span><code><span class="c1">// wasmtime_vm.h</span>

<span class="cp">#pragma once</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;wasi.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;wasm.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;wasmtime.h&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">"wasm_base.h"</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">"wasm_api.h"</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string&gt;</span>

<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">wasm_engine_t</span><span class="w">           </span><span class="o">*</span><span class="n">vm_engine</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_module_t</span><span class="w">       </span><span class="o">*</span><span class="k">module</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_store_t</span><span class="w">        </span><span class="o">*</span><span class="n">store</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_context_t</span><span class="w">      </span><span class="o">*</span><span class="n">context</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_linker_t</span><span class="w">       </span><span class="o">*</span><span class="n">linker</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_instance_t</span><span class="w">      </span><span class="n">instance</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_memory_t</span><span class="w">        </span><span class="n">memory</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">wasm_wasmtime_plugin_t</span><span class="p">;</span>

<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w">                </span><span class="n">name</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_func_callback_t</span><span class="w"> </span><span class="n">cb</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int8_t</span><span class="w">                   </span><span class="n">param_num</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasm_valkind_t</span><span class="w">           </span><span class="n">param_type</span><span class="p">[</span><span class="n">MAX_WASM_API_ARG</span><span class="p">];</span>
<span class="p">}</span><span class="w"> </span><span class="n">wasm_wasmtime_host_api_t</span><span class="p">;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">WasmtimeVM</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">WasmBaseVM</span><span class="w"> </span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">WasmtimeVM</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">load</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">wasm_file</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">wasm_name</span><span class="p">);</span><span class="w"> </span><span class="c1">// load wasm and init</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">int32_t</span><span class="w"> </span><span class="nf">wasm_call</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">func_name</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">has_result</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">param_type</span><span class="p">,</span><span class="w"> </span><span class="p">...);</span><span class="w"> </span><span class="c1">// call wasm func</span>

<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">int32_t</span><span class="w"> </span><span class="nf">wasm_memory_alloc</span><span class="p">(</span><span class="kt">int32_t</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="nf">wasm_get_memory</span><span class="p">(</span><span class="kt">int32_t</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="kt">int32_t</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>

<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="o">~</span><span class="n">WasmtimeVM</span><span class="p">();</span>


<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setCtxId</span><span class="p">(</span><span class="kt">int32_t</span><span class="w"> </span><span class="n">wasm_ctx_id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">wasm_ctx_id_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasm_ctx_id</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">int32_t</span><span class="w"> </span><span class="nf">getCtxId</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">wasm_ctx_id_</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="nf">get_wasm_name</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">wasm_name_</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">int32_t</span><span class="w"> </span><span class="nf">get_wasm_id</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">id_</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">set_wasm_id</span><span class="p">(</span><span class="kt">int32_t</span><span class="w"> </span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">id_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">id</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="n">wasm_functype_t</span><span class="w"> </span><span class="o">*</span><span class="n">wasmtime_host_api_func</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">wasm_wasmtime_host_api_t</span><span class="w"> </span><span class="o">*</span><span class="n">api</span><span class="p">);</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">wasmtime_report_error</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">wasmtime_error_t</span><span class="w"> </span><span class="o">*</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">wasm_trap_t</span><span class="w"> </span><span class="o">*</span><span class="n">trap</span><span class="p">);</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="nf">wasm_wasmtime_has</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">name</span><span class="p">);</span>

<span class="w">    </span><span class="n">wasm_wasmtime_plugin_t</span><span class="o">*</span><span class="w"> </span><span class="n">plugin</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int32_t</span><span class="w"> </span><span class="n">wasm_ctx_id_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">wasm_name_</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int32_t</span><span class="w"> </span><span class="n">id_</span><span class="p">;</span>

<span class="w">  </span><span class="n">wasmtime_val_t</span><span class="w">   </span><span class="n">param_int32</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{{</span><span class="w"> </span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WASMTIME_I32</span><span class="w"> </span><span class="p">}};</span>
<span class="w">    </span><span class="n">wasmtime_val_t</span><span class="w">   </span><span class="n">param_int32_int32</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{{</span><span class="w"> </span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WASMTIME_I32</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WASMTIME_I32</span><span class="w"> </span><span class="p">}};</span>
<span class="w">    </span><span class="n">wasmtime_val_t</span><span class="w">   </span><span class="n">param_int32_int32_int32</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WASMTIME_I32</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WASMTIME_I32</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WASMTIME_I32</span><span class="w"> </span><span class="p">},</span>
<span class="p">};</span>
<span class="w">    </span><span class="n">wasmtime_val_t</span><span class="w">   </span><span class="n">param_int32_int32_int32_int32</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WASMTIME_I32</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WASMTIME_I32</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WASMTIME_I32</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WASMTIME_I32</span><span class="w"> </span><span class="p">},</span>
<span class="p">};</span>
<span class="w">    </span><span class="n">wasmtime_val_t</span><span class="w">   </span><span class="n">param_int32_int32_int32_int32_int32</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WASMTIME_I32</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WASMTIME_I32</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WASMTIME_I32</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WASMTIME_I32</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">kind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WASMTIME_I32</span><span class="w"> </span><span class="p">},</span>
<span class="p">};</span>
<span class="p">};</span>

<span class="c1">// wasmtime_vm.cc</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">"wasmtime_vm.h"</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span>

<span class="cp">#define DEFINE_WASM_API(NAME, ARG_CHECK) \</span>
<span class="cp">    static wasm_trap_t* wasmtime_##NAME( \</span>
<span class="cp">        void *env, \</span>
<span class="cp">        wasmtime_caller_t *caller, \</span>
<span class="cp">        const wasmtime_val_t *args, \</span>
<span class="cp">        size_t nargs, \</span>
<span class="cp">        wasmtime_val_t *results, \</span>
<span class="cp">        size_t nresults \</span>
<span class="cp">    ) { \</span>
<span class="cp">        ARG_CHECK \</span>
<span class="cp">        results[0].kind = WASMTIME_I32; \</span>
<span class="cp">        results[0].of.i32 = res; \</span>
<span class="cp">        return NULL; \</span>
<span class="cp">    }</span>
<span class="cp">#define DEFINE_WASM_NAME(NAME, ARG) \</span>
<span class="cp">    {#NAME, wasmtime_##NAME, ARG},</span>

<span class="cp">#define DEFINE_WASM_NAME_ARG_VOID \</span>
<span class="cp">    0, {}</span>
<span class="cp">#define DEFINE_WASM_API_ARG_CHECK_VOID(NAME) \</span>
<span class="cp">    int32_t res = NAME();</span>

<span class="cp">#define DEFINE_WASM_NAME_ARG_I32_1 \</span>
<span class="cp">    1, { \</span>
<span class="cp">    WASM_I32, }</span>
<span class="cp">#define DEFINE_WASM_API_ARG_CHECK_I32_1(NAME) \</span>
<span class="cp">    int32_t p0 = args[0].of.i32; \</span>
<span class="cp">    int32_t res = NAME(p0);</span>

<span class="cp">#define DEFINE_WASM_NAME_ARG_I32_2 \</span>
<span class="cp">    2, { \</span>
<span class="cp">    WASM_I32, WASM_I32, }</span>
<span class="cp">#define DEFINE_WASM_API_ARG_CHECK_I32_2(NAME) \</span>
<span class="cp">    int32_t p0 = args[0].of.i32; \</span>
<span class="cp">    int32_t p1 = args[1].of.i32; \</span>
<span class="cp">    int32_t res = NAME(p0, p1);</span>

<span class="cp">#define DEFINE_WASM_NAME_ARG_I32_3 \</span>
<span class="cp">    3, { \</span>
<span class="cp">    WASM_I32, WASM_I32, WASM_I32, }</span>
<span class="cp">#define DEFINE_WASM_API_ARG_CHECK_I32_3(NAME) \</span>
<span class="cp">    int32_t p0 = args[0].of.i32; \</span>
<span class="cp">    int32_t p1 = args[1].of.i32; \</span>
<span class="cp">    int32_t p2 = args[2].of.i32; \</span>
<span class="cp">    int32_t res = NAME(p0, p1, p2);</span>

<span class="cp">#define DEFINE_WASM_NAME_ARG_I32_4 \</span>
<span class="cp">    4, { \</span>
<span class="cp">    WASM_I32, WASM_I32, WASM_I32, WASM_I32, }</span>
<span class="cp">#define DEFINE_WASM_API_ARG_CHECK_I32_4(NAME) \</span>
<span class="cp">    int32_t p0 = args[0].of.i32; \</span>
<span class="cp">    int32_t p1 = args[1].of.i32; \</span>
<span class="cp">    int32_t p2 = args[2].of.i32; \</span>
<span class="cp">    int32_t p3 = args[3].of.i32; \</span>
<span class="cp">    int32_t res = NAME(p0, p1, p2, p3);</span>

<span class="cp">#define DEFINE_WASM_NAME_ARG_I32_5 \</span>
<span class="cp">    5, { \</span>
<span class="cp">    WASM_I32, WASM_I32, WASM_I32, WASM_I32, WASM_I32,  \</span>
<span class="cp">}</span>
<span class="cp">#define DEFINE_WASM_API_ARG_CHECK_I32_5(NAME) \</span>
<span class="cp">    int32_t p0 = args[0].of.i32; \</span>
<span class="cp">    int32_t p1 = args[1].of.i32; \</span>
<span class="cp">    int32_t p2 = args[2].of.i32; \</span>
<span class="cp">    int32_t p3 = args[3].of.i32; \</span>
<span class="cp">    int32_t p4 = args[4].of.i32; \</span>
<span class="cp">    int32_t res = NAME(p0, p1, p2, p3, p4);</span>

<span class="cp">#define DEFINE_WASM_NAME_ARG_I32_6 \</span>
<span class="cp">    6, { \</span>
<span class="cp">    WASM_I32, WASM_I32, WASM_I32, WASM_I32, WASM_I32,  \</span>
<span class="cp">    WASM_I32, }</span>
<span class="cp">#define DEFINE_WASM_API_ARG_CHECK_I32_6(NAME) \</span>
<span class="cp">    int32_t p0 = args[0].of.i32; \</span>
<span class="cp">    int32_t p1 = args[1].of.i32; \</span>
<span class="cp">    int32_t p2 = args[2].of.i32; \</span>
<span class="cp">    int32_t p3 = args[3].of.i32; \</span>
<span class="cp">    int32_t p4 = args[4].of.i32; \</span>
<span class="cp">    int32_t p5 = args[5].of.i32; \</span>
<span class="cp">    int32_t res = NAME(p0, p1, p2, p3, p4, p5);</span>

<span class="cp">#define DEFINE_WASM_NAME_ARG_I32_7 \</span>
<span class="cp">    7, { \</span>
<span class="cp">    WASM_I32, WASM_I32, WASM_I32, WASM_I32, WASM_I32,  \</span>
<span class="cp">    WASM_I32, WASM_I32, }</span>
<span class="cp">#define DEFINE_WASM_API_ARG_CHECK_I32_7(NAME) \</span>
<span class="cp">    int32_t p0 = args[0].of.i32; \</span>
<span class="cp">    int32_t p1 = args[1].of.i32; \</span>
<span class="cp">    int32_t p2 = args[2].of.i32; \</span>
<span class="cp">    int32_t p3 = args[3].of.i32; \</span>
<span class="cp">    int32_t p4 = args[4].of.i32; \</span>
<span class="cp">    int32_t p5 = args[5].of.i32; \</span>
<span class="cp">    int32_t p6 = args[6].of.i32; \</span>
<span class="cp">    int32_t res = NAME(p0, p1, p2, p3, p4, p5, p6);</span>

<span class="n">DEFINE_WASM_API</span><span class="p">(</span><span class="n">tendis_get_buffer_bytes</span><span class="p">,</span>
<span class="w">                </span><span class="n">DEFINE_WASM_API_ARG_CHECK_I32_4</span><span class="p">(</span><span class="n">tendis_get_buffer_bytes</span><span class="p">))</span>

<span class="n">DEFINE_WASM_API</span><span class="p">(</span><span class="n">tendis_set_buffer_bytes</span><span class="p">,</span>
<span class="w">                </span><span class="n">DEFINE_WASM_API_ARG_CHECK_I32_4</span><span class="p">(</span><span class="n">tendis_set_buffer_bytes</span><span class="p">))</span>


<span class="k">static</span><span class="w"> </span><span class="n">wasm_wasmtime_host_api_t</span><span class="w"> </span><span class="n">host_apis</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">DEFINE_WASM_NAME</span><span class="p">(</span><span class="n">tendis_get_buffer_bytes</span><span class="p">,</span><span class="w"> </span><span class="n">DEFINE_WASM_NAME_ARG_I32_4</span><span class="p">)</span>
<span class="w">    </span><span class="n">DEFINE_WASM_NAME</span><span class="p">(</span><span class="n">tendis_set_buffer_bytes</span><span class="p">,</span><span class="w"> </span><span class="n">DEFINE_WASM_NAME_ARG_I32_4</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="s">""</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="p">}</span>
<span class="p">};</span>

<span class="n">wasm_functype_t</span><span class="w"> </span><span class="o">*</span>
<span class="nf">WasmtimeVM::wasmtime_host_api_func</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">wasm_wasmtime_host_api_t</span><span class="w"> </span><span class="o">*</span><span class="n">api</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w">                </span><span class="n">i</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasm_valtype_vec_t</span><span class="w"> </span><span class="n">param_vec</span><span class="p">,</span><span class="w"> </span><span class="n">result_vec</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasm_valtype_t</span><span class="w">    </span><span class="o">*</span><span class="n">param</span><span class="p">[</span><span class="n">MAX_WASM_API_ARG</span><span class="p">];</span>
<span class="w">    </span><span class="n">wasm_valtype_t</span><span class="w">    </span><span class="o">*</span><span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="w">    </span><span class="n">wasm_functype_t</span><span class="w">   </span><span class="o">*</span><span class="n">f</span><span class="p">;</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">api</span><span class="o">-&gt;</span><span class="n">param_num</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasm_valtype_new</span><span class="p">(</span><span class="n">api</span><span class="o">-&gt;</span><span class="n">param_type</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasm_valtype_new</span><span class="p">(</span><span class="n">WASM_I32</span><span class="p">);</span>
<span class="w">    </span><span class="n">wasm_valtype_vec_new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">param_vec</span><span class="p">,</span><span class="w"> </span><span class="n">api</span><span class="o">-&gt;</span><span class="n">param_num</span><span class="p">,</span><span class="w"> </span><span class="n">param</span><span class="p">);</span>
<span class="w">    </span><span class="n">wasm_valtype_vec_new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result_vec</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">);</span>

<span class="w">    </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasm_functype_new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">param_vec</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">result_vec</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">f</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">WasmtimeVM::wasmtime_report_error</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">message</span><span class="p">,</span>
<span class="w">    </span><span class="n">wasmtime_error_t</span><span class="w"> </span><span class="o">*</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">wasm_trap_t</span><span class="w"> </span><span class="o">*</span><span class="n">trap</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">wasm_byte_vec_t</span><span class="w"> </span><span class="n">error_message</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">wasmtime_error_message</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">error_message</span><span class="p">);</span>
<span class="w">        </span><span class="n">wasmtime_error_delete</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">wasm_trap_message</span><span class="p">(</span><span class="n">trap</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">error_message</span><span class="p">);</span>
<span class="w">        </span><span class="n">wasm_trap_delete</span><span class="p">(</span><span class="n">trap</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">error_message</span><span class="p">.</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">error_message</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasm_byte_vec_delete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">error_message</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">WasmtimeVM::load</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">bytecode</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">wasm_name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w">                        </span><span class="n">i</span><span class="p">;</span>
<span class="w">    </span><span class="kt">bool</span><span class="w">                          </span><span class="n">ok</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasm_engine_t</span><span class="w">                </span><span class="o">*</span><span class="n">vm_engine</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasm_trap_t</span><span class="w">                  </span><span class="o">*</span><span class="n">trap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_module_t</span><span class="w">            </span><span class="o">*</span><span class="k">module</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_store_t</span><span class="w">             </span><span class="o">*</span><span class="n">store</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_context_t</span><span class="w">           </span><span class="o">*</span><span class="n">context</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_linker_t</span><span class="w">            </span><span class="o">*</span><span class="n">linker</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasi_config_t</span><span class="w">                </span><span class="o">*</span><span class="n">wasi_config</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_error_t</span><span class="w">             </span><span class="o">*</span><span class="n">error</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasmtime_extern_t</span><span class="w">             </span><span class="n">item</span><span class="p">;</span>

<span class="w">    </span><span class="n">plugin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">wasm_wasmtime_plugin_t</span><span class="p">;</span>
<span class="w">    </span><span class="n">wasm_name_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasm_name</span><span class="p">;</span>

<span class="w">    </span><span class="n">vm_engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasm_engine_new</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">vm_engine</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">"failed to new engine"</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">//wasmtime_module_deserialize();</span>
<span class="w">    </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime_module_new</span><span class="p">(</span><span class="n">vm_engine</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">bytecode</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="n">bytecode</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span><span class="w"> </span><span class="o">&amp;</span><span class="k">module</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//error = wasmtime_module_deserialize(vm_engine, (const uint8_t*) bytecode.c_str(), bytecode.size(), &amp;module);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">wasmtime_report_error</span><span class="p">(</span><span class="s">"failed to new module: "</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-2</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime_store_new</span><span class="p">(</span><span class="n">vm_engine</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">store</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-3</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime_store_context</span><span class="p">(</span><span class="n">store</span><span class="p">);</span>

<span class="w">    </span><span class="n">wasi_config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasi_config_new</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">wasi_config</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-4</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">wasi_config_inherit_env</span><span class="p">(</span><span class="n">wasi_config</span><span class="p">);</span>
<span class="w">    </span><span class="n">wasi_config_inherit_stdin</span><span class="p">(</span><span class="n">wasi_config</span><span class="p">);</span>
<span class="w">    </span><span class="n">wasi_config_inherit_stdout</span><span class="p">(</span><span class="n">wasi_config</span><span class="p">);</span>
<span class="w">    </span><span class="n">wasi_config_inherit_stderr</span><span class="p">(</span><span class="n">wasi_config</span><span class="p">);</span>

<span class="w">    </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime_context_set_wasi</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">wasi_config</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">wasmtime_report_error</span><span class="p">(</span><span class="s">"failed to init WASI: "</span><span class="p">,</span><span class="w"> </span><span class="n">err</span>
<span class="p">[</span><span class="n">message</span><span class="w"> </span><span class="n">truncated</span><span class="p">]</span>
</code></pre></div><br>
</p>
</blockquote>



<a name="503672780"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310333%20question%3A%20How%20to%20ensure%20c-api%20thr.../near/503672780" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310333.20question.3A.20How.20to.20ensure.20c-api.20thr.2E.2E.2E.html#503672780">(Mar 06 2025 at 01:35)</a>:</h4>
<p>liupeidong0620 <a href="https://github.com/bytecodealliance/wasmtime/issues/10333#issuecomment-2702499856">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10333">issue #10333</a>:</p>
<blockquote>
<p>Thanks</p>
</blockquote>



<hr><p>Last updated: Feb 22 2026 at 11:05 UTC</p>
</html>
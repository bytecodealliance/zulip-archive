<html>
<head><meta charset="utf-8"><title>wasmtime / issue #11602 s390x: Incorrect ABI (?) when mix... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311602.20s390x.3A.20Incorrect.20ABI.20.28.3F.29.20when.20mix.2E.2E.2E.html">wasmtime / issue #11602 s390x: Incorrect ABI (?) when mix...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="537545357"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311602%20s390x%3A%20Incorrect%20ABI%20%28%3F%29%20when%20mix.../near/537545357" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311602.20s390x.3A.20Incorrect.20ABI.20.28.3F.29.20when.20mix.2E.2E.2E.html#537545357">(Sep 03 2025 at 19:59)</a>:</h4>
<p>alexcrichton opened <a href="https://github.com/bytecodealliance/wasmtime/issues/11602">issue #11602</a>:</p>
<blockquote>
<p>Given this input:</p>
<div class="codehilite" data-code-language="wasm"><pre><span></span><code>(module
  (func (export "f")
    (param
      i32 i32 i32 i32
      i32 i32 i32 i32
      i32 i32 i32 i32
      i32 i32 i32 i32
      i32
    )
    (result
      i32 i32 i32 i32
      i32 i32 i32 i32
      i32 i32 i32 i32
      i32 i32 i32 i32
      i32
    )

    (block $h
      (try_table (catch_all $h)
        local.get 0
        local.get 1
        local.get 2
        local.get 3
        local.get 4
        local.get 5
        local.get 6
        local.get 7
        local.get 8
        local.get 9
        local.get 10
        local.get 11
        local.get 12
        local.get 13
        local.get 14
        local.get 15
        local.get 16

        call $f2_callee
        return
      )
    )
    unreachable
  )
  (func $f2_callee
    (param
      i32 i32 i32 i32
      i32 i32 i32 i32
      i32 i32 i32 i32
      i32 i32 i32 i32
      i32
    )
    (result
      i32 i32 i32 i32
      i32 i32 i32 i32
      i32 i32 i32 i32
      i32 i32 i32 i32
      i32
    )

    local.get 0
    local.get 1
    local.get 2
    local.get 3
    local.get 4
    local.get 5
    local.get 6
    local.get 7
    local.get 8
    local.get 9
    local.get 10
    local.get 11
    local.get 12
    local.get 13
    local.get 14
    local.get 15
    local.get 16
  )
)

(assert_return (invoke "f"
    (i32.const 0)
    (i32.const 1)
    (i32.const 2)
    (i32.const 3)
    (i32.const 4)
    (i32.const 5)
    (i32.const 6)
    (i32.const 7)
    (i32.const 8)
    (i32.const 9)
    (i32.const 10)
    (i32.const 11)
    (i32.const 12)
    (i32.const 13)
    (i32.const 14)
    (i32.const 15)
    (i32.const 16)
  )
  (i32.const 0)
  (i32.const 1)
  (i32.const 2)
  (i32.const 3)
  (i32.const 4)
  (i32.const 5)
  (i32.const 6)
  (i32.const 7)
  (i32.const 8)
  (i32.const 9)
  (i32.const 10)
  (i32.const 11)
  (i32.const 12)
  (i32.const 13)
  (i32.const 14)
  (i32.const 15)
  (i32.const 16)
)
</code></pre></div>
<p>locally this fails for me as:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">target</span><span class="w"> </span><span class="n">s390x</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="w"> </span><span class="n">wast</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">foo</span><span class="p">.</span><span class="n">wast</span><span class="w"> </span><span class="o">-</span><span class="n">W</span><span class="w"> </span><span class="n">exceptions</span>
<span class="o">..</span><span class="p">.</span>
<span class="n">qemu</span><span class="p">:</span><span class="w"> </span><span class="nc">uncaught</span><span class="w"> </span><span class="n">target</span><span class="w"> </span><span class="n">signal</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="p">(</span><span class="n">Segmentation</span><span class="w"> </span><span class="n">fault</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">core</span><span class="w"> </span><span class="n">dumped</span>
<span class="n">zsh</span><span class="p">:</span><span class="w"> </span><span class="nc">segmentation</span><span class="w"> </span><span class="n">fault</span><span class="w"> </span><span class="p">(</span><span class="n">core</span><span class="w"> </span><span class="n">dumped</span><span class="p">)</span><span class="w">  </span><span class="n">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">target</span><span class="w"> </span><span class="n">s390x</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="w"> </span><span class="n">wast</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">foo</span><span class="p">.</span><span class="n">wast</span><span class="w"> </span><span class="o">-</span><span class="n">W</span><span class="w"> </span><span class="n">exceptions</span>
</code></pre></div>
<p>debugging this it appears that the array-to-wasm trampoline's stack pointer isn't restored upon it being returned to. The fault appears to be that the place-to-save-wasm results is saved on the stack but when it's reloaded from the stack the wrong value is reloaded. Beyond this though I'm not entirely sure where the issue lies.</p>
<p>cc @uweigand </p>
</blockquote>



<a name="537545358"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311602%20s390x%3A%20Incorrect%20ABI%20%28%3F%29%20when%20mix.../near/537545358" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311602.20s390x.3A.20Incorrect.20ABI.20.28.3F.29.20when.20mix.2E.2E.2E.html#537545358">(Sep 03 2025 at 19:59)</a>:</h4>
<p><a href="https://github.com/alexcrichton">alexcrichton</a> added the cranelift:area:s390x label to <a href="https://github.com/bytecodealliance/wasmtime/issues/11602">Issue #11602</a>.</p>



<a name="537545360"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311602%20s390x%3A%20Incorrect%20ABI%20%28%3F%29%20when%20mix.../near/537545360" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311602.20s390x.3A.20Incorrect.20ABI.20.28.3F.29.20when.20mix.2E.2E.2E.html#537545360">(Sep 03 2025 at 19:59)</a>:</h4>
<p><a href="https://github.com/alexcrichton">alexcrichton</a> added the wasm-proposal:exceptions label to <a href="https://github.com/bytecodealliance/wasmtime/issues/11602">Issue #11602</a>.</p>



<a name="537577205"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311602%20s390x%3A%20Incorrect%20ABI%20%28%3F%29%20when%20mix.../near/537577205" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311602.20s390x.3A.20Incorrect.20ABI.20.28.3F.29.20when.20mix.2E.2E.2E.html#537577205">(Sep 04 2025 at 01:54)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/11602#issuecomment-3251416596">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11602">issue #11602</a>:</p>
<blockquote>
<p>After <a href="https://github.com/bytecodealliance/wasmtime/pull/11597">https://github.com/bytecodealliance/wasmtime/pull/11597</a> merges the reproduction will require reverting <a href="https://github.com/bytecodealliance/wasmtime/pull/11597/files#diff-908a422cef87524478865a23918af79040c970e02a3cc6862f6eb508710606f9">these changes first</a></p>
</blockquote>



<a name="538955435"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311602%20s390x%3A%20Incorrect%20ABI%20%28%3F%29%20when%20mix.../near/538955435" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311602.20s390x.3A.20Incorrect.20ABI.20.28.3F.29.20when.20mix.2E.2E.2E.html#538955435">(Sep 11 2025 at 23:20)</a>:</h4>
<p>alexcrichton closed <a href="https://github.com/bytecodealliance/wasmtime/issues/11602">issue #11602</a>:</p>
<blockquote>
<p>Given this input:</p>
<div class="codehilite" data-code-language="wasm"><pre><span></span><code>(module
  (func (export "f")
    (param
      i32 i32 i32 i32
      i32 i32 i32 i32
      i32 i32 i32 i32
      i32 i32 i32 i32
      i32
    )
    (result
      i32 i32 i32 i32
      i32 i32 i32 i32
      i32 i32 i32 i32
      i32 i32 i32 i32
      i32
    )

    (block $h
      (try_table (catch_all $h)
        local.get 0
        local.get 1
        local.get 2
        local.get 3
        local.get 4
        local.get 5
        local.get 6
        local.get 7
        local.get 8
        local.get 9
        local.get 10
        local.get 11
        local.get 12
        local.get 13
        local.get 14
        local.get 15
        local.get 16

        call $f2_callee
        return
      )
    )
    unreachable
  )
  (func $f2_callee
    (param
      i32 i32 i32 i32
      i32 i32 i32 i32
      i32 i32 i32 i32
      i32 i32 i32 i32
      i32
    )
    (result
      i32 i32 i32 i32
      i32 i32 i32 i32
      i32 i32 i32 i32
      i32 i32 i32 i32
      i32
    )

    local.get 0
    local.get 1
    local.get 2
    local.get 3
    local.get 4
    local.get 5
    local.get 6
    local.get 7
    local.get 8
    local.get 9
    local.get 10
    local.get 11
    local.get 12
    local.get 13
    local.get 14
    local.get 15
    local.get 16
  )
)

(assert_return (invoke "f"
    (i32.const 0)
    (i32.const 1)
    (i32.const 2)
    (i32.const 3)
    (i32.const 4)
    (i32.const 5)
    (i32.const 6)
    (i32.const 7)
    (i32.const 8)
    (i32.const 9)
    (i32.const 10)
    (i32.const 11)
    (i32.const 12)
    (i32.const 13)
    (i32.const 14)
    (i32.const 15)
    (i32.const 16)
  )
  (i32.const 0)
  (i32.const 1)
  (i32.const 2)
  (i32.const 3)
  (i32.const 4)
  (i32.const 5)
  (i32.const 6)
  (i32.const 7)
  (i32.const 8)
  (i32.const 9)
  (i32.const 10)
  (i32.const 11)
  (i32.const 12)
  (i32.const 13)
  (i32.const 14)
  (i32.const 15)
  (i32.const 16)
)
</code></pre></div>
<p>locally this fails for me as:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">target</span><span class="w"> </span><span class="n">s390x</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="w"> </span><span class="n">wast</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">foo</span><span class="p">.</span><span class="n">wast</span><span class="w"> </span><span class="o">-</span><span class="n">W</span><span class="w"> </span><span class="n">exceptions</span>
<span class="o">..</span><span class="p">.</span>
<span class="n">qemu</span><span class="p">:</span><span class="w"> </span><span class="nc">uncaught</span><span class="w"> </span><span class="n">target</span><span class="w"> </span><span class="n">signal</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="p">(</span><span class="n">Segmentation</span><span class="w"> </span><span class="n">fault</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">core</span><span class="w"> </span><span class="n">dumped</span>
<span class="n">zsh</span><span class="p">:</span><span class="w"> </span><span class="nc">segmentation</span><span class="w"> </span><span class="n">fault</span><span class="w"> </span><span class="p">(</span><span class="n">core</span><span class="w"> </span><span class="n">dumped</span><span class="p">)</span><span class="w">  </span><span class="n">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">target</span><span class="w"> </span><span class="n">s390x</span><span class="o">-</span><span class="n">unknown</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="w"> </span><span class="n">wast</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">foo</span><span class="p">.</span><span class="n">wast</span><span class="w"> </span><span class="o">-</span><span class="n">W</span><span class="w"> </span><span class="n">exceptions</span>
</code></pre></div>
<p>debugging this it appears that the array-to-wasm trampoline's stack pointer isn't restored upon it being returned to. The fault appears to be that the place-to-save-wasm results is saved on the stack but when it's reloaded from the stack the wrong value is reloaded. Beyond this though I'm not entirely sure where the issue lies.</p>
<p>cc @uweigand </p>
</blockquote>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
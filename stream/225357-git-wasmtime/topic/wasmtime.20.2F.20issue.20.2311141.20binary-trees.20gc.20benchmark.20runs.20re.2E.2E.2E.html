<html>
<head><meta charset="utf-8"><title>wasmtime / issue #11141 binary-trees gc benchmark runs re... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311141.20binary-trees.20gc.20benchmark.20runs.20re.2E.2E.2E.html">wasmtime / issue #11141 binary-trees gc benchmark runs re...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="525934561"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311141%20binary-trees%20gc%20benchmark%20runs%20re.../near/525934561" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311141.20binary-trees.20gc.20benchmark.20runs.20re.2E.2E.2E.html#525934561">(Jun 26 2025 at 15:47)</a>:</h4>
<p>jrmuizel opened <a href="https://github.com/bytecodealliance/wasmtime/issues/11141">issue #11141</a>:</p>
<blockquote>
<h3>Test Case</h3>
<p><a href="https://github.com/user-attachments/files/20929191/binary-trees-wasi-opt.wasm.zip">binary-trees-wasi-opt.wasm.zip</a></p>
<h3>Steps to Reproduce</h3>
<ul>
<li>Run <code>time wasmtime run -W gc=y binary-trees-wasi-opt.wasm</code></li>
</ul>
<h3>Actual Results</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">stretch</span><span class="w"> </span><span class="n">tree</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">depth</span><span class="w"> </span><span class="mi">21</span><span class="w"> </span><span class="n">check</span><span class="p">:</span><span class="w"> </span><span class="mi">4194303</span>
<span class="mi">1048576</span><span class="w"> </span><span class="n">trees</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">depth</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="n">check</span><span class="p">:</span><span class="w"> </span><span class="mi">32505856</span>
<span class="mi">262144</span><span class="w"> </span><span class="n">trees</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">depth</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="n">check</span><span class="p">:</span><span class="w"> </span><span class="mi">33292288</span>
<span class="mi">65536</span><span class="w"> </span><span class="n">trees</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">depth</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="n">check</span><span class="p">:</span><span class="w"> </span><span class="mi">33488896</span>
<span class="mi">16384</span><span class="w"> </span><span class="n">trees</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">depth</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="n">check</span><span class="p">:</span><span class="w"> </span><span class="mi">33538048</span>
<span class="mi">4096</span><span class="w"> </span><span class="n">trees</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">depth</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="n">check</span><span class="p">:</span><span class="w"> </span><span class="mi">33550336</span>
<span class="mi">1024</span><span class="w"> </span><span class="n">trees</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">depth</span><span class="w"> </span><span class="mi">14</span><span class="w"> </span><span class="n">check</span><span class="p">:</span><span class="w"> </span><span class="mi">33553408</span>
<span class="mi">256</span><span class="w"> </span><span class="n">trees</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">depth</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="n">check</span><span class="p">:</span><span class="w"> </span><span class="mi">33554176</span>
<span class="mi">64</span><span class="w"> </span><span class="n">trees</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">depth</span><span class="w"> </span><span class="mi">18</span><span class="w"> </span><span class="n">check</span><span class="p">:</span><span class="w"> </span><span class="mi">33554368</span>
<span class="mi">16</span><span class="w"> </span><span class="n">trees</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">depth</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="n">check</span><span class="p">:</span><span class="w"> </span><span class="mi">33554416</span>
<span class="n">long</span><span class="w"> </span><span class="n">lived</span><span class="w"> </span><span class="n">tree</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">depth</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="n">check</span><span class="p">:</span><span class="w"> </span><span class="mi">2097151</span>

<span class="n">real</span><span class="w">    </span><span class="mi">2</span><span class="n">m13</span><span class="p">.</span><span class="mi">350</span><span class="n">s</span>
<span class="n">user</span><span class="w">    </span><span class="mi">2</span><span class="n">m12</span><span class="p">.</span><span class="mi">736</span><span class="n">s</span>
<span class="n">sys</span><span class="w"> </span><span class="mi">0</span><span class="n">m0</span><span class="p">.</span><span class="mi">454</span><span class="n">s</span>
</code></pre></div>
<h3>Expected Results</h3>
<p>It should run much faster.<br>
V8: 1.2s<br>
Firefox: 4.8s<br>
Safari: 5.9s</p>
<h3>Extra Info</h3>
<p>The benchmark is:</p>
<div class="codehilite" data-code-language="Java"><pre><span></span><code><span class="kd">class</span> <span class="nc">TreeNode</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">TreeNode</span><span class="w"> </span><span class="n">left</span><span class="p">;</span>
<span class="w">    </span><span class="n">TreeNode</span><span class="w"> </span><span class="n">right</span><span class="p">;</span>

<span class="w">    </span><span class="n">TreeNode</span><span class="w"> </span><span class="nf">bottomUpTree</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">depth</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">depth</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">TreeNode</span><span class="w"> </span><span class="n">leftChild</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">bottomUpTree</span><span class="p">(</span><span class="n">depth</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">            </span><span class="n">TreeNode</span><span class="w"> </span><span class="n">rightChild</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">bottomUpTree</span><span class="p">(</span><span class="n">depth</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">            </span><span class="n">TreeNode</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TreeNode</span><span class="p">();</span>
<span class="w">            </span><span class="n">node</span><span class="p">.</span><span class="na">left</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">leftChild</span><span class="p">;</span>
<span class="w">            </span><span class="n">node</span><span class="p">.</span><span class="na">right</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rightChild</span><span class="p">;</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">node</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">TreeNode</span><span class="w"> </span><span class="n">node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TreeNode</span><span class="p">();</span>
<span class="w">            </span><span class="n">node</span><span class="p">.</span><span class="na">left</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">            </span><span class="n">node</span><span class="p">.</span><span class="na">right</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">node</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="nf">itemCheck</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">left</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">left</span><span class="p">.</span><span class="na">itemCheck</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">right</span><span class="p">.</span><span class="na">itemCheck</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">minDepth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">20</span><span class="p">;</span><span class="w">  </span><span class="c1">// Increase n to make it more interesting</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">maxDepth</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">minDepth</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">maxDepth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">minDepth</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">maxDepth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">stretchDepth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">maxDepth</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">    </span><span class="n">TreeNode</span><span class="w"> </span><span class="n">stretchTree</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TreeNode</span><span class="p">();</span>
<span class="w">    </span><span class="n">TreeNode</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stretchTree</span><span class="p">.</span><span class="na">bottomUpTree</span><span class="p">(</span><span class="n">stretchDepth</span><span class="p">);</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">check</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temp</span><span class="p">.</span><span class="na">itemCheck</span><span class="p">();</span>
<span class="w">    </span><span class="n">print</span><span class="p">(</span><span class="s">"stretch tree of depth "</span><span class="p">);</span>
<span class="w">    </span><span class="n">print</span><span class="p">(</span><span class="n">stretchDepth</span><span class="p">);</span>
<span class="w">    </span><span class="n">print</span><span class="p">(</span><span class="s">" check: "</span><span class="p">);</span>
<span class="w">    </span><span class="n">println</span><span class="p">(</span><span class="n">check</span><span class="p">);</span>

<span class="w">    </span><span class="n">TreeNode</span><span class="w"> </span><span class="n">longLivedTree</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TreeNode</span><span class="p">();</span>
<span class="w">    </span><span class="n">longLivedTree</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">longLivedTree</span><span class="p">.</span><span class="na">bottomUpTree</span><span class="p">(</span><span class="n">maxDepth</span><span class="p">);</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">depth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">minDepth</span><span class="p">;</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">depth</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">maxDepth</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">iterations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">maxDepth</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">depth</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">minDepth</span><span class="p">);</span>
<span class="w">        </span><span class="n">check</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">iterations</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">TreeNode</span><span class="w"> </span><span class="n">tree</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TreeNode</span><span class="p">();</span>
<span class="w">            </span><span class="n">tree</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tree</span><span class="p">.</span><span class="na">bottomUpTree</span><span class="p">(</span><span class="n">depth</span><span class="p">);</span>
<span class="w">            </span><span class="n">check</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">check</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tree</span><span class="p">.</span><span class="na">itemCheck</span><span class="p">();</span>
<span class="w">            </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">print</span><span class="p">(</span><span class="n">iterations</span><span class="p">);</span>
<span class="w">        </span><span class="n">print</span><span class="p">(</span><span class="s">" trees of depth "</span><span class="p">);</span>
<span class="w">        </span><span class="n">print</span><span class="p">(</span><span class="n">depth</span><span class="p">);</span>
<span class="w">        </span><span class="n">print</span><span class="p">(</span><span class="s">" check: "</span><span class="p">);</span>
<span class="w">        </span><span class="n">println</span><span class="p">(</span><span class="n">check</span><span class="p">);</span>
<span class="w">        </span><span class="n">depth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">depth</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">print</span><span class="p">(</span><span class="s">"long lived tree of depth "</span><span class="p">);</span>
<span class="w">    </span><span class="n">print</span><span class="p">(</span><span class="n">maxDepth</span><span class="p">);</span>
<span class="w">    </span><span class="n">print</span><span class="p">(</span><span class="s">" check: "</span><span class="p">);</span>
<span class="w">    </span><span class="n">println</span><span class="p">(</span><span class="n">longLivedTree</span><span class="p">.</span><span class="na">itemCheck</span><span class="p">());</span>
<span class="p">}</span>
</code></pre></div>
<p>compiled with <a href="https://github.com/jrmuizel/wasm-lang1">https://github.com/jrmuizel/wasm-lang1</a></p>
<p>There's a browser version here: <a href="https://zingy-sorbet-48e9a5.netlify.app/binary-trees-opt.html">https://zingy-sorbet-48e9a5.netlify.app/binary-trees-opt.html</a></p>
</blockquote>



<a name="525934562"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311141%20binary-trees%20gc%20benchmark%20runs%20re.../near/525934562" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311141.20binary-trees.20gc.20benchmark.20runs.20re.2E.2E.2E.html#525934562">(Jun 26 2025 at 15:47)</a>:</h4>
<p><a href="https://github.com/jrmuizel">jrmuizel</a> added the bug label to <a href="https://github.com/bytecodealliance/wasmtime/issues/11141">Issue #11141</a>.</p>



<a name="525936154"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311141%20binary-trees%20gc%20benchmark%20runs%20re.../near/525936154" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311141.20binary-trees.20gc.20benchmark.20runs.20re.2E.2E.2E.html#525936154">(Jun 26 2025 at 15:56)</a>:</h4>
<p><a href="https://github.com/alexcrichton">alexcrichton</a> added the wasm-proposal:gc label to <a href="https://github.com/bytecodealliance/wasmtime/issues/11141">Issue #11141</a>.</p>



<a name="525953350"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311141%20binary-trees%20gc%20benchmark%20runs%20re.../near/525953350" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311141.20binary-trees.20gc.20benchmark.20runs.20re.2E.2E.2E.html#525953350">(Jun 26 2025 at 17:41)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/issues/11141#issuecomment-3009273370">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11141">issue #11141</a>:</p>
<blockquote>
<p>Thanks for filing this issue with a test case and STR, @jrmuizel! Very appreciated.</p>
<p>First off, in general, when benchmarking Wasm execution in Wasmtime, we want to make sure that we aren't measuring compile time. Unlike browsers, Wasmtime doesn't start with a baseline compiler or interpreter and then dynamically tier up to an optimized compiler; we just (depending on the configuration) compile with our optimizing compiler immediately and then when the whole module is compiled, we start running it. Wasmtime is really more like an AOT compiler than a browser JIT, even though it can technically compile just-in-time. So given all that, in the future, it would be good to do something like this:</p>
<div class="codehilite" data-code-language="Bash Session"><pre><span></span><code><span class="gp">$ </span>wasmtime<span class="w"> </span>compile<span class="w"> </span>binary-trees-wasi-opt.wasm<span class="w"> </span>-o<span class="w"> </span>binary-trees-wasi-opt.cwasm
<span class="gp">$ </span><span class="nb">time</span><span class="w"> </span>wasmtime<span class="w"> </span>run<span class="w"> </span>--allow-precompiled<span class="w"> </span>binary-trees-wasi-opt.cwasm
</code></pre></div>
<p>(And maybe replace <code>time</code> with <a href="https://github.com/sharkdp/hyperfine"><code>hyperfine</code></a> as necessary.)</p>
<p>Second, just to set expectations, you should know that we have thus far focused only on correctness and haven't put much effort into optimizing the GC implementation yet. Not at the level of the details of codegen nor at the algorithmic level. For example, the default DRC collector uses a fixed size bump chunk in part of its implementation, and whenever that gets full, we trigger a GC. We don't do any doubling of that bump chunk or anything like that based on the GC heap's size, and I suspect this could lead to somewhat pathological behavior. See also <a href="https://github.com/bytecodealliance/wasmtime/issues/9351">https://github.com/bytecodealliance/wasmtime/issues/9351</a> for a collection of GC optimizations that we haven't investigated yet.</p>
<p>Finally, if the test case doesn't allocate too much, it is also worth investigating whether using the null collector has a different performance profile than the default DRC collector. If the test case is hitting the potential pathological behavior previously described, then using the null collector will avoid that. That's of course not necessarily a solution for users, but is very useful information to include in issues. Basically, this helps us diagnose whether the issue is in our codegen or the collector implementation itself.</p>
<p>Anyways, that's all just some hopefully helpful background and context for you. I will investigate what's going on here in more detail in a little bit.</p>
</blockquote>



<a name="525961426"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311141%20binary-trees%20gc%20benchmark%20runs%20re.../near/525961426" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311141.20binary-trees.20gc.20benchmark.20runs.20re.2E.2E.2E.html#525961426">(Jun 26 2025 at 18:32)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/issues/11141#issuecomment-3009467719">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11141">issue #11141</a>:</p>
<blockquote>
<p>The benchmark doesn't complete with the null collector, but the output before it OOMs is coming <em>much</em> quicker, so this is probably related to something in the DRC collector itself.</p>
</blockquote>



<a name="525974723"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311141%20binary-trees%20gc%20benchmark%20runs%20re.../near/525974723" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311141.20binary-trees.20gc.20benchmark.20runs.20re.2E.2E.2E.html#525974723">(Jun 26 2025 at 20:18)</a>:</h4>
<p>jrmuizel <a href="https://github.com/bytecodealliance/wasmtime/issues/11141#issuecomment-3009844225">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11141">issue #11141</a>:</p>
<blockquote>
<p>Pre-compiling doesn't seem to help:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">allow</span><span class="o">-</span><span class="n">precompiled</span><span class="w"> </span><span class="o">-</span><span class="n">W</span><span class="w"> </span><span class="n">gc</span><span class="w"> </span><span class="n">binary</span><span class="o">-</span><span class="n">trees</span><span class="o">-</span><span class="n">wasi</span><span class="o">-</span><span class="n">opt</span><span class="p">.</span><span class="n">cwasm</span>
<span class="n">stretch</span><span class="w"> </span><span class="n">tree</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">depth</span><span class="w"> </span><span class="mi">21</span><span class="w"> </span><span class="n">check</span><span class="p">:</span><span class="w"> </span><span class="mi">4194303</span>
<span class="mi">1048576</span><span class="w"> </span><span class="n">trees</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">depth</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="n">check</span><span class="p">:</span><span class="w"> </span><span class="mi">32505856</span>
<span class="mi">262144</span><span class="w"> </span><span class="n">trees</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">depth</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="n">check</span><span class="p">:</span><span class="w"> </span><span class="mi">33292288</span>
<span class="mi">65536</span><span class="w"> </span><span class="n">trees</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">depth</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="n">check</span><span class="p">:</span><span class="w"> </span><span class="mi">33488896</span>
<span class="mi">16384</span><span class="w"> </span><span class="n">trees</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">depth</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="n">check</span><span class="p">:</span><span class="w"> </span><span class="mi">33538048</span>
<span class="mi">4096</span><span class="w"> </span><span class="n">trees</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">depth</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="n">check</span><span class="p">:</span><span class="w"> </span><span class="mi">33550336</span>
<span class="mi">1024</span><span class="w"> </span><span class="n">trees</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">depth</span><span class="w"> </span><span class="mi">14</span><span class="w"> </span><span class="n">check</span><span class="p">:</span><span class="w"> </span><span class="mi">33553408</span>
<span class="mi">256</span><span class="w"> </span><span class="n">trees</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">depth</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="n">check</span><span class="p">:</span><span class="w"> </span><span class="mi">33554176</span>
<span class="mi">64</span><span class="w"> </span><span class="n">trees</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">depth</span><span class="w"> </span><span class="mi">18</span><span class="w"> </span><span class="n">check</span><span class="p">:</span><span class="w"> </span><span class="mi">33554368</span>
<span class="mi">16</span><span class="w"> </span><span class="n">trees</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">depth</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="n">check</span><span class="p">:</span><span class="w"> </span><span class="mi">33554416</span>
<span class="n">long</span><span class="w"> </span><span class="n">lived</span><span class="w"> </span><span class="n">tree</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">depth</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="n">check</span><span class="p">:</span><span class="w"> </span><span class="mi">2097151</span>

<span class="n">real</span><span class="w">    </span><span class="mi">2</span><span class="n">m12</span><span class="p">.</span><span class="mi">869</span><span class="n">s</span>
<span class="n">user</span><span class="w">    </span><span class="mi">2</span><span class="n">m12</span><span class="p">.</span><span class="mi">303</span><span class="n">s</span>
<span class="n">sys</span><span class="w"> </span><span class="mi">0</span><span class="n">m0</span><span class="p">.</span><span class="mi">467</span><span class="n">s</span>
</code></pre></div>
<p>The test case allocates a lot. It's basically just this: <a href="https://benchmarksgame-team.pages.debian.net/benchmarksgame/program/binarytrees-javavm-2.html">https://benchmarksgame-team.pages.debian.net/benchmarksgame/program/binarytrees-javavm-2.html</a></p>
<p>The other wasm implementations spend most of their time in GC as well.</p>
<p>Here's a profile of wasmtime: <a href="https://share.firefox.dev/4k8jCy0">https://share.firefox.dev/4k8jCy0</a></p>
<p>and the Spidermonkey bug for the slowness compared to Chrome:<br>
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1971860">https://bugzilla.mozilla.org/show_bug.cgi?id=1971860</a></p>
</blockquote>



<a name="525985262"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311141%20binary-trees%20gc%20benchmark%20runs%20re.../near/525985262" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311141.20binary-trees.20gc.20benchmark.20runs.20re.2E.2E.2E.html#525985262">(Jun 26 2025 at 21:52)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/issues/11141#issuecomment-3010255998">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11141">issue #11141</a>:</p>
<blockquote>
<p><a href="https://github.com/bytecodealliance/wasmtime/pull/11144">https://github.com/bytecodealliance/wasmtime/pull/11144</a> fixes the bump chunk issue I was talking about, and cuts the test case's runtime in half for me</p>
</blockquote>



<a name="525986749"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311141%20binary-trees%20gc%20benchmark%20runs%20re.../near/525986749" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311141.20binary-trees.20gc.20benchmark.20runs.20re.2E.2E.2E.html#525986749">(Jun 26 2025 at 22:09)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/issues/11141#issuecomment-3010298767">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11141">issue #11141</a>:</p>
<blockquote>
<p>15% of the remaining time is spent cloning <code>Arc</code>s inside <code>MmapBase</code> and <code>MmapOffset</code> just to get the base pointer for a <code>VMMemoryDefinition</code> <span aria-label="face palm" class="emoji emoji-1f926" role="img" title="face palm">:face_palm:</span> </p>
</blockquote>



<a name="526127097"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311141%20binary-trees%20gc%20benchmark%20runs%20re.../near/526127097" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311141.20binary-trees.20gc.20benchmark.20runs.20re.2E.2E.2E.html#526127097">(Jun 27 2025 at 17:28)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/issues/11141#issuecomment-3013873389">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11141">issue #11141</a>:</p>
<blockquote>
<blockquote>
<p>15% of the remaining time is spent cloning <code>Arc</code>s inside <code>MmapBase</code> and <code>MmapOffset</code> just to get the base pointer for a <code>VMMemoryDefinition</code> <span aria-label="face palm" class="emoji emoji-1f926" role="img" title="face palm">:face_palm:</span></p>
</blockquote>
<p>And another 15% of that time is spent dropping those <code>Arc</code>s that we just cloned.</p>
<p>WIP patch for this in <a href="https://github.com/bytecodealliance/wasmtime/pull/11148">https://github.com/bytecodealliance/wasmtime/pull/11148</a></p>
</blockquote>



<a name="526137925"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311141%20binary-trees%20gc%20benchmark%20runs%20re.../near/526137925" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311141.20binary-trees.20gc.20benchmark.20runs.20re.2E.2E.2E.html#526137925">(Jun 27 2025 at 18:51)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/11141#issuecomment-3014073849">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11141">issue #11141</a>:</p>
<blockquote>
<p>In the end, @fitzgen this benchmark (or something similar?) might be a good addition to sightglass perhaps</p>
</blockquote>



<a name="526139026"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311141%20binary-trees%20gc%20benchmark%20runs%20re.../near/526139026" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311141.20binary-trees.20gc.20benchmark.20runs.20re.2E.2E.2E.html#526139026">(Jun 27 2025 at 19:01)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/issues/11141#issuecomment-3014096809">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11141">issue #11141</a>:</p>
<blockquote>
<blockquote>
<p>In the end, <a href="https://github.com/fitzgen">@fitzgen</a> this benchmark (or something similar?) might be a good addition to sightglass perhaps</p>
</blockquote>
<p>Yeah I was thinking the same, although we'd need to get its runtime a little lower probably for that to be reasonable.</p>
</blockquote>



<a name="526465718"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311141%20binary-trees%20gc%20benchmark%20runs%20re.../near/526465718" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311141.20binary-trees.20gc.20benchmark.20runs.20re.2E.2E.2E.html#526465718">(Jun 30 2025 at 18:50)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/issues/11141#issuecomment-3020342248">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11141">issue #11141</a>:</p>
<blockquote>
<p>See also <a href="https://github.com/bytecodealliance/wasmtime/issues/11159">https://github.com/bytecodealliance/wasmtime/issues/11159</a></p>
</blockquote>



<a name="526477535"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311141%20binary-trees%20gc%20benchmark%20runs%20re.../near/526477535" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311141.20binary-trees.20gc.20benchmark.20runs.20re.2E.2E.2E.html#526477535">(Jun 30 2025 at 19:53)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/issues/11141#issuecomment-3020507211">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11141">issue #11141</a>:</p>
<blockquote>
<p>See also <a href="https://github.com/bytecodealliance/wasmtime/issues/11162">https://github.com/bytecodealliance/wasmtime/issues/11162</a></p>
</blockquote>



<a name="526479078"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311141%20binary-trees%20gc%20benchmark%20runs%20re.../near/526479078" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311141.20binary-trees.20gc.20benchmark.20runs.20re.2E.2E.2E.html#526479078">(Jun 30 2025 at 20:05)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/issues/11141#issuecomment-3020533899">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11141">issue #11141</a>:</p>
<blockquote>
<p>See also <a href="https://github.com/bytecodealliance/wasmtime/issues/11163">https://github.com/bytecodealliance/wasmtime/issues/11163</a></p>
</blockquote>



<a name="526480755"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311141%20binary-trees%20gc%20benchmark%20runs%20re.../near/526480755" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311141.20binary-trees.20gc.20benchmark.20runs.20re.2E.2E.2E.html#526480755">(Jun 30 2025 at 20:18)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/issues/11141#issuecomment-3020565490">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11141">issue #11141</a>:</p>
<blockquote>
<p>See also <a href="https://github.com/bytecodealliance/wasmtime/issues/11164">https://github.com/bytecodealliance/wasmtime/issues/11164</a></p>
</blockquote>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
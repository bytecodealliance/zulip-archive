<html>
<head><meta charset="utf-8"><title>wasmtime / issue #10381 The definition wasmtime_func_t in... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310381.20The.20definition.20wasmtime_func_t.20in.2E.2E.2E.html">wasmtime / issue #10381 The definition wasmtime_func_t in...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="505150454"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310381%20The%20definition%20wasmtime_func_t%20in.../near/505150454" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310381.20The.20definition.20wasmtime_func_t.20in.2E.2E.2E.html#505150454">(Mar 12 2025 at 14:31)</a>:</h4>
<p><a href="https://github.com/TheWaWaR">TheWaWaR</a> added the bug label to <a href="https://github.com/bytecodealliance/wasmtime/issues/10381">Issue #10381</a>.</p>



<a name="505150457"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310381%20The%20definition%20wasmtime_func_t%20in.../near/505150457" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310381.20The.20definition.20wasmtime_func_t.20in.2E.2E.2E.html#505150457">(Mar 12 2025 at 14:31)</a>:</h4>
<p>TheWaWaR opened <a href="https://github.com/bytecodealliance/wasmtime/issues/10381">issue #10381</a>:</p>
<blockquote>
<p>The <code>wasmtime_func_t</code> in <code>wasmtime /extern.h</code> is</p>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">wasmtime_func</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">store_id</span><span class="p">;</span>
<span class="w">  </span><span class="kt">size_t</span><span class="w"> </span><span class="n">__private</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">wasmtime_func_t</span><span class="p">;</span>
</code></pre></div>
<p>But in rust code (crates/c-api/src/val.rs):</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[repr(C)]</span>
<span class="cp">#[derive(Clone, Copy)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">union</span><span class="w"> </span><span class="nc">wasmtime_func_t</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">store_id</span><span class="p">:</span><span class="w"> </span><span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="n">func</span><span class="p">:</span><span class="w"> </span><span class="nc">Func</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Copy, Clone, Debug)]</span>
<span class="cp">#[repr(transparent)]</span><span class="w"> </span><span class="c1">// here for the C API</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">Func</span><span class="p">(</span><span class="n">Stored</span><span class="o">&lt;</span><span class="n">FuncData</span><span class="o">&gt;</span><span class="p">);</span>

<span class="cp">#[repr(C)]</span><span class="w"> </span><span class="c1">// used by reference in the C API, also in `wasmtime_func_t`.</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">Stored</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">store_id</span><span class="p">:</span><span class="w"> </span><span class="nc">StoreId</span><span class="p">,</span>
<span class="w">    </span><span class="n">index</span><span class="p">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span>
<span class="w">    </span><span class="n">_marker</span><span class="p">:</span><span class="w"> </span><span class="nc">marker</span><span class="p">::</span><span class="n">PhantomData</span><span class="o">&lt;</span><span class="k">fn</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">T</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>
<p>The size of wasmtime_func_t in C is 16 bytes, but the size in rust is 24 bytes, which include 2 <code>store_id</code> field.</p>
<p>As a consequence, the type <code>wasmtime_val_union</code> in Rust can't align with the type <code>wasmtime_valunion_t</code> in C.</p>
</blockquote>



<a name="505150556"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310381%20The%20definition%20wasmtime_func_t%20in.../near/505150556" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310381.20The.20definition.20wasmtime_func_t.20in.2E.2E.2E.html#505150556">(Mar 12 2025 at 14:32)</a>:</h4>
<p>TheWaWaR edited <a href="https://github.com/bytecodealliance/wasmtime/issues/10381">issue #10381</a>:</p>
<blockquote>
<p>The <code>wasmtime_func_t</code> in <code>wasmtime /extern.h</code> is</p>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">wasmtime_func</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">store_id</span><span class="p">;</span>
<span class="w">  </span><span class="kt">size_t</span><span class="w"> </span><span class="n">__private</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">wasmtime_func_t</span><span class="p">;</span>
</code></pre></div>
<p>But in rust code (crates/c-api/src/val.rs):</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[repr(C)]</span>
<span class="cp">#[derive(Clone, Copy)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">union</span><span class="w"> </span><span class="nc">wasmtime_func_t</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">store_id</span><span class="p">:</span><span class="w"> </span><span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="n">func</span><span class="p">:</span><span class="w"> </span><span class="nc">Func</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Copy, Clone, Debug)]</span>
<span class="cp">#[repr(transparent)]</span><span class="w"> </span><span class="c1">// here for the C API</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">Func</span><span class="p">(</span><span class="n">Stored</span><span class="o">&lt;</span><span class="n">FuncData</span><span class="o">&gt;</span><span class="p">);</span>

<span class="cp">#[repr(C)]</span><span class="w"> </span><span class="c1">// used by reference in the C API, also in `wasmtime_func_t`.</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">Stored</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">store_id</span><span class="p">:</span><span class="w"> </span><span class="nc">StoreId</span><span class="p">,</span>
<span class="w">    </span><span class="n">index</span><span class="p">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span>
<span class="w">    </span><span class="n">_marker</span><span class="p">:</span><span class="w"> </span><span class="nc">marker</span><span class="p">::</span><span class="n">PhantomData</span><span class="o">&lt;</span><span class="k">fn</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">T</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>
<p>The size of wasmtime_func_t in C is 16 bytes, but the size in rust is 24 bytes, which include 2 <code>store_id</code> fields.</p>
<p>As a consequence, the type <code>wasmtime_val_union</code> in Rust can't align with the type <code>wasmtime_valunion_t</code> in C.</p>
</blockquote>



<a name="505151645"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310381%20The%20definition%20wasmtime_func_t%20in.../near/505151645" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310381.20The.20definition.20wasmtime_func_t.20in.2E.2E.2E.html#505151645">(Mar 12 2025 at 14:35)</a>:</h4>
<p>TheWaWaR <a href="https://github.com/bytecodealliance/wasmtime/issues/10381#issuecomment-2718110748">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10381">issue #10381</a>:</p>
<blockquote>
<p>And also the type <code>wasmtime_anyref_t</code> and <code>wasmtime_externref_t</code> in Rust code doesn't have <code>#[repr(C)]</code> in the definition marco <code>ref_wrapper!</code>.</p>
</blockquote>



<a name="505152380"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310381%20The%20definition%20wasmtime_func_t%20in.../near/505152380" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310381.20The.20definition.20wasmtime_func_t.20in.2E.2E.2E.html#505152380">(Mar 12 2025 at 14:37)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/10381#issuecomment-2718117921">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10381">issue #10381</a>:</p>
<blockquote>
<p>Have you run into issues in the wild as a result of this? Or was this spotted during code review?</p>
<p>The Rust definition of <code>wasmtime_func_t</code> uses a <code>union</code> so it shouldn't be 24 bytes, but if you found an issue in the wild then that's more worrisome.</p>
</blockquote>



<a name="505153629"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310381%20The%20definition%20wasmtime_func_t%20in.../near/505153629" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310381.20The.20definition.20wasmtime_func_t.20in.2E.2E.2E.html#505153629">(Mar 12 2025 at 14:42)</a>:</h4>
<p>TheWaWaR <a href="https://github.com/bytecodealliance/wasmtime/issues/10381#issuecomment-2718130136">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10381">issue #10381</a>:</p>
<blockquote>
<p>My problem is the callback function registered with <code>wasmtime_linker_define_func</code>, the <code>params</code> can't parse correctly with my zig code. Even the second param's <code>kind</code> field is parse incorrectly.</p>
</blockquote>



<a name="505153801"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310381%20The%20definition%20wasmtime_func_t%20in.../near/505153801" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310381.20The.20definition.20wasmtime_func_t.20in.2E.2E.2E.html#505153801">(Mar 12 2025 at 14:42)</a>:</h4>
<p>TheWaWaR edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/10381#issuecomment-2718130136">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10381">issue #10381</a>:</p>
<blockquote>
<p>My problem is the callback function registered with <code>wasmtime_linker_define_func</code>, the <code>params</code> can't read correctly with my zig code. Even the second param's <code>kind</code> field is incorrect.</p>
</blockquote>



<a name="505154611"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310381%20The%20definition%20wasmtime_func_t%20in.../near/505154611" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310381.20The.20definition.20wasmtime_func_t.20in.2E.2E.2E.html#505154611">(Mar 12 2025 at 14:45)</a>:</h4>
<p>TheWaWaR edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/10381#issuecomment-2718130136">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10381">issue #10381</a>:</p>
<blockquote>
<p>My problem is the callback function registered with <code>wasmtime_linker_define_func</code>, the <code>params</code> can't read correctly with my zig code. Even the second param's <code>kind</code> field is incorrect.</p>
<p><div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="kr">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="n">getKeyboardState</span><span class="p">(</span>
<span class="w">    </span><span class="n">env</span><span class="o">:</span><span class="w"> </span><span class="o">*</span><span class="n">anyopaque</span><span class="p">,</span>
<span class="w">    </span><span class="n">caller</span><span class="o">:</span><span class="w"> </span><span class="o">*</span><span class="n">anyopaque</span><span class="p">,</span>
<span class="w">    </span><span class="n">args</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="kr">const</span><span class="w"> </span><span class="n">Value</span><span class="p">,</span>
<span class="w">    </span><span class="n">nargs</span><span class="o">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span>
<span class="w">    </span><span class="n">results</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="n">Value</span><span class="p">,</span>
<span class="w">    </span><span class="n">nresults</span><span class="o">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="n">callconv</span><span class="p">(.</span><span class="n">C</span><span class="p">)</span><span class="w"> </span><span class="o">?*</span><span class="n">anyopaque</span><span class="w"> </span><span class="p">{}</span>

<span class="kr">pub</span><span class="w"> </span><span class="kr">const</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">extern</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">kind</span><span class="o">:</span><span class="w"> </span><span class="n">ValueKind</span><span class="p">,</span>
<span class="w">    </span><span class="n">of</span><span class="o">:</span><span class="w"> </span><span class="n">ValueUnion</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1">// wasmtime/val.h: wasmtime_valunion_t</span>
<span class="kr">pub</span><span class="w"> </span><span class="kr">const</span><span class="w"> </span><span class="n">ValueUnion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">extern</span><span class="w"> </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">i32</span><span class="o">:</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span>
<span class="w">    </span><span class="kt">i64</span><span class="o">:</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span>
<span class="w">    </span><span class="kt">f32</span><span class="o">:</span><span class="w"> </span><span class="kt">f32</span><span class="p">,</span>
<span class="w">    </span><span class="kt">f64</span><span class="o">:</span><span class="w"> </span><span class="kt">f64</span><span class="p">,</span>
<span class="w">    </span><span class="n">anyref</span><span class="o">:</span><span class="w"> </span><span class="kt">u128</span><span class="p">,</span>
<span class="w">    </span><span class="n">externref</span><span class="o">:</span><span class="w"> </span><span class="kt">u128</span><span class="p">,</span>
<span class="w">    </span><span class="n">funcref</span><span class="o">:</span><span class="w"> </span><span class="kt">u128</span><span class="p">,</span>
<span class="w">    </span><span class="n">v128</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="mi">16</span><span class="p">]</span><span class="kt">u8</span><span class="p">,</span>
<span class="p">};</span>

<span class="c1">// wasmtime/val.h: wasmtime_valkind_t</span>
<span class="kr">pub</span><span class="w"> </span><span class="kr">const</span><span class="w"> </span><span class="n">ValueKind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">enum</span><span class="p">(</span><span class="kt">u8</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">i32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="kt">i64</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
<span class="w">    </span><span class="kt">f64</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span>
<span class="w">    </span><span class="n">v128</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span>
<span class="w">    </span><span class="n">funcref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span>
<span class="w">    </span><span class="n">externref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span>
<span class="w">    </span><span class="n">anyref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div><br>
</p>
</blockquote>



<a name="505154859"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310381%20The%20definition%20wasmtime_func_t%20in.../near/505154859" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310381.20The.20definition.20wasmtime_func_t.20in.2E.2E.2E.html#505154859">(Mar 12 2025 at 14:46)</a>:</h4>
<p>TheWaWaR edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/10381#issuecomment-2718130136">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10381">issue #10381</a>:</p>
<blockquote>
<p>My problem is the callback function registered with <code>wasmtime_linker_define_func</code>, the <code>params</code> can't read correctly with my zig code. Even the second param's <code>kind</code> field is incorrect. (other arguments in the callback function is ok.)</p>
<p><div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="kr">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="n">getKeyboardState</span><span class="p">(</span>
<span class="w">    </span><span class="n">env</span><span class="o">:</span><span class="w"> </span><span class="o">*</span><span class="n">anyopaque</span><span class="p">,</span>
<span class="w">    </span><span class="n">caller</span><span class="o">:</span><span class="w"> </span><span class="o">*</span><span class="n">anyopaque</span><span class="p">,</span>
<span class="w">    </span><span class="n">args</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="kr">const</span><span class="w"> </span><span class="n">Value</span><span class="p">,</span>
<span class="w">    </span><span class="n">nargs</span><span class="o">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span>
<span class="w">    </span><span class="n">results</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="n">Value</span><span class="p">,</span>
<span class="w">    </span><span class="n">nresults</span><span class="o">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="n">callconv</span><span class="p">(.</span><span class="n">C</span><span class="p">)</span><span class="w"> </span><span class="o">?*</span><span class="n">anyopaque</span><span class="w"> </span><span class="p">{}</span>

<span class="kr">pub</span><span class="w"> </span><span class="kr">const</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">extern</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">kind</span><span class="o">:</span><span class="w"> </span><span class="n">ValueKind</span><span class="p">,</span>
<span class="w">    </span><span class="n">of</span><span class="o">:</span><span class="w"> </span><span class="n">ValueUnion</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1">// wasmtime/val.h: wasmtime_valunion_t</span>
<span class="kr">pub</span><span class="w"> </span><span class="kr">const</span><span class="w"> </span><span class="n">ValueUnion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">extern</span><span class="w"> </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">i32</span><span class="o">:</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span>
<span class="w">    </span><span class="kt">i64</span><span class="o">:</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span>
<span class="w">    </span><span class="kt">f32</span><span class="o">:</span><span class="w"> </span><span class="kt">f32</span><span class="p">,</span>
<span class="w">    </span><span class="kt">f64</span><span class="o">:</span><span class="w"> </span><span class="kt">f64</span><span class="p">,</span>
<span class="w">    </span><span class="n">anyref</span><span class="o">:</span><span class="w"> </span><span class="kt">u128</span><span class="p">,</span>
<span class="w">    </span><span class="n">externref</span><span class="o">:</span><span class="w"> </span><span class="kt">u128</span><span class="p">,</span>
<span class="w">    </span><span class="n">funcref</span><span class="o">:</span><span class="w"> </span><span class="kt">u128</span><span class="p">,</span>
<span class="w">    </span><span class="n">v128</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="mi">16</span><span class="p">]</span><span class="kt">u8</span><span class="p">,</span>
<span class="p">};</span>

<span class="c1">// wasmtime/val.h: wasmtime_valkind_t</span>
<span class="kr">pub</span><span class="w"> </span><span class="kr">const</span><span class="w"> </span><span class="n">ValueKind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">enum</span><span class="p">(</span><span class="kt">u8</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">i32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="kt">i64</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
<span class="w">    </span><span class="kt">f64</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span>
<span class="w">    </span><span class="n">v128</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span>
<span class="w">    </span><span class="n">funcref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span>
<span class="w">    </span><span class="n">externref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span>
<span class="w">    </span><span class="n">anyref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div><br>
</p>
</blockquote>



<a name="505155291"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310381%20The%20definition%20wasmtime_func_t%20in.../near/505155291" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310381.20The.20definition.20wasmtime_func_t.20in.2E.2E.2E.html#505155291">(Mar 12 2025 at 14:47)</a>:</h4>
<p>TheWaWaR edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/10381#issuecomment-2718130136">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10381">issue #10381</a>:</p>
<blockquote>
<p>My problem is the callback function registered with <code>wasmtime_linker_define_func</code>, the <code>params</code>/<code>results</code> can't read correctly with my zig code. Even the second param's <code>kind</code> field is incorrect. (other arguments in the callback function is ok.)</p>
<p><div class="codehilite" data-code-language="Zig"><pre><span></span><code><span class="kr">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="n">getKeyboardState</span><span class="p">(</span>
<span class="w">    </span><span class="n">env</span><span class="o">:</span><span class="w"> </span><span class="o">*</span><span class="n">anyopaque</span><span class="p">,</span>
<span class="w">    </span><span class="n">caller</span><span class="o">:</span><span class="w"> </span><span class="o">*</span><span class="n">anyopaque</span><span class="p">,</span>
<span class="w">    </span><span class="n">args</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="kr">const</span><span class="w"> </span><span class="n">Value</span><span class="p">,</span>
<span class="w">    </span><span class="n">nargs</span><span class="o">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span>
<span class="w">    </span><span class="n">results</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="n">Value</span><span class="p">,</span>
<span class="w">    </span><span class="n">nresults</span><span class="o">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="n">callconv</span><span class="p">(.</span><span class="n">C</span><span class="p">)</span><span class="w"> </span><span class="o">?*</span><span class="n">anyopaque</span><span class="w"> </span><span class="p">{}</span>

<span class="kr">pub</span><span class="w"> </span><span class="kr">const</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">extern</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">kind</span><span class="o">:</span><span class="w"> </span><span class="n">ValueKind</span><span class="p">,</span>
<span class="w">    </span><span class="n">of</span><span class="o">:</span><span class="w"> </span><span class="n">ValueUnion</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1">// wasmtime/val.h: wasmtime_valunion_t</span>
<span class="kr">pub</span><span class="w"> </span><span class="kr">const</span><span class="w"> </span><span class="n">ValueUnion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kr">extern</span><span class="w"> </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">i32</span><span class="o">:</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span>
<span class="w">    </span><span class="kt">i64</span><span class="o">:</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span>
<span class="w">    </span><span class="kt">f32</span><span class="o">:</span><span class="w"> </span><span class="kt">f32</span><span class="p">,</span>
<span class="w">    </span><span class="kt">f64</span><span class="o">:</span><span class="w"> </span><span class="kt">f64</span><span class="p">,</span>
<span class="w">    </span><span class="n">anyref</span><span class="o">:</span><span class="w"> </span><span class="kt">u128</span><span class="p">,</span>
<span class="w">    </span><span class="n">externref</span><span class="o">:</span><span class="w"> </span><span class="kt">u128</span><span class="p">,</span>
<span class="w">    </span><span class="n">funcref</span><span class="o">:</span><span class="w"> </span><span class="kt">u128</span><span class="p">,</span>
<span class="w">    </span><span class="n">v128</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="mi">16</span><span class="p">]</span><span class="kt">u8</span><span class="p">,</span>
<span class="p">};</span>

<span class="c1">// wasmtime/val.h: wasmtime_valkind_t</span>
<span class="kr">pub</span><span class="w"> </span><span class="kr">const</span><span class="w"> </span><span class="n">ValueKind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">enum</span><span class="p">(</span><span class="kt">u8</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">i32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="kt">i64</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="kt">f32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
<span class="w">    </span><span class="kt">f64</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span>
<span class="w">    </span><span class="n">v128</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span>
<span class="w">    </span><span class="n">funcref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span>
<span class="w">    </span><span class="n">externref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span>
<span class="w">    </span><span class="n">anyref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span>
<span class="p">};</span>
</code></pre></div><br>
</p>
</blockquote>



<a name="505156985"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310381%20The%20definition%20wasmtime_func_t%20in.../near/505156985" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310381.20The.20definition.20wasmtime_func_t.20in.2E.2E.2E.html#505156985">(Mar 12 2025 at 14:53)</a>:</h4>
<p>TheWaWaR <a href="https://github.com/bytecodealliance/wasmtime/issues/10381#issuecomment-2718166455">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10381">issue #10381</a>:</p>
<blockquote>
<p>I have tried print the value in <code>c_callback_to_rust_fn</code>, <code>params.as_ptr().addr()</code> matched the value in my zig code, so I guess it's a problem of data structure definition.</p>
</blockquote>



<a name="505157308"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310381%20The%20definition%20wasmtime_func_t%20in.../near/505157308" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310381.20The.20definition.20wasmtime_func_t.20in.2E.2E.2E.html#505157308">(Mar 12 2025 at 14:54)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/10381#issuecomment-2718169356">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10381">issue #10381</a>:</p>
<blockquote>
<p>Sorry but I'm not familiar enough with Zig to know what I'm looking at there. Can you reduce your problem to being expressed in terms of the C API? One thing I see is that the definition of <code>ValueUnion</code> probably isn't correct sice the alignment of <code>u128</code> isn't the same as <code>wasmtime_func_t</code>.</p>
<p>Otherwise if you're using Zig there aren't official bindings to Wasmtime available in Zig so you're going to be kind of on your own for support. If you would like support here you'll most likely need to frame your problem in terms of C as opposed to Zig as otherwise you're unlikely to be able to get much help.</p>
</blockquote>



<a name="505157383"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310381%20The%20definition%20wasmtime_func_t%20in.../near/505157383" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310381.20The.20definition.20wasmtime_func_t.20in.2E.2E.2E.html#505157383">(Mar 12 2025 at 14:54)</a>:</h4>
<p>TheWaWaR edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/10381#issuecomment-2718166455">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10381">issue #10381</a>:</p>
<blockquote>
<p>I have tried print the value in <code>c_callback_to_rust_fn</code>:</p>
<ul>
<li>The type/value in <code>vals</code> before passing into callback function is correct.</li>
<li><code>params.as_ptr().addr()</code> matched the value in my zig code<br>
so I guess it's a problem of data structure definition.</li>
</ul>
</blockquote>



<a name="505157435"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310381%20The%20definition%20wasmtime_func_t%20in.../near/505157435" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310381.20The.20definition.20wasmtime_func_t.20in.2E.2E.2E.html#505157435">(Mar 12 2025 at 14:55)</a>:</h4>
<p>TheWaWaR edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/10381#issuecomment-2718166455">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10381">issue #10381</a>:</p>
<blockquote>
<p>I have tried print the value in <code>c_callback_to_rust_fn</code>:</p>
<ul>
<li>The type/value in <code>vals</code> before passing into callback function is correct.</li>
<li><code>params.as_ptr().addr()</code> matched the value in my zig code<br>
*<br>
so I guess it's a problem of data structure definition.</li>
</ul>
</blockquote>



<a name="505157497"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310381%20The%20definition%20wasmtime_func_t%20in.../near/505157497" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310381.20The.20definition.20wasmtime_func_t.20in.2E.2E.2E.html#505157497">(Mar 12 2025 at 14:55)</a>:</h4>
<p>TheWaWaR edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/10381#issuecomment-2718166455">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10381">issue #10381</a>:</p>
<blockquote>
<p>I have tried print the value in <code>c_callback_to_rust_fn</code>:</p>
<ul>
<li>The type/value in <code>vals</code> before passing into callback function is correct.</li>
<li><code>params.as_ptr().addr()</code> matched the value in my zig code</li>
</ul>
<p>so I guess it's a problem of data structure definition.</p>
</blockquote>



<a name="505185036"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310381%20The%20definition%20wasmtime_func_t%20in.../near/505185036" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310381.20The.20definition.20wasmtime_func_t.20in.2E.2E.2E.html#505185036">(Mar 12 2025 at 16:25)</a>:</h4>
<p>TheWaWaR closed <a href="https://github.com/bytecodealliance/wasmtime/issues/10381">issue #10381</a>:</p>
<blockquote>
<p>The <code>wasmtime_func_t</code> in <code>wasmtime /extern.h</code> is</p>
<div class="codehilite" data-code-language="C"><pre><span></span><code><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">wasmtime_func</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">store_id</span><span class="p">;</span>
<span class="w">  </span><span class="kt">size_t</span><span class="w"> </span><span class="n">__private</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">wasmtime_func_t</span><span class="p">;</span>
</code></pre></div>
<p>But in rust code (crates/c-api/src/val.rs):</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">#[repr(C)]</span>
<span class="cp">#[derive(Clone, Copy)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">union</span><span class="w"> </span><span class="nc">wasmtime_func_t</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">store_id</span><span class="p">:</span><span class="w"> </span><span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="n">func</span><span class="p">:</span><span class="w"> </span><span class="nc">Func</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Copy, Clone, Debug)]</span>
<span class="cp">#[repr(transparent)]</span><span class="w"> </span><span class="c1">// here for the C API</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">Func</span><span class="p">(</span><span class="n">Stored</span><span class="o">&lt;</span><span class="n">FuncData</span><span class="o">&gt;</span><span class="p">);</span>

<span class="cp">#[repr(C)]</span><span class="w"> </span><span class="c1">// used by reference in the C API, also in `wasmtime_func_t`.</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">Stored</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">store_id</span><span class="p">:</span><span class="w"> </span><span class="nc">StoreId</span><span class="p">,</span>
<span class="w">    </span><span class="n">index</span><span class="p">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span>
<span class="w">    </span><span class="n">_marker</span><span class="p">:</span><span class="w"> </span><span class="nc">marker</span><span class="p">::</span><span class="n">PhantomData</span><span class="o">&lt;</span><span class="k">fn</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">T</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>
<p>The size of wasmtime_func_t in C is 16 bytes, but the size in rust is 24 bytes, which include 2 <code>store_id</code> fields.</p>
<p>As a consequence, the type <code>wasmtime_val_union</code> in Rust can't align with the type <code>wasmtime_valunion_t</code> in C.</p>
</blockquote>



<a name="505185038"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310381%20The%20definition%20wasmtime_func_t%20in.../near/505185038" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310381.20The.20definition.20wasmtime_func_t.20in.2E.2E.2E.html#505185038">(Mar 12 2025 at 16:25)</a>:</h4>
<p>TheWaWaR <a href="https://github.com/bytecodealliance/wasmtime/issues/10381#issuecomment-2718447160">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10381">issue #10381</a>:</p>
<blockquote>
<p>I tested it in C, it's ok. You are right, I think the problem is the alignment of <code>u128</code>.</p>
</blockquote>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
<html>
<head><meta charset="utf-8"><title>wasmtime / PR #11128 x64: Add lowerings for the `bt` inst... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311128.20x64.3A.20Add.20lowerings.20for.20the.20.60bt.60.20inst.2E.2E.2E.html">wasmtime / PR #11128 x64: Add lowerings for the `bt` inst...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="525565452"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311128%20x64%3A%20Add%20lowerings%20for%20the%20%60bt%60%20inst.../near/525565452" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311128.20x64.3A.20Add.20lowerings.20for.20the.20.60bt.60.20inst.2E.2E.2E.html#525565452">(Jun 24 2025 at 17:34)</a>:</h4>
<p>alexcrichton opened <a href="https://github.com/bytecodealliance/wasmtime/pull/11128">PR #11128</a> from <code>alexcrichton:x64-bt</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>This commit builds on the previous refactorings to leverage the <code>bt</code> instruction on x64 which moves a specific bit into the CF bit of EFLAGS which can be useful for comparisons/branches/selects/etc.</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="525565453"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311128%20x64%3A%20Add%20lowerings%20for%20the%20%60bt%60%20inst.../near/525565453" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311128.20x64.3A.20Add.20lowerings.20for.20the.20.60bt.60.20inst.2E.2E.2E.html#525565453">(Jun 24 2025 at 17:34)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/11128">PR #11128</a>.</p>



<a name="525565454"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311128%20x64%3A%20Add%20lowerings%20for%20the%20%60bt%60%20inst.../near/525565454" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311128.20x64.3A.20Add.20lowerings.20for.20the.20.60bt.60.20inst.2E.2E.2E.html#525565454">(Jun 24 2025 at 17:34)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers">wasmtime-core-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/11128">PR #11128</a>.</p>



<a name="525565455"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311128%20x64%3A%20Add%20lowerings%20for%20the%20%60bt%60%20inst.../near/525565455" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311128.20x64.3A.20Add.20lowerings.20for.20the.20.60bt.60.20inst.2E.2E.2E.html#525565455">(Jun 24 2025 at 17:34)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/fitzgen">fitzgen</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/11128">PR #11128</a>.</p>



<a name="525583484"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311128%20x64%3A%20Add%20lowerings%20for%20the%20%60bt%60%20inst.../near/525583484" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311128.20x64.3A.20Add.20lowerings.20for.20the.20.60bt.60.20inst.2E.2E.2E.html#525583484">(Jun 24 2025 at 19:38)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11128#pullrequestreview-2955066247">PR review</a>.</p>



<a name="525583486"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311128%20x64%3A%20Add%20lowerings%20for%20the%20%60bt%60%20inst.../near/525583486" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311128.20x64.3A.20Add.20lowerings.20for.20the.20.60bt.60.20inst.2E.2E.2E.html#525583486">(Jun 24 2025 at 19:38)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/11128#discussion_r2164750330">PR review comment</a>:</p>
<blockquote>
<p>Do we expect this to use a <code>bt</code> instruction? If not, then why not?</p>
</blockquote>



<a name="525583488"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311128%20x64%3A%20Add%20lowerings%20for%20the%20%60bt%60%20inst.../near/525583488" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311128.20x64.3A.20Add.20lowerings.20for.20the.20.60bt.60.20inst.2E.2E.2E.html#525583488">(Jun 24 2025 at 19:38)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/11128#discussion_r2164756127">PR review comment</a>:</p>
<blockquote>
<p>Slightly easier to understand, for me at least, like this:</p>
<p><div class="codehilite" data-code-language="suggestion"><pre><span></span><code>        if val.count_ones() == 1 {
            Some(u8::try_from(val.trailing_zeros()).unwrap())
        } else {
            None
        }
</code></pre></div><br>
</p>
</blockquote>



<a name="525583489"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311128%20x64%3A%20Add%20lowerings%20for%20the%20%60bt%60%20inst.../near/525583489" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311128.20x64.3A.20Add.20lowerings.20for.20the.20.60bt.60.20inst.2E.2E.2E.html#525583489">(Jun 24 2025 at 19:38)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/11128#discussion_r2164750752">PR review comment</a>:</p>
<blockquote>
<p>Same here?</p>
</blockquote>



<a name="525592539"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311128%20x64%3A%20Add%20lowerings%20for%20the%20%60bt%60%20inst.../near/525592539" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311128.20x64.3A.20Add.20lowerings.20for.20the.20.60bt.60.20inst.2E.2E.2E.html#525592539">(Jun 24 2025 at 20:45)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11128">PR #11128</a>.</p>



<a name="525592631"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311128%20x64%3A%20Add%20lowerings%20for%20the%20%60bt%60%20inst.../near/525592631" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311128.20x64.3A.20Add.20lowerings.20for.20the.20.60bt.60.20inst.2E.2E.2E.html#525592631">(Jun 24 2025 at 20:46)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/11128#issuecomment-3001813416">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11128">PR #11128</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @cfallin, @fitzgen</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "cranelift", "cranelift:area:x64", "isle"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>cfallin: isle</li>
<li>fitzgen: isle</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="525592823"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311128%20x64%3A%20Add%20lowerings%20for%20the%20%60bt%60%20inst.../near/525592823" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311128.20x64.3A.20Add.20lowerings.20for.20the.20.60bt.60.20inst.2E.2E.2E.html#525592823">(Jun 24 2025 at 20:47)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11128#pullrequestreview-2955281432">PR review</a>.</p>



<a name="525592824"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311128%20x64%3A%20Add%20lowerings%20for%20the%20%60bt%60%20inst.../near/525592824" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311128.20x64.3A.20Add.20lowerings.20for.20the.20.60bt.60.20inst.2E.2E.2E.html#525592824">(Jun 24 2025 at 20:47)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/11128#discussion_r2164872267">PR review comment</a>:</p>
<blockquote>
<p>It's intentional yeah, and corresponds to <a href="https://github.com/bytecodealliance/wasmtime/pull/11128/files#diff-5921dd103c30cf61da9e9befccac790585d04b0d2abe56c8f87f84816eba5676R4295-R4299">this lowering rule</a>. My rationale is "LLVM is <a href="https://godbolt.org/z/frsh7s1cT">probably smarter than I</a>" and I'm assuming LLVM did things like micro-op tests or something to figure out that <code>test</code> has a lower latency than <code>bt</code> or something like that. No idea if that's actually the case though, just mirroring them.</p>
</blockquote>



<a name="525594414"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311128%20x64%3A%20Add%20lowerings%20for%20the%20%60bt%60%20inst.../near/525594414" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311128.20x64.3A.20Add.20lowerings.20for.20the.20.60bt.60.20inst.2E.2E.2E.html#525594414">(Jun 24 2025 at 20:58)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11128#pullrequestreview-2955307208">PR review</a>.</p>



<a name="525594415"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311128%20x64%3A%20Add%20lowerings%20for%20the%20%60bt%60%20inst.../near/525594415" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311128.20x64.3A.20Add.20lowerings.20for.20the.20.60bt.60.20inst.2E.2E.2E.html#525594415">(Jun 24 2025 at 20:58)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/11128#discussion_r2164888415">PR review comment</a>:</p>
<blockquote>
<p>According to <a href="https://www.agner.org/optimize/instruction_tables.pdf">Agner Fog's tables</a>, taking Skylake as a random reasonable baseline µarch, <code>test</code> has one cycle latency and a throughput of 4/cycle (four ALU ports can execute it) while <code>bt</code> has one cycle latency and a throughput of 2/cycle (two ALU ports can execute it). So probably reasonable to prefer <code>test</code> to <code>bt</code> where possible.</p>
</blockquote>



<a name="525596954"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311128%20x64%3A%20Add%20lowerings%20for%20the%20%60bt%60%20inst.../near/525596954" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311128.20x64.3A.20Add.20lowerings.20for.20the.20.60bt.60.20inst.2E.2E.2E.html#525596954">(Jun 24 2025 at 21:19)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11128#pullrequestreview-2955376170">PR review</a>.</p>



<a name="525596956"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311128%20x64%3A%20Add%20lowerings%20for%20the%20%60bt%60%20inst.../near/525596956" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311128.20x64.3A.20Add.20lowerings.20for.20the.20.60bt.60.20inst.2E.2E.2E.html#525596956">(Jun 24 2025 at 21:19)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/11128#discussion_r2164930235">PR review comment</a>:</p>
<blockquote>
<p>Nice that sounds like an excellent reference to put as documentation in the lowering rules so I'll do that.</p>
</blockquote>



<a name="525607665"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311128%20x64%3A%20Add%20lowerings%20for%20the%20%60bt%60%20inst.../near/525607665" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311128.20x64.3A.20Add.20lowerings.20for.20the.20.60bt.60.20inst.2E.2E.2E.html#525607665">(Jun 24 2025 at 22:56)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11128">PR #11128</a>.</p>



<a name="525734187"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311128%20x64%3A%20Add%20lowerings%20for%20the%20%60bt%60%20inst.../near/525734187" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311128.20x64.3A.20Add.20lowerings.20for.20the.20.60bt.60.20inst.2E.2E.2E.html#525734187">(Jun 25 2025 at 15:06)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11128#pullrequestreview-2958581944">PR review</a>:</p>
<blockquote>
<p>Thanks!</p>
</blockquote>



<a name="525738814"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311128%20x64%3A%20Add%20lowerings%20for%20the%20%60bt%60%20inst.../near/525738814" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311128.20x64.3A.20Add.20lowerings.20for.20the.20.60bt.60.20inst.2E.2E.2E.html#525738814">(Jun 25 2025 at 15:29)</a>:</h4>
<p>fitzgen merged <a href="https://github.com/bytecodealliance/wasmtime/pull/11128">PR #11128</a>.</p>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
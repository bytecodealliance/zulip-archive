<html>
<head><meta charset="utf-8"><title>wasmtime / issue #11342 wasip3: Closing a socket resource... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311342.20wasip3.3A.20Closing.20a.20socket.20resource.2E.2E.2E.html">wasmtime / issue #11342 wasip3: Closing a socket resource...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="531717196"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311342%20wasip3%3A%20Closing%20a%20socket%20resource.../near/531717196" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311342.20wasip3.3A.20Closing.20a.20socket.20resource.2E.2E.2E.html#531717196">(Jul 29 2025 at 23:38)</a>:</h4>
<p>alexcrichton opened <a href="https://github.com/bytecodealliance/wasmtime/issues/11342">issue #11342</a>:</p>
<blockquote>
<p>Currently there is liberal use of <code>Arc&lt;...&gt;</code> in the WASIp3 <code>wasi:sockets</code> implementation which is used for sharing sockets between tasks which are used to implement streams. One example is that a stream of clients can be extracted from a TCP listener, meaning that the underlying socket is now shared between the original TCP listener resource and the stream that is reading clients. The consequence of this implementation is that when the resource is closed it does not mean that the actual socket is itself closed. For example the OS-level port remains reserved until the task for accepted clients also exits. While the tasks will "promptly exit" there is currently no reliable mechanism to await this happening.</p>
<p>This leads to tests for REUSEADDR, for example, having a loop around re-binding a port and asserting it's successful. This test is being added in <a href="https://github.com/bytecodealliance/wasmtime/pull/11291">https://github.com/bytecodealliance/wasmtime/pull/11291</a>.</p>
</blockquote>



<a name="531717197"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311342%20wasip3%3A%20Closing%20a%20socket%20resource.../near/531717197" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311342.20wasip3.3A.20Closing.20a.20socket.20resource.2E.2E.2E.html#531717197">(Jul 29 2025 at 23:38)</a>:</h4>
<p><a href="https://github.com/alexcrichton">alexcrichton</a> added the wasi:impl label to <a href="https://github.com/bytecodealliance/wasmtime/issues/11342">Issue #11342</a>.</p>



<a name="531717198"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311342%20wasip3%3A%20Closing%20a%20socket%20resource.../near/531717198" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311342.20wasip3.3A.20Closing.20a.20socket.20resource.2E.2E.2E.html#531717198">(Jul 29 2025 at 23:38)</a>:</h4>
<p><a href="https://github.com/alexcrichton">alexcrichton</a> added the wasm-proposal:component-model-async label to <a href="https://github.com/bytecodealliance/wasmtime/issues/11342">Issue #11342</a>.</p>



<a name="533794936"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311342%20wasip3%3A%20Closing%20a%20socket%20resource.../near/533794936" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311342.20wasip3.3A.20Closing.20a.20socket.20resource.2E.2E.2E.html#533794936">(Aug 11 2025 at 13:30)</a>:</h4>
<p>rvolosatovs <a href="https://github.com/bytecodealliance/wasmtime/issues/11342#issuecomment-3174860894">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11342">issue #11342</a>:</p>
<blockquote>
<p>One thing that is currently missing in the implementation is the receive/listen task cancellation on socket drop, i.e. <code>receive</code> and <code>listen</code> should store the <code>AbortHandle</code> in the socket state and abort these tasks once the socket is dropped.</p>
<p>I spent some time on it just now, but I don't really see a nice way to integrate this with the <code>start_receive</code> etc. abstractions without making <code>TcpState</code> field public again, @alexcrichton could you handle this?</p>
<p>I don't know if that would necessarily fix this issue, but it's something we should do anyway. For reference, here's the documentation of <code>wasi:http</code> for a similar construct: <a href="https://github.com/WebAssembly/wasi-http/blob/ad500ba30bdfd57e04bdabdcd0480111681bf017/wit-0.3.0-draft/types.wit#L420-L423">https://github.com/WebAssembly/wasi-http/blob/ad500ba30bdfd57e04bdabdcd0480111681bf017/wit-0.3.0-draft/types.wit#L420-L423</a></p>
</blockquote>



<a name="533795121"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311342%20wasip3%3A%20Closing%20a%20socket%20resource.../near/533795121" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311342.20wasip3.3A.20Closing.20a.20socket.20resource.2E.2E.2E.html#533795121">(Aug 11 2025 at 13:31)</a>:</h4>
<p>rvolosatovs edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/11342#issuecomment-3174860894">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11342">issue #11342</a>:</p>
<blockquote>
<p>One thing that is currently missing in the implementation is the receive/listen task cancellation on socket drop, i.e. <code>receive</code> and <code>listen</code> should store the <code>AbortHandle</code> in the socket state and abort these tasks once the socket is dropped.</p>
<p>I spent some time on it just now, but I don't really see a nice way to integrate this with the <code>start_receive</code> etc. abstractions without making <code>TcpState</code> field public again, @alexcrichton could you handle this?</p>
<p>I've implemented this for filesystem though: <a href="https://github.com/bytecodealliance/wasmtime/pull/11406/commits/40415b52f79a33c376a2a875ffecb1d0a01c7903">https://github.com/bytecodealliance/wasmtime/pull/11406/commits/40415b52f79a33c376a2a875ffecb1d0a01c7903</a></p>
<p>I don't know if that would necessarily fix this issue, but it's something we should do anyway. For reference, here's the documentation of <code>wasi:http</code> for a similar construct: <a href="https://github.com/WebAssembly/wasi-http/blob/ad500ba30bdfd57e04bdabdcd0480111681bf017/wit-0.3.0-draft/types.wit#L420-L423">https://github.com/WebAssembly/wasi-http/blob/ad500ba30bdfd57e04bdabdcd0480111681bf017/wit-0.3.0-draft/types.wit#L420-L423</a></p>
</blockquote>



<a name="533795446"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311342%20wasip3%3A%20Closing%20a%20socket%20resource.../near/533795446" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311342.20wasip3.3A.20Closing.20a.20socket.20resource.2E.2E.2E.html#533795446">(Aug 11 2025 at 13:33)</a>:</h4>
<p>rvolosatovs edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/11342#issuecomment-3174860894">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11342">issue #11342</a>:</p>
<blockquote>
<p>One thing that is currently missing in the implementation is the receive/listen task cancellation on socket drop, i.e. <code>receive</code> and <code>listen</code> should store the <code>AbortHandle</code> in the socket state and abort these tasks once the socket is dropped.</p>
<p>I spent some time on it just now, but I don't really see a nice way to integrate this with the <code>start_receive</code> etc. abstractions without making <code>TcpState</code> field public again, @alexcrichton could you handle this?</p>
<p>I've implemented this for filesystem though: <a href="https://github.com/bytecodealliance/wasmtime/pull/11406/commits/40415b52f79a33c376a2a875ffecb1d0a01c7903">https://github.com/bytecodealliance/wasmtime/pull/11406/commits/40415b52f79a33c376a2a875ffecb1d0a01c7903</a></p>
<p>I don't know if that would necessarily fix this issue, but it's something we should do anyway. For reference, here's the documentation of <code>wasi:http</code> for a similar construct: <a href="https://github.com/WebAssembly/wasi-http/blob/ad500ba30bdfd57e04bdabdcd0480111681bf017/wit-0.3.0-draft/types.wit#L420-L423">https://github.com/WebAssembly/wasi-http/blob/ad500ba30bdfd57e04bdabdcd0480111681bf017/wit-0.3.0-draft/types.wit#L420-L423</a></p>
<p>For reference, here's the in-progress diff, if it helps:</p>
<p><div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gh">diff --git a/crates/wasi/src/p3/sockets/host/types/tcp.rs b/crates/wasi/src/p3/sockets/host/types/tcp.rs</span>
<span class="gh">index 66314d5372..a2bf1ff0c1 100644</span>
<span class="gd">--- a/crates/wasi/src/p3/sockets/host/types/tcp.rs</span>
<span class="gi">+++ b/crates/wasi/src/p3/sockets/host/types/tcp.rs</span>
<span class="gu">@@ -266,11 +266,12 @@ impl HostTcpSocketWithStore for WasiSockets {</span>
<span class="w"> </span>                    let (result_tx, result_rx) = instance
<span class="w"> </span>                        .future(&amp;mut view, || unreachable!())
<span class="w"> </span>                        .context("failed to create future")?;
<span class="gd">-                    view.spawn(ReceiveTask {</span>
<span class="gi">+                    let task = view.spawn(ReceiveTask {</span>
<span class="w"> </span>                        stream,
<span class="w"> </span>                        data_tx,
<span class="w"> </span>                        result_tx,
<span class="w"> </span>                    });
<span class="gi">+                    socket.set_p3_receive_task(task);</span>
<span class="w"> </span>                    Ok((data_rx, result_rx))
<span class="w"> </span>                }
<span class="w"> </span>                None =&gt; {
<span class="gh">diff --git a/crates/wasi/src/sockets/tcp.rs b/crates/wasi/src/sockets/tcp.rs</span>
<span class="gh">index 09dd2ba8de..ff907b356e 100644</span>
<span class="gd">--- a/crates/wasi/src/sockets/tcp.rs</span>
<span class="gi">+++ b/crates/wasi/src/sockets/tcp.rs</span>
<span class="gu">@@ -94,7 +94,10 @@ enum TcpState {</span>
<span class="w"> </span>    ///
<span class="w"> </span>    /// A socket will not transition out of this state.
<span class="w"> </span>    #[cfg(feature = "p3")]
<span class="gd">-    Receiving(Arc&lt;tokio::net::TcpStream&gt;),</span>
<span class="gi">+    Receiving(</span>
<span class="gi">+        Arc&lt;tokio::net::TcpStream&gt;,</span>
<span class="gi">+        Option&lt;wasmtime::component::AbortHandle&gt;,</span>
<span class="gi">+    ),</span>

<span class="w"> </span>    /// This is a WASIp2-bound socket which stores some extra state for
<span class="w"> </span>    /// read/write streams to handle TCP shutdown.
<span class="gu">@@ -239,7 +242,7 @@ impl TcpSocket {</span>
<span class="w"> </span>            | TcpState::ListenStarted(socket) =&gt; Ok(socket.as_socketlike_view()),
<span class="w"> </span>            TcpState::Connected(stream) =&gt; Ok(stream.as_socketlike_view()),
<span class="w"> </span>            #[cfg(feature = "p3")]
<span class="gd">-            TcpState::Receiving(stream) =&gt; Ok(stream.as_socketlike_view()),</span>
<span class="gi">+            TcpState::Receiving(stream, _) =&gt; Ok(stream.as_socketlike_view()),</span>
<span class="w"> </span>            TcpState::Listening { listener, .. } =&gt; Ok(listener.as_socketlike_view()),
<span class="w"> </span>            TcpState::P2Streaming(state) =&gt; Ok(state.stream.as_socketlike_view()),
<span class="w"> </span>            TcpState::Connecting(..) | TcpState::ConnectReady(_) | TcpState::Closed =&gt; {
<span class="gu">@@ -459,7 +462,7 @@ impl TcpSocket {</span>
<span class="w"> </span>    pub(crate) fn start_receive(&amp;mut self) -&gt; Option&lt;&amp;Arc&lt;tokio::net::TcpStream&gt;&gt; {
<span class="w"> </span>        match mem::replace(&amp;mut self.tcp_state, TcpState::Closed) {
<span class="w"> </span>            TcpState::Connected(stream) =&gt; {
<span class="gd">-                self.tcp_state = TcpState::Receiving(stream);</span>
<span class="gi">+                self.tcp_state = TcpState::Receiving(stream, None);</span>
<span class="w"> </span>                Some(self.tcp_stream_arc().unwrap())
<span class="w"> </span>            }
<span class="w"> </span>            prev =&gt; {
<span class="gu">@@ -469,12 +472,26 @@ impl TcpSocket {</span>
<span class="w"> </span>        }
<span class="w"> </span>    }

<span class="gi">+    #[cfg(feature = "p3")]</span>
<span class="gi">+    pub(crate) fn set_p3_receive_task(</span>
<span class="gi">+        &amp;mut self,</span>
<span class="gi">+        task: wasmtime::component::AbortHandle,</span>
<span class="gi">+    ) -&gt; Result&lt;(), ErrorCode&gt; {</span>
<span class="gi">+        match &amp;mut self.tcp_state {</span>
<span class="gi">+            TcpState::Receiving(_, slot @ None) =&gt; {</span>
<span class="gi">+                *slot = Some(task);</span>
<span class="gi">+                Ok(())</span>
<span class="gi">+            }</span>
<span class="gi">+            _ =&gt; Err(ErrorCode::InvalidState),</span>
<span class="gi">+        }</span>
<span class="gi">+    }</span>
<span class="gi">+</span>
<span class="w"> </span>    pub(crate) fn local_address(&amp;self) -&gt; Result&lt;SocketAddr, ErrorCode&gt; {
<span class="w"> </span>        match &amp;self.tcp_state {
<span class="w"> </span>            TcpState::Bound(socket) =&gt; Ok(socket.local_addr()?),
<span class="w"> </span>            TcpState::Connected(stream) =&gt; Ok(stream.local_addr()?),
<span class="w"> </span>            #[cfg(feature = "p3")]
<span class="gd">-            TcpState::Receiving(stream) =&gt; Ok(stream.local_addr()?),</span>
<span class="gi">+            TcpState::Receiving(stream, _) =&gt; Ok(stream.local_addr()?),</span>
<span class="w"> </span>            TcpState::P2Streaming(state) =&gt; Ok(state.stream.local_addr()?),
<span class="w"> </span>            TcpState::Listening { listener, .. } =&gt; Ok(listener.local_addr()?),
<span class="w"> </span>            #[cfg(feature = "p3")]
<span class="gu">@@ -645,7 +662,7 @@ impl TcpSocket {</span>
<span class="w"> </span>        match &amp;self.tcp_state {
<span class="w"> </span>            TcpState::Connected(socket) =&gt; Ok(socket),
<span class="w"> </span>            #[cfg(feature = "p3")]
<span class="gd">-            TcpState::Receiving(socket) =&gt; Ok(socket),</span>
<span class="gi">+            TcpState::Receiving(socket, _) =&gt; Ok(socket),</span>
<span class="w"> </span>            TcpState::P2Streaming(state) =&gt; Ok(&amp;state.stream),
<span class="w"> </span>            #[cfg(feature = "p3")]
<span class="w"> </span>            TcpState::Error(err) =&gt; Err(err.into()),
<span class="gu">@@ -695,7 +712,7 @@ impl TcpSocket {</span>
<span class="w"> </span>            | TcpState::P2Streaming(_) =&gt; {}

<span class="w"> </span>            #[cfg(feature = "p3")]
<span class="gd">-            TcpState::Receiving(_) | TcpState::Error(_) =&gt; {}</span>
<span class="gi">+            TcpState::Receiving(_, _) | TcpState::Error(_) =&gt; {}</span>

<span class="w"> </span>            TcpState::Connecting(Some(future)) =&gt; {
<span class="w"> </span>                self.tcp_state = TcpState::ConnectReady(future.as_mut().await);
</code></pre></div><br>
</p>
</blockquote>



<a name="533848677"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311342%20wasip3%3A%20Closing%20a%20socket%20resource.../near/533848677" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311342.20wasip3.3A.20Closing.20a.20socket.20resource.2E.2E.2E.html#533848677">(Aug 11 2025 at 18:49)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/11342#issuecomment-3176362182">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11342">issue #11342</a>:</p>
<blockquote>
<p>Related issue after our discussion today as well: <a href="https://github.com/WebAssembly/component-model/issues/552">https://github.com/WebAssembly/component-model/issues/552</a></p>
</blockquote>



<a name="534277103"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311342%20wasip3%3A%20Closing%20a%20socket%20resource.../near/534277103" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311342.20wasip3.3A.20Closing.20a.20socket.20resource.2E.2E.2E.html#534277103">(Aug 13 2025 at 17:53)</a>:</h4>
<p>alexcrichton assigned dicej to <a href="https://github.com/bytecodealliance/wasmtime/issues/11342">issue #11342</a>.</p>



<a name="537769213"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311342%20wasip3%3A%20Closing%20a%20socket%20resource.../near/537769213" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311342.20wasip3.3A.20Closing.20a.20socket.20resource.2E.2E.2E.html#537769213">(Sep 04 2025 at 23:17)</a>:</h4>
<p>alexcrichton closed <a href="https://github.com/bytecodealliance/wasmtime/issues/11342">issue #11342</a>:</p>
<blockquote>
<p>Currently there is liberal use of <code>Arc&lt;...&gt;</code> in the WASIp3 <code>wasi:sockets</code> implementation which is used for sharing sockets between tasks which are used to implement streams. One example is that a stream of clients can be extracted from a TCP listener, meaning that the underlying socket is now shared between the original TCP listener resource and the stream that is reading clients. The consequence of this implementation is that when the resource is closed it does not mean that the actual socket is itself closed. For example the OS-level port remains reserved until the task for accepted clients also exits. While the tasks will "promptly exit" there is currently no reliable mechanism to await this happening.</p>
<p>This leads to tests for REUSEADDR, for example, having a loop around re-binding a port and asserting it's successful. This test is being added in <a href="https://github.com/bytecodealliance/wasmtime/pull/11291">https://github.com/bytecodealliance/wasmtime/pull/11291</a>.</p>
</blockquote>



<a name="537769218"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311342%20wasip3%3A%20Closing%20a%20socket%20resource.../near/537769218" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311342.20wasip3.3A.20Closing.20a.20socket.20resource.2E.2E.2E.html#537769218">(Sep 04 2025 at 23:17)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/11342#issuecomment-3256269061">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11342">issue #11342</a>:</p>
<blockquote>
<p>Fixed in <a href="https://github.com/bytecodealliance/wasmtime/pull/11515">https://github.com/bytecodealliance/wasmtime/pull/11515</a></p>
</blockquote>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
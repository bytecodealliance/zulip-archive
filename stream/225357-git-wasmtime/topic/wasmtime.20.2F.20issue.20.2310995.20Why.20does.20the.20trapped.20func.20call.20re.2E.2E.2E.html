<html>
<head><meta charset="utf-8"><title>wasmtime / issue #10995 Why does the trapped func call re... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310995.20Why.20does.20the.20trapped.20func.20call.20re.2E.2E.2E.html">wasmtime / issue #10995 Why does the trapped func call re...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="523245493"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310995%20Why%20does%20the%20trapped%20func%20call%20re.../near/523245493" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310995.20Why.20does.20the.20trapped.20func.20call.20re.2E.2E.2E.html#523245493">(Jun 10 2025 at 09:22)</a>:</h4>
<p>sammyne opened <a href="https://github.com/bytecodealliance/wasmtime/issues/10995">issue #10995</a>:</p>
<blockquote>
<p>I make the simple wasm host as </p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">path</span><span class="p">::</span><span class="n">PathBuf</span><span class="p">;</span>

<span class="k">use</span><span class="w"> </span><span class="n">anyhow</span><span class="p">::</span><span class="n">Context</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">clap</span><span class="p">::</span><span class="n">Parser</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">component</span><span class="p">::{</span><span class="n">Component</span><span class="p">,</span><span class="w"> </span><span class="n">Linker</span><span class="p">,</span><span class="w"> </span><span class="n">Val</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::{</span><span class="n">Config</span><span class="p">,</span><span class="w"> </span><span class="n">Engine</span><span class="p">,</span><span class="w"> </span><span class="n">Store</span><span class="p">,</span><span class="w"> </span><span class="n">Trap</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">WasiCtxBuilder</span><span class="p">;</span>

<span class="k">fn</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">anyhow</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">Cli</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cli</span><span class="p">::</span><span class="n">parse</span><span class="p">();</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span><span class="p">::</span><span class="n">default</span><span class="p">();</span>
<span class="w">    </span><span class="n">config</span><span class="p">.</span><span class="n">wasm_component_model</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Engine</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">config</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Linker</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Add the command world (aka WASI CLI) to the linker</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">add_to_linker_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="p">).</span><span class="n">context</span><span class="p">(</span><span class="s">"link command world"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WasiCtxBuilder</span><span class="p">::</span><span class="n">new</span><span class="p">().</span><span class="n">inherit_stdout</span><span class="p">().</span><span class="n">build_p1</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Store</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">component</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Component</span><span class="p">::</span><span class="n">from_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="n">path</span><span class="p">).</span><span class="n">context</span><span class="p">(</span><span class="s">"Component file not found"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">INTERFACE</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="kt">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"sammyne:helloworld/greeter@1.0.0"</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">FUNC_NAME</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="kt">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"say-hello"</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">linker</span>
<span class="w">        </span><span class="p">.</span><span class="n">instantiate</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">component</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">context</span><span class="p">(</span><span class="s">"instantiate"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// ref: https://docs.rs/wasmtime/30.0.2/wasmtime/component/struct.Instance.html#method.get_func</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">say_hello</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">instance_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instance</span>
<span class="w">            </span><span class="p">.</span><span class="n">get_export</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="nb">None</span><span class="p">,</span><span class="w"> </span><span class="n">INTERFACE</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">with_context</span><span class="p">(</span><span class="o">||</span><span class="w"> </span><span class="fm">format!</span><span class="p">(</span><span class="s">"miss interface: {INTERFACE}"</span><span class="p">))</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">func_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instance</span>
<span class="w">            </span><span class="p">.</span><span class="n">get_export</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance_idx</span><span class="p">),</span><span class="w"> </span><span class="n">FUNC_NAME</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">with_context</span><span class="p">(</span><span class="o">||</span><span class="w"> </span><span class="fm">format!</span><span class="p">(</span><span class="s">"locate func '{FUNC_NAME}'"</span><span class="p">))</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="n">instance</span>
<span class="w">            </span><span class="p">.</span><span class="n">get_func</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">func_idx</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">with_context</span><span class="p">(</span><span class="o">||</span><span class="w"> </span><span class="fm">format!</span><span class="p">(</span><span class="s">"load func '{FUNC_NAME}'"</span><span class="p">))</span><span class="o">?</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="c1">// make name prettry large to trigger OOM on purpose.</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"a"</span><span class="p">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">1024</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1024</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1024</span><span class="p">);</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">new_hello_request</span><span class="p">(</span><span class="n">name</span><span class="p">.</span><span class="n">clone</span><span class="p">())];</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">Val</span><span class="p">::</span><span class="n">Bool</span><span class="p">(</span><span class="kc">false</span><span class="p">)];</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">say_hello</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">results</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nb">Ok</span><span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{}</span>
<span class="w">            </span><span class="nb">Err</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">match</span><span class="w"> </span><span class="n">err</span><span class="p">.</span><span class="n">downcast_ref</span><span class="p">::</span><span class="o">&lt;</span><span class="n">Trap</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nb">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="fm">println!</span><span class="p">(</span><span class="s">"#{i} non-trap err: {err}"</span><span class="p">),</span>
<span class="w">                    </span><span class="nb">Some</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="fm">println!</span><span class="p">(</span><span class="s">"#{i} trap err: {c}</span><span class="se">\n</span><span class="s">{err}"</span><span class="p">),</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">say_hello</span>
<span class="w">            </span><span class="p">.</span><span class="n">post_return</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">with_context</span><span class="p">(</span><span class="o">||</span><span class="w"> </span><span class="fm">format!</span><span class="p">(</span><span class="s">"#{i} post return '{FUNC_NAME}'"</span><span class="p">))</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">say_hello</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">instance_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instance</span>
<span class="w">            </span><span class="p">.</span><span class="n">get_export</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="nb">None</span><span class="p">,</span><span class="w"> </span><span class="n">INTERFACE</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">with_context</span><span class="p">(</span><span class="o">||</span><span class="w"> </span><span class="fm">format!</span><span class="p">(</span><span class="s">"miss interface: {INTERFACE}"</span><span class="p">))</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">func_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instance</span>
<span class="w">            </span><span class="p">.</span><span class="n">get_export</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance_idx</span><span class="p">),</span><span class="w"> </span><span class="n">FUNC_NAME</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">with_context</span><span class="p">(</span><span class="o">||</span><span class="w"> </span><span class="fm">format!</span><span class="p">(</span><span class="s">"locate func '{FUNC_NAME}'"</span><span class="p">))</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="n">instance</span>
<span class="w">            </span><span class="p">.</span><span class="n">get_func</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">func_idx</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">with_context</span><span class="p">(</span><span class="o">||</span><span class="w"> </span><span class="fm">format!</span><span class="p">(</span><span class="s">"load func '{FUNC_NAME}'"</span><span class="p">))</span><span class="o">?</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">new_hello_request</span><span class="p">(</span><span class="n">name</span><span class="p">.</span><span class="n">clone</span><span class="p">())];</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">Val</span><span class="p">::</span><span class="n">Bool</span><span class="p">(</span><span class="kc">false</span><span class="p">)];</span>
<span class="w">    </span><span class="n">say_hello</span>
<span class="w">        </span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">results</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">context</span><span class="p">(</span><span class="s">"call after trap"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"hello world"</span><span class="p">);</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>

<span class="sd">/// A CLI for executing WebAssembly components that</span>
<span class="sd">/// implement the `example` world.</span>
<span class="cp">#[derive(Parser)]</span>
<span class="cp">#[clap(name = </span><span class="s">"hello-world-host"</span><span class="cp">, version = env!(</span><span class="s">"CARGO_PKG_VERSION"</span><span class="cp">))]</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">Cli</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="sd">/// WASM 组件的路径</span>
<span class="w">    </span><span class="cp">#[clap(short, long)]</span>
<span class="w">    </span><span class="n">path</span><span class="p">:</span><span class="w"> </span><span class="nc">PathBuf</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">fn</span><span class="w"> </span><span class="nf">new_hello_request</span><span class="p">(</span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="nb">String</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">Val</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Val</span><span class="p">::</span><span class="n">Record</span><span class="p">(</span><span class="fm">vec!</span><span class="p">[(</span><span class="s">"name"</span><span class="p">.</span><span class="n">to_owned</span><span class="p">(),</span><span class="w"> </span><span class="n">Val</span><span class="p">::</span><span class="nb">String</span><span class="p">(</span><span class="n">name</span><span class="p">))])</span>
<span class="p">}</span>
</code></pre></div><br>
</p>
</blockquote>



<a name="523246289"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310995%20Why%20does%20the%20trapped%20func%20call%20re.../near/523246289" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310995.20Why.20does.20the.20trapped.20func.20call.20re.2E.2E.2E.html#523246289">(Jun 10 2025 at 09:26)</a>:</h4>
<p>sammyne edited <a href="https://github.com/bytecodealliance/wasmtime/issues/10995">issue #10995</a>:</p>
<blockquote>
<p>I make the simple wasm host as </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">path</span><span class="p">::</span><span class="n">PathBuf</span><span class="p">;</span>

<span class="k">use</span><span class="w"> </span><span class="n">anyhow</span><span class="p">::</span><span class="n">Context</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">clap</span><span class="p">::</span><span class="n">Parser</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">component</span><span class="p">::{</span><span class="n">Component</span><span class="p">,</span><span class="w"> </span><span class="n">Linker</span><span class="p">,</span><span class="w"> </span><span class="n">Val</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::{</span><span class="n">Config</span><span class="p">,</span><span class="w"> </span><span class="n">Engine</span><span class="p">,</span><span class="w"> </span><span class="n">Store</span><span class="p">,</span><span class="w"> </span><span class="n">Trap</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">WasiCtxBuilder</span><span class="p">;</span>

<span class="k">fn</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">anyhow</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">Cli</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cli</span><span class="p">::</span><span class="n">parse</span><span class="p">();</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span><span class="p">::</span><span class="n">default</span><span class="p">();</span>
<span class="w">    </span><span class="n">config</span><span class="p">.</span><span class="n">wasm_component_model</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Engine</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">config</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Linker</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Add the command world (aka WASI CLI) to the linker</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">add_to_linker_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="p">).</span><span class="n">context</span><span class="p">(</span><span class="s">"link command world"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WasiCtxBuilder</span><span class="p">::</span><span class="n">new</span><span class="p">().</span><span class="n">inherit_stdout</span><span class="p">().</span><span class="n">build_p1</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Store</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">component</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Component</span><span class="p">::</span><span class="n">from_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="n">path</span><span class="p">).</span><span class="n">context</span><span class="p">(</span><span class="s">"Component file not found"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">INTERFACE</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="kt">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"sammyne:helloworld/greeter@1.0.0"</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">FUNC_NAME</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="kt">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"say-hello"</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">linker</span>
<span class="w">        </span><span class="p">.</span><span class="n">instantiate</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">component</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">context</span><span class="p">(</span><span class="s">"instantiate"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// ref: https://docs.rs/wasmtime/30.0.2/wasmtime/component/struct.Instance.html#method.get_func</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">say_hello</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">instance_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instance</span>
<span class="w">            </span><span class="p">.</span><span class="n">get_export</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="nb">None</span><span class="p">,</span><span class="w"> </span><span class="n">INTERFACE</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">with_context</span><span class="p">(</span><span class="o">||</span><span class="w"> </span><span class="fm">format!</span><span class="p">(</span><span class="s">"miss interface: {INTERFACE}"</span><span class="p">))</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">func_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instance</span>
<span class="w">            </span><span class="p">.</span><span class="n">get_export</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance_idx</span><span class="p">),</span><span class="w"> </span><span class="n">FUNC_NAME</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">with_context</span><span class="p">(</span><span class="o">||</span><span class="w"> </span><span class="fm">format!</span><span class="p">(</span><span class="s">"locate func '{FUNC_NAME}'"</span><span class="p">))</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="n">instance</span>
<span class="w">            </span><span class="p">.</span><span class="n">get_func</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">func_idx</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">with_context</span><span class="p">(</span><span class="o">||</span><span class="w"> </span><span class="fm">format!</span><span class="p">(</span><span class="s">"load func '{FUNC_NAME}'"</span><span class="p">))</span><span class="o">?</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="c1">// make name prettry large to trigger OOM on purpose.</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"a"</span><span class="p">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">1024</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1024</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1024</span><span class="p">);</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">new_hello_request</span><span class="p">(</span><span class="n">name</span><span class="p">.</span><span class="n">clone</span><span class="p">())];</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">Val</span><span class="p">::</span><span class="n">Bool</span><span class="p">(</span><span class="kc">false</span><span class="p">)];</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">say_hello</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">results</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nb">Ok</span><span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{}</span>
<span class="w">            </span><span class="nb">Err</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">match</span><span class="w"> </span><span class="n">err</span><span class="p">.</span><span class="n">downcast_ref</span><span class="p">::</span><span class="o">&lt;</span><span class="n">Trap</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nb">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="fm">println!</span><span class="p">(</span><span class="s">"#{i} non-trap err: {err}"</span><span class="p">),</span>
<span class="w">                    </span><span class="nb">Some</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="fm">println!</span><span class="p">(</span><span class="s">"#{i} trap err: {c}</span><span class="se">\n</span><span class="s">{err}"</span><span class="p">),</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">say_hello</span>
<span class="w">            </span><span class="p">.</span><span class="n">post_return</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">with_context</span><span class="p">(</span><span class="o">||</span><span class="w"> </span><span class="fm">format!</span><span class="p">(</span><span class="s">"#{i} post return '{FUNC_NAME}'"</span><span class="p">))</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">say_hello</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">instance_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instance</span>
<span class="w">            </span><span class="p">.</span><span class="n">get_export</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="nb">None</span><span class="p">,</span><span class="w"> </span><span class="n">INTERFACE</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">with_context</span><span class="p">(</span><span class="o">||</span><span class="w"> </span><span class="fm">format!</span><span class="p">(</span><span class="s">"miss interface: {INTERFACE}"</span><span class="p">))</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">func_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instance</span>
<span class="w">            </span><span class="p">.</span><span class="n">get_export</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance_idx</span><span class="p">),</span><span class="w"> </span><span class="n">FUNC_NAME</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">with_context</span><span class="p">(</span><span class="o">||</span><span class="w"> </span><span class="fm">format!</span><span class="p">(</span><span class="s">"locate func '{FUNC_NAME}'"</span><span class="p">))</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="n">instance</span>
<span class="w">            </span><span class="p">.</span><span class="n">get_func</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">func_idx</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">with_context</span><span class="p">(</span><span class="o">||</span><span class="w"> </span><span class="fm">format!</span><span class="p">(</span><span class="s">"load func '{FUNC_NAME}'"</span><span class="p">))</span><span class="o">?</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">new_hello_request</span><span class="p">(</span><span class="n">name</span><span class="p">.</span><span class="n">clone</span><span class="p">())];</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">Val</span><span class="p">::</span><span class="n">Bool</span><span class="p">(</span><span class="kc">false</span><span class="p">)];</span>
<span class="w">    </span><span class="n">say_hello</span>
<span class="w">        </span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">results</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">context</span><span class="p">(</span><span class="s">"call after trap"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"hello world"</span><span class="p">);</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>

<span class="sd">/// A CLI for executing WebAssembly components that</span>
<span class="sd">/// implement the `example` world.</span>
<span class="cp">#[derive(Parser)]</span>
<span class="cp">#[clap(name = </span><span class="s">"hello-world-host"</span><span class="cp">, version = env!(</span><span class="s">"CARGO_PKG_VERSION"</span><span class="cp">))]</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">Cli</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="sd">/// WASM 组件的路径</span>
<span class="w">    </span><span class="cp">#[clap(short, long)]</span>
<span class="w">    </span><span class="n">path</span><span class="p">:</span><span class="w"> </span><span class="nc">PathBuf</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">fn</span><span class="w"> </span><span class="nf">new_hello_request</span><span class="p">(</span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="nb">String</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">Val</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Val</span><span class="p">::</span><span class="n">Record</span><span class="p">(</span><span class="fm">vec!</span><span class="p">[(</span><span class="s">"name"</span><span class="p">.</span><span class="n">to_owned</span><span class="p">(),</span><span class="w"> </span><span class="n">Val</span><span class="p">::</span><span class="nb">String</span><span class="p">(</span><span class="n">name</span><span class="p">))])</span>
<span class="p">}</span>
</code></pre></div>
<p>The <code>say_hello</code> outside the <code>for</code> loop triggering <code>Trap</code> failed with error as</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>Error:<span class="w"> </span>call<span class="w"> </span>after<span class="w"> </span><span class="nb">trap</span>

Caused<span class="w"> </span>by:
<span class="w">    </span>wasm<span class="w"> </span>trap:<span class="w"> </span>cannot<span class="w"> </span>enter<span class="w"> </span>component<span class="w"> </span>instance
</code></pre></div>
<p>Really appreciate if someone could explain the reason of rendering the instance non-enterable.</p>
</blockquote>



<a name="523247819"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310995%20Why%20does%20the%20trapped%20func%20call%20re.../near/523247819" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310995.20Why.20does.20the.20trapped.20func.20call.20re.2E.2E.2E.html#523247819">(Jun 10 2025 at 09:34)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/10995#issuecomment-2958386611">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10995">issue #10995</a>:</p>
<blockquote>
<p><a href="https://github.com/WebAssembly/component-model/blob/main/design/mvp/Explainer.md#component-invariants">https://github.com/WebAssembly/component-model/blob/main/design/mvp/Explainer.md#component-invariants</a></p>
<blockquote>
<p>Components define a "lockdown" state that prevents continued execution after a trap. This both prevents continued execution with corrupt state and also allows more-aggressive compiler optimizations (e.g., store reordering). This was considered early in Core WebAssembly standardization but rejected due to the lack of clear trapping boundary. With components, each component instance is given a mutable "lockdown" state that is set upon trap and implicitly checked at every execution step by component functions. Thus, after a trap, it's no longer possible to observe the internal state of a component instance.</p>
</blockquote>
</blockquote>



<a name="523248168"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310995%20Why%20does%20the%20trapped%20func%20call%20re.../near/523248168" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310995.20Why.20does.20the.20trapped.20func.20call.20re.2E.2E.2E.html#523248168">(Jun 10 2025 at 09:36)</a>:</h4>
<p>bjorn3 edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/10995#issuecomment-2958386611">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10995">issue #10995</a>:</p>
<blockquote>
<p><a href="https://github.com/WebAssembly/component-model/blob/main/design/mvp/Explainer.md#component-invariants">https://github.com/WebAssembly/component-model/blob/main/design/mvp/Explainer.md#component-invariants</a></p>
<blockquote>
<p>Components define a "lockdown" state that prevents continued execution after a trap. This both prevents continued execution with corrupt state and also allows more-aggressive compiler optimizations (e.g., store reordering). This was considered early in Core WebAssembly standardization but rejected due to the lack of clear trapping boundary. With components, each component instance is given a mutable "lockdown" state that is set upon trap and implicitly checked at every execution step by component functions. Thus, after a trap, it's no longer possible to observe the internal state of a component instance.</p>
</blockquote>
<p>Also from the perspective of the guest wasm module it is straight up UB to re-enter after a trap if the module was compiled by LLVM, even when not using the component model.</p>
</blockquote>



<a name="523249816"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310995%20Why%20does%20the%20trapped%20func%20call%20re.../near/523249816" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310995.20Why.20does.20the.20trapped.20func.20call.20re.2E.2E.2E.html#523249816">(Jun 10 2025 at 09:44)</a>:</h4>
<p>sammyne <a href="https://github.com/bytecodealliance/wasmtime/issues/10995#issuecomment-2958416339">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10995">issue #10995</a>:</p>
<blockquote>
<blockquote>
<p><a href="https://github.com/WebAssembly/component-model/blob/main/design/mvp/Explainer.md#component-invariants">https://github.com/WebAssembly/component-model/blob/main/design/mvp/Explainer.md#component-invariants</a></p>
<blockquote>
<p>Components define a "lockdown" state that prevents continued execution after a trap. This both prevents continued execution with corrupt state and also allows more-aggressive compiler optimizations (e.g., store reordering). This was considered early in Core WebAssembly standardization but rejected due to the lack of clear trapping boundary. With components, each component instance is given a mutable "lockdown" state that is set upon trap and implicitly checked at every execution step by component functions. Thus, after a trap, it's no longer possible to observe the internal state of a component instance.</p>
</blockquote>
<p>Also from the perspective of the guest wasm module it is straight up UB to re-enter after a trap if the module was compiled by LLVM, even when not using the component model.</p>
</blockquote>
<p>Two further questions</p>
<p>Q1: It should be possible the check the tables, resources etc by means of the bound <code>Store</code>. Why "it's no longer possible to observe the internal state of a component instance"?</p>
<p>Q2:  As for re-enter after trap, is the UB caused by table or resources leaked by previous trap? If not reusing the table and resources, it should run as if the re-enter is a fresh run. </p>
</blockquote>



<a name="523253148"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310995%20Why%20does%20the%20trapped%20func%20call%20re.../near/523253148" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310995.20Why.20does.20the.20trapped.20func.20call.20re.2E.2E.2E.html#523253148">(Jun 10 2025 at 10:03)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/10995#issuecomment-2958487140">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10995">issue #10995</a>:</p>
<blockquote>
<blockquote>
<p>Q1: It should be possible the check the tables, resources etc by means of the bound Store. Why "it's no longer possible to observe the internal state of a component instance"?</p>
</blockquote>
<p>AFAIK there is no way to get a reference to those things from a component. Stores don't provide any way to iterate over the things that are contained inside it.</p>
<blockquote>
<p>Q2: As for re-enter after trap, is the UB caused by table or resources leaked by previous trap? If not reusing the table and resources, it should run as if the re-enter is a fresh run.</p>
</blockquote>
<p>It is caused by reusing the linear memory and globals of the component. The only way to prevent reusing that is by literally recreating the component.</p>
</blockquote>



<a name="523265662"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310995%20Why%20does%20the%20trapped%20func%20call%20re.../near/523265662" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310995.20Why.20does.20the.20trapped.20func.20call.20re.2E.2E.2E.html#523265662">(Jun 10 2025 at 11:15)</a>:</h4>
<p>sammyne <a href="https://github.com/bytecodealliance/wasmtime/issues/10995#issuecomment-2958759415">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10995">issue #10995</a>:</p>
<blockquote>
<blockquote>
<blockquote>
<p>Q1: It should be possible the check the tables, resources etc by means of the bound Store. Why "it's no longer possible to observe the internal state of a component instance"?</p>
</blockquote>
<p>AFAIK there is no way to get a reference to those things from a component. Stores don't provide any way to iterate over the things that are contained inside it.</p>
<blockquote>
<p>Q2: As for re-enter after trap, is the UB caused by table or resources leaked by previous trap? If not reusing the table and resources, it should run as if the re-enter is a fresh run.</p>
</blockquote>
<p>It is caused by reusing the linear memory and globals of the component. The only way to prevent reusing that is by literally recreating the component.</p>
</blockquote>
<p>Let's assume the linear memory is reused for the re-entered instance, previous bookkeeping of which allocated memory chunks should be reused also, the new allocation request will be satisified in the unallocated chunks. It just leaked memory. How is the UB triggered? Could you give an example explaining the UB?</p>
</blockquote>



<a name="523267354"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310995%20Why%20does%20the%20trapped%20func%20call%20re.../near/523267354" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310995.20Why.20does.20the.20trapped.20func.20call.20re.2E.2E.2E.html#523267354">(Jun 10 2025 at 11:25)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/10995#issuecomment-2958786675">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10995">issue #10995</a>:</p>
<blockquote>
<p>LLVM is allowed to temporarily write garbage to memory (eg a global variable) for as long as it fixes it up before anyone can observe it according to the rules of the LLVM abstract machine. At the same time it assumes that after a trap nobody will be around to observe anything anymore, so it will just optimize away the restore operation if preceded by a trap.</p>
</blockquote>



<a name="523313391"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310995%20Why%20does%20the%20trapped%20func%20call%20re.../near/523313391" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310995.20Why.20does.20the.20trapped.20func.20call.20re.2E.2E.2E.html#523313391">(Jun 10 2025 at 15:02)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/10995#issuecomment-2959610388">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10995">issue #10995</a>:</p>
<blockquote>
<p>You might also be interested in <a href="https://github.com/WebAssembly/component-model/issues/502">https://github.com/WebAssembly/component-model/issues/502</a> which is about inspecting components after a trap as well.</p>
</blockquote>



<a name="523400067"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310995%20Why%20does%20the%20trapped%20func%20call%20re.../near/523400067" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310995.20Why.20does.20the.20trapped.20func.20call.20re.2E.2E.2E.html#523400067">(Jun 11 2025 at 02:05)</a>:</h4>
<p>sammyne closed <a href="https://github.com/bytecodealliance/wasmtime/issues/10995">issue #10995</a>:</p>
<blockquote>
<p>I make the simple wasm host as </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">path</span><span class="p">::</span><span class="n">PathBuf</span><span class="p">;</span>

<span class="k">use</span><span class="w"> </span><span class="n">anyhow</span><span class="p">::</span><span class="n">Context</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">clap</span><span class="p">::</span><span class="n">Parser</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">component</span><span class="p">::{</span><span class="n">Component</span><span class="p">,</span><span class="w"> </span><span class="n">Linker</span><span class="p">,</span><span class="w"> </span><span class="n">Val</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::{</span><span class="n">Config</span><span class="p">,</span><span class="w"> </span><span class="n">Engine</span><span class="p">,</span><span class="w"> </span><span class="n">Store</span><span class="p">,</span><span class="w"> </span><span class="n">Trap</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">WasiCtxBuilder</span><span class="p">;</span>

<span class="k">fn</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">anyhow</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">Cli</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Cli</span><span class="p">::</span><span class="n">parse</span><span class="p">();</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span><span class="p">::</span><span class="n">default</span><span class="p">();</span>
<span class="w">    </span><span class="n">config</span><span class="p">.</span><span class="n">wasm_component_model</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Engine</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">config</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Linker</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Add the command world (aka WASI CLI) to the linker</span>
<span class="w">    </span><span class="n">wasmtime_wasi</span><span class="p">::</span><span class="n">add_to_linker_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">linker</span><span class="p">).</span><span class="n">context</span><span class="p">(</span><span class="s">"link command world"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WasiCtxBuilder</span><span class="p">::</span><span class="n">new</span><span class="p">().</span><span class="n">inherit_stdout</span><span class="p">().</span><span class="n">build_p1</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Store</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="n">ctx</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">component</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Component</span><span class="p">::</span><span class="n">from_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="n">path</span><span class="p">).</span><span class="n">context</span><span class="p">(</span><span class="s">"Component file not found"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">INTERFACE</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="kt">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"sammyne:helloworld/greeter@1.0.0"</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">FUNC_NAME</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="kt">str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"say-hello"</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">linker</span>
<span class="w">        </span><span class="p">.</span><span class="n">instantiate</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">component</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">context</span><span class="p">(</span><span class="s">"instantiate"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// ref: https://docs.rs/wasmtime/30.0.2/wasmtime/component/struct.Instance.html#method.get_func</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">say_hello</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">instance_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instance</span>
<span class="w">            </span><span class="p">.</span><span class="n">get_export</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="nb">None</span><span class="p">,</span><span class="w"> </span><span class="n">INTERFACE</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">with_context</span><span class="p">(</span><span class="o">||</span><span class="w"> </span><span class="fm">format!</span><span class="p">(</span><span class="s">"miss interface: {INTERFACE}"</span><span class="p">))</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">func_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instance</span>
<span class="w">            </span><span class="p">.</span><span class="n">get_export</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance_idx</span><span class="p">),</span><span class="w"> </span><span class="n">FUNC_NAME</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">with_context</span><span class="p">(</span><span class="o">||</span><span class="w"> </span><span class="fm">format!</span><span class="p">(</span><span class="s">"locate func '{FUNC_NAME}'"</span><span class="p">))</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="n">instance</span>
<span class="w">            </span><span class="p">.</span><span class="n">get_func</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">func_idx</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">with_context</span><span class="p">(</span><span class="o">||</span><span class="w"> </span><span class="fm">format!</span><span class="p">(</span><span class="s">"load func '{FUNC_NAME}'"</span><span class="p">))</span><span class="o">?</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="c1">// make name prettry large to trigger OOM on purpose.</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"a"</span><span class="p">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">1024</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1024</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1024</span><span class="p">);</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">new_hello_request</span><span class="p">(</span><span class="n">name</span><span class="p">.</span><span class="n">clone</span><span class="p">())];</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">Val</span><span class="p">::</span><span class="n">Bool</span><span class="p">(</span><span class="kc">false</span><span class="p">)];</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">say_hello</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">results</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nb">Ok</span><span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{}</span>
<span class="w">            </span><span class="nb">Err</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">match</span><span class="w"> </span><span class="n">err</span><span class="p">.</span><span class="n">downcast_ref</span><span class="p">::</span><span class="o">&lt;</span><span class="n">Trap</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nb">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="fm">println!</span><span class="p">(</span><span class="s">"#{i} non-trap err: {err}"</span><span class="p">),</span>
<span class="w">                    </span><span class="nb">Some</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="fm">println!</span><span class="p">(</span><span class="s">"#{i} trap err: {c}</span><span class="se">\n</span><span class="s">{err}"</span><span class="p">),</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">say_hello</span>
<span class="w">            </span><span class="p">.</span><span class="n">post_return</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">with_context</span><span class="p">(</span><span class="o">||</span><span class="w"> </span><span class="fm">format!</span><span class="p">(</span><span class="s">"#{i} post return '{FUNC_NAME}'"</span><span class="p">))</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">say_hello</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">instance_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instance</span>
<span class="w">            </span><span class="p">.</span><span class="n">get_export</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="nb">None</span><span class="p">,</span><span class="w"> </span><span class="n">INTERFACE</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">with_context</span><span class="p">(</span><span class="o">||</span><span class="w"> </span><span class="fm">format!</span><span class="p">(</span><span class="s">"miss interface: {INTERFACE}"</span><span class="p">))</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">func_idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">instance</span>
<span class="w">            </span><span class="p">.</span><span class="n">get_export</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance_idx</span><span class="p">),</span><span class="w"> </span><span class="n">FUNC_NAME</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">with_context</span><span class="p">(</span><span class="o">||</span><span class="w"> </span><span class="fm">format!</span><span class="p">(</span><span class="s">"locate func '{FUNC_NAME}'"</span><span class="p">))</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="n">instance</span>
<span class="w">            </span><span class="p">.</span><span class="n">get_func</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">func_idx</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">with_context</span><span class="p">(</span><span class="o">||</span><span class="w"> </span><span class="fm">format!</span><span class="p">(</span><span class="s">"load func '{FUNC_NAME}'"</span><span class="p">))</span><span class="o">?</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">params</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">new_hello_request</span><span class="p">(</span><span class="n">name</span><span class="p">.</span><span class="n">clone</span><span class="p">())];</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">Val</span><span class="p">::</span><span class="n">Bool</span><span class="p">(</span><span class="kc">false</span><span class="p">)];</span>
<span class="w">    </span><span class="n">say_hello</span>
<span class="w">        </span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">params</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">results</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">context</span><span class="p">(</span><span class="s">"call after trap"</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"hello world"</span><span class="p">);</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>

<span class="sd">/// A CLI for executing WebAssembly components that</span>
<span class="sd">/// implement the `example` world.</span>
<span class="cp">#[derive(Parser)]</span>
<span class="cp">#[clap(name = </span><span class="s">"hello-world-host"</span><span class="cp">, version = env!(</span><span class="s">"CARGO_PKG_VERSION"</span><span class="cp">))]</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">Cli</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="sd">/// WASM 组件的路径</span>
<span class="w">    </span><span class="cp">#[clap(short, long)]</span>
<span class="w">    </span><span class="n">path</span><span class="p">:</span><span class="w"> </span><span class="nc">PathBuf</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">fn</span><span class="w"> </span><span class="nf">new_hello_request</span><span class="p">(</span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="nb">String</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">Val</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Val</span><span class="p">::</span><span class="n">Record</span><span class="p">(</span><span class="fm">vec!</span><span class="p">[(</span><span class="s">"name"</span><span class="p">.</span><span class="n">to_owned</span><span class="p">(),</span><span class="w"> </span><span class="n">Val</span><span class="p">::</span><span class="nb">String</span><span class="p">(</span><span class="n">name</span><span class="p">))])</span>
<span class="p">}</span>
</code></pre></div>
<p>The <code>say_hello</code> outside the <code>for</code> loop triggering <code>Trap</code> failed with error as</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>Error:<span class="w"> </span>call<span class="w"> </span>after<span class="w"> </span><span class="nb">trap</span>

Caused<span class="w"> </span>by:
<span class="w">    </span>wasm<span class="w"> </span>trap:<span class="w"> </span>cannot<span class="w"> </span>enter<span class="w"> </span>component<span class="w"> </span>instance
</code></pre></div>
<p>Really appreciate if someone could explain the reason of rendering the instance non-enterable.</p>
</blockquote>



<hr><p>Last updated: Feb 22 2026 at 11:05 UTC</p>
</html>
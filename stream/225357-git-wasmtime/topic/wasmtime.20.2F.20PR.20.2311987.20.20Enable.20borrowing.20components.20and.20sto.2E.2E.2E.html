<html>
<head><meta charset="utf-8"><title>wasmtime / PR #11987  Enable borrowing components and sto... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311987.20.20Enable.20borrowing.20components.20and.20sto.2E.2E.2E.html">wasmtime / PR #11987  Enable borrowing components and sto...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="553957811"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311987%20%20Enable%20borrowing%20components%20and%20sto.../near/553957811" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311987.20.20Enable.20borrowing.20components.20and.20sto.2E.2E.2E.html#553957811">(Nov 05 2025 at 20:36)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/fitzgen">fitzgen</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/11987">PR #11987</a>.</p>



<a name="553957812"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311987%20%20Enable%20borrowing%20components%20and%20sto.../near/553957812" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311987.20.20Enable.20borrowing.20components.20and.20sto.2E.2E.2E.html#553957812">(Nov 05 2025 at 20:36)</a>:</h4>
<p>alexcrichton opened <a href="https://github.com/bytecodealliance/wasmtime/pull/11987">PR #11987</a> from <code>alexcrichton:less-clone</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>This commit adds a new, safe, function to the <code>Instance</code> type for<br>
internal use in Wasmtime which enables simultaneously borrowing the<br>
<code>Component</code>-within-the-<code>Instance</code> as well as the original store at the<br>
same time. This is not possible to do in safe Rust when the store is<br>
mutable and must be implemented with <code>unsafe</code> code.</p>
<p>The motivation for this commit is performance. In <a href="https://github.com/bytecodealliance/wasmtime/issues/11974">https://github.com/bytecodealliance/wasmtime/issues/11974</a> it was<br>
discovered that the addition of a single <code>Arc::clone</code> was enough to<br>
reduce throughput in the embedding by 20%. While <code>Arc::clone</code> is<br>
generally cheap I can see how a "contended" <code>Arc::clone</code> could get quite<br>
expensive. This particular benchmark was running multiple instances of<br>
the same component across multiple threads which were all doing many<br>
host calls. Each host call, after the refactoring of <a href="https://github.com/bytecodealliance/wasmtime/pull/10959">https://github.com/bytecodealliance/wasmtime/pull/10959</a>, contained<br>
an <code>Arc::clone</code> to the component itself. This in turn led to many<br>
threads constantly incrementing/decrementing the <code>Arc::clone</code> count of<br>
the same <code>Arc</code> instance.</p>
<p>At a high level this clone is not necessary. The component lives within<br>
the store and cannot be mutated/deleted during execution. Safe Rust,<br>
however, forbids access to the component and mutably using the store at<br>
the same time. Thus, this helper function enters the picture. The goal<br>
here is to remove the <code>Arc::clone</code> calls without requiring major surgery<br>
or such to refactor the implementations of various functions throughout<br>
Wasmtime. The <code>unsafe</code> block used to implement this function documents<br>
more rationale as to why this should be safe.</p>
<p>Closes #11974</p>
</blockquote>



<a name="553957813"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311987%20%20Enable%20borrowing%20components%20and%20sto.../near/553957813" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311987.20.20Enable.20borrowing.20components.20and.20sto.2E.2E.2E.html#553957813">(Nov 05 2025 at 20:36)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers">wasmtime-core-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/11987">PR #11987</a>.</p>



<a name="553957871"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311987%20%20Enable%20borrowing%20components%20and%20sto.../near/553957871" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311987.20.20Enable.20borrowing.20components.20and.20sto.2E.2E.2E.html#553957871">(Nov 05 2025 at 20:37)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/11987#issuecomment-3493288007">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11987">PR #11987</a>:</p>
<blockquote>
<p>Note that this is built on <a href="https://github.com/bytecodealliance/wasmtime/pull/11986">https://github.com/bytecodealliance/wasmtime/pull/11986</a>, so only the second commit is relevant here.</p>
</blockquote>



<a name="554388896"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311987%20%20Enable%20borrowing%20components%20and%20sto.../near/554388896" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311987.20.20Enable.20borrowing.20components.20and.20sto.2E.2E.2E.html#554388896">(Nov 07 2025 at 18:19)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11987#pullrequestreview-3435596966">PR review</a>:</p>
<blockquote>
<p>Do we have tests that run under MIRI that cover this?</p>
</blockquote>



<a name="554388899"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311987%20%20Enable%20borrowing%20components%20and%20sto.../near/554388899" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311987.20.20Enable.20borrowing.20components.20and.20sto.2E.2E.2E.html#554388899">(Nov 07 2025 at 18:19)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/11987#discussion_r2504896179">PR review comment</a>:</p>
<blockquote>
<p><div class="codehilite" data-code-language="suggestion"><pre><span></span><code>        // within a component instance, within a store, to be deallocated or mutated while
        // a store is in use. Consequently it should be safe to simultaneously
</code></pre></div><br>
</p>
</blockquote>



<a name="554388967"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311987%20%20Enable%20borrowing%20components%20and%20sto.../near/554388967" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311987.20.20Enable.20borrowing.20components.20and.20sto.2E.2E.2E.html#554388967">(Nov 07 2025 at 18:20)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11987#pullrequestreview-3435601557">PR review</a>.</p>



<a name="554403062"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311987%20%20Enable%20borrowing%20components%20and%20sto.../near/554403062" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311987.20.20Enable.20borrowing.20components.20and.20sto.2E.2E.2E.html#554403062">(Nov 07 2025 at 19:35)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11987">PR #11987</a>.</p>



<a name="554403348"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311987%20%20Enable%20borrowing%20components%20and%20sto.../near/554403348" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311987.20.20Enable.20borrowing.20components.20and.20sto.2E.2E.2E.html#554403348">(Nov 07 2025 at 19:37)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/11987#issuecomment-3504539888">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11987">PR #11987</a>:</p>
<blockquote>
<p>We do indeed! There are a number of tests in <code>tests/all/pulley.rs</code> run under miri which do host calls which should exercise these paths.</p>
</blockquote>



<a name="554403373"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311987%20%20Enable%20borrowing%20components%20and%20sto.../near/554403373" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311987.20.20Enable.20borrowing.20components.20and.20sto.2E.2E.2E.html#554403373">(Nov 07 2025 at 19:37)</a>:</h4>
<p>alexcrichton has enabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/11987">PR #11987</a>.</p>



<a name="554408517"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311987%20%20Enable%20borrowing%20components%20and%20sto.../near/554408517" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311987.20.20Enable.20borrowing.20components.20and.20sto.2E.2E.2E.html#554408517">(Nov 07 2025 at 20:13)</a>:</h4>
<p>alexcrichton merged <a href="https://github.com/bytecodealliance/wasmtime/pull/11987">PR #11987</a>.</p>



<hr><p>Last updated: Feb 22 2026 at 11:05 UTC</p>
</html>
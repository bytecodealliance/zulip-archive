<html>
<head><meta charset="utf-8"><title>wasmtime / PR #11468 Make const-expr evaluation `async` · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311468.20Make.20const-expr.20evaluation.20.60async.60.html">wasmtime / PR #11468 Make const-expr evaluation `async`</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="535213112"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311468%20Make%20const-expr%20evaluation%20%60async%60/near/535213112" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311468.20Make.20const-expr.20evaluation.20.60async.60.html#535213112">(Aug 19 2025 at 22:51)</a>:</h4>
<p>alexcrichton opened <a href="https://github.com/bytecodealliance/wasmtime/pull/11468">PR #11468</a> from <code>alexcrichton:more-gc-async</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>This commit is extracted from #11430 to accurately reflect how const-expr evaluation is an async operation due to GC pauses that may happen. The changes in this commit are:</p>
<ul>
<li>Const-expr evaluation is, at its core, now an <code>async</code> function.</li>
<li>To leverage this new <code>async</code>-ness all internal operations are switched from <code>*_maybe_async</code> to <code>*_async</code> meaning all the <code>*_maybe_async</code> methods can be removed.</li>
<li>Some libcalls using <code>*_maybe_async</code> are switch to using <code>*_async</code> plus the <code>block_on!</code> utility to help jettison more <code>*_maybe_async</code> methods.</li>
<li>Instance initialization is now an <code>async</code> function. This is temporarily handled with <code>block_on</code> during instance initialization to avoid propagating the <code>async</code>-ness further upwards. This <code>block_on</code> will get deleted in future refactorings.</li>
<li>Const-expr evaluation has been refactored slightly to enable having a fast path in global initialization which skips an <code>await</code> point entirely, achieving performance-parity in benchmarks prior to this commit.</li>
</ul>
<p>This ended up fixing a niche issue with GC where if a wasm execution was suspended during <code>table.init</code>, for example, during a const-expr evaluation triggering a GC then if the wasm execution was cancelled it would panic the host. This panic was because the GC operation returned <code>Result</code> but it was <code>unwrap</code>'d as part of the const-expr evaluation which can fail not only to invalid-ness but also due to "computation is cancelled" traps.</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="535213114"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311468%20Make%20const-expr%20evaluation%20%60async%60/near/535213114" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311468.20Make.20const-expr.20evaluation.20.60async.60.html#535213114">(Aug 19 2025 at 22:51)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/pchickey">pchickey</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/11468">PR #11468</a>.</p>



<a name="535213116"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311468%20Make%20const-expr%20evaluation%20%60async%60/near/535213116" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311468.20Make.20const-expr.20evaluation.20.60async.60.html#535213116">(Aug 19 2025 at 22:51)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers">wasmtime-core-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/11468">PR #11468</a>.</p>



<a name="535213263"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311468%20Make%20const-expr%20evaluation%20%60async%60/near/535213263" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311468.20Make.20const-expr.20evaluation.20.60async.60.html#535213263">(Aug 19 2025 at 22:52)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/11468#issuecomment-3202636577">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11468">PR #11468</a>:</p>
<blockquote>
<p>Actually, thinking more, the issue about panicking on const expr evaluation failure means <a href="https://github.com/bytecodealliance/wasmtime/issues/11469">allocation failure in GC is a host panic</a> which isn't great. Deferring that to a separate issue.</p>
</blockquote>



<a name="535213578"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311468%20Make%20const-expr%20evaluation%20%60async%60/near/535213578" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311468.20Make.20const-expr.20evaluation.20.60async.60.html#535213578">(Aug 19 2025 at 22:57)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11468">PR #11468</a>.</p>



<a name="535227894"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311468%20Make%20const-expr%20evaluation%20%60async%60/near/535227894" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311468.20Make.20const-expr.20evaluation.20.60async.60.html#535227894">(Aug 20 2025 at 02:18)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/11468#issuecomment-3203927152">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11468">PR #11468</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @fitzgen</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "wasmtime:api", "wasmtime:ref-types"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>fitzgen: wasmtime:ref-types</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="535351087"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311468%20Make%20const-expr%20evaluation%20%60async%60/near/535351087" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311468.20Make.20const-expr.20evaluation.20.60async.60.html#535351087">(Aug 20 2025 at 16:23)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11468">PR #11468</a>.</p>



<a name="535355237"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311468%20Make%20const-expr%20evaluation%20%60async%60/near/535355237" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311468.20Make.20const-expr.20evaluation.20.60async.60.html#535355237">(Aug 20 2025 at 16:48)</a>:</h4>
<p><strong>pchickey</strong> requested <a href="https://github.com/fitzgen">fitzgen</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/11468">PR #11468</a>.</p>



<a name="535359837"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311468%20Make%20const-expr%20evaluation%20%60async%60/near/535359837" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311468.20Make.20const-expr.20evaluation.20.60async.60.html#535359837">(Aug 20 2025 at 17:20)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11468#pullrequestreview-3137577187">PR review</a>:</p>
<blockquote>
<p><span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span> </p>
</blockquote>



<a name="535359838"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311468%20Make%20const-expr%20evaluation%20%60async%60/near/535359838" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311468.20Make.20const-expr.20evaluation.20.60async.60.html#535359838">(Aug 20 2025 at 17:20)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/11468#discussion_r2288822416">PR review comment</a>:</p>
<blockquote>
<p>Are there any non-async <code>retry_after_gc</code> calls at this point? I think all of them should be async by the time we finish the asyncification of the internals, but I'm not sure if we are there yet or not. But when we are, we should delete the non-async version and then just rename the async variation to plain <code>retry_after_gc</code>.</p>
</blockquote>



<a name="535359839"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311468%20Make%20const-expr%20evaluation%20%60async%60/near/535359839" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311468.20Make.20const-expr.20evaluation.20.60async.60.html#535359839">(Aug 20 2025 at 17:20)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/11468#discussion_r2288827262">PR review comment</a>:</p>
<blockquote>
<p>And then <code>Instance::new_raw</code> will become an <code>async</code> function in another follow up PR?</p>
</blockquote>



<a name="535360682"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311468%20Make%20const-expr%20evaluation%20%60async%60/near/535360682" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311468.20Make.20const-expr.20evaluation.20.60async.60.html#535360682">(Aug 20 2025 at 17:26)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11468#pullrequestreview-3137609231">PR review</a>.</p>



<a name="535360683"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311468%20Make%20const-expr%20evaluation%20%60async%60/near/535360683" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311468.20Make.20const-expr.20evaluation.20.60async.60.html#535360683">(Aug 20 2025 at 17:26)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/11468#discussion_r2288841677">PR review comment</a>:</p>
<blockquote>
<p>Soon! (got a PR queued up after #11470 to delete the sync version</p>
</blockquote>



<a name="535360703"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311468%20Make%20const-expr%20evaluation%20%60async%60/near/535360703" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311468.20Make.20const-expr.20evaluation.20.60async.60.html#535360703">(Aug 20 2025 at 17:27)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11468#pullrequestreview-3137609690">PR review</a>.</p>



<a name="535360705"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311468%20Make%20const-expr%20evaluation%20%60async%60/near/535360705" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311468.20Make.20const-expr.20evaluation.20.60async.60.html#535360705">(Aug 20 2025 at 17:27)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/11468#discussion_r2288842023">PR review comment</a>:</p>
<blockquote>
<p>Indeed! That'll be #11470</p>
</blockquote>



<a name="535363883"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311468%20Make%20const-expr%20evaluation%20%60async%60/near/535363883" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311468.20Make.20const-expr.20evaluation.20.60async.60.html#535363883">(Aug 20 2025 at 17:51)</a>:</h4>
<p>alexcrichton merged <a href="https://github.com/bytecodealliance/wasmtime/pull/11468">PR #11468</a>.</p>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
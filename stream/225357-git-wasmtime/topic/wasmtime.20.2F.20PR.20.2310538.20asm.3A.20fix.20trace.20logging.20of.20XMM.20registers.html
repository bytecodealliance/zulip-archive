<html>
<head><meta charset="utf-8"><title>wasmtime / PR #10538 asm: fix trace logging of XMM registers · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310538.20asm.3A.20fix.20trace.20logging.20of.20XMM.20registers.html">wasmtime / PR #10538 asm: fix trace logging of XMM registers</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="510720135"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310538%20asm%3A%20fix%20trace%20logging%20of%20XMM%20registers/near/510720135" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310538.20asm.3A.20fix.20trace.20logging.20of.20XMM.20registers.html#510720135">(Apr 07 2025 at 16:42)</a>:</h4>
<p><strong>abrown</strong> requested <a href="https://github.com/cfallin">cfallin</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/10538">PR #10538</a>.</p>



<a name="510720136"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310538%20asm%3A%20fix%20trace%20logging%20of%20XMM%20registers/near/510720136" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310538.20asm.3A.20fix.20trace.20logging.20of.20XMM.20registers.html#510720136">(Apr 07 2025 at 16:42)</a>:</h4>
<p><strong>abrown</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/10538">PR #10538</a>.</p>



<a name="510720137"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310538%20asm%3A%20fix%20trace%20logging%20of%20XMM%20registers/near/510720137" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310538.20asm.3A.20fix.20trace.20logging.20of.20XMM.20registers.html#510720137">(Apr 07 2025 at 16:42)</a>:</h4>
<p>abrown opened <a href="https://github.com/bytecodealliance/wasmtime/pull/10538">PR #10538</a> from <code>abrown:fix-10529</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>Along the lines of #10389 and #10478, this change fixes the case where an XMM register is pretty-printed during logging, which may happen before register allocation has provided a true HW register.</p>
<p>Fixes #10529.</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="510720829"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310538%20asm%3A%20fix%20trace%20logging%20of%20XMM%20registers/near/510720829" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310538.20asm.3A.20fix.20trace.20logging.20of.20XMM.20registers.html#510720829">(Apr 07 2025 at 16:45)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/10538#issuecomment-2783979052">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/10538">PR #10538</a>:</p>
<blockquote>
<p>Could the test added in <a href="https://github.com/bytecodealliance/wasmtime/pull/10478">https://github.com/bytecodealliance/wasmtime/pull/10478</a> be expanded to cover this too?</p>
</blockquote>



<a name="510730785"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310538%20asm%3A%20fix%20trace%20logging%20of%20XMM%20registers/near/510730785" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310538.20asm.3A.20fix.20trace.20logging.20of.20XMM.20registers.html#510730785">(Apr 07 2025 at 17:37)</a>:</h4>
<p>abrown <a href="https://github.com/bytecodealliance/wasmtime/pull/10538#issuecomment-2784096146">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/10538">PR #10538</a>:</p>
<blockquote>
<blockquote>
<p>Could the test added in #10478 be expanded to cover this too?</p>
</blockquote>
<p>Yeah, we need a few more SSE lowerings plumbed through to really trigger this; I can't seem to find one that actually goes all the way from WAT to the assembler that will use an XMM register and trigger this.</p>
</blockquote>



<a name="510786377"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310538%20asm%3A%20fix%20trace%20logging%20of%20XMM%20registers/near/510786377" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310538.20asm.3A.20fix.20trace.20logging.20of.20XMM.20registers.html#510786377">(Apr 07 2025 at 23:48)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/10538#pullrequestreview-2748341670">PR review</a>:</p>
<blockquote>
<p>Thanks!</p>
<p>An idle thought about testing: would it be possible to run the filetests in CI with <code>RUST_LOG=trace</code>? That would certainly give us coverage of almost all or all lowerings (we expect them all to be tested); only uncertainty is what it would do to test time, but probably OK?</p>
</blockquote>



<a name="511028036"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310538%20asm%3A%20fix%20trace%20logging%20of%20XMM%20registers/near/511028036" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310538.20asm.3A.20fix.20trace.20logging.20of.20XMM.20registers.html#511028036">(Apr 08 2025 at 21:22)</a>:</h4>
<p>abrown <a href="https://github.com/bytecodealliance/wasmtime/pull/10538#issuecomment-2787691356">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/10538">PR #10538</a>:</p>
<blockquote>
<blockquote>
<p>Thanks!</p>
<p>An idle thought about testing: would it be possible to run the filetests in CI with <code>RUST_LOG=trace</code>? That would certainly give us coverage of almost all or all lowerings (we expect them all to be tested); only uncertainty is what it would do to test time, but probably OK?</p>
</blockquote>
<p>I think that makes sense. Here's a slowdown comparison:</p>
<div class="codehilite" data-code-language="Bash Session"><pre><span></span><code><span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span>cranelift
<span class="gp">$ </span><span class="nv">RUST_LOG</span><span class="o">=</span><span class="nv">cranelift_codegen</span><span class="o">=</span>trace<span class="w"> </span>/usr/bin/time<span class="w"> </span>cargo<span class="w"> </span><span class="nb">test</span>
<span class="go">...</span>
<span class="go">24.65user 0.57system 0:04.66elapsed 540%CPU</span>
</code></pre></div>
<div class="codehilite" data-code-language="Bash Session"><pre><span></span><code><span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span>cranelift
<span class="gp">$ </span>/usr/bin/time<span class="w"> </span>cargo<span class="w"> </span><span class="nb">test</span>
<span class="go">...</span>
<span class="go">17.79user 0.12system 0:04.18elapsed 427%CPU</span>
</code></pre></div>
<p>Slower, but perhaps worth it. Where does this fit in <code>main.yml</code>, though? A whole new <code>test_*</code> job?</p>
</blockquote>



<a name="511029393"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310538%20asm%3A%20fix%20trace%20logging%20of%20XMM%20registers/near/511029393" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310538.20asm.3A.20fix.20trace.20logging.20of.20XMM.20registers.html#511029393">(Apr 08 2025 at 21:33)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/10538#issuecomment-2787713199">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/10538">PR #10538</a>:</p>
<blockquote>
<p>This won't fit easily into <code>main.yml</code> unfortunately. The <code>cranelift-tools</code> crate is tested in a "soup" with a bunch of other crates which are partitioned automatically. As global state (<code>RUST_LOG</code>) this also isn't workable as a sibling <code>#[test]</code>. What I might recommend is a sibling <code>cranelift/tests/filetests_with_trace.rs</code> which is mostly the same but configures <code>env_logger</code> or similar. That keeps it isolated into a single process at least.</p>
</blockquote>



<a name="511281732"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310538%20asm%3A%20fix%20trace%20logging%20of%20XMM%20registers/near/511281732" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310538.20asm.3A.20fix.20trace.20logging.20of.20XMM.20registers.html#511281732">(Apr 09 2025 at 23:49)</a>:</h4>
<p>abrown updated <a href="https://github.com/bytecodealliance/wasmtime/pull/10538">PR #10538</a>.</p>



<a name="511282437"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310538%20asm%3A%20fix%20trace%20logging%20of%20XMM%20registers/near/511282437" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310538.20asm.3A.20fix.20trace.20logging.20of.20XMM.20registers.html#511282437">(Apr 09 2025 at 23:55)</a>:</h4>
<p>abrown <a href="https://github.com/bytecodealliance/wasmtime/pull/10538#issuecomment-2791216454">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/10538">PR #10538</a>:</p>
<blockquote>
<p>This seems a bit like overkill but, hey, this virtual-vs-HW register panic keeps popping up. ea36958 adds a test to run all the filetests with logging enabled, which I confirmed catches the bug. When everything goes well, this is what I see time-wise:</p>
<div class="codehilite" data-code-language="Bash Session"><pre><span></span><code><span class="gp">$ </span>/usr/bin/time<span class="w"> </span>cargo<span class="w"> </span><span class="nb">test</span><span class="w"> </span>--package<span class="w"> </span>cranelift-tools<span class="w"> </span>--test<span class="w"> </span>filetests
<span class="go">...</span>
<span class="go">14.87user 0.13system 0:01.15elapsed 1304%CPU</span>
</code></pre></div>
<div class="codehilite" data-code-language="Bash Session"><pre><span></span><code><span class="gp">$ </span>/usr/bin/time<span class="w"> </span>cargo<span class="w"> </span><span class="nb">test</span><span class="w"> </span>--package<span class="w"> </span>cranelift-tools<span class="w"> </span>--test<span class="w"> </span>logged-filetests
<span class="go">...</span>
<span class="go">20.41user 0.29system 0:01.42elapsed 1451%CPU</span>
</code></pre></div>
<p>Of course, if anything goes poorly, then one can expect an afternoon-long wait while the test runner prints every log it has captured. I guess that is incentive to keep the pretty-printing working!</p>
</blockquote>



<a name="511287478"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310538%20asm%3A%20fix%20trace%20logging%20of%20XMM%20registers/near/511287478" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310538.20asm.3A.20fix.20trace.20logging.20of.20XMM.20registers.html#511287478">(Apr 10 2025 at 00:41)</a>:</h4>
<p>abrown merged <a href="https://github.com/bytecodealliance/wasmtime/pull/10538">PR #10538</a>.</p>



<hr><p>Last updated: Feb 22 2026 at 11:05 UTC</p>
</html>
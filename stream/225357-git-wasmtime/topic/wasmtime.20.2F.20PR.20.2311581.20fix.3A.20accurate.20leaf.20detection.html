<html>
<head><meta charset="utf-8"><title>wasmtime / PR #11581 fix: accurate leaf detection · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html">wasmtime / PR #11581 fix: accurate leaf detection</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="537088955"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537088955" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537088955">(Sep 01 2025 at 11:26)</a>:</h4>
<p>pnodet opened <a href="https://github.com/bytecodealliance/wasmtime/pull/11581">PR #11581</a> from <code>pnodet:pnodet-2</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>ensures that Cranelift's frame pointer optimization and stack checks are applied correctly based on the actual presence of call instructions in the generated machine code, rather than potentially inaccurate heuristics based on IR-level information.</p>
<p>- Scanning actual VCode instructions for calls<br>
  - Detecting all call types (direct, indirect, tail calls, libcalls)<br>
  - Using this for frame pointer optimization decisions<br>
  - Properly handling stack check insertion</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="537089046"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537089046" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537089046">(Sep 01 2025 at 11:27)</a>:</h4>
<p>pnodet edited <a href="https://github.com/bytecodealliance/wasmtime/pull/11581">PR #11581</a>:</p>
<blockquote>
<p>ensures that Cranelift's frame pointer optimization and stack checks are applied correctly based on the actual presence of call instructions in the generated machine code, rather than potentially inaccurate heuristics based on IR-level information.</p>
<p>- Scanning actual VCode instructions for calls<br>
  - Detecting all call types (direct, indirect, tail calls, libcalls)<br>
  - Using this for frame pointer optimization decisions<br>
  - Properly handling stack check insertion</p>
<p>Fix #11573</p>
</blockquote>



<a name="537089122"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537089122" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537089122">(Sep 01 2025 at 11:27)</a>:</h4>
<p>pnodet updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11581">PR #11581</a>.</p>



<a name="537089140"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537089140" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537089140">(Sep 01 2025 at 11:27)</a>:</h4>
<p><strong>pnodet</strong> has marked <a href="https://github.com/bytecodealliance/wasmtime/pull/11581">PR #11581</a> as ready for review.</p>



<a name="537089144"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537089144" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537089144">(Sep 01 2025 at 11:27)</a>:</h4>
<p><strong>pnodet</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/11581">PR #11581</a>.</p>



<a name="537089145"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537089145" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537089145">(Sep 01 2025 at 11:28)</a>:</h4>
<p><strong>pnodet</strong> requested <a href="https://github.com/alexcrichton">alexcrichton</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/11581">PR #11581</a>.</p>



<a name="537089693"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537089693" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537089693">(Sep 01 2025 at 11:31)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/11581#discussion_r2313702089">PR review comment</a>:</p>
<blockquote>
<p>Does this function even still need to exist?</p>
</blockquote>



<a name="537089694"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537089694" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537089694">(Sep 01 2025 at 11:31)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11581#pullrequestreview-3173287889">PR review</a>.</p>



<a name="537090414"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537090414" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537090414">(Sep 01 2025 at 11:35)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11581#pullrequestreview-3173299150">PR review</a>.</p>



<a name="537090415"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537090415" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537090415">(Sep 01 2025 at 11:35)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/11581#discussion_r2313709634">PR review comment</a>:</p>
<blockquote>
<p><code>self.insts.iter().any(|inst| inst.is_call())</code>?</p>
</blockquote>



<a name="537093296"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537093296" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537093296">(Sep 01 2025 at 11:50)</a>:</h4>
<p>pnodet submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11581#pullrequestreview-3173340395">PR review</a>.</p>



<a name="537093297"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537093297" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537093297">(Sep 01 2025 at 11:50)</a>:</h4>
<p>pnodet created <a href="https://github.com/bytecodealliance/wasmtime/pull/11581#discussion_r2313741943">PR review comment</a>:</p>
<blockquote>
<p>Indeed, looks cleaner, will change.</p>
</blockquote>



<a name="537093325"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537093325" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537093325">(Sep 01 2025 at 11:50)</a>:</h4>
<p>pnodet updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11581">PR #11581</a>.</p>



<a name="537093491"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537093491" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537093491">(Sep 01 2025 at 11:51)</a>:</h4>
<p>pnodet submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11581#pullrequestreview-3173343632">PR review</a>.</p>



<a name="537093492"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537093492" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537093492">(Sep 01 2025 at 11:51)</a>:</h4>
<p>pnodet created <a href="https://github.com/bytecodealliance/wasmtime/pull/11581#discussion_r2313744521">PR review comment</a>:</p>
<blockquote>
<p>I let @alexcrichton weigh in on this</p>
</blockquote>



<a name="537093511"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537093511" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537093511">(Sep 01 2025 at 11:52)</a>:</h4>
<p>pnodet edited <a href="https://github.com/bytecodealliance/wasmtime/pull/11581#discussion_r2313744521">PR review comment</a>.</p>



<a name="537175145"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537175145" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537175145">(Sep 01 2025 at 21:47)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11581#pullrequestreview-3174505935">PR review</a>:</p>
<blockquote>
<p>Thanks for working on this! Leaving a few thoughts below:</p>
</blockquote>



<a name="537175146"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537175146" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537175146">(Sep 01 2025 at 21:47)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/11581#discussion_r2314592859">PR review comment</a>:</p>
<blockquote>
<p>Rather than use a mutable setter pattern with action-at-a-distance plumbing, let's compute the property directly from the ABI code. We already make a pass to find clobbers and so we should be able to detect this at the same time.</p>
</blockquote>



<a name="537175147"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537175147" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537175147">(Sep 01 2025 at 21:47)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/11581#discussion_r2314594805">PR review comment</a>:</p>
<blockquote>
<p>A few things:</p>
<ul>
<li>We want to compute this during the clobber scan in ABI code, so let's not do a separate scan;</li>
<li>Providing an accessor method like this is (IMHO) slightly un-idiomatic, in that it hides a potentially expensive scan behind something that looks like a simple feature/flag test;</li>
<li>If we do add a helper, (tiny minor nit but) putting it right at the top of the VCode methods, before <code>fn new</code>, is probably not the place to do it to make the file read nicely.</li>
</ul>
</blockquote>



<a name="537175148"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537175148" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537175148">(Sep 01 2025 at 21:47)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/11581#discussion_r2314592277">PR review comment</a>:</p>
<blockquote>
<p>Thanks for adding these tests, but (i) they all appear to be testing <code>is_leaf</code>, which we want to remove, per above; (ii) they don't actually test the ABI behavior, which is visible only in the emitted code.</p>
<p>Could you add some compile filetests instead, showing disassemblies with and without frame-pointer setup? In particular I'd expect the case where I commented and asked for #11573 to be filed to revert back to no-frame-pointer.</p>
</blockquote>



<a name="537175149"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537175149" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537175149">(Sep 01 2025 at 21:47)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/11581#discussion_r2314588731">PR review comment</a>:</p>
<blockquote>
<p>(I'm not Alex, but I noted this issue originally and suggested that he file #11573 <a href="https://github.com/bytecodealliance/wasmtime/pull/11570#discussion_r2310845668">here</a>)</p>
<p>IMHO: we should remove this method -- firstly, we don't need it internally, and secondly, it's nearly impossible to use it for anything useful externally because of the caveats we have found. An API that looks "almost useful" but provides misleading or inaccurate results with both false positives <em>and</em> false negatives is a footgun shouldn't exist.</p>
</blockquote>



<a name="537175188"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537175188" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537175188">(Sep 01 2025 at 21:48)</a>:</h4>
<p>cfallin edited <a href="https://github.com/bytecodealliance/wasmtime/pull/11581#discussion_r2314588731">PR review comment</a>.</p>



<a name="537175549"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537175549" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537175549">(Sep 01 2025 at 21:53)</a>:</h4>
<p>pnodet <a href="https://github.com/bytecodealliance/wasmtime/pull/11581#issuecomment-3243300905">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11581">PR #11581</a>:</p>
<blockquote>
<p>Thanks for the suggestions @cfallin<br>
If it's okay with you all I'll wait for a decision on wether <code>is_leaf</code> should be removed or improved before implementing more changes</p>
</blockquote>



<a name="537175913"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537175913" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537175913">(Sep 01 2025 at 21:58)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/11581#issuecomment-3243305384">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11581">PR #11581</a>:</p>
<blockquote>
<blockquote>
<p>If it's okay with you all I'll wait for a decision on wether is_leaf should be removed or improved before implementing more changes</p>
</blockquote>
<p>As noted in my code review, please remove it, thanks!</p>
</blockquote>



<a name="537176417"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537176417" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537176417">(Sep 01 2025 at 22:04)</a>:</h4>
<p><strong>cfallin</strong> requested <a href="https://github.com/cfallin">cfallin</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/11581">PR #11581</a>.</p>



<a name="537176487"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537176487" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537176487">(Sep 01 2025 at 22:05)</a>:</h4>
<p>cfallin edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/11581#issuecomment-3243305384">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11581">PR #11581</a>:</p>
<blockquote>
<blockquote>
<p>If it's okay with you all I'll wait for a decision on wether is_leaf should be removed or improved before implementing more changes</p>
</blockquote>
<p>As noted in my code review, please remove it, thanks!</p>
<p>(In more detail: I am a core reviewer on Cranelift too and originally asked for the issue to be filed, so I'm happy to take the review; there isn't any other "decision" process, but you're welcome to raise any other concerns or, in the limit, take it to the Cranelift weekly meeting)</p>
</blockquote>



<a name="537178121"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537178121" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537178121">(Sep 01 2025 at 22:26)</a>:</h4>
<p>pnodet updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11581">PR #11581</a>.</p>



<a name="537179604"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537179604" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537179604">(Sep 01 2025 at 22:45)</a>:</h4>
<p>pnodet updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11581">PR #11581</a>.</p>



<a name="537180191"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537180191" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537180191">(Sep 01 2025 at 22:53)</a>:</h4>
<p>pnodet updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11581">PR #11581</a>.</p>



<a name="537180899"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537180899" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537180899">(Sep 01 2025 at 23:01)</a>:</h4>
<p>pnodet updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11581">PR #11581</a>.</p>



<a name="537231702"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537231702" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537231702">(Sep 02 2025 at 08:17)</a>:</h4>
<p>pnodet updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11581">PR #11581</a>.</p>



<a name="537232156"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537232156" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537232156">(Sep 02 2025 at 08:19)</a>:</h4>
<p>pnodet updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11581">PR #11581</a>.</p>



<a name="537236889"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537236889" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537236889">(Sep 02 2025 at 08:43)</a>:</h4>
<p>pnodet updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11581">PR #11581</a>.</p>



<a name="537237395"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537237395" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537237395">(Sep 02 2025 at 08:46)</a>:</h4>
<p>pnodet edited <a href="https://github.com/bytecodealliance/wasmtime/pull/11581">PR #11581</a>:</p>
<blockquote>
<p>## Problem</p>
<p>The previous leaf function detection in <code>FunctionStencil::is_leaf()</code> was overly conservative. It would incorrectly mark functions as non-leaf if they:</p>
<p>- Had any function signatures defined (even if unused)<br>
  - Referenced any TLS global values (even without calling)</p>
<p>This conservative approach prevented valid leaf functions from benefiting from frame pointer optimizations, particularly affecting performance when <code>preserve_frame_pointers=false</code>.</p>
<p>## Solution</p>
<p>This PR implements accurate leaf function detection by analyzing the actual generated machine code during the VCode register allocation phase. The new approach:</p>
<p>1. <strong>Adds <code>is_call()</code> method to <code>MachInst</code> trait</strong> - Each architecture implementation now identifies its call instructions (including indirect calls and tail calls)</p>
<p>2. <strong>Detects calls during register allocation</strong> - The <code>compute_clobbers()</code> method in VCode now tracks whether any actual call instructions exist</p>
<p>3. <strong>Removes the conservative <code>is_leaf()</code> method</strong> - The old method that made assumptions based on IR-level information is replaced</p>
<p>4. <strong>Provides comprehensive test coverage</strong> - Tests verify various scenarios including:</p>
<div class="codehilite"><pre><span></span><code> - True leaf functions (correctly identified as leaf)
 - Functions with unused signatures (correctly identified as leaf)
 - Functions with actual calls (correctly identified as non-leaf)
 - Functions taking function addresses (correctly identified as leaf)
</code></pre></div>

<p>Fix #11573</p>
</blockquote>



<a name="537237428"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537237428" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537237428">(Sep 02 2025 at 08:46)</a>:</h4>
<p><strong>pnodet</strong> has marked <a href="https://github.com/bytecodealliance/wasmtime/pull/11581">PR #11581</a> as ready for review.</p>



<a name="537240300"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537240300" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537240300">(Sep 02 2025 at 09:02)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11581#pullrequestreview-3175572928">PR review</a>.</p>



<a name="537240302"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537240302" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537240302">(Sep 02 2025 at 09:02)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/11581#discussion_r2315417197">PR review comment</a>:</p>
<blockquote>
<p>Do we actually need to set up a stack frame if the only call we would do is a tail call? Fair chance the tail call handling doesn't currently handle not having a stack frame, so this doesn't have to be changed in this PR. Just noting a potential optimization opportunity.</p>
</blockquote>



<a name="537240531"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537240531" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537240531">(Sep 02 2025 at 09:04)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11581#pullrequestreview-3175578793">PR review</a>.</p>



<a name="537240532"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537240532" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537240532">(Sep 02 2025 at 09:04)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/11581#discussion_r2315420723">PR review comment</a>:</p>
<blockquote>
<p>How hard would it be to return this value instead of mutating the <code>Callee</code>?</p>
</blockquote>



<a name="537240989"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537240989" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537240989">(Sep 02 2025 at 09:06)</a>:</h4>
<p>pnodet updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11581">PR #11581</a>.</p>



<a name="537242123"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537242123" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537242123">(Sep 02 2025 at 09:12)</a>:</h4>
<p>pnodet submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11581#pullrequestreview-3175606772">PR review</a>.</p>



<a name="537242125"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537242125" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537242125">(Sep 02 2025 at 09:12)</a>:</h4>
<p>pnodet created <a href="https://github.com/bytecodealliance/wasmtime/pull/11581#discussion_r2315441375">PR review comment</a>:</p>
<blockquote>
<p>@bjorn3 I don't think this would be too much of a hassle, I could see something like</p>
<p><div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gd">-  let clobbers = self.compute_clobbers(regalloc);</span>
<span class="gd">-  self.abi.compute_frame_layout(&amp;self.sigs, regalloc.num_spillslots, clobbers);</span>

<span class="gi">+  let (clobbers, is_leaf) = self.compute_clobbers(regalloc);</span>
<span class="gi">+  self.abi.set_is_leaf(is_leaf);</span>
<span class="gi">+  self.abi.compute_frame_layout(&amp;self.sigs, regalloc.num_spillslots, clobbers);</span>
</code></pre></div><br>
</p>
</blockquote>



<a name="537243490"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537243490" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537243490">(Sep 02 2025 at 09:19)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11581#pullrequestreview-3175637498">PR review</a>.</p>



<a name="537243491"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537243491" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537243491">(Sep 02 2025 at 09:19)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/11581#discussion_r2315464684">PR review comment</a>:</p>
<blockquote>
<p>This needs to be considered a call instruction too. As should the <code>blr x3 ; reloc_external Aarch64TlsDescCall u1:0 0</code> on arm64 and if it doesn't already happen whichever instruction is used for <code>__tls_get_addr</code> calls in the <code>tls_value</code> lowering on other platforms.</p>
</blockquote>



<a name="537243992"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537243992" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537243992">(Sep 02 2025 at 09:22)</a>:</h4>
<p>pnodet submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11581#pullrequestreview-3175650689">PR review</a>.</p>



<a name="537243993"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537243993" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537243993">(Sep 02 2025 at 09:22)</a>:</h4>
<p>pnodet created <a href="https://github.com/bytecodealliance/wasmtime/pull/11581#discussion_r2315474407">PR review comment</a>:</p>
<blockquote>
<p>@bjorn3 We could have  the vcode analysis distinguish </p>
<p>- Leaf: No calls at all<br>
  - Tail-call-only: Only tail calls<br>
  - Non-leaf: Has regular calls (with or without tail calls)</p>
<p>Something like </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">call_type</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">CallType</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">match</span><span class="w"> </span><span class="bp">self</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="n">Inst</span><span class="p">::</span><span class="n">Call</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="p">}</span>
<span class="w">          </span><span class="o">|</span><span class="w"> </span><span class="n">Inst</span><span class="p">::</span><span class="n">CallInd</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">CallType</span><span class="p">::</span><span class="n">Regular</span><span class="p">,</span>

<span class="w">          </span><span class="n">Inst</span><span class="p">::</span><span class="n">ReturnCall</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="p">}</span>
<span class="w">          </span><span class="o">|</span><span class="w"> </span><span class="n">Inst</span><span class="p">::</span><span class="n">ReturnCallInd</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="o">..</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">CallType</span><span class="p">::</span><span class="n">TailOnly</span><span class="p">,</span>

<span class="w">          </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">CallType</span><span class="p">::</span><span class="nb">None</span><span class="p">,</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
</code></pre></div>
<p>so that tail call only functions skip prologue and epilogue?</p>
</blockquote>



<a name="537244583"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537244583" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537244583">(Sep 02 2025 at 09:25)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11581#pullrequestreview-3175669468">PR review</a>.</p>



<a name="537244585"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537244585" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537244585">(Sep 02 2025 at 09:25)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/11581#discussion_r2315487327">PR review comment</a>:</p>
<blockquote>
<p>I meant removing <code>set_is_leaf</code> and the <code>is_leaf</code> field of <code>Callee</code> entirely and instead passing <code>is_leaf</code> around to functions that need it. I don't know how much of a hassle that would be.</p>
</blockquote>



<a name="537245104"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537245104" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537245104">(Sep 02 2025 at 09:28)</a>:</h4>
<p>pnodet updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11581">PR #11581</a>.</p>



<a name="537261363"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537261363" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537261363">(Sep 02 2025 at 11:08)</a>:</h4>
<p>pnodet submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11581#pullrequestreview-3176066310">PR review</a>.</p>



<a name="537261364"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537261364" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537261364">(Sep 02 2025 at 11:08)</a>:</h4>
<p>pnodet created <a href="https://github.com/bytecodealliance/wasmtime/pull/11581#discussion_r2315752471">PR review comment</a>:</p>
<blockquote>
<p>I'm wondering if in </p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/10d2cbc59d35b14c3027a8542f636c591b2ec96b/cranelift/codegen/src/isa/x64/abi.rs#L937">https://github.com/bytecodealliance/wasmtime/blob/10d2cbc59d35b14c3027a8542f636c591b2ec96b/cranelift/codegen/src/isa/x64/abi.rs#L937</a></p>
<p>Should we have something like</p>
<p><div class="codehilite" data-code-language="Diff"><pre><span></span><code><span class="gd">-          let setup_area_size = 16; // RBP, return address</span>
<span class="gi">+          let setup_area_size = is_leaf {</span>
<span class="gi">+              0</span>
<span class="gi">+          } else {</span>
<span class="gi">+              16 // RBP, return address</span>
<span class="gi">+          };</span>
</code></pre></div><br>
</p>
</blockquote>



<a name="537261501"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537261501" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537261501">(Sep 02 2025 at 11:08)</a>:</h4>
<p>pnodet submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11581#pullrequestreview-3176068807">PR review</a>.</p>



<a name="537261502"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537261502" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537261502">(Sep 02 2025 at 11:08)</a>:</h4>
<p>pnodet created <a href="https://github.com/bytecodealliance/wasmtime/pull/11581#discussion_r2315754353">PR review comment</a>:</p>
<blockquote>
<p>And also checking flags.preserve_frame_pointers</p>
</blockquote>



<a name="537263666"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537263666" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537263666">(Sep 02 2025 at 11:21)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11581#pullrequestreview-3176103237">PR review</a>.</p>



<a name="537263667"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537263667" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537263667">(Sep 02 2025 at 11:21)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/11581#discussion_r2315780668">PR review comment</a>:</p>
<blockquote>
<p>You mean for tail calls? I think those are best left to a separate PR.</p>
</blockquote>



<a name="537274394"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537274394" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537274394">(Sep 02 2025 at 12:25)</a>:</h4>
<p>pnodet updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11581">PR #11581</a>.</p>



<a name="537274437"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537274437" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537274437">(Sep 02 2025 at 12:25)</a>:</h4>
<p><strong>pnodet</strong> requested <a href="https://github.com/bjorn3">bjorn3</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/11581">PR #11581</a>.</p>



<a name="537274506"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537274506" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537274506">(Sep 02 2025 at 12:25)</a>:</h4>
<p>pnodet submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11581#pullrequestreview-3176316110">PR review</a>.</p>



<a name="537274509"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537274509" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537274509">(Sep 02 2025 at 12:25)</a>:</h4>
<p>pnodet created <a href="https://github.com/bytecodealliance/wasmtime/pull/11581#discussion_r2315927594">PR review comment</a>:</p>
<blockquote>
<p>I made another pass on this</p>
</blockquote>



<a name="537274821"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537274821" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537274821">(Sep 02 2025 at 12:27)</a>:</h4>
<p>pnodet updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11581">PR #11581</a>.</p>



<a name="537275216"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537275216" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537275216">(Sep 02 2025 at 12:29)</a>:</h4>
<p>pnodet edited <a href="https://github.com/bytecodealliance/wasmtime/pull/11581">PR #11581</a>:</p>
<blockquote>
<p>## Problem</p>
<p>The previous leaf function detection in <code>FunctionStencil::is_leaf()</code> was overly conservative. It would incorrectly mark functions as non-leaf if they:</p>
<p>- Had any function signatures defined (even if unused)<br>
  - Referenced any TLS global values (even without calling)</p>
<p>## Solution</p>
<p>This PR implements accurate leaf function detection by analyzing the actual generated machine code during the VCode register allocation phase. The new approach:</p>
<p>1. <strong>Adds <code>is_call()</code> method to <code>MachInst</code> trait</strong> - Each architecture implementation now identifies its call instructions (including indirect calls and tail calls)</p>
<p>2. <strong>Detects calls during register allocation</strong> - The <code>compute_clobbers()</code> method in VCode now tracks whether any actual call instructions exist</p>
<p>3. <strong>Removes the conservative <code>is_leaf()</code> method</strong> - The old method that made assumptions based on IR-level information is replaced</p>
<p>Fix #11573</p>
</blockquote>



<a name="537276000"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537276000" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537276000">(Sep 02 2025 at 12:34)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11581#pullrequestreview-3176347349">PR review</a>.</p>



<a name="537276001"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537276001" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537276001">(Sep 02 2025 at 12:34)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/11581#discussion_r2315948672">PR review comment</a>:</p>
<blockquote>
<div class="codehilite" data-code-language="suggestion"><pre><span></span><code>            | Inst::MachOTlsGetAddr { .. } =&gt; true,
</code></pre></div>
<p>PE/COFF unlike other object file formats directly emits a <code>%fs</code> relative access rather than by emitting a call that may later be relaxed by the linker.</p>
</blockquote>



<a name="537276439"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537276439" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537276439">(Sep 02 2025 at 12:36)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11581#pullrequestreview-3176355006">PR review</a>.</p>



<a name="537296989"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537296989" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537296989">(Sep 02 2025 at 14:16)</a>:</h4>
<p>pnodet updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11581">PR #11581</a>.</p>



<a name="537297264"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537297264" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537297264">(Sep 02 2025 at 14:17)</a>:</h4>
<p>pnodet <a href="https://github.com/bytecodealliance/wasmtime/pull/11581#issuecomment-3245557638">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11581">PR #11581</a>:</p>
<blockquote>
<p>@cfallin I've updated this PR thanks to the given insights and to reflect the changes discussed above, would mind giving it another look?</p>
</blockquote>



<a name="537322177"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537322177" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537322177">(Sep 02 2025 at 16:18)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11581#pullrequestreview-3177286685">PR review</a>:</p>
<blockquote>
<p>Thanks for the updates! Looks generally good now. Just a few small nits below; happy to merge once those are changed.</p>
</blockquote>



<a name="537322178"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537322178" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537322178">(Sep 02 2025 at 16:18)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/11581#discussion_r2316576585">PR review comment</a>:</p>
<blockquote>
<p>Tiny nit, but our style is usually to end comments with a <code>.</code>.</p>
</blockquote>



<a name="537322179"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537322179" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537322179">(Sep 02 2025 at 16:18)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/11581#discussion_r2316581592">PR review comment</a>:</p>
<blockquote>
<p>Can we update the header comment here to note that we're including the test for completeness with respect to other ISAs, but that x64 does not yet implement the leaf-function optimization, so frame setup is still present below?</p>
</blockquote>



<a name="537322180"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537322180" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537322180">(Sep 02 2025 at 16:18)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/11581#discussion_r2316575804">PR review comment</a>:</p>
<blockquote>
<p>Let's call this <code>compute_clobbers_and_leaf</code> for clarity, now that it returns both.</p>
</blockquote>



<a name="537322703"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537322703" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537322703">(Sep 02 2025 at 16:22)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11581#pullrequestreview-3177312289">PR review</a>.</p>



<a name="537322705"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537322705" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537322705">(Sep 02 2025 at 16:22)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/11581#discussion_r2316590259">PR review comment</a>:</p>
<blockquote>
<p>x64 actually doesn't implement the leaf-function optimization at all (it is a bit different than the other ISAs because the call still pushes the return address; that created some complications that I'm forgetting at the moment; in any case, indeed, that is territory for a separate PR).</p>
</blockquote>



<a name="537322998"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537322998" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537322998">(Sep 02 2025 at 16:23)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11581#pullrequestreview-3177316211">PR review</a>.</p>



<a name="537322999"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537322999" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537322999">(Sep 02 2025 at 16:23)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/11581#discussion_r2316593216">PR review comment</a>:</p>
<blockquote>
<p>Let's leave tail call support for a separate PR as well -- it would be nice to have, but the tail-call implementation itself is quite finicky and specific to our frame layout, and would need updating as well; in other words, it's not just a matter of omitting the prologue.</p>
</blockquote>



<a name="537370835"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537370835" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537370835">(Sep 02 2025 at 22:04)</a>:</h4>
<p>pnodet updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11581">PR #11581</a>.</p>



<a name="537371024"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537371024" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537371024">(Sep 02 2025 at 22:06)</a>:</h4>
<p>pnodet <a href="https://github.com/bytecodealliance/wasmtime/pull/11581#issuecomment-3246939833">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11581">PR #11581</a>:</p>
<blockquote>
<p>Thanks for the review. I made the changes you pointed out. I'll let you merge at your own convenience! </p>
</blockquote>



<a name="537371066"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537371066" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537371066">(Sep 02 2025 at 22:06)</a>:</h4>
<p>pnodet updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11581">PR #11581</a>.</p>



<a name="537371535"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537371535" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537371535">(Sep 02 2025 at 22:11)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11581#pullrequestreview-3178289319">PR review</a>:</p>
<blockquote>
<p>Thanks!</p>
</blockquote>



<a name="537371542"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537371542" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537371542">(Sep 02 2025 at 22:11)</a>:</h4>
<p>cfallin has enabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/11581">PR #11581</a>.</p>



<a name="537373215"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537373215" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537373215">(Sep 02 2025 at 22:28)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/11581#issuecomment-3246997137">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11581">PR #11581</a>:</p>
<blockquote>
<p>@pnodet it looks like this needs some test expectation updates (use the "bless" environment variable to do this then commit the deltas in a separate commit) -- happy to merge once CI is green.</p>
</blockquote>



<a name="537375142"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537375142" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537375142">(Sep 02 2025 at 22:51)</a>:</h4>
<p>pnodet updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11581">PR #11581</a>.</p>



<a name="537375143"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537375143" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537375143">(Sep 02 2025 at 22:51)</a>:</h4>
<p>cfallin has disabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/11581">PR #11581</a>.</p>



<a name="537375276"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537375276" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537375276">(Sep 02 2025 at 22:52)</a>:</h4>
<p>pnodet <a href="https://github.com/bytecodealliance/wasmtime/pull/11581#issuecomment-3247046828">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11581">PR #11581</a>:</p>
<blockquote>
<p>@cfallin Indeed, this was from newly added tests and I hadn't rebased the main branch since</p>
</blockquote>



<a name="537398861"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537398861" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537398861">(Sep 03 2025 at 04:37)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/11581#issuecomment-3247656890">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11581">PR #11581</a>:</p>
<blockquote>
<p>@pnodet there is a failure when testing this PR on the merge queue because <code>main</code> now has new filetests whose outputs shift with this PR. Could you merge (not rebase) <code>main</code> and then in a separate commit, update filetest outputs?</p>
</blockquote>



<a name="537410065"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537410065" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537410065">(Sep 03 2025 at 06:42)</a>:</h4>
<p>pnodet updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11581">PR #11581</a>.</p>



<a name="537457080"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537457080" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537457080">(Sep 03 2025 at 11:44)</a>:</h4>
<p>pnodet edited <a href="https://github.com/bytecodealliance/wasmtime/pull/11581">PR #11581</a>:</p>
<blockquote>
<p>## Problem</p>
<p>The previous leaf function detection in <code>FunctionStencil::is_leaf()</code> was overly conservative. It would incorrectly mark functions as non-leaf if they:</p>
<p>- Had any function signatures defined (even if unused)<br>
  - Referenced any TLS global values (even without calling)</p>
<p>## Solution</p>
<p>This PR implements accurate leaf function detection by analyzing the actual generated machine code during the VCode register allocation phase. The new approach:</p>
<p>1. <strong>Adds <code>is_call()</code> method to <code>MachInst</code> trait</strong> - Each architecture implementation now identifies its call instructions (including indirect calls and tail calls)</p>
<p>2. <strong>Detects calls during register allocation</strong> - The <code>compute_clobbers()</code> method in VCode now tracks whether any actual call instructions exist</p>
<p>3. <strong>Removes the conservative <code>is_leaf()</code> method</strong> - The old method that made assumptions based on IR-level information is replaced</p>
<p>Fixes #11573</p>
</blockquote>



<a name="537512372"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537512372" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537512372">(Sep 03 2025 at 16:20)</a>:</h4>
<p>cfallin merged <a href="https://github.com/bytecodealliance/wasmtime/pull/11581">PR #11581</a>.</p>



<a name="537515432"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311581%20fix%3A%20accurate%20leaf%20detection/near/537515432" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311581.20fix.3A.20accurate.20leaf.20detection.html#537515432">(Sep 03 2025 at 16:35)</a>:</h4>
<p>pnodet <a href="https://github.com/bytecodealliance/wasmtime/pull/11581#issuecomment-3249968386">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11581">PR #11581</a>:</p>
<blockquote>
<p>@cfallin @bjorn3 Thanks!</p>
</blockquote>



<hr><p>Last updated: Feb 22 2026 at 11:05 UTC</p>
</html>
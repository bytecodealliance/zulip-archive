<html>
<head><meta charset="utf-8"><title>wasmtime / issue #12033 Support load sinking across notra... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312033.20Support.20load.20sinking.20across.20notra.2E.2E.2E.html">wasmtime / issue #12033 Support load sinking across notra...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="556605380"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312033%20Support%20load%20sinking%20across%20notra.../near/556605380" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312033.20Support.20load.20sinking.20across.20notra.2E.2E.2E.html#556605380">(Nov 15 2025 at 13:23)</a>:</h4>
<p>bjorn3 opened <a href="https://github.com/bytecodealliance/wasmtime/issues/12033">issue #12033</a>:</p>
<blockquote>
<h4>Feature</h4>
<p>For example for subtracting 2 mathematical vectors with 3 elements like so:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">function</span><span class="w"> </span><span class="n">u0</span><span class="p">:</span><span class="mi">0</span><span class="p">(</span><span class="kt">i64</span><span class="w"> </span><span class="n">sret</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span><span class="n">system_v</span><span class="w"> </span><span class="p">{</span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span><span class="p">:</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="p">:</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v2</span><span class="p">:</span><span class="w"> </span><span class="kt">i64</span><span class="p">):</span>
<span class="w">    </span><span class="nc">v3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">f64</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">v1</span>
<span class="w">    </span><span class="n">v4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">f64</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">v2</span>
<span class="w">    </span><span class="n">v6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">f64</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">v1</span><span class="o">+</span><span class="mi">8</span>
<span class="w">    </span><span class="n">v7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">f64</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">v2</span><span class="o">+</span><span class="mi">8</span>
<span class="w">    </span><span class="n">v9</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">f64</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">v1</span><span class="o">+</span><span class="mi">16</span>
<span class="w">    </span><span class="n">v10</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">f64</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">v2</span><span class="o">+</span><span class="mi">16</span>
<span class="w">    </span><span class="n">v5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fsub</span><span class="w"> </span><span class="n">v3</span><span class="p">,</span><span class="w"> </span><span class="n">v4</span>
<span class="w">    </span><span class="n">store</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">v5</span><span class="p">,</span><span class="w"> </span><span class="n">v0</span>
<span class="w">    </span><span class="n">v8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fsub</span><span class="w"> </span><span class="n">v6</span><span class="p">,</span><span class="w"> </span><span class="n">v7</span>
<span class="w">    </span><span class="n">store</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">v8</span><span class="p">,</span><span class="w"> </span><span class="n">v0</span><span class="o">+</span><span class="mi">8</span>
<span class="w">    </span><span class="n">v11</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fsub</span><span class="w"> </span><span class="n">v9</span><span class="p">,</span><span class="w"> </span><span class="n">v10</span>
<span class="w">    </span><span class="n">store</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">v11</span><span class="p">,</span><span class="w"> </span><span class="n">v0</span><span class="o">+</span><span class="mi">16</span>
<span class="w">    </span><span class="k">return</span>
<span class="p">}</span>
</code></pre></div>
<p>6 load instructions will be generated followed by 3 pairs of sub + store:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="mi">0000000000000000</span><span class="w"> </span><span class="o">&lt;</span><span class="n">sub</span><span class="o">&gt;</span><span class="p">:</span>
<span class="w">   </span><span class="mi">0</span><span class="p">:</span><span class="w">   </span><span class="mi">55</span><span class="w">                      </span><span class="n">push</span><span class="w">   </span><span class="n">rbp</span>
<span class="w">   </span><span class="mi">1</span><span class="p">:</span><span class="w">   </span><span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">e5</span><span class="w">                </span><span class="n">mov</span><span class="w">    </span><span class="n">rbp</span><span class="p">,</span><span class="n">rsp</span>
<span class="w">   </span><span class="mi">4</span><span class="p">:</span><span class="w">   </span><span class="nc">f2</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="mi">3</span><span class="n">e</span><span class="w">             </span><span class="n">movsd</span><span class="w">  </span><span class="n">xmm7</span><span class="p">,</span><span class="n">QWORD</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span><span class="p">[</span><span class="n">rsi</span><span class="p">]</span>
<span class="w">   </span><span class="mi">8</span><span class="p">:</span><span class="w">   </span><span class="nc">f2</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="mi">2</span><span class="n">a</span><span class="w">             </span><span class="n">movsd</span><span class="w">  </span><span class="n">xmm5</span><span class="p">,</span><span class="n">QWORD</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span><span class="p">[</span><span class="n">rdx</span><span class="p">]</span>
<span class="w">   </span><span class="n">c</span><span class="p">:</span><span class="w">   </span><span class="nc">f2</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="mi">46</span><span class="w"> </span><span class="mi">08</span><span class="w">          </span><span class="n">movsd</span><span class="w">  </span><span class="n">xmm0</span><span class="p">,</span><span class="n">QWORD</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span><span class="p">[</span><span class="n">rsi</span><span class="o">+</span><span class="mh">0x8</span><span class="p">]</span>
<span class="w">  </span><span class="mi">11</span><span class="p">:</span><span class="w">   </span><span class="nc">f2</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="mi">72</span><span class="w"> </span><span class="mi">08</span><span class="w">          </span><span class="n">movsd</span><span class="w">  </span><span class="n">xmm6</span><span class="p">,</span><span class="n">QWORD</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span><span class="p">[</span><span class="n">rdx</span><span class="o">+</span><span class="mh">0x8</span><span class="p">]</span>
<span class="w">  </span><span class="mi">16</span><span class="p">:</span><span class="w">   </span><span class="nc">f2</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="mi">4</span><span class="n">e</span><span class="w"> </span><span class="mi">10</span><span class="w">          </span><span class="n">movsd</span><span class="w">  </span><span class="n">xmm1</span><span class="p">,</span><span class="n">QWORD</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span><span class="p">[</span><span class="n">rsi</span><span class="o">+</span><span class="mh">0x10</span><span class="p">]</span>
<span class="w">  </span><span class="mi">1</span><span class="n">b</span><span class="p">:</span><span class="w">   </span><span class="nc">f2</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="mi">52</span><span class="w"> </span><span class="mi">10</span><span class="w">          </span><span class="n">movsd</span><span class="w">  </span><span class="n">xmm2</span><span class="p">,</span><span class="n">QWORD</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span><span class="p">[</span><span class="n">rdx</span><span class="o">+</span><span class="mh">0x10</span><span class="p">]</span>
<span class="w">  </span><span class="mi">20</span><span class="p">:</span><span class="w">   </span><span class="nc">f2</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">5</span><span class="n">c</span><span class="w"> </span><span class="n">fd</span><span class="w">             </span><span class="n">subsd</span><span class="w">  </span><span class="n">xmm7</span><span class="p">,</span><span class="n">xmm5</span>
<span class="w">  </span><span class="mi">24</span><span class="p">:</span><span class="w">   </span><span class="nc">f2</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="mi">3</span><span class="n">f</span><span class="w">             </span><span class="n">movsd</span><span class="w">  </span><span class="n">QWORD</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span><span class="p">[</span><span class="n">rdi</span><span class="p">],</span><span class="n">xmm7</span>
<span class="w">  </span><span class="mi">28</span><span class="p">:</span><span class="w">   </span><span class="nc">f2</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">5</span><span class="n">c</span><span class="w"> </span><span class="n">c6</span><span class="w">             </span><span class="n">subsd</span><span class="w">  </span><span class="n">xmm0</span><span class="p">,</span><span class="n">xmm6</span>
<span class="w">  </span><span class="mi">2</span><span class="n">c</span><span class="p">:</span><span class="w">   </span><span class="nc">f2</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="mi">47</span><span class="w"> </span><span class="mi">08</span><span class="w">          </span><span class="n">movsd</span><span class="w">  </span><span class="n">QWORD</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span><span class="p">[</span><span class="n">rdi</span><span class="o">+</span><span class="mh">0x8</span><span class="p">],</span><span class="n">xmm0</span>
<span class="w">  </span><span class="mi">31</span><span class="p">:</span><span class="w">   </span><span class="nc">f2</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">5</span><span class="n">c</span><span class="w"> </span><span class="n">ca</span><span class="w">             </span><span class="n">subsd</span><span class="w">  </span><span class="n">xmm1</span><span class="p">,</span><span class="n">xmm2</span>
<span class="w">  </span><span class="mi">35</span><span class="p">:</span><span class="w">   </span><span class="nc">f2</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="mi">4</span><span class="n">f</span><span class="w"> </span><span class="mi">10</span><span class="w">          </span><span class="n">movsd</span><span class="w">  </span><span class="n">QWORD</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span><span class="p">[</span><span class="n">rdi</span><span class="o">+</span><span class="mh">0x10</span><span class="p">],</span><span class="n">xmm1</span>
<span class="w">  </span><span class="mi">3</span><span class="n">a</span><span class="p">:</span><span class="w">   </span><span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">f8</span><span class="w">                </span><span class="n">mov</span><span class="w">    </span><span class="n">rax</span><span class="p">,</span><span class="n">rdi</span>
<span class="w">  </span><span class="mi">3</span><span class="n">d</span><span class="p">:</span><span class="w">   </span><span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">ec</span><span class="w">                </span><span class="n">mov</span><span class="w">    </span><span class="n">rsp</span><span class="p">,</span><span class="n">rbp</span>
<span class="w">  </span><span class="mi">40</span><span class="p">:</span><span class="w">   </span><span class="mi">5</span><span class="n">d</span><span class="w">                      </span><span class="n">pop</span><span class="w">    </span><span class="n">rbp</span>
<span class="w">  </span><span class="mi">41</span><span class="p">:</span><span class="w">   </span><span class="nc">c3</span><span class="w">                      </span><span class="n">ret</span>
</code></pre></div>
<p>while LLVM is able to sink half the loads into the <code>subsd</code> instructions themself even with -O0:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">  </span><span class="n">sub</span><span class="p">:</span>
<span class="w">        </span><span class="nc">mov</span><span class="w">     </span><span class="n">rax</span><span class="p">,</span><span class="w"> </span><span class="n">rdi</span>
<span class="w">        </span><span class="n">movsd</span><span class="w">   </span><span class="n">xmm2</span><span class="p">,</span><span class="w"> </span><span class="n">qword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="p">[</span><span class="n">rsi</span><span class="p">]</span>
<span class="w">        </span><span class="n">subsd</span><span class="w">   </span><span class="n">xmm2</span><span class="p">,</span><span class="w"> </span><span class="n">qword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="p">[</span><span class="n">rdx</span><span class="p">]</span>
<span class="w">        </span><span class="n">movsd</span><span class="w">   </span><span class="n">xmm1</span><span class="p">,</span><span class="w"> </span><span class="n">qword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="p">[</span><span class="n">rsi</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">8</span><span class="p">]</span>
<span class="w">        </span><span class="n">subsd</span><span class="w">   </span><span class="n">xmm1</span><span class="p">,</span><span class="w"> </span><span class="n">qword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="p">[</span><span class="n">rdx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">8</span><span class="p">]</span>
<span class="w">        </span><span class="n">movsd</span><span class="w">   </span><span class="n">xmm0</span><span class="p">,</span><span class="w"> </span><span class="n">qword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="p">[</span><span class="n">rsi</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">16</span><span class="p">]</span>
<span class="w">        </span><span class="n">subsd</span><span class="w">   </span><span class="n">xmm0</span><span class="p">,</span><span class="w"> </span><span class="n">qword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="p">[</span><span class="n">rdx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">16</span><span class="p">]</span>
<span class="w">        </span><span class="n">movsd</span><span class="w">   </span><span class="n">qword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="p">[</span><span class="n">rdi</span><span class="p">],</span><span class="w"> </span><span class="n">xmm2</span>
<span class="w">        </span><span class="n">movsd</span><span class="w">   </span><span class="n">qword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="p">[</span><span class="n">rdi</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">8</span><span class="p">],</span><span class="w"> </span><span class="n">xmm1</span>
<span class="w">        </span><span class="n">movsd</span><span class="w">   </span><span class="n">qword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="p">[</span><span class="n">rdi</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">16</span><span class="p">],</span><span class="w"> </span><span class="n">xmm0</span>
<span class="w">        </span><span class="n">ret</span>
</code></pre></div>
<p>Cranelift is not entirely incapable of load sinking as seen for a dot product where it does load sink a single load:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">function</span><span class="w"> </span><span class="n">u0</span><span class="p">:</span><span class="mi">0</span><span class="p">(</span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">f64</span><span class="w"> </span><span class="nc">system_v</span><span class="w"> </span><span class="p">{</span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span><span class="p">:</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="p">:</span><span class="w"> </span><span class="kt">i64</span><span class="p">):</span>
<span class="w">    </span><span class="nc">v3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">f64</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">v0</span>
<span class="w">    </span><span class="n">v4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">f64</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">v1</span>
<span class="w">    </span><span class="n">v6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">f64</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">v0</span><span class="o">+</span><span class="mi">8</span>
<span class="w">    </span><span class="n">v7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">f64</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">v1</span><span class="o">+</span><span class="mi">8</span>
<span class="w">    </span><span class="n">v10</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">f64</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">v0</span><span class="o">+</span><span class="mi">16</span>
<span class="w">    </span><span class="n">v11</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">f64</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">v1</span><span class="o">+</span><span class="mi">16</span>
<span class="w">    </span><span class="n">v5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fmul</span><span class="w"> </span><span class="n">v3</span><span class="p">,</span><span class="w"> </span><span class="n">v4</span>
<span class="w">    </span><span class="n">v8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fmul</span><span class="w"> </span><span class="n">v6</span><span class="p">,</span><span class="w"> </span><span class="n">v7</span>
<span class="w">    </span><span class="n">v9</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fadd</span><span class="w"> </span><span class="n">v5</span><span class="p">,</span><span class="w"> </span><span class="n">v8</span>
<span class="w">    </span><span class="n">v12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fmul</span><span class="w"> </span><span class="n">v10</span><span class="p">,</span><span class="w"> </span><span class="n">v11</span>
<span class="w">    </span><span class="n">v13</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fadd</span><span class="w"> </span><span class="n">v9</span><span class="p">,</span><span class="w"> </span><span class="n">v12</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v13</span>
<span class="p">}</span>
</code></pre></div>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="mi">0000000000000000</span><span class="w"> </span><span class="o">&lt;</span><span class="n">dot</span><span class="o">&gt;</span><span class="p">:</span>
<span class="w">   </span><span class="mi">0</span><span class="p">:</span><span class="w">   </span><span class="mi">55</span><span class="w">                      </span><span class="n">push</span><span class="w">   </span><span class="n">rbp</span>
<span class="w">   </span><span class="mi">1</span><span class="p">:</span><span class="w">   </span><span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">e5</span><span class="w">                </span><span class="n">mov</span><span class="w">    </span><span class="n">rbp</span><span class="p">,</span><span class="n">rsp</span>
<span class="w">   </span><span class="mi">4</span><span class="p">:</span><span class="w">   </span><span class="nc">f2</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="mi">07</span><span class="w">             </span><span class="n">movsd</span><span class="w">  </span><span class="n">xmm0</span><span class="p">,</span><span class="n">QWORD</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span><span class="p">[</span><span class="n">rdi</span><span class="p">]</span>
<span class="w">   </span><span class="mi">8</span><span class="p">:</span><span class="w">   </span><span class="nc">f2</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="mi">2</span><span class="n">e</span><span class="w">             </span><span class="n">movsd</span><span class="w">  </span><span class="n">xmm5</span><span class="p">,</span><span class="n">QWORD</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span><span class="p">[</span><span class="n">rsi</span><span class="p">]</span>
<span class="w">   </span><span class="n">c</span><span class="p">:</span><span class="w">   </span><span class="nc">f2</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="mi">4</span><span class="n">f</span><span class="w"> </span><span class="mi">08</span><span class="w">          </span><span class="n">movsd</span><span class="w">  </span><span class="n">xmm1</span><span class="p">,</span><span class="n">QWORD</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span><span class="p">[</span><span class="n">rdi</span><span class="o">+</span><span class="mh">0x8</span><span class="p">]</span>
<span class="w">  </span><span class="mi">11</span><span class="p">:</span><span class="w">   </span><span class="nc">f2</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="mi">76</span><span class="w"> </span><span class="mi">08</span><span class="w">          </span><span class="n">movsd</span><span class="w">  </span><span class="n">xmm6</span><span class="p">,</span><span class="n">QWORD</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span><span class="p">[</span><span class="n">rsi</span><span class="o">+</span><span class="mh">0x8</span><span class="p">]</span>
<span class="w">  </span><span class="mi">16</span><span class="p">:</span><span class="w">   </span><span class="nc">f2</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="mi">57</span><span class="w"> </span><span class="mi">10</span><span class="w">          </span><span class="n">movsd</span><span class="w">  </span><span class="n">xmm2</span><span class="p">,</span><span class="n">QWORD</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span><span class="p">[</span><span class="n">rdi</span><span class="o">+</span><span class="mh">0x10</span><span class="p">]</span>
<span class="w">  </span><span class="mi">1</span><span class="n">b</span><span class="p">:</span><span class="w">   </span><span class="nc">f2</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">59</span><span class="w"> </span><span class="n">c5</span><span class="w">             </span><span class="n">mulsd</span><span class="w">  </span><span class="n">xmm0</span><span class="p">,</span><span class="n">xmm5</span>
<span class="w">  </span><span class="mi">1</span><span class="n">f</span><span class="p">:</span><span class="w">   </span><span class="nc">f2</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">59</span><span class="w"> </span><span class="n">ce</span><span class="w">             </span><span class="n">mulsd</span><span class="w">  </span><span class="n">xmm1</span><span class="p">,</span><span class="n">xmm6</span>
<span class="w">  </span><span class="mi">23</span><span class="p">:</span><span class="w">   </span><span class="nc">f2</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">58</span><span class="w"> </span><span class="n">c1</span><span class="w">             </span><span class="n">addsd</span><span class="w">  </span><span class="n">xmm0</span><span class="p">,</span><span class="n">xmm1</span>
<span class="w">  </span><span class="mi">27</span><span class="p">:</span><span class="w">   </span><span class="nc">f2</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">59</span><span class="w"> </span><span class="mi">56</span><span class="w"> </span><span class="mi">10</span><span class="w">          </span><span class="n">mulsd</span><span class="w">  </span><span class="n">xmm2</span><span class="p">,</span><span class="n">QWORD</span><span class="w"> </span><span class="n">PTR</span><span class="w"> </span><span class="p">[</span><span class="n">rsi</span><span class="o">+</span><span class="mh">0x10</span><span class="p">]</span>
<span class="w">  </span><span class="mi">2</span><span class="n">c</span><span class="p">:</span><span class="w">   </span><span class="nc">f2</span><span class="w"> </span><span class="mi">0</span><span class="n">f</span><span class="w"> </span><span class="mi">58</span><span class="w"> </span><span class="n">c2</span><span class="w">             </span><span class="n">addsd</span><span class="w">  </span><span class="n">xmm0</span><span class="p">,</span><span class="n">xmm2</span>
<span class="w">  </span><span class="mi">30</span><span class="p">:</span><span class="w">   </span><span class="mi">48</span><span class="w"> </span><span class="mi">89</span><span class="w"> </span><span class="n">ec</span><span class="w">                </span><span class="n">mov</span><span class="w">    </span><span class="n">rsp</span><span class="p">,</span><span class="n">rbp</span>
<span class="w">  </span><span class="mi">33</span><span class="p">:</span><span class="w">   </span><span class="mi">5</span><span class="n">d</span><span class="w">                      </span><span class="n">pop</span><span class="w">    </span><span class="n">rbp</span>
<span class="w">  </span><span class="mi">34</span><span class="p">:</span><span class="w">   </span><span class="nc">c3</span><span class="w">                      </span><span class="n">ret</span>
</code></pre></div>
<p>but again even LLVM -O0 will load sink all 3 possible loads:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">dot</span><span class="p">:</span>
<span class="w">        </span><span class="nc">mov</span><span class="w">     </span><span class="n">qword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="p">[</span><span class="n">rsp</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">8</span><span class="p">],</span><span class="w"> </span><span class="n">rdi</span>
<span class="w">        </span><span class="n">movsd</span><span class="w">   </span><span class="n">xmm0</span><span class="p">,</span><span class="w"> </span><span class="n">qword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="p">[</span><span class="n">rdi</span><span class="p">]</span>
<span class="w">        </span><span class="n">mulsd</span><span class="w">   </span><span class="n">xmm0</span><span class="p">,</span><span class="w"> </span><span class="n">qword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="p">[</span><span class="n">rsi</span><span class="p">]</span>
<span class="w">        </span><span class="n">movsd</span><span class="w">   </span><span class="n">xmm1</span><span class="p">,</span><span class="w"> </span><span class="n">qword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="p">[</span><span class="n">rdi</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">8</span><span class="p">]</span>
<span class="w">        </span><span class="n">mulsd</span><span class="w">   </span><span class="n">xmm1</span><span class="p">,</span><span class="w"> </span><span class="n">qword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="p">[</span><span class="n">rsi</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">8</span><span class="p">]</span>
<span class="w">        </span><span class="n">addsd</span><span class="w">   </span><span class="n">xmm0</span><span class="p">,</span><span class="w"> </span><span class="n">xmm1</span>
<span class="w">        </span><span class="n">movsd</span><span class="w">   </span><span class="n">xmm1</span><span class="p">,</span><span class="w"> </span><span class="n">qword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="p">[</span><span class="n">rdi</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">16</span><span class="p">]</span>
<span class="w">        </span><span class="n">mulsd</span><span class="w">   </span><span class="n">xmm1</span><span class="p">,</span><span class="w"> </span><span class="n">qword</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="p">[</span><span class="n">rsi</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">16</span><span class="p">]</span>
<span class="w">        </span><span class="n">addsd</span><span class="w">   </span><span class="n">xmm0</span><span class="p">,</span><span class="w"> </span><span class="n">xmm1</span>
<span class="w">        </span><span class="n">ret</span>
</code></pre></div>
<p>These examples are taken from <a href="https://github.com/ebobby/simple-raytracer/blob/496b6164b9f16250f99b91327da8f01acc1e3534/src/vector.rs">https://github.com/ebobby/simple-raytracer/blob/496b6164b9f16250f99b91327da8f01acc1e3534/src/vector.rs</a> compiled with both cg_clif (<code>-Copt-level=3</code>) and cg_llvm (<code>-Copt-level=0</code>).</p>
<h4>Benefit</h4>
<p>Improves runtime performance.</p>
<h4>Implementation</h4>
<p>I think this is caused by <code>get_value_as_source_or_const</code> considering loads as having side-effects even when they are <code>notrap</code>.</p>
<h4>Alternatives</h4>
<p>TODO: What are the alternative implementation approaches or alternative ways to<br>
solve the problem that this feature would solve? How do these alternatives<br>
compare to this proposal?<br>
</p>
</blockquote>



<a name="556605413"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312033%20Support%20load%20sinking%20across%20notra.../near/556605413" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312033.20Support.20load.20sinking.20across.20notra.2E.2E.2E.html#556605413">(Nov 15 2025 at 13:24)</a>:</h4>
<p>bjorn3 edited <a href="https://github.com/bytecodealliance/wasmtime/issues/12033">issue #12033</a>:</p>
<blockquote>
<h4>Feature</h4>
<p>For example for subtracting 2 mathematical vectors with 3 elements like so:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">function</span><span class="w"> </span><span class="n">u0</span><span class="p">:</span><span class="mi">0</span><span class="p">(</span><span class="kt">i64</span><span class="w"> </span><span class="n">sret</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span><span class="n">system_v</span><span class="w"> </span><span class="p">{</span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span><span class="p">:</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="p">:</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v2</span><span class="p">:</span><span class="w"> </span><span class="kt">i64</span><span class="p">):</span>
<span class="w">    </span><span class="nc">v3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">f64</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">v1</span>
<span class="w">    </span><span class="n">v4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">f64</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">v2</span>
<span class="w">    </span><span class="n">v6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">f64</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">v1</span><span class="o">+</span><span class="mi">8</span>
<span class="w">    </span><span class="n">v7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">f64</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">v2</span><span class="o">+</span><span class="mi">8</span>
<span class="w">    </span><span class="n">v9</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">f64</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">v1</span><span class="o">+</span><span class="mi">16</span>
<span class="w">    </span><span class="n">v10</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">f64</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">v2</span><span class="o">+</span><span class="mi">16</span>
<span class="w">    </span><span class="n">v5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fsub</span><span class="w"> </span><span class="n">v3</span><span class="p">,</span><span class="w"> </span><span class="n">v4</span>
<span class="w">    </span><span class="n">store</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">v5</span><span class="p">,</span><span class="w"> </span><span class="n">v0</span>
<span class="w">    </span><span class="n">v8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fsub</span><span class="w"> </span><span class="n">v6</span><span class="p">,</span><span class="w"> </span><span class="n">v7</span>
<span class="w">    </span><span class="n">store</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">v8</span><span class="p">,</span><span class="w"> </span><span class="n">v0</span><span class="o">+</span><span class="mi">8</span>
<span class="w">    </span><span class="n">v11</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fsub</span><span class="w"> </span><span class="n">v9</span><span class="p">,</span><span class="w"> </span><span class="n">v10</span>
<span class="w">    </span><span class="n">store</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">v11</span><span class="p">,</span><span class="w"> </span><span class="n">v0</span><span class="o">+</span><span class="mi">16</span>
<span class="w">    </span><span class="k">return</span>
<span class="p">}</span>
</code></pre></div>
<p>6 load instructions will be generated followed by 3 pairs of sub + store:</p>
<div class="codehilite" data-code-language="GAS"><pre><span></span><code><span class="err">0000000000000000</span><span class="w"> </span><span class="err">&lt;</span><span class="nf">sub</span><span class="err">&gt;</span><span class="p">:</span>
<span class="w">   </span><span class="err">0:</span><span class="w">   </span><span class="err">55</span><span class="w">                      </span><span class="nf">push</span><span class="w">   </span><span class="no">rbp</span>
<span class="w">   </span><span class="err">1:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="err">89</span><span class="w"> </span><span class="nf">e5</span><span class="w">                </span><span class="no">mov</span><span class="w">    </span><span class="no">rbp</span><span class="p">,</span><span class="no">rsp</span>
<span class="w">   </span><span class="err">4:</span><span class="w">   </span><span class="nf">f2</span><span class="w"> </span><span class="mi">0</span><span class="no">f</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="mi">3</span><span class="no">e</span><span class="w">             </span><span class="no">movsd</span><span class="w">  </span><span class="no">xmm7</span><span class="p">,</span><span class="no">QWORD</span><span class="w"> </span><span class="no">PTR</span><span class="w"> </span><span class="p">[</span><span class="no">rsi</span><span class="p">]</span>
<span class="w">   </span><span class="err">8:</span><span class="w">   </span><span class="nf">f2</span><span class="w"> </span><span class="mi">0</span><span class="no">f</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="mi">2</span><span class="no">a</span><span class="w">             </span><span class="no">movsd</span><span class="w">  </span><span class="no">xmm5</span><span class="p">,</span><span class="no">QWORD</span><span class="w"> </span><span class="no">PTR</span><span class="w"> </span><span class="p">[</span><span class="no">rdx</span><span class="p">]</span>
<span class="w">   </span><span class="nl">c:</span><span class="w">   </span><span class="nf">f2</span><span class="w"> </span><span class="mi">0</span><span class="no">f</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="mi">46</span><span class="w"> </span><span class="mi">08</span><span class="w">          </span><span class="no">movsd</span><span class="w">  </span><span class="no">xmm0</span><span class="p">,</span><span class="no">QWORD</span><span class="w"> </span><span class="no">PTR</span><span class="w"> </span><span class="p">[</span><span class="no">rsi</span><span class="err">+</span><span class="mi">0x8</span><span class="p">]</span>
<span class="w">  </span><span class="err">11:</span><span class="w">   </span><span class="nf">f2</span><span class="w"> </span><span class="mi">0</span><span class="no">f</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="mi">72</span><span class="w"> </span><span class="mi">08</span><span class="w">          </span><span class="no">movsd</span><span class="w">  </span><span class="no">xmm6</span><span class="p">,</span><span class="no">QWORD</span><span class="w"> </span><span class="no">PTR</span><span class="w"> </span><span class="p">[</span><span class="no">rdx</span><span class="err">+</span><span class="mi">0x8</span><span class="p">]</span>
<span class="w">  </span><span class="err">16:</span><span class="w">   </span><span class="nf">f2</span><span class="w"> </span><span class="mi">0</span><span class="no">f</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="mi">4</span><span class="no">e</span><span class="w"> </span><span class="mi">10</span><span class="w">          </span><span class="no">movsd</span><span class="w">  </span><span class="no">xmm1</span><span class="p">,</span><span class="no">QWORD</span><span class="w"> </span><span class="no">PTR</span><span class="w"> </span><span class="p">[</span><span class="no">rsi</span><span class="err">+</span><span class="mi">0x10</span><span class="p">]</span>
<span class="w">  </span><span class="err">1</span><span class="nl">b:</span><span class="w">   </span><span class="nf">f2</span><span class="w"> </span><span class="mi">0</span><span class="no">f</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="mi">52</span><span class="w"> </span><span class="mi">10</span><span class="w">          </span><span class="no">movsd</span><span class="w">  </span><span class="no">xmm2</span><span class="p">,</span><span class="no">QWORD</span><span class="w"> </span><span class="no">PTR</span><span class="w"> </span><span class="p">[</span><span class="no">rdx</span><span class="err">+</span><span class="mi">0x10</span><span class="p">]</span>
<span class="w">  </span><span class="err">20:</span><span class="w">   </span><span class="nf">f2</span><span class="w"> </span><span class="mi">0</span><span class="no">f</span><span class="w"> </span><span class="mi">5</span><span class="no">c</span><span class="w"> </span><span class="no">fd</span><span class="w">             </span><span class="no">subsd</span><span class="w">  </span><span class="no">xmm7</span><span class="p">,</span><span class="no">xmm5</span>
<span class="w">  </span><span class="err">24:</span><span class="w">   </span><span class="nf">f2</span><span class="w"> </span><span class="mi">0</span><span class="no">f</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="mi">3</span><span class="no">f</span><span class="w">             </span><span class="no">movsd</span><span class="w">  </span><span class="no">QWORD</span><span class="w"> </span><span class="no">PTR</span><span class="w"> </span><span class="p">[</span><span class="no">rdi</span><span class="p">],</span><span class="no">xmm7</span>
<span class="w">  </span><span class="err">28:</span><span class="w">   </span><span class="nf">f2</span><span class="w"> </span><span class="mi">0</span><span class="no">f</span><span class="w"> </span><span class="mi">5</span><span class="no">c</span><span class="w"> </span><span class="no">c6</span><span class="w">             </span><span class="no">subsd</span><span class="w">  </span><span class="no">xmm0</span><span class="p">,</span><span class="no">xmm6</span>
<span class="w">  </span><span class="err">2</span><span class="nl">c:</span><span class="w">   </span><span class="nf">f2</span><span class="w"> </span><span class="mi">0</span><span class="no">f</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="mi">47</span><span class="w"> </span><span class="mi">08</span><span class="w">          </span><span class="no">movsd</span><span class="w">  </span><span class="no">QWORD</span><span class="w"> </span><span class="no">PTR</span><span class="w"> </span><span class="p">[</span><span class="no">rdi</span><span class="err">+</span><span class="mi">0x8</span><span class="p">],</span><span class="no">xmm0</span>
<span class="w">  </span><span class="err">31:</span><span class="w">   </span><span class="nf">f2</span><span class="w"> </span><span class="mi">0</span><span class="no">f</span><span class="w"> </span><span class="mi">5</span><span class="no">c</span><span class="w"> </span><span class="no">ca</span><span class="w">             </span><span class="no">subsd</span><span class="w">  </span><span class="no">xmm1</span><span class="p">,</span><span class="no">xmm2</span>
<span class="w">  </span><span class="err">35:</span><span class="w">   </span><span class="nf">f2</span><span class="w"> </span><span class="mi">0</span><span class="no">f</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="mi">4</span><span class="no">f</span><span class="w"> </span><span class="mi">10</span><span class="w">          </span><span class="no">movsd</span><span class="w">  </span><span class="no">QWORD</span><span class="w"> </span><span class="no">PTR</span><span class="w"> </span><span class="p">[</span><span class="no">rdi</span><span class="err">+</span><span class="mi">0x10</span><span class="p">],</span><span class="no">xmm1</span>
<span class="w">  </span><span class="err">3</span><span class="nl">a:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="err">89</span><span class="w"> </span><span class="nf">f8</span><span class="w">                </span><span class="no">mov</span><span class="w">    </span><span class="no">rax</span><span class="p">,</span><span class="no">rdi</span>
<span class="w">  </span><span class="err">3</span><span class="nl">d:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="err">89</span><span class="w"> </span><span class="nf">ec</span><span class="w">                </span><span class="no">mov</span><span class="w">    </span><span class="no">rsp</span><span class="p">,</span><span class="no">rbp</span>
<span class="w">  </span><span class="err">40:</span><span class="w">   </span><span class="err">5</span><span class="nf">d</span><span class="w">                      </span><span class="no">pop</span><span class="w">    </span><span class="no">rbp</span>
<span class="w">  </span><span class="err">41:</span><span class="w">   </span><span class="nf">c3</span><span class="w">                      </span><span class="no">ret</span>
</code></pre></div>
<p>while LLVM is able to sink half the loads into the <code>subsd</code> instructions themself even with -O0:</p>
<div class="codehilite" data-code-language="GAS"><pre><span></span><code><span class="w">  </span><span class="nl">sub:</span>
<span class="w">        </span><span class="nf">mov</span><span class="w">     </span><span class="no">rax</span><span class="p">,</span><span class="w"> </span><span class="no">rdi</span>
<span class="w">        </span><span class="nf">movsd</span><span class="w">   </span><span class="no">xmm2</span><span class="p">,</span><span class="w"> </span><span class="no">qword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rsi</span><span class="p">]</span>
<span class="w">        </span><span class="nf">subsd</span><span class="w">   </span><span class="no">xmm2</span><span class="p">,</span><span class="w"> </span><span class="no">qword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rdx</span><span class="p">]</span>
<span class="w">        </span><span class="nf">movsd</span><span class="w">   </span><span class="no">xmm1</span><span class="p">,</span><span class="w"> </span><span class="no">qword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rsi</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="mi">8</span><span class="p">]</span>
<span class="w">        </span><span class="nf">subsd</span><span class="w">   </span><span class="no">xmm1</span><span class="p">,</span><span class="w"> </span><span class="no">qword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rdx</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="mi">8</span><span class="p">]</span>
<span class="w">        </span><span class="nf">movsd</span><span class="w">   </span><span class="no">xmm0</span><span class="p">,</span><span class="w"> </span><span class="no">qword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rsi</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="mi">16</span><span class="p">]</span>
<span class="w">        </span><span class="nf">subsd</span><span class="w">   </span><span class="no">xmm0</span><span class="p">,</span><span class="w"> </span><span class="no">qword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rdx</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="mi">16</span><span class="p">]</span>
<span class="w">        </span><span class="nf">movsd</span><span class="w">   </span><span class="no">qword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rdi</span><span class="p">],</span><span class="w"> </span><span class="no">xmm2</span>
<span class="w">        </span><span class="nf">movsd</span><span class="w">   </span><span class="no">qword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rdi</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="mi">8</span><span class="p">],</span><span class="w"> </span><span class="no">xmm1</span>
<span class="w">        </span><span class="nf">movsd</span><span class="w">   </span><span class="no">qword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rdi</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="mi">16</span><span class="p">],</span><span class="w"> </span><span class="no">xmm0</span>
<span class="w">        </span><span class="nf">ret</span>
</code></pre></div>
<p>Cranelift is not entirely incapable of load sinking as seen for a dot product where it does load sink a single load:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">function</span><span class="w"> </span><span class="n">u0</span><span class="p">:</span><span class="mi">0</span><span class="p">(</span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">f64</span><span class="w"> </span><span class="nc">system_v</span><span class="w"> </span><span class="p">{</span>
<span class="n">block0</span><span class="p">(</span><span class="n">v0</span><span class="p">:</span><span class="w"> </span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">v1</span><span class="p">:</span><span class="w"> </span><span class="kt">i64</span><span class="p">):</span>
<span class="w">    </span><span class="nc">v3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">f64</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">v0</span>
<span class="w">    </span><span class="n">v4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">f64</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">v1</span>
<span class="w">    </span><span class="n">v6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">f64</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">v0</span><span class="o">+</span><span class="mi">8</span>
<span class="w">    </span><span class="n">v7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">f64</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">v1</span><span class="o">+</span><span class="mi">8</span>
<span class="w">    </span><span class="n">v10</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">f64</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">v0</span><span class="o">+</span><span class="mi">16</span>
<span class="w">    </span><span class="n">v11</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load</span><span class="p">.</span><span class="kt">f64</span><span class="w"> </span><span class="n">notrap</span><span class="w"> </span><span class="n">v1</span><span class="o">+</span><span class="mi">16</span>
<span class="w">    </span><span class="n">v5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fmul</span><span class="w"> </span><span class="n">v3</span><span class="p">,</span><span class="w"> </span><span class="n">v4</span>
<span class="w">    </span><span class="n">v8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fmul</span><span class="w"> </span><span class="n">v6</span><span class="p">,</span><span class="w"> </span><span class="n">v7</span>
<span class="w">    </span><span class="n">v9</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fadd</span><span class="w"> </span><span class="n">v5</span><span class="p">,</span><span class="w"> </span><span class="n">v8</span>
<span class="w">    </span><span class="n">v12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fmul</span><span class="w"> </span><span class="n">v10</span><span class="p">,</span><span class="w"> </span><span class="n">v11</span>
<span class="w">    </span><span class="n">v13</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fadd</span><span class="w"> </span><span class="n">v9</span><span class="p">,</span><span class="w"> </span><span class="n">v12</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v13</span>
<span class="p">}</span>
</code></pre></div>
<div class="codehilite" data-code-language="GAS"><pre><span></span><code><span class="err">0000000000000000</span><span class="w"> </span><span class="err">&lt;</span><span class="nf">dot</span><span class="err">&gt;</span><span class="p">:</span>
<span class="w">   </span><span class="err">0:</span><span class="w">   </span><span class="err">55</span><span class="w">                      </span><span class="nf">push</span><span class="w">   </span><span class="no">rbp</span>
<span class="w">   </span><span class="err">1:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="err">89</span><span class="w"> </span><span class="nf">e5</span><span class="w">                </span><span class="no">mov</span><span class="w">    </span><span class="no">rbp</span><span class="p">,</span><span class="no">rsp</span>
<span class="w">   </span><span class="err">4:</span><span class="w">   </span><span class="nf">f2</span><span class="w"> </span><span class="mi">0</span><span class="no">f</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="mi">07</span><span class="w">             </span><span class="no">movsd</span><span class="w">  </span><span class="no">xmm0</span><span class="p">,</span><span class="no">QWORD</span><span class="w"> </span><span class="no">PTR</span><span class="w"> </span><span class="p">[</span><span class="no">rdi</span><span class="p">]</span>
<span class="w">   </span><span class="err">8:</span><span class="w">   </span><span class="nf">f2</span><span class="w"> </span><span class="mi">0</span><span class="no">f</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="mi">2</span><span class="no">e</span><span class="w">             </span><span class="no">movsd</span><span class="w">  </span><span class="no">xmm5</span><span class="p">,</span><span class="no">QWORD</span><span class="w"> </span><span class="no">PTR</span><span class="w"> </span><span class="p">[</span><span class="no">rsi</span><span class="p">]</span>
<span class="w">   </span><span class="nl">c:</span><span class="w">   </span><span class="nf">f2</span><span class="w"> </span><span class="mi">0</span><span class="no">f</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="mi">4</span><span class="no">f</span><span class="w"> </span><span class="mi">08</span><span class="w">          </span><span class="no">movsd</span><span class="w">  </span><span class="no">xmm1</span><span class="p">,</span><span class="no">QWORD</span><span class="w"> </span><span class="no">PTR</span><span class="w"> </span><span class="p">[</span><span class="no">rdi</span><span class="err">+</span><span class="mi">0x8</span><span class="p">]</span>
<span class="w">  </span><span class="err">11:</span><span class="w">   </span><span class="nf">f2</span><span class="w"> </span><span class="mi">0</span><span class="no">f</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="mi">76</span><span class="w"> </span><span class="mi">08</span><span class="w">          </span><span class="no">movsd</span><span class="w">  </span><span class="no">xmm6</span><span class="p">,</span><span class="no">QWORD</span><span class="w"> </span><span class="no">PTR</span><span class="w"> </span><span class="p">[</span><span class="no">rsi</span><span class="err">+</span><span class="mi">0x8</span><span class="p">]</span>
<span class="w">  </span><span class="err">16:</span><span class="w">   </span><span class="nf">f2</span><span class="w"> </span><span class="mi">0</span><span class="no">f</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="mi">57</span><span class="w"> </span><span class="mi">10</span><span class="w">          </span><span class="no">movsd</span><span class="w">  </span><span class="no">xmm2</span><span class="p">,</span><span class="no">QWORD</span><span class="w"> </span><span class="no">PTR</span><span class="w"> </span><span class="p">[</span><span class="no">rdi</span><span class="err">+</span><span class="mi">0x10</span><span class="p">]</span>
<span class="w">  </span><span class="err">1</span><span class="nl">b:</span><span class="w">   </span><span class="nf">f2</span><span class="w"> </span><span class="mi">0</span><span class="no">f</span><span class="w"> </span><span class="mi">59</span><span class="w"> </span><span class="no">c5</span><span class="w">             </span><span class="no">mulsd</span><span class="w">  </span><span class="no">xmm0</span><span class="p">,</span><span class="no">xmm5</span>
<span class="w">  </span><span class="err">1</span><span class="nl">f:</span><span class="w">   </span><span class="nf">f2</span><span class="w"> </span><span class="mi">0</span><span class="no">f</span><span class="w"> </span><span class="mi">59</span><span class="w"> </span><span class="no">ce</span><span class="w">             </span><span class="no">mulsd</span><span class="w">  </span><span class="no">xmm1</span><span class="p">,</span><span class="no">xmm6</span>
<span class="w">  </span><span class="err">23:</span><span class="w">   </span><span class="nf">f2</span><span class="w"> </span><span class="mi">0</span><span class="no">f</span><span class="w"> </span><span class="mi">58</span><span class="w"> </span><span class="no">c1</span><span class="w">             </span><span class="no">addsd</span><span class="w">  </span><span class="no">xmm0</span><span class="p">,</span><span class="no">xmm1</span>
<span class="w">  </span><span class="err">27:</span><span class="w">   </span><span class="nf">f2</span><span class="w"> </span><span class="mi">0</span><span class="no">f</span><span class="w"> </span><span class="mi">59</span><span class="w"> </span><span class="mi">56</span><span class="w"> </span><span class="mi">10</span><span class="w">          </span><span class="no">mulsd</span><span class="w">  </span><span class="no">xmm2</span><span class="p">,</span><span class="no">QWORD</span><span class="w"> </span><span class="no">PTR</span><span class="w"> </span><span class="p">[</span><span class="no">rsi</span><span class="err">+</span><span class="mi">0x10</span><span class="p">]</span>
<span class="w">  </span><span class="err">2</span><span class="nl">c:</span><span class="w">   </span><span class="nf">f2</span><span class="w"> </span><span class="mi">0</span><span class="no">f</span><span class="w"> </span><span class="mi">58</span><span class="w"> </span><span class="no">c2</span><span class="w">             </span><span class="no">addsd</span><span class="w">  </span><span class="no">xmm0</span><span class="p">,</span><span class="no">xmm2</span>
<span class="w">  </span><span class="err">30:</span><span class="w">   </span><span class="err">48</span><span class="w"> </span><span class="err">89</span><span class="w"> </span><span class="nf">ec</span><span class="w">                </span><span class="no">mov</span><span class="w">    </span><span class="no">rsp</span><span class="p">,</span><span class="no">rbp</span>
<span class="w">  </span><span class="err">33:</span><span class="w">   </span><span class="err">5</span><span class="nf">d</span><span class="w">                      </span><span class="no">pop</span><span class="w">    </span><span class="no">rbp</span>
<span class="w">  </span><span class="err">34:</span><span class="w">   </span><span class="nf">c3</span><span class="w">                      </span><span class="no">ret</span>
</code></pre></div>
<p>but again even LLVM -O0 will load sink all 3 possible loads:</p>
<div class="codehilite" data-code-language="GAS"><pre><span></span><code><span class="nl">dot:</span>
<span class="w">        </span><span class="nf">mov</span><span class="w">     </span><span class="no">qword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rsp</span><span class="w"> </span><span class="p">-</span><span class="w"> </span><span class="mi">8</span><span class="p">],</span><span class="w"> </span><span class="no">rdi</span>
<span class="w">        </span><span class="nf">movsd</span><span class="w">   </span><span class="no">xmm0</span><span class="p">,</span><span class="w"> </span><span class="no">qword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rdi</span><span class="p">]</span>
<span class="w">        </span><span class="nf">mulsd</span><span class="w">   </span><span class="no">xmm0</span><span class="p">,</span><span class="w"> </span><span class="no">qword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rsi</span><span class="p">]</span>
<span class="w">        </span><span class="nf">movsd</span><span class="w">   </span><span class="no">xmm1</span><span class="p">,</span><span class="w"> </span><span class="no">qword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rdi</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="mi">8</span><span class="p">]</span>
<span class="w">        </span><span class="nf">mulsd</span><span class="w">   </span><span class="no">xmm1</span><span class="p">,</span><span class="w"> </span><span class="no">qword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rsi</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="mi">8</span><span class="p">]</span>
<span class="w">        </span><span class="nf">addsd</span><span class="w">   </span><span class="no">xmm0</span><span class="p">,</span><span class="w"> </span><span class="no">xmm1</span>
<span class="w">        </span><span class="nf">movsd</span><span class="w">   </span><span class="no">xmm1</span><span class="p">,</span><span class="w"> </span><span class="no">qword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rdi</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="mi">16</span><span class="p">]</span>
<span class="w">        </span><span class="nf">mulsd</span><span class="w">   </span><span class="no">xmm1</span><span class="p">,</span><span class="w"> </span><span class="no">qword</span><span class="w"> </span><span class="no">ptr</span><span class="w"> </span><span class="p">[</span><span class="no">rsi</span><span class="w"> </span><span class="err">+</span><span class="w"> </span><span class="mi">16</span><span class="p">]</span>
<span class="w">        </span><span class="nf">addsd</span><span class="w">   </span><span class="no">xmm0</span><span class="p">,</span><span class="w"> </span><span class="no">xmm1</span>
<span class="w">        </span><span class="nf">ret</span>
</code></pre></div>
<p>These examples are taken from <a href="https://github.com/ebobby/simple-raytracer/blob/496b6164b9f16250f99b91327da8f01acc1e3534/src/vector.rs">https://github.com/ebobby/simple-raytracer/blob/496b6164b9f16250f99b91327da8f01acc1e3534/src/vector.rs</a> compiled with both cg_clif (<code>-Copt-level=3</code>) and cg_llvm (<code>-Copt-level=0</code>).</p>
<h4>Benefit</h4>
<p>Improves runtime performance.</p>
<h4>Implementation</h4>
<p>I think this is caused by <code>get_value_as_source_or_const</code> considering loads as having side-effects even when they are <code>notrap</code>.</p>
<h4>Alternatives</h4>
<p>TODO: What are the alternative implementation approaches or alternative ways to<br>
solve the problem that this feature would solve? How do these alternatives<br>
compare to this proposal?<br>
</p>
</blockquote>



<a name="560444148"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312033%20Support%20load%20sinking%20across%20notra.../near/560444148" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312033.20Support.20load.20sinking.20across.20notra.2E.2E.2E.html#560444148">(Nov 26 2025 at 17:28)</a>:</h4>
<p><a href="https://github.com/alexcrichton">alexcrichton</a> added the cranelift:area:x64 label to <a href="https://github.com/bytecodealliance/wasmtime/issues/12033">Issue #12033</a>.</p>



<a name="561734779"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312033%20Support%20load%20sinking%20across%20notra.../near/561734779" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312033.20Support.20load.20sinking.20across.20notra.2E.2E.2E.html#561734779">(Dec 03 2025 at 19:17)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/12033#issuecomment-3608448450">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12033">issue #12033</a>:</p>
<blockquote>
<p>Thanks for filing this!</p>
<p>The main difficulty with doing this today is that our instruction-coloring pass computes colors once, and updates colors on all loads and stores; in essence this is like building a spine of dependency edges between all adjacent memory ops to keep them all in the same order.</p>
<p>The desired optimization output does actually have the ops in the same order, but we need to <em>update</em> instruction colors as we sink to see that. That's maybe possible with a little more complexity but we'd have to think carefully about it.</p>
<p>(Note that coloring happens separately than alias analysis and works to keep all side-effects in order; if we were to unify the two, it would probably best be via Nick's proposal in #10427)</p>
</blockquote>



<a name="561736265"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312033%20Support%20load%20sinking%20across%20notra.../near/561736265" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312033.20Support.20load.20sinking.20across.20notra.2E.2E.2E.html#561736265">(Dec 03 2025 at 19:26)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/12033#issuecomment-3608487203">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12033">issue #12033</a>:</p>
<blockquote>
<p>When only notrap loads are involved, it doesn't matter that the order of the loads stays the same. It only matter that it doesn't change relative to loads that may trap and stores.</p>
</blockquote>



<a name="561736625"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312033%20Support%20load%20sinking%20across%20notra.../near/561736625" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312033.20Support.20load.20sinking.20across.20notra.2E.2E.2E.html#561736625">(Dec 03 2025 at 19:28)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/12033#issuecomment-3608493861">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12033">issue #12033</a>:</p>
<blockquote>
<p>Yes, that's what makes the transform possible, I agree. My description is how lowering works today, so we will need to update the instruction coloring algorithm as noted.</p>
</blockquote>



<a name="561736747"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312033%20Support%20load%20sinking%20across%20notra.../near/561736747" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312033.20Support.20load.20sinking.20across.20notra.2E.2E.2E.html#561736747">(Dec 03 2025 at 19:29)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/12033#issuecomment-3608496378">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12033">issue #12033</a>:</p>
<blockquote>
<p>(The reason that notrap loads still participate in coloring is that they should not be moved across stores; and moving across stores is governed today by coloring, not alias analysis)</p>
</blockquote>



<hr><p>Last updated: Feb 22 2026 at 11:05 UTC</p>
</html>
<html>
<head><meta charset="utf-8"><title>wasmtime / PR #12483 Implement branch hinting proposal su... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312483.20Implement.20branch.20hinting.20proposal.20su.2E.2E.2E.html">wasmtime / PR #12483 Implement branch hinting proposal su...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="571181732"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312483%20Implement%20branch%20hinting%20proposal%20su.../near/571181732" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312483.20Implement.20branch.20hinting.20proposal.20su.2E.2E.2E.html#571181732">(Jan 31 2026 at 09:44)</a>:</h4>
<p>gfx opened <a href="https://github.com/bytecodealliance/wasmtime/pull/12483">PR #12483</a> from <code>wado-lang:gfx/branch_hinting</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>This PR adds support for the WebAssembly branch hinting proposal by parsing the <code>metadata.code.branch_hint</code> custom section and using the hints to mark cold blocks during Cranelift code generation.</p>
<p>Implementation details:</p>
<ul>
<li>Parse branch hints in <code>ModuleTranslation</code> from the custom section using wasmparser's <code>KnownCustom::BranchHints</code> reader</li>
<li>Store hints as a map from function index to (offset, taken) pairs</li>
<li>Add <code>get_branch_hint()</code> helper in <code>FuncEnvironment</code> to look up hints by converting absolute byte offsets to function-relative offsets</li>
<li>Apply hints in <code>translate_br_if()</code>: when a branch is marked unlikely (<code>taken=false</code>), mark the branch target as cold; when marked likely (<code>taken=true</code>), mark the fallthrough block as cold</li>
</ul>
<p>Branch hints are always parsed and applied when present in a module; no configuration flag is required.</p>
<p>A disassembly test is included to verify cold block annotations, but official WebAssembly spec tests for this proposal are not yet available.</p>
<p>Closes #9463</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="571181735"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312483%20Implement%20branch%20hinting%20proposal%20su.../near/571181735" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312483.20Implement.20branch.20hinting.20proposal.20su.2E.2E.2E.html#571181735">(Jan 31 2026 at 09:44)</a>:</h4>
<p><strong>gfx</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/12483">PR #12483</a>.</p>



<a name="571181736"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312483%20Implement%20branch%20hinting%20proposal%20su.../near/571181736" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312483.20Implement.20branch.20hinting.20proposal.20su.2E.2E.2E.html#571181736">(Jan 31 2026 at 09:44)</a>:</h4>
<p><strong>gfx</strong> requested <a href="https://github.com/fitzgen">fitzgen</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/12483">PR #12483</a>.</p>



<a name="571181737"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312483%20Implement%20branch%20hinting%20proposal%20su.../near/571181737" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312483.20Implement.20branch.20hinting.20proposal.20su.2E.2E.2E.html#571181737">(Jan 31 2026 at 09:44)</a>:</h4>
<p><strong>gfx</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers">wasmtime-core-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/12483">PR #12483</a>.</p>



<a name="571181738"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312483%20Implement%20branch%20hinting%20proposal%20su.../near/571181738" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312483.20Implement.20branch.20hinting.20proposal.20su.2E.2E.2E.html#571181738">(Jan 31 2026 at 09:44)</a>:</h4>
<p><strong>gfx</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-default-reviewers">wasmtime-default-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/12483">PR #12483</a>.</p>



<a name="571183365"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312483%20Implement%20branch%20hinting%20proposal%20su.../near/571183365" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312483.20Implement.20branch.20hinting.20proposal.20su.2E.2E.2E.html#571183365">(Jan 31 2026 at 10:07)</a>:</h4>
<p>gfx edited <a href="https://github.com/bytecodealliance/wasmtime/pull/12483">PR #12483</a>:</p>
<blockquote>
<p>This PR adds support for the WebAssembly branch hinting proposal by parsing the <code>metadata.code.branch_hint</code> custom section and using the hints to mark cold blocks during Cranelift code generation.</p>
<p>Implementation details:</p>
<ul>
<li>Parse branch hints in <code>ModuleTranslation</code> from the custom section using wasmparser's <code>KnownCustom::BranchHints</code> reader</li>
<li>Store hints as a map from function index to (offset, taken) pairs</li>
<li>Add <code>get_branch_hint()</code> helper in <code>FuncEnvironment</code> to look up hints by converting absolute byte offsets to function-relative offsets</li>
<li>Apply hints in <code>translate_br_if()</code>: when a branch is marked unlikely (<code>taken=false</code>), mark the branch target as cold; when marked likely (<code>taken=true</code>), mark the fallthrough block as cold</li>
</ul>
<p>Branch hints are always parsed and applied when present in a module; no configuration flag is required.</p>
<p>A disassembly test is included to verify cold block annotations, but official WebAssembly spec tests for this proposal are not yet available.</p>
<p>Closes #9463</p>
<p>Question: should I add a knob to enable/disable this feature? Currently, this is automatically turned on. I'm not sure I should add an option for it.</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="571189793"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312483%20Implement%20branch%20hinting%20proposal%20su.../near/571189793" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312483.20Implement.20branch.20hinting.20proposal.20su.2E.2E.2E.html#571189793">(Jan 31 2026 at 11:46)</a>:</h4>
<p>github-actions[bot] added the label <code>wasmtime:docs</code> on <a href="https://github.com/bytecodealliance/wasmtime/pull/12483">PR #12483</a>.</p>



<a name="571344559"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312483%20Implement%20branch%20hinting%20proposal%20su.../near/571344559" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312483.20Implement.20branch.20hinting.20proposal.20su.2E.2E.2E.html#571344559">(Feb 02 2026 at 04:22)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/12483#pullrequestreview-3737241825">PR review</a>.</p>



<a name="571344561"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312483%20Implement%20branch%20hinting%20proposal%20su.../near/571344561" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312483.20Implement.20branch.20hinting.20proposal.20su.2E.2E.2E.html#571344561">(Feb 02 2026 at 04:22)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/12483#discussion_r2752490258">PR review comment</a>:</p>
<blockquote>
<p>This loop I think might be good to optimize in terms of translation will only lookup branch hints (I think?) in increasing order of offsets. That means that currently this code is an $O(n^2)$ loop as-implemented. That could be optimized by using a binary search here, but I think this could go one step further and, ideally, store a reference to the raw buffer of input wasm data (in theory) here. For example this could be a <code>.peekable()</code> iterator over the raw wasm itself. Looking up via <code>get_branch_hint</code> would advance the iterator if it's at the matching position.</p>
<p>Regardless I think it'll be needed to remove the quadratic behavior here, and I think ideally it'd be via an iterator-like approach to avoid the logarithmic nature of a binary search.</p>
</blockquote>



<a name="571499262"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312483%20Implement%20branch%20hinting%20proposal%20su.../near/571499262" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312483.20Implement.20branch.20hinting.20proposal.20su.2E.2E.2E.html#571499262">(Feb 02 2026 at 18:25)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/12483#pullrequestreview-3741186930">PR review</a>:</p>
<blockquote>
<blockquote>
<p>Question: should I add a knob to enable/disable this feature? Currently, this is automatically turned on. I'm not sure I should add an option for it.</p>
</blockquote>
<p>Yes, I think we should have a config knob for this.</p>
<p>And to follow our rules by the letter, we we shouldn't enable it by default until it is fuzzed (and has been fuzzed for a couple weeks). This would most likely involve adding support to <code>wasm-smith</code> for emitting branch hints.</p>
</blockquote>



<a name="571499561"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312483%20Implement%20branch%20hinting%20proposal%20su.../near/571499561" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312483.20Implement.20branch.20hinting.20proposal.20su.2E.2E.2E.html#571499561">(Feb 02 2026 at 18:26)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/12483#pullrequestreview-3741186930">PR review</a>:</p>
<blockquote>
<blockquote>
<p>Question: should I add a knob to enable/disable this feature? Currently, this is automatically turned on. I'm not sure I should add an option for it.</p>
</blockquote>
<p>Yes, I think we should have a config knob for this.</p>
<p>And to follow <a href="https://docs.wasmtime.dev/stability-wasm-proposals.html#feature-requirements">our rules</a> by the letter, we we shouldn't enable it by default until it is fuzzed (and has been fuzzed for a couple weeks). This would most likely involve adding support to <code>wasm-smith</code> for emitting branch hints.</p>
</blockquote>



<a name="571549447"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312483%20Implement%20branch%20hinting%20proposal%20su.../near/571549447" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312483.20Implement.20branch.20hinting.20proposal.20su.2E.2E.2E.html#571549447">(Feb 03 2026 at 00:18)</a>:</h4>
<p>gfx updated <a href="https://github.com/bytecodealliance/wasmtime/pull/12483">PR #12483</a>.</p>



<a name="571549511"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312483%20Implement%20branch%20hinting%20proposal%20su.../near/571549511" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312483.20Implement.20branch.20hinting.20proposal.20su.2E.2E.2E.html#571549511">(Feb 03 2026 at 00:19)</a>:</h4>
<p>gfx submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/12483#pullrequestreview-3742188889">PR review</a>.</p>



<a name="571549512"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312483%20Implement%20branch%20hinting%20proposal%20su.../near/571549512" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312483.20Implement.20branch.20hinting.20proposal.20su.2E.2E.2E.html#571549512">(Feb 03 2026 at 00:19)</a>:</h4>
<p>gfx created <a href="https://github.com/bytecodealliance/wasmtime/pull/12483#discussion_r2756554858">PR review comment</a>:</p>
<blockquote>
<p>Ah, you are right. </p>
<p>How about bc62088d6f7b31712badb427fd37e18c3c410a95 for O(n) complexity?</p>
</blockquote>



<a name="571551141"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312483%20Implement%20branch%20hinting%20proposal%20su.../near/571551141" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312483.20Implement.20branch.20hinting.20proposal.20su.2E.2E.2E.html#571551141">(Feb 03 2026 at 00:40)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/12483#pullrequestreview-3742256268">PR review</a>.</p>



<a name="571551142"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312483%20Implement%20branch%20hinting%20proposal%20su.../near/571551142" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312483.20Implement.20branch.20hinting.20proposal.20su.2E.2E.2E.html#571551142">(Feb 03 2026 at 00:40)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/12483#discussion_r2756612320">PR review comment</a>:</p>
<blockquote>
<p>What Alex is getting at, i think, is that the <a href="https://webassembly.github.io/branch-hinting/metadata/code/binary.html">spec</a> states that the hints are given in PC order. So why not traverse hints in order, taking them when they match as we visit increasing PC offsets? We should be able to that in O(n) time with O(1) space overhead, i.e., not building a HashMap at all.</p>
</blockquote>



<a name="571551166"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312483%20Implement%20branch%20hinting%20proposal%20su.../near/571551166" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312483.20Implement.20branch.20hinting.20proposal.20su.2E.2E.2E.html#571551166">(Feb 03 2026 at 00:40)</a>:</h4>
<p>cfallin edited <a href="https://github.com/bytecodealliance/wasmtime/pull/12483#discussion_r2756612320">PR review comment</a>.</p>



<a name="573016097"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312483%20Implement%20branch%20hinting%20proposal%20su.../near/573016097" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312483.20Implement.20branch.20hinting.20proposal.20su.2E.2E.2E.html#573016097">(Feb 10 2026 at 11:49)</a>:</h4>
<p>AlbertMarashi <a href="https://github.com/bytecodealliance/wasmtime/pull/12483#issuecomment-3877118280">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/12483">PR #12483</a>:</p>
<blockquote>
<p>How nice, I was just going to start using this - great to see it's being worked on!</p>
</blockquote>



<hr><p>Last updated: Feb 22 2026 at 11:05 UTC</p>
</html>
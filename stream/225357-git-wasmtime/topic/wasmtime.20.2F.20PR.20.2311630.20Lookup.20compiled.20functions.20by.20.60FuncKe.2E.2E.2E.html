<html>
<head><meta charset="utf-8"><title>wasmtime / PR #11630 Lookup compiled functions by `FuncKe... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311630.20Lookup.20compiled.20functions.20by.20.60FuncKe.2E.2E.2E.html">wasmtime / PR #11630 Lookup compiled functions by `FuncKe...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="537945314"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311630%20Lookup%20compiled%20functions%20by%20%60FuncKe.../near/537945314" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311630.20Lookup.20compiled.20functions.20by.20.60FuncKe.2E.2E.2E.html#537945314">(Sep 05 2025 at 20:50)</a>:</h4>
<p>fitzgen opened <a href="https://github.com/bytecodealliance/wasmtime/pull/11630">PR #11630</a> from <code>fitzgen:organize-compiled-func-locs-by-func-key</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>This treats compiled functions homogeneously, removing the need to add new metadata tables to places like <code>CompiledModuleInfo</code> whenever we add a new kind of function, and simplifying the process of constructing the metadata for a final, linked compilation artifact. This also paves the way to doing gc-sections in our linking (getting smaller code sizes, removing functions that have been inlined into every caller, and etc...) as we no longer assume that certain types of function index spaces are dense.</p>
<p>This does, however, replace a couple operations that were previously O(1) table lookups with O(log n) binary searches. And, notably, some of these are on the <code>VMFuncRef</code>-creation path, and therefore on the<br>
force-initialization-of-a-lazy-funcref-table-slot path, when we look up a Wasm function and its trampolines. Our call-indirect micro-benchmarks show that indirect calling every funcref once in a table of 64Ki slots went from taking ~2.6ms to ~3.8ms (a +46% slowdown). Note that this edge case is both synthetic and the worst-case scenario for this commit's change: we are measuring, as much as we can, <em>only</em> the force-initialization-of-a-lazy-funcref-table-slot path. All other call-indirect benchmarks are within the noise, which is what we would expect.</p>
<p>Also, the size of <code>.cwasm</code>s is slightly larger: <code>spidermonkey.wasm</code>'s <code>.cwasm</code> size went from <code>19_750_632</code> bytes to <code>19785872</code> bytes, which is a 1.78% increase.</p>
<p>Ultimately, I believe that the simplification and possibility of doing gc-sections in the future is worth the downsides. That said, if others feel differently, there are some things we could try to improve the situation, although most things I can think of off the top of my head (e.g. LEB128s and delta encoding, making certain <code>FuncKey</code> kinds' index spaces dense) will improve one of code size or lookup times while pessimizing the other. I'm sure we could come up with something given enough effort though.</p>
<p>&lt;details&gt;</p>
<p>&lt;summary&gt;call-indirect micro-benchmarks results&lt;/summary&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">call</span><span class="o">-</span><span class="n">indirect</span><span class="o">/</span><span class="n">same</span><span class="o">-</span><span class="n">callee</span><span class="o">/</span><span class="n">table</span><span class="o">-</span><span class="n">init</span><span class="o">-</span><span class="n">lazy</span><span class="o">/</span><span class="mi">65536</span><span class="o">-</span><span class="n">calls</span>
<span class="w">                        </span><span class="n">time</span><span class="p">:</span><span class="w">   </span><span class="p">[</span><span class="mf">144.14</span><span class="w"> </span><span class="err">µ</span><span class="n">s</span><span class="w"> </span><span class="mf">145.26</span><span class="w"> </span><span class="err">µ</span><span class="n">s</span><span class="w"> </span><span class="mf">146.56</span><span class="w"> </span><span class="err">µ</span><span class="n">s</span><span class="p">]</span>
<span class="w">                        </span><span class="n">thrpt</span><span class="p">:</span><span class="w">  </span><span class="p">[</span><span class="mf">447.15</span><span class="w"> </span><span class="n">Melem</span><span class="o">/</span><span class="n">s</span><span class="w"> </span><span class="mf">451.15</span><span class="w"> </span><span class="n">Melem</span><span class="o">/</span><span class="n">s</span><span class="w"> </span><span class="mf">454.68</span><span class="w"> </span><span class="n">Melem</span><span class="o">/</span><span class="n">s</span><span class="p">]</span>
<span class="w">                 </span><span class="n">change</span><span class="p">:</span>
<span class="w">                        </span><span class="nc">time</span><span class="p">:</span><span class="w">   </span><span class="p">[</span><span class="err">−</span><span class="mf">5.5066</span><span class="o">%</span><span class="w"> </span><span class="err">−</span><span class="mf">3.6611</span><span class="o">%</span><span class="w"> </span><span class="err">−</span><span class="mf">1.9130</span><span class="o">%</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span>
<span class="w">                        </span><span class="n">thrpt</span><span class="p">:</span><span class="w">  </span><span class="p">[</span><span class="o">+</span><span class="mf">1.9503</span><span class="o">%</span><span class="w"> </span><span class="o">+</span><span class="mf">3.8002</span><span class="o">%</span><span class="w"> </span><span class="o">+</span><span class="mf">5.8275</span><span class="o">%</span><span class="p">]</span>
<span class="w">                        </span><span class="n">Performance</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">improved</span><span class="p">.</span>
<span class="n">Found</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="n">outliers</span><span class="w"> </span><span class="n">among</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="n">measurements</span><span class="w"> </span><span class="p">(</span><span class="mf">9.00</span><span class="o">%</span><span class="p">)</span>
<span class="w">  </span><span class="mi">7</span><span class="w"> </span><span class="p">(</span><span class="mf">7.00</span><span class="o">%</span><span class="p">)</span><span class="w"> </span><span class="n">high</span><span class="w"> </span><span class="n">mild</span>
<span class="w">  </span><span class="mi">2</span><span class="w"> </span><span class="p">(</span><span class="mf">2.00</span><span class="o">%</span><span class="p">)</span><span class="w"> </span><span class="n">high</span><span class="w"> </span><span class="n">severe</span>
<span class="n">call</span><span class="o">-</span><span class="n">indirect</span><span class="o">/</span><span class="n">different</span><span class="o">-</span><span class="n">callees</span><span class="o">/</span><span class="n">table</span><span class="o">-</span><span class="n">init</span><span class="o">-</span><span class="n">lazy</span><span class="o">/</span><span class="mi">65536</span><span class="o">-</span><span class="n">calls</span>
<span class="w">                        </span><span class="n">time</span><span class="p">:</span><span class="w">   </span><span class="p">[</span><span class="mf">3.8128</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="mf">3.8433</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="mf">3.8763</span><span class="w"> </span><span class="n">ms</span><span class="p">]</span>
<span class="w">                        </span><span class="n">thrpt</span><span class="p">:</span><span class="w">  </span><span class="p">[</span><span class="mf">16.907</span><span class="w"> </span><span class="n">Melem</span><span class="o">/</span><span class="n">s</span><span class="w"> </span><span class="mf">17.052</span><span class="w"> </span><span class="n">Melem</span><span class="o">/</span><span class="n">s</span><span class="w"> </span><span class="mf">17.188</span><span class="w"> </span><span class="n">Melem</span><span class="o">/</span><span class="n">s</span><span class="p">]</span>
<span class="w">                 </span><span class="n">change</span><span class="p">:</span>
<span class="w">                        </span><span class="nc">time</span><span class="p">:</span><span class="w">   </span><span class="p">[</span><span class="o">+</span><span class="mf">43.064</span><span class="o">%</span><span class="w"> </span><span class="o">+</span><span class="mf">46.066</span><span class="o">%</span><span class="w"> </span><span class="o">+</span><span class="mf">49.080</span><span class="o">%</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span>
<span class="w">                        </span><span class="n">thrpt</span><span class="p">:</span><span class="w">  </span><span class="p">[</span><span class="err">−</span><span class="mf">32.922</span><span class="o">%</span><span class="w"> </span><span class="err">−</span><span class="mf">31.538</span><span class="o">%</span><span class="w"> </span><span class="err">−</span><span class="mf">30.101</span><span class="o">%</span><span class="p">]</span>
<span class="w">                        </span><span class="n">Performance</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">regressed</span><span class="p">.</span>
<span class="n">Found</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="n">outliers</span><span class="w"> </span><span class="n">among</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="n">measurements</span><span class="w"> </span><span class="p">(</span><span class="mf">7.00</span><span class="o">%</span><span class="p">)</span>
<span class="w">  </span><span class="mi">7</span><span class="w"> </span><span class="p">(</span><span class="mf">7.00</span><span class="o">%</span><span class="p">)</span><span class="w"> </span><span class="n">high</span><span class="w"> </span><span class="n">mild</span>
<span class="n">call</span><span class="o">-</span><span class="n">indirect</span><span class="o">/</span><span class="n">same</span><span class="o">-</span><span class="n">callee</span><span class="o">/</span><span class="n">table</span><span class="o">-</span><span class="n">init</span><span class="o">-</span><span class="n">strict</span><span class="o">/</span><span class="mi">65536</span><span class="o">-</span><span class="n">calls</span>
<span class="w">                        </span><span class="n">time</span><span class="p">:</span><span class="w">   </span><span class="p">[</span><span class="mf">130.27</span><span class="w"> </span><span class="err">µ</span><span class="n">s</span><span class="w"> </span><span class="mf">131.66</span><span class="w"> </span><span class="err">µ</span><span class="n">s</span><span class="w"> </span><span class="mf">133.40</span><span class="w"> </span><span class="err">µ</span><span class="n">s</span><span class="p">]</span>
<span class="w">                        </span><span class="n">thrpt</span><span class="p">:</span><span class="w">  </span><span class="p">[</span><span class="mf">491.26</span><span class="w"> </span><span class="n">Melem</span><span class="o">/</span><span class="n">s</span><span class="w"> </span><span class="mf">497.75</span><span class="w"> </span><span class="n">Melem</span><span class="o">/</span><span class="n">s</span><span class="w"> </span><span class="mf">503.09</span><span class="w"> </span><span class="n">Melem</span><span class="o">/</span><span class="n">s</span><span class="p">]</span>
<span class="w">                 </span><span class="n">change</span><span class="p">:</span>
<span class="w">                        </span><span class="nc">time</span><span class="p">:</span><span class="w">   </span><span class="p">[</span><span class="err">−</span><span class="mf">6.4798</span><span class="o">%</span><span class="w"> </span><span class="err">−</span><span class="mf">4.1871</span><span class="o">%</span><span class="w"> </span><span class="err">−</span><span class="mf">1.8965</span><span class="o">%</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span>
<span class="w">                        </span><span class="n">thrpt</span><span class="p">:</span><span class="w">  </span><span class="p">[</span><span class="o">+</span><span class="mf">1.9332</span><span class="o">%</span><span class="w"> </span><span class="o">+</span><span class="mf">4.3701</span><span class="o">%</span><span class="w"> </span><span class="o">+</span><span class="mf">6.9288</span><span class="o">%</span><span class="p">]</span>
<span class="w">                        </span><span class="n">Performance</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">improved</span><span class="p">.</span>
<span class="n">Found</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="n">outliers</span><span class="w"> </span><span class="n">among</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="n">measurements</span><span class="w"> </span><span class="p">(</span><span class="mf">12.00</span><span class="o">%</span><span class="p">)</span>
<span class="w">  </span><span class="mi">4</span><span class="w"> </span><span class="p">(</span><span class="mf">4.00</span><span class="o">%</span><span class="p">)</span><span class="w"> </span><span class="n">high</span><span class="w"> </span><span class="n">mild</span>
<span class="w">  </span><span class="mi">8</span><span class="w"> </span><span class="p">(</span><span class="mf">8.00</span><span class="o">%</span><span class="p">)</span><span class="w"> </span><span class="n">high</span><span class="w"> </span><span class="n">severe</span>
<span class="n">call</span><span class="o">-</span><span class="n">indirect</span><span class="o">/</span><span class="n">different</span><span class="o">-</span><span class="n">callees</span><span class="o">/</span><span class="n">table</span><span class="o">-</span><span class="n">init</span><span class="o">-</span><span class="n">strict</span><span class="o">/</span><span class="mi">65536</span><span class="o">-</span><span class="n">calls</span>
<span class="w">                        </span><span class="n">time</span><span class="p">:</span><span class="w">   </span><span class="p">[</span><span class="mf">176.22</span><span class="w"> </span><span class="err">µ</span><span class="n">s</span><span class="w"> </span><span class="mf">178.49</span><span class="w"> </span><span class="err">µ</span><span class="n">s</span><span class="w"> </span><span class="mf">180.99</span><span class="w"> </span><span class="err">µ</span><span class="n">s</span><span class="p">]</span>
<span class="w">                        </span><span class="n">thrpt</span><span class="p">:</span><span class="w">  </span><span class="p">[</span><span class="mf">362.10</span><span class="w"> </span><span class="n">Melem</span><span class="o">/</span><span class="n">s</span><span class="w"> </span><span class="mf">367.18</span><span class="w"> </span><span class="n">Melem</span><span class="o">/</span><span class="n">s</span><span class="w"> </span><span class="mf">371.90</span><span class="w"> </span><span class="n">Melem</span><span class="o">/</span><span class="n">s</span><span class="p">]</span>
<span class="w">                 </span><span class="n">change</span><span class="p">:</span>
<span class="w">                        </span><span class="nc">time</span><span class="p">:</span><span class="w">   </span><span class="p">[</span><span class="err">−</span><span class="mf">18.431</span><span class="o">%</span><span class="w"> </span><span class="err">−</span><span class="mf">15.397</span><span class="o">%</span><span class="w"> </span><span class="err">−</span><span class="mf">12.330</span><span class="o">%</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span>
<span class="w">                        </span><span class="n">thrpt</span><span class="p">:</span><span class="w">  </span><span class="p">[</span><span class="o">+</span><span class="mf">14.064</span><span class="o">%</span><span class="w"> </span><span class="o">+</span><span class="mf">18.200</span><span class="o">%</span><span class="w"> </span><span class="o">+</span><span class="mf">22.595</span><span class="o">%</span><span class="p">]</span>
<span class="w">                        </span><span class="n">Performance</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">improved</span><span class="p">.</span>
<span class="n">Found</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="n">outliers</span><span class="w"> </span><span class="n">among</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="n">measurements</span><span class="w"> </span><span class="p">(</span><span class="mf">7.00</span><span class="o">%</span><span class="p">)</span>
<span class="w">  </span><span class="mi">4</span><span class="w"> </span><span class="p">(</span><span class="mf">4.00</span><span class="o">%</span><span class="p">)</span><span class="w"> </span><span class="n">high</span><span class="w"> </span><span class="n">mild</span>
<span class="w">  </span><span class="mi">3</span><span class="w"> </span><span class="p">(</span><span class="mf">3.00</span><span class="o">%</span><span class="p">)</span><span class="w"> </span><span class="n">high</span><span class="w"> </span><span class="n">severe</span>
</code></pre></div>
<p>&lt;/details&gt;</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="537945318"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311630%20Lookup%20compiled%20functions%20by%20%60FuncKe.../near/537945318" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311630.20Lookup.20compiled.20functions.20by.20.60FuncKe.2E.2E.2E.html#537945318">(Sep 05 2025 at 20:50)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/cfallin">cfallin</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/11630">PR #11630</a>.</p>



<a name="537945320"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311630%20Lookup%20compiled%20functions%20by%20%60FuncKe.../near/537945320" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311630.20Lookup.20compiled.20functions.20by.20.60FuncKe.2E.2E.2E.html#537945320">(Sep 05 2025 at 20:50)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/11630">PR #11630</a>.</p>



<a name="537945322"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311630%20Lookup%20compiled%20functions%20by%20%60FuncKe.../near/537945322" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311630.20Lookup.20compiled.20functions.20by.20.60FuncKe.2E.2E.2E.html#537945322">(Sep 05 2025 at 20:50)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/alexcrichton">alexcrichton</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/11630">PR #11630</a>.</p>



<a name="537945323"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311630%20Lookup%20compiled%20functions%20by%20%60FuncKe.../near/537945323" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311630.20Lookup.20compiled.20functions.20by.20.60FuncKe.2E.2E.2E.html#537945323">(Sep 05 2025 at 20:50)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers">wasmtime-core-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/11630">PR #11630</a>.</p>



<a name="537946164"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311630%20Lookup%20compiled%20functions%20by%20%60FuncKe.../near/537946164" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311630.20Lookup.20compiled.20functions.20by.20.60FuncKe.2E.2E.2E.html#537946164">(Sep 05 2025 at 20:56)</a>:</h4>
<p>fitzgen edited <a href="https://github.com/bytecodealliance/wasmtime/pull/11630">PR #11630</a>:</p>
<blockquote>
<p>This treats compiled functions homogeneously, removing the need to add new metadata tables to places like <code>CompiledModuleInfo</code> whenever we add a new kind of function, and simplifying the process of constructing the metadata for a final, linked compilation artifact. This also paves the way to doing gc-sections in our linking (getting smaller code sizes, removing functions that have been inlined into every caller, and etc...) as we no longer assume that certain types of function index spaces are dense.</p>
<p>This does, however, replace a couple operations that were previously O(1) table lookups with O(log n) binary searches. And, notably, some of these are on the <code>VMFuncRef</code>-creation path, and therefore on the<br>
force-initialization-of-a-lazy-funcref-table-slot path, when we look up a Wasm function and its trampolines. Our call-indirect micro-benchmarks show that indirect calling every funcref once in a table of 64Ki slots went from taking ~2.6ms to ~3.8ms (a +46% slowdown). Note that this edge case is both synthetic and the worst-case scenario for this commit's change: we are measuring, as much as we can, <em>only</em> the force-initialization-of-a-lazy-funcref-table-slot path. All other call-indirect benchmarks are within the noise, which is what we would expect.</p>
<p>Also, the size of <code>.cwasm</code>s is slightly larger: <code>spidermonkey.wasm</code>'s <code>.cwasm</code> size went from <code>19_750_632</code> bytes to <code>19_785_872</code> bytes, which is a 1.78% increase.</p>
<p>Ultimately, I believe that the simplification and possibility of doing gc-sections in the future is worth the downsides. That said, if others feel differently, there are some things we could try to improve the situation, although most things I can think of off the top of my head (e.g. LEB128s and delta encoding, making certain <code>FuncKey</code> kinds' index spaces dense) will improve one of code size or lookup times while pessimizing the other. I'm sure we could come up with something given enough effort though.</p>
<p>&lt;details&gt;</p>
<p>&lt;summary&gt;call-indirect micro-benchmarks results&lt;/summary&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">call</span><span class="o">-</span><span class="n">indirect</span><span class="o">/</span><span class="n">same</span><span class="o">-</span><span class="n">callee</span><span class="o">/</span><span class="n">table</span><span class="o">-</span><span class="n">init</span><span class="o">-</span><span class="n">lazy</span><span class="o">/</span><span class="mi">65536</span><span class="o">-</span><span class="n">calls</span>
<span class="w">                        </span><span class="n">time</span><span class="p">:</span><span class="w">   </span><span class="p">[</span><span class="mf">144.14</span><span class="w"> </span><span class="err">µ</span><span class="n">s</span><span class="w"> </span><span class="mf">145.26</span><span class="w"> </span><span class="err">µ</span><span class="n">s</span><span class="w"> </span><span class="mf">146.56</span><span class="w"> </span><span class="err">µ</span><span class="n">s</span><span class="p">]</span>
<span class="w">                        </span><span class="n">thrpt</span><span class="p">:</span><span class="w">  </span><span class="p">[</span><span class="mf">447.15</span><span class="w"> </span><span class="n">Melem</span><span class="o">/</span><span class="n">s</span><span class="w"> </span><span class="mf">451.15</span><span class="w"> </span><span class="n">Melem</span><span class="o">/</span><span class="n">s</span><span class="w"> </span><span class="mf">454.68</span><span class="w"> </span><span class="n">Melem</span><span class="o">/</span><span class="n">s</span><span class="p">]</span>
<span class="w">                 </span><span class="n">change</span><span class="p">:</span>
<span class="w">                        </span><span class="nc">time</span><span class="p">:</span><span class="w">   </span><span class="p">[</span><span class="err">−</span><span class="mf">5.5066</span><span class="o">%</span><span class="w"> </span><span class="err">−</span><span class="mf">3.6611</span><span class="o">%</span><span class="w"> </span><span class="err">−</span><span class="mf">1.9130</span><span class="o">%</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span>
<span class="w">                        </span><span class="n">thrpt</span><span class="p">:</span><span class="w">  </span><span class="p">[</span><span class="o">+</span><span class="mf">1.9503</span><span class="o">%</span><span class="w"> </span><span class="o">+</span><span class="mf">3.8002</span><span class="o">%</span><span class="w"> </span><span class="o">+</span><span class="mf">5.8275</span><span class="o">%</span><span class="p">]</span>
<span class="w">                        </span><span class="n">Performance</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">improved</span><span class="p">.</span>
<span class="n">Found</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="n">outliers</span><span class="w"> </span><span class="n">among</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="n">measurements</span><span class="w"> </span><span class="p">(</span><span class="mf">9.00</span><span class="o">%</span><span class="p">)</span>
<span class="w">  </span><span class="mi">7</span><span class="w"> </span><span class="p">(</span><span class="mf">7.00</span><span class="o">%</span><span class="p">)</span><span class="w"> </span><span class="n">high</span><span class="w"> </span><span class="n">mild</span>
<span class="w">  </span><span class="mi">2</span><span class="w"> </span><span class="p">(</span><span class="mf">2.00</span><span class="o">%</span><span class="p">)</span><span class="w"> </span><span class="n">high</span><span class="w"> </span><span class="n">severe</span>
<span class="n">call</span><span class="o">-</span><span class="n">indirect</span><span class="o">/</span><span class="n">different</span><span class="o">-</span><span class="n">callees</span><span class="o">/</span><span class="n">table</span><span class="o">-</span><span class="n">init</span><span class="o">-</span><span class="n">lazy</span><span class="o">/</span><span class="mi">65536</span><span class="o">-</span><span class="n">calls</span>
<span class="w">                        </span><span class="n">time</span><span class="p">:</span><span class="w">   </span><span class="p">[</span><span class="mf">3.8128</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="mf">3.8433</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="mf">3.8763</span><span class="w"> </span><span class="n">ms</span><span class="p">]</span>
<span class="w">                        </span><span class="n">thrpt</span><span class="p">:</span><span class="w">  </span><span class="p">[</span><span class="mf">16.907</span><span class="w"> </span><span class="n">Melem</span><span class="o">/</span><span class="n">s</span><span class="w"> </span><span class="mf">17.052</span><span class="w"> </span><span class="n">Melem</span><span class="o">/</span><span class="n">s</span><span class="w"> </span><span class="mf">17.188</span><span class="w"> </span><span class="n">Melem</span><span class="o">/</span><span class="n">s</span><span class="p">]</span>
<span class="w">                 </span><span class="n">change</span><span class="p">:</span>
<span class="w">                        </span><span class="nc">time</span><span class="p">:</span><span class="w">   </span><span class="p">[</span><span class="o">+</span><span class="mf">43.064</span><span class="o">%</span><span class="w"> </span><span class="o">+</span><span class="mf">46.066</span><span class="o">%</span><span class="w"> </span><span class="o">+</span><span class="mf">49.080</span><span class="o">%</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span>
<span class="w">                        </span><span class="n">thrpt</span><span class="p">:</span><span class="w">  </span><span class="p">[</span><span class="err">−</span><span class="mf">32.922</span><span class="o">%</span><span class="w"> </span><span class="err">−</span><span class="mf">31.538</span><span class="o">%</span><span class="w"> </span><span class="err">−</span><span class="mf">30.101</span><span class="o">%</span><span class="p">]</span>
<span class="w">                        </span><span class="n">Performance</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">regressed</span><span class="p">.</span>
<span class="n">Found</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="n">outliers</span><span class="w"> </span><span class="n">among</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="n">measurements</span><span class="w"> </span><span class="p">(</span><span class="mf">7.00</span><span class="o">%</span><span class="p">)</span>
<span class="w">  </span><span class="mi">7</span><span class="w"> </span><span class="p">(</span><span class="mf">7.00</span><span class="o">%</span><span class="p">)</span><span class="w"> </span><span class="n">high</span><span class="w"> </span><span class="n">mild</span>
<span class="n">call</span><span class="o">-</span><span class="n">indirect</span><span class="o">/</span><span class="n">same</span><span class="o">-</span><span class="n">callee</span><span class="o">/</span><span class="n">table</span><span class="o">-</span><span class="n">init</span><span class="o">-</span><span class="n">strict</span><span class="o">/</span><span class="mi">65536</span><span class="o">-</span><span class="n">calls</span>
<span class="w">                        </span><span class="n">time</span><span class="p">:</span><span class="w">   </span><span class="p">[</span><span class="mf">130.27</span><span class="w"> </span><span class="err">µ</span><span class="n">s</span><span class="w"> </span><span class="mf">131.66</span><span class="w"> </span><span class="err">µ</span><span class="n">s</span><span class="w"> </span><span class="mf">133.40</span><span class="w"> </span><span class="err">µ</span><span class="n">s</span><span class="p">]</span>
<span class="w">                        </span><span class="n">thrpt</span><span class="p">:</span><span class="w">  </span><span class="p">[</span><span class="mf">491.26</span><span class="w"> </span><span class="n">Melem</span><span class="o">/</span><span class="n">s</span><span class="w"> </span><span class="mf">497.75</span><span class="w"> </span><span class="n">Melem</span><span class="o">/</span><span class="n">s</span><span class="w"> </span><span class="mf">503.09</span><span class="w"> </span><span class="n">Melem</span><span class="o">/</span><span class="n">s</span><span class="p">]</span>
<span class="w">                 </span><span class="n">change</span><span class="p">:</span>
<span class="w">                        </span><span class="nc">time</span><span class="p">:</span><span class="w">   </span><span class="p">[</span><span class="err">−</span><span class="mf">6.4798</span><span class="o">%</span><span class="w"> </span><span class="err">−</span><span class="mf">4.1871</span><span class="o">%</span><span class="w"> </span><span class="err">−</span><span class="mf">1.8965</span><span class="o">%</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span>
<span class="w">                        </span><span class="n">thrpt</span><span class="p">:</span><span class="w">  </span><span class="p">[</span><span class="o">+</span><span class="mf">1.9332</span><span class="o">%</span><span class="w"> </span><span class="o">+</span><span class="mf">4.3701</span><span class="o">%</span><span class="w"> </span><span class="o">+</span><span class="mf">6.9288</span><span class="o">%</span><span class="p">]</span>
<span class="w">                        </span><span class="n">Performance</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">improved</span><span class="p">.</span>
<span class="n">Found</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="n">outliers</span><span class="w"> </span><span class="n">among</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="n">measurements</span><span class="w"> </span><span class="p">(</span><span class="mf">12.00</span><span class="o">%</span><span class="p">)</span>
<span class="w">  </span><span class="mi">4</span><span class="w"> </span><span class="p">(</span><span class="mf">4.00</span><span class="o">%</span><span class="p">)</span><span class="w"> </span><span class="n">high</span><span class="w"> </span><span class="n">mild</span>
<span class="w">  </span><span class="mi">8</span><span class="w"> </span><span class="p">(</span><span class="mf">8.00</span><span class="o">%</span><span class="p">)</span><span class="w"> </span><span class="n">high</span><span class="w"> </span><span class="n">severe</span>
<span class="n">call</span><span class="o">-</span><span class="n">indirect</span><span class="o">/</span><span class="n">different</span><span class="o">-</span><span class="n">callees</span><span class="o">/</span><span class="n">table</span><span class="o">-</span><span class="n">init</span><span class="o">-</span><span class="n">strict</span><span class="o">/</span><span class="mi">65536</span><span class="o">-</span><span class="n">calls</span>
<span class="w">                        </span><span class="n">time</span><span class="p">:</span><span class="w">   </span><span class="p">[</span><span class="mf">176.22</span><span class="w"> </span><span class="err">µ</span><span class="n">s</span><span class="w"> </span><span class="mf">178.49</span><span class="w"> </span><span class="err">µ</span><span class="n">s</span><span class="w"> </span><span class="mf">180.99</span><span class="w"> </span><span class="err">µ</span><span class="n">s</span><span class="p">]</span>
<span class="w">                        </span><span class="n">thrpt</span><span class="p">:</span><span class="w">  </span><span class="p">[</span><span class="mf">362.10</span><span class="w"> </span><span class="n">Melem</span><span class="o">/</span><span class="n">s</span><span class="w"> </span><span class="mf">367.18</span><span class="w"> </span><span class="n">Melem</span><span class="o">/</span><span class="n">s</span><span class="w"> </span><span class="mf">371.90</span><span class="w"> </span><span class="n">Melem</span><span class="o">/</span><span class="n">s</span><span class="p">]</span>
<span class="w">                 </span><span class="n">change</span><span class="p">:</span>
<span class="w">                        </span><span class="nc">time</span><span class="p">:</span><span class="w">   </span><span class="p">[</span><span class="err">−</span><span class="mf">18.431</span><span class="o">%</span><span class="w"> </span><span class="err">−</span><span class="mf">15.397</span><span class="o">%</span><span class="w"> </span><span class="err">−</span><span class="mf">12.330</span><span class="o">%</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span>
<span class="w">                        </span><span class="n">thrpt</span><span class="p">:</span><span class="w">  </span><span class="p">[</span><span class="o">+</span><span class="mf">14.064</span><span class="o">%</span><span class="w"> </span><span class="o">+</span><span class="mf">18.200</span><span class="o">%</span><span class="w"> </span><span class="o">+</span><span class="mf">22.595</span><span class="o">%</span><span class="p">]</span>
<span class="w">                        </span><span class="n">Performance</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">improved</span><span class="p">.</span>
<span class="n">Found</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="n">outliers</span><span class="w"> </span><span class="n">among</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="n">measurements</span><span class="w"> </span><span class="p">(</span><span class="mf">7.00</span><span class="o">%</span><span class="p">)</span>
<span class="w">  </span><span class="mi">4</span><span class="w"> </span><span class="p">(</span><span class="mf">4.00</span><span class="o">%</span><span class="p">)</span><span class="w"> </span><span class="n">high</span><span class="w"> </span><span class="n">mild</span>
<span class="w">  </span><span class="mi">3</span><span class="w"> </span><span class="p">(</span><span class="mf">3.00</span><span class="o">%</span><span class="p">)</span><span class="w"> </span><span class="n">high</span><span class="w"> </span><span class="n">severe</span>
</code></pre></div>
<p>&lt;/details&gt;</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="537946651"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311630%20Lookup%20compiled%20functions%20by%20%60FuncKe.../near/537946651" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311630.20Lookup.20compiled.20functions.20by.20.60FuncKe.2E.2E.2E.html#537946651">(Sep 05 2025 at 21:00)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11630">PR #11630</a>.</p>



<a name="537948009"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311630%20Lookup%20compiled%20functions%20by%20%60FuncKe.../near/537948009" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311630.20Lookup.20compiled.20functions.20by.20.60FuncKe.2E.2E.2E.html#537948009">(Sep 05 2025 at 21:10)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11630">PR #11630</a>.</p>



<a name="537956404"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311630%20Lookup%20compiled%20functions%20by%20%60FuncKe.../near/537956404" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311630.20Lookup.20compiled.20functions.20by.20.60FuncKe.2E.2E.2E.html#537956404">(Sep 05 2025 at 22:44)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/11630#issuecomment-3259950762">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11630">PR #11630</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @saulecabrera</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "wasmtime:api", "winch"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>saulecabrera: winch</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="538306652"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311630%20Lookup%20compiled%20functions%20by%20%60FuncKe.../near/538306652" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311630.20Lookup.20compiled.20functions.20by.20.60FuncKe.2E.2E.2E.html#538306652">(Sep 08 2025 at 20:07)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/11630#discussion_r2331236705">PR review comment</a>:</p>
<blockquote>
<p>Could this expand on what a <code>None</code> case means?</p>
<p>(also if it's purely to be able to use <code>Module::default</code> I think it'd be ok to remove that construction method)</p>
</blockquote>



<a name="538306653"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311630%20Lookup%20compiled%20functions%20by%20%60FuncKe.../near/538306653" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311630.20Lookup.20compiled.20functions.20by.20.60FuncKe.2E.2E.2E.html#538306653">(Sep 08 2025 at 20:07)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11630#pullrequestreview-3197953050">PR review</a>:</p>
<blockquote>
<p>Really nice how this turned out, thanks for pushing on this!</p>
<p>One more benchmark though before merging I now realize -- component instantiation. IIRC we confirmed core wasm instantiation was largely unaffected by this but reading over this I'm remembering that component instantiation, when it hits various initializers for trampolines/builtins/etc, will do the <code>FuncKey</code> lookup now. Can you make a simple-ish <code>spidermonkey.wasm</code> component and compare before/after the instantiation numbers?</p>
</blockquote>



<a name="539160455"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311630%20Lookup%20compiled%20functions%20by%20%60FuncKe.../near/539160455" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311630.20Lookup.20compiled.20functions.20by.20.60FuncKe.2E.2E.2E.html#539160455">(Sep 12 2025 at 20:46)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11630#pullrequestreview-3218772391">PR review</a>.</p>



<a name="539160456"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311630%20Lookup%20compiled%20functions%20by%20%60FuncKe.../near/539160456" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311630.20Lookup.20compiled.20functions.20by.20.60FuncKe.2E.2E.2E.html#539160456">(Sep 12 2025 at 20:46)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/11630#discussion_r2345400744">PR review comment</a>:</p>
<blockquote>
<p>Addressed in <a href="https://github.com/bytecodealliance/wasmtime/pull/11694">https://github.com/bytecodealliance/wasmtime/pull/11694</a></p>
</blockquote>



<a name="539635248"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311630%20Lookup%20compiled%20functions%20by%20%60FuncKe.../near/539635248" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311630.20Lookup.20compiled.20functions.20by.20.60FuncKe.2E.2E.2E.html#539635248">(Sep 15 2025 at 19:38)</a>:</h4>
<p>fitzgen updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11630">PR #11630</a>.</p>



<a name="539635431"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311630%20Lookup%20compiled%20functions%20by%20%60FuncKe.../near/539635431" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311630.20Lookup.20compiled.20functions.20by.20.60FuncKe.2E.2E.2E.html#539635431">(Sep 15 2025 at 19:39)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/pull/11630#issuecomment-3293663797">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11630">PR #11630</a>:</p>
<blockquote>
<p>@alexcrichton mind taking another look at this? Redid a bunch of stuff so that there is actually a (very small) code size improvement now, the various index spaces have nice newtypes, and lookups into dense index spaces are O(1) again.</p>
</blockquote>



<a name="539635544"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311630%20Lookup%20compiled%20functions%20by%20%60FuncKe.../near/539635544" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311630.20Lookup.20compiled.20functions.20by.20.60FuncKe.2E.2E.2E.html#539635544">(Sep 15 2025 at 19:40)</a>:</h4>
<p>fitzgen edited <a href="https://github.com/bytecodealliance/wasmtime/pull/11630">PR #11630</a>:</p>
<blockquote>
<p>This commit refactors our metadata, treating compiled functions homogeneously<br>
and removing the need to add new tables to places like <code>CompiledModuleInfo</code><br>
whenever we add a new kind of function. This also simplifies the process of<br>
constructing the metadata for a final, linked compilation artifact. Finally, it<br>
paves the way to doing gc-sections during our linking process (which would give<br>
us smaller code sizes by removing functions that have been inlined into every<br>
caller, for example) as we now allow holes in certain types of function index<br>
spaces that were previously always densely populated.</p>
<p>We have two kinds of index spaces:</p>
<ol>
<li>
<p>Mostly-dense index spaces, which take O(max_index) space and provide O(1)<br>
lookups.</p>
</li>
<li>
<p>Sparse index spaces, which take O(num_members) space and provide<br>
O(log n) lookups.</p>
</li>
</ol>
<p>Most of our function index spaces are currently dense, but we can tweak that in<br>
the future if necessary.</p>
<p>Furthermore, code size of <code>.cwasm</code> binaries has shrunk very slightly with this<br>
refactoring. Consider <code>spidermonkey.wasm</code>'s compiled <code>.cwasm</code>:</p>
<ul>
<li>Size before: 218756 <code>.wasmtime.info</code> section bytes, 20052632 total bytes</li>
<li>Size after: 213761 <code>.wasmtime.info</code> section bytes, 20047640 total bytes</li>
</ul>
<p>That is a 2.28% reduction on the size of the <code>.wasmtime.info</code> section, or a<br>
0.025% reduction total.</p>
<p>However, we previously did a single metadata lookup to get the location of both<br>
a Wasm function itself and its array-to-Wasm trampoline at the same time, and in<br>
the new version of the code two lookups are performed. This is slightly slower,<br>
as shown in our call-indirect micro-benchmark that combines lazy table<br>
initialization (which delays looking up the function element's location until<br>
runtime) with indirect-calling each table element exactly once (which defeats<br>
the amortization of that lookup). So this micro-benchmark is both synthetic and<br>
the worst-case scenario for this commit's change: we are measuring, as much as<br>
we can, <em>only</em> the force-initialization-of-a-lazy-funcref-table-slot path.</p>
<p>Ultimately, I believe that the simplification is worth the regression in this<br>
micro-benchmark.</p>
<p>&lt;details&gt;</p>
<p>&lt;summary&gt;call-indirect micro-benchmarks results&lt;/summary&gt;</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">call</span><span class="o">-</span><span class="n">indirect</span><span class="o">/</span><span class="n">same</span><span class="o">-</span><span class="n">callee</span><span class="o">/</span><span class="n">table</span><span class="o">-</span><span class="n">init</span><span class="o">-</span><span class="n">lazy</span><span class="o">/</span><span class="mi">65536</span><span class="o">-</span><span class="n">calls</span>
<span class="w">                        </span><span class="n">time</span><span class="p">:</span><span class="w">   </span><span class="p">[</span><span class="mf">152.77</span><span class="w"> </span><span class="err">µ</span><span class="n">s</span><span class="w"> </span><span class="mf">154.92</span><span class="w"> </span><span class="err">µ</span><span class="n">s</span><span class="w"> </span><span class="mf">157.39</span><span class="w"> </span><span class="err">µ</span><span class="n">s</span><span class="p">]</span>
<span class="w">                        </span><span class="n">thrpt</span><span class="p">:</span><span class="w">  </span><span class="p">[</span><span class="mf">416.40</span><span class="w"> </span><span class="n">Melem</span><span class="o">/</span><span class="n">s</span><span class="w"> </span><span class="mf">423.04</span><span class="w"> </span><span class="n">Melem</span><span class="o">/</span><span class="n">s</span><span class="w"> </span><span class="mf">428.99</span><span class="w"> </span><span class="n">Melem</span><span class="o">/</span><span class="n">s</span><span class="p">]</span>
<span class="w">                 </span><span class="n">change</span><span class="p">:</span>
<span class="w">                        </span><span class="nc">time</span><span class="p">:</span><span class="w">   </span><span class="p">[</span><span class="err">−</span><span class="mf">13.749</span><span class="o">%</span><span class="w"> </span><span class="err">−</span><span class="mf">10.205</span><span class="o">%</span><span class="w"> </span><span class="err">−</span><span class="mf">6.2864</span><span class="o">%</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span>
<span class="w">                        </span><span class="n">thrpt</span><span class="p">:</span><span class="w">  </span><span class="p">[</span><span class="o">+</span><span class="mf">6.7081</span><span class="o">%</span><span class="w"> </span><span class="o">+</span><span class="mf">11.365</span><span class="o">%</span><span class="w"> </span><span class="o">+</span><span class="mf">15.941</span><span class="o">%</span><span class="p">]</span>
<span class="w">                        </span><span class="n">Performance</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">improved</span><span class="p">.</span>
<span class="n">Found</span><span class="w"> </span><span class="mi">13</span><span class="w"> </span><span class="n">outliers</span><span class="w"> </span><span class="n">among</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="n">measurements</span><span class="w"> </span><span class="p">(</span><span class="mf">13.00</span><span class="o">%</span><span class="p">)</span>
<span class="w">  </span><span class="mi">8</span><span class="w"> </span><span class="p">(</span><span class="mf">8.00</span><span class="o">%</span><span class="p">)</span><span class="w"> </span><span class="n">high</span><span class="w"> </span><span class="n">mild</span>
<span class="w">  </span><span class="mi">5</span><span class="w"> </span><span class="p">(</span><span class="mf">5.00</span><span class="o">%</span><span class="p">)</span><span class="w"> </span><span class="n">high</span><span class="w"> </span><span class="n">severe</span>
<span class="n">call</span><span class="o">-</span><span class="n">indirect</span><span class="o">/</span><span class="n">different</span><span class="o">-</span><span class="n">callees</span><span class="o">/</span><span class="n">table</span><span class="o">-</span><span class="n">init</span><span class="o">-</span><span class="n">lazy</span><span class="o">/</span><span class="mi">65536</span><span class="o">-</span><span class="n">calls</span>
<span class="w">                        </span><span class="n">time</span><span class="p">:</span><span class="w">   </span><span class="p">[</span><span class="mf">4.3564</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="mf">4.4641</span><span class="w"> </span><span class="n">ms</span><span class="w"> </span><span class="mf">4.5843</span><span class="w"> </span><span class="n">ms</span><span class="p">]</span>
<span class="w">                        </span><span class="n">thrpt</span><span class="p">:</span><span class="w">  </span><span class="p">[</span><span class="mf">14.296</span><span class="w"> </span><span class="n">Melem</span><span class="o">/</span><span class="n">s</span><span class="w"> </span><span class="mf">14.681</span><span class="w"> </span><span class="n">Melem</span><span class="o">/</span><span class="n">s</span><span class="w"> </span><span class="mf">15.044</span><span class="w"> </span><span class="n">Melem</span><span class="o">/</span><span class="n">s</span><span class="p">]</span>
<span class="w">                 </span><span class="n">change</span><span class="p">:</span>
<span class="w">                        </span><span class="nc">time</span><span class="p">:</span><span class="w">   </span><span class="p">[</span><span class="o">+</span><span class="mf">38.134</span><span class="o">%</span><span class="w"> </span><span class="o">+</span><span class="mf">44.404</span><span class="o">%</span><span class="w"> </span><span class="o">+</span><span class="mf">50.927</span><span class="o">%</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span>
<span class="w">                        </span><span class="n">thrpt</span><span class="p">:</span><span class="w">  </span><span class="p">[</span><span class="err">−</span><span class="mf">33.743</span><span class="o">%</span><span class="w"> </span><span class="err">−</span><span class="mf">30.750</span><span class="o">%</span><span class="w"> </span><span class="err">−</span><span class="mf">27.606</span><span class="o">%</span><span class="p">]</span>
<span class="w">                        </span><span class="n">Performance</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">regressed</span><span class="p">.</span>
<span class="n">Found</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">outliers</span><span class="w"> </span><span class="n">among</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="n">measurements</span><span class="w"> </span><span class="p">(</span><span class="mf">5.00</span><span class="o">%</span><span class="p">)</span>
<span class="w">  </span><span class="mi">2</span><span class="w"> </span><span class="p">(</span><span class="mf">2.00</span><span class="o">%</span><span class="p">)</span><span class="w"> </span><span class="n">high</span><span class="w"> </span><span class="n">mild</span>
<span class="w">  </span><span class="mi">3</span><span class="w"> </span><span class="p">(</span><span class="mf">3.00</span><span class="o">%</span><span class="p">)</span><span class="w"> </span><span class="n">high</span><span class="w"> </span><span class="n">severe</span>
<span class="n">call</span><span class="o">-</span><span class="n">indirect</span><span class="o">/</span><span class="n">same</span><span class="o">-</span><span class="n">callee</span><span class="o">/</span><span class="n">table</span><span class="o">-</span><span class="n">init</span><span class="o">-</span><span class="n">strict</span><span class="o">/</span><span class="mi">65536</span><span class="o">-</span><span class="n">calls</span>
<span class="w">                        </span><span class="n">time</span><span class="p">:</span><span class="w">   </span><span class="p">[</span><span class="mf">144.91</span><span class="w"> </span><span class="err">µ</span><span class="n">s</span><span class="w"> </span><span class="mf">148.41</span><span class="w"> </span><span class="err">µ</span><span class="n">s</span><span class="w"> </span><span class="mf">152.02</span><span class="w"> </span><span class="err">µ</span><span class="n">s</span><span class="p">]</span>
<span class="w">                        </span><span class="n">thrpt</span><span class="p">:</span><span class="w">  </span><span class="p">[</span><span class="mf">431.10</span><span class="w"> </span><span class="n">Melem</span><span class="o">/</span><span class="n">s</span><span class="w"> </span><span class="mf">441.58</span><span class="w"> </span><span class="n">Melem</span><span class="o">/</span><span class="n">s</span><span class="w"> </span><span class="mf">452.24</span><span class="w"> </span><span class="n">Melem</span><span class="o">/</span><span class="n">s</span><span class="p">]</span>
<span class="w">                 </span><span class="n">change</span><span class="p">:</span>
<span class="w">                        </span><span class="nc">time</span><span class="p">:</span><span class="w">   </span><span class="p">[</span><span class="err">−</span><span class="mf">13.665</span><span class="o">%</span><span class="w"> </span><span class="err">−</span><span class="mf">10.470</span><span class="o">%</span><span class="w"> </span><span class="err">−</span><span class="mf">7.2626</span><span class="o">%</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span>
<span class="w">                        </span><span class="n">thrpt</span><span class="p">:</span><span class="w">  </span><span class="p">[</span><span class="o">+</span><span class="mf">7.8313</span><span class="o">%</span><span class="w"> </span><span class="o">+</span><span class="mf">11.694</span><span class="o">%</span><span class="w"> </span><span class="o">+</span><span class="mf">15.828</span><span class="o">%</span><span class="p">]</span>
<span class="w">                        </span><span class="n">Performance</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">improved</span><span class="p">.</span>
<span class="n">Found</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="n">outliers</span><span class="w"> </span><span class="n">among</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="n">measurements</span><span class="w"> </span><span class="p">(</span><span class="mf">4.00</span><span class="o">%</span><span class="p">)</span>
<span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="mf">1.00</span><span class="o">%</span><span class="p">)</span><span class="w"> </span><span class="n">high</span><span class="w"> </span><span class="n">mild</span>
<span class="w">  </span><span class="mi">3</span><span class="w"> </span><span class="p">(</span><span class="mf">3.00</span><span class="o">%</span><span class="p">)</span><span class="w"> </span><span class="n">high</span><span class="w"> </span><span class="n">severe</span>
<span class="n">call</span><span class="o">-</span><span class="n">indirect</span><span class="o">/</span><span class="n">different</span><span class="o">-</span><span class="n">callees</span><span class="o">/</span><span class="n">table</span><span class="o">-</span><span class="n">init</span><span class="o">-</span><span class="n">strict</span><span class="o">/</span><span class="mi">65536</span><span class="o">-</span><span class="n">calls</span>
<span class="w">                        </span><span class="n">time</span><span class="p">:</span><span class="w">   </span><span class="p">[</span><span class="mf">195.18</span><span class="w"> </span><span class="err">µ</span><span class="n">s</span><span class="w"> </span><span class="mf">200.67</span><span class="w"> </span><span class="err">µ</span><span class="n">s</span><span class="w"> </span><span class="mf">206.49</span><span class="w"> </span><span class="err">µ</span><span class="n">s</span><span class="p">]</span>
<span class="w">                        </span><span class="n">thrpt</span><span class="p">:</span><span class="w">  </span><span class="p">[</span><span class="mf">317.38</span><span class="w"> </span><span class="n">Melem</span><span class="o">/</span><span class="n">s</span><span class="w"> </span><span class="mf">326.59</span><span class="w"> </span><span class="n">Melem</span><span class="o">/</span><span class="n">s</span><span class="w"> </span><span class="mf">335.77</span><span class="w"> </span><span class="n">Melem</span><span class="o">/</span><span class="n">s</span><span class="p">]</span>
<span class="w">                 </span><span class="n">change</span><span class="p">:</span>
<span class="w">                        </span><span class="nc">time</span><span class="p">:</span><span class="w">   </span><span class="p">[</span><span class="err">−</span><span class="mf">15.936</span><span class="o">%</span><span class="w"> </span><span class="err">−</span><span class="mf">11.568</span><span class="o">%</span><span class="w"> </span><span class="err">−</span><span class="mf">7.0835</span><span class="o">%</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span>
<span class="w">                        </span><span class="n">thrpt</span><span class="p">:</span><span class="w">  </span><span class="p">[</span><span class="o">+</span><span class="mf">7.6235</span><span class="o">%</span><span class="w"> </span><span class="o">+</span><span class="mf">13.081</span><span class="o">%</span><span class="w"> </span><span class="o">+</span><span class="mf">18.957</span><span class="o">%</span><span class="p">]</span>
<span class="w">                        </span><span class="n">Performance</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">improved</span><span class="p">.</span>
<span class="n">Found</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="n">outliers</span><span class="w"> </span><span class="n">among</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="n">measurements</span><span class="w"> </span><span class="p">(</span><span class="mf">5.00</span><span class="o">%</span><span class="p">)</span>
<span class="w">  </span><span class="mi">5</span><span class="w"> </span><span class="p">(</span><span class="mf">5.00</span><span class="o">%</span><span class="p">)</span><span class="w"> </span><span class="n">high</span><span class="w"> </span><span class="n">mild</span>
</code></pre></div>
</blockquote>



<a name="539653312"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311630%20Lookup%20compiled%20functions%20by%20%60FuncKe.../near/539653312" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311630.20Lookup.20compiled.20functions.20by.20.60FuncKe.2E.2E.2E.html#539653312">(Sep 15 2025 at 22:00)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11630#pullrequestreview-3226453152">PR review</a>.</p>



<a name="539658773"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311630%20Lookup%20compiled%20functions%20by%20%60FuncKe.../near/539658773" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311630.20Lookup.20compiled.20functions.20by.20.60FuncKe.2E.2E.2E.html#539658773">(Sep 15 2025 at 22:59)</a>:</h4>
<p>fitzgen merged <a href="https://github.com/bytecodealliance/wasmtime/pull/11630">PR #11630</a>.</p>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
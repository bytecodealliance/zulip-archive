<html>
<head><meta charset="utf-8"><title>wasmtime / issue #10418 differential fuzzbug: Wide arithm... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310418.20differential.20fuzzbug.3A.20Wide.20arithm.2E.2E.2E.html">wasmtime / issue #10418 differential fuzzbug: Wide arithm...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="506456765"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310418%20differential%20fuzzbug%3A%20Wide%20arithm.../near/506456765" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310418.20differential.20fuzzbug.3A.20Wide.20arithm.2E.2E.2E.html#506456765">(Mar 18 2025 at 11:44)</a>:</h4>
<p><a href="https://github.com/saulecabrera">saulecabrera</a> added the fuzz-bug label to <a href="https://github.com/bytecodealliance/wasmtime/issues/10418">Issue #10418</a>.</p>



<a name="506456766"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310418%20differential%20fuzzbug%3A%20Wide%20arithm.../near/506456766" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310418.20differential.20fuzzbug.3A.20Wide.20arithm.2E.2E.2E.html#506456766">(Mar 18 2025 at 11:44)</a>:</h4>
<p><a href="https://github.com/saulecabrera">saulecabrera</a> added the bug label to <a href="https://github.com/bytecodealliance/wasmtime/issues/10418">Issue #10418</a>.</p>



<a name="506456772"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310418%20differential%20fuzzbug%3A%20Wide%20arithm.../near/506456772" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310418.20differential.20fuzzbug.3A.20Wide.20arithm.2E.2E.2E.html#506456772">(Mar 18 2025 at 11:44)</a>:</h4>
<p>saulecabrera opened <a href="https://github.com/bytecodealliance/wasmtime/issues/10418">issue #10418</a>:</p>
<blockquote>
<p>For the following program:</p>
<div class="codehilite" data-code-language="WebAssembly"><pre><span></span><code><span class="p">(</span><span class="k">module</span>
  <span class="p">(</span><span class="k">type</span> <span class="cm">(;0;)</span> <span class="p">(</span><span class="k">func</span> <span class="p">(</span><span class="k">param</span> <span class="kt">i32</span><span class="p">)</span> <span class="p">(</span><span class="k">result</span> <span class="kt">i64</span><span class="p">)))</span>
  <span class="p">(</span><span class="k">global</span> <span class="cm">(;0;)</span> <span class="p">(</span><span class="k">mut</span> <span class="kt">i32</span><span class="p">)</span> <span class="nb">i32.const</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">(</span><span class="k">global</span> <span class="cm">(;1;)</span> <span class="p">(</span><span class="k">mut</span> <span class="kt">i64</span><span class="p">)</span> <span class="nb">i64.const</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">(</span><span class="k">global</span> <span class="cm">(;2;)</span> <span class="p">(</span><span class="k">mut</span> <span class="kt">i32</span><span class="p">)</span> <span class="nb">i32.const</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">(</span><span class="k">export</span> <span class="s2">" "</span> <span class="p">(</span><span class="k">func</span> <span class="mi">0</span><span class="p">))</span>
  <span class="p">(</span><span class="k">func</span> <span class="cm">(;0;)</span> <span class="p">(</span><span class="k">type</span> <span class="mi">0</span><span class="p">)</span> <span class="p">(</span><span class="k">param</span> <span class="kt">i32</span><span class="p">)</span> <span class="p">(</span><span class="k">result</span> <span class="kt">i64</span><span class="p">)</span>
    <span class="nb">i32.const</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="c1">;; label = @1</span>
      <span class="nb">unreachable</span>
    <span class="k">end</span>
    <span class="nb">global.get</span> <span class="mi">2</span>
    <span class="nb">global.set</span> <span class="mi">2</span>
    <span class="nb">i64.const</span> <span class="mf">288230376151711744</span>
    <span class="nb">i64.const</span> <span class="mf">288230376151711744</span>
    <span class="nb">i64.mul</span><span class="err">_wide_s</span>
    <span class="nb">i32.wrap_i64</span>
    <span class="nb">global.get</span> <span class="mi">0</span>
    <span class="nb">i32.xor</span>
    <span class="nb">global.set</span> <span class="mi">0</span>
    <span class="nb">global.get</span> <span class="mi">1</span>
    <span class="nb">i64.xor</span>
  <span class="p">)</span>
<span class="p">)</span>
</code></pre></div>
<p>When invoked via:</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>cargo<span class="w"> </span>run<span class="w"> </span>--<span class="w"> </span>run<span class="w"> </span>-Wwide-arithmetic<span class="o">=</span>y<span class="w"> </span>--invoke<span class="w"> </span><span class="s2">" "</span><span class="w"> </span>index.wat<span class="w"> </span><span class="m">0</span>
</code></pre></div>
<p>The result, using <code>-Ccompiler=cranelift</code> or <code>-Ccompiler=winch</code> or <code>--target=pulley64</code> is consistently the same: <code>0</code>. However, when invoked via:</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>wasm_cli<span class="w"> </span>--invoke<span class="w"> </span><span class="s2">" "</span><span class="w"> </span>index.wat<span class="w"> </span><span class="m">0</span>
</code></pre></div>
<p>The result is <code>4503599627370496</code></p>
<p>Reducing a bit further, it seems the the problem is the ordering of the return values from <code>i64.mul_wide_s</code></p>
<p>Consider:</p>
<div class="codehilite" data-code-language="WebAssembly"><pre><span></span><code><span class="p">(</span><span class="k">module</span>
  <span class="p">(</span><span class="k">type</span> <span class="cm">(;0;)</span> <span class="p">(</span><span class="k">func</span> <span class="p">(</span><span class="k">param</span> <span class="kt">i32</span><span class="p">)</span> <span class="p">(</span><span class="k">result</span> <span class="kt">i64</span><span class="p">)))</span>
  <span class="p">(</span><span class="k">global</span> <span class="cm">(;0;)</span> <span class="p">(</span><span class="k">mut</span> <span class="kt">i32</span><span class="p">)</span> <span class="nb">i32.const</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">(</span><span class="k">global</span> <span class="cm">(;1;)</span> <span class="p">(</span><span class="k">mut</span> <span class="kt">i64</span><span class="p">)</span> <span class="nb">i64.const</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">(</span><span class="k">global</span> <span class="cm">(;2;)</span> <span class="p">(</span><span class="k">mut</span> <span class="kt">i32</span><span class="p">)</span> <span class="nb">i32.const</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">(</span><span class="k">export</span> <span class="s2">" "</span> <span class="p">(</span><span class="k">func</span> <span class="mi">0</span><span class="p">))</span>
  <span class="p">(</span><span class="k">func</span> <span class="cm">(;0;)</span> <span class="p">(</span><span class="k">type</span> <span class="mi">0</span><span class="p">)</span> <span class="p">(</span><span class="k">param</span> <span class="kt">i32</span><span class="p">)</span> <span class="p">(</span><span class="k">result</span> <span class="kt">i64</span><span class="p">)</span>
    <span class="nb">i32.const</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="c1">;; label = @1</span>
      <span class="nb">unreachable</span>
    <span class="k">end</span>
    <span class="nb">global.get</span> <span class="mi">2</span>
    <span class="nb">global.set</span> <span class="mi">2</span>
    <span class="nb">i64.const</span> <span class="mf">288230376151711744</span>
    <span class="nb">i64.const</span> <span class="mf">288230376151711744</span>
    <span class="nb">i64.mul</span><span class="err">_wide_s</span>
    <span class="nb">drop</span>
  <span class="p">)</span>
<span class="p">)</span>
</code></pre></div>
<p>The result for Wasmtime (using any of the compilers or pulley) is: <code>0</code>.<br>
Using <code>wasmi</code>  the result is: <code>4503599627370496</code></p>
<p>Which clearly suggests that there's a discrepancy on how the results of <code>i64.mul_wide_s</code>  are handled in <code>wasmi</code>. According to the consistent results in Wasmtime, I'm tempted to suggest that this probably a bug in <code>wasmi</code>  itself, however, I'm opening this issue here first for confirmation. </p>
<p>cc @alexcrichton @Robbepop <br>
</p>
</blockquote>



<a name="506457257"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310418%20differential%20fuzzbug%3A%20Wide%20arithm.../near/506457257" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310418.20differential.20fuzzbug.3A.20Wide.20arithm.2E.2E.2E.html#506457257">(Mar 18 2025 at 11:46)</a>:</h4>
<p>Robbepop <a href="https://github.com/bytecodealliance/wasmtime/issues/10418#issuecomment-2732915918">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10418">issue #10418</a>:</p>
<blockquote>
<p>Since the <code>wide-arithmetic</code> support in Wasmi is fairly new it likely is a bug in Wasmi. Going to inspect it as soon as I find time.</p>
</blockquote>



<a name="506457260"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310418%20differential%20fuzzbug%3A%20Wide%20arithm.../near/506457260" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310418.20differential.20fuzzbug.3A.20Wide.20arithm.2E.2E.2E.html#506457260">(Mar 18 2025 at 11:46)</a>:</h4>
<p>saulecabrera edited <a href="https://github.com/bytecodealliance/wasmtime/issues/10418">issue #10418</a>:</p>
<blockquote>
<p>For the following program:</p>
<div class="codehilite" data-code-language="WebAssembly"><pre><span></span><code><span class="p">(</span><span class="k">module</span>
  <span class="p">(</span><span class="k">type</span> <span class="cm">(;0;)</span> <span class="p">(</span><span class="k">func</span> <span class="p">(</span><span class="k">param</span> <span class="kt">i32</span><span class="p">)</span> <span class="p">(</span><span class="k">result</span> <span class="kt">i64</span><span class="p">)))</span>
  <span class="p">(</span><span class="k">global</span> <span class="cm">(;0;)</span> <span class="p">(</span><span class="k">mut</span> <span class="kt">i32</span><span class="p">)</span> <span class="nb">i32.const</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">(</span><span class="k">global</span> <span class="cm">(;1;)</span> <span class="p">(</span><span class="k">mut</span> <span class="kt">i64</span><span class="p">)</span> <span class="nb">i64.const</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">(</span><span class="k">global</span> <span class="cm">(;2;)</span> <span class="p">(</span><span class="k">mut</span> <span class="kt">i32</span><span class="p">)</span> <span class="nb">i32.const</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">(</span><span class="k">export</span> <span class="s2">" "</span> <span class="p">(</span><span class="k">func</span> <span class="mi">0</span><span class="p">))</span>
  <span class="p">(</span><span class="k">func</span> <span class="cm">(;0;)</span> <span class="p">(</span><span class="k">type</span> <span class="mi">0</span><span class="p">)</span> <span class="p">(</span><span class="k">param</span> <span class="kt">i32</span><span class="p">)</span> <span class="p">(</span><span class="k">result</span> <span class="kt">i64</span><span class="p">)</span>
    <span class="nb">i32.const</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="c1">;; label = @1</span>
      <span class="nb">unreachable</span>
    <span class="k">end</span>
    <span class="nb">global.get</span> <span class="mi">2</span>
    <span class="nb">global.set</span> <span class="mi">2</span>
    <span class="nb">i64.const</span> <span class="mf">288230376151711744</span>
    <span class="nb">i64.const</span> <span class="mf">288230376151711744</span>
    <span class="nb">i64.mul</span><span class="err">_wide_s</span>
    <span class="nb">i32.wrap_i64</span>
    <span class="nb">global.get</span> <span class="mi">0</span>
    <span class="nb">i32.xor</span>
    <span class="nb">global.set</span> <span class="mi">0</span>
    <span class="nb">global.get</span> <span class="mi">1</span>
    <span class="nb">i64.xor</span>
  <span class="p">)</span>
<span class="p">)</span>
</code></pre></div>
<p>When invoked via:</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>cargo<span class="w"> </span>run<span class="w"> </span>--<span class="w"> </span>run<span class="w"> </span>-Wwide-arithmetic<span class="o">=</span>y<span class="w"> </span>--invoke<span class="w"> </span><span class="s2">" "</span><span class="w"> </span>index.wat<span class="w"> </span><span class="m">0</span>
</code></pre></div>
<p>The result, using <code>-Ccompiler=cranelift</code> or <code>-Ccompiler=winch</code> or <code>--target=pulley64</code> is consistently the same: <code>0</code>. However, when invoked via:</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>wasmi_cli<span class="w"> </span>--invoke<span class="w"> </span><span class="s2">" "</span><span class="w"> </span>index.wat<span class="w"> </span><span class="m">0</span>
</code></pre></div>
<p>The result is <code>4503599627370496</code></p>
<p>Reducing a bit further, it seems the the problem is the ordering of the return values from <code>i64.mul_wide_s</code></p>
<p>Consider:</p>
<div class="codehilite" data-code-language="WebAssembly"><pre><span></span><code><span class="p">(</span><span class="k">module</span>
  <span class="p">(</span><span class="k">type</span> <span class="cm">(;0;)</span> <span class="p">(</span><span class="k">func</span> <span class="p">(</span><span class="k">param</span> <span class="kt">i32</span><span class="p">)</span> <span class="p">(</span><span class="k">result</span> <span class="kt">i64</span><span class="p">)))</span>
  <span class="p">(</span><span class="k">global</span> <span class="cm">(;0;)</span> <span class="p">(</span><span class="k">mut</span> <span class="kt">i32</span><span class="p">)</span> <span class="nb">i32.const</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">(</span><span class="k">global</span> <span class="cm">(;1;)</span> <span class="p">(</span><span class="k">mut</span> <span class="kt">i64</span><span class="p">)</span> <span class="nb">i64.const</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">(</span><span class="k">global</span> <span class="cm">(;2;)</span> <span class="p">(</span><span class="k">mut</span> <span class="kt">i32</span><span class="p">)</span> <span class="nb">i32.const</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">(</span><span class="k">export</span> <span class="s2">" "</span> <span class="p">(</span><span class="k">func</span> <span class="mi">0</span><span class="p">))</span>
  <span class="p">(</span><span class="k">func</span> <span class="cm">(;0;)</span> <span class="p">(</span><span class="k">type</span> <span class="mi">0</span><span class="p">)</span> <span class="p">(</span><span class="k">param</span> <span class="kt">i32</span><span class="p">)</span> <span class="p">(</span><span class="k">result</span> <span class="kt">i64</span><span class="p">)</span>
    <span class="nb">i32.const</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="c1">;; label = @1</span>
      <span class="nb">unreachable</span>
    <span class="k">end</span>
    <span class="nb">global.get</span> <span class="mi">2</span>
    <span class="nb">global.set</span> <span class="mi">2</span>
    <span class="nb">i64.const</span> <span class="mf">288230376151711744</span>
    <span class="nb">i64.const</span> <span class="mf">288230376151711744</span>
    <span class="nb">i64.mul</span><span class="err">_wide_s</span>
    <span class="nb">drop</span>
  <span class="p">)</span>
<span class="p">)</span>
</code></pre></div>
<p>The result for Wasmtime (using any of the compilers or pulley) is: <code>0</code>.<br>
Using <code>wasmi</code>  the result is: <code>4503599627370496</code></p>
<p>Which clearly suggests that there's a discrepancy on how the results of <code>i64.mul_wide_s</code>  are handled in <code>wasmi</code>. According to the consistent results in Wasmtime, I'm tempted to suggest that this probably a bug in <code>wasmi</code>  itself, however, I'm opening this issue here first for confirmation. </p>
<p>cc @alexcrichton @Robbepop <br>
</p>
</blockquote>



<a name="506458280"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310418%20differential%20fuzzbug%3A%20Wide%20arithm.../near/506458280" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310418.20differential.20fuzzbug.3A.20Wide.20arithm.2E.2E.2E.html#506458280">(Mar 18 2025 at 11:50)</a>:</h4>
<p>Robbepop edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/10418#issuecomment-2732915918">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10418">issue #10418</a>:</p>
<blockquote>
<p>Since the <code>wide-arithmetic</code> support in Wasmi is fairly new it likely is a bug in Wasmi. Going to inspect it as soon as I find time.<br>
From my understanding the <code>drop</code> instructions drops the high 64-bits of the result.<br>
<code>288230376151711744^2 ~= 8,30767497e34</code> and <code>8,30767497e34 / 2^64 = 4503599627370496</code></p>
</blockquote>



<a name="506458297"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310418%20differential%20fuzzbug%3A%20Wide%20arithm.../near/506458297" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310418.20differential.20fuzzbug.3A.20Wide.20arithm.2E.2E.2E.html#506458297">(Mar 18 2025 at 11:51)</a>:</h4>
<p>Robbepop edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/10418#issuecomment-2732915918">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10418">issue #10418</a>:</p>
<blockquote>
<p>Since the <code>wide-arithmetic</code> support in Wasmi is fairly new it likely is a bug in Wasmi. Going to inspect it as soon as I find time.</p>
<p>From my understanding the <code>drop</code> instructions drops the high 64-bits of the result.<br>
<code>288230376151711744^2 ~= 8,30767497e34</code> and <code>8,30767497e34 / 2^64 = 4503599627370496</code></p>
</blockquote>



<a name="506496396"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310418%20differential%20fuzzbug%3A%20Wide%20arithm.../near/506496396" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310418.20differential.20fuzzbug.3A.20Wide.20arithm.2E.2E.2E.html#506496396">(Mar 18 2025 at 14:28)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/10418#issuecomment-2733460521">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10418">issue #10418</a>:</p>
<blockquote>
<p>@Robbepop this program:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">288230376151711744_</span><span class="k">i64</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">288230376151711744_</span><span class="k">i64</span><span class="p">;</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{a} * {b} = {}"</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">wrapping_mul</span><span class="p">(</span><span class="n">b</span><span class="p">));</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{a:#x} * {b:#x} = {:#x}"</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">wrapping_mul</span><span class="p">(</span><span class="n">b</span><span class="p">));</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">i128</span><span class="p">::</span><span class="n">from</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">i128</span><span class="p">::</span><span class="n">from</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{a} * {b} = {}"</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">wrapping_mul</span><span class="p">(</span><span class="n">b</span><span class="p">));</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"{a:#x} * {b:#x} = {:#x}"</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">wrapping_mul</span><span class="p">(</span><span class="n">b</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div>
<p>prints</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="mi">288230376151711744</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">288230376151711744</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="mh">0x400000000000000</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mh">0x400000000000000</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x0</span>
<span class="mi">288230376151711744</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">288230376151711744</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">83076749736557242056487941267521536</span>
<span class="mh">0x400000000000000</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mh">0x400000000000000</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x100000000000000000000000000000</span>
</code></pre></div>
<p>so I think it's expected that the low bits are all zero?</p>
</blockquote>



<a name="506500822"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310418%20differential%20fuzzbug%3A%20Wide%20arithm.../near/506500822" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310418.20differential.20fuzzbug.3A.20Wide.20arithm.2E.2E.2E.html#506500822">(Mar 18 2025 at 14:45)</a>:</h4>
<p>Robbepop <a href="https://github.com/bytecodealliance/wasmtime/issues/10418#issuecomment-2733517619">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10418">issue #10418</a>:</p>
<blockquote>
<p>@alexcrichton indeed, it seems that Wasmi const-eval for <code>wide-arithmetic</code> is off here. Sorry about that!</p>
</blockquote>



<a name="506507043"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310418%20differential%20fuzzbug%3A%20Wide%20arithm.../near/506507043" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310418.20differential.20fuzzbug.3A.20Wide.20arithm.2E.2E.2E.html#506507043">(Mar 18 2025 at 15:07)</a>:</h4>
<p>alexcrichton closed <a href="https://github.com/bytecodealliance/wasmtime/issues/10418">issue #10418</a>:</p>
<blockquote>
<p>For the following program:</p>
<div class="codehilite" data-code-language="WebAssembly"><pre><span></span><code><span class="p">(</span><span class="k">module</span>
  <span class="p">(</span><span class="k">type</span> <span class="cm">(;0;)</span> <span class="p">(</span><span class="k">func</span> <span class="p">(</span><span class="k">param</span> <span class="kt">i32</span><span class="p">)</span> <span class="p">(</span><span class="k">result</span> <span class="kt">i64</span><span class="p">)))</span>
  <span class="p">(</span><span class="k">global</span> <span class="cm">(;0;)</span> <span class="p">(</span><span class="k">mut</span> <span class="kt">i32</span><span class="p">)</span> <span class="nb">i32.const</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">(</span><span class="k">global</span> <span class="cm">(;1;)</span> <span class="p">(</span><span class="k">mut</span> <span class="kt">i64</span><span class="p">)</span> <span class="nb">i64.const</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">(</span><span class="k">global</span> <span class="cm">(;2;)</span> <span class="p">(</span><span class="k">mut</span> <span class="kt">i32</span><span class="p">)</span> <span class="nb">i32.const</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">(</span><span class="k">export</span> <span class="s2">" "</span> <span class="p">(</span><span class="k">func</span> <span class="mi">0</span><span class="p">))</span>
  <span class="p">(</span><span class="k">func</span> <span class="cm">(;0;)</span> <span class="p">(</span><span class="k">type</span> <span class="mi">0</span><span class="p">)</span> <span class="p">(</span><span class="k">param</span> <span class="kt">i32</span><span class="p">)</span> <span class="p">(</span><span class="k">result</span> <span class="kt">i64</span><span class="p">)</span>
    <span class="nb">i32.const</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="c1">;; label = @1</span>
      <span class="nb">unreachable</span>
    <span class="k">end</span>
    <span class="nb">global.get</span> <span class="mi">2</span>
    <span class="nb">global.set</span> <span class="mi">2</span>
    <span class="nb">i64.const</span> <span class="mf">288230376151711744</span>
    <span class="nb">i64.const</span> <span class="mf">288230376151711744</span>
    <span class="nb">i64.mul</span><span class="err">_wide_s</span>
    <span class="nb">i32.wrap_i64</span>
    <span class="nb">global.get</span> <span class="mi">0</span>
    <span class="nb">i32.xor</span>
    <span class="nb">global.set</span> <span class="mi">0</span>
    <span class="nb">global.get</span> <span class="mi">1</span>
    <span class="nb">i64.xor</span>
  <span class="p">)</span>
<span class="p">)</span>
</code></pre></div>
<p>When invoked via:</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>cargo<span class="w"> </span>run<span class="w"> </span>--<span class="w"> </span>run<span class="w"> </span>-Wwide-arithmetic<span class="o">=</span>y<span class="w"> </span>--invoke<span class="w"> </span><span class="s2">" "</span><span class="w"> </span>index.wat<span class="w"> </span><span class="m">0</span>
</code></pre></div>
<p>The result, using <code>-Ccompiler=cranelift</code> or <code>-Ccompiler=winch</code> or <code>--target=pulley64</code> is consistently the same: <code>0</code>. However, when invoked via:</p>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>wasmi_cli<span class="w"> </span>--invoke<span class="w"> </span><span class="s2">" "</span><span class="w"> </span>index.wat<span class="w"> </span><span class="m">0</span>
</code></pre></div>
<p>The result is <code>4503599627370496</code></p>
<p>Reducing a bit further, it seems the the problem is the ordering of the return values from <code>i64.mul_wide_s</code></p>
<p>Consider:</p>
<div class="codehilite" data-code-language="WebAssembly"><pre><span></span><code><span class="p">(</span><span class="k">module</span>
  <span class="p">(</span><span class="k">type</span> <span class="cm">(;0;)</span> <span class="p">(</span><span class="k">func</span> <span class="p">(</span><span class="k">param</span> <span class="kt">i32</span><span class="p">)</span> <span class="p">(</span><span class="k">result</span> <span class="kt">i64</span><span class="p">)))</span>
  <span class="p">(</span><span class="k">global</span> <span class="cm">(;0;)</span> <span class="p">(</span><span class="k">mut</span> <span class="kt">i32</span><span class="p">)</span> <span class="nb">i32.const</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">(</span><span class="k">global</span> <span class="cm">(;1;)</span> <span class="p">(</span><span class="k">mut</span> <span class="kt">i64</span><span class="p">)</span> <span class="nb">i64.const</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">(</span><span class="k">global</span> <span class="cm">(;2;)</span> <span class="p">(</span><span class="k">mut</span> <span class="kt">i32</span><span class="p">)</span> <span class="nb">i32.const</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">(</span><span class="k">export</span> <span class="s2">" "</span> <span class="p">(</span><span class="k">func</span> <span class="mi">0</span><span class="p">))</span>
  <span class="p">(</span><span class="k">func</span> <span class="cm">(;0;)</span> <span class="p">(</span><span class="k">type</span> <span class="mi">0</span><span class="p">)</span> <span class="p">(</span><span class="k">param</span> <span class="kt">i32</span><span class="p">)</span> <span class="p">(</span><span class="k">result</span> <span class="kt">i64</span><span class="p">)</span>
    <span class="nb">i32.const</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="c1">;; label = @1</span>
      <span class="nb">unreachable</span>
    <span class="k">end</span>
    <span class="nb">global.get</span> <span class="mi">2</span>
    <span class="nb">global.set</span> <span class="mi">2</span>
    <span class="nb">i64.const</span> <span class="mf">288230376151711744</span>
    <span class="nb">i64.const</span> <span class="mf">288230376151711744</span>
    <span class="nb">i64.mul</span><span class="err">_wide_s</span>
    <span class="nb">drop</span>
  <span class="p">)</span>
<span class="p">)</span>
</code></pre></div>
<p>The result for Wasmtime (using any of the compilers or pulley) is: <code>0</code>.<br>
Using <code>wasmi</code>  the result is: <code>4503599627370496</code></p>
<p>Which clearly suggests that there's a discrepancy on how the results of <code>i64.mul_wide_s</code>  are handled in <code>wasmi</code>. According to the consistent results in Wasmtime, I'm tempted to suggest that this probably a bug in <code>wasmi</code>  itself, however, I'm opening this issue here first for confirmation. </p>
<p>cc @alexcrichton @Robbepop <br>
</p>
</blockquote>



<a name="506903139"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310418%20differential%20fuzzbug%3A%20Wide%20arithm.../near/506903139" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310418.20differential.20fuzzbug.3A.20Wide.20arithm.2E.2E.2E.html#506903139">(Mar 20 2025 at 08:09)</a>:</h4>
<p>Robbepop <a href="https://github.com/bytecodealliance/wasmtime/issues/10418#issuecomment-2739519584">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10418">issue #10418</a>:</p>
<blockquote>
<p>@saulecabrera @alexcrichton The bug has been fixed in Wasmi yesterday and today I released Wasmi v0.42.1 that includes this fix. So technically Wasmtime fuzzing could use v0.42.1 again with <code>wide-arithmetic</code> enabled if you feel like it makes sense. Not sure so I didn't create a PR, yet.</p>
</blockquote>



<a name="506903251"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310418%20differential%20fuzzbug%3A%20Wide%20arithm.../near/506903251" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310418.20differential.20fuzzbug.3A.20Wide.20arithm.2E.2E.2E.html#506903251">(Mar 20 2025 at 08:09)</a>:</h4>
<p>Robbepop edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/10418#issuecomment-2739519584">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10418">issue #10418</a>:</p>
<blockquote>
<p>@saulecabrera @alexcrichton The bug has been fixed in Wasmi yesterday and today I released Wasmi v0.42.1 that includes this fix. So technically Wasmtime fuzzing could use v0.42.1 again with <code>wide-arithmetic</code> enabled if you feel like it makes sense. Not sure so I didn't create a PR, yet.</p>
<p>The fix was trivial: <a href="https://github.com/wasmi-labs/wasmi/pull/1397">https://github.com/wasmi-labs/wasmi/pull/1397</a></p>
</blockquote>



<a name="506996917"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310418%20differential%20fuzzbug%3A%20Wide%20arithm.../near/506996917" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310418.20differential.20fuzzbug.3A.20Wide.20arithm.2E.2E.2E.html#506996917">(Mar 20 2025 at 14:55)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/10418#issuecomment-2740749284">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10418">issue #10418</a>:</p>
<blockquote>
<p>Thanks! Opened up <a href="https://github.com/bytecodealliance/wasmtime/pull/10430">https://github.com/bytecodealliance/wasmtime/pull/10430</a> to re-enable</p>
</blockquote>



<hr><p>Last updated: Feb 22 2026 at 11:05 UTC</p>
</html>
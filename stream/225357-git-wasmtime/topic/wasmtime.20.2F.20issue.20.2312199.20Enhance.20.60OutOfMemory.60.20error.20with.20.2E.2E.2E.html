<html>
<head><meta charset="utf-8"><title>wasmtime / issue #12199 Enhance `OutOfMemory` error with ... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312199.20Enhance.20.60OutOfMemory.60.20error.20with.20.2E.2E.2E.html">wasmtime / issue #12199 Enhance `OutOfMemory` error with ...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="565058269"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312199%20Enhance%20%60OutOfMemory%60%20error%20with%20.../near/565058269" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312199.20Enhance.20.60OutOfMemory.60.20error.20with.20.2E.2E.2E.html#565058269">(Dec 22 2025 at 19:17)</a>:</h4>
<p>alexcrichton opened <a href="https://github.com/bytecodealliance/wasmtime/issues/12199">issue #12199</a>:</p>
<blockquote>
<p>There's some more discussion <a href="https://github.com/bytecodealliance/wasmtime/pull/12163#discussion_r2636121426">here</a>, but I personally think we should strive to extend this error with the contextual number of bytes that were attempted to be allocated. Implementation-wise this will be tricky, however, so it'll require deliberate design.</p>
</blockquote>



<a name="565058270"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312199%20Enhance%20%60OutOfMemory%60%20error%20with%20.../near/565058270" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312199.20Enhance.20.60OutOfMemory.60.20error.20with.20.2E.2E.2E.html#565058270">(Dec 22 2025 at 19:17)</a>:</h4>
<p><a href="https://github.com/alexcrichton">alexcrichton</a> added the wasmtime:api label to <a href="https://github.com/bytecodealliance/wasmtime/issues/12199">Issue #12199</a>.</p>



<a name="567833794"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312199%20Enhance%20%60OutOfMemory%60%20error%20with%20.../near/567833794" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312199.20Enhance.20.60OutOfMemory.60.20error.20with.20.2E.2E.2E.html#567833794">(Jan 13 2026 at 18:29)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/issues/12199#issuecomment-3745778258">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12199">issue #12199</a>:</p>
<blockquote>
<p>How does this sound?</p>
<ul>
<li>Bitpack the size and layout into the <code>&amp;OutOfMemory</code> pointer.</li>
<li>Add a <code>pub fn OutOfMemory::layout(&amp;self) -&gt; Layout</code> method that reads the bitpacked data.</li>
<li>Do _not_ have a public ctor for <code>OutOfMemory</code> (and I guess also remove the clone/copy derives?)</li>
<li>Instead have <code>pub fn Error::out_of_memory(layout: Layout) -&gt; Error</code>, which does the bitpacking and wrapping up into an <code>Error</code>.</li>
</ul>
<p>So with this setup, you are generally only ever dealing with <code>&amp;OutOfMemory</code> or an <code>Error</code> wrapping an <code>OutOfMemory</code>, but not an owned <code>OutOfMemory</code> that isn't inside an <code>Error</code>. So you can still ask things like <code>error.is&lt;OutOfMemory&gt;()</code> and do <code>error.downcast_ref::&lt;OutOfMemory&gt;().unwrap().layout()</code> and all that, which is / will be (probably?) the most common uses of <code>OutOfMemory</code>.</p>
<p>However, the one tricky thing is that <code>error.downcast::&lt;OutOfMemory&gt;().unwrap()</code> will give you an owned <code>OutOfMemory</code>, but because it isn't a pointer into an <code>Error</code>, you will lose the bitpacked layout info, and so <code>OutOfMemory::layout</code> will need to return an option or a zero-sized layout or something. Perhaps even worse is that we have no guarantee that taking a reference to an owned <code>OutOfMemory</code> will produce a pointer that won't "accidentally" have non-zero data in our bitpacked areas, so we could just return arbitrary (and incorrect) layouts in this case.</p>
<p>FWIW, we could also avoid this one last edge case by moving the <code>layout</code> method to <code>Error</code>, so you can only get the layout info from an <code>Error</code> that wraps an <code>OutOfMemory</code> (presumably; we'd still have an option for the non-OOM <code>Error</code> case, but we wouldn't have to worry about arbitrary/incorrect layout data). This is probably the way to go, despite the API being a bit funkier...</p>
</blockquote>



<a name="567834911"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312199%20Enhance%20%60OutOfMemory%60%20error%20with%20.../near/567834911" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312199.20Enhance.20.60OutOfMemory.60.20error.20with.20.2E.2E.2E.html#567834911">(Jan 13 2026 at 18:36)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/issues/12199#issuecomment-3745801801">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12199">issue #12199</a>:</p>
<blockquote>
<blockquote>
<p>However, the one tricky thing is that <code>error.downcast::&lt;OutOfMemory&gt;().unwrap()</code> will give you an owned <code>OutOfMemory</code></p>
</blockquote>
<p>We could also just make <code>error.downcast::&lt;OutOfMemory&gt;()</code> always fail too. This might actually be the best option, since that way we can use the bitpacked layout information inside the display and debug impls for <code>OutOfMemory</code>, which having the layout accessors on <code>Error</code> wouldn't allow.</p>
</blockquote>



<a name="567835436"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312199%20Enhance%20%60OutOfMemory%60%20error%20with%20.../near/567835436" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312199.20Enhance.20.60OutOfMemory.60.20error.20with.20.2E.2E.2E.html#567835436">(Jan 13 2026 at 18:39)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/12199#issuecomment-3745814072">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12199">issue #12199</a>:</p>
<blockquote>
<p>Wouldn't we want a public constructor of <code>OutOfMemory</code> for collection-based APIs which'd return <code>Result&lt;T, OutOfMemory&gt;</code>?</p>
</blockquote>



<a name="567835775"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312199%20Enhance%20%60OutOfMemory%60%20error%20with%20.../near/567835775" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312199.20Enhance.20.60OutOfMemory.60.20error.20with.20.2E.2E.2E.html#567835775">(Jan 13 2026 at 18:41)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/issues/12199#issuecomment-3745823899">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12199">issue #12199</a>:</p>
<blockquote>
<blockquote>
<p>Wouldn't we want a public constructor of <code>OutOfMemory</code> for collection-based APIs which'd return <code>Result&lt;T, OutOfMemory&gt;</code>?</p>
</blockquote>
<p>Yeah I just ran into this as I started investigating further.</p>
<p>New idea: make <code>OutOfMemory</code> a newtype wrapper around <code>Error</code> where the wrapped <code>Error</code> is guaranteed to be bitpacked with layout info and have a discriminant appropriately set to mark that it is not a boxed dyn error (as it already does today).</p>
</blockquote>



<a name="567836628"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312199%20Enhance%20%60OutOfMemory%60%20error%20with%20.../near/567836628" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312199.20Enhance.20.60OutOfMemory.60.20error.20with.20.2E.2E.2E.html#567836628">(Jan 13 2026 at 18:46)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/12199#issuecomment-3745844730">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12199">issue #12199</a>:</p>
<blockquote>
<p>I may not quite be following something, or I think I'm missing something? I would expect <code>OutOfMemory</code> to contain <code>NonZero&lt;usize&gt;</code> and then <code>Error</code>'s internal <code>NonNull&lt;T&gt;</code> which it contains would be transmuted to <code>NonZero&lt;usize&gt;</code> for getting <code>&amp;OutOfMemory</code> or something like that. I also don't think we can deal with a full <code>Layout</code> (size + align) and can only deal with the size for now, I don't know how to bitpack the alignment into the payload.</p>
</blockquote>



<a name="567838425"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312199%20Enhance%20%60OutOfMemory%60%20error%20with%20.../near/567838425" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312199.20Enhance.20.60OutOfMemory.60.20error.20with.20.2E.2E.2E.html#567838425">(Jan 13 2026 at 18:58)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/issues/12199#issuecomment-3745897436">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12199">issue #12199</a>:</p>
<blockquote>
<blockquote>
<p>I would expect <code>OutOfMemory</code> to contain <code>NonZero&lt;usize&gt;</code> and then <code>Error</code>'s internal <code>NonNull&lt;T&gt;</code> which it contains would be transmuted to <code>NonZero&lt;usize&gt;</code> for getting <code>&amp;OutOfMemory</code> or something like that.</p>
</blockquote>
<p>Yeah, this is basically equivalent to my newtype idea.</p>
<blockquote>
<p>I also don't think we can deal with a full <code>Layout</code> (size + align) and can only deal with the size for now, I don't know how to bitpack the alignment into the payload.</p>
</blockquote>
<p>I think you are correct. I was thinking that, because the alloc size is limited to <code>isize::MAX</code> we had half the bits for the layout, but we have half the <code>usize</code> <em>range</em> which is only one bit. Mixing up domains.</p>
</blockquote>



<a name="567839256"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312199%20Enhance%20%60OutOfMemory%60%20error%20with%20.../near/567839256" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312199.20Enhance.20.60OutOfMemory.60.20error.20with.20.2E.2E.2E.html#567839256">(Jan 13 2026 at 19:02)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/12199#issuecomment-3745924403">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12199">issue #12199</a>:</p>
<blockquote>
<p>On second thought -- I don't think that <code>&amp;NonNull&lt;T&gt;</code> can be safely coerced to <code>&amp;NonZero&lt;usize&gt;</code>. What with provenance and CHERI I suspect that's an explicitly unsupported operation, and that might sink this entire endeavour</p>
</blockquote>



<a name="567839485"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312199%20Enhance%20%60OutOfMemory%60%20error%20with%20.../near/567839485" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312199.20Enhance.20.60OutOfMemory.60.20error.20with.20.2E.2E.2E.html#567839485">(Jan 13 2026 at 19:04)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/issues/12199#issuecomment-3745933623">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12199">issue #12199</a>:</p>
<blockquote>
<p>We can have <code>OutOfMemory</code> wrap a <code>NonNull&lt;()&gt;</code> or whatever and bit pack in the address</p>
</blockquote>



<a name="567839611"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312199%20Enhance%20%60OutOfMemory%60%20error%20with%20.../near/567839611" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312199.20Enhance.20.60OutOfMemory.60.20error.20with.20.2E.2E.2E.html#567839611">(Jan 13 2026 at 19:04)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/issues/12199#issuecomment-3745938492">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12199">issue #12199</a>:</p>
<blockquote>
<p>(Or be a newtype of <code>Error</code>, as originally suggested)</p>
</blockquote>



<a name="567840178"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312199%20Enhance%20%60OutOfMemory%60%20error%20with%20.../near/567840178" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312199.20Enhance.20.60OutOfMemory.60.20error.20with.20.2E.2E.2E.html#567840178">(Jan 13 2026 at 19:08)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/12199#issuecomment-3745964849">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12199">issue #12199</a>:</p>
<blockquote>
<p>Good point, and ok yeah that seems reasonable (<code>struct OutOfMemory(Error)</code>) with some extra guarantees perhaps or something like that<br>
</p>
</blockquote>



<a name="568074051"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312199%20Enhance%20%60OutOfMemory%60%20error%20with%20.../near/568074051" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312199.20Enhance.20.60OutOfMemory.60.20error.20with.20.2E.2E.2E.html#568074051">(Jan 14 2026 at 20:27)</a>:</h4>
<p>fitzgen closed <a href="https://github.com/bytecodealliance/wasmtime/issues/12199">issue #12199</a>:</p>
<blockquote>
<p>There's some more discussion <a href="https://github.com/bytecodealliance/wasmtime/pull/12163#discussion_r2636121426">here</a>, but I personally think we should strive to extend this error with the contextual number of bytes that were attempted to be allocated. Implementation-wise this will be tricky, however, so it'll require deliberate design.</p>
</blockquote>



<hr><p>Last updated: Feb 22 2026 at 11:05 UTC</p>
</html>
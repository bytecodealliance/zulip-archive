<html>
<head><meta charset="utf-8"><title>wasmtime / issue #10167 error: error calling default export · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310167.20error.3A.20error.20calling.20default.20export.html">wasmtime / issue #10167 error: error calling default export</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="497226632"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310167%20error%3A%20error%20calling%20default%20export/near/497226632" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310167.20error.3A.20error.20calling.20default.20export.html#497226632">(Feb 02 2025 at 04:53)</a>:</h4>
<p><a href="https://github.com/davecramer">davecramer</a> added the bug label to <a href="https://github.com/bytecodealliance/wasmtime/issues/10167">Issue #10167</a>.</p>



<a name="497226633"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310167%20error%3A%20error%20calling%20default%20export/near/497226633" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310167.20error.3A.20error.20calling.20default.20export.html#497226633">(Feb 02 2025 at 04:53)</a>:</h4>
<p>davecramer opened <a href="https://github.com/bytecodealliance/wasmtime/issues/10167">issue #10167</a>:</p>
<blockquote>
<p>Thanks for filing a bug report! Please fill out the TODOs below.</p>
<p><strong>Note: if you want to report a security issue, please read our <a href="https://bytecodealliance.org/security">security policy</a>!</strong></p>
<h3>Test Case</h3>
<p>With the following python</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">talk</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
<span class="w">    </span><span class="nc">return</span><span class="w"> </span><span class="s">"Talk "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">message</span>


<span class="n">def</span><span class="w"> </span><span class="n">main</span><span class="p">():</span>
<span class="w">    </span><span class="nc">print</span><span class="p">(</span><span class="n">talk</span><span class="p">(</span><span class="s">"Hello World"</span><span class="p">))</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span>


<span class="k">if</span><span class="w"> </span><span class="n">__name__</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">"__main__"</span><span class="p">:</span>
<span class="w">    </span><span class="nc">main</span><span class="p">()</span>
</code></pre></div>
<p>compiled to wasm using py2wasm</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">int</span><span class="w"> </span><span class="n">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Set up our context</span>
<span class="w">  </span><span class="n">wasm_engine_t</span><span class="w"> </span><span class="o">*</span><span class="n">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasm_engine_new</span><span class="p">();</span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">engine</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">NULL</span><span class="p">);</span>
<span class="w">  </span><span class="n">wasmtime_store_t</span><span class="w"> </span><span class="o">*</span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime_store_new</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="n">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">NULL</span><span class="p">);</span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">store</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">NULL</span><span class="p">);</span>
<span class="w">  </span><span class="n">wasmtime_context_t</span><span class="w"> </span><span class="o">*</span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime_store_context</span><span class="p">(</span><span class="n">store</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Create a linker with WASI functions defined</span>
<span class="w">  </span><span class="n">wasmtime_linker_t</span><span class="w"> </span><span class="o">*</span><span class="n">linker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime_linker_new</span><span class="p">(</span><span class="n">engine</span><span class="p">);</span>
<span class="w">  </span><span class="n">wasmtime_error_t</span><span class="w"> </span><span class="o">*</span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime_linker_define_wasi</span><span class="p">(</span><span class="n">linker</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">NULL</span><span class="p">)</span>
<span class="w">    </span><span class="n">exit_with_error</span><span class="p">(</span><span class="s">"failed to link wasi"</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">NULL</span><span class="p">);</span>

<span class="w">  </span><span class="n">wasm_byte_vec_t</span><span class="w"> </span><span class="n">wasm</span><span class="p">;</span>
<span class="w">  </span><span class="c1">// Load our input file to parse it next</span>
<span class="w">  </span><span class="n">FILE</span><span class="w"> </span><span class="o">*</span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fopen</span><span class="p">(</span><span class="s">"wasm/test.wasm"</span><span class="p">,</span><span class="w"> </span><span class="s">"rb"</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">file</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">"&gt; Error loading file!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="w">    </span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">fseek</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="n">L</span><span class="p">,</span><span class="w"> </span><span class="n">SEEK_END</span><span class="p">);</span>
<span class="w">  </span><span class="n">size_t</span><span class="w"> </span><span class="n">file_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ftell</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
<span class="w">  </span><span class="n">wasm_byte_vec_new_uninitialized</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wasm</span><span class="p">,</span><span class="w"> </span><span class="n">file_size</span><span class="p">);</span>
<span class="w">  </span><span class="n">fseek</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="n">L</span><span class="p">,</span><span class="w"> </span><span class="n">SEEK_SET</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fread</span><span class="p">(</span><span class="n">wasm</span><span class="p">.</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">file_size</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">file</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">"&gt; Error loading module!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="w">    </span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">fclose</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Compile our modules</span>
<span class="w">  </span><span class="n">wasmtime_module_t</span><span class="w"> </span><span class="o">*</span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NULL</span><span class="p">;</span>
<span class="w">  </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime_module_new</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">wasm</span><span class="p">.</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">wasm</span><span class="p">.</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">module</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">module</span><span class="p">)</span>
<span class="w">    </span><span class="n">exit_with_error</span><span class="p">(</span><span class="s">"failed to compile module"</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">NULL</span><span class="p">);</span>
<span class="w">  </span><span class="n">wasm_byte_vec_delete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wasm</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Instantiate wasi</span>
<span class="w">  </span><span class="n">wasi_config_t</span><span class="w"> </span><span class="o">*</span><span class="n">wasi_config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasi_config_new</span><span class="p">();</span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">wasi_config</span><span class="p">);</span>
<span class="w">  </span><span class="n">wasi_config_inherit_argv</span><span class="p">(</span><span class="n">wasi_config</span><span class="p">);</span>
<span class="w">  </span><span class="n">wasi_config_inherit_env</span><span class="p">(</span><span class="n">wasi_config</span><span class="p">);</span>
<span class="w">  </span><span class="n">wasi_config_inherit_stdin</span><span class="p">(</span><span class="n">wasi_config</span><span class="p">);</span>
<span class="w">  </span><span class="n">wasi_config_inherit_stdout</span><span class="p">(</span><span class="n">wasi_config</span><span class="p">);</span>
<span class="w">  </span><span class="n">wasi_config_inherit_stderr</span><span class="p">(</span><span class="n">wasi_config</span><span class="p">);</span>
<span class="w">  </span><span class="n">wasm_trap_t</span><span class="w"> </span><span class="o">*</span><span class="n">trap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NULL</span><span class="p">;</span>
<span class="w">  </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime_context_set_wasi</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">wasi_config</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">NULL</span><span class="p">)</span>
<span class="w">    </span><span class="n">exit_with_error</span><span class="p">(</span><span class="s">"failed to instantiate WASI"</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">NULL</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Instantiate the module</span>
<span class="w">  </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime_linker_module</span><span class="p">(</span><span class="n">linker</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="s">""</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">module</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">NULL</span><span class="p">)</span>
<span class="w">    </span><span class="n">exit_with_error</span><span class="p">(</span><span class="s">"failed to instantiate module"</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">NULL</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Run it.</span>
<span class="w">  </span><span class="n">wasmtime_func_t</span><span class="w"> </span><span class="n">func</span><span class="p">;</span>
<span class="w">  </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime_linker_get_default</span><span class="p">(</span><span class="n">linker</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="s">"main"</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">func</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">NULL</span><span class="p">)</span>
<span class="w">    </span><span class="n">exit_with_error</span><span class="p">(</span><span class="s">"failed to locate default export for module"</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">NULL</span><span class="p">);</span>

<span class="w">  </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime_func_call</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">func</span><span class="p">,</span><span class="w"> </span><span class="n">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">trap</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">NULL</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">trap</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">NULL</span><span class="p">){</span>
<span class="w">    </span><span class="n">exit_with_error</span><span class="p">(</span><span class="s">"error calling default export"</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">trap</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="c1">// Clean up after ourselves at this point</span>
<span class="w">  </span><span class="n">wasmtime_module_delete</span><span class="p">(</span><span class="n">module</span><span class="p">);</span>
<span class="w">  </span><span class="n">wasmtime_store_delete</span><span class="p">(</span><span class="n">store</span><span class="p">);</span>
<span class="w">  </span><span class="n">wasm_engine_delete</span><span class="p">(</span><span class="n">engine</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n">void</span><span class="w"> </span><span class="n">exit_with_error</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">wasmtime_error_t</span><span class="w"> </span><span class="o">*</span><span class="n">error</span><span class="p">,</span>
<span class="w">                            </span><span class="n">wasm_trap_t</span><span class="w"> </span><span class="o">*</span><span class="n">trap</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">"error: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p">);</span>
<span class="w">  </span><span class="n">wasm_byte_vec_t</span><span class="w"> </span><span class="n">error_message</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">wasmtime_error_message</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">error_message</span><span class="p">);</span>
<span class="w">    </span><span class="n">wasmtime_error_delete</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">wasm_trap_message</span><span class="p">(</span><span class="n">trap</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">error_message</span><span class="p">);</span>
<span class="w">    </span><span class="n">wasm_trap_delete</span><span class="p">(</span><span class="n">trap</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">"%.*s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">int</span><span class="p">)</span><span class="n">error_message</span><span class="p">.</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">error_message</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
<span class="w">  </span><span class="n">wasm_byte_vec_delete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">error_message</span><span class="p">);</span>
<span class="w">  </span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>TODO: upload Wasm file here<br>
I get the error </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Talk</span><span class="w"> </span><span class="n">Hello</span><span class="w"> </span><span class="n">World</span>
<span class="n">error</span><span class="p">:</span><span class="w"> </span><span class="nc">error</span><span class="w"> </span><span class="n">calling</span><span class="w"> </span><span class="n">default</span><span class="w"> </span><span class="n">export</span>
<span class="n">error</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="n">executing</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">wasm</span><span class="w"> </span><span class="n">backtrace</span><span class="p">:</span>
<span class="w">    </span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="mh">0x32a019</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">__wasi_proc_exit</span>
<span class="w">    </span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="mh">0x3286df</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">_Exit</span>
<span class="w">    </span><span class="mi">2</span><span class="p">:</span><span class="w"> </span><span class="mh">0x33301f</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">exit</span>
<span class="w">    </span><span class="mi">3</span><span class="p">:</span><span class="w"> </span><span class="mh">0x16698d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">Py_Exit</span>
<span class="w">    </span><span class="mi">4</span><span class="p">:</span><span class="w"> </span><span class="mh">0x34b2dc</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">main</span>
<span class="w">    </span><span class="mi">5</span><span class="p">:</span><span class="w"> </span><span class="mh">0x329c22</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">__main_void</span>
<span class="w">    </span><span class="mi">6</span><span class="p">:</span><span class="w"> </span><span class="mh">0x5002</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">_start</span>
<span class="n">note</span><span class="p">:</span><span class="w"> </span><span class="nc">using</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="err">`</span><span class="n">WASMTIME_BACKTRACE_DETAILS</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="n">show</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">debugging</span><span class="w"> </span><span class="n">information</span>

<span class="n">Caused</span><span class="w"> </span><span class="n">by</span><span class="p">:</span>
<span class="w">    </span><span class="nc">Exited</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="n">exit</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="mi">0</span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: <br>
29.0.0</p>
<p>Operating system: macos Sonoma 14.7.2</p>
<p>Architecture: ARM</p>
</blockquote>



<a name="497226688"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310167%20error%3A%20error%20calling%20default%20export/near/497226688" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310167.20error.3A.20error.20calling.20default.20export.html#497226688">(Feb 02 2025 at 04:54)</a>:</h4>
<p>davecramer edited <a href="https://github.com/bytecodealliance/wasmtime/issues/10167">issue #10167</a>:</p>
<blockquote>
<h3>Test Case</h3>
<p>With the following python</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">talk</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
<span class="w">    </span><span class="nc">return</span><span class="w"> </span><span class="s">"Talk "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">message</span>


<span class="n">def</span><span class="w"> </span><span class="n">main</span><span class="p">():</span>
<span class="w">    </span><span class="nc">print</span><span class="p">(</span><span class="n">talk</span><span class="p">(</span><span class="s">"Hello World"</span><span class="p">))</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span>


<span class="k">if</span><span class="w"> </span><span class="n">__name__</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">"__main__"</span><span class="p">:</span>
<span class="w">    </span><span class="nc">main</span><span class="p">()</span>
</code></pre></div>
<p>compiled to wasm using py2wasm</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">int</span><span class="w"> </span><span class="n">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Set up our context</span>
<span class="w">  </span><span class="n">wasm_engine_t</span><span class="w"> </span><span class="o">*</span><span class="n">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasm_engine_new</span><span class="p">();</span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">engine</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">NULL</span><span class="p">);</span>
<span class="w">  </span><span class="n">wasmtime_store_t</span><span class="w"> </span><span class="o">*</span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime_store_new</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="n">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">NULL</span><span class="p">);</span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">store</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">NULL</span><span class="p">);</span>
<span class="w">  </span><span class="n">wasmtime_context_t</span><span class="w"> </span><span class="o">*</span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime_store_context</span><span class="p">(</span><span class="n">store</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Create a linker with WASI functions defined</span>
<span class="w">  </span><span class="n">wasmtime_linker_t</span><span class="w"> </span><span class="o">*</span><span class="n">linker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime_linker_new</span><span class="p">(</span><span class="n">engine</span><span class="p">);</span>
<span class="w">  </span><span class="n">wasmtime_error_t</span><span class="w"> </span><span class="o">*</span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime_linker_define_wasi</span><span class="p">(</span><span class="n">linker</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">NULL</span><span class="p">)</span>
<span class="w">    </span><span class="n">exit_with_error</span><span class="p">(</span><span class="s">"failed to link wasi"</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">NULL</span><span class="p">);</span>

<span class="w">  </span><span class="n">wasm_byte_vec_t</span><span class="w"> </span><span class="n">wasm</span><span class="p">;</span>
<span class="w">  </span><span class="c1">// Load our input file to parse it next</span>
<span class="w">  </span><span class="n">FILE</span><span class="w"> </span><span class="o">*</span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fopen</span><span class="p">(</span><span class="s">"wasm/test.wasm"</span><span class="p">,</span><span class="w"> </span><span class="s">"rb"</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">file</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">"&gt; Error loading file!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="w">    </span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">fseek</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="n">L</span><span class="p">,</span><span class="w"> </span><span class="n">SEEK_END</span><span class="p">);</span>
<span class="w">  </span><span class="n">size_t</span><span class="w"> </span><span class="n">file_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ftell</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
<span class="w">  </span><span class="n">wasm_byte_vec_new_uninitialized</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wasm</span><span class="p">,</span><span class="w"> </span><span class="n">file_size</span><span class="p">);</span>
<span class="w">  </span><span class="n">fseek</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="n">L</span><span class="p">,</span><span class="w"> </span><span class="n">SEEK_SET</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fread</span><span class="p">(</span><span class="n">wasm</span><span class="p">.</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">file_size</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">file</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">"&gt; Error loading module!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="w">    </span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">fclose</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Compile our modules</span>
<span class="w">  </span><span class="n">wasmtime_module_t</span><span class="w"> </span><span class="o">*</span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NULL</span><span class="p">;</span>
<span class="w">  </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime_module_new</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">wasm</span><span class="p">.</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">wasm</span><span class="p">.</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">module</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">module</span><span class="p">)</span>
<span class="w">    </span><span class="n">exit_with_error</span><span class="p">(</span><span class="s">"failed to compile module"</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">NULL</span><span class="p">);</span>
<span class="w">  </span><span class="n">wasm_byte_vec_delete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wasm</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Instantiate wasi</span>
<span class="w">  </span><span class="n">wasi_config_t</span><span class="w"> </span><span class="o">*</span><span class="n">wasi_config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasi_config_new</span><span class="p">();</span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">wasi_config</span><span class="p">);</span>
<span class="w">  </span><span class="n">wasi_config_inherit_argv</span><span class="p">(</span><span class="n">wasi_config</span><span class="p">);</span>
<span class="w">  </span><span class="n">wasi_config_inherit_env</span><span class="p">(</span><span class="n">wasi_config</span><span class="p">);</span>
<span class="w">  </span><span class="n">wasi_config_inherit_stdin</span><span class="p">(</span><span class="n">wasi_config</span><span class="p">);</span>
<span class="w">  </span><span class="n">wasi_config_inherit_stdout</span><span class="p">(</span><span class="n">wasi_config</span><span class="p">);</span>
<span class="w">  </span><span class="n">wasi_config_inherit_stderr</span><span class="p">(</span><span class="n">wasi_config</span><span class="p">);</span>
<span class="w">  </span><span class="n">wasm_trap_t</span><span class="w"> </span><span class="o">*</span><span class="n">trap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NULL</span><span class="p">;</span>
<span class="w">  </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime_context_set_wasi</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">wasi_config</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">NULL</span><span class="p">)</span>
<span class="w">    </span><span class="n">exit_with_error</span><span class="p">(</span><span class="s">"failed to instantiate WASI"</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">NULL</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Instantiate the module</span>
<span class="w">  </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime_linker_module</span><span class="p">(</span><span class="n">linker</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="s">""</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">module</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">NULL</span><span class="p">)</span>
<span class="w">    </span><span class="n">exit_with_error</span><span class="p">(</span><span class="s">"failed to instantiate module"</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">NULL</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Run it.</span>
<span class="w">  </span><span class="n">wasmtime_func_t</span><span class="w"> </span><span class="n">func</span><span class="p">;</span>
<span class="w">  </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime_linker_get_default</span><span class="p">(</span><span class="n">linker</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="s">"main"</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">func</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">NULL</span><span class="p">)</span>
<span class="w">    </span><span class="n">exit_with_error</span><span class="p">(</span><span class="s">"failed to locate default export for module"</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">NULL</span><span class="p">);</span>

<span class="w">  </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime_func_call</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">func</span><span class="p">,</span><span class="w"> </span><span class="n">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">trap</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">NULL</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">trap</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">NULL</span><span class="p">){</span>
<span class="w">    </span><span class="n">exit_with_error</span><span class="p">(</span><span class="s">"error calling default export"</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">trap</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="c1">// Clean up after ourselves at this point</span>
<span class="w">  </span><span class="n">wasmtime_module_delete</span><span class="p">(</span><span class="n">module</span><span class="p">);</span>
<span class="w">  </span><span class="n">wasmtime_store_delete</span><span class="p">(</span><span class="n">store</span><span class="p">);</span>
<span class="w">  </span><span class="n">wasm_engine_delete</span><span class="p">(</span><span class="n">engine</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n">void</span><span class="w"> </span><span class="n">exit_with_error</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">wasmtime_error_t</span><span class="w"> </span><span class="o">*</span><span class="n">error</span><span class="p">,</span>
<span class="w">                            </span><span class="n">wasm_trap_t</span><span class="w"> </span><span class="o">*</span><span class="n">trap</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">"error: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p">);</span>
<span class="w">  </span><span class="n">wasm_byte_vec_t</span><span class="w"> </span><span class="n">error_message</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">wasmtime_error_message</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">error_message</span><span class="p">);</span>
<span class="w">    </span><span class="n">wasmtime_error_delete</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">wasm_trap_message</span><span class="p">(</span><span class="n">trap</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">error_message</span><span class="p">);</span>
<span class="w">    </span><span class="n">wasm_trap_delete</span><span class="p">(</span><span class="n">trap</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">"%.*s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">int</span><span class="p">)</span><span class="n">error_message</span><span class="p">.</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">error_message</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
<span class="w">  </span><span class="n">wasm_byte_vec_delete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">error_message</span><span class="p">);</span>
<span class="w">  </span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>TODO: upload Wasm file here<br>
I get the error </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Talk</span><span class="w"> </span><span class="n">Hello</span><span class="w"> </span><span class="n">World</span>
<span class="n">error</span><span class="p">:</span><span class="w"> </span><span class="nc">error</span><span class="w"> </span><span class="n">calling</span><span class="w"> </span><span class="n">default</span><span class="w"> </span><span class="n">export</span>
<span class="n">error</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="n">executing</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">wasm</span><span class="w"> </span><span class="n">backtrace</span><span class="p">:</span>
<span class="w">    </span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="mh">0x32a019</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">__wasi_proc_exit</span>
<span class="w">    </span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="mh">0x3286df</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">_Exit</span>
<span class="w">    </span><span class="mi">2</span><span class="p">:</span><span class="w"> </span><span class="mh">0x33301f</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">exit</span>
<span class="w">    </span><span class="mi">3</span><span class="p">:</span><span class="w"> </span><span class="mh">0x16698d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">Py_Exit</span>
<span class="w">    </span><span class="mi">4</span><span class="p">:</span><span class="w"> </span><span class="mh">0x34b2dc</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">main</span>
<span class="w">    </span><span class="mi">5</span><span class="p">:</span><span class="w"> </span><span class="mh">0x329c22</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">__main_void</span>
<span class="w">    </span><span class="mi">6</span><span class="p">:</span><span class="w"> </span><span class="mh">0x5002</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">_start</span>
<span class="n">note</span><span class="p">:</span><span class="w"> </span><span class="nc">using</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="err">`</span><span class="n">WASMTIME_BACKTRACE_DETAILS</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="n">show</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">debugging</span><span class="w"> </span><span class="n">information</span>

<span class="n">Caused</span><span class="w"> </span><span class="n">by</span><span class="p">:</span>
<span class="w">    </span><span class="nc">Exited</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="n">exit</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="mi">0</span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: <br>
29.0.0</p>
<p>Operating system: macos Sonoma 14.7.2</p>
<p>Architecture: ARM</p>
</blockquote>



<a name="497245929"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310167%20error%3A%20error%20calling%20default%20export/near/497245929" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310167.20error.3A.20error.20calling.20default.20export.html#497245929">(Feb 02 2025 at 10:18)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/10167#issuecomment-2629331747">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10167">issue #10167</a>:</p>
<blockquote>
<p>The wasi_proc_exit syscall works by throwing a trap with the exit code. In Rust you can downcast the trap to the wasi exit code type, but I don't think the C API supports this.</p>
</blockquote>



<a name="497245956"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310167%20error%3A%20error%20calling%20default%20export/near/497245956" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310167.20error.3A.20error.20calling.20default.20export.html#497245956">(Feb 02 2025 at 10:18)</a>:</h4>
<p>bjorn3 edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/10167#issuecomment-2629331747">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10167">issue #10167</a>:</p>
<blockquote>
<p>The wasi_proc_exit syscall works by throwing a trap with the exit code. In Rust you can downcast the trap to the wasi exit code type, but I don't think the C API supports this.</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/a0338af84f66cb452fdf4b692d4facb5d052c12d/src/commands/run.rs#L243-L249">https://github.com/bytecodealliance/wasmtime/blob/a0338af84f66cb452fdf4b692d4facb5d052c12d/src/commands/run.rs#L243-L249</a></p>
</blockquote>



<a name="497277008"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310167%20error%3A%20error%20calling%20default%20export/near/497277008" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310167.20error.3A.20error.20calling.20default.20export.html#497277008">(Feb 02 2025 at 17:58)</a>:</h4>
<p>davecramer <a href="https://github.com/bytecodealliance/wasmtime/issues/10167#issuecomment-2629492829">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10167">issue #10167</a>:</p>
<blockquote>
<p>Interesting as it is more or less from the examples</p>
<p>Thanks</p>
<p>Dave Cramer</p>
<p>On Sun, Feb 2, 2025 at 5:18 AM bjorn3 <strong><em>@</em></strong>.***&gt; wrote:</p>
<blockquote>
<p>The wasi_proc_exit syscall works by throwing a trap with the exit code. In<br>
Rust you can downcast the trap to the wasi exit code type, but I don't<br>
think the C API supports this.</p>
<p>—<br>
Reply to this email directly, view it on GitHub<br>
&lt;<a href="https://github.com/bytecodealliance/wasmtime/issues/10167#issuecomment-2629331747">https://github.com/bytecodealliance/wasmtime/issues/10167#issuecomment-2629331747</a>&gt;,<br>
or unsubscribe<br>
&lt;<a href="https://github.com/notifications/unsubscribe-auth/AADDH5QPPT7ERETPV7KLM332NXWHLAVCNFSM6AAAAABWKAIFZOVHI2DSMVQWIX3LMV43OSLTON2WKQ3PNVWWK3TUHMZDMMRZGMZTCNZUG4">https://github.com/notifications/unsubscribe-auth/AADDH5QPPT7ERETPV7KLM332NXWHLAVCNFSM6AAAAABWKAIFZOVHI2DSMVQWIX3LMV43OSLTON2WKQ3PNVWWK3TUHMZDMMRZGMZTCNZUG4</a>&gt;<br>
.<br>
You are receiving this because you authored the thread.Message ID:<br>
<strong><em>@</em></strong>.***&gt;</p>
</blockquote>
</blockquote>



<a name="497294136"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310167%20error%3A%20error%20calling%20default%20export/near/497294136" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310167.20error.3A.20error.20calling.20default.20export.html#497294136">(Feb 02 2025 at 21:47)</a>:</h4>
<p>pchickey <a href="https://github.com/bytecodealliance/wasmtime/issues/10167#issuecomment-2629570645">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10167">issue #10167</a>:</p>
<blockquote>
<p>What's going on here is that the Wasm VM does not have a way to unwind the stack when a function like libc's <code>exit</code> is called, so we have to implement it by having the WASI implementation throw a trap. In the C API, you can use <a href="https://github.com/bytecodealliance/wasmtime/blob/pch/invoke_wave/crates/c-api/include/wasmtime/error.h#L54-L62"><code>wasmtime_error_exit_status</code></a> to check if the returned error is caused by a WASI exit, and you probably want to treat a WASI exit with code 0 the same as a successful call (the C API does not bake that assumption in for you).</p>
<p>The Wasm Exception Handling proposal has recently <a href="https://github.com/WebAssembly/proposals?tab=readme-ov-file#phase-4---standardize-the-feature-wg">progressed to Phase 4</a> and we want to implement it in wasmtime soon. Once it is widely available in WASI runtimes, we can then change the behavior of the WASI libc to implement <code>exit</code> with stack unwinding, rather than calling a special function that traps and requires user interpretation in this way.</p>
</blockquote>



<a name="497294582"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310167%20error%3A%20error%20calling%20default%20export/near/497294582" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310167.20error.3A.20error.20calling.20default.20export.html#497294582">(Feb 02 2025 at 21:53)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/10167#issuecomment-2629573121">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10167">issue #10167</a>:</p>
<blockquote>
<blockquote>
<p>we can then change the behavior of the WASI libc to implement exit with stack unwinding</p>
</blockquote>
<p>That would be unsound at least when the guest language is rust. <code>std::process::exit</code> is defined to immediately exit the process without unwinding and in the libc crate <code>exit</code> is defined as <code>extern "C"</code> rather than <code>extern "C-unwind"</code> and thus unwinding out of it is UB.</p>
</blockquote>



<a name="497398951"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310167%20error%3A%20error%20calling%20default%20export/near/497398951" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310167.20error.3A.20error.20calling.20default.20export.html#497398951">(Feb 03 2025 at 10:58)</a>:</h4>
<p>davecramer <a href="https://github.com/bytecodealliance/wasmtime/issues/10167#issuecomment-2630614780">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10167">issue #10167</a>:</p>
<blockquote>
<p>Well it's good to know that there's nothing I can do about it. <br>
I'm kind of surprised that nobody else has found this? Seems like it isn't used very much<br>
It's not out of the realm of possibility that I could write what I want in Rust, it's just much easier in C.</p>
</blockquote>



<a name="497412881"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310167%20error%3A%20error%20calling%20default%20export/near/497412881" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310167.20error.3A.20error.20calling.20default.20export.html#497412881">(Feb 03 2025 at 11:56)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/10167#issuecomment-2630739788">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10167">issue #10167</a>:</p>
<blockquote>
<p>@davecramer did you see Pat's link to <code>wasmtime_error_exit_status</code>? Does that not work for you? (That's the solution to this issue, and adding such handling to the C/Rust API examples would be reasonable too I think)</p>
</blockquote>



<a name="497425923"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310167%20error%3A%20error%20calling%20default%20export/near/497425923" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310167.20error.3A.20error.20calling.20default.20export.html#497425923">(Feb 03 2025 at 12:52)</a>:</h4>
<p>davecramer <a href="https://github.com/bytecodealliance/wasmtime/issues/10167#issuecomment-2630867691">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10167">issue #10167</a>:</p>
<blockquote>
<p>@alexcrichton honestly, no. Just got back from FOSDEM, bit ragged at the moment.</p>
</blockquote>



<a name="497467253"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310167%20error%3A%20error%20calling%20default%20export/near/497467253" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310167.20error.3A.20error.20calling.20default.20export.html#497467253">(Feb 03 2025 at 15:32)</a>:</h4>
<p>davecramer closed <a href="https://github.com/bytecodealliance/wasmtime/issues/10167">issue #10167</a>:</p>
<blockquote>
<h3>Test Case</h3>
<p>With the following python</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">def</span><span class="w"> </span><span class="n">talk</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
<span class="w">    </span><span class="nc">return</span><span class="w"> </span><span class="s">"Talk "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">message</span>


<span class="n">def</span><span class="w"> </span><span class="n">main</span><span class="p">():</span>
<span class="w">    </span><span class="nc">print</span><span class="p">(</span><span class="n">talk</span><span class="p">(</span><span class="s">"Hello World"</span><span class="p">))</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span>


<span class="k">if</span><span class="w"> </span><span class="n">__name__</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">"__main__"</span><span class="p">:</span>
<span class="w">    </span><span class="nc">main</span><span class="p">()</span>
</code></pre></div>
<p>compiled to wasm using py2wasm</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">int</span><span class="w"> </span><span class="n">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// Set up our context</span>
<span class="w">  </span><span class="n">wasm_engine_t</span><span class="w"> </span><span class="o">*</span><span class="n">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasm_engine_new</span><span class="p">();</span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">engine</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">NULL</span><span class="p">);</span>
<span class="w">  </span><span class="n">wasmtime_store_t</span><span class="w"> </span><span class="o">*</span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime_store_new</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="n">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">NULL</span><span class="p">);</span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">store</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">NULL</span><span class="p">);</span>
<span class="w">  </span><span class="n">wasmtime_context_t</span><span class="w"> </span><span class="o">*</span><span class="n">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime_store_context</span><span class="p">(</span><span class="n">store</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Create a linker with WASI functions defined</span>
<span class="w">  </span><span class="n">wasmtime_linker_t</span><span class="w"> </span><span class="o">*</span><span class="n">linker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime_linker_new</span><span class="p">(</span><span class="n">engine</span><span class="p">);</span>
<span class="w">  </span><span class="n">wasmtime_error_t</span><span class="w"> </span><span class="o">*</span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime_linker_define_wasi</span><span class="p">(</span><span class="n">linker</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">NULL</span><span class="p">)</span>
<span class="w">    </span><span class="n">exit_with_error</span><span class="p">(</span><span class="s">"failed to link wasi"</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">NULL</span><span class="p">);</span>

<span class="w">  </span><span class="n">wasm_byte_vec_t</span><span class="w"> </span><span class="n">wasm</span><span class="p">;</span>
<span class="w">  </span><span class="c1">// Load our input file to parse it next</span>
<span class="w">  </span><span class="n">FILE</span><span class="w"> </span><span class="o">*</span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fopen</span><span class="p">(</span><span class="s">"wasm/test.wasm"</span><span class="p">,</span><span class="w"> </span><span class="s">"rb"</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">file</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">"&gt; Error loading file!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="w">    </span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">fseek</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="n">L</span><span class="p">,</span><span class="w"> </span><span class="n">SEEK_END</span><span class="p">);</span>
<span class="w">  </span><span class="n">size_t</span><span class="w"> </span><span class="n">file_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ftell</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
<span class="w">  </span><span class="n">wasm_byte_vec_new_uninitialized</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wasm</span><span class="p">,</span><span class="w"> </span><span class="n">file_size</span><span class="p">);</span>
<span class="w">  </span><span class="n">fseek</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="n">L</span><span class="p">,</span><span class="w"> </span><span class="n">SEEK_SET</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fread</span><span class="p">(</span><span class="n">wasm</span><span class="p">.</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">file_size</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">file</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">"&gt; Error loading module!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="w">    </span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">fclose</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Compile our modules</span>
<span class="w">  </span><span class="n">wasmtime_module_t</span><span class="w"> </span><span class="o">*</span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NULL</span><span class="p">;</span>
<span class="w">  </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime_module_new</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">wasm</span><span class="p">.</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">wasm</span><span class="p">.</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">module</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">module</span><span class="p">)</span>
<span class="w">    </span><span class="n">exit_with_error</span><span class="p">(</span><span class="s">"failed to compile module"</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">NULL</span><span class="p">);</span>
<span class="w">  </span><span class="n">wasm_byte_vec_delete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wasm</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Instantiate wasi</span>
<span class="w">  </span><span class="n">wasi_config_t</span><span class="w"> </span><span class="o">*</span><span class="n">wasi_config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasi_config_new</span><span class="p">();</span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">wasi_config</span><span class="p">);</span>
<span class="w">  </span><span class="n">wasi_config_inherit_argv</span><span class="p">(</span><span class="n">wasi_config</span><span class="p">);</span>
<span class="w">  </span><span class="n">wasi_config_inherit_env</span><span class="p">(</span><span class="n">wasi_config</span><span class="p">);</span>
<span class="w">  </span><span class="n">wasi_config_inherit_stdin</span><span class="p">(</span><span class="n">wasi_config</span><span class="p">);</span>
<span class="w">  </span><span class="n">wasi_config_inherit_stdout</span><span class="p">(</span><span class="n">wasi_config</span><span class="p">);</span>
<span class="w">  </span><span class="n">wasi_config_inherit_stderr</span><span class="p">(</span><span class="n">wasi_config</span><span class="p">);</span>
<span class="w">  </span><span class="n">wasm_trap_t</span><span class="w"> </span><span class="o">*</span><span class="n">trap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NULL</span><span class="p">;</span>
<span class="w">  </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime_context_set_wasi</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">wasi_config</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">NULL</span><span class="p">)</span>
<span class="w">    </span><span class="n">exit_with_error</span><span class="p">(</span><span class="s">"failed to instantiate WASI"</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">NULL</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Instantiate the module</span>
<span class="w">  </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime_linker_module</span><span class="p">(</span><span class="n">linker</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="s">""</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">module</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">NULL</span><span class="p">)</span>
<span class="w">    </span><span class="n">exit_with_error</span><span class="p">(</span><span class="s">"failed to instantiate module"</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">NULL</span><span class="p">);</span>

<span class="w">  </span><span class="c1">// Run it.</span>
<span class="w">  </span><span class="n">wasmtime_func_t</span><span class="w"> </span><span class="n">func</span><span class="p">;</span>
<span class="w">  </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime_linker_get_default</span><span class="p">(</span><span class="n">linker</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="s">"main"</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">func</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">NULL</span><span class="p">)</span>
<span class="w">    </span><span class="n">exit_with_error</span><span class="p">(</span><span class="s">"failed to locate default export for module"</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">NULL</span><span class="p">);</span>

<span class="w">  </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime_func_call</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">func</span><span class="p">,</span><span class="w"> </span><span class="n">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">trap</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">NULL</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">trap</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">NULL</span><span class="p">){</span>
<span class="w">    </span><span class="n">exit_with_error</span><span class="p">(</span><span class="s">"error calling default export"</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">trap</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="c1">// Clean up after ourselves at this point</span>
<span class="w">  </span><span class="n">wasmtime_module_delete</span><span class="p">(</span><span class="n">module</span><span class="p">);</span>
<span class="w">  </span><span class="n">wasmtime_store_delete</span><span class="p">(</span><span class="n">store</span><span class="p">);</span>
<span class="w">  </span><span class="n">wasm_engine_delete</span><span class="p">(</span><span class="n">engine</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n">void</span><span class="w"> </span><span class="n">exit_with_error</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">wasmtime_error_t</span><span class="w"> </span><span class="o">*</span><span class="n">error</span><span class="p">,</span>
<span class="w">                            </span><span class="n">wasm_trap_t</span><span class="w"> </span><span class="o">*</span><span class="n">trap</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">"error: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p">);</span>
<span class="w">  </span><span class="n">wasm_byte_vec_t</span><span class="w"> </span><span class="n">error_message</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">error</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">wasmtime_error_message</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">error_message</span><span class="p">);</span>
<span class="w">    </span><span class="n">wasmtime_error_delete</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">wasm_trap_message</span><span class="p">(</span><span class="n">trap</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">error_message</span><span class="p">);</span>
<span class="w">    </span><span class="n">wasm_trap_delete</span><span class="p">(</span><span class="n">trap</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">"%.*s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">int</span><span class="p">)</span><span class="n">error_message</span><span class="p">.</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">error_message</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
<span class="w">  </span><span class="n">wasm_byte_vec_delete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">error_message</span><span class="p">);</span>
<span class="w">  </span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>TODO: upload Wasm file here<br>
I get the error </p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">Talk</span><span class="w"> </span><span class="n">Hello</span><span class="w"> </span><span class="n">World</span>
<span class="n">error</span><span class="p">:</span><span class="w"> </span><span class="nc">error</span><span class="w"> </span><span class="n">calling</span><span class="w"> </span><span class="n">default</span><span class="w"> </span><span class="n">export</span>
<span class="n">error</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="n">executing</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">wasm</span><span class="w"> </span><span class="n">backtrace</span><span class="p">:</span>
<span class="w">    </span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="mh">0x32a019</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">__wasi_proc_exit</span>
<span class="w">    </span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="mh">0x3286df</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">_Exit</span>
<span class="w">    </span><span class="mi">2</span><span class="p">:</span><span class="w"> </span><span class="mh">0x33301f</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">exit</span>
<span class="w">    </span><span class="mi">3</span><span class="p">:</span><span class="w"> </span><span class="mh">0x16698d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">Py_Exit</span>
<span class="w">    </span><span class="mi">4</span><span class="p">:</span><span class="w"> </span><span class="mh">0x34b2dc</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">main</span>
<span class="w">    </span><span class="mi">5</span><span class="p">:</span><span class="w"> </span><span class="mh">0x329c22</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">__main_void</span>
<span class="w">    </span><span class="mi">6</span><span class="p">:</span><span class="w"> </span><span class="mh">0x5002</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unknown</span><span class="o">&gt;!</span><span class="n">_start</span>
<span class="n">note</span><span class="p">:</span><span class="w"> </span><span class="nc">using</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="err">`</span><span class="n">WASMTIME_BACKTRACE_DETAILS</span><span class="o">=</span><span class="mi">1</span><span class="err">`</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">may</span><span class="w"> </span><span class="n">show</span><span class="w"> </span><span class="n">more</span><span class="w"> </span><span class="n">debugging</span><span class="w"> </span><span class="n">information</span>

<span class="n">Caused</span><span class="w"> </span><span class="n">by</span><span class="p">:</span>
<span class="w">    </span><span class="nc">Exited</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="n">exit</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="mi">0</span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: <br>
29.0.0</p>
<p>Operating system: macos Sonoma 14.7.2</p>
<p>Architecture: ARM</p>
</blockquote>



<a name="497467256"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310167%20error%3A%20error%20calling%20default%20export/near/497467256" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310167.20error.3A.20error.20calling.20default.20export.html#497467256">(Feb 03 2025 at 15:32)</a>:</h4>
<p>davecramer <a href="https://github.com/bytecodealliance/wasmtime/issues/10167#issuecomment-2631342017">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10167">issue #10167</a>:</p>
<blockquote>
<blockquote>
<p><a href="https://github.com/davecramer">@davecramer</a> did you see Pat's link to <code>wasmtime_error_exit_status</code>? Does that not work for you? (That's the solution to this issue, and adding such handling to the C/Rust API examples would be reasonable too I think)</p>
</blockquote>
<p>That works fine.</p>
<p>Now on to how to pass data back and forth without using argc, argv.<br>
Thanks!</p>
</blockquote>



<hr><p>Last updated: Feb 22 2026 at 11:05 UTC</p>
</html>
<html>
<head><meta charset="utf-8"><title>wasmtime / issue #10397 [GC] id from different slab · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310397.20.5BGC.5D.20id.20from.20different.20slab.html">wasmtime / issue #10397 [GC] id from different slab</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="505650488"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310397%20%5BGC%5D%20id%20from%20different%20slab/near/505650488" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310397.20.5BGC.5D.20id.20from.20different.20slab.html#505650488">(Mar 14 2025 at 11:31)</a>:</h4>
<p><a href="https://github.com/vouillon">vouillon</a> added the bug label to <a href="https://github.com/bytecodealliance/wasmtime/issues/10397">Issue #10397</a>.</p>



<a name="505650489"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310397%20%5BGC%5D%20id%20from%20different%20slab/near/505650489" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310397.20.5BGC.5D.20id.20from.20different.20slab.html#505650489">(Mar 14 2025 at 11:31)</a>:</h4>
<p>vouillon opened <a href="https://github.com/bytecodealliance/wasmtime/issues/10397">issue #10397</a>:</p>
<blockquote>
<h3>Test Case</h3>
<p><a href="https://github.com/user-attachments/files/19246260/slab-mismatch.zip">slab-mismatch.zip</a></p>
<h3>Steps to Reproduce</h3>
<p>Run the following command:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">.</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">wasmtime</span><span class="w">  </span><span class="o">-</span><span class="n">W</span><span class="o">=</span><span class="n">all</span><span class="o">-</span><span class="n">proposals</span><span class="o">=</span><span class="n">y</span><span class="w"> </span><span class="n">slab</span><span class="o">-</span><span class="n">mismatch</span><span class="p">.</span><span class="n">wasm</span>
</code></pre></div>
<h3>Expected Results</h3>
<p>It should not crash.</p>
<h3>Actual Results</h3>
<p>We get a panic:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">jerome</span><span class="o">/</span><span class="n">sources</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">crates</span><span class="o">/</span><span class="n">slab</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">387</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span>
<span class="nc">id</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">different</span><span class="w"> </span><span class="n">slab</span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Wasmtime commit: a3381e48775912a3e1a68c05180932f3ce74c5b4</p>
<p>Operating system: Linux</p>
<p>Architecture: x64<br>
</p>
</blockquote>



<a name="506194517"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310397%20%5BGC%5D%20id%20from%20different%20slab/near/506194517" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310397.20.5BGC.5D.20id.20from.20different.20slab.html#506194517">(Mar 17 2025 at 15:56)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/issues/10397#issuecomment-2730045195">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10397">issue #10397</a>:</p>
<blockquote>
<p>Thanks for filing this bug!</p>
</blockquote>



<a name="506542021"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310397%20%5BGC%5D%20id%20from%20different%20slab/near/506542021" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310397.20.5BGC.5D.20id.20from.20different.20slab.html#506542021">(Mar 18 2025 at 17:40)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/issues/10397#issuecomment-2734170911">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10397">issue #10397</a>:</p>
<blockquote>
<p>Minimized a bit further:</p>
<div class="codehilite" data-code-language="WebAssembly"><pre><span></span><code><span class="p">(</span><span class="k">module</span>
  <span class="p">(</span><span class="k">type</span> <span class="nv">$func</span> <span class="p">(</span><span class="k">func</span><span class="p">))</span>
  <span class="p">(</span><span class="k">type</span> <span class="nv">$array</span> <span class="p">(</span><span class="err">array</span> <span class="p">(</span><span class="k">mut</span> <span class="kt">i32</span><span class="p">)))</span>
  <span class="p">(</span><span class="k">type</span> <span class="nv">$struct</span> <span class="p">(</span><span class="err">sub</span> <span class="p">(</span><span class="err">struct</span> <span class="p">(</span><span class="err">field</span> <span class="nv">$field</span> <span class="p">(</span><span class="err">ref</span> <span class="nv">$func</span><span class="p">)))))</span>

  <span class="p">(</span><span class="k">elem</span> <span class="k">func</span> <span class="nv">$nop</span><span class="p">)</span>
  <span class="p">(</span><span class="k">func</span> <span class="nv">$nop</span><span class="p">)</span>

  <span class="p">(</span><span class="k">func</span> <span class="p">(</span><span class="k">export</span> <span class="s2">""</span><span class="p">)</span>
    <span class="p">(</span><span class="k">local</span> <span class="nv">$local_array</span> <span class="p">(</span><span class="err">ref</span> <span class="nv">$array</span><span class="p">))</span>
    <span class="p">(</span><span class="k">local</span> <span class="nv">$local_struct</span> <span class="p">(</span><span class="err">ref</span> <span class="nv">$struct</span><span class="p">))</span>
    <span class="p">(</span><span class="nb">local.set</span> <span class="nv">$local_struct</span> <span class="p">(</span><span class="err">struct.new</span> <span class="nv">$struct</span> <span class="p">(</span><span class="err">ref.</span><span class="k">func</span> <span class="nv">$nop</span><span class="p">)))</span>
    <span class="p">(</span><span class="k">loop</span> <span class="nv">$outer</span>
      <span class="p">(</span><span class="nb">local.set</span> <span class="nv">$local_array</span> <span class="p">(</span><span class="err">array.new</span> <span class="nv">$array</span> <span class="p">(</span><span class="nb">i32.const</span> <span class="mi">0</span><span class="p">)</span> <span class="p">(</span><span class="nb">i32.const</span> <span class="mi">1</span><span class="p">)))</span>
      <span class="p">(</span><span class="k">loop</span> <span class="nv">$inner</span>
        <span class="p">(</span><span class="err">array.set</span> <span class="nv">$array</span> <span class="p">(</span><span class="err">ref.cast</span> <span class="p">(</span><span class="err">ref</span> <span class="nv">$array</span><span class="p">)</span> <span class="p">(</span><span class="nb">local.get</span> <span class="nv">$local_array</span><span class="p">))</span>
                          <span class="p">(</span><span class="nb">i32.const</span> <span class="mi">0</span><span class="p">)</span>
                          <span class="p">(</span><span class="nb">i32.const</span> <span class="mi">1</span><span class="p">))</span>
        <span class="p">(</span><span class="nb">br_if</span> <span class="nv">$inner</span> <span class="p">(</span><span class="nb">i32.const</span> <span class="mi">0</span><span class="p">))</span>
      <span class="p">)</span>
      <span class="p">(</span><span class="nb">call</span><span class="err">_ref</span> <span class="nv">$func</span> <span class="p">(</span><span class="err">struct.get</span> <span class="nv">$struct</span> <span class="nv">$field</span> <span class="p">(</span><span class="nb">local.get</span> <span class="nv">$local_struct</span><span class="p">)))</span>
      <span class="p">(</span><span class="nb">br</span> <span class="nv">$outer</span><span class="p">)</span>
    <span class="p">)</span>
  <span class="p">)</span>
<span class="p">)</span>
</code></pre></div>
<p>There are a couple interesting things that can't be removed from the test case while preserving the crash:</p>
<ul>
<li>the <code>br_if</code> whose operand is a constant <code>0</code></li>
<li>the <code>ref.cast</code> into the exact same type that it already is</li>
</ul>
</blockquote>



<a name="507371264"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310397%20%5BGC%5D%20id%20from%20different%20slab/near/507371264" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310397.20.5BGC.5D.20id.20from.20different.20slab.html#507371264">(Mar 21 2025 at 21:31)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/issues/10397#issuecomment-2744487057">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10397">issue #10397</a>:</p>
<blockquote>
<p>I have a fix for this over in <a href="https://github.com/bytecodealliance/wasmtime/pull/10456">https://github.com/bytecodealliance/wasmtime/pull/10456</a></p>
<p>Thanks again for the bug report!</p>
</blockquote>



<a name="507374791"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310397%20%5BGC%5D%20id%20from%20different%20slab/near/507374791" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310397.20.5BGC.5D.20id.20from.20different.20slab.html#507374791">(Mar 21 2025 at 22:00)</a>:</h4>
<p>vouillon <a href="https://github.com/bytecodealliance/wasmtime/issues/10397#issuecomment-2744543503">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10397">issue #10397</a>:</p>
<blockquote>
<p>Thanks a lot!<br>
I'm not sure the fix is complete, though. I still get similar errors (<code>id from different slab</code> and <code>assertion failed: types.is_subtype(actual_ty, expected_ty)</code>). I'll try to find the time to produce a reduced test case.</p>
</blockquote>



<a name="507376426"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310397%20%5BGC%5D%20id%20from%20different%20slab/near/507376426" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310397.20.5BGC.5D.20id.20from.20different.20slab.html#507376426">(Mar 21 2025 at 22:13)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/issues/10397#issuecomment-2744568139">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10397">issue #10397</a>:</p>
<blockquote>
<p>Yeah, we sandbox the GC heap, so when we have any kind of GC heap corruption bug, it tends to look like those panics rather than overwriting host memory or what have you. Occasionally it might look like a SIGILL at a <code>ud2</code> instruction because of an assertion check inside of JIT code tripping. But the important thing is that corruption in the GC heap should never result in memory unsafety in the rest of the runtime, just panics or whatever.</p>
<p>Anyways, the point is, it is likely not the same bug if it still triggers after <a href="https://github.com/bytecodealliance/wasmtime/pull/10456">https://github.com/bytecodealliance/wasmtime/pull/10456</a>, but just that all kinds of GC heap corruption tend to show the same symptoms.</p>
<p>But as always, reduced test cases are super helpful, thanks for taking the time to make reproducers and all that!</p>
</blockquote>



<a name="507850558"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310397%20%5BGC%5D%20id%20from%20different%20slab/near/507850558" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310397.20.5BGC.5D.20id.20from.20different.20slab.html#507850558">(Mar 24 2025 at 18:37)</a>:</h4>
<p>cfallin closed <a href="https://github.com/bytecodealliance/wasmtime/issues/10397">issue #10397</a>:</p>
<blockquote>
<h3>Test Case</h3>
<p><a href="https://github.com/user-attachments/files/19246260/slab-mismatch.zip">slab-mismatch.zip</a></p>
<h3>Steps to Reproduce</h3>
<p>Run the following command:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">.</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">wasmtime</span><span class="w">  </span><span class="o">-</span><span class="n">W</span><span class="o">=</span><span class="n">all</span><span class="o">-</span><span class="n">proposals</span><span class="o">=</span><span class="n">y</span><span class="w"> </span><span class="n">slab</span><span class="o">-</span><span class="n">mismatch</span><span class="p">.</span><span class="n">wasm</span>
</code></pre></div>
<h3>Expected Results</h3>
<p>It should not crash.</p>
<h3>Actual Results</h3>
<p>We get a panic:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="n">panicked</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">jerome</span><span class="o">/</span><span class="n">sources</span><span class="o">/</span><span class="n">wasmtime</span><span class="o">/</span><span class="n">crates</span><span class="o">/</span><span class="n">slab</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">lib</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">387</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span>
<span class="nc">id</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">different</span><span class="w"> </span><span class="n">slab</span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Wasmtime commit: a3381e48775912a3e1a68c05180932f3ce74c5b4</p>
<p>Operating system: Linux</p>
<p>Architecture: x64<br>
</p>
</blockquote>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
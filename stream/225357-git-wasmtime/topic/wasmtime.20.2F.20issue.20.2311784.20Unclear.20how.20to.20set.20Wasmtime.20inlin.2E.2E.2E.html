<html>
<head><meta charset="utf-8"><title>wasmtime / issue #11784 Unclear how to set Wasmtime inlin... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311784.20Unclear.20how.20to.20set.20Wasmtime.20inlin.2E.2E.2E.html">wasmtime / issue #11784 Unclear how to set Wasmtime inlin...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="542868644"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311784%20Unclear%20how%20to%20set%20Wasmtime%20inlin.../near/542868644" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311784.20Unclear.20how.20to.20set.20Wasmtime.20inlin.2E.2E.2E.html#542868644">(Oct 03 2025 at 05:02)</a>:</h4>
<p>cfallin opened <a href="https://github.com/bytecodealliance/wasmtime/issues/11784">issue #11784</a>:</p>
<blockquote>
<p>Currently, the <code>Config</code> API has only <code>compiler_inlining</code>, which flips a global flag to enable the inliner, but its behavior is governed by more fine-grained flags.</p>
<p>Some of these flags are exposed as hidden "Cranelift flags" interpreted by <code>wasmtime-cranelift</code> <a href="https://github.com/bytecodealliance/wasmtime/blob/7cebfa206fe4a40ab54e9862f30b05c5fefb9043/crates/cranelift/src/builder.rs#L74-L85">here</a>. These flags are set at least by the fuzzer <a href="https://github.com/bytecodealliance/wasmtime/blob/7cebfa206fe4a40ab54e9862f30b05c5fefb9043/crates/fuzzing/src/generators/config.rs#L333-L352">here</a>. That match in the setter in turn alters the tunables that are contained on the <code>wasmtime_cranelift::compiler::Compiler</code>.</p>
<p>However, the actual inlining decision is <a href="https://github.com/bytecodealliance/wasmtime/blob/7cebfa206fe4a40ab54e9862f30b05c5fefb9043/crates/wasmtime/src/compile.rs#L787">governed</a> by the <code>Tunables</code> held <a href="https://github.com/bytecodealliance/wasmtime/blob/7cebfa206fe4a40ab54e9862f30b05c5fefb9043/crates/wasmtime/src/compile.rs#L676">on the Engine</a>. These <code>Tunables</code> are <em>passed into</em> the compiler <a href="https://github.com/bytecodealliance/wasmtime/blob/7cebfa206fe4a40ab54e9862f30b05c5fefb9043/crates/wasmtime/src/config.rs#L2531">here</a>, when using the configuration to build the compiler object. However, note that the flow is one-way: the <a href="https://github.com/bytecodealliance/wasmtime/blob/7cebfa206fe4a40ab54e9862f30b05c5fefb9043/crates/environ/src/compile/mod.rs#L129"><code>set_tunables</code></a> trait method takes a <code>Tunables</code> by value, i.e., copies all the tunable knobs once at that time. The copy is then altered <a href="https://github.com/bytecodealliance/wasmtime/blob/7cebfa206fe4a40ab54e9862f30b05c5fefb9043/crates/wasmtime/src/config.rs#L2532-L2534">in the next few lines</a> as the compiler flags are applied, but the original that ends up on the <code>Engine</code> never is.</p>
<p>It's still a bit unclear to me how the fuzzer ultimately is able to set up fuzzing of inlining appropriately, but when I try to get intra-module inlining to work with</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">config</span><span class="p">.</span><span class="n">compiler_inlining</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="k">unsafe</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">config</span><span class="p">.</span><span class="n">cranelift_flag_set</span><span class="p">(</span><span class="s">"wasmtime_inlining_intra_module"</span><span class="p">,</span><span class="w"> </span><span class="s">"true"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>I find that <code>intra_module_inlining</code> when queried by the inlining heuristics is still at its default <code>WhenUsingGc</code> rather than <code>Yes</code>. I had to add a <code>Config::compiler_force_Inlining()</code> method as a hack in #11769 to allow for testing, but we should probably support the hidden flag properly from the <code>Config</code> API instead. It's unclear to me what the right fix should be: either alter the plumbing so tunables updates can be made by the compiler (should <code>set_tunables</code> take a mutable borrow of the <code>Tunables</code>, held only while the builder is alive, and we can then move the clone into the build step?) or by adding a more first-class way of setting these inlining heuristics on the <code>Config</code>.</p>
<p>cc @fitzgen </p>
</blockquote>



<a name="542868645"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311784%20Unclear%20how%20to%20set%20Wasmtime%20inlin.../near/542868645" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311784.20Unclear.20how.20to.20set.20Wasmtime.20inlin.2E.2E.2E.html#542868645">(Oct 03 2025 at 05:02)</a>:</h4>
<p><a href="https://github.com/cfallin">cfallin</a> added the bug label to <a href="https://github.com/bytecodealliance/wasmtime/issues/11784">Issue #11784</a>.</p>



<a name="543411525"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311784%20Unclear%20how%20to%20set%20Wasmtime%20inlin.../near/543411525" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311784.20Unclear.20how.20to.20set.20Wasmtime.20inlin.2E.2E.2E.html#543411525">(Oct 06 2025 at 21:29)</a>:</h4>
<p>fitzgen closed <a href="https://github.com/bytecodealliance/wasmtime/issues/11784">issue #11784</a>:</p>
<blockquote>
<p>Currently, the <code>Config</code> API has only <code>compiler_inlining</code>, which flips a global flag to enable the inliner, but its behavior is governed by more fine-grained flags.</p>
<p>Some of these flags are exposed as hidden "Cranelift flags" interpreted by <code>wasmtime-cranelift</code> <a href="https://github.com/bytecodealliance/wasmtime/blob/7cebfa206fe4a40ab54e9862f30b05c5fefb9043/crates/cranelift/src/builder.rs#L74-L85">here</a>. These flags are set at least by the fuzzer <a href="https://github.com/bytecodealliance/wasmtime/blob/7cebfa206fe4a40ab54e9862f30b05c5fefb9043/crates/fuzzing/src/generators/config.rs#L333-L352">here</a>. That match in the setter in turn alters the tunables that are contained on the <code>wasmtime_cranelift::compiler::Compiler</code>.</p>
<p>However, the actual inlining decision is <a href="https://github.com/bytecodealliance/wasmtime/blob/7cebfa206fe4a40ab54e9862f30b05c5fefb9043/crates/wasmtime/src/compile.rs#L787">governed</a> by the <code>Tunables</code> held <a href="https://github.com/bytecodealliance/wasmtime/blob/7cebfa206fe4a40ab54e9862f30b05c5fefb9043/crates/wasmtime/src/compile.rs#L676">on the Engine</a>. These <code>Tunables</code> are <em>passed into</em> the compiler <a href="https://github.com/bytecodealliance/wasmtime/blob/7cebfa206fe4a40ab54e9862f30b05c5fefb9043/crates/wasmtime/src/config.rs#L2531">here</a>, when using the configuration to build the compiler object. However, note that the flow is one-way: the <a href="https://github.com/bytecodealliance/wasmtime/blob/7cebfa206fe4a40ab54e9862f30b05c5fefb9043/crates/environ/src/compile/mod.rs#L129"><code>set_tunables</code></a> trait method takes a <code>Tunables</code> by value, i.e., copies all the tunable knobs once at that time. The copy is then altered <a href="https://github.com/bytecodealliance/wasmtime/blob/7cebfa206fe4a40ab54e9862f30b05c5fefb9043/crates/wasmtime/src/config.rs#L2532-L2534">in the next few lines</a> as the compiler flags are applied, but the original that ends up on the <code>Engine</code> never is.</p>
<p>It's still a bit unclear to me how the fuzzer ultimately is able to set up fuzzing of inlining appropriately, but when I try to get intra-module inlining to work with</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">config</span><span class="p">.</span><span class="n">compiler_inlining</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="k">unsafe</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">config</span><span class="p">.</span><span class="n">cranelift_flag_set</span><span class="p">(</span><span class="s">"wasmtime_inlining_intra_module"</span><span class="p">,</span><span class="w"> </span><span class="s">"true"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>I find that <code>intra_module_inlining</code> when queried by the inlining heuristics is still at its default <code>WhenUsingGc</code> rather than <code>Yes</code>. I had to add a <code>Config::compiler_force_Inlining()</code> method as a hack in #11769 to allow for testing, but we should probably support the hidden flag properly from the <code>Config</code> API instead. It's unclear to me what the right fix should be: either alter the plumbing so tunables updates can be made by the compiler (should <code>set_tunables</code> take a mutable borrow of the <code>Tunables</code>, held only while the builder is alive, and we can then move the clone into the build step?) or by adding a more first-class way of setting these inlining heuristics on the <code>Config</code>.</p>
<p>cc @fitzgen </p>
</blockquote>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
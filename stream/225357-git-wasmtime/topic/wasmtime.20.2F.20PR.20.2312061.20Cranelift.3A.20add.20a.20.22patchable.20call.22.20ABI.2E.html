<html>
<head><meta charset="utf-8"><title>wasmtime / PR #12061 Cranelift: add a &quot;patchable call&quot; ABI. · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312061.20Cranelift.3A.20add.20a.20.22patchable.20call.22.20ABI.2E.html">wasmtime / PR #12061 Cranelift: add a &quot;patchable call&quot; ABI.</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="558550565"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312061%20Cranelift%3A%20add%20a%20%22patchable%20call%22%20ABI./near/558550565" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312061.20Cranelift.3A.20add.20a.20.22patchable.20call.22.20ABI.2E.html#558550565">(Nov 20 2025 at 23:47)</a>:</h4>
<p>cfallin opened <a href="https://github.com/bytecodealliance/wasmtime/pull/12061">PR #12061</a> from <code>cfallin:patchable-abi-is-happy-to-preserve-all-your-registers</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>This ABI is intended for use in scenarios where we want a very lightweight callsite that can be turned on and off by patching in one instruction. (The actual patchable call instruction is not in this PR; that will be a separate PR.)</p>
<p>The idea is that we define a call to clobber <em>no</em> registers -- not even the arguments! And we restrict signatures such that on all of our supported architectures, all arguments go into registers only. Those two requirements together mean that all callsites for this ABI should have only a raw call instruction, with no loads/stores to stackslots; and have the minimum possible impact on regalloc, by only imposing constraints on args to ensure they are in certain registers but not altering those registers.</p>
<p>Given this, we could implement, e.g., breakpoints with patchable callsites (off by default) at every sequence point in compiled code. In a typical use-case with Wasmtime-compiled Wasm, that would put a bunch of uses of vmctx constrained to the first argument register in every code path, but vmctx likely already sits there most of the time anyway (for any call to other Wasm functions or for libcalls). Thus, the impact is just the one instruction and nothing else.</p>
<p>This PR adds the calling convention itself and tests that show that <em>two</em> consecutive callsites can be compiled with no register setup re-occurring from one call to the next (thus demonstrating no clobbers).</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="558550567"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312061%20Cranelift%3A%20add%20a%20%22patchable%20call%22%20ABI./near/558550567" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312061.20Cranelift.3A.20add.20a.20.22patchable.20call.22.20ABI.2E.html#558550567">(Nov 20 2025 at 23:47)</a>:</h4>
<p><strong>cfallin</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/12061">PR #12061</a>.</p>



<a name="558550568"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312061%20Cranelift%3A%20add%20a%20%22patchable%20call%22%20ABI./near/558550568" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312061.20Cranelift.3A.20add.20a.20.22patchable.20call.22.20ABI.2E.html#558550568">(Nov 20 2025 at 23:47)</a>:</h4>
<p><strong>cfallin</strong> requested <a href="https://github.com/alexcrichton">alexcrichton</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/12061">PR #12061</a>.</p>



<a name="558551119"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312061%20Cranelift%3A%20add%20a%20%22patchable%20call%22%20ABI./near/558551119" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312061.20Cranelift.3A.20add.20a.20.22patchable.20call.22.20ABI.2E.html#558551119">(Nov 20 2025 at 23:53)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/12061#issuecomment-3560692554">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/12061">PR #12061</a>:</p>
<blockquote>
<p>(Switching to draft actually -- want to implement the callee side in this one too, sorry)</p>
</blockquote>



<a name="558555041"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312061%20Cranelift%3A%20add%20a%20%22patchable%20call%22%20ABI./near/558555041" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312061.20Cranelift.3A.20add.20a.20.22patchable.20call.22.20ABI.2E.html#558555041">(Nov 21 2025 at 00:26)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/12061">PR #12061</a>.</p>



<a name="558555072"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312061%20Cranelift%3A%20add%20a%20%22patchable%20call%22%20ABI./near/558555072" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312061.20Cranelift.3A.20add.20a.20.22patchable.20call.22.20ABI.2E.html#558555072">(Nov 21 2025 at 00:27)</a>:</h4>
<p><strong>cfallin</strong> has marked <a href="https://github.com/bytecodealliance/wasmtime/pull/12061">PR #12061</a> as ready for review.</p>



<a name="558555109"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312061%20Cranelift%3A%20add%20a%20%22patchable%20call%22%20ABI./near/558555109" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312061.20Cranelift.3A.20add.20a.20.22patchable.20call.22.20ABI.2E.html#558555109">(Nov 21 2025 at 00:27)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/12061#issuecomment-3560768217">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/12061">PR #12061</a>:</p>
<blockquote>
<p>OK, good to go now!</p>
</blockquote>



<a name="558576746"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312061%20Cranelift%3A%20add%20a%20%22patchable%20call%22%20ABI./near/558576746" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312061.20Cranelift.3A.20add.20a.20.22patchable.20call.22.20ABI.2E.html#558576746">(Nov 21 2025 at 04:54)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/12061">PR #12061</a>.</p>



<a name="558591641"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312061%20Cranelift%3A%20add%20a%20%22patchable%20call%22%20ABI./near/558591641" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312061.20Cranelift.3A.20add.20a.20.22patchable.20call.22.20ABI.2E.html#558591641">(Nov 21 2025 at 07:17)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/12061">PR #12061</a>.</p>



<a name="558591643"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312061%20Cranelift%3A%20add%20a%20%22patchable%20call%22%20ABI./near/558591643" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312061.20Cranelift.3A.20add.20a.20.22patchable.20call.22.20ABI.2E.html#558591643">(Nov 21 2025 at 07:17)</a>:</h4>
<p><strong>cfallin</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers">wasmtime-core-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/12061">PR #12061</a>.</p>



<a name="558592228"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312061%20Cranelift%3A%20add%20a%20%22patchable%20call%22%20ABI./near/558592228" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312061.20Cranelift.3A.20add.20a.20.22patchable.20call.22.20ABI.2E.html#558592228">(Nov 21 2025 at 07:21)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/12061#pullrequestreview-3491509282">PR review</a>.</p>



<a name="558592230"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312061%20Cranelift%3A%20add%20a%20%22patchable%20call%22%20ABI./near/558592230" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312061.20Cranelift.3A.20add.20a.20.22patchable.20call.22.20ABI.2E.html#558592230">(Nov 21 2025 at 07:21)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/12061#discussion_r2548789498">PR review comment</a>:</p>
<blockquote>
<p>One thing to note here: riscv64 now counts upward rather than downward when saving clobbers, because it has to worry about 16-aligning vector regs (which were never previously callee-saves) and this is simpler to do (and to match the size computation) with a forward order. This is why a bunch of riscv64 tests were reblessed.</p>
<p>Pulley copied this logic but (i) I didn't want to alter the special "pulley-managed clobber saves" stuff and (ii) I think its vector stores/loads allow unaligned access, unlike riscv64 in the base case.</p>
</blockquote>



<a name="558672302"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312061%20Cranelift%3A%20add%20a%20%22patchable%20call%22%20ABI./near/558672302" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312061.20Cranelift.3A.20add.20a.20.22patchable.20call.22.20ABI.2E.html#558672302">(Nov 21 2025 at 14:26)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/12061#pullrequestreview-3492949917">PR review</a>.</p>



<a name="558672306"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312061%20Cranelift%3A%20add%20a%20%22patchable%20call%22%20ABI./near/558672306" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312061.20Cranelift.3A.20add.20a.20.22patchable.20call.22.20ABI.2E.html#558672306">(Nov 21 2025 at 14:26)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/12061#discussion_r2549904305">PR review comment</a>:</p>
<blockquote>
<p>Question for you, which I realize is basically unrelated to this PR -- this function feels like it's duplicated logic relative to <code>get_regs_clobbered_by_call</code> where this more-or-less returns the inverse of the other. How come in the backends this has its own implementation vs having one function delegate to the other?</p>
</blockquote>



<a name="558672307"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312061%20Cranelift%3A%20add%20a%20%22patchable%20call%22%20ABI./near/558672307" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312061.20Cranelift.3A.20add.20a.20.22patchable.20call.22.20ABI.2E.html#558672307">(Nov 21 2025 at 14:26)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/12061#discussion_r2549915488">PR review comment</a>:</p>
<blockquote>
<p>Similar question to aarch64 (or feel free to resolve with no comment if you respond to aarch64)</p>
</blockquote>



<a name="558672309"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312061%20Cranelift%3A%20add%20a%20%22patchable%20call%22%20ABI./near/558672309" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312061.20Cranelift.3A.20add.20a.20.22patchable.20call.22.20ABI.2E.html#558672309">(Nov 21 2025 at 14:26)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/12061#discussion_r2549912951">PR review comment</a>:</p>
<blockquote>
<p>Similar to my question about aarch64, would it be possible to implement this method in terms of <code>get_regs_clobbered_by_call</code>? </p>
</blockquote>



<a name="558672310"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312061%20Cranelift%3A%20add%20a%20%22patchable%20call%22%20ABI./near/558672310" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312061.20Cranelift.3A.20add.20a.20.22patchable.20call.22.20ABI.2E.html#558672310">(Nov 21 2025 at 14:26)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/12061#discussion_r2549916103">PR review comment</a>:</p>
<blockquote>
<p>Similar question to aarch64 (or feel free to resolve with no comment if you respond to aarch64)</p>
</blockquote>



<a name="558672311"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312061%20Cranelift%3A%20add%20a%20%22patchable%20call%22%20ABI./near/558672311" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312061.20Cranelift.3A.20add.20a.20.22patchable.20call.22.20ABI.2E.html#558672311">(Nov 21 2025 at 14:26)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/12061#discussion_r2549917693">PR review comment</a>:</p>
<blockquote>
<p>Similar question to aarch64 (or feel free to resolve with no comment if you respond to aarch64)</p>
</blockquote>



<a name="558672312"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312061%20Cranelift%3A%20add%20a%20%22patchable%20call%22%20ABI./near/558672312" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312061.20Cranelift.3A.20add.20a.20.22patchable.20call.22.20ABI.2E.html#558672312">(Nov 21 2025 at 14:26)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/12061#discussion_r2549908825">PR review comment</a>:</p>
<blockquote>
<p>Is it worth clarifying here that the return register, if applicable, is clobbered? I realize that's sort of like a "system" register which isn't tracked by regalloc, but I believe that's the one register that's clobbered with this ABI? (not that it matters, we always save it in the prologue anyway)</p>
</blockquote>



<a name="558734888"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312061%20Cranelift%3A%20add%20a%20%22patchable%20call%22%20ABI./near/558734888" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312061.20Cranelift.3A.20add.20a.20.22patchable.20call.22.20ABI.2E.html#558734888">(Nov 21 2025 at 19:13)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/12061#pullrequestreview-3494044160">PR review</a>.</p>



<a name="558734889"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312061%20Cranelift%3A%20add%20a%20%22patchable%20call%22%20ABI./near/558734889" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312061.20Cranelift.3A.20add.20a.20.22patchable.20call.22.20ABI.2E.html#558734889">(Nov 21 2025 at 19:13)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/12061#discussion_r2550723523">PR review comment</a>:</p>
<blockquote>
<p>Okay great, this is exactly what I was hoping would be here. We should document these constraints in the <code>ir::CallConv</code> doc comments for cranelift embedders tho.</p>
</blockquote>



<a name="558734891"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312061%20Cranelift%3A%20add%20a%20%22patchable%20call%22%20ABI./near/558734891" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312061.20Cranelift.3A.20add.20a.20.22patchable.20call.22.20ABI.2E.html#558734891">(Nov 21 2025 at 19:13)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/12061#discussion_r2550720230">PR review comment</a>:</p>
<blockquote>
<p>Alternatively it probably makes sense to restrict this calling convention to only as many arguments as fit in registers (portably?) and disallow returns. We can enforce this in CLIF validation.</p>
</blockquote>



<a name="558736903"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312061%20Cranelift%3A%20add%20a%20%22patchable%20call%22%20ABI./near/558736903" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312061.20Cranelift.3A.20add.20a.20.22patchable.20call.22.20ABI.2E.html#558736903">(Nov 21 2025 at 19:25)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/12061#discussion_r2550752224">PR review comment</a>:</p>
<blockquote>
<p>Right, yep, this is documented in this doc-comment (see 11 lines up): "only up to four arguments of integer type, and no return values".</p>
</blockquote>



<a name="558736904"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312061%20Cranelift%3A%20add%20a%20%22patchable%20call%22%20ABI./near/558736904" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312061.20Cranelift.3A.20add.20a.20.22patchable.20call.22.20ABI.2E.html#558736904">(Nov 21 2025 at 19:25)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/12061#pullrequestreview-3494089423">PR review</a>.</p>



<a name="558737088"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312061%20Cranelift%3A%20add%20a%20%22patchable%20call%22%20ABI./near/558737088" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312061.20Cranelift.3A.20add.20a.20.22patchable.20call.22.20ABI.2E.html#558737088">(Nov 21 2025 at 19:26)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/12061#pullrequestreview-3494092631">PR review</a>.</p>



<a name="558737089"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312061%20Cranelift%3A%20add%20a%20%22patchable%20call%22%20ABI./near/558737089" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312061.20Cranelift.3A.20add.20a.20.22patchable.20call.22.20ABI.2E.html#558737089">(Nov 21 2025 at 19:26)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/12061#discussion_r2550754431">PR review comment</a>:</p>
<blockquote>
<p>Yes, I believe it is documented: from line 55 in <code>call_conv.rs</code> I have</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">      </span><span class="sd">/// The ABI is based on the native register-argument ABI on each</span>
<span class="w">      </span><span class="sd">/// respective platform, but puts severe restrictions on allowable</span>
<span class="w">      </span><span class="sd">/// signatures: only up to four arguments of integer type, and no</span>
<span class="w">      </span><span class="sd">/// return values. It does not support tail-calls, and disallows</span>
<span class="w">      </span><span class="sd">/// any extension modes on arguments.</span>
</code></pre></div><br>
</p>
</blockquote>



<a name="558737660"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312061%20Cranelift%3A%20add%20a%20%22patchable%20call%22%20ABI./near/558737660" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312061.20Cranelift.3A.20add.20a.20.22patchable.20call.22.20ABI.2E.html#558737660">(Nov 21 2025 at 19:29)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/12061#pullrequestreview-3494102730">PR review</a>.</p>



<a name="558737661"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312061%20Cranelift%3A%20add%20a%20%22patchable%20call%22%20ABI./near/558737661" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312061.20Cranelift.3A.20add.20a.20.22patchable.20call.22.20ABI.2E.html#558737661">(Nov 21 2025 at 19:29)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/12061#discussion_r2550761197">PR review comment</a>:</p>
<blockquote>
<p>That's a great question! They are mostly but not entirely the same: witness the beauty that is the aarch64 calling convention, where it is specified that <em>half</em> of the vector registers (the low/f64 half) is callee-saved while half is caller-saved. The result of that is that we have the special "caller and callee conventions match so ignore callsites" logic that gives us the right code in the common case, but we have to conservatively over-approximate otherwise.</p>
<p>In non-aarch64 cases I agree it could be refactored, though that's another cleanup project I'd rather defer till after this PR if that's OK :-)</p>
</blockquote>



<a name="558742428"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312061%20Cranelift%3A%20add%20a%20%22patchable%20call%22%20ABI./near/558742428" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312061.20Cranelift.3A.20add.20a.20.22patchable.20call.22.20ABI.2E.html#558742428">(Nov 21 2025 at 20:01)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/12061#pullrequestreview-3494187182">PR review</a>.</p>



<a name="558742430"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312061%20Cranelift%3A%20add%20a%20%22patchable%20call%22%20ABI./near/558742430" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312061.20Cranelift.3A.20add.20a.20.22patchable.20call.22.20ABI.2E.html#558742430">(Nov 21 2025 at 20:01)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/12061#discussion_r2550828587">PR review comment</a>:</p>
<blockquote>
<p>D'oh -- thanks!</p>
</blockquote>



<a name="558774558"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312061%20Cranelift%3A%20add%20a%20%22patchable%20call%22%20ABI./near/558774558" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312061.20Cranelift.3A.20add.20a.20.22patchable.20call.22.20ABI.2E.html#558774558">(Nov 22 2025 at 01:34)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/12061#issuecomment-3565252107">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/12061">PR #12061</a>:</p>
<blockquote>
<p>(There is something weird going on with riscv64 which I spent a bit of time trying to debug with qemu+gdb today -- will resolve that before this moves further)</p>
</blockquote>



<a name="558776225"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312061%20Cranelift%3A%20add%20a%20%22patchable%20call%22%20ABI./near/558776225" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312061.20Cranelift.3A.20add.20a.20.22patchable.20call.22.20ABI.2E.html#558776225">(Nov 22 2025 at 02:02)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/12061">PR #12061</a>.</p>



<a name="558776553"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312061%20Cranelift%3A%20add%20a%20%22patchable%20call%22%20ABI./near/558776553" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312061.20Cranelift.3A.20add.20a.20.22patchable.20call.22.20ABI.2E.html#558776553">(Nov 22 2025 at 02:07)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/12061">PR #12061</a>.</p>



<a name="558776611"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312061%20Cranelift%3A%20add%20a%20%22patchable%20call%22%20ABI./near/558776611" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312061.20Cranelift.3A.20add.20a.20.22patchable.20call.22.20ABI.2E.html#558776611">(Nov 22 2025 at 02:08)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/12061">PR #12061</a>.</p>



<a name="558776898"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312061%20Cranelift%3A%20add%20a%20%22patchable%20call%22%20ABI./near/558776898" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312061.20Cranelift.3A.20add.20a.20.22patchable.20call.22.20ABI.2E.html#558776898">(Nov 22 2025 at 02:14)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/12061#issuecomment-3565327603">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/12061">PR #12061</a>:</p>
<blockquote>
<p>riscv64 issue was some weirdness with non-aligned stackslot area sizes causing problems with the new alignment of clobber-saves with the bottom-up ordering. I've reverted the changes that flipped the order to bottom-up.</p>
</blockquote>



<a name="558777052"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312061%20Cranelift%3A%20add%20a%20%22patchable%20call%22%20ABI./near/558777052" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312061.20Cranelift.3A.20add.20a.20.22patchable.20call.22.20ABI.2E.html#558777052">(Nov 22 2025 at 02:17)</a>:</h4>
<p>cfallin has enabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/12061">PR #12061</a>.</p>



<a name="558778911"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312061%20Cranelift%3A%20add%20a%20%22patchable%20call%22%20ABI./near/558778911" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312061.20Cranelift.3A.20add.20a.20.22patchable.20call.22.20ABI.2E.html#558778911">(Nov 22 2025 at 02:54)</a>:</h4>
<p>cfallin merged <a href="https://github.com/bytecodealliance/wasmtime/pull/12061">PR #12061</a>.</p>



<hr><p>Last updated: Feb 22 2026 at 11:05 UTC</p>
</html>
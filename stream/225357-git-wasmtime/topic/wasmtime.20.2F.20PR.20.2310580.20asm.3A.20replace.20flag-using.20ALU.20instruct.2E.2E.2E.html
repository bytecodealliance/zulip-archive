<html>
<head><meta charset="utf-8"><title>wasmtime / PR #10580 asm: replace flag-using ALU instruct... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310580.20asm.3A.20replace.20flag-using.20ALU.20instruct.2E.2E.2E.html">wasmtime / PR #10580 asm: replace flag-using ALU instruct...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="512191998"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310580%20asm%3A%20replace%20flag-using%20ALU%20instruct.../near/512191998" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310580.20asm.3A.20replace.20flag-using.20ALU.20instruct.2E.2E.2E.html#512191998">(Apr 14 2025 at 23:37)</a>:</h4>
<p>abrown opened <a href="https://github.com/bytecodealliance/wasmtime/pull/10580">PR #10580</a> from <code>abrown:asm-flags</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>This change replaces ISLE lowerings for the <code>ProducesFlags</code> and <code>ConsumesFlags</code> wrappers with instructions from the new assembler. This is a necessary step towards fully using the new assembler for ALU instructions (<code>AluRmiR</code> is only used for zeroing registers now).</p>
<p>A couple items of note:</p>
<ul>
<li>there are a few places where <code>lower.isle</code> wants to abstract over some subset of ALU operations to avoid repetition; this change retains that via some <code>x64_*_flags</code> helpers that take a new type (<code>ChainFlagsOp</code>, e.g.) that restricts which operations the helper can use. This is not a major refactor but it does show that we use these flag-producing instructions in quite limited ways.</li>
<li>we previously decided to keep rules that used wider versions of registers for i8/i16 operations to avoid CPU dependencies; this is problematic for instructions that rely on overflow, though, so this change extracts those "wider register" rules into <code>x64_*_break_deps</code> helpers.</li>
</ul>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="512412106"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310580%20asm%3A%20replace%20flag-using%20ALU%20instruct.../near/512412106" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310580.20asm.3A.20replace.20flag-using.20ALU.20instruct.2E.2E.2E.html#512412106">(Apr 15 2025 at 20:56)</a>:</h4>
<p>abrown updated <a href="https://github.com/bytecodealliance/wasmtime/pull/10580">PR #10580</a>.</p>



<a name="512412149"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310580%20asm%3A%20replace%20flag-using%20ALU%20instruct.../near/512412149" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310580.20asm.3A.20replace.20flag-using.20ALU.20instruct.2E.2E.2E.html#512412149">(Apr 15 2025 at 20:56)</a>:</h4>
<p><strong>abrown</strong> has marked <a href="https://github.com/bytecodealliance/wasmtime/pull/10580">PR #10580</a> as ready for review.</p>



<a name="512412151"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310580%20asm%3A%20replace%20flag-using%20ALU%20instruct.../near/512412151" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310580.20asm.3A.20replace.20flag-using.20ALU.20instruct.2E.2E.2E.html#512412151">(Apr 15 2025 at 20:56)</a>:</h4>
<p><strong>abrown</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/10580">PR #10580</a>.</p>



<a name="512412152"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310580%20asm%3A%20replace%20flag-using%20ALU%20instruct.../near/512412152" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310580.20asm.3A.20replace.20flag-using.20ALU.20instruct.2E.2E.2E.html#512412152">(Apr 15 2025 at 20:56)</a>:</h4>
<p><strong>abrown</strong> requested <a href="https://github.com/cfallin">cfallin</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/10580">PR #10580</a>.</p>



<a name="512428492"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310580%20asm%3A%20replace%20flag-using%20ALU%20instruct.../near/512428492" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310580.20asm.3A.20replace.20flag-using.20ALU.20instruct.2E.2E.2E.html#512428492">(Apr 15 2025 at 23:03)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/10580#pullrequestreview-2770131033">PR review</a>:</p>
<blockquote>
<p>Nice! I like the factoring here -- once the low-level helpers are out of the way, the application of this to each instruction is pretty straightforward.</p>
</blockquote>



<a name="512428493"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310580%20asm%3A%20replace%20flag-using%20ALU%20instruct.../near/512428493" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310580.20asm.3A.20replace.20flag-using.20ALU.20instruct.2E.2E.2E.html#512428493">(Apr 15 2025 at 23:03)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/10580#discussion_r2045674904">PR review comment</a>:</p>
<blockquote>
<p>Can we add a comment here that this should only be provided an instruction that actually produces flags, and is meant to be used by helpers that bind it with explicit instructions? In other words, it's semantically "unsafe" in the Rust sense and has to be used in the right way to uphold invariants.</p>
</blockquote>



<a name="512623316"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310580%20asm%3A%20replace%20flag-using%20ALU%20instruct.../near/512623316" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310580.20asm.3A.20replace.20flag-using.20ALU.20instruct.2E.2E.2E.html#512623316">(Apr 16 2025 at 17:44)</a>:</h4>
<p>abrown updated <a href="https://github.com/bytecodealliance/wasmtime/pull/10580">PR #10580</a>.</p>



<a name="512623370"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310580%20asm%3A%20replace%20flag-using%20ALU%20instruct.../near/512623370" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310580.20asm.3A.20replace.20flag-using.20ALU.20instruct.2E.2E.2E.html#512623370">(Apr 16 2025 at 17:44)</a>:</h4>
<p>abrown has enabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/10580">PR #10580</a>.</p>



<a name="512639202"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310580%20asm%3A%20replace%20flag-using%20ALU%20instruct.../near/512639202" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310580.20asm.3A.20replace.20flag-using.20ALU.20instruct.2E.2E.2E.html#512639202">(Apr 16 2025 at 18:24)</a>:</h4>
<p>abrown merged <a href="https://github.com/bytecodealliance/wasmtime/pull/10580">PR #10580</a>.</p>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
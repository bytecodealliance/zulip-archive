<html>
<head><meta charset="utf-8"><title>wasmtime / issue #11340 Figure out how to optimize away `... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311340.20Figure.20out.20how.20to.20optimize.20away.20.60.2E.2E.2E.html">wasmtime / issue #11340 Figure out how to optimize away `...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="531666603"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311340%20Figure%20out%20how%20to%20optimize%20away%20%60.../near/531666603" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311340.20Figure.20out.20how.20to.20optimize.20away.20.60.2E.2E.2E.html#531666603">(Jul 29 2025 at 17:42)</a>:</h4>
<p>fitzgen opened <a href="https://github.com/bytecodealliance/wasmtime/issues/11340">issue #11340</a>:</p>
<blockquote>
<p>For example, consider <code>tests/disas/component-model/direct-call-inlining.wat</code>. It begins by checking and setting the component flag globals for entry into a component:</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/6b7465480b6fc831dad1b9dfad09b7cf58a05bd3/tests/disas/component-model/direct-adapter-calls-inlining.wat#L80-L100">https://github.com/bytecodealliance/wasmtime/blob/6b7465480b6fc831dad1b9dfad09b7cf58a05bd3/tests/disas/component-model/direct-adapter-calls-inlining.wat#L80-L100</a></p>
<p>And ends by resetting those globals to their original values:</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/6b7465480b6fc831dad1b9dfad09b7cf58a05bd3/tests/disas/component-model/direct-adapter-calls-inlining.wat#L104-L133">https://github.com/bytecodealliance/wasmtime/blob/6b7465480b6fc831dad1b9dfad09b7cf58a05bd3/tests/disas/component-model/direct-adapter-calls-inlining.wat#L104-L133</a></p>
<p>This is the vast bulk of the inlined callee code, since the actual callee got const-prop'd away into a simple constant:</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/6b7465480b6fc831dad1b9dfad09b7cf58a05bd3/tests/disas/component-model/direct-adapter-calls-inlining.wat#L143">https://github.com/bytecodealliance/wasmtime/blob/6b7465480b6fc831dad1b9dfad09b7cf58a05bd3/tests/disas/component-model/direct-adapter-calls-inlining.wat#L143</a></p>
<p>Ideally the only thing we would have after inlining is that constant. I guess we also need to check the flags, but we shouldn't need to write to them at all.</p>
<p>Addressing this likely involves implementing <a href="https://github.com/bytecodealliance/wasmtime/issues/4167">dead-store-elimination</a> in our alias analysis, but maybe also requires some higher-level analyses and logic in the adapter generation code as well, where we know exactly what can and cannot observe those globals and when.</p>
</blockquote>



<a name="531666605"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311340%20Figure%20out%20how%20to%20optimize%20away%20%60.../near/531666605" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311340.20Figure.20out.20how.20to.20optimize.20away.20.60.2E.2E.2E.html#531666605">(Jul 29 2025 at 17:42)</a>:</h4>
<p><a href="https://github.com/fitzgen">fitzgen</a> added the cranelift<span aria-label="goal" class="emoji emoji-1f945" role="img" title="goal">:goal:</span>optimize-speed label to <a href="https://github.com/bytecodealliance/wasmtime/issues/11340">Issue #11340</a>.</p>



<a name="531666609"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311340%20Figure%20out%20how%20to%20optimize%20away%20%60.../near/531666609" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311340.20Figure.20out.20how.20to.20optimize.20away.20.60.2E.2E.2E.html#531666609">(Jul 29 2025 at 17:42)</a>:</h4>
<p><a href="https://github.com/fitzgen">fitzgen</a> added the wasm-proposal:component-model label to <a href="https://github.com/bytecodealliance/wasmtime/issues/11340">Issue #11340</a>.</p>



<a name="531666699"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311340%20Figure%20out%20how%20to%20optimize%20away%20%60.../near/531666699" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311340.20Figure.20out.20how.20to.20optimize.20away.20.60.2E.2E.2E.html#531666699">(Jul 29 2025 at 17:43)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/issues/11340#issuecomment-3133459931">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11340">issue #11340</a>:</p>
<blockquote>
<p>cc @cfallin </p>
</blockquote>



<a name="534020601"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311340%20Figure%20out%20how%20to%20optimize%20away%20%60.../near/534020601" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311340.20Figure.20out.20how.20to.20optimize.20away.20.60.2E.2E.2E.html#534020601">(Aug 12 2025 at 16:51)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/11340#issuecomment-3180202120">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11340">issue #11340</a>:</p>
<blockquote>
<p>This looks like something we could get to work fairly well if we have custom alias-analysis regions and use one per global; then the store-elimination condition will be fairly robust to any other intervening memory traffic.</p>
<p>The tricky part is the condition that no intervening may-trap operations occur. This is needed for soundness in the absence of more semantic info from the IR, because we ensure that memory state at a trap is as-if no optimizations occurred. But if we know that the flags are not observable after a trap, perhaps we could note that with a flag; then we can allow trapping ops not to clobber the last-store info. (Is it really a core Wasm-level global or some custom component-model storage? Is it accessible via any of our instance introspection APIs?)</p>
</blockquote>



<a name="534023749"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311340%20Figure%20out%20how%20to%20optimize%20away%20%60.../near/534023749" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311340.20Figure.20out.20how.20to.20optimize.20away.20.60.2E.2E.2E.html#534023749">(Aug 12 2025 at 17:11)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/issues/11340#issuecomment-3180261340">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11340">issue #11340</a>:</p>
<blockquote>
<blockquote>
<p>This looks like something we could get to work fairly well if we have custom alias-analysis regions and use one per global</p>
</blockquote>
<p>In <a href="https://github.com/bytecodealliance/wasmtime/issues/9348">https://github.com/bytecodealliance/wasmtime/issues/9348</a>, I want to remove our hard-coded alias regions and replace them with an arbitrary <code>u8</code> or something that the cranelift embedder assigns semantics to. This would work well here, allowing us to give these flags unique regions (well in a world where we go crazy with regions, we might need to map multiple application-level logical regions onto the same cranelift-level "physical" regions due to bitpacking constraints and running out of <code>u8</code> space, or else we would have to make a new alias region entity table; that is all something we can deal with if/when we get to it).</p>
<blockquote>
<p>The tricky part is the condition that no intervening may-trap operations occur. This is needed for soundness in the absence of more semantic info from the IR, because we ensure that memory state at a trap is as-if no optimizations occurred. But if we know that the flags are not observable after a trap, perhaps we could note that with a flag; then we can allow trapping ops not to clobber the last-store info.</p>
</blockquote>
<p>This perhaps seems like a property of the alias region: is this region observable after traps or not? If we want to start having additional metadata about alias regions like this, then maybe they really do need to become their own entity table.</p>
<blockquote>
<p>(Is it really a core Wasm-level global or some custom component-model storage? Is it accessible via any of our instance introspection APIs?)</p>
</blockquote>
<p>They are implemented with Wasm-level globals but they not directly observable by anything but the Wasm adapter functions we generate. Guest Wasm cannot access them directly.</p>
<p>However, they do prevent re-entrancy (that is what these gets/sets are implementing in the first place) and the traps we raise when we detect re-entrancy are visible to embedders (the guest component halts and cannot be re-entered after one of these traps, as attempts to do so will just keep hitting this re-entrancy trap).</p>
<p>They are not exported, and so embedders cannot get a <code>wasmtime::Global</code> to introspect them. I think they will show up in core dumps, but that would just be us leaking an implementation detail in our core dumps, essentially, and I would argue that doesn't "count". Definitely shouldn't be any way for the embedder to modify these flags directly.</p>
</blockquote>



<a name="534026183"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311340%20Figure%20out%20how%20to%20optimize%20away%20%60.../near/534026183" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311340.20Figure.20out.20how.20to.20optimize.20away.20.60.2E.2E.2E.html#534026183">(Aug 12 2025 at 17:29)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/11340#issuecomment-3180312580">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11340">issue #11340</a>:</p>
<blockquote>
<p>Yep, your custom alias region proposal is what I had in mind :-) This would work nicely as a new kind of entity: something like <code>region0 = region</code> / <code>region1 = region internal</code> in the preamble. We could also consider whether other semantic properties make sense, e.g. noting a region is readonly, or guaranteed not to be altered by callees, etc. Perhaps it even makes sense to move all semantic info we carry on <code>MemFlags</code> into the region? (I'm struggling to think of a case where we could have loads/stores with different semantics at different points to the same disjoint subset of addresses...)</p>
<p>If I recall correctly, one of the concerns we had at that time was whether we could fit a whole region identifier in the 16-byte <code>InstructionData</code> for a load/store, hence the <code>u8</code> region ID; stores <a href="https://github.com/bytecodealliance/wasmtime/blob/cf88a7c6010e845b50e3332aea8a146d4d8a3bb4/cranelift/codegen/meta/src/shared/instructions.rs#L795-L798">already have</a> opcode, 32-bit offset, address, data, and flags (so three <code>u32</code>s and discriminant+flags packed in a fourth). Limiting to 256 regions seems anemic (consider: calling many different components from one large init function, each with their own reentrancy flag). But if we're replacing <code>MemFlags</code> (per above) by moving its flags to the region, then we have 16 or 24 bits (depending on <code>InstructionData</code> discriminant size) to play with, which seems reasonable.</p>
</blockquote>



<a name="534027586"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311340%20Figure%20out%20how%20to%20optimize%20away%20%60.../near/534027586" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311340.20Figure.20out.20how.20to.20optimize.20away.20.60.2E.2E.2E.html#534027586">(Aug 12 2025 at 17:39)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/issues/11340#issuecomment-3180359517">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11340">issue #11340</a>:</p>
<blockquote>
<blockquote>
<p>(I'm struggling to think of a case where we could have loads/stores with different semantics at different points to the same disjoint subset of addresses...)</p>
</blockquote>
<p>The only flag I can think of would be <code>can_move</code> which depends more on the data-flow properties of the instruction than the memory region.</p>
</blockquote>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
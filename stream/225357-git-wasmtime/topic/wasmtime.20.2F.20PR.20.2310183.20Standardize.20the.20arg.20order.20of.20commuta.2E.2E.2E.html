<html>
<head><meta charset="utf-8"><title>wasmtime / PR #10183 Standardize the arg order of commuta... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310183.20Standardize.20the.20arg.20order.20of.20commuta.2E.2E.2E.html">wasmtime / PR #10183 Standardize the arg order of commuta...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="497725961"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310183%20Standardize%20the%20arg%20order%20of%20commuta.../near/497725961" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310183.20Standardize.20the.20arg.20order.20of.20commuta.2E.2E.2E.html#497725961">(Feb 04 2025 at 18:00)</a>:</h4>
<p>erikrose opened <a href="https://github.com/bytecodealliance/wasmtime/pull/10183">PR #10183</a> from <code>erikrose:canonical-gvn</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>This stands on the shoulders of #6135 but reorders only while computing GVN map lookup keys. It doesn't affect the codegenned instructions themselves, which will hopefully dodge the performance regression that led to that PR's reversion.</p>
</blockquote>



<a name="497727298"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310183%20Standardize%20the%20arg%20order%20of%20commuta.../near/497727298" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310183.20Standardize.20the.20arg.20order.20of.20commuta.2E.2E.2E.html#497727298">(Feb 04 2025 at 18:07)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/10183#issuecomment-2634708140">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/10183">PR #10183</a>:</p>
<blockquote>
<p>@erikrose interesting, thanks for this PR. I'm curious if you've observed a benefit (e.g. on our Sightglass suite) in runtime, and also what the impact on compile time is?</p>
<p>My general thought is I'm a little leery of adding extra magic to the egraph optimizer -- it's already a carefully-tuned combo stage of all of the core optimizations, and I'd rather make it simpler than more complex, all other things being equal -- but we can certainly think about ways to clean this up if it shows a benefit.</p>
</blockquote>



<a name="497733576"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310183%20Standardize%20the%20arg%20order%20of%20commuta.../near/497733576" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310183.20Standardize.20the.20arg.20order.20of.20commuta.2E.2E.2E.html#497733576">(Feb 04 2025 at 18:46)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/10183#issuecomment-2634787138">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/10183">PR #10183</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @cfallin, @fitzgen</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "cranelift", "isle"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>cfallin: isle</li>
<li>fitzgen: isle</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="497755569"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310183%20Standardize%20the%20arg%20order%20of%20commuta.../near/497755569" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310183.20Standardize.20the.20arg.20order.20of.20commuta.2E.2E.2E.html#497755569">(Feb 04 2025 at 21:00)</a>:</h4>
<p>erikrose <a href="https://github.com/bytecodealliance/wasmtime/pull/10183#issuecomment-2635066179">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/10183">PR #10183</a>:</p>
<blockquote>
<p>Yes, this is definitely a drafty draft at the moment (hence the Draft classification!). :-) Dan thought it would be a good acclimatization task for me, and indeed, it was a great tour of many parts of Cranelift. It seems like it can also grant me a good little tour of Sightglass, and then we'll see if it's worth pursuing further. Thanks for having a look!</p>
</blockquote>



<a name="497978795"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310183%20Standardize%20the%20arg%20order%20of%20commuta.../near/497978795" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310183.20Standardize.20the.20arg.20order.20of.20commuta.2E.2E.2E.html#497978795">(Feb 05 2025 at 20:38)</a>:</h4>
<p>erikrose updated <a href="https://github.com/bytecodealliance/wasmtime/pull/10183">PR #10183</a>.</p>



<a name="498224315"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310183%20Standardize%20the%20arg%20order%20of%20commuta.../near/498224315" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310183.20Standardize.20the.20arg.20order.20of.20commuta.2E.2E.2E.html#498224315">(Feb 06 2025 at 22:42)</a>:</h4>
<p>erikrose closed without merge <a href="https://github.com/bytecodealliance/wasmtime/pull/10183">PR #10183</a>.</p>



<a name="498224317"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310183%20Standardize%20the%20arg%20order%20of%20commuta.../near/498224317" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310183.20Standardize.20the.20arg.20order.20of.20commuta.2E.2E.2E.html#498224317">(Feb 06 2025 at 22:42)</a>:</h4>
<p>erikrose <a href="https://github.com/bytecodealliance/wasmtime/pull/10183#issuecomment-2641288304">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/10183">PR #10183</a>:</p>
<blockquote>
<p>I benched this patch last night (and it took all night, because I ran the whole "all" suite). It didn't have a huge impact on execution speed either way: 7 benchmarks were faster, 9 slower, and 94 no-difference. Caveats: I ran this on macOS, so it's ARM-only and cycle-count-only—no perf counters. Here are the trimmed-down results, to get a sense of impact:</p>
<p>Ones where the PR was faster than <code>main</code>:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">target</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">libwasmtime_bench_api</span><span class="p">.</span><span class="n">dylib</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.02</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.03</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">tmp</span><span class="o">/</span><span class="n">wasmtime_main</span><span class="p">.</span><span class="n">dylib</span><span class="o">!</span>
<span class="n">target</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">libwasmtime_bench_api</span><span class="p">.</span><span class="n">dylib</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.02</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.02</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">tmp</span><span class="o">/</span><span class="n">wasmtime_main</span><span class="p">.</span><span class="n">dylib</span><span class="o">!</span>
<span class="n">target</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">libwasmtime_bench_api</span><span class="p">.</span><span class="n">dylib</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.00</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.02</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">tmp</span><span class="o">/</span><span class="n">wasmtime_main</span><span class="p">.</span><span class="n">dylib</span><span class="o">!</span>
<span class="n">target</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">libwasmtime_bench_api</span><span class="p">.</span><span class="n">dylib</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.01</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.02</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">tmp</span><span class="o">/</span><span class="n">wasmtime_main</span><span class="p">.</span><span class="n">dylib</span><span class="o">!</span>
<span class="n">target</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">libwasmtime_bench_api</span><span class="p">.</span><span class="n">dylib</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.00</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.02</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">tmp</span><span class="o">/</span><span class="n">wasmtime_main</span><span class="p">.</span><span class="n">dylib</span><span class="o">!</span>
<span class="n">target</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">libwasmtime_bench_api</span><span class="p">.</span><span class="n">dylib</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.00</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.01</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">tmp</span><span class="o">/</span><span class="n">wasmtime_main</span><span class="p">.</span><span class="n">dylib</span><span class="o">!</span>
<span class="n">target</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">libwasmtime_bench_api</span><span class="p">.</span><span class="n">dylib</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.00</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.01</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">tmp</span><span class="o">/</span><span class="n">wasmtime_main</span><span class="p">.</span><span class="n">dylib</span><span class="o">!</span>
</code></pre></div>
<p>Ones where the PR was slower:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">tmp</span><span class="o">/</span><span class="n">wasmtime_main</span><span class="p">.</span><span class="n">dylib</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.00</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.05</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">target</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">libwasmtime_bench_api</span><span class="p">.</span><span class="n">dylib</span><span class="o">!</span>
<span class="n">tmp</span><span class="o">/</span><span class="n">wasmtime_main</span><span class="p">.</span><span class="n">dylib</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.00</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.04</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">target</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">libwasmtime_bench_api</span><span class="p">.</span><span class="n">dylib</span><span class="o">!</span>
<span class="n">tmp</span><span class="o">/</span><span class="n">wasmtime_main</span><span class="p">.</span><span class="n">dylib</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.02</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.02</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">target</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">libwasmtime_bench_api</span><span class="p">.</span><span class="n">dylib</span><span class="o">!</span>
<span class="n">tmp</span><span class="o">/</span><span class="n">wasmtime_main</span><span class="p">.</span><span class="n">dylib</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.00</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.04</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">target</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">libwasmtime_bench_api</span><span class="p">.</span><span class="n">dylib</span><span class="o">!</span>
<span class="n">tmp</span><span class="o">/</span><span class="n">wasmtime_main</span><span class="p">.</span><span class="n">dylib</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.01</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.02</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">target</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">libwasmtime_bench_api</span><span class="p">.</span><span class="n">dylib</span><span class="o">!</span>
<span class="n">tmp</span><span class="o">/</span><span class="n">wasmtime_main</span><span class="p">.</span><span class="n">dylib</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.00</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.01</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">target</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">libwasmtime_bench_api</span><span class="p">.</span><span class="n">dylib</span><span class="o">!</span>
<span class="n">tmp</span><span class="o">/</span><span class="n">wasmtime_main</span><span class="p">.</span><span class="n">dylib</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.00</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.01</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">target</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">libwasmtime_bench_api</span><span class="p">.</span><span class="n">dylib</span><span class="o">!</span>
<span class="n">tmp</span><span class="o">/</span><span class="n">wasmtime_main</span><span class="p">.</span><span class="n">dylib</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.00</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.01</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">target</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">libwasmtime_bench_api</span><span class="p">.</span><span class="n">dylib</span><span class="o">!</span>
<span class="n">tmp</span><span class="o">/</span><span class="n">wasmtime_main</span><span class="p">.</span><span class="n">dylib</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="mf">1.00</span><span class="n">x</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="mf">1.00</span><span class="n">x</span><span class="w"> </span><span class="n">faster</span><span class="w"> </span><span class="n">than</span><span class="w"> </span><span class="n">target</span><span class="o">/</span><span class="n">release</span><span class="o">/</span><span class="n">libwasmtime_bench_api</span><span class="p">.</span><span class="n">dylib</span><span class="o">!</span>
</code></pre></div>
<p>I expect most of the suite, embodied in .wasm files, already made a trip through LLVM's optimization pipeline and thus had all the GVN opportunities used up already. It may be worth waking this up again if ever we encounter a use case where that's not true. In the meantime, I'll close this. Here are the full benchmark results for posterity: <a href="https://github.com/user-attachments/files/18698493/Full.Sightglass.Results.txt">Full Sightglass Results.txt</a>.</p>
<p>If we ever pick it up again, I would…</p>
<ul>
<li>[ ] Push GVN key generation to someplace where we don't have to look at it in the main egraph loop: perhaps in the GVN hash itself.</li>
<li>[ ] Remove the <code>IntCompare</code> and <code>FloatCompare</code> <code>==</code> arms of the <code>match</code>, since they'd be more at home as ISLE rules (and are probably already implemented as such).<br>
</li>
</ul>
</blockquote>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
<html>
<head><meta charset="utf-8"><title>wasmtime / issue #10181 [GC] Illegal instruction · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310181.20.5BGC.5D.20Illegal.20instruction.html">wasmtime / issue #10181 [GC] Illegal instruction</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="497669714"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310181%20%5BGC%5D%20Illegal%20instruction/near/497669714" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310181.20.5BGC.5D.20Illegal.20instruction.html#497669714">(Feb 04 2025 at 13:48)</a>:</h4>
<p><a href="https://github.com/vouillon">vouillon</a> added the bug label to <a href="https://github.com/bytecodealliance/wasmtime/issues/10181">Issue #10181</a>.</p>



<a name="497669719"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310181%20%5BGC%5D%20Illegal%20instruction/near/497669719" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310181.20.5BGC.5D.20Illegal.20instruction.html#497669719">(Feb 04 2025 at 13:48)</a>:</h4>
<p>vouillon opened <a href="https://github.com/bytecodealliance/wasmtime/issues/10181">issue #10181</a>:</p>
<blockquote>
<h3>Test Case</h3>
<p><a href="https://github.com/user-attachments/files/18657925/constprop.zip">constprop.zip</a></p>
<h3>Steps to Reproduce</h3>
<p>Run the following command:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">.</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">wasmtime</span><span class="w">  </span><span class="o">-</span><span class="n">W</span><span class="o">=</span><span class="n">all</span><span class="o">-</span><span class="n">proposals</span><span class="o">=</span><span class="n">y</span><span class="w"> </span><span class="n">constprop</span><span class="p">.</span><span class="n">wasm</span>
</code></pre></div>
<h3>Expected Results</h3>
<p>This works fine if one add the <code>-C collector=null</code> option:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">debug</span><span class="o">/</span><span class="n">wasmtime</span><span class="w"> </span><span class="o">-</span><span class="n">C</span><span class="w"> </span><span class="n">collector</span><span class="o">=</span><span class="n">null</span><span class="w">  </span><span class="o">-</span><span class="n">W</span><span class="o">=</span><span class="n">all</span><span class="o">-</span><span class="n">proposals</span><span class="o">=</span><span class="n">y</span><span class="w"> </span><span class="n">constprop</span><span class="p">.</span><span class="n">wasm</span>
<span class="n">booleans</span><span class="p">:</span><span class="w"> </span><span class="nc">passed</span>
<span class="n">integers</span><span class="p">:</span><span class="w"> </span><span class="nc">passed</span>
<span class="n">floats</span><span class="p">:</span><span class="w"> </span><span class="nc">passed</span>
<span class="mi">32</span><span class="o">-</span><span class="n">bit</span><span class="w"> </span><span class="n">integers</span><span class="p">:</span><span class="w"> </span><span class="nc">passed</span>
<span class="n">native</span><span class="w"> </span><span class="n">integers</span><span class="p">:</span><span class="w"> </span><span class="nc">passed</span>
<span class="mi">64</span><span class="o">-</span><span class="n">bit</span><span class="w"> </span><span class="n">integers</span><span class="p">:</span><span class="w"> </span><span class="nc">passed</span>
<span class="n">integer</span><span class="w"> </span><span class="n">conversions</span><span class="p">:</span><span class="w"> </span><span class="nc">passed</span>
<span class="mi">32</span><span class="o">-</span><span class="n">bit</span><span class="w"> </span><span class="n">integer</span><span class="w"> </span><span class="n">conversions</span><span class="p">:</span><span class="w"> </span><span class="nc">passed</span>
<span class="n">native</span><span class="w"> </span><span class="n">integer</span><span class="w"> </span><span class="n">conversions</span><span class="p">:</span><span class="w"> </span><span class="nc">passed</span>
<span class="mi">64</span><span class="o">-</span><span class="n">bit</span><span class="w"> </span><span class="n">integer</span><span class="w"> </span><span class="n">conversions</span><span class="p">:</span><span class="w"> </span><span class="nc">passed</span>
</code></pre></div>
<h3>Actual Results</h3>
<p>This crashes with an <code>Illegal instruction</code> error.</p>
<h3>Versions and Environment</h3>
<p>Wasmtime commit: 0e0560087beff704bc111a1abb1d6a80c1b5da70</p>
<p>Operating system: Linux</p>
<p>Architecture: x64<br>
</p>
</blockquote>



<a name="497672093"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310181%20%5BGC%5D%20Illegal%20instruction/near/497672093" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310181.20.5BGC.5D.20Illegal.20instruction.html#497672093">(Feb 04 2025 at 13:58)</a>:</h4>
<p>alexcrichton assigned afonso360 to <a href="https://github.com/bytecodealliance/wasmtime/issues/10181">issue #10181</a>.</p>



<a name="497672096"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310181%20%5BGC%5D%20Illegal%20instruction/near/497672096" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310181.20.5BGC.5D.20Illegal.20instruction.html#497672096">(Feb 04 2025 at 13:58)</a>:</h4>
<p>alexcrichton assigned fitzgen to <a href="https://github.com/bytecodealliance/wasmtime/issues/10181">issue #10181</a>.</p>



<a name="497672122"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310181%20%5BGC%5D%20Illegal%20instruction/near/497672122" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310181.20.5BGC.5D.20Illegal.20instruction.html#497672122">(Feb 04 2025 at 13:58)</a>:</h4>
<p>alexcrichton unassigned afonso360 from <a href="https://github.com/bytecodealliance/wasmtime/issues/10181">issue #10181</a>.</p>



<a name="497714404"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310181%20%5BGC%5D%20Illegal%20instruction/near/497714404" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310181.20.5BGC.5D.20Illegal.20instruction.html#497714404">(Feb 04 2025 at 17:00)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/issues/10181#issuecomment-2634556893">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10181">issue #10181</a>:</p>
<blockquote>
<p>Thanks for the bug report!</p>
<p>If you have time, minimizing the test case <code>wat</code> with <code>creduce</code> would be very appreciated and make diagnosing and fixing this easier. If not, I'll get around to that eventually.</p>
</blockquote>



<a name="497714843"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310181%20%5BGC%5D%20Illegal%20instruction/near/497714843" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310181.20.5BGC.5D.20Illegal.20instruction.html#497714843">(Feb 04 2025 at 17:02)</a>:</h4>
<p><a href="https://github.com/fitzgen">fitzgen</a> added the wasm-proposal:gc label to <a href="https://github.com/bytecodealliance/wasmtime/issues/10181">Issue #10181</a>.</p>



<a name="497727795"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310181%20%5BGC%5D%20Illegal%20instruction/near/497727795" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310181.20.5BGC.5D.20Illegal.20instruction.html#497727795">(Feb 04 2025 at 18:10)</a>:</h4>
<p>just-an-engineer <a href="https://github.com/bytecodealliance/wasmtime/issues/10181#issuecomment-2634713961">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10181">issue #10181</a>:</p>
<blockquote>
<p>I'll take this.<br>
After some initial looking, it has to do with the async stuff, I'm guessing it pops the wrong address somehow.</p>
</blockquote>



<a name="497734647"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310181%20%5BGC%5D%20Illegal%20instruction/near/497734647" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310181.20.5BGC.5D.20Illegal.20instruction.html#497734647">(Feb 04 2025 at 18:52)</a>:</h4>
<p>just-an-engineer <a href="https://github.com/bytecodealliance/wasmtime/issues/10181#issuecomment-2634801367">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10181">issue #10181</a>:</p>
<blockquote>
<p>Where is this wasm file from, and how did you compile it?<br>
I suspect it may be from an invalid wasm file, which the code _should_ check for currently, but doesn't seem to. Running <code>wasm-validate</code> on it gives me an error of invalid type a few bytes in, but I imagine that tools stops after the first error, so no idea how many more.<br>
Anyways, it could be that there's some invalid stuff here that operates outside of the specification, that leds to an incorrect address being jumped to during the async execution stuffs.</p>
</blockquote>



<a name="497751452"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310181%20%5BGC%5D%20Illegal%20instruction/near/497751452" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310181.20.5BGC.5D.20Illegal.20instruction.html#497751452">(Feb 04 2025 at 20:34)</a>:</h4>
<p>vouillon <a href="https://github.com/bytecodealliance/wasmtime/issues/10181#issuecomment-2635007625">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10181">issue #10181</a>:</p>
<blockquote>
<p>This code relies on the Wasm GC proposal. This proposal is not supported by <code>wasm-validate</code>. That's why you get errors.<br>
The code is generated using <a href="https://github.com/ocsigen/js_of_ocaml/blob/7c6c20949ebff14ba0d069ba1b5ff99a0f3be434/README_wasm_of_ocaml.md">wasm_of_ocaml</a>, which compiles OCaml code to Wam.<br>
The <a href="https://github.com/ocsigen/js_of_ocaml/blob/7c6c20949ebff14ba0d069ba1b5ff99a0f3be434/compiler/tests-ocaml/basic/constprop.ml.c">source code</a> comes from the OCaml test suite, so it is a bit weird.<br>
<code>wasm-opt</code> from the binaryen toolchain is used to optimize the code. And the code runs fine in <code>node</code>. So I'm quite confident regarding its validity.<br>
</p>
</blockquote>



<a name="497765079"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310181%20%5BGC%5D%20Illegal%20instruction/near/497765079" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310181.20.5BGC.5D.20Illegal.20instruction.html#497765079">(Feb 04 2025 at 22:02)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/issues/10181#issuecomment-2635172664">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10181">issue #10181</a>:</p>
<blockquote>
<p>@just-an-engineer </p>
<blockquote>
<p>I'll take this.</p>
</blockquote>
<p>You're definitely welcome to investigate this bug, but this isn't likely the best good-first-issue kind of bug if you aren't already somewhat familiar with Wasmtime and Cranelift.</p>
<p>What would be super helpful whether you continue to investigate this bug or leave it for someone else would be to run <code>creduce</code> on the <code>.wat</code> disassembly of the test case and reduce it to a minimal example that triggers the illegal instruction fault. This would involve something like:</p>
<ul>
<li><code>wasm-tools wasm2wat test.wasm -o test.wat</code></li>
<li>
<p>Writing a <code>predicate.sh</code> that does something like<br>
<code>sh
  #!/usr/bin/env bash
  set -eu
  cargo run --manifest-path ~/path/to/wasmtime/Cargo.toml -- \
      -C collector=null -W=all-proposals=y \
      test.wat \
      2&gt;&amp;1 | grep -q 'Illegal instruction'
  </code><br>
  (Note: the above is untested, you would want to make sure that it exits <code>1</code> if <code>test.wasm</code> doesn't trigger the illegal instruction and <code>0</code> if it does trigger the illegal instruction.)</p>
</li>
<li>
<p>And finally run <code>creduce</code> something like<br>
<code>
  creduce --not-c predicate.sh test.wat
  </code></p>
</li>
</ul>
<p>And when <code>creduce</code> is finished, post the reduced test case here.</p>
<blockquote>
<p>I suspect it may be from an invalid wasm file</p>
</blockquote>
<p>Wasmtime always validates the Wasm as part of its process of translating it to Cranelift's IR (called CLIF) so, barring validator bugs, we should never actually execute any invalid Wasm file.</p>
</blockquote>



<a name="498314120"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310181%20%5BGC%5D%20Illegal%20instruction/near/498314120" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310181.20.5BGC.5D.20Illegal.20instruction.html#498314120">(Feb 07 2025 at 11:06)</a>:</h4>
<p>vouillon <a href="https://github.com/bytecodealliance/wasmtime/issues/10181#issuecomment-2642608130">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10181">issue #10181</a>:</p>
<blockquote>
<p>I have used <code>wasm-reduce</code> (from the Binaryen toolchain) and <code>creduce</code>, plus some manual rewriting, to reduce the size of the code. It remains a bit large, probably because one needs a specific allocation pattern to trigger the bug. In particular, there is a global array which is not used anywhere, and some values that are dropped right after being allocated.<br>
A circular datastructure is built using <code>struct.set</code>. Maybe this confuses the GC? I don't see anything else suspicious.<br>
<a href="https://github.com/user-attachments/files/18705401/constprop.wat.txt">constprop.wat.txt</a></p>
</blockquote>



<a name="500350026"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310181%20%5BGC%5D%20Illegal%20instruction/near/500350026" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310181.20.5BGC.5D.20Illegal.20instruction.html#500350026">(Feb 18 2025 at 09:04)</a>:</h4>
<p>tanishiking <a href="https://github.com/bytecodealliance/wasmtime/issues/10181#issuecomment-2665004815">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10181">issue #10181</a>:</p>
<blockquote>
<p>We encountered an "Illegal Instruction" error in our project (<a href="https://github.com/scala-wasm/scala-wasm/pull/5">scala-wasm</a> fork of Scala.js to support wasm component model).</p>
<p>I'm not sure if this is the only case, but the error occurs at least when we try to set an <code>i31</code> value (converted from i32 with the MSB has 1) to an <code>anyref</code> struct field.</p>
<div class="codehilite" data-code-language="WebAssembly"><pre><span></span><code><span class="p">(</span><span class="k">module</span>
  <span class="p">(</span><span class="k">type</span> <span class="nv">$c.scala.Tuple1</span> <span class="p">(</span><span class="err">sub</span> <span class="p">(</span><span class="err">struct</span>
    <span class="p">(</span><span class="err">field</span> <span class="nv">$f.scala.Tuple1._1</span> <span class="p">(</span><span class="k">mut</span> <span class="err">anyref</span><span class="p">)))))</span>

  <span class="p">(</span><span class="k">func</span> <span class="p">(</span><span class="k">export</span> <span class="s2">"test"</span><span class="p">)</span>
    <span class="p">(</span><span class="k">local</span> <span class="nv">$instance</span> <span class="p">(</span><span class="err">ref</span> <span class="nv">$c.scala.Tuple1</span><span class="p">))</span>
    <span class="nb">i32.const</span> <span class="mi">-2</span>
    <span class="err">ref.i</span><span class="mi">31</span>
    <span class="err">struct.new</span> <span class="nv">$c.scala.Tuple1</span>
    <span class="nb">drop</span>
  <span class="p">)</span>
<span class="p">)</span>
</code></pre></div>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>$<span class="w"> </span>wasm-tools<span class="w"> </span>parse<span class="w"> </span>test.wat<span class="w"> </span>-o<span class="w"> </span>test.wasm
$<span class="w"> </span>wasmtime<span class="w"> </span>run<span class="w"> </span>-W<span class="w"> </span><span class="k">function</span>-references,gc<span class="w"> </span>--invoke<span class="w"> </span><span class="nb">test</span><span class="w"> </span>test.wasm
make:<span class="w"> </span>***<span class="w"> </span><span class="o">[</span>run<span class="o">]</span><span class="w"> </span>Illegal<span class="w"> </span>instruction:<span class="w"> </span><span class="m">4</span>
</code></pre></div>
<p>see: <a href="https://github.com/tanishiking/kitchensink/tree/main/wasmtime-illegal-instruction">https://github.com/tanishiking/kitchensink/tree/main/wasmtime-illegal-instruction</a></p>
<p>As @vouillon mentioned, the problem doesn't happen when using the <code>-C collector=null</code> option.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"> </span><span class="o">--</span><span class="n">version</span>
<span class="n">wasmtime</span><span class="w"> </span><span class="mf">29.0.1</span><span class="w"> </span><span class="p">(</span><span class="mi">58282</span><span class="n">df89</span><span class="w"> </span><span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">21</span><span class="p">)</span>
</code></pre></div>
</blockquote>



<a name="500350742"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310181%20%5BGC%5D%20Illegal%20instruction/near/500350742" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310181.20.5BGC.5D.20Illegal.20instruction.html#500350742">(Feb 18 2025 at 09:08)</a>:</h4>
<p>tanishiking edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/10181#issuecomment-2665004815">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10181">issue #10181</a>:</p>
<blockquote>
<p>We encountered an "Illegal Instruction" error in our project (<a href="https://github.com/scala-wasm/scala-wasm/pull/5">scala-wasm</a> fork of Scala.js to support wasm component model).</p>
<p>I'm not sure if this is the only case, but the error occurs at least when we try to set an <code>i31</code> value (converted from i32 with the MSB has 1) to an <code>anyref</code> struct field.</p>
<div class="codehilite" data-code-language="WebAssembly"><pre><span></span><code><span class="p">(</span><span class="k">module</span>
  <span class="p">(</span><span class="k">type</span> <span class="nv">$c.scala.Tuple1</span> <span class="p">(</span><span class="err">sub</span> <span class="p">(</span><span class="err">struct</span>
    <span class="p">(</span><span class="err">field</span> <span class="nv">$f.scala.Tuple1._1</span> <span class="p">(</span><span class="k">mut</span> <span class="err">anyref</span><span class="p">)))))</span>

  <span class="p">(</span><span class="k">func</span> <span class="p">(</span><span class="k">export</span> <span class="s2">"test"</span><span class="p">)</span>
    <span class="p">(</span><span class="k">local</span> <span class="nv">$instance</span> <span class="p">(</span><span class="err">ref</span> <span class="nv">$c.scala.Tuple1</span><span class="p">))</span>
    <span class="nb">i32.const</span> <span class="mi">-2</span>
    <span class="err">ref.i</span><span class="mi">31</span>
    <span class="err">struct.new</span> <span class="nv">$c.scala.Tuple1</span>
    <span class="nb">drop</span>
  <span class="p">)</span>
<span class="p">)</span>
</code></pre></div>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>$<span class="w"> </span>wasm-tools<span class="w"> </span>parse<span class="w"> </span>test.wat<span class="w"> </span>-o<span class="w"> </span>test.wasm
$<span class="w"> </span>wasmtime<span class="w"> </span>run<span class="w"> </span>-W<span class="w"> </span><span class="k">function</span>-references,gc<span class="w"> </span>--invoke<span class="w"> </span><span class="nb">test</span><span class="w"> </span>test.wasm
make:<span class="w"> </span>***<span class="w"> </span><span class="o">[</span>run<span class="o">]</span><span class="w"> </span>Illegal<span class="w"> </span>instruction:<span class="w"> </span><span class="m">4</span>
</code></pre></div>
<p>see: <a href="https://github.com/tanishiking/kitchensink/tree/main/wasmtime-illegal-instruction">https://github.com/tanishiking/kitchensink/tree/main/wasmtime-illegal-instruction</a></p>
<ul>
<li>As @vouillon mentioned, the problem doesn't happen when using the <code>-C collector=null</code> option.</li>
<li>I guess there're other reproductions as well, because I find there's only <code>(ref.i31 (i32.const 0))</code> in @vouillon 's reproduction case.</li>
</ul>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"> </span><span class="o">--</span><span class="n">version</span>
<span class="n">wasmtime</span><span class="w"> </span><span class="mf">29.0.1</span><span class="w"> </span><span class="p">(</span><span class="mi">58282</span><span class="n">df89</span><span class="w"> </span><span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">21</span><span class="p">)</span>
</code></pre></div>
</blockquote>



<a name="500350835"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310181%20%5BGC%5D%20Illegal%20instruction/near/500350835" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310181.20.5BGC.5D.20Illegal.20instruction.html#500350835">(Feb 18 2025 at 09:09)</a>:</h4>
<p>tanishiking edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/10181#issuecomment-2665004815">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10181">issue #10181</a>:</p>
<blockquote>
<p>We encountered an "Illegal Instruction" error in our project (<a href="https://github.com/scala-wasm/scala-wasm/pull/5">scala-wasm</a> fork of Scala.js to support wasm component model).</p>
<p>I'm not sure if this is the only case, but the error occurs at least when we try to set an <code>i31</code> value (converted from i32 with the MSB has 1) to an <code>anyref</code> struct field.</p>
<div class="codehilite" data-code-language="WebAssembly"><pre><span></span><code><span class="p">(</span><span class="k">module</span>
  <span class="p">(</span><span class="k">type</span> <span class="nv">$c.scala.Tuple1</span> <span class="p">(</span><span class="err">sub</span> <span class="p">(</span><span class="err">struct</span>
    <span class="p">(</span><span class="err">field</span> <span class="nv">$f.scala.Tuple1._1</span> <span class="p">(</span><span class="k">mut</span> <span class="err">anyref</span><span class="p">)))))</span>

  <span class="p">(</span><span class="k">func</span> <span class="p">(</span><span class="k">export</span> <span class="s2">"test"</span><span class="p">)</span>
    <span class="p">(</span><span class="k">local</span> <span class="nv">$instance</span> <span class="p">(</span><span class="err">ref</span> <span class="nv">$c.scala.Tuple1</span><span class="p">))</span>
    <span class="nb">i32.const</span> <span class="mi">-1</span>
    <span class="err">ref.i</span><span class="mi">31</span>
    <span class="err">struct.new</span> <span class="nv">$c.scala.Tuple1</span>
    <span class="nb">drop</span>
  <span class="p">)</span>
<span class="p">)</span>
</code></pre></div>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>$<span class="w"> </span>wasm-tools<span class="w"> </span>parse<span class="w"> </span>test.wat<span class="w"> </span>-o<span class="w"> </span>test.wasm
$<span class="w"> </span>wasmtime<span class="w"> </span>run<span class="w"> </span>-W<span class="w"> </span><span class="k">function</span>-references,gc<span class="w"> </span>--invoke<span class="w"> </span><span class="nb">test</span><span class="w"> </span>test.wasm
make:<span class="w"> </span>***<span class="w"> </span><span class="o">[</span>run<span class="o">]</span><span class="w"> </span>Illegal<span class="w"> </span>instruction:<span class="w"> </span><span class="m">4</span>
</code></pre></div>
<p>see: <a href="https://github.com/tanishiking/kitchensink/tree/main/wasmtime-illegal-instruction">https://github.com/tanishiking/kitchensink/tree/main/wasmtime-illegal-instruction</a></p>
<ul>
<li>As @vouillon mentioned, the problem doesn't happen when using the <code>-C collector=null</code> option.</li>
<li>I guess there're other reproductions as well, because I find there's only <code>(ref.i31 (i32.const 0))</code> in @vouillon 's reproduction case.</li>
</ul>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"> </span><span class="o">--</span><span class="n">version</span>
<span class="n">wasmtime</span><span class="w"> </span><span class="mf">29.0.1</span><span class="w"> </span><span class="p">(</span><span class="mi">58282</span><span class="n">df89</span><span class="w"> </span><span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">21</span><span class="p">)</span>
</code></pre></div>
</blockquote>



<a name="500353073"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310181%20%5BGC%5D%20Illegal%20instruction/near/500353073" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310181.20.5BGC.5D.20Illegal.20instruction.html#500353073">(Feb 18 2025 at 09:21)</a>:</h4>
<p>tanishiking edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/10181#issuecomment-2665004815">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10181">issue #10181</a>:</p>
<blockquote>
<p>We encountered an "Illegal Instruction" error in our project (<a href="https://github.com/scala-wasm/scala-wasm/pull/5">scala-wasm</a> fork of Scala.js to support wasm component model).</p>
<p>The error occurs at least when we try to set an <code>i31</code> value (converted from i32 with the MSB has 1) to an <code>anyref</code> struct field.</p>
<div class="codehilite" data-code-language="WebAssembly"><pre><span></span><code><span class="p">(</span><span class="k">module</span>
  <span class="p">(</span><span class="k">type</span> <span class="nv">$c.scala.Tuple1</span> <span class="p">(</span><span class="err">sub</span> <span class="p">(</span><span class="err">struct</span>
    <span class="p">(</span><span class="err">field</span> <span class="nv">$f.scala.Tuple1._1</span> <span class="p">(</span><span class="k">mut</span> <span class="err">anyref</span><span class="p">)))))</span>

  <span class="p">(</span><span class="k">func</span> <span class="p">(</span><span class="k">export</span> <span class="s2">"test"</span><span class="p">)</span>
    <span class="p">(</span><span class="k">local</span> <span class="nv">$instance</span> <span class="p">(</span><span class="err">ref</span> <span class="nv">$c.scala.Tuple1</span><span class="p">))</span>
    <span class="nb">i32.const</span> <span class="mi">-1</span>
    <span class="err">ref.i</span><span class="mi">31</span>
    <span class="err">struct.new</span> <span class="nv">$c.scala.Tuple1</span>
    <span class="nb">drop</span>
  <span class="p">)</span>
<span class="p">)</span>
</code></pre></div>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>$<span class="w"> </span>wasm-tools<span class="w"> </span>parse<span class="w"> </span>test.wat<span class="w"> </span>-o<span class="w"> </span>test.wasm
$<span class="w"> </span>wasmtime<span class="w"> </span>run<span class="w"> </span>-W<span class="w"> </span><span class="k">function</span>-references,gc<span class="w"> </span>--invoke<span class="w"> </span><span class="nb">test</span><span class="w"> </span>test.wasm
make:<span class="w"> </span>***<span class="w"> </span><span class="o">[</span>run<span class="o">]</span><span class="w"> </span>Illegal<span class="w"> </span>instruction:<span class="w"> </span><span class="m">4</span>
</code></pre></div>
<p>see: <a href="https://github.com/tanishiking/kitchensink/tree/main/wasmtime-illegal-instruction">https://github.com/tanishiking/kitchensink/tree/main/wasmtime-illegal-instruction</a></p>
<ul>
<li>As @vouillon mentioned, the problem doesn't happen when using the <code>-C collector=null</code> option.</li>
<li>I guess there're other reproductions as well, because I find there's only <code>(ref.i31 (i32.const 0))</code> in @vouillon 's reproduction case.</li>
</ul>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"> </span><span class="o">--</span><span class="n">version</span>
<span class="n">wasmtime</span><span class="w"> </span><span class="mf">29.0.1</span><span class="w"> </span><span class="p">(</span><span class="mi">58282</span><span class="n">df89</span><span class="w"> </span><span class="mi">2025</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">21</span><span class="p">)</span>
</code></pre></div>
</blockquote>



<a name="501051914"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310181%20%5BGC%5D%20Illegal%20instruction/near/501051914" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310181.20.5BGC.5D.20Illegal.20instruction.html#501051914">(Feb 21 2025 at 08:51)</a>:</h4>
<p>tanishiking <a href="https://github.com/bytecodealliance/wasmtime/issues/10181#issuecomment-2673953316">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10181">issue #10181</a>:</p>
<blockquote>
<p>This particular example <a href="https://github.com/bytecodealliance/wasmtime/issues/10181#issuecomment-2665004815">https://github.com/bytecodealliance/wasmtime/issues/10181#issuecomment-2665004815</a> has fixed in local-built wasmtime  (287e8fb5405a943f67babf08643e23bea449e7bf) <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span> thanks! maybe <a href="https://github.com/bytecodealliance/wasmtime/pull/10091">https://github.com/bytecodealliance/wasmtime/pull/10091</a> was the fix?</p>
<p>but we still hit the <code>Illegal instruction: 4</code> error in larger binary, I'll share it when I could make a bit smaller reproducible example.</p>
</blockquote>



<a name="501052086"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310181%20%5BGC%5D%20Illegal%20instruction/near/501052086" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310181.20.5BGC.5D.20Illegal.20instruction.html#501052086">(Feb 21 2025 at 08:52)</a>:</h4>
<p>tanishiking edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/10181#issuecomment-2673953316">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10181">issue #10181</a>:</p>
<blockquote>
<p>This particular example <a href="https://github.com/bytecodealliance/wasmtime/issues/10181#issuecomment-2665004815">https://github.com/bytecodealliance/wasmtime/issues/10181#issuecomment-2665004815</a> has fixed in local-built wasmtime  (287e8fb5405a943f67babf08643e23bea449e7bf) <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span> not sure what was the fix though.</p>
<p>but we still hit the <code>Illegal instruction: 4</code> error in larger binary, I'll share it when I could make a bit smaller reproducible example.</p>
</blockquote>



<a name="501052116"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310181%20%5BGC%5D%20Illegal%20instruction/near/501052116" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310181.20.5BGC.5D.20Illegal.20instruction.html#501052116">(Feb 21 2025 at 08:52)</a>:</h4>
<p>tanishiking edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/10181#issuecomment-2673953316">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10181">issue #10181</a>:</p>
<blockquote>
<p>This particular example <a href="https://github.com/bytecodealliance/wasmtime/issues/10181#issuecomment-2665004815">https://github.com/bytecodealliance/wasmtime/issues/10181#issuecomment-2665004815</a> has fixed in local-built wasmtime  (287e8fb5405a943f67babf08643e23bea449e7bf) <span aria-label="tada" class="emoji emoji-1f389" role="img" title="tada">:tada:</span> not sure what was the fix though.</p>
<p>We still hit the <code>Illegal instruction: 4</code> error in larger binary, I'll share it when I could make a bit smaller reproducible example.</p>
</blockquote>



<a name="504896953"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2310181%20%5BGC%5D%20Illegal%20instruction/near/504896953" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2310181.20.5BGC.5D.20Illegal.20instruction.html#504896953">(Mar 11 2025 at 16:36)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/issues/10181#issuecomment-2715011157">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/10181">issue #10181</a>:</p>
<blockquote>
<p>@tanishiking could you check whether <a href="https://github.com/bytecodealliance/wasmtime/pull/10371">https://github.com/bytecodealliance/wasmtime/pull/10371</a> fixes the issue locally for you? It fixes illegal instruction faults for me locally (which are the externally visible symptoms of internal debug assertions inside the compiled Wasm code failing). Thanks!</p>
</blockquote>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
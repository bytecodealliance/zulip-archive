<html>
<head><meta charset="utf-8"><title>wasmtime / PR #10477 asm: add `LOCK`-prefixed instructions · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310477.20asm.3A.20add.20.60LOCK.60-prefixed.20instructions.html">wasmtime / PR #10477 asm: add `LOCK`-prefixed instructions</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="508403599"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310477%20asm%3A%20add%20%60LOCK%60-prefixed%20instructions/near/508403599" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310477.20asm.3A.20add.20.60LOCK.60-prefixed.20instructions.html#508403599">(Mar 27 2025 at 00:36)</a>:</h4>
<p>abrown opened <a href="https://github.com/bytecodealliance/wasmtime/pull/10477">PR #10477</a> from <code>abrown:asm-locks</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>These changes add new instructions that add the <code>LOCK</code> prefix. The <code>LOCK</code> prefix is only valid for (1) instruction forms where the destination is a memory operand and (2) instructions in the following set: ADD, ADC, AND, BTC, BTR, BTS, CMPXCHG, CMPXCH8B,<br>
CMPXCHG16B, DEC, INC, NEG, NOT, OR, SBB, SUB, XOR, XADD, and XCHG (not all of which are defined yet). To handle (1) we add a new memory-only operand kind: <code>m{8|16|32|64}</code>.</p>
<p>With new <code>LOCK</code>-prefixed instructions defined, we use them in the ISLE lowering of read-modify-write instructions. The top-level <code>lower.isle</code> lowerings underwent some refactoring to handle the fact that these instructions return a <code>SideEffectNoResult</code> but the lowering rule expects an invalid register to be returned in a <code>Reg</code>-to-<code>InstOutput</code> auto conversion.</p>
</blockquote>



<a name="508403600"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310477%20asm%3A%20add%20%60LOCK%60-prefixed%20instructions/near/508403600" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310477.20asm.3A.20add.20.60LOCK.60-prefixed.20instructions.html#508403600">(Mar 27 2025 at 00:36)</a>:</h4>
<p><strong>abrown</strong> requested <a href="https://github.com/fitzgen">fitzgen</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/10477">PR #10477</a>.</p>



<a name="508403601"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310477%20asm%3A%20add%20%60LOCK%60-prefixed%20instructions/near/508403601" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310477.20asm.3A.20add.20.60LOCK.60-prefixed.20instructions.html#508403601">(Mar 27 2025 at 00:36)</a>:</h4>
<p><strong>abrown</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/10477">PR #10477</a>.</p>



<a name="508403737"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310477%20asm%3A%20add%20%60LOCK%60-prefixed%20instructions/near/508403737" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310477.20asm.3A.20add.20.60LOCK.60-prefixed.20instructions.html#508403737">(Mar 27 2025 at 00:38)</a>:</h4>
<p>abrown submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/10477#pullrequestreview-2718912585">PR review</a>.</p>



<a name="508403738"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310477%20asm%3A%20add%20%60LOCK%60-prefixed%20instructions/near/508403738" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310477.20asm.3A.20add.20.60LOCK.60-prefixed.20instructions.html#508403738">(Mar 27 2025 at 00:38)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/wasmtime/pull/10477#discussion_r2015177181">PR review comment</a>:</p>
<blockquote>
<p>It could be helpful to review this commit separately since it contains all the formatting changes (<code>cargo fmt</code>) and no functional changes.</p>
</blockquote>



<a name="508403832"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310477%20asm%3A%20add%20%60LOCK%60-prefixed%20instructions/near/508403832" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310477.20asm.3A.20add.20.60LOCK.60-prefixed.20instructions.html#508403832">(Mar 27 2025 at 00:39)</a>:</h4>
<p>abrown edited <a href="https://github.com/bytecodealliance/wasmtime/pull/10477#discussion_r2015177181">PR review comment</a>.</p>



<a name="508413584"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310477%20asm%3A%20add%20%60LOCK%60-prefixed%20instructions/near/508413584" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310477.20asm.3A.20add.20.60LOCK.60-prefixed.20instructions.html#508413584">(Mar 27 2025 at 02:14)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/10477#issuecomment-2756284407">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/10477">PR #10477</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @cfallin, @fitzgen</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "cranelift", "cranelift:area:x64", "cranelift:meta", "isle"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>cfallin: isle</li>
<li>fitzgen: isle</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="508422179"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310477%20asm%3A%20add%20%60LOCK%60-prefixed%20instructions/near/508422179" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310477.20asm.3A.20add.20.60LOCK.60-prefixed.20instructions.html#508422179">(Mar 27 2025 at 03:25)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/10477#pullrequestreview-2719365831">PR review</a>.</p>



<a name="508422180"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310477%20asm%3A%20add%20%60LOCK%60-prefixed%20instructions/near/508422180" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310477.20asm.3A.20add.20.60LOCK.60-prefixed.20instructions.html#508422180">(Mar 27 2025 at 03:25)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/10477#discussion_r2015541688">PR review comment</a>:</p>
<blockquote>
<p>Question for this: would it would to have <code>.lock()</code> as a builder on the return value of <code>inst(..)</code> and that would be an indicator that the lock prefix and non-lock prefix would both be generated? That way we wouldn't have to duplicate the opcodes/feature flags and we could bake-in logic that <code>.lock()</code> requires the first operand to be memory</p>
</blockquote>



<a name="508422283"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310477%20asm%3A%20add%20%60LOCK%60-prefixed%20instructions/near/508422283" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310477.20asm.3A.20add.20.60LOCK.60-prefixed.20instructions.html#508422283">(Mar 27 2025 at 03:26)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/10477#pullrequestreview-2719366888">PR review</a>.</p>



<a name="508422284"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310477%20asm%3A%20add%20%60LOCK%60-prefixed%20instructions/near/508422284" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310477.20asm.3A.20add.20.60LOCK.60-prefixed.20instructions.html#508422284">(Mar 27 2025 at 03:26)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/10477#discussion_r2015542391">PR review comment</a>:</p>
<blockquote>
<p>To clarify: I'd want the same generated code as what this PR does today, just with less boilerplate on the definitions here by having <code>.lock()</code> as an agumentation rather than a new set of instructions. It could even internally "expand" somewhere along the way to two instruction values perhaps?</p>
</blockquote>



<a name="508572222"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310477%20asm%3A%20add%20%60LOCK%60-prefixed%20instructions/near/508572222" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310477.20asm.3A.20add.20.60LOCK.60-prefixed.20instructions.html#508572222">(Mar 27 2025 at 16:53)</a>:</h4>
<p>abrown submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/10477#pullrequestreview-2722665121">PR review</a>.</p>



<a name="508572225"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310477%20asm%3A%20add%20%60LOCK%60-prefixed%20instructions/near/508572225" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310477.20asm.3A.20add.20.60LOCK.60-prefixed.20instructions.html#508572225">(Mar 27 2025 at 16:53)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/wasmtime/pull/10477#discussion_r2017143962">PR review comment</a>:</p>
<blockquote>
<p>Yeah, I started with that route but abandoned it due to "too much magic." Right now these definitions have the property that each line here shows up as a generated instruction, and either doing that under the hood with <code>.lock()</code> or alternately setting up a <code>for</code> loop in this file to do the same ends up breaking that simple correspondence. And these new magically-created instructions are actually different enough that, combined with the "new instruction magic," I abandoned that route: they have a new mnemonic (<code>lock_*</code>), they have a new prefix, and--crucially--they only accept memory (not reg-mem) as their destination operand.</p>
<p>The other approach I thought through here was to actually model <code>LOCK</code> as its own separate instruction that would take a <code>Box&lt;LockableInst&gt;</code> or something like that. Intel's manual conceptually treats <code>LOCK</code> as its own instruction, so it made sense from that perspective. And it would have forced me to create some way to integrate hand-crafted instructions, i.e., instructions that we simply implement by hand but somehow get integrated into the auto-generated <code>Inst</code> enum. But ultimately I decided that, because in <code>cranelift-codegen-meta</code> we end up needing new ISLE constructors for any <code>LOCK</code>-prefixed variants, just creating more boilerplate was the simplest and clearest.</p>
</blockquote>



<a name="508862819"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310477%20asm%3A%20add%20%60LOCK%60-prefixed%20instructions/near/508862819" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310477.20asm.3A.20add.20.60LOCK.60-prefixed.20instructions.html#508862819">(Mar 28 2025 at 23:48)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/10477#pullrequestreview-2727072487">PR review</a>:</p>
<blockquote>
<p>LGTM!</p>
</blockquote>



<a name="508864589"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310477%20asm%3A%20add%20%60LOCK%60-prefixed%20instructions/near/508864589" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310477.20asm.3A.20add.20.60LOCK.60-prefixed.20instructions.html#508864589">(Mar 29 2025 at 00:10)</a>:</h4>
<p>fitzgen merged <a href="https://github.com/bytecodealliance/wasmtime/pull/10477">PR #10477</a>.</p>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
<html>
<head><meta charset="utf-8"><title>wasmtime / PR #11707 ci: Cache Rust compilation and cargo... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311707.20ci.3A.20Cache.20Rust.20compilation.20and.20cargo.2E.2E.2E.html">wasmtime / PR #11707 ci: Cache Rust compilation and cargo...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="540081313"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311707%20ci%3A%20Cache%20Rust%20compilation%20and%20cargo.../near/540081313" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311707.20ci.3A.20Cache.20Rust.20compilation.20and.20cargo.2E.2E.2E.html#540081313">(Sep 17 2025 at 18:46)</a>:</h4>
<p>tschneidereit opened <a href="https://github.com/bytecodealliance/wasmtime/pull/11707">PR #11707</a> from <code>tschneidereit:actions-cache</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>I noticed that Wasmtime uses almost no cache for its GitHub Actions workflows. Let's see how well adding a cache for <code>target</code> plus various <code>cargo</code> dirs works.</p>
</blockquote>



<a name="540081315"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311707%20ci%3A%20Cache%20Rust%20compilation%20and%20cargo.../near/540081315" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311707.20ci.3A.20Cache.20Rust.20compilation.20and.20cargo.2E.2E.2E.html#540081315">(Sep 17 2025 at 18:46)</a>:</h4>
<p><strong>tschneidereit</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-default-reviewers">wasmtime-default-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/11707">PR #11707</a>.</p>



<a name="540081317"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311707%20ci%3A%20Cache%20Rust%20compilation%20and%20cargo.../near/540081317" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311707.20ci.3A.20Cache.20Rust.20compilation.20and.20cargo.2E.2E.2E.html#540081317">(Sep 17 2025 at 18:46)</a>:</h4>
<p><strong>tschneidereit</strong> requested <a href="https://github.com/cfallin">cfallin</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/11707">PR #11707</a>.</p>



<a name="540087138"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311707%20ci%3A%20Cache%20Rust%20compilation%20and%20cargo.../near/540087138" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311707.20ci.3A.20Cache.20Rust.20compilation.20and.20cargo.2E.2E.2E.html#540087138">(Sep 17 2025 at 19:20)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/11707#issuecomment-3304273236">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11707">PR #11707</a>:</p>
<blockquote>
<p>Personally I don't think we're a good fit for caching here, so I'm not sure about this. Some concerns I would have are:</p>
<ul>
<li>Right now this is keyed on os + lock file but what exactly is built/cached in a <code>target</code> dir depends on the build itself. That means that as-is there may not be much sharing between builders with whomever wins the race to populate the cache (especially with features in play changing deep in deps). If we were to fully shard the cache based on build then I'd fear we would blow the limits quickly. We have &gt;100 CI entries and with a 10G limit for the whole repo that gives ~100M per cache entry, and a build of Wasmtime is much larger than that.</li>
<li>We don't really need to cache Cargo registry lookups any more AFAIK as it's such a small portion of the build itself.</li>
</ul>
<p>The most plausible route I know of for caching would be something like <code>sccache</code>-level granularity rather than target-dir-granularity, but I also haven't tested out if that would help much. Our slowest builds are mostly emulation of s390x/riscv64 and Windows. Emulation makes sense and Windows is unfortunately just really slow</p>
</blockquote>



<a name="540087627"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311707%20ci%3A%20Cache%20Rust%20compilation%20and%20cargo.../near/540087627" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311707.20ci.3A.20Cache.20Rust.20compilation.20and.20cargo.2E.2E.2E.html#540087627">(Sep 17 2025 at 19:24)</a>:</h4>
<p>tschneidereit updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11707">PR #11707</a>.</p>



<a name="540088094"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311707%20ci%3A%20Cache%20Rust%20compilation%20and%20cargo.../near/540088094" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311707.20ci.3A.20Cache.20Rust.20compilation.20and.20cargo.2E.2E.2E.html#540088094">(Sep 17 2025 at 19:27)</a>:</h4>
<p>tschneidereit <a href="https://github.com/bytecodealliance/wasmtime/pull/11707#issuecomment-3304293663">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11707">PR #11707</a>:</p>
<blockquote>
<p>Yeah, it's possible that this will end up not being worth it: my first attempt shaved about 45 seconds off the build, and that might vary by which job wins the race to creating the cache entry.</p>
<p>I just force-pushed a new version using <a href="https://github.com/Swatinem/rust-cache">https://github.com/Swatinem/rust-cache</a>. We'll see if that does any better at all. If not, the only other thing I can think of is to specifically enable caching for the longest-running jobs and nothing else. Or we'll just close this at that point.</p>
</blockquote>



<a name="540091338"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311707%20ci%3A%20Cache%20Rust%20compilation%20and%20cargo.../near/540091338" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311707.20ci.3A.20Cache.20Rust.20compilation.20and.20cargo.2E.2E.2E.html#540091338">(Sep 17 2025 at 19:48)</a>:</h4>
<p>tschneidereit <a href="https://github.com/bytecodealliance/wasmtime/pull/11707#issuecomment-3304358120">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11707">PR #11707</a>:</p>
<blockquote>
<p>I re-triggered the build with cache seeded, but I'm already pretty certain that this won't help as-is: the job name part of the cache keys for the <code>test-*</code> jobs is abbreviated in a way that makes exactly the longest-running jobs race for creating the cache entry :/</p>
</blockquote>



<a name="540107350"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311707%20ci%3A%20Cache%20Rust%20compilation%20and%20cargo.../near/540107350" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311707.20ci.3A.20Cache.20Rust.20compilation.20and.20cargo.2E.2E.2E.html#540107350">(Sep 17 2025 at 21:45)</a>:</h4>
<p>tschneidereit updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11707">PR #11707</a>.</p>



<a name="540109056"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311707%20ci%3A%20Cache%20Rust%20compilation%20and%20cargo.../near/540109056" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311707.20ci.3A.20Cache.20Rust.20compilation.20and.20cargo.2E.2E.2E.html#540109056">(Sep 17 2025 at 22:03)</a>:</h4>
<p>tschneidereit updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11707">PR #11707</a>.</p>



<a name="540114387"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311707%20ci%3A%20Cache%20Rust%20compilation%20and%20cargo.../near/540114387" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311707.20ci.3A.20Cache.20Rust.20compilation.20and.20cargo.2E.2E.2E.html#540114387">(Sep 17 2025 at 22:56)</a>:</h4>
<p>tschneidereit updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11707">PR #11707</a>.</p>



<a name="540114942"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311707%20ci%3A%20Cache%20Rust%20compilation%20and%20cargo.../near/540114942" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311707.20ci.3A.20Cache.20Rust.20compilation.20and.20cargo.2E.2E.2E.html#540114942">(Sep 17 2025 at 23:01)</a>:</h4>
<p>tschneidereit <a href="https://github.com/bytecodealliance/wasmtime/pull/11707#issuecomment-3304795062">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11707">PR #11707</a>:</p>
<blockquote>
<p>With a switch to only using the cache for the longest-running test job, I think this might work? It seems to reduce CI runtime by about 60-80 seconds, or ~10% or so, which doesn't seem too bad.</p>
<p>The last iteration also only caches dependencies now. With that, a cache entry for Linux is about 340MB, which should hopefully mean that for a full test run we should still stay way under 10GB, and hence shouldn't risk evicting the preexisting, much more long-term stable caches.</p>
</blockquote>



<a name="540115062"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311707%20ci%3A%20Cache%20Rust%20compilation%20and%20cargo.../near/540115062" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311707.20ci.3A.20Cache.20Rust.20compilation.20and.20cargo.2E.2E.2E.html#540115062">(Sep 17 2025 at 23:03)</a>:</h4>
<p>tschneidereit edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/11707#issuecomment-3304795062">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11707">PR #11707</a>:</p>
<blockquote>
<p>With a switch to only using the cache for the longest-running test job, I think this might work? It seems to reduce CI runtime by about 60-80 seconds, or ~10% or so, which doesn't seem too bad.</p>
<p>The last iteration also only caches dependencies now. With that, a cache entry for Linux is about 400MB, which should hopefully mean that for a full test run we should still stay way under 10GB, and hence shouldn't risk evicting the preexisting, much more long-term stable caches.</p>
<p>[Edit: 400MB, not 340MB. I think that doesn't change the calculus though)</p>
</blockquote>



<a name="540482542"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311707%20ci%3A%20Cache%20Rust%20compilation%20and%20cargo.../near/540482542" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311707.20ci.3A.20Cache.20Rust.20compilation.20and.20cargo.2E.2E.2E.html#540482542">(Sep 19 2025 at 15:28)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/11707#issuecomment-3312647802">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11707">PR #11707</a>:</p>
<blockquote>
<p>Could you run <code>prtest:full</code> for this too? I'm not actually sure how many wasmtime-cli builds we do but it would be good to confirm the total size is hopefully well under 10G. Only caching wasmtime-cli seems reasonable since <a href="https://github.com/bytecodealliance/wasmtime/actions/metrics/performance?tab=jobs&amp;filters=workflow_file_name%3Amain.yml">that's our slowest test run</a> mostly, with the one outlier being C API tests on Windows.</p>
<p>Another possible alternative, though, is to configure sccache for the wasmtime-cli test job too. That would I think yield effectively the same speedups with better cache eviction behavior because the cache entries are much more fine-grained.</p>
</blockquote>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
<html>
<head><meta charset="utf-8"><title>wasmtime / issue #11841 Guest debugging: ensure that inst... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311841.20Guest.20debugging.3A.20ensure.20that.20inst.2E.2E.2E.html">wasmtime / issue #11841 Guest debugging: ensure that inst...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="544440929"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311841%20Guest%20debugging%3A%20ensure%20that%20inst.../near/544440929" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311841.20Guest.20debugging.3A.20ensure.20that.20inst.2E.2E.2E.html#544440929">(Oct 13 2025 at 01:11)</a>:</h4>
<p>cfallin opened <a href="https://github.com/bytecodealliance/wasmtime/issues/11841">issue #11841</a>:</p>
<blockquote>
<p>(carried over from <a href="https://github.com/bytecodealliance/wasmtime/pull/11769#discussion_r2412214550">this review discussion</a> on #11769)</p>
<p>Currently, guest-debug instrumentation stores all local/stack values in a stackslot for observability by the debugger. This works well for primitives like integers/floats/vectors, and is fine for GC refs when the GC is not moving (i.e. tracing only observes the roots read-only) because the values also exist elsewhere in the program; but will be a problem once the GC becomes a moving GC.</p>
</blockquote>



<a name="544440930"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311841%20Guest%20debugging%3A%20ensure%20that%20inst.../near/544440930" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311841.20Guest.20debugging.3A.20ensure.20that.20inst.2E.2E.2E.html#544440930">(Oct 13 2025 at 01:11)</a>:</h4>
<p><a href="https://github.com/cfallin">cfallin</a> added the bug label to <a href="https://github.com/bytecodealliance/wasmtime/issues/11841">Issue #11841</a>.</p>



<a name="544440935"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311841%20Guest%20debugging%3A%20ensure%20that%20inst.../near/544440935" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311841.20Guest.20debugging.3A.20ensure.20that.20inst.2E.2E.2E.html#544440935">(Oct 13 2025 at 01:11)</a>:</h4>
<p><a href="https://github.com/cfallin">cfallin</a> removed the bug label from <a href="https://github.com/bytecodealliance/wasmtime/issues/11841">Issue #11841</a>.</p>



<a name="544440936"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311841%20Guest%20debugging%3A%20ensure%20that%20inst.../near/544440936" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311841.20Guest.20debugging.3A.20ensure.20that.20inst.2E.2E.2E.html#544440936">(Oct 13 2025 at 01:11)</a>:</h4>
<p><a href="https://github.com/cfallin">cfallin</a> added the wasmtime:debugging label to <a href="https://github.com/bytecodealliance/wasmtime/issues/11841">Issue #11841</a>.</p>



<a name="544440943"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311841%20Guest%20debugging%3A%20ensure%20that%20inst.../near/544440943" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311841.20Guest.20debugging.3A.20ensure.20that.20inst.2E.2E.2E.html#544440943">(Oct 13 2025 at 01:11)</a>:</h4>
<p><a href="https://github.com/cfallin">cfallin</a> added the wasmtime:ref-types label to <a href="https://github.com/bytecodealliance/wasmtime/issues/11841">Issue #11841</a>.</p>



<a name="544440978"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311841%20Guest%20debugging%3A%20ensure%20that%20inst.../near/544440978" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311841.20Guest.20debugging.3A.20ensure.20that.20inst.2E.2E.2E.html#544440978">(Oct 13 2025 at 01:12)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/issues/11841#issuecomment-3395579075">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11841">issue #11841</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @fitzgen</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "wasmtime:ref-types"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>fitzgen: wasmtime:ref-types</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="544441069"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311841%20Guest%20debugging%3A%20ensure%20that%20inst.../near/544441069" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311841.20Guest.20debugging.3A.20ensure.20that.20inst.2E.2E.2E.html#544441069">(Oct 13 2025 at 01:14)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/11841#issuecomment-3395581142">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11841">issue #11841</a>:</p>
<blockquote>
<p>Now that I write this out, I think actually we need to root GC refs properly in the instrumentation slot; DCE could otherwise remove the parts of the original program that would keep the ref rooted.</p>
</blockquote>



<a name="544600969"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311841%20Guest%20debugging%3A%20ensure%20that%20inst.../near/544600969" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311841.20Guest.20debugging.3A.20ensure.20that.20inst.2E.2E.2E.html#544600969">(Oct 13 2025 at 17:58)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/issues/11841#issuecomment-3398533280">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11841">issue #11841</a>:</p>
<blockquote>
<p>Semi-related to this issue: we could extend <code>ir::UserStackMapEntry</code> to have an opaque, user-defined <code>u32</code> if necessary. Right now, the only way to differentiate different entries is via their type, but if we need to have different kinds of stack map entries that happen to have the same <code>ir::Type</code>, we could use this hypothetical <code>u32</code>.</p>
<p>But actually I think maybe all that is necessary here is to call the same underlying DFG APIs that the safepoints-insertion pass in the frontend does, so that the locals and operand stack slots that exist for the debug instrumentation have associated stack map entries recorded.</p>
</blockquote>



<a name="544611692"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311841%20Guest%20debugging%3A%20ensure%20that%20inst.../near/544611692" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311841.20Guest.20debugging.3A.20ensure.20that.20inst.2E.2E.2E.html#544611692">(Oct 13 2025 at 19:35)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/11841#issuecomment-3398801692">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11841">issue #11841</a>:</p>
<blockquote>
<p>Ah, so I've implemented actual rooting <a href="https://github.com/cfallin/wasmtime/commit/66e650522ea98758c39ea766c6a7906a1949036d">here</a> as part of the draft PR that follows instrumentation; it ended up being simpler to use the frame tables to walk the slots than to try to conmingle the two concepts somehow in the metadata or implementation. That commit has a <code>Fixes #11841</code> that should close this once the followup happens :-)</p>
</blockquote>



<a name="544624176"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311841%20Guest%20debugging%3A%20ensure%20that%20inst.../near/544624176" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311841.20Guest.20debugging.3A.20ensure.20that.20inst.2E.2E.2E.html#544624176">(Oct 13 2025 at 21:41)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/issues/11841#issuecomment-3399148128">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11841">issue #11841</a>:</p>
<blockquote>
<p>That seems like a fair amount of machinery that I think could be replaced by a call to <a href="https://docs.rs/cranelift-codegen/0.124.1/cranelift_codegen/ir/dfg/struct.DataFlowGraph.html#method.append_user_stack_map_entry">https://docs.rs/cranelift-codegen/0.124.1/cranelift_codegen/ir/dfg/struct.DataFlowGraph.html#method.append_user_stack_map_entry</a> at the appropriate places and then we get to reuse the existing stack maps infrastructure? Introducing new FP-indexing and pointer arithmetic and all that seems a bit extra if it isn't actually necessary in this case.</p>
<blockquote>
<p>it ended up being simpler to use the frame tables to walk the slots than to try to conmingle the two concepts somehow in the metadata or implementation.</p>
</blockquote>
<p>I feel like I must be misunderstanding something because I feel that the approach in that commit is the one that is mixing up two concepts: the GC's stack walking now needs to query and interpret two sources of truth (stack map metadata and debug info metadata) to find live GC references on the stack. On the flipside, I would expect that by adding stack map entries for the stack slot offsets that contain live GC refs, we keep one source of truth for stack tracing, and we do not conflate debug info and stack maps. The debugger uses debug info, the GC uses stack maps.</p>
</blockquote>



<a name="544629483"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311841%20Guest%20debugging%3A%20ensure%20that%20inst.../near/544629483" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311841.20Guest.20debugging.3A.20ensure.20that.20inst.2E.2E.2E.html#544629483">(Oct 13 2025 at 22:26)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/11841#issuecomment-3399244193">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11841">issue #11841</a>:</p>
<blockquote>
<p>Ah, it appears that I had misremembered how stackmaps worked -- I had been imagining there was a separate stackslot and I'd have to add some new kind of entry to refer to my stackslot; but indeed not the case, I can refer to any stackslot+offset. I'll update it -- thanks!</p>
</blockquote>



<a name="544875141"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311841%20Guest%20debugging%3A%20ensure%20that%20inst.../near/544875141" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311841.20Guest.20debugging.3A.20ensure.20that.20inst.2E.2E.2E.html#544875141">(Oct 15 2025 at 04:41)</a>:</h4>
<p>cfallin closed <a href="https://github.com/bytecodealliance/wasmtime/issues/11841">issue #11841</a>:</p>
<blockquote>
<p>(carried over from <a href="https://github.com/bytecodealliance/wasmtime/pull/11769#discussion_r2412214550">this review discussion</a> on #11769)</p>
<p>Currently, guest-debug instrumentation stores all local/stack values in a stackslot for observability by the debugger. This works well for primitives like integers/floats/vectors, and is fine for GC refs when the GC is not moving (i.e. tracing only observes the roots read-only) because the values also exist elsewhere in the program; but will be a problem once the GC becomes a moving GC.</p>
</blockquote>



<a name="544875142"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311841%20Guest%20debugging%3A%20ensure%20that%20inst.../near/544875142" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311841.20Guest.20debugging.3A.20ensure.20that.20inst.2E.2E.2E.html#544875142">(Oct 15 2025 at 04:41)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/issues/11841#issuecomment-3404500131">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11841">issue #11841</a>:</p>
<blockquote>
<p>This was closed in #11769.</p>
</blockquote>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
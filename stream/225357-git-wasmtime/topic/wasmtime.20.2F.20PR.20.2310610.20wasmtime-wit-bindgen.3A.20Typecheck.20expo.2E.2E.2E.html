<html>
<head><meta charset="utf-8"><title>wasmtime / PR #10610 wasmtime-wit-bindgen: Typecheck expo... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310610.20wasmtime-wit-bindgen.3A.20Typecheck.20expo.2E.2E.2E.html">wasmtime / PR #10610 wasmtime-wit-bindgen: Typecheck expo...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="513094856"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310610%20wasmtime-wit-bindgen%3A%20Typecheck%20expo.../near/513094856" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310610.20wasmtime-wit-bindgen.3A.20Typecheck.20expo.2E.2E.2E.html#513094856">(Apr 18 2025 at 20:40)</a>:</h4>
<p>pchickey edited <a href="https://github.com/bytecodealliance/wasmtime/pull/10610">PR #10610</a>.</p>



<a name="513096249"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310610%20wasmtime-wit-bindgen%3A%20Typecheck%20expo.../near/513096249" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310610.20wasmtime-wit-bindgen.3A.20Typecheck.20expo.2E.2E.2E.html#513096249">(Apr 18 2025 at 20:53)</a>:</h4>
<p>pchickey updated <a href="https://github.com/bytecodealliance/wasmtime/pull/10610">PR #10610</a>.</p>



<a name="513097166"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310610%20wasmtime-wit-bindgen%3A%20Typecheck%20expo.../near/513097166" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310610.20wasmtime-wit-bindgen.3A.20Typecheck.20expo.2E.2E.2E.html#513097166">(Apr 18 2025 at 21:01)</a>:</h4>
<p>pchickey edited <a href="https://github.com/bytecodealliance/wasmtime/pull/10610">PR #10610</a>:</p>
<blockquote>
<p>Based on #10616.</p>
<p>Currently, in bindgen-emitted component wrappers, the existence of export functions is checked at the construction of the {interface-name}Indices struct, but each export function is only finally typechecked on their invocation in {interface-name}::call_{func-name}.</p>
<p>The goal of this PR is to typecheck component exports at the construction of Indices. This is desirable because it gives a type error as early as possible - when using Indices by way of {interface-name}Pre, this can be performed with only an InstancePre, where the creation of an InstancePre requires only a Component and Linker, and typechecks all of the Component's imports. So, really, this is about getting exports on parity with imports.</p>
<p>Closes #9155 . I've worked around this with ugly hacks in embeddings for 2 different employers now and I'm not about to do it for a third :).</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="513097184"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310610%20wasmtime-wit-bindgen%3A%20Typecheck%20expo.../near/513097184" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310610.20wasmtime-wit-bindgen.3A.20Typecheck.20expo.2E.2E.2E.html#513097184">(Apr 18 2025 at 21:01)</a>:</h4>
<p>pchickey edited <a href="https://github.com/bytecodealliance/wasmtime/pull/10610">PR #10610</a>:</p>
<blockquote>
<p>Based on #10616.</p>
<p>Currently, in bindgen-emitted component wrappers, the existence of export functions is checked at the construction of the {interface-name}Indices struct, but each export function is only finally typechecked on their invocation in {interface-name}::call_{func-name}.</p>
<p>The goal of this PR is to typecheck component exports at the construction of Indices. This is desirable because it gives a type error as early as possible - when using Indices by way of {interface-name}Pre, this can be performed with only an InstancePre, where the creation of an InstancePre requires only a Component and Linker, and typechecks all of the Component's imports. So, really, this is about getting exports on parity with imports.</p>
<p>Closes #9155 . I've worked around this with ugly hacks in embeddings for 2 different employers now and I'm not about to do it for a third.</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="513108570"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310610%20wasmtime-wit-bindgen%3A%20Typecheck%20expo.../near/513108570" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310610.20wasmtime-wit-bindgen.3A.20Typecheck.20expo.2E.2E.2E.html#513108570">(Apr 18 2025 at 23:06)</a>:</h4>
<p>pchickey updated <a href="https://github.com/bytecodealliance/wasmtime/pull/10610">PR #10610</a>.</p>



<a name="513109288"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310610%20wasmtime-wit-bindgen%3A%20Typecheck%20expo.../near/513109288" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310610.20wasmtime-wit-bindgen.3A.20Typecheck.20expo.2E.2E.2E.html#513109288">(Apr 18 2025 at 23:15)</a>:</h4>
<p>pchickey edited <a href="https://github.com/bytecodealliance/wasmtime/pull/10610">PR #10610</a>:</p>
<blockquote>
<p>Based on #10616.</p>
<p>Currently, in bindgen-emitted component wrappers, the existence of export functions is checked at the construction of the {interface-name}Indices struct, but each export function is only finally typechecked on their invocation in {interface-name}::call_{func-name}.</p>
<p>The goal of this PR is to typecheck component exports at the construction of Indices. This is desirable because it gives a type error as early as possible - when using Indices by way of {interface-name}Pre, this can be performed with only an InstancePre, where the creation of an InstancePre requires only a Component and Linker, and typechecks all of the Component's imports. So, really, this is about getting exports on parity with imports.</p>
<p>Closes #9155 . I've worked around this with ugly hacks in embeddings for 2 different employers now and I'm not about to do it for a third.</p>
<h2>Additions to Wasmtime</h2>
<ul>
<li><code>InstancePre</code> now has an additional <code>InstanceType</code> member. The <code>InstanceType</code> represents the type information carried in the <code>Linker</code> used to typecheck all of the <code>InstancePre</code>'s imports. This is accessible by a new accessor <code>instance_type(&amp;self) -&gt; &amp;InstanceType</code>.</li>
<li><code>Instance</code> has a new accessor <code>instance_type(&amp;self, store: impl AsContextMut) -&gt; InstanceType</code>. The store contains all of the information required to construct the InstanceType, so this is just a matter of exposing whats already there.</li>
<li><code>component::types::ComponentFunc</code> has a new method <code>typecheck&lt;Params, Returns&gt;(&amp;self, instance_type: &amp;InstanceType) -&gt; Result&lt;()&gt;</code>. The underlying typecheck performed here is the exact same one performed in <code>Func::typed&lt;Params, Returns&gt;(&amp;self, store: impl AsContextMut) -&gt; Result&lt;()&gt;</code>, except rather than the type information coming out of the store, its provided by the InstanceType.</li>
</ul>
<p>All of these additions are pub interfaces but marked <code>#[doc(hidden)]</code> to make them "internal", because the prior art was that <code>InstanceType</code> and is internal, and there are no other public interfaces for retrieving <code>InstanceType</code> or typechecking, with the sole exception of <code>Func::typed</code>. I think that we should consider making these documented public interfaces, but I'll leave that to a future PR unless requested.</p>
<h2>Changes to wasmtime-wit-bindgen</h2>
<p>This test case demonstates the extent of the changes: <a href="https://github.com/bytecodealliance/wasmtime/pull/10610/files#diff-0b0815115f3addd488fbf1f032466f210b9fcd29ec42f4b4a777e58f80abba16">https://github.com/bytecodealliance/wasmtime/pull/10610/files#diff-0b0815115f3addd488fbf1f032466f210b9fcd29ec42f4b4a777e58f80abba16</a></p>
<ul>
<li>The <code>{Foo}Indicies</code> constructor which is used in the <code>InstancePre</code> path <code>new(&amp;Component) -&gt; Result&lt;Self&gt;</code> now has signature <code>new(&amp;Component, &amp;InstanceType) -&gt; Result&lt;Self&gt;</code> .</li>
<li>The other constructor <code>new_instance(impl AsContextMut, &amp;Instance) -&gt; Result&lt;Self&gt;</code> keeps the same signature, because the combination of an Instance and its store are sufficient to create an InstanceType.</li>
<li>The InstanceType is plumbed through to the common <code>_new</code> internals.</li>
<li>Each place an export index is retrieved for a function, <code>.get_export_index</code> has been substituted out with <code>.get_export</code>, and the returned <code>ComponentItem</code> is checked to be a ComponentItem::ComponentFunc(func), and then <code>func.typecheck</code> is invoked with the type argument corresponding to the <code>TypedFunc</code> type parameters.</li>
</ul>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="513109770"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310610%20wasmtime-wit-bindgen%3A%20Typecheck%20expo.../near/513109770" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310610.20wasmtime-wit-bindgen.3A.20Typecheck.20expo.2E.2E.2E.html#513109770">(Apr 18 2025 at 23:22)</a>:</h4>
<p>pchickey edited <a href="https://github.com/bytecodealliance/wasmtime/pull/10610">PR #10610</a>:</p>
<blockquote>
<p>Based on #10616.</p>
<p>Currently, in bindgen-emitted component wrappers, the existence of export functions is checked at the construction of the {interface-name}Indices struct, but each export function is only finally typechecked on their invocation in {interface-name}::call_{func-name}.</p>
<p>The goal of this PR is to typecheck component exports at the construction of Indices. This is desirable because it gives a type error as early as possible - when using Indices by way of {interface-name}Pre, this can be performed with only an InstancePre, where the creation of an InstancePre requires only a Component and Linker, and typechecks all of the Component's imports. So, really, this is about getting exports on parity with imports.</p>
<p>Closes #9155 . I've worked around this with ugly hacks in embeddings for 2 different employers now and I'm not about to do it for a third.</p>
<h2>Additions to Wasmtime</h2>
<ul>
<li><code>InstancePre</code> now has an additional <code>InstanceType</code> member. The <code>InstanceType</code> represents the type information carried in the <code>Linker</code> used to typecheck all of the <code>InstancePre</code>'s imports. This is accessible by a new accessor <code>instance_type(&amp;self) -&gt; &amp;InstanceType</code>.</li>
<li><code>Instance</code> has a new accessor <code>instance_type(&amp;self, store: impl AsContextMut) -&gt; InstanceType</code>. The store contains all of the information required to construct the InstanceType, so this is just a matter of exposing whats already there.</li>
<li><code>component::types::ComponentFunc</code> has a new method <code>typecheck&lt;Params, Returns&gt;(&amp;self, instance_type: &amp;InstanceType) -&gt; Result&lt;()&gt;</code>. The underlying typecheck performed here is the exact same one performed in <code>Func::typed&lt;Params, Returns&gt;(&amp;self, store: impl AsContextMut) -&gt; Result&lt;()&gt;</code>, except rather than the type information coming out of the store, its provided by the InstanceType.</li>
</ul>
<p>All of these additions are pub interfaces but marked <code>#[doc(hidden)]</code> to make them "internal", because the prior art was that <code>InstanceType</code> and is internal, and there are no other public interfaces for retrieving <code>InstanceType</code> or typechecking, with the sole exception of <code>Func::typed</code>. I think that we should consider making these documented public interfaces, but I'll leave that to a future PR unless requested.</p>
<h2>Changes to wasmtime-wit-bindgen</h2>
<p>This test case demonstates the extent of the changes: <a href="https://github.com/bytecodealliance/wasmtime/pull/10610/files#diff-0b0815115f3addd488fbf1f032466f210b9fcd29ec42f4b4a777e58f80abba16">https://github.com/bytecodealliance/wasmtime/pull/10610/files#diff-0b0815115f3addd488fbf1f032466f210b9fcd29ec42f4b4a777e58f80abba16</a></p>
<ul>
<li>The <code>{Foo}Indicies</code> constructor which is used in the <code>InstancePre</code> path <code>new(&amp;Component) -&gt; Result&lt;Self&gt;</code> now has signature <code>new(&amp;Component, &amp;InstanceType) -&gt; Result&lt;Self&gt;</code> .</li>
<li>The other constructor <code>new_instance(impl AsContextMut, &amp;Instance) -&gt; Result&lt;Self&gt;</code> keeps the same signature, because the combination of an Instance and its store are sufficient to create an InstanceType.</li>
<li>The InstanceType is plumbed through to the common <code>_new</code> internals.</li>
<li>Each place an export index is retrieved for a function, <code>.get_export_index</code> has been substituted out with <code>.get_export</code>, and the returned <code>ComponentItem</code> is checked to be a ComponentItem::ComponentFunc(func), and then <code>func.typecheck</code> is invoked with the type argument corresponding to the <code>TypedFunc</code> type parameters.</li>
</ul>
<h2>Future work</h2>
<p>Each export func is typechecked again in its bindgen <code>call_{funcname}</code> function, in which the <code>Func</code> member owned by the typed instance <code>{Foo}</code> struct is cast to a <code>TypedFunc</code> with the specific type parameters bindgen keeps track of for each func. Since the <code>{Foo}</code> struct is created from a <code>{Foo}Indices</code>, we can guarantee that the export funcs have been typechecked against a given <code>Linker</code> or <code>Store</code>, so we could potentially elide the repeated typecheck there, and make an unchecked cast to TypedFunc instead. (TypedFuncs are not stored in the <code>{Foo}</code> struct at least in part because their type parameters may use <code>&amp;'a ...</code> which only apply to the site of the call, and not to the storage of that member in <code>{Foo}</code>. The <code>for&lt;'a&gt;</code> trick only works for trait objects, not concrete types like TypedFunc.)</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="513109813"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310610%20wasmtime-wit-bindgen%3A%20Typecheck%20expo.../near/513109813" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310610.20wasmtime-wit-bindgen.3A.20Typecheck.20expo.2E.2E.2E.html#513109813">(Apr 18 2025 at 23:23)</a>:</h4>
<p><strong>pchickey</strong> has marked <a href="https://github.com/bytecodealliance/wasmtime/pull/10610">PR #10610</a> as ready for review.</p>



<a name="513109814"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310610%20wasmtime-wit-bindgen%3A%20Typecheck%20expo.../near/513109814" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310610.20wasmtime-wit-bindgen.3A.20Typecheck.20expo.2E.2E.2E.html#513109814">(Apr 18 2025 at 23:23)</a>:</h4>
<p><strong>pchickey</strong> requested <a href="https://github.com/dicej">dicej</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/10610">PR #10610</a>.</p>



<a name="513109816"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310610%20wasmtime-wit-bindgen%3A%20Typecheck%20expo.../near/513109816" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310610.20wasmtime-wit-bindgen.3A.20Typecheck.20expo.2E.2E.2E.html#513109816">(Apr 18 2025 at 23:23)</a>:</h4>
<p><strong>pchickey</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers">wasmtime-core-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/10610">PR #10610</a>.</p>



<a name="513110250"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310610%20wasmtime-wit-bindgen%3A%20Typecheck%20expo.../near/513110250" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310610.20wasmtime-wit-bindgen.3A.20Typecheck.20expo.2E.2E.2E.html#513110250">(Apr 18 2025 at 23:29)</a>:</h4>
<p>pchickey edited <a href="https://github.com/bytecodealliance/wasmtime/pull/10610">PR #10610</a>:</p>
<blockquote>
<p>Based on #10616.</p>
<p>Currently, in bindgen-emitted component wrappers, the existence of export functions is checked at the construction of the {interface-name}Indices struct, but each export function is only finally typechecked on their invocation in {interface-name}::call_{func-name}.</p>
<p>The goal of this PR is to typecheck component exports at the construction of Indices. This is desirable because it gives a type error as early as possible - when using {interface-name}Indices by way of {interface-name}Pre, this can be performed with only an InstancePre, where the creation of an InstancePre requires only a Component and Linker, and typechecks all of the Component's imports. So, really, this is about getting exports on parity with imports.</p>
<p>Closes #9155 . I've worked around this with ugly hacks in embeddings for 2 different employers now and I'm not about to do it for a third.</p>
<h2>Additions to Wasmtime</h2>
<ul>
<li><code>InstancePre</code> now has an additional <code>InstanceType</code> member. The <code>InstanceType</code> represents the type information carried in the <code>Linker</code> used to typecheck all of the <code>InstancePre</code>'s imports. This is accessible by a new accessor <code>instance_type(&amp;self) -&gt; &amp;InstanceType</code>.</li>
<li><code>Instance</code> has a new accessor <code>instance_type(&amp;self, store: impl AsContextMut) -&gt; InstanceType</code>. The store contains all of the information required to construct the InstanceType, so this is just a matter of exposing whats already there.</li>
<li><code>component::types::ComponentFunc</code> has a new method <code>typecheck&lt;Params, Returns&gt;(&amp;self, instance_type: &amp;InstanceType) -&gt; Result&lt;()&gt;</code>. The underlying typecheck performed here is the exact same one performed in <code>Func::typed&lt;Params, Returns&gt;(&amp;self, store: impl AsContextMut) -&gt; Result&lt;()&gt;</code>, except rather than the type information coming out of the store, its provided by the InstanceType.</li>
</ul>
<p>All of these additions are pub interfaces but marked <code>#[doc(hidden)]</code> to make them "internal", because the prior art was that <code>InstanceType</code> and is internal, and there are no other public interfaces for retrieving <code>InstanceType</code> or typechecking, with the sole exception of <code>Func::typed</code>. I think that we should consider making these documented public interfaces, but I'll leave that to a future PR unless requested.</p>
<h2>Changes to wasmtime-wit-bindgen</h2>
<p>This test case demonstates the extent of the changes: <a href="https://github.com/bytecodealliance/wasmtime/pull/10610/files#diff-0b0815115f3addd488fbf1f032466f210b9fcd29ec42f4b4a777e58f80abba16">https://github.com/bytecodealliance/wasmtime/pull/10610/files#diff-0b0815115f3addd488fbf1f032466f210b9fcd29ec42f4b4a777e58f80abba16</a></p>
<ul>
<li>The <code>{Foo}Indicies</code> constructor which is used in the <code>InstancePre</code> path <code>new(&amp;Component) -&gt; Result&lt;Self&gt;</code> now has signature <code>new(&amp;Component, &amp;InstanceType) -&gt; Result&lt;Self&gt;</code> .</li>
<li>The other constructor <code>new_instance(impl AsContextMut, &amp;Instance) -&gt; Result&lt;Self&gt;</code> keeps the same signature, because the combination of an Instance and its store are sufficient to create an InstanceType.</li>
<li>The InstanceType is plumbed through to the common <code>_new</code> internals.</li>
<li>Each place an export index is retrieved for a function, <code>.get_export_index</code> has been substituted out with <code>.get_export</code>, and the returned <code>ComponentItem</code> is checked to be a ComponentItem::ComponentFunc(func), and then <code>func.typecheck</code> is invoked with the type argument corresponding to the <code>TypedFunc</code> type parameters.</li>
</ul>
<h2>Future work</h2>
<p>Each export func is typechecked again in its bindgen <code>call_{funcname}</code> function, in which the <code>Func</code> member owned by the typed instance <code>{Foo}</code> struct is cast to a <code>TypedFunc</code> with the specific type parameters bindgen keeps track of for each func. Since the <code>{Foo}</code> struct is created from a <code>{Foo}Indices</code>, we can guarantee that the export funcs have been typechecked against a given <code>Linker</code> or <code>Store</code>, so we could potentially elide the repeated typecheck there, and make an unchecked cast to TypedFunc instead. (TypedFuncs are not stored in the <code>{Foo}</code> struct at least in part because their type parameters may use <code>&amp;'a ...</code> which only apply to the site of the call, and not to the storage of that member in <code>{Foo}</code>. The <code>for&lt;'a&gt;</code> trick only works for trait objects, not concrete types like TypedFunc.)</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="513408971"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310610%20wasmtime-wit-bindgen%3A%20Typecheck%20expo.../near/513408971" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310610.20wasmtime-wit-bindgen.3A.20Typecheck.20expo.2E.2E.2E.html#513408971">(Apr 21 2025 at 14:22)</a>:</h4>
<p>dicej submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/10610#pullrequestreview-2781356505">PR review</a>.</p>



<a name="513415255"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310610%20wasmtime-wit-bindgen%3A%20Typecheck%20expo.../near/513415255" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310610.20wasmtime-wit-bindgen.3A.20Typecheck.20expo.2E.2E.2E.html#513415255">(Apr 21 2025 at 15:01)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/10610#issuecomment-2818686165">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/10610">PR #10610</a>:</p>
<blockquote>
<p>I'm a bit concerned about <a href="https://github.com/bytecodealliance/wasmtime/pull/10616">https://github.com/bytecodealliance/wasmtime/pull/10616</a> and the cost implications of having more <code>Arc</code>-clones on lifting/lowering paths, and after reading over this more I've got a possibilty which I forget if we already talked about and/or whether you tried, so let me know if I sound like a broken record. Could the various <code>*Indices</code> constructors take a <code>&amp;InstancePre&lt;T&gt;</code> instead of a <code>&amp;Component</code>? That way we could refactor the internals of <code>InstancePre&lt;T&gt;</code> to hold whatever is necessary to cheaply create the <code>InstanceType&lt;T&gt;</code> I think?</p>
</blockquote>



<a name="513415282"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310610%20wasmtime-wit-bindgen%3A%20Typecheck%20expo.../near/513415282" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310610.20wasmtime-wit-bindgen.3A.20Typecheck.20expo.2E.2E.2E.html#513415282">(Apr 21 2025 at 15:01)</a>:</h4>
<p>alexcrichton edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/10610#issuecomment-2818686165">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/10610">PR #10610</a>:</p>
<blockquote>
<p>I'm a bit concerned about <a href="https://github.com/bytecodealliance/wasmtime/pull/10616">https://github.com/bytecodealliance/wasmtime/pull/10616</a> and the cost implications of having more <code>Arc</code>-clones on lifting/lowering paths, and after reading over this more I've got a possibilty which I forget if we already talked about and/or whether you tried, so let me know if I sound like a broken record. Could the various <code>*Indices</code> constructors take a <code>&amp;InstancePre&lt;T&gt;</code> instead of a <code>&amp;Component</code>? That way we could refactor the internals of <code>InstancePre&lt;T&gt;</code> to hold whatever is necessary to cheaply create the <code>InstanceType&lt;'_&gt;</code> I think?</p>
</blockquote>



<a name="513431549"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310610%20wasmtime-wit-bindgen%3A%20Typecheck%20expo.../near/513431549" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310610.20wasmtime-wit-bindgen.3A.20Typecheck.20expo.2E.2E.2E.html#513431549">(Apr 21 2025 at 16:32)</a>:</h4>
<p>pchickey <a href="https://github.com/bytecodealliance/wasmtime/pull/10610#issuecomment-2818970259">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/10610">PR #10610</a>:</p>
<blockquote>
<p>Thanks, I'll explore that now!</p>
</blockquote>



<a name="513466943"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310610%20wasmtime-wit-bindgen%3A%20Typecheck%20expo.../near/513466943" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310610.20wasmtime-wit-bindgen.3A.20Typecheck.20expo.2E.2E.2E.html#513466943">(Apr 21 2025 at 20:41)</a>:</h4>
<p>pchickey updated <a href="https://github.com/bytecodealliance/wasmtime/pull/10610">PR #10610</a>.</p>



<a name="513469484"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310610%20wasmtime-wit-bindgen%3A%20Typecheck%20expo.../near/513469484" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310610.20wasmtime-wit-bindgen.3A.20Typecheck.20expo.2E.2E.2E.html#513469484">(Apr 21 2025 at 21:03)</a>:</h4>
<p>pchickey updated <a href="https://github.com/bytecodealliance/wasmtime/pull/10610">PR #10610</a>.</p>



<a name="513469963"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310610%20wasmtime-wit-bindgen%3A%20Typecheck%20expo.../near/513469963" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310610.20wasmtime-wit-bindgen.3A.20Typecheck.20expo.2E.2E.2E.html#513469963">(Apr 21 2025 at 21:07)</a>:</h4>
<p>pchickey edited <a href="https://github.com/bytecodealliance/wasmtime/pull/10610">PR #10610</a>.</p>



<a name="513470209"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310610%20wasmtime-wit-bindgen%3A%20Typecheck%20expo.../near/513470209" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310610.20wasmtime-wit-bindgen.3A.20Typecheck.20expo.2E.2E.2E.html#513470209">(Apr 21 2025 at 21:09)</a>:</h4>
<p>pchickey edited <a href="https://github.com/bytecodealliance/wasmtime/pull/10610">PR #10610</a>:</p>
<blockquote>
<p>Based on #10616.</p>
<p>Currently, in bindgen-emitted component wrappers, the existence of export functions is checked at the construction of the {interface-name}Indices struct, but each export function is only finally typechecked on their invocation in {interface-name}::call_{func-name}.</p>
<p>The goal of this PR is to typecheck component exports at the construction of Indices. This is desirable because it gives a type error as early as possible - when using {interface-name}Indices by way of {interface-name}Pre, this can be performed with only an InstancePre, where the creation of an InstancePre requires only a Component and Linker, and typechecks all of the Component's imports. So, really, this is about getting exports on parity with imports.</p>
<p>Closes #9155 . I've worked around this with ugly hacks in embeddings for 2 different employers now and I'm not about to do it for a third.</p>
<h2>Addition to Wasmtime</h2>
<p><code>component::types::ComponentFunc</code> has a new method <code>typecheck&lt;Params, Returns&gt;(&amp;self, instance_type: &amp;InstanceType) -&gt; Result&lt;()&gt;</code>. The underlying typecheck performed here is the exact same one performed in <code>Func::typed&lt;Params, Returns&gt;(&amp;self, store: impl AsContextMut) -&gt; Result&lt;()&gt;</code>, except rather than the type information coming out of the store, its provided by the InstanceType.</p>
<p>This addition is a pub interfaces but marked <code>#[doc(hidden)]</code> to make them "internal", because the prior art was that <code>InstanceType</code> and is internal, and there are no other public interfaces for retrieving <code>InstanceType</code> or typechecking, with the sole exception of <code>Func::typed</code>. I think that we should consider making these documented public interfaces, but I'll leave that to a future PR unless requested.</p>
<h2>Changes to wasmtime-wit-bindgen</h2>
<p>This test case demonstates the extent of the changes: <a href="https://github.com/bytecodealliance/wasmtime/pull/10610/files#diff-0b0815115f3addd488fbf1f032466f210b9fcd29ec42f4b4a777e58f80abba16">https://github.com/bytecodealliance/wasmtime/pull/10610/files#diff-0b0815115f3addd488fbf1f032466f210b9fcd29ec42f4b4a777e58f80abba16</a></p>
<ul>
<li>The <code>{Foo}Indicies</code> constructor which is used in the <code>InstancePre</code> path <code>new(&amp;Component) -&gt; Result&lt;Self&gt;</code> now has signature <code>new(&amp;Component, &amp;InstanceType) -&gt; Result&lt;Self&gt;</code> .</li>
<li>The other constructor <code>new_instance(impl AsContextMut, &amp;Instance) -&gt; Result&lt;Self&gt;</code> keeps the same signature, because the combination of an Instance and its store are sufficient to create an InstanceType.</li>
<li>The InstanceType is plumbed through to the common <code>_new</code> internals.</li>
<li>Each place an export index is retrieved for a function, <code>.get_export_index</code> has been substituted out with <code>.get_export</code>, and the returned <code>ComponentItem</code> is checked to be a ComponentItem::ComponentFunc(func), and then <code>func.typecheck</code> is invoked with the type argument corresponding to the <code>TypedFunc</code> type parameters.</li>
</ul>
<h2>Future work</h2>
<p>Each export func is typechecked again in its bindgen <code>call_{funcname}</code> function, in which the <code>Func</code> member owned by the typed instance <code>{Foo}</code> struct is cast to a <code>TypedFunc</code> with the specific type parameters bindgen keeps track of for each func. Since the <code>{Foo}</code> struct is created from a <code>{Foo}Indices</code>, we can guarantee that the export funcs have been typechecked against a given <code>Linker</code> or <code>Store</code>, so we could potentially elide the repeated typecheck there, and make an unchecked cast to TypedFunc instead. (TypedFuncs are not stored in the <code>{Foo}</code> struct at least in part because their type parameters may use <code>&amp;'a ...</code> which only apply to the site of the call, and not to the storage of that member in <code>{Foo}</code>. The <code>for&lt;'a&gt;</code> trick only works for trait objects, not concrete types like TypedFunc.)</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="513471395"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310610%20wasmtime-wit-bindgen%3A%20Typecheck%20expo.../near/513471395" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310610.20wasmtime-wit-bindgen.3A.20Typecheck.20expo.2E.2E.2E.html#513471395">(Apr 21 2025 at 21:18)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/10610#pullrequestreview-2782263404">PR review</a>.</p>



<a name="513471923"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310610%20wasmtime-wit-bindgen%3A%20Typecheck%20expo.../near/513471923" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310610.20wasmtime-wit-bindgen.3A.20Typecheck.20expo.2E.2E.2E.html#513471923">(Apr 21 2025 at 21:23)</a>:</h4>
<p>pchickey edited <a href="https://github.com/bytecodealliance/wasmtime/pull/10610">PR #10610</a>:</p>
<blockquote>
<p>Based on #10616.</p>
<p>Currently, in bindgen-emitted component wrappers, the existence of export functions is checked at the construction of the {interface-name}Indices struct, but each export function is only finally typechecked on their invocation in {interface-name}::call_{func-name}.</p>
<p>The goal of this PR is to typecheck component exports at the construction of Indices. This is desirable because it gives a type error as early as possible - when using {interface-name}Indices by way of {interface-name}Pre, this can be performed with only an InstancePre, where the creation of an InstancePre requires only a Component and Linker, and typechecks all of the Component's imports. So, really, this is about getting exports on parity with imports.</p>
<p>Closes #9155 . I've worked around this with ugly hacks in embeddings for 2 different employers now and I'm not about to do it for a third.</p>
<h2>Addition to Wasmtime</h2>
<p><code>component::types::ComponentFunc</code> has a new method <code>typecheck&lt;Params, Returns&gt;(&amp;self, instance_type: &amp;InstanceType) -&gt; Result&lt;()&gt;</code>. The underlying typecheck performed here is the exact same one performed in <code>Func::typed&lt;Params, Returns&gt;(&amp;self, store: impl AsContextMut) -&gt; Result&lt;()&gt;</code>, except rather than the type information coming out of the store, its provided by the InstanceType.</p>
<p>This addition is a pub interfaces but marked <code>#[doc(hidden)]</code> to make them "internal", because the prior art was that <code>InstanceType</code> and is internal, and there are no other public interfaces for retrieving <code>InstanceType</code> or typechecking, with the sole exception of <code>Func::typed</code>. I think that we should consider making these documented public interfaces, but I'll leave that to a future PR unless requested.</p>
<h2>Changes to wasmtime-wit-bindgen</h2>
<p>The <code>resources-import</code> test case demonstates the extent of the changes: <a href="https://github.com/bytecodealliance/wasmtime/pull/10610/files#diff-0b0815115f3addd488fbf1f032466f210b9fcd29ec42f4b4a777e58f80abba16">https://github.com/bytecodealliance/wasmtime/pull/10610/files#diff-0b0815115f3addd488fbf1f032466f210b9fcd29ec42f4b4a777e58f80abba16</a></p>
<ul>
<li>Since typechecking information is available from the InstancePre (thanks to #10616), we can unify the two variations on constructing an Indices struct: there is now a single constructor <code>fn new&lt;T&gt;(_instance_pre: InstancePre&lt;T&gt;) -&gt; Result&lt;Self&gt;</code>. Deduplicating this eliminates both generated code and complexity in the generator.</li>
<li></li>
<li>
<p>The new sigular constructor uses <code>_instance_pre.component()</code> to lookup exports (both their index and their ComponentItem), and <code>_instance_pre.instance_type()</code> is used to typecheck the export.</p>
</li>
<li>
<p>Each place an export index is retrieved for a function, <code>.get_export_index</code> has been substituted out with <code>.get_export</code>, and the returned <code>ComponentItem</code> is checked to be a ComponentItem::ComponentFunc(func), and then <code>func.typecheck</code> is invoked with the type argument corresponding to the <code>TypedFunc</code> type parameters.</p>
</li>
</ul>
<h2>Future work</h2>
<p>Each export func is typechecked again in its bindgen <code>call_{funcname}</code> function, in which the <code>Func</code> member owned by the typed instance <code>{Foo}</code> struct is cast to a <code>TypedFunc</code> with the specific type parameters bindgen keeps track of for each func. Since the <code>{Foo}</code> struct is created from a <code>{Foo}Indices</code>, we can guarantee that the export funcs have been typechecked against a given <code>Linker</code> or <code>Store</code>, so we could potentially elide the repeated typecheck there, and make an unchecked cast to TypedFunc instead. (TypedFuncs are not stored in the <code>{Foo}</code> struct at least in part because their type parameters may use <code>&amp;'a ...</code> which only apply to the site of the call, and not to the storage of that member in <code>{Foo}</code>. The <code>for&lt;'a&gt;</code> trick only works for trait objects, not concrete types like TypedFunc.)</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="513471951"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310610%20wasmtime-wit-bindgen%3A%20Typecheck%20expo.../near/513471951" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310610.20wasmtime-wit-bindgen.3A.20Typecheck.20expo.2E.2E.2E.html#513471951">(Apr 21 2025 at 21:23)</a>:</h4>
<p>pchickey edited <a href="https://github.com/bytecodealliance/wasmtime/pull/10610">PR #10610</a>:</p>
<blockquote>
<p>Based on #10616.</p>
<p>Currently, in bindgen-emitted component wrappers, the existence of export functions is checked at the construction of the {interface-name}Indices struct, but each export function is only finally typechecked on their invocation in {interface-name}::call_{func-name}.</p>
<p>The goal of this PR is to typecheck component exports at the construction of Indices. This is desirable because it gives a type error as early as possible - when using {interface-name}Indices by way of {interface-name}Pre, this can be performed with only an InstancePre, where the creation of an InstancePre requires only a Component and Linker, and typechecks all of the Component's imports. So, really, this is about getting exports on parity with imports.</p>
<p>Closes #9155 . I've worked around this with ugly hacks in embeddings for 2 different employers now and I'm not about to do it for a third.</p>
<h2>Addition to Wasmtime</h2>
<p><code>component::types::ComponentFunc</code> has a new method <code>typecheck&lt;Params, Returns&gt;(&amp;self, instance_type: &amp;InstanceType) -&gt; Result&lt;()&gt;</code>. The underlying typecheck performed here is the exact same one performed in <code>Func::typed&lt;Params, Returns&gt;(&amp;self, store: impl AsContextMut) -&gt; Result&lt;()&gt;</code>, except rather than the type information coming out of the store, its provided by the InstanceType.</p>
<p>This addition is a pub interfaces but marked <code>#[doc(hidden)]</code> to make them "internal", because the prior art was that <code>InstanceType</code> and is internal, and there are no other public interfaces for retrieving <code>InstanceType</code> or typechecking, with the sole exception of <code>Func::typed</code>. I think that we should consider making these documented public interfaces, but I'll leave that to a future PR unless requested.</p>
<h2>Changes to wasmtime-wit-bindgen</h2>
<p>The <code>resources-import</code> test case demonstates the extent of the changes: <a href="https://github.com/bytecodealliance/wasmtime/pull/10610/files#diff-0b0815115f3addd488fbf1f032466f210b9fcd29ec42f4b4a777e58f80abba16">https://github.com/bytecodealliance/wasmtime/pull/10610/files#diff-0b0815115f3addd488fbf1f032466f210b9fcd29ec42f4b4a777e58f80abba16</a></p>
<ul>
<li>Since typechecking information is available from the InstancePre (thanks to #10616), we can unify the two variations on constructing an Indices struct: there is now a single constructor <code>fn new&lt;T&gt;(_instance_pre: InstancePre&lt;T&gt;) -&gt; Result&lt;Self&gt;</code>. Deduplicating this eliminates both generated code and complexity in the generator.</li>
<li>The new sigular constructor uses <code>_instance_pre.component()</code> to lookup exports (both their index and their ComponentItem), and <code>_instance_pre.instance_type()</code> is used to typecheck the export.</li>
<li>Each place an export index is retrieved for a function, <code>.get_export_index</code> has been substituted out with <code>.get_export</code>, and the returned <code>ComponentItem</code> is checked to be a ComponentItem::ComponentFunc(func), and then <code>func.typecheck</code> is invoked with the type argument corresponding to the <code>TypedFunc</code> type parameters.</li>
</ul>
<h2>Future work</h2>
<p>Each export func is typechecked again in its bindgen <code>call_{funcname}</code> function, in which the <code>Func</code> member owned by the typed instance <code>{Foo}</code> struct is cast to a <code>TypedFunc</code> with the specific type parameters bindgen keeps track of for each func. Since the <code>{Foo}</code> struct is created from a <code>{Foo}Indices</code>, we can guarantee that the export funcs have been typechecked against a given <code>Linker</code> or <code>Store</code>, so we could potentially elide the repeated typecheck there, and make an unchecked cast to TypedFunc instead. (TypedFuncs are not stored in the <code>{Foo}</code> struct at least in part because their type parameters may use <code>&amp;'a ...</code> which only apply to the site of the call, and not to the storage of that member in <code>{Foo}</code>. The <code>for&lt;'a&gt;</code> trick only works for trait objects, not concrete types like TypedFunc.)</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="513471986"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310610%20wasmtime-wit-bindgen%3A%20Typecheck%20expo.../near/513471986" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310610.20wasmtime-wit-bindgen.3A.20Typecheck.20expo.2E.2E.2E.html#513471986">(Apr 21 2025 at 21:23)</a>:</h4>
<p>pchickey edited <a href="https://github.com/bytecodealliance/wasmtime/pull/10610">PR #10610</a>:</p>
<blockquote>
<p>Based on #10621</p>
<p>Currently, in bindgen-emitted component wrappers, the existence of export functions is checked at the construction of the {interface-name}Indices struct, but each export function is only finally typechecked on their invocation in {interface-name}::call_{func-name}.</p>
<p>The goal of this PR is to typecheck component exports at the construction of Indices. This is desirable because it gives a type error as early as possible - when using {interface-name}Indices by way of {interface-name}Pre, this can be performed with only an InstancePre, where the creation of an InstancePre requires only a Component and Linker, and typechecks all of the Component's imports. So, really, this is about getting exports on parity with imports.</p>
<p>Closes #9155 . I've worked around this with ugly hacks in embeddings for 2 different employers now and I'm not about to do it for a third.</p>
<h2>Addition to Wasmtime</h2>
<p><code>component::types::ComponentFunc</code> has a new method <code>typecheck&lt;Params, Returns&gt;(&amp;self, instance_type: &amp;InstanceType) -&gt; Result&lt;()&gt;</code>. The underlying typecheck performed here is the exact same one performed in <code>Func::typed&lt;Params, Returns&gt;(&amp;self, store: impl AsContextMut) -&gt; Result&lt;()&gt;</code>, except rather than the type information coming out of the store, its provided by the InstanceType.</p>
<p>This addition is a pub interfaces but marked <code>#[doc(hidden)]</code> to make them "internal", because the prior art was that <code>InstanceType</code> and is internal, and there are no other public interfaces for retrieving <code>InstanceType</code> or typechecking, with the sole exception of <code>Func::typed</code>. I think that we should consider making these documented public interfaces, but I'll leave that to a future PR unless requested.</p>
<h2>Changes to wasmtime-wit-bindgen</h2>
<p>The <code>resources-import</code> test case demonstates the extent of the changes: <a href="https://github.com/bytecodealliance/wasmtime/pull/10610/files#diff-0b0815115f3addd488fbf1f032466f210b9fcd29ec42f4b4a777e58f80abba16">https://github.com/bytecodealliance/wasmtime/pull/10610/files#diff-0b0815115f3addd488fbf1f032466f210b9fcd29ec42f4b4a777e58f80abba16</a></p>
<ul>
<li>Since typechecking information is available from the InstancePre (thanks to #10621), we can unify the two variations on constructing an Indices struct: there is now a single constructor <code>fn new&lt;T&gt;(_instance_pre: InstancePre&lt;T&gt;) -&gt; Result&lt;Self&gt;</code>. Deduplicating this eliminates both generated code and complexity in the generator.</li>
<li>The new sigular constructor uses <code>_instance_pre.component()</code> to lookup exports (both their index and their ComponentItem), and <code>_instance_pre.instance_type()</code> is used to typecheck the export.</li>
<li>Each place an export index is retrieved for a function, <code>.get_export_index</code> has been substituted out with <code>.get_export</code>, and the returned <code>ComponentItem</code> is checked to be a ComponentItem::ComponentFunc(func), and then <code>func.typecheck</code> is invoked with the type argument corresponding to the <code>TypedFunc</code> type parameters.</li>
</ul>
<h2>Future work</h2>
<p>Each export func is typechecked again in its bindgen <code>call_{funcname}</code> function, in which the <code>Func</code> member owned by the typed instance <code>{Foo}</code> struct is cast to a <code>TypedFunc</code> with the specific type parameters bindgen keeps track of for each func. Since the <code>{Foo}</code> struct is created from a <code>{Foo}Indices</code>, we can guarantee that the export funcs have been typechecked against a given <code>Linker</code> or <code>Store</code>, so we could potentially elide the repeated typecheck there, and make an unchecked cast to TypedFunc instead. (TypedFuncs are not stored in the <code>{Foo}</code> struct at least in part because their type parameters may use <code>&amp;'a ...</code> which only apply to the site of the call, and not to the storage of that member in <code>{Foo}</code>. The <code>for&lt;'a&gt;</code> trick only works for trait objects, not concrete types like TypedFunc.)</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="513472065"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310610%20wasmtime-wit-bindgen%3A%20Typecheck%20expo.../near/513472065" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310610.20wasmtime-wit-bindgen.3A.20Typecheck.20expo.2E.2E.2E.html#513472065">(Apr 21 2025 at 21:24)</a>:</h4>
<p>pchickey <a href="https://github.com/bytecodealliance/wasmtime/pull/10610#issuecomment-2819535602">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/10610">PR #10610</a>:</p>
<blockquote>
<p>I addressed the concerns above and rewrote the description accordingly.</p>
</blockquote>



<a name="513473690"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310610%20wasmtime-wit-bindgen%3A%20Typecheck%20expo.../near/513473690" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310610.20wasmtime-wit-bindgen.3A.20Typecheck.20expo.2E.2E.2E.html#513473690">(Apr 21 2025 at 21:38)</a>:</h4>
<p>pchickey edited <a href="https://github.com/bytecodealliance/wasmtime/pull/10610">PR #10610</a>.</p>



<a name="513473990"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310610%20wasmtime-wit-bindgen%3A%20Typecheck%20expo.../near/513473990" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310610.20wasmtime-wit-bindgen.3A.20Typecheck.20expo.2E.2E.2E.html#513473990">(Apr 21 2025 at 21:40)</a>:</h4>
<p>pchickey updated <a href="https://github.com/bytecodealliance/wasmtime/pull/10610">PR #10610</a>.</p>



<a name="513474003"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310610%20wasmtime-wit-bindgen%3A%20Typecheck%20expo.../near/513474003" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310610.20wasmtime-wit-bindgen.3A.20Typecheck.20expo.2E.2E.2E.html#513474003">(Apr 21 2025 at 21:40)</a>:</h4>
<p>pchickey has enabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/10610">PR #10610</a>.</p>



<a name="513477879"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310610%20wasmtime-wit-bindgen%3A%20Typecheck%20expo.../near/513477879" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310610.20wasmtime-wit-bindgen.3A.20Typecheck.20expo.2E.2E.2E.html#513477879">(Apr 21 2025 at 22:16)</a>:</h4>
<p>pchickey merged <a href="https://github.com/bytecodealliance/wasmtime/pull/10610">PR #10610</a>.</p>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
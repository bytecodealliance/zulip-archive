<html>
<head><meta charset="utf-8"><title>wasmtime / PR #11115 x64: migrate many AVX instructions · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311115.20x64.3A.20migrate.20many.20AVX.20instructions.html">wasmtime / PR #11115 x64: migrate many AVX instructions</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="525412264"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311115%20x64%3A%20migrate%20many%20AVX%20instructions/near/525412264" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311115.20x64.3A.20migrate.20many.20AVX.20instructions.html#525412264">(Jun 23 2025 at 21:50)</a>:</h4>
<p>abrown opened <a href="https://github.com/bytecodealliance/wasmtime/pull/11115">PR #11115</a> from <code>abrown:asm-xmm-rmir-vex</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>This migration of AVX instructions to use the new assembler is intended to be a large but quite mechanical conversion of all instructions that fit within the <code>Inst::XmmRmiRVex</code> variant. Unfortunately, three unimplemented SSE instructions (<code>vpmaddwd</code>, <code>vpmaddubsw</code>, <code>vpshufb</code>) prevent us from fully removing <code>Inst::XmmRmiRVex</code> and its ISLE helper, <code>xmm_rmir_vex</code>; we can remove those later once the SSE versions are implemented.</p>
<p>Beyond small format-related changes in Cranelift to accept the new VEX shapes, the largest change comes in Winch: because of how <code>AvxOpcode</code> was passed around previously, I was forced to create new constructors and refactor various bits. I resisted the temptation to go too far, but I could not resist making some of these constructors more consistent, e.g., using common suffixes (<code>rrr</code>, <code>rri</code>) and moving like instructions closer to each other.</p>
</blockquote>



<a name="525412266"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311115%20x64%3A%20migrate%20many%20AVX%20instructions/near/525412266" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311115.20x64.3A.20migrate.20many.20AVX.20instructions.html#525412266">(Jun 23 2025 at 21:50)</a>:</h4>
<p><strong>abrown</strong> requested <a href="https://github.com/alexcrichton">alexcrichton</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/11115">PR #11115</a>.</p>



<a name="525412267"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311115%20x64%3A%20migrate%20many%20AVX%20instructions/near/525412267" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311115.20x64.3A.20migrate.20many.20AVX.20instructions.html#525412267">(Jun 23 2025 at 21:50)</a>:</h4>
<p><strong>abrown</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/11115">PR #11115</a>.</p>



<a name="525412268"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311115%20x64%3A%20migrate%20many%20AVX%20instructions/near/525412268" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311115.20x64.3A.20migrate.20many.20AVX.20instructions.html#525412268">(Jun 23 2025 at 21:50)</a>:</h4>
<p><strong>abrown</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers">wasmtime-core-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/11115">PR #11115</a>.</p>



<a name="525412825"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311115%20x64%3A%20migrate%20many%20AVX%20instructions/near/525412825" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311115.20x64.3A.20migrate.20many.20AVX.20instructions.html#525412825">(Jun 23 2025 at 21:56)</a>:</h4>
<p>abrown updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11115">PR #11115</a>.</p>



<a name="525416530"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311115%20x64%3A%20migrate%20many%20AVX%20instructions/near/525416530" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311115.20x64.3A.20migrate.20many.20AVX.20instructions.html#525416530">(Jun 23 2025 at 22:39)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/11115#discussion_r2162629972">PR review comment</a>:</p>
<blockquote>
<p>This looks peculiar! This indicates that we might be placing an unnecessary byte which isn't required? Or that the old encoding for these instructions was 1-byte smaller than the encoding from the assembler?</p>
<p>(or maybe a rebase conflict as one of the PRs I landed recently removed some bytes and this might be adding them back in without having rebased on that? unsure)</p>
</blockquote>



<a name="525416531"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311115%20x64%3A%20migrate%20many%20AVX%20instructions/near/525416531" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311115.20x64.3A.20migrate.20many.20AVX.20instructions.html#525416531">(Jun 23 2025 at 22:39)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/11115#discussion_r2162630546">PR review comment</a>:</p>
<blockquote>
<p>To confirm, changing opcodes here is intentional?</p>
</blockquote>



<a name="525416532"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311115%20x64%3A%20migrate%20many%20AVX%20instructions/near/525416532" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311115.20x64.3A.20migrate.20many.20AVX.20instructions.html#525416532">(Jun 23 2025 at 22:39)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/11115#discussion_r2162628215">PR review comment</a>:</p>
<blockquote>
<p>This (and a few below) regressed away from <code>v*</code></p>
</blockquote>



<a name="525416535"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311115%20x64%3A%20migrate%20many%20AVX%20instructions/near/525416535" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311115.20x64.3A.20migrate.20many.20AVX.20instructions.html#525416535">(Jun 23 2025 at 22:39)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11115#pullrequestreview-2951683881">PR review</a>.</p>



<a name="525416536"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311115%20x64%3A%20migrate%20many%20AVX%20instructions/near/525416536" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311115.20x64.3A.20migrate.20many.20AVX.20instructions.html#525416536">(Jun 23 2025 at 22:39)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/11115#discussion_r2162626466">PR review comment</a>:</p>
<blockquote>
<p>Should this (and various others around here) be using <code>*_or_avx</code>?</p>
</blockquote>



<a name="525416537"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311115%20x64%3A%20migrate%20many%20AVX%20instructions/near/525416537" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311115.20x64.3A.20migrate.20many.20AVX.20instructions.html#525416537">(Jun 23 2025 at 22:39)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/11115#discussion_r2162626968">PR review comment</a>:</p>
<blockquote>
<p>Accidental regression from <code>vpsrlq</code> to <code>psrlq</code> I think</p>
</blockquote>



<a name="525771089"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311115%20x64%3A%20migrate%20many%20AVX%20instructions/near/525771089" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311115.20x64.3A.20migrate.20many.20AVX.20instructions.html#525771089">(Jun 25 2025 at 18:49)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/wasmtime/pull/11115#discussion_r2167389588">PR review comment</a>:</p>
<blockquote>
<p>It's a "generate all 1s" situation so I just changed it to the lowest lane version, but I'll change it back.</p>
</blockquote>



<a name="525771090"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311115%20x64%3A%20migrate%20many%20AVX%20instructions/near/525771090" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311115.20x64.3A.20migrate.20many.20AVX.20instructions.html#525771090">(Jun 25 2025 at 18:49)</a>:</h4>
<p>abrown submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11115#pullrequestreview-2959283325">PR review</a>.</p>



<a name="525771168"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311115%20x64%3A%20migrate%20many%20AVX%20instructions/near/525771168" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311115.20x64.3A.20migrate.20many.20AVX.20instructions.html#525771168">(Jun 25 2025 at 18:50)</a>:</h4>
<p>abrown updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11115">PR #11115</a>.</p>



<a name="525777871"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311115%20x64%3A%20migrate%20many%20AVX%20instructions/near/525777871" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311115.20x64.3A.20migrate.20many.20AVX.20instructions.html#525777871">(Jun 25 2025 at 19:43)</a>:</h4>
<p>abrown updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11115">PR #11115</a>.</p>



<a name="525781473"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311115%20x64%3A%20migrate%20many%20AVX%20instructions/near/525781473" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311115.20x64.3A.20migrate.20many.20AVX.20instructions.html#525781473">(Jun 25 2025 at 20:08)</a>:</h4>
<p>abrown submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11115#pullrequestreview-2959510966">PR review</a>.</p>



<a name="525781475"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311115%20x64%3A%20migrate%20many%20AVX%20instructions/near/525781475" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311115.20x64.3A.20migrate.20many.20AVX.20instructions.html#525781475">(Jun 25 2025 at 20:08)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/wasmtime/pull/11115#discussion_r2167536305">PR review comment</a>:</p>
<blockquote>
<p>(referenced above)</p>
</blockquote>



<a name="525781632"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311115%20x64%3A%20migrate%20many%20AVX%20instructions/near/525781632" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311115.20x64.3A.20migrate.20many.20AVX.20instructions.html#525781632">(Jun 25 2025 at 20:09)</a>:</h4>
<p>abrown submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11115#pullrequestreview-2959513157">PR review</a>.</p>



<a name="525781633"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311115%20x64%3A%20migrate%20many%20AVX%20instructions/near/525781633" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311115.20x64.3A.20migrate.20many.20AVX.20instructions.html#525781633">(Jun 25 2025 at 20:09)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/wasmtime/pull/11115#discussion_r2167537781">PR review comment</a>:</p>
<blockquote>
<p>Ok, looking at this again, I think we should just accept this (like you were pointing out when we talked). This is coming because this PR switched the order of the operands as it lowered the instruction and I think this operand swap makes more sense. Take a look at the constructor I tagged below: we pass <code>src1</code> and <code>src2</code> in the order one would expect. I'm just going to leave this.</p>
</blockquote>



<a name="525781833"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311115%20x64%3A%20migrate%20many%20AVX%20instructions/near/525781833" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311115.20x64.3A.20migrate.20many.20AVX.20instructions.html#525781833">(Jun 25 2025 at 20:10)</a>:</h4>
<p>abrown updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11115">PR #11115</a>.</p>



<a name="525789120"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311115%20x64%3A%20migrate%20many%20AVX%20instructions/near/525789120" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311115.20x64.3A.20migrate.20many.20AVX.20instructions.html#525789120">(Jun 25 2025 at 20:57)</a>:</h4>
<p>abrown merged <a href="https://github.com/bytecodealliance/wasmtime/pull/11115">PR #11115</a>.</p>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
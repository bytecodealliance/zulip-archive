<html>
<head><meta charset="utf-8"><title>wasmtime / issue #11226 Support running tasks for all ins... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311226.20Support.20running.20tasks.20for.20all.20ins.2E.2E.2E.html">wasmtime / issue #11226 Support running tasks for all ins...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="528405705"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311226%20Support%20running%20tasks%20for%20all%20ins.../near/528405705" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311226.20Support.20running.20tasks.20for.20all.20ins.2E.2E.2E.html#528405705">(Jul 11 2025 at 21:00)</a>:</h4>
<p>dicej opened <a href="https://github.com/bytecodealliance/wasmtime/issues/11226">issue #11226</a>:</p>
<blockquote>
<p>Currently, if you have a <code>Store</code> with multiple component instances, you can only run an event loop (via e.g. <code>Instance::run</code>) for one of those instances at a time.  We'd like to remove that restriction and allow all the instances to make progress concurrently.</p>
<p>Note that this will require moving some or all of <code>ConcurrentState</code> out of <code>ComponentInstance</code> and into <code>Store</code>.  In fact, <code>ConcurrentState</code> originally _did_ live in <code>Store</code>; I moved it to <code>ComponentInstance</code> when I discovered that <code>wasmtime-wast</code> reuses the same store to run multiple instances, which caused issues when one of those instances trapped with unfinished tasks still pending and subsequent instances tried to resume those tasks.  If we move that state back into <code>Store</code>, we'll need to take care to avoid such cross-talk (whether due to serial or concurrent use of instances within a single store) by immediately purging any tasks and associated state belonging to a trapped instance.</p>
</blockquote>



<a name="528405706"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311226%20Support%20running%20tasks%20for%20all%20ins.../near/528405706" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311226.20Support.20running.20tasks.20for.20all.20ins.2E.2E.2E.html#528405706">(Jul 11 2025 at 21:00)</a>:</h4>
<p><a href="https://github.com/dicej">dicej</a> added the wasm-proposal:component-model-async label to <a href="https://github.com/bytecodealliance/wasmtime/issues/11226">Issue #11226</a>.</p>



<a name="528406033"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311226%20Support%20running%20tasks%20for%20all%20ins.../near/528406033" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311226.20Support.20running.20tasks.20for.20all.20ins.2E.2E.2E.html#528406033">(Jul 11 2025 at 21:03)</a>:</h4>
<p>dicej edited <a href="https://github.com/bytecodealliance/wasmtime/issues/11226">issue #11226</a>:</p>
<blockquote>
<p>Currently, if you have a <code>Store</code> with multiple component instances, you can only run an event loop (via e.g. <code>Instance::run</code>) for one of those instances at a time.  We'd like to remove that restriction and allow all the instances to make progress concurrently.</p>
<p>Note that this will require moving some or all of <code>ConcurrentState</code> out of <code>ComponentInstance</code> and into <code>Store</code>.  In fact, <code>ConcurrentState</code> originally _did_ live in <code>Store</code>; I moved it to <code>ComponentInstance</code> when I discovered that <code>wasmtime-wast</code> reuses the same store to run multiple instances, which caused issues when one of those instances trapped with unfinished tasks still pending and subsequent instances tried to resume those tasks.  If we move that state back into <code>Store</code>, we'll need to take care to avoid such cross-talk (whether due to serial or concurrent use of instances within a single store) by immediately purging any tasks and associated state belonging to a trapped instance.</p>
<p>This change should additionally allow us to move methods like <code>Instance::{stream,future}</code> to <code>Store[ContextMut]</code> since streams and futures would no longer be instance-specific.  That, in turn, should allow us to remove the <code>Access[or]::instance</code> methods since e.g. host functions would no longer need access to the specific instance they're being called from.</p>
</blockquote>



<a name="528408082"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311226%20Support%20running%20tasks%20for%20all%20ins.../near/528408082" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311226.20Support.20running.20tasks.20for.20all.20ins.2E.2E.2E.html#528408082">(Jul 11 2025 at 21:23)</a>:</h4>
<p>dicej edited <a href="https://github.com/bytecodealliance/wasmtime/issues/11226">issue #11226</a>:</p>
<blockquote>
<p>Currently, if you have a <code>Store</code> with multiple component instances, you can only run an event loop (via e.g. <code>Instance::run</code>) for one of those instances at a time.  We'd like to remove that restriction and allow all the instances to make progress concurrently.</p>
<p>Note that this might require moving some or all of <code>ConcurrentState</code> out of <code>ComponentInstance</code> and into <code>Store</code>.  In fact, <code>ConcurrentState</code> originally _did_ live in <code>Store</code>; I moved it to <code>ComponentInstance</code> when I discovered that <code>wasmtime-wast</code> reuses the same store to run multiple instances, which caused issues when one of those instances trapped with unfinished tasks still pending and subsequent instances tried to resume those tasks.  If we move that state back into <code>Store</code>, we'll need to take care to avoid such cross-talk (whether due to serial or concurrent use of instances within a single store) by immediately purging any tasks and associated state belonging to a trapped instance.</p>
<p>This change should additionally allow us to move methods like <code>Instance::{stream,future}</code> to <code>Store[ContextMut]</code> since streams and futures would no longer be instance-specific.  That, in turn, should allow us to remove the <code>Access[or]::instance</code> methods since e.g. host functions would no longer need access to the specific instance they're being called from.</p>
</blockquote>



<a name="528408147"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311226%20Support%20running%20tasks%20for%20all%20ins.../near/528408147" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311226.20Support.20running.20tasks.20for.20all.20ins.2E.2E.2E.html#528408147">(Jul 11 2025 at 21:24)</a>:</h4>
<p>dicej edited <a href="https://github.com/bytecodealliance/wasmtime/issues/11226">issue #11226</a>:</p>
<blockquote>
<p>Currently, if you have a <code>Store</code> with multiple component instances, you can only run an event loop (via e.g. <code>Instance::run</code>) for one of those instances at a time.  We'd like to remove that restriction and allow all the instances to make progress concurrently.</p>
<p>Note that this will require moving some or all of <code>ConcurrentState</code> out of <code>ComponentInstance</code> and into <code>Store</code>.  In fact, <code>ConcurrentState</code> originally _did_ live in <code>Store</code>; I moved it to <code>ComponentInstance</code> when I discovered that <code>wasmtime-wast</code> reuses the same store to run multiple instances, which caused issues when one of those instances trapped with unfinished tasks still pending and subsequent instances tried to resume those tasks.  If we move that state back into <code>Store</code>, we'll need to take care to avoid such cross-talk (whether due to serial or concurrent use of instances within a single store) by immediately purging any tasks and associated state belonging to a trapped instance.</p>
<p>This change should additionally allow us to move methods like <code>Instance::{stream,future}</code> to <code>Store[ContextMut]</code> since streams and futures would no longer be instance-specific.  That, in turn, should allow us to remove the <code>Access[or]::instance</code> methods since e.g. host functions would no longer need access to the specific instance they're being called from.</p>
</blockquote>



<a name="537527608"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311226%20Support%20running%20tasks%20for%20all%20ins.../near/537527608" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311226.20Support.20running.20tasks.20for.20all.20ins.2E.2E.2E.html#537527608">(Sep 03 2025 at 17:49)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/11226#issuecomment-3250200805">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11226">issue #11226</a>:</p>
<blockquote>
<p>@dicej and I talked about this today and we mostly concluded this is a bit more nuanced than originally anticipated. Our current thinking is:</p>
<ul>
<li>We'll move everything to the <code>Store</code></li>
<li>We'll update <code>wasmtime-wast</code> to make a store-per-component-instance.</li>
</ul>
<p>The basic conclusion we reached is that the main benefit of today's design is that we can conceptually throw away the entirety of all async state when a trap happens. While we don't proactively currently do that all embeddings morally do that and we could in theory start doing it within Wasmtime. Simply applying what this issue says makes this quite complicated because we'd have to either (a) keep concurrent state for all instances separate or (b) keep track of which parts of state in the store map to one instance. Our conclusion was that this probably isn't worth it and we probably want to elevate the "throw the instance state away" to "throw the whole store away". </p>
<p>This requires updating <code>wasmtime-wast</code> though which reuses a store across trapping instances. And this also touches on more component-model level things which we want to discuss with others as well. More updates after meetings next week...</p>
</blockquote>



<a name="538310969"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311226%20Support%20running%20tasks%20for%20all%20ins.../near/538310969" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311226.20Support.20running.20tasks.20for.20all.20ins.2E.2E.2E.html#538310969">(Sep 08 2025 at 20:36)</a>:</h4>
<p>alexcrichton assigned alexcrichton to <a href="https://github.com/bytecodealliance/wasmtime/issues/11226">issue #11226</a>.</p>



<a name="538310970"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311226%20Support%20running%20tasks%20for%20all%20ins.../near/538310970" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311226.20Support.20running.20tasks.20for.20all.20ins.2E.2E.2E.html#538310970">(Sep 08 2025 at 20:36)</a>:</h4>
<p>alexcrichton assigned dicej to <a href="https://github.com/bytecodealliance/wasmtime/issues/11226">issue #11226</a>.</p>



<a name="542313435"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311226%20Support%20running%20tasks%20for%20all%20ins.../near/542313435" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311226.20Support.20running.20tasks.20for.20all.20ins.2E.2E.2E.html#542313435">(Sep 30 2025 at 15:56)</a>:</h4>
<p>dicej edited <a href="https://github.com/bytecodealliance/wasmtime/issues/11226">issue #11226</a>:</p>
<blockquote>
<p>Currently, if you have a <code>Store</code> with multiple component instances, you can only run an event loop (via e.g. <code>Instance::run_concurrent</code>) for one of those instances at a time.  We'd like to remove that restriction and allow all the instances to make progress concurrently.</p>
<p>Note that this will require moving some or all of <code>ConcurrentState</code> out of <code>ComponentInstance</code> and into <code>Store</code>.  In fact, <code>ConcurrentState</code> originally _did_ live in <code>Store</code>; I moved it to <code>ComponentInstance</code> when I discovered that <code>wasmtime-wast</code> reuses the same store to run multiple instances, which caused issues when one of those instances trapped with unfinished tasks still pending and subsequent instances tried to resume those tasks.  If we move that state back into <code>Store</code>, we'll need to take care to avoid such cross-talk (whether due to serial or concurrent use of instances within a single store) by immediately purging any tasks and associated state belonging to a trapped instance.</p>
<p>This change should additionally allow us to move methods like <code>Instance::{stream,future}</code> to <code>Store[ContextMut]</code> since streams and futures would no longer be instance-specific.  That, in turn, should allow us to remove the <code>Access[or]::instance</code> methods since e.g. host functions would no longer need access to the specific instance they're being called from.</p>
</blockquote>



<a name="543400900"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311226%20Support%20running%20tasks%20for%20all%20ins.../near/543400900" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311226.20Support.20running.20tasks.20for.20all.20ins.2E.2E.2E.html#543400900">(Oct 06 2025 at 20:16)</a>:</h4>
<p>dicej closed <a href="https://github.com/bytecodealliance/wasmtime/issues/11226">issue #11226</a>:</p>
<blockquote>
<p>Currently, if you have a <code>Store</code> with multiple component instances, you can only run an event loop (via e.g. <code>Instance::run_concurrent</code>) for one of those instances at a time.  We'd like to remove that restriction and allow all the instances to make progress concurrently.</p>
<p>Note that this will require moving some or all of <code>ConcurrentState</code> out of <code>ComponentInstance</code> and into <code>Store</code>.  In fact, <code>ConcurrentState</code> originally _did_ live in <code>Store</code>; I moved it to <code>ComponentInstance</code> when I discovered that <code>wasmtime-wast</code> reuses the same store to run multiple instances, which caused issues when one of those instances trapped with unfinished tasks still pending and subsequent instances tried to resume those tasks.  If we move that state back into <code>Store</code>, we'll need to take care to avoid such cross-talk (whether due to serial or concurrent use of instances within a single store) by immediately purging any tasks and associated state belonging to a trapped instance.</p>
<p>This change should additionally allow us to move methods like <code>Instance::{stream,future}</code> to <code>Store[ContextMut]</code> since streams and futures would no longer be instance-specific.  That, in turn, should allow us to remove the <code>Access[or]::instance</code> methods since e.g. host functions would no longer need access to the specific instance they're being called from.</p>
</blockquote>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
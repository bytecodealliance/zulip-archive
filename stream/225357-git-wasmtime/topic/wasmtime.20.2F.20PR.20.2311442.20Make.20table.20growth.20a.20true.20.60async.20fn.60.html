<html>
<head><meta charset="utf-8"><title>wasmtime / PR #11442 Make table growth a true `async fn` · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311442.20Make.20table.20growth.20a.20true.20.60async.20fn.60.html">wasmtime / PR #11442 Make table growth a true `async fn`</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="534716763"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311442%20Make%20table%20growth%20a%20true%20%60async%20fn%60/near/534716763" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311442.20Make.20table.20growth.20a.20true.20.60async.20fn.60.html#534716763">(Aug 15 2025 at 21:46)</a>:</h4>
<p>alexcrichton opened <a href="https://github.com/bytecodealliance/wasmtime/pull/11442">PR #11442</a> from <code>alexcrichton:really-start-the-async-journey</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>Upon further refactoring and thinking about #11430 I've realized that we might be able to sidestep <code>T: Send</code> on the store entirely which would be quite the boon if it can be pulled off. The realization I had is that the main reason for this was <code>&amp;mut dyn VMStore</code> on the stack, but that itself is actually a bug in Wasmtime (#11178) and shouldn't be done. The functions which have this on the stack should actually ONLY have the resource limiter, if configured. This means that while the <code>ResourceLimiter{,Async}</code> traits need a <code>Send</code> supertrait that's relatively easy to add without much impact. My hunch is that plumbing this through to the end will enable all the benefits of #11430 without requiring adding <code>T: Send</code> to the store.</p>
<p>This commit starts out on this journey by making table growth a true <code>async fn</code>. A new internal type is added to represent a store's limiter which is plumbed to growth functions. This represents a hierarchy of borrows that look like:</p>
<ul>
<li><code>StoreInner&lt;T&gt;</code><ul>
<li><code>StoreResourceLimiter&lt;'_&gt;</code></li>
<li><code>StoreOpaque</code><ul>
<li><code>Pin&lt;&amp;mut Instance&gt;</code><ul>
<li><code>&amp;mut vm::Table</code></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>This notably, safely, allows operating on <code>vm::Table</code> with a <code>StoreResourceLimiter</code> at the same time. This is exactly what's needed and prevents needing to have <code>&amp;mut dyn VMStore</code>, the previous argument, on the stack.</p>
<p>This refactoring cleans up <code>unsafe</code> blocks in table growth right now which manually uses raw pointers to work around the borrow checker. No more now!</p>
<p>I'll note as well that this is just an incremental step. What I plan on doing next is handling other locations like memory growth, memory allocation, and table allocation. Each of those will require further refactorings to ensure that things like GC are correctly accounted for so they're going to be split into separate PRs. Functionally though this PR should have no impact other than a fiber is no longer required for <code>Table::grow_async</code>.</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="534716765"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311442%20Make%20table%20growth%20a%20true%20%60async%20fn%60/near/534716765" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311442.20Make.20table.20growth.20a.20true.20.60async.20fn.60.html#534716765">(Aug 15 2025 at 21:46)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/pchickey">pchickey</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/11442">PR #11442</a>.</p>



<a name="534716767"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311442%20Make%20table%20growth%20a%20true%20%60async%20fn%60/near/534716767" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311442.20Make.20table.20growth.20a.20true.20.60async.20fn.60.html#534716767">(Aug 15 2025 at 21:46)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers">wasmtime-core-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/11442">PR #11442</a>.</p>



<a name="534718112"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311442%20Make%20table%20growth%20a%20true%20%60async%20fn%60/near/534718112" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311442.20Make.20table.20growth.20a.20true.20.60async.20fn.60.html#534718112">(Aug 15 2025 at 22:03)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11442">PR #11442</a>.</p>



<a name="534997862"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311442%20Make%20table%20growth%20a%20true%20%60async%20fn%60/near/534997862" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311442.20Make.20table.20growth.20a.20true.20.60async.20fn.60.html#534997862">(Aug 18 2025 at 18:01)</a>:</h4>
<p>pchickey submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11442#pullrequestreview-3129378846">PR review</a>.</p>



<a name="535000859"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311442%20Make%20table%20growth%20a%20true%20%60async%20fn%60/near/535000859" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311442.20Make.20table.20growth.20a.20true.20.60async.20fn.60.html#535000859">(Aug 18 2025 at 18:23)</a>:</h4>
<p>alexcrichton merged <a href="https://github.com/bytecodealliance/wasmtime/pull/11442">PR #11442</a>.</p>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
<html>
<head><meta charset="utf-8"><title>wasmtime / PR #11763 support continuing host-to-host stre... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311763.20support.20continuing.20host-to-host.20stre.2E.2E.2E.html">wasmtime / PR #11763 support continuing host-to-host stre...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="542302801"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311763%20support%20continuing%20host-to-host%20stre.../near/542302801" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311763.20support.20continuing.20host-to-host.20stre.2E.2E.2E.html#542302801">(Sep 30 2025 at 15:11)</a>:</h4>
<p><strong>dicej</strong> requested <a href="https://github.com/alexcrichton">alexcrichton</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/11763">PR #11763</a>.</p>



<a name="542302809"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311763%20support%20continuing%20host-to-host%20stre.../near/542302809" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311763.20support.20continuing.20host-to-host.20stre.2E.2E.2E.html#542302809">(Sep 30 2025 at 15:11)</a>:</h4>
<p>dicej opened <a href="https://github.com/bytecodealliance/wasmtime/pull/11763">PR #11763</a> from <code>dicej:fix-11703</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>This addresses #11703 by allowing the embedder to "short-circuit" host-to-host streams and keep them flowing after the guest instance and its store have been disposed.  Besides fixing that bug, it makes common proxy and full-duplex streaming scenarios more efficient by getting the Wasmtime runtime out of the way as early as possible, avoiding the extra memory and indirection overhead which would otherwise be imposed.</p>
<p>See the individual commit messages for details.  Here's a summary:</p>
<ul>
<li>Add <code>StreamReader::try_into</code> for coercing a host-created stream into the <code>StreamProducer</code> implementation (or possibly a subset of it) that was used to create it.  <code>wasmtime-wasi-http</code> now uses this to unmask guest bodies which are really host bodies.</li>
<li>Use <code>tokio::task::spawn</code> instead of <code>Accessor::spawn</code> to handle connection I/O for outgoing <code>wasmtime-wasi-http</code> requests.  This ensures that the connection remains alive after the store is disposed.</li>
</ul>
<p>Note that the implementation of <code>StreamReader::try_into</code> required adding a default-implemented <code>StreamProducer::try_into</code> function for doing the coercion.  The signature of that function is a bit awkward given that we have to erase the types and do runtime downcasts internally.  The upside is that it supports the scenario where the <code>StreamProducer</code> implementation is <code>!Unpin</code> (meaning it cannot be downcasted, AFAICT), in which case it may be coerced into a type representing a relevant subset which is <code>Unpin</code>.</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="542302811"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311763%20support%20continuing%20host-to-host%20stre.../near/542302811" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311763.20support.20continuing.20host-to-host.20stre.2E.2E.2E.html#542302811">(Sep 30 2025 at 15:11)</a>:</h4>
<p><strong>dicej</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-wasi-reviewers">wasmtime-wasi-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/11763">PR #11763</a>.</p>



<a name="542302812"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311763%20support%20continuing%20host-to-host%20stre.../near/542302812" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311763.20support.20continuing.20host-to-host.20stre.2E.2E.2E.html#542302812">(Sep 30 2025 at 15:11)</a>:</h4>
<p><strong>dicej</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers">wasmtime-core-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/11763">PR #11763</a>.</p>



<a name="542302813"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311763%20support%20continuing%20host-to-host%20stre.../near/542302813" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311763.20support.20continuing.20host-to-host.20stre.2E.2E.2E.html#542302813">(Sep 30 2025 at 15:11)</a>:</h4>
<p><strong>dicej</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-default-reviewers">wasmtime-default-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/11763">PR #11763</a>.</p>



<a name="542305678"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311763%20support%20continuing%20host-to-host%20stre.../near/542305678" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311763.20support.20continuing.20host-to-host.20stre.2E.2E.2E.html#542305678">(Sep 30 2025 at 15:23)</a>:</h4>
<p>dicej <a href="https://github.com/bytecodealliance/wasmtime/pull/11763#issuecomment-3352728446">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11763">PR #11763</a>:</p>
<blockquote>
<p>@rvolosatovs you might have opinions about <a href="https://github.com/bytecodealliance/wasmtime/pull/11763/commits/30afd9fa9e2a7adbf768c476a6119851e229ff5b">https://github.com/bytecodealliance/wasmtime/pull/11763/commits/30afd9fa9e2a7adbf768c476a6119851e229ff5b</a></p>
</blockquote>



<a name="542354448"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311763%20support%20continuing%20host-to-host%20stre.../near/542354448" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311763.20support.20continuing.20host-to-host.20stre.2E.2E.2E.html#542354448">(Sep 30 2025 at 19:41)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11763#pullrequestreview-3286455658">PR review</a>.</p>



<a name="542354449"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311763%20support%20continuing%20host-to-host%20stre.../near/542354449" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311763.20support.20continuing.20host-to-host.20stre.2E.2E.2E.html#542354449">(Sep 30 2025 at 19:41)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/11763#discussion_r2392643257">PR review comment</a>:</p>
<blockquote>
<p>This <code>Box::new(*...)</code> shouldn't be necessary I think? In theory <code>Pin::into_inner(me)</code> should suffice here I believe</p>
</blockquote>



<a name="542354451"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311763%20support%20continuing%20host-to-host%20stre.../near/542354451" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311763.20support.20continuing.20host-to-host.20stre.2E.2E.2E.html#542354451">(Sep 30 2025 at 19:41)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/11763#discussion_r2392646819">PR review comment</a>:</p>
<blockquote>
<p>Could this happen during the construction of <code>Response</code> instead of here? Then I believe this would naturally fall through to <code>Body::Host</code> below?</p>
</blockquote>



<a name="542355607"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311763%20support%20continuing%20host-to-host%20stre.../near/542355607" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311763.20support.20continuing.20host-to-host.20stre.2E.2E.2E.html#542355607">(Sep 30 2025 at 19:48)</a>:</h4>
<p>dicej submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11763#pullrequestreview-3286484693">PR review</a>.</p>



<a name="542355609"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311763%20support%20continuing%20host-to-host%20stre.../near/542355609" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311763.20support.20continuing.20host-to-host.20stre.2E.2E.2E.html#542355609">(Sep 30 2025 at 19:48)</a>:</h4>
<p>dicej created <a href="https://github.com/bytecodealliance/wasmtime/pull/11763#discussion_r2392665282">PR review comment</a>:</p>
<blockquote>
<p>The compiler doesn't like that:</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">error</span><span class="p">[</span><span class="n">E0277</span><span class="p">]:</span><span class="w"> </span><span class="err">`</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">any</span><span class="p">::</span><span class="n">Any</span><span class="err">`</span><span class="w"> </span><span class="n">cannot</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">unpinned</span>
<span class="w">   </span><span class="o">-</span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">crates</span><span class="o">/</span><span class="n">wasi</span><span class="o">-</span><span class="n">http</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">p3</span><span class="o">/</span><span class="n">body</span><span class="p">.</span><span class="n">rs</span><span class="p">:</span><span class="mi">543</span><span class="p">:</span><span class="mi">32</span>
<span class="w">    </span><span class="o">|</span>
<span class="mi">543</span><span class="w"> </span><span class="o">|</span><span class="w">             </span><span class="nb">Ok</span><span class="p">(</span><span class="n">Pin</span><span class="p">::</span><span class="n">into_inner</span><span class="p">(</span><span class="n">me</span><span class="p">))</span>
<span class="w">    </span><span class="o">|</span><span class="w">                </span><span class="o">---------------</span><span class="w"> </span><span class="o">^^</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="err">`</span><span class="n">std</span><span class="p">::</span><span class="n">marker</span><span class="p">::</span><span class="nb">Unpin</span><span class="err">`</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">not</span><span class="w"> </span><span class="n">implemented</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="err">`</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">any</span><span class="p">::</span><span class="n">Any</span><span class="err">`</span>
<span class="w">    </span><span class="o">|</span><span class="w">                </span><span class="o">|</span>
<span class="w">    </span><span class="o">|</span><span class="w">                </span><span class="n">required</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">bound</span><span class="w"> </span><span class="n">introduced</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">call</span>
</code></pre></div><br>
</p>
</blockquote>



<a name="542356553"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311763%20support%20continuing%20host-to-host%20stre.../near/542356553" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311763.20support.20continuing.20host-to-host.20stre.2E.2E.2E.html#542356553">(Sep 30 2025 at 19:54)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/11763#discussion_r2392680836">PR review comment</a>:</p>
<blockquote>
<p>Weird! <code>let me = Pin::into_inner(me); Ok(me)</code> works though.</p>
<p>I think it's because it's trying to coerce <code>me: Pin&lt;Box&lt;Self&gt;&gt;</code> into <code>Pin&lt;Box&lt;dyn Any&gt;&gt;</code> and then go through <code>Pin::into_inner</code> to get out the <code>Box&lt;dyn Any&gt;</code> which doesn't work because <code>dyn Any</code> indeed does not implement <code>Unpin</code>. By separating it out it guides inference correctly.</p>
</blockquote>



<a name="542356554"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311763%20support%20continuing%20host-to-host%20stre.../near/542356554" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311763.20support.20continuing.20host-to-host.20stre.2E.2E.2E.html#542356554">(Sep 30 2025 at 19:54)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11763#pullrequestreview-3286505069">PR review</a>.</p>



<a name="542357892"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311763%20support%20continuing%20host-to-host%20stre.../near/542357892" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311763.20support.20continuing.20host-to-host.20stre.2E.2E.2E.html#542357892">(Sep 30 2025 at 20:02)</a>:</h4>
<p>dicej updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11763">PR #11763</a>.</p>



<a name="542357964"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311763%20support%20continuing%20host-to-host%20stre.../near/542357964" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311763.20support.20continuing.20host-to-host.20stre.2E.2E.2E.html#542357964">(Sep 30 2025 at 20:02)</a>:</h4>
<p>dicej submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11763#pullrequestreview-3286536703">PR review</a>.</p>



<a name="542357965"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311763%20support%20continuing%20host-to-host%20stre.../near/542357965" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311763.20support.20continuing.20host-to-host.20stre.2E.2E.2E.html#542357965">(Sep 30 2025 at 20:02)</a>:</h4>
<p>dicej created <a href="https://github.com/bytecodealliance/wasmtime/pull/11763#discussion_r2392702939">PR review comment</a>:</p>
<blockquote>
<p>Good idea; done!</p>
</blockquote>



<a name="542358234"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311763%20support%20continuing%20host-to-host%20stre.../near/542358234" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311763.20support.20continuing.20host-to-host.20stre.2E.2E.2E.html#542358234">(Sep 30 2025 at 20:04)</a>:</h4>
<p>dicej has enabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/11763">PR #11763</a>.</p>



<a name="542363430"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311763%20support%20continuing%20host-to-host%20stre.../near/542363430" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311763.20support.20continuing.20host-to-host.20stre.2E.2E.2E.html#542363430">(Sep 30 2025 at 20:38)</a>:</h4>
<p>dicej merged <a href="https://github.com/bytecodealliance/wasmtime/pull/11763">PR #11763</a>.</p>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
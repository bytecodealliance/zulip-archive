<html>
<head><meta charset="utf-8"><title>wasmtime / PR #11768 Cranelift: add debug tag infrastruct... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html">wasmtime / PR #11768 Cranelift: add debug tag infrastruct...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="542401717"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/542401717" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#542401717">(Oct 01 2025 at 03:36)</a>:</h4>
<p>cfallin opened <a href="https://github.com/bytecodealliance/wasmtime/pull/11768">PR #11768</a> from <code>cfallin:cranelift-debug-tags</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>This PR adds <em>debug tags</em>, a kind of metadata that can attach to CLIF instructions and be lowered to VCode instructions and as metadata on the produced compiled code. It also adds opaque descriptor blobs carried with stackslots. Together, these two features allow decorating IR with first-class debug instrumentation that is properly preserved by the compiler, including across optimizations and inlining. (Wasmtime's use of these features will come in followup PRs.)</p>
<p>The key idea of a "debug tag" is to allow the Cranelift embedder to express whatever information it needs to, in a format that is opaque to Cranelift itself, except for the parts that need translation during lowering. In particular, the <code>DebugTag::StackSlot</code> variant gets translated to a physical offset into the stackframe in the compiled metadata output. So, for example, the embedder can emit a tag referring to a stackslot, and another describing an offset in that stackslot.</p>
<p>The debug tags exist as a <em>sequence</em> on any given instruction; the meaning of the sequence is known only to the embedder, <em>except</em> that during inlining, the tags for the inlining call instruction are prepended to the tags of inlined instructions. In this way, a canonical use-case of tags as describing original source-language frames can preserve the source-language view even when multiple functions are inlined into one.</p>
<p>The descriptor on a stackslot may look a little odd at first, but its purpose is to allow serializing some description of stackslot-contained runtime user-program data, in a way that is firmly attached to the stackslot. In particular, in the face of inlining, this descriptor is copied into the inlining (parent) function from the inlined function when the stackslot entity is copied; no other metadata outside Cranelift needs to track the identity of stackslots and know about that motion. This fits nicely with the ability of tags to refer to stackslots; together, the embedder can annotate instructions as having certain state in stackslots, and describe the format of that state per stackslot.</p>
<p>This infrastructure is tested with some compile-tests now; testing of the interpretation of the metadata output will come with end-to-end debug instrumentation tests in a followup PR.</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="542401719"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/542401719" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#542401719">(Oct 01 2025 at 03:36)</a>:</h4>
<p><strong>cfallin</strong> requested <a href="https://github.com/alexcrichton">alexcrichton</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/11768">PR #11768</a>.</p>



<a name="542401720"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/542401720" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#542401720">(Oct 01 2025 at 03:36)</a>:</h4>
<p><strong>cfallin</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/11768">PR #11768</a>.</p>



<a name="542401921"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/542401921" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#542401921">(Oct 01 2025 at 03:38)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11768">PR #11768</a>.</p>



<a name="542402114"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/542402114" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#542402114">(Oct 01 2025 at 03:41)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11768">PR #11768</a>.</p>



<a name="542402630"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/542402630" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#542402630">(Oct 01 2025 at 03:47)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11768">PR #11768</a>.</p>



<a name="542404075"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/542404075" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#542404075">(Oct 01 2025 at 04:05)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11768">PR #11768</a>.</p>



<a name="542404822"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/542404822" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#542404822">(Oct 01 2025 at 04:17)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11768">PR #11768</a>.</p>



<a name="542446665"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/542446665" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#542446665">(Oct 01 2025 at 09:20)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11768#pullrequestreview-3288258522">PR review</a>.</p>



<a name="542446666"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/542446666" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#542446666">(Oct 01 2025 at 09:20)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/11768#discussion_r2393958343">PR review comment</a>:</p>
<blockquote>
<p>Why are you removing this? If a value is in a fixed stack slot, then using this map would be more efficient than using debug tags that you need to attach to every instruction for native debugging.</p>
</blockquote>



<a name="542524707"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/542524707" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#542524707">(Oct 01 2025 at 15:28)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11768#pullrequestreview-3289501674">PR review</a>:</p>
<blockquote>
<p>I have some assorted thoughts below, but I'd second @bjorn3's question a bit too. Overall I'm at least not personally quite following why we need to plumb so much through Cranelift vs reading the result of Cranelift's compilation. I mentioned below that it felt like we should be using a newtype-u32 rather than <code>Vec&lt;DebugTag&gt;</code> in places, but additionally if we're already plumbing around <code>StackSlot</code>-to-offset as the result of compilation that seems like it's a big part of what we want already? The only other major missing piece would be <code>Inst</code>-to-offset-in-output which looks related to <code>MachDebugTagPos</code> logic here for example. </p>
<p>I may not be the best reviewer for this though perhaps. Or perhaps I should read the next PR to see how this is all used. </p>
</blockquote>



<a name="542524710"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/542524710" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#542524710">(Oct 01 2025 at 15:28)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/11768#discussion_r2394816500">PR review comment</a>:</p>
<blockquote>
<p>Should this have an <code>else</code> that does <code>self.insts.remove(&amp;to)</code>?</p>
</blockquote>



<a name="542524711"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/542524711" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#542524711">(Oct 01 2025 at 15:28)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/11768#discussion_r2394833860">PR review comment</a>:</p>
<blockquote>
<p>How come this is a <code>Vec&lt;u8&gt;</code> vs a newtype-u32? (or other fixed-width integer) I would naively expect the latter where the embedder would be responsible for mapping the integer back to substantial data (which may or may not make sense to represent as <code>Vec&lt;u8&gt;</code>)</p>
</blockquote>



<a name="542524712"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/542524712" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#542524712">(Oct 01 2025 at 15:28)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/11768#discussion_r2394842961">PR review comment</a>:</p>
<blockquote>
<p>At a high level after skimming this PR I'm surprised in that I expected more handling of infrastructure or something internally. This is currently a map of <code>Inst</code> to <code>Vec&lt;DebugTag&gt;</code>, but that appears to be mostly it. I'm surprised by that where I was expecting some sort of integration with egraphs or something like that. Because otherwise wouldn't egraphs basically destroy the usefulness of the debug tags where instructions are remapped/moved/etc? I realize for debugging in Wasmtime we'd disable egraphs, but if the handling is so light in Cranelift I'm also not certain why this can't be an embedder-only thing vs needing to be baked into Cranelift.</p>
</blockquote>



<a name="542524713"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/542524713" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#542524713">(Oct 01 2025 at 15:28)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/11768#discussion_r2394822983">PR review comment</a>:</p>
<blockquote>
<p>I'm a bit surprised by this in the sense that most of Cranelift is centered around costly clones/etc of vectors. I would otherwise expect some sort of step up-front to turn <code>Vec&lt;DebugTag&gt;</code> into a <code>DebugList(u32)</code> descriptor and then that would be passed around here. Is it worth doing that sort of compile-time optimization at this point? Or are these infrequent/short enough to not really matter?</p>
</blockquote>



<a name="542524714"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/542524714" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#542524714">(Oct 01 2025 at 15:28)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/11768#discussion_r2394851615">PR review comment</a>:</p>
<blockquote>
<p>I realize that this is mostly repeating what's already here, but I'm getting a bit more worried over time that a <code>MachBuffer</code> is kilobytes-large and we sort of keep naively adding more <code>SmallVec</code>s which may result in a lot of wasted empty space. At what point is it better to use a <code>Vec&lt;T&gt;</code> vs <code>SmallVec&lt;[T; N]&gt;</code>?</p>
</blockquote>



<a name="542524723"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/542524723" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#542524723">(Oct 01 2025 at 15:28)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/11768#discussion_r2394826118">PR review comment</a>:</p>
<blockquote>
<p>Is it worth having any sort of interning here where <code>tags</code> is deduplicated with previous lists? I'm not far enough in my understanding yet to know whether it's going to be common to have the same set of debug tags frequently throughout a function</p>
</blockquote>



<a name="542542009"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/542542009" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#542542009">(Oct 01 2025 at 16:49)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/fitzgen">fitzgen</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/11768">PR #11768</a>.</p>



<a name="542542010"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/542542010" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#542542010">(Oct 01 2025 at 16:49)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/alexcrichton">alexcrichton</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/11768">PR #11768</a>.</p>



<a name="542550519"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/542550519" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#542550519">(Oct 01 2025 at 17:41)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11768#pullrequestreview-3289785003">PR review</a>:</p>
<blockquote>
<p>Thanks Chris!</p>
<p>Also from the discussion in the cranelift meeting today:</p>
<ul>
<li>we should re-add the <code>sequence_point</code> CLIF instruction</li>
<li>we should assert that the only instructions with debug tags are <code>sequence_point</code> intstructions</li>
</ul>
</blockquote>



<a name="542550520"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/542550520" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#542550520">(Oct 01 2025 at 17:41)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/11768#discussion_r2395188581">PR review comment</a>:</p>
<blockquote>
<p>Not every stack slot needs a descriptor, so it would be nice if this was a secondary map, and then all the existing callers for creating new stack slots wouldn't need to change.</p>
<p>Even if a descriptor becomes a u32/entity, I think this would still be nice to put in a side table.</p>
</blockquote>



<a name="542550521"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/542550521" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#542550521">(Oct 01 2025 at 17:41)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/11768#discussion_r2395189242">PR review comment</a>:</p>
<blockquote>
<p>Basically would be this side table, in fact.</p>
</blockquote>



<a name="542550523"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/542550523" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#542550523">(Oct 01 2025 at 17:41)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/11768#discussion_r2395000979">PR review comment</a>:</p>
<blockquote>
<p>But they could be? We are using indices and flat storage anyways, so why not give those indices a newtype as an entity and do</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">DebugTag</span><span class="p">(</span><span class="kt">u32</span><span class="p">);</span>
<span class="n">entity_impl</span><span class="o">!</span><span class="p">(</span><span class="n">DebugTag</span><span class="p">);</span>

<span class="k">enum</span><span class="w"> </span><span class="nc">DebugTagData</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">User</span><span class="p">(</span><span class="kt">u32</span><span class="p">),</span>
<span class="w">    </span><span class="n">StackSlot</span><span class="p">(</span><span class="n">StackSlot</span><span class="p">),</span>
<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">DebugTags</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">tags</span><span class="p">:</span><span class="w"> </span><span class="nc">PrimaryMap</span><span class="o">&lt;</span><span class="n">DebugTag</span><span class="p">,</span><span class="w"> </span><span class="n">DebugTagData</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">pool</span><span class="p">:</span><span class="w"> </span><span class="nc">ListPool</span><span class="o">&lt;</span><span class="n">DebugTag</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">insts</span><span class="p">:</span><span class="w"> </span><span class="nc">SecondaryMap</span><span class="o">&lt;</span><span class="n">Inst</span><span class="p">,</span><span class="w"> </span><span class="n">EntityList</span><span class="o">&lt;</span><span class="n">DebugTag</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>
<p>?</p>
<p>I guess this adds an indirection, but in return means that you recycle memory when creating new lists (prepending an existing list with new tags means that the existing list is "leaked" in the current data structure) and you have size classes and all that.</p>
<p>Not clear to me which side of the trade off is ultimately a better choice, but at minimum this comment about not being able to use <code>EntityList</code> is clearly a bit distracting :)</p>
</blockquote>



<a name="542612979"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/542612979" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#542612979">(Oct 01 2025 at 21:07)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11768#pullrequestreview-3291123873">PR review</a>.</p>



<a name="542612980"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/542612980" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#542612980">(Oct 01 2025 at 21:07)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/11768#discussion_r2395901926">PR review comment</a>:</p>
<blockquote>
<p>This information isn't actually removed, just <a href="https://github.com/bytecodealliance/wasmtime/pull/11768/files#diff-f9524bac9108c13ddfe351160d287ab858d4e815181a867e56fa5382e5bd564eR332">moved here</a> as something accessible from the <code>MachBuffer</code> for slightly neater plumbing.</p>
</blockquote>



<a name="542613906"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/542613906" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#542613906">(Oct 01 2025 at 21:13)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/11768#issuecomment-3358154382">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11768">PR #11768</a>:</p>
<blockquote>
<blockquote>
<p>I have some assorted thoughts below, but I'd second @bjorn3's question a bit too. Overall I'm at least not personally quite following why we need to plumb so much through Cranelift vs reading the result of Cranelift's compilation. I mentioned below that it felt like we should be using a newtype-u32 rather than <code>Vec&lt;DebugTag&gt;</code> in places, but additionally if we're already plumbing around <code>StackSlot</code>-to-offset as the result of compilation that seems like it's a big part of what we want already? The only other major missing piece would be <code>Inst</code>-to-offset-in-output which looks related to <code>MachDebugTagPos</code> logic here for example.</p>
</blockquote>
<p>To recap a bit what we discussed in today's Cranelift meeting for any other readers (or posterity):</p>
<ul>
<li>The design here is more or less necessitated by supporting preservation across inlining (and we fully preserve debugging correctness across other optimizations too, so handling inlining as well doesn't seem out of place; moreover, excluding it seemed to me to be an unnecessary limit). In particular, inlining concatenates tags from the inlining call instruction to those of the inlined instructions (see <a href="https://github.com/bytecodealliance/wasmtime/pull/11768/files#diff-3650351ec5e041ebf66bb8e7abbde58ca2fc89bbd0e281a095672424cdada8b5R1">this doc comment</a>); this is what means we need a list of tags, rather than a single tag, and the need for these tags to stand alone (rather than be an indirect index into some other data) is forced by inlining as well.</li>
<li>The correctness across optimizations is ensured by placing tags on side-effectful instructions, which don't get removed. In the sibling PR for Wasmtime (#11769) I add them on all trapping instructions, and on callsites; an earlier iteration of this work put them on sequence-point instructions that acted as explicit immovable markers instead. I explained the appeal of that latter design for conceptual clarity in the meeting and we agreed to go back to sequence-point instructions (calls will also need tags, so the inlining mechanism works).</li>
</ul>
</blockquote>



<a name="542614323"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/542614323" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#542614323">(Oct 01 2025 at 21:16)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/11768#issuecomment-3358162537">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11768">PR #11768</a>:</p>
<blockquote>
<p>Also:</p>
<ul>
<li>Attaching tags to instruction indices and then recovering information at the output is error-prone for a number of reasons, but inlining again is what forces us to have tags as a first-class object that flow <em>through</em> the IR rather than live alongside it.</li>
<li>Cranelift needs to handle the translation of stackslot references from the IR level to the frame-layout level in the compilation metadata, so this part of the mechanism also needs to be first-class in the IR, and can't be indirected to the outside (<code>wasmtime-cranelift</code> or other embedder).</li>
</ul>
</blockquote>



<a name="542614543"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/542614543" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#542614543">(Oct 01 2025 at 21:18)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11768#pullrequestreview-3291161080">PR review</a>.</p>



<a name="542614545"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/542614545" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#542614545">(Oct 01 2025 at 21:18)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/11768#discussion_r2395926488">PR review comment</a>:</p>
<blockquote>
<p>Addressed in top-level comment but the tl;dr is: (i) things that are put in the IR here need to be first-class either because inlining pulls them between functions, and needs to operate semantically on them (concatenate list of virtual frames), or because Cranelift needs to translate/lower them somehow (stackslot refs); (ii) we do run and support full optimizations, and this works because tags are attached to side-effecting insts.</p>
</blockquote>



<a name="542614711"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/542614711" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#542614711">(Oct 01 2025 at 21:20)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11768#pullrequestreview-3291165102">PR review</a>.</p>



<a name="542614712"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/542614712" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#542614712">(Oct 01 2025 at 21:20)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/11768#discussion_r2395929159">PR review comment</a>:</p>
<blockquote>
<p>Unfortunately the tag lists for each point will be unique (they include the Wasm PC, for example), so deduplication won't really do much here. Separating the intern-into-list-pool step from the attachment isn't the worst idea, and would allow sharing in theory, but e.g. the <code>wasmtime-cranelift</code> embedder won't do that (each list is unique).</p>
</blockquote>



<a name="542614881"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/542614881" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#542614881">(Oct 01 2025 at 21:21)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11768#pullrequestreview-3291170480">PR review</a>.</p>



<a name="542614882"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/542614882" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#542614882">(Oct 01 2025 at 21:21)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/11768#discussion_r2395932310">PR review comment</a>:</p>
<blockquote>
<p>More that they are unique at each instance, so there isn't much value to sharing. That said, if we revert to my earlier sequence-point design, there is no need to attach tags to every instruction inserted by a cursor as this does here; rather they will be explicitly attached on one particular instruction; so we can get rid of this field and the clones from it.</p>
</blockquote>



<a name="542635033"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/542635033" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#542635033">(Oct 02 2025 at 00:32)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11768">PR #11768</a>.</p>



<a name="542635055"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/542635055" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#542635055">(Oct 02 2025 at 00:32)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11768#pullrequestreview-3291722659">PR review</a>.</p>



<a name="542635056"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/542635056" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#542635056">(Oct 02 2025 at 00:32)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/11768#discussion_r2396350605">PR review comment</a>:</p>
<blockquote>
<p>Yes, wasn't needed before but is now (with stricter checking of tag presence on non-sequence-point insts) -- fixed!</p>
</blockquote>



<a name="542635085"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/542635085" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#542635085">(Oct 02 2025 at 00:33)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11768#pullrequestreview-3291722960">PR review</a>.</p>



<a name="542635087"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/542635087" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#542635087">(Oct 02 2025 at 00:33)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/11768#discussion_r2396350824">PR review comment</a>:</p>
<blockquote>
<p>Removed this now, since tags can only be on sequence points and need not be spread across all inserted insts.</p>
</blockquote>



<a name="542635835"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/542635835" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#542635835">(Oct 02 2025 at 00:42)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11768#pullrequestreview-3291732489">PR review</a>.</p>



<a name="542635837"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/542635837" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#542635837">(Oct 02 2025 at 00:42)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/11768#discussion_r2396359106">PR review comment</a>:</p>
<blockquote>
<p>I poked at this a bit but I think it's probably not the right answer -- indirection would be a win if it led to substantial savings by sharing one copy of a large object, but in this case, <code>DebugTagData</code> is going to be 64 bits, so we already have a 50% overhead storing a separate u32 to index each one in the entity list, nevermind the pointer into <em>that</em> list, and the dependent load / extra hop to get there.</p>
<p>FWIW, while we do abandon the <em>one</em> tag list for a call instruction when doing inlining (three tags in practice in Wasmtime), that's the only case where a freelist inside the pool would help -- every other tag list is constructed once in its final form.</p>
<p>I'll go ahead and resolve this but others are free to poke at it further of course :-)</p>
</blockquote>



<a name="542635923"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/542635923" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#542635923">(Oct 02 2025 at 00:43)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/11768#issuecomment-3358631665">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11768">PR #11768</a>:</p>
<blockquote>
<p>I've re-added sequence points in the latest push, and I'll remove the built-in stackslot descriptor blobs (in favor of a <code>u64</code> that in Wasmtime's case can hold a <code>FuncKey</code>) next.</p>
</blockquote>



<a name="542636125"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/542636125" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#542636125">(Oct 02 2025 at 00:46)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11768">PR #11768</a>.</p>



<a name="542636126"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/542636126" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#542636126">(Oct 02 2025 at 00:46)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11768#pullrequestreview-3291736431">PR review</a>.</p>



<a name="542636128"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/542636128" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#542636128">(Oct 02 2025 at 00:46)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/11768#discussion_r2396362594">PR review comment</a>:</p>
<blockquote>
<p>That's a great question; way back in 2020 I found that smallvecs helped avoid realloc/copy traffic for the code buffer itself for small functions, but we've carried that pattern through to all the tags, some of which may be much more sparse. I'll switch these back to <code>Vec</code>s.</p>
</blockquote>



<a name="542636247"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/542636247" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#542636247">(Oct 02 2025 at 00:47)</a>:</h4>
<p>cfallin edited <a href="https://github.com/bytecodealliance/wasmtime/pull/11768#discussion_r2396362594">PR review comment</a>.</p>



<a name="542649865"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/542649865" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#542649865">(Oct 02 2025 at 04:00)</a>:</h4>
<p>cfallin updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11768">PR #11768</a>.</p>



<a name="542650121"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/542650121" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#542650121">(Oct 02 2025 at 04:02)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11768#pullrequestreview-3292076705">PR review</a>.</p>



<a name="542650122"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/542650122" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#542650122">(Oct 02 2025 at 04:02)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/11768#discussion_r2396645905">PR review comment</a>:</p>
<blockquote>
<p>I ended up keeping this as a field in <code>StackSlotData</code> but</p>
<ul>
<li>making it an <code>Option&lt;StackSlotKey&gt;</code> and</li>
<li>keeping <code>StackSlotData::new()</code>'s signature unchanged, while adding <code>new_with_key</code></li>
</ul>
<p>This feels a little nicer/more functional than having to set a side-table IMHO, and is less error-prone (the key is still part of the definition, not something that optimizations have to remember to move as well).</p>
</blockquote>



<a name="542650293"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/542650293" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#542650293">(Oct 02 2025 at 04:04)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/11768#discussion_r2396651350">PR review comment</a>:</p>
<blockquote>
<p>Very good point -- after discussions in the Cranelift meeting today it seems a <code>u64</code> is sufficient (concretely, Wasmtime needs the <code>FuncKey</code> associated with the stackslot so it can go look up the frame shape descriptor later); so I've defined a newtype <code>StackSlotKey</code> for this.</p>
</blockquote>



<a name="542650299"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/542650299" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#542650299">(Oct 02 2025 at 04:04)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11768#pullrequestreview-3292085263">PR review</a>.</p>



<a name="542650451"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/542650451" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#542650451">(Oct 02 2025 at 04:04)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/11768#issuecomment-3358953262">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11768">PR #11768</a>:</p>
<blockquote>
<p>All comments are addressed now, I think -- thanks!</p>
</blockquote>



<a name="542657818"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/542657818" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#542657818">(Oct 02 2025 at 05:41)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/11768#issuecomment-3359214727">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11768">PR #11768</a>:</p>
<blockquote>
<p>Alright, actually, now that I'm working through rebasing the Wasmtime half on this, I'm not convinced that removing the "blob of bytes descriptor" from the stackslot is actually the right move:</p>
<ul>
<li>It's horribly complex to keep the side table and plumb it to the right places on the <code>wasmtime-cranelift</code> side, in particular around inlining. Inlining "just works" when the <code>StackSlotData</code> is self-describing. Now we need to carry the side-table on the wasmtime-cranelift side, let <code>cranelift-codegen</code> query callees and decide to inline via the <code>Inline</code> trait, but insert a side-effect somehow enacted by that trait's implementation to move descriptors behind the scenes back on the <code>wasmtime-cranelift</code> side. That seems very error-prone in comparison. (Note that because we implement a per-function compiler, there is no place for a single module-global side-table to exist and be updated by the parallel compilation.)</li>
<li>It's not any more efficient (we still are copying data from <code>FuncEnvironment</code> into the side-table, then between functions' side-tables when inlining). IIRC this was the original concern -- "too Vec-heavy" in some sense; but the descriptors still exist, just at arm's length and in a remote place that has to remain synchronized.</li>
</ul>
<p>My wip branch is <a href="https://github.com/cfallin/wasmtime/commit/a2fd80c197fd09d58c5edf63a417c7a931e277a9">here</a> for anyone curious but I didn't finish wiring up the part that actually queries/uses the descriptors; stopped when I realized what I would have to do in the <code>InliningCompiler</code>.</p>
<p>I pretty strongly feel that the way it worked before was simpler, more self-contained, and more maintainable; this approach is pushed in a bad direction by high-level feedback that may not have foreseen all the implications. Also, handling inlining is becoming the crux of the complexity, <em>but</em> only because of the review feedback (a sort of self-fulfilling prophecy) -- the original works fine.</p>
<p>@alexcrichton @fitzgen let me know what you think! I'll revert the last commit if you're OK with the above.</p>
</blockquote>



<a name="542658359"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/542658359" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#542658359">(Oct 02 2025 at 05:48)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/11768#issuecomment-3359233391">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11768">PR #11768</a>:</p>
<blockquote>
<p>(To add a little more reasoning by analogy: everything else that goes into metadata in the compiled artifact comes directly from Cranelift, e.g. exception tables, source locations, unwind info, and the like; even the <code>name_map</code>, which is carried separately in <code>CompiledFunction</code>, comes directly from the CLIF, and the CLIF is updated by inlining and any other transforms. Following the precedent here, we should keep everything that describes what we'll emit in the IR itself; doing otherwise is constructing a parallel universe of info on the Wasmtime side that has to be maintained and updated carefully whenever we do interprocedural opts. The spirit of our RFC is to work with the compiler, not against it, and let it manage and translate our debugging instrumentation + metadata like any other part of the program.)</p>
</blockquote>



<a name="542764039"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/542764039" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#542764039">(Oct 02 2025 at 14:57)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/11768#issuecomment-3361604188">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11768">PR #11768</a>:</p>
<blockquote>
<p>At a high level I'm not trying to make life more difficult here, but rather I'm trying to maintain a separation between Wasmtime and Cranelift to avoid having the "wasm mode" in Cranelift with a bunch of custom features just for Wasmtime. For example you say:</p>
<blockquote>
<p>simpler, more self-contained, and more maintainable</p>
</blockquote>
<p>but following this to the extreme means that we throw away the ability to embed Cranelift anywhere else and fuse it to Wasmtime specifically. That will objectively simplify Cranelift and make it more self-contained for Wasmtime's use case for example. Despite this though I don't think it makes sense to do, so this is part of a gray area of sorts where I thinks it's worth exploring solutions that avoid tacking on Wasmtime-specific features into Cranelift.</p>
<p>The reason I feel this is Wasmtime-specific is how this relates to other Cranelift features feels different. For example <code>UserExternalName</code> is heavily used by Wasmtime and is just an opaque 64-bit integer effectively from Cranelift's point of view. It would objectively be simpler if we didn't have to deal with this and just moved <code>FuncKey</code> directly into Cranelift, but I view it as valuable that we don't do that. Having a tight API boundary is also nice for future compatibility/extensibility in that it makes working on Cranelift, outside the context of Wasmtime, easier.</p>
<p>This is my high-level motivation at least which I wanted to explain. I'm not intentionally trying to make this harder to work with but basically trying to maintain a separation between Wasmtime and Cranelift. This is of course, as with everything, a balance to figure out what works and what doesn't. I don't want to over-rotate on "they must be separate" but I also don't want to over-rotate on "this works let's just ship it".</p>
<hr>
<p>For this problem specifically, I could very well be missing details, but I was under the impression that the idea was to tack a 64-bit integer/value/etc onto a <code>Descriptor</code>. That'd be the serialization of <code>FuncKey</code> which means, at the end of compilation, we know what origin function a stack slot corresponds to. What I was then thinking would happen is that <code>CompiledFunction</code> in Cranelift would retain metadata describing the stack slot (locals, etc). During the linking phase we'd need to build the metadata section in the ELF, and we'd use Cranelift's <code>MachBuffer</code> output to find what stack slots a function has. We'd then use this <code>FuncKey</code> to look up in the map of all functions to go to the metadata that the function wants, and then the section would be emitted.</p>
<blockquote>
<p>It's horribly complex to keep the side table and plumb it to the right places on the wasmtime-cranelift side</p>
</blockquote>
<p>Along the lines of my initial comment here, I want to reiterate that I'm not trying to make things horribly complex. If they are then they are and we should go a different route. </p>
<p>For now though I'm not sure myself at least why inlining would come into play given that there's a stack-slot-per-function that's significant so the descriptor is the <code>FuncKey</code> for that function. I'm also not sure why carrying around the side table would be difficult if the per-function metadata were placed into a <code>CompiledFunction</code> and then looked up during the final linking phase.</p>
<blockquote>
<p>It's not any more efficient</p>
</blockquote>
<p>In some sense we've long since given up on this level of efficiency. There's a ton of inefficiencies in the "don't clone this" or "don't move this" category related to Cranelift compilation and it's something we've never really focused on. I don't mean to claim "if we remove this <code>Vec</code> we're retain our lightning-fast compilation" but moreso "if we can I think it'd be good to avoid taking this debt on". For example in the old iteration it looked like whenever a <code>Callee</code> is made it would clone the <code>descriptor</code> field of stack slots. That naively seems like it would clone per-call within a function. Now I have no idea how big the metadata is and it's always solvable by also slapping a few <code>Arc</code>s around.</p>
<p>Basically efficiency isn't a huge point for me, it's just something I noticed. The higher-level point to me is that it feels like a wart in Cranelift's design where everywhere else embedder-related things are integers but here it happens to be a <code>Vec&lt;u8&gt;</code> because that happens to be what we want for this exact use case in Wasmtime</p>
</blockquote>



<a name="542772422"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/542772422" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#542772422">(Oct 02 2025 at 15:30)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/11768#issuecomment-3361851741">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11768">PR #11768</a>:</p>
<blockquote>
<p>So, a few things:</p>
<ul>
<li>I don't think I'm arguing to make Cranelift Wasmtime-specific at all. I agree that's a bad end-goal; I chose <code>Vec&lt;u8&gt;</code> for the stack-slot descriptor specifically because it was an opaque representation.</li>
<li>I do think this case is a bit different. Your mention of the <code>UserExternalName</code> example is illustrative: CLIF itself contains a list of all external names referenced; this list is legible to and kept updated by the inliner. That's a good example of "IR contains all relevant info", and we're assured that we'll get it right. In contrast, here, externalizing the information about the frame slot causes some really subtle and surprising possible footguns. To dig into your sketch a bit:</li>
</ul>
<blockquote>
<p>For this problem specifically, I could very well be missing details, but I was under the impression that the idea was to tack a 64-bit integer/value/etc onto a Descriptor. That'd be the serialization of FuncKey which means, at the end of compilation, we know what origin function a stack slot corresponds to. What I was then thinking would happen is that CompiledFunction in Cranelift would retain metadata describing the stack slot (locals, etc). During the linking phase we'd need to build the metadata section in the ELF, and we'd use Cranelift's MachBuffer output to find what stack slots a function has. We'd then use this FuncKey to look up in the map of all functions to go to the metadata that the function wants, and then the section would be emitted.</p>
</blockquote>
<p>That's fine until we get to the point of looking up the metadata. Note that the metadata (the stackslot format) is an artifact of the compilation of the original function; it's not computed separately or just part of the source or whatnot. So we need a merge step. The simple answer here is to let each function emit only its own original source-level-function metadata as it's appended to the text section.</p>
<p>But there are at least two problems with this:</p>
<ul>
<li>What happens if we do function-level DCE? (We can't; or we need a special "we still need your metadata as a donation to the cause, but you don't get to go in .text" mode.)</li>
<li>We actually need another pre-pass to create the mapping from FuncKeys to frame-table descriptor indices. (In today's setup all descriptors are local to the function so we just lazily create them as needed during translation of progpoints.)<ul>
<li>And this refactors the whole trait setup in <code>Compiler</code> -- right now it's explicitly one pass with an "append to text section" method.</li>
</ul>
</li>
</ul>
<p>This is part of what I mean by new complexity -- the need to keep things in sync, and rely on the invariant that someone else will later emit that metadata, and the need to compute the mapping that the layer of indirection introduces, makes me a bit squeamish. In contrast, IR that is fully self-describing gives us solutions to all of the above for free.</p>
</blockquote>



<a name="542772800"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/542772800" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#542772800">(Oct 02 2025 at 15:32)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/11768#issuecomment-3361873149">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11768">PR #11768</a>:</p>
<blockquote>
<blockquote>
<p>For example in the old iteration it looked like whenever a Callee is made it would clone the descriptor field of stack slots. That naively seems like it would clone per-call within a function.</p>
</blockquote>
<p>I don't think that's true -- descriptors were copied as part of the compilation pipeline (same as serialized data would be in a hypothetical refactor), but callsites only need to create tags to refer to them.</p>
</blockquote>



<a name="542780705"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/542780705" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#542780705">(Oct 02 2025 at 16:07)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/pull/11768#issuecomment-3362010900">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11768">PR #11768</a>:</p>
<blockquote>
<blockquote>
<p>We actually need another pre-pass to create the mapping from FuncKeys to frame-table descriptor indices.</p>
</blockquote>
<p>This could be derived from the <code>FuncKey</code> the same way <code>ExternalName</code> is, can't it?</p>
</blockquote>



<a name="542784553"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/542784553" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#542784553">(Oct 02 2025 at 16:25)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/11768#issuecomment-3362076581">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11768">PR #11768</a>:</p>
<blockquote>
<blockquote>
<blockquote>
<p>We actually need another pre-pass to create the mapping from FuncKeys to frame-table descriptor indices.</p>
</blockquote>
<p>This could be derived from the <code>FuncKey</code> the same way <code>ExternalName</code> is, can't it?</p>
</blockquote>
<p>Unfortunately not: <code>ExternalName</code> is built by directly embedding the <code>FuncKey</code> (<a href="https://github.com/bytecodealliance/wasmtime/blob/7cebfa206fe4a40ab54e9862f30b05c5fefb9043/crates/cranelift/src/compiler.rs#L1524">here</a>), which is a bitpacked u64 not necessarily in a contiguous sequence; whereas we need indices into a descriptor table in the frame-table section that are contiguous.</p>
</blockquote>



<a name="542821561"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/542821561" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#542821561">(Oct 02 2025 at 20:00)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/11768#issuecomment-3362734629">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11768">PR #11768</a>:</p>
<blockquote>
<p>I've pushed this <a href="https://github.com/cfallin/wasmtime/tree/wasmtime-debug-instrumentation-2">a little further still</a> and the next impedance mismatch is that frame slots can be at different FP offsets when inlined; so one can build a global table from FuncKey to descriptor, but part of the descriptor varies depending on the use-site, so one needs another layer of descriptors to reference <em>those</em> descriptors and add an FP offset.</p>
<p>Lest this be accounted under "complexity of inlining", I'll note again that everything just works when the IR is self-describing; trying to spread the concept of a descriptor across two layers, when the thing it is attached to is a builtin IR entity that is freely manipulated by the compiler, is the source of the problems...</p>
</blockquote>



<a name="542822207"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/542822207" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#542822207">(Oct 02 2025 at 20:04)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/11768#issuecomment-3362744269">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11768">PR #11768</a>:</p>
<blockquote>
<p>Well  at this point it seems like the way forward is <code>Vec&lt;u8&gt;</code> as a descriptor entry in stack slots. That being said I still feel like it's an unresolved point to me. It's not the end of the world to paper over and just see how it works out, so I don't feel the need to block anything. That being said I'll still put my thoughts down:</p>
<blockquote>
<p>... chose Vec&lt;u8&gt; for the stack-slot descriptor specifically because it was an opaque representation.</p>
<p>... Your mention of the UserExternalName example is illustrative: ...</p>
</blockquote>
<p>Personally I don't know how to grapple with these two things. On one hand it's ok for external symbols to be two 32-bit integers when they're more naturally represented in many other places as strings. This then works well enough during inlining that there's no reason to change this. For stack slots, though, you're saying it makes more sense to use a bag-of-bytes descriptor despite symbols, for example, intentionally (I assume?) not using that. I also don't understand why a bag-of-bytes or integer-on-stack-slot is any different w.r.t. inlining, both strategies simply copy whatever's there to somewhere else. The only difference is the interpretation later on and then it's either the bytes are there or a lookup table is needed.</p>
<p>Now I agree that looking up the metadata by key is slightly more tricky. I don't understand why it's so tricky it's not worth pursuing, though. The merge step already exists in the form of <a href="https://github.com/bytecodealliance/wasmtime/blob/7cebfa206fe4a40ab54e9862f30b05c5fefb9043/crates/environ/src/compile/mod.rs#L301-L333">linking everything together</a> and we already have to have mapping logic related to handling relocations. This is certainly a tricky step, but I don't understand why building a map at the beginning would make it any more meaningfully trickier.</p>
<blockquote>
<p>This is part of what I mean by new complexity -- the need to keep things in sync, and rely on the invariant that someone else will later emit that metadata, and the need to compute the mapping that the layer of indirection introduces, </p>
</blockquote>
<p>I don't fully grasp the increase in complexity here. My assumption is that a descriptor for a stack slot is more-or-less a function of a <code>FuncKey</code>. Given that there's not really anything to keep in sync other than something needs to produce a map of <code>FuncKey</code> to descriptor and each function compilation would produce its descriptor as part of the <code>CompiledFunction</code>. While DCE seems like something to keep in mind that doesn't seem like an insurmountable amount of complexity (e.g. the function is passed in with a flag saying "don't put this in the text section").</p>
<p>Overall I agree it's different than what's already here today, but I again don't fully understand the rationale about the drastic increase in complexity.</p>
<blockquote>
<p>In contrast, IR that is fully self-describing gives us solutions to all of the above for free. </p>
<p>...</p>
<blockquote>
<p>For example in the old iteration it looked like whenever a Callee is made it would clone the descriptor field of stack slots. </p>
</blockquote>
<p>I don't think that's true ...</p>
</blockquote>
<p>I meant <a href="https://github.com/bytecodealliance/wasmtime/blob/d2d8bb4b36e1f17e83c22a656b3dbca62ebf0d08/cranelift/codegen/src/machinst/abi.rs#L1256">this line</a> from the previous version of this PR.</p>
</blockquote>



<a name="542841240"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/542841240" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#542841240">(Oct 02 2025 at 22:46)</a>:</h4>
<p>cfallin <a href="https://github.com/bytecodealliance/wasmtime/pull/11768#issuecomment-3363486190">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11768">PR #11768</a>:</p>
<blockquote>
<p>Alright, I managed to cobble a solution together (update after rebase on the Wasmtime side <a href="https://github.com/bytecodealliance/wasmtime/pull/11769/commits/2c75c5d36ecc2faa0dea200afcad06e81a2a74af">here</a>). Apologies for the pushback -- it's a subjective design thing and I'm still not super-happy with the coupling, versus fully self-describing IR, but at least this is <em>possible</em>. It did require some small changes to the signatures in the compiler traits and you can see the extra pass over functions but at least it's enabled only when the tunable is set.</p>
<p>(I think that by redesigning the serialization format a bit to separate out the slot-offset-from-FP from the offset-within-slot, I can share descriptors between inlined copies of functions rather than emitting them separately for each function that uses them; I'll poke at that on the Wasmtime side.)</p>
</blockquote>



<a name="542989577"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/542989577" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#542989577">(Oct 03 2025 at 17:03)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/11768#issuecomment-3366489167">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11768">PR #11768</a>:</p>
<blockquote>
<p>This all looks reasonable to me, thanks! A skim over #11769 all looks pretty reasonable to me too. I'll defer to @fitzgen for final approval on this though</p>
</blockquote>



<a name="543023328"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/543023328" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#543023328">(Oct 03 2025 at 20:17)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11768#pullrequestreview-3300777939">PR review</a>.</p>



<a name="543023329"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/543023329" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#543023329">(Oct 03 2025 at 20:17)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/11768#discussion_r2403251354">PR review comment</a>:</p>
<blockquote>
<p>Maybe use PackedOption?</p>
</blockquote>



<a name="543390336"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/543390336" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#543390336">(Oct 06 2025 at 19:07)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/pull/11768#issuecomment-3373454559">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11768">PR #11768</a>:</p>
<blockquote>
<blockquote>
<p>I'll defer to @fitzgen for final approval on this though</p>
</blockquote>
<p>I looked over the usage in the PR stacked on top of this and things looked pretty reasonable, didn't seem like there needed to be a lot of bookkeeping of extra info in Wasmtime that otherwise would have been inside of Cranelift, so LGTM <span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span> </p>
</blockquote>



<a name="543391726"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/543391726" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#543391726">(Oct 06 2025 at 19:16)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11768#pullrequestreview-3306757350">PR review</a>.</p>



<a name="543394837"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/543394837" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#543394837">(Oct 06 2025 at 19:37)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11768#pullrequestreview-3306878067">PR review</a>.</p>



<a name="543394838"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/543394838" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#543394838">(Oct 06 2025 at 19:37)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/11768#discussion_r2408169495">PR review comment</a>:</p>
<blockquote>
<p>I don't necessarily want to take any bites out of the domain of the arbitrary u64 -- it's already used by Wasmtime to carry a FuncKey which has its own bit-level encoding (rather than a serial index). Hopefully though stackslots are sparse enough (vs. e.g. instructions or blocks) that this is OK...</p>
</blockquote>



<a name="543398598"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311768%20Cranelift%3A%20add%20debug%20tag%20infrastruct.../near/543398598" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311768.20Cranelift.3A.20add.20debug.20tag.20infrastruct.2E.2E.2E.html#543398598">(Oct 06 2025 at 20:01)</a>:</h4>
<p>cfallin merged <a href="https://github.com/bytecodealliance/wasmtime/pull/11768">PR #11768</a>.</p>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
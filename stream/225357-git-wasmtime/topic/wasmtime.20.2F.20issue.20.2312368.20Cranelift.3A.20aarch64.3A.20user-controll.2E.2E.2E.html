<html>
<head><meta charset="utf-8"><title>wasmtime / issue #12368 Cranelift: aarch64: user-controll... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312368.20Cranelift.3A.20aarch64.3A.20user-controll.2E.2E.2E.html">wasmtime / issue #12368 Cranelift: aarch64: user-controll...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="568633370"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312368%20Cranelift%3A%20aarch64%3A%20user-controll.../near/568633370" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312368.20Cranelift.3A.20aarch64.3A.20user-controll.2E.2E.2E.html#568633370">(Jan 18 2026 at 03:44)</a>:</h4>
<p>mmcloughlin opened <a href="https://github.com/bytecodealliance/wasmtime/issues/12368">issue #12368</a>:</p>
<blockquote>
<p>The following <code>lower_fmla</code> rules enable user-controlled recursion.</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/v40.0.2/cranelift/codegen/src/isa/aarch64/lower.isle#L606-L615">https://github.com/bytecodealliance/wasmtime/blob/v40.0.2/cranelift/codegen/src/isa/aarch64/lower.isle#L606-L615</a></p>
<p>These rules will peel away an arbitrary number of <code>fneg</code> arguments to an <code>fma</code><br>
instruction, alternating between a fused-multiply-add and<br>
fused-multiply-subtract operation.</p>
<h3><code>.clif</code> Test Case</h3>
<p>Generate a CLIF function with a stack of <code>fneg</code> arguments using a script like<br>
<code>fneg.py</code>:</p>
<div class="codehilite" data-code-language="Python"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>


<span class="k">def</span><span class="w"> </span><span class="nf">generate_fneg_fma_rec</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"function </span><span class="si">%f</span><span class="s2">ma_fneg_rec(f32x4, f32x4, f32x4) -&gt; f32x4 {"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"block0(v1: f32x4, v2: f32x4, v3: f32x4):"</span><span class="p">)</span>

    <span class="n">n</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"    v</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2"> = fneg v</span><span class="si">{</span><span class="n">n</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"    v</span><span class="si">{</span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> = fneg v</span><span class="si">{</span><span class="n">n</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">+=</span> <span class="mi">2</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"    v</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2"> = fma v</span><span class="si">{</span><span class="n">n</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="si">}</span><span class="s2">, v</span><span class="si">{</span><span class="n">n</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">, v1"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"    return v</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"}"</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="n">count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="n">generate_fneg_fma_rec</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<p>Generate a large instance and compile with <code>clif-util</code> (at <code>v40.0.2</code>):</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">python3</span><span class="w"> </span><span class="n">fneg</span><span class="p">.</span><span class="n">py</span><span class="w"> </span><span class="mi">100000</span><span class="w"> </span><span class="o">&gt;</span><span class="n">fneg100000</span><span class="p">.</span><span class="n">clif</span>
<span class="cp">$</span><span class="w"> </span><span class="n">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">bin</span><span class="w"> </span><span class="n">clif</span><span class="o">-</span><span class="n">util</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="o">--</span><span class="n">target</span><span class="w"> </span><span class="n">aarch64</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="o">--</span><span class="n">disasm</span><span class="w"> </span><span class="n">fneg100000</span><span class="p">.</span><span class="n">clif</span>
<span class="o">..</span><span class="p">.</span>
</code></pre></div>
<h3>Expected Results</h3>
<p>Expect function to compile and execute successfully. Ideally, it would be<br>
optimized to a single <code>fma</code>.</p>
<h3>Actual Results</h3>
<p>Observe that rule recursion leads to stack overflow, for a sufficiently large<br>
instance.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="p">(</span><span class="mi">2897042</span><span class="p">)</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">overflowed</span><span class="w"> </span><span class="n">its</span><span class="w"> </span><span class="n">stack</span>
<span class="n">fatal</span><span class="w"> </span><span class="n">runtime</span><span class="w"> </span><span class="n">error</span><span class="p">:</span><span class="w"> </span><span class="nc">stack</span><span class="w"> </span><span class="n">overflow</span><span class="p">,</span><span class="w"> </span><span class="n">aborting</span>
<span class="n">fish</span><span class="p">:</span><span class="w"> </span><span class="nc">Job</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">'</span><span class="na">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">bin</span><span class="w"> </span><span class="n">clif</span><span class="o">-</span><span class="n">util</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="n">co</span><span class="err">…</span><span class="o">'</span><span class="w"> </span><span class="n">terminated</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">signal</span><span class="w"> </span><span class="n">SIGABRT</span><span class="w"> </span><span class="p">(</span><span class="n">Abort</span><span class="p">)</span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: v40.0.2</p>
<p>Operating system: Mac OSX</p>
<p>Architecture: AArch64</p>
<h3>Extra Info</h3>
<p>Related #12333</p>
</blockquote>



<a name="568633371"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312368%20Cranelift%3A%20aarch64%3A%20user-controll.../near/568633371" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312368.20Cranelift.3A.20aarch64.3A.20user-controll.2E.2E.2E.html#568633371">(Jan 18 2026 at 03:44)</a>:</h4>
<p><a href="https://github.com/mmcloughlin">mmcloughlin</a> added the bug label to <a href="https://github.com/bytecodealliance/wasmtime/issues/12368">Issue #12368</a>.</p>



<a name="568633372"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312368%20Cranelift%3A%20aarch64%3A%20user-controll.../near/568633372" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312368.20Cranelift.3A.20aarch64.3A.20user-controll.2E.2E.2E.html#568633372">(Jan 18 2026 at 03:44)</a>:</h4>
<p><a href="https://github.com/mmcloughlin">mmcloughlin</a> added the cranelift label to <a href="https://github.com/bytecodealliance/wasmtime/issues/12368">Issue #12368</a>.</p>



<a name="568633418"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312368%20Cranelift%3A%20aarch64%3A%20user-controll.../near/568633418" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312368.20Cranelift.3A.20aarch64.3A.20user-controll.2E.2E.2E.html#568633418">(Jan 18 2026 at 03:45)</a>:</h4>
<p>mmcloughlin edited <a href="https://github.com/bytecodealliance/wasmtime/issues/12368">issue #12368</a>:</p>
<blockquote>
<p>The following <code>lower_fmla</code> rules enable user-controlled recursion.</p>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/v40.0.2/cranelift/codegen/src/isa/aarch64/lower.isle#L606-L615">https://github.com/bytecodealliance/wasmtime/blob/v40.0.2/cranelift/codegen/src/isa/aarch64/lower.isle#L606-L615</a></p>
<p>These rules will peel away an arbitrary number of <code>fneg</code> arguments to an <code>fma</code><br>
instruction, alternating between a fused-multiply-add and<br>
fused-multiply-subtract operation.</p>
<h3><code>.clif</code> Test Case</h3>
<p>Generate a CLIF function with a stack of <code>fneg</code> arguments using a script like<br>
<code>fneg.py</code>:</p>
<div class="codehilite" data-code-language="Python"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>


<span class="k">def</span><span class="w"> </span><span class="nf">generate_fneg_fma_rec</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"function </span><span class="si">%f</span><span class="s2">ma_fneg_rec(f32x4, f32x4, f32x4) -&gt; f32x4 {"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"block0(v1: f32x4, v2: f32x4, v3: f32x4):"</span><span class="p">)</span>

    <span class="n">n</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"    v</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2"> = fneg v</span><span class="si">{</span><span class="n">n</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"    v</span><span class="si">{</span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> = fneg v</span><span class="si">{</span><span class="n">n</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">+=</span> <span class="mi">2</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"    v</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2"> = fma v</span><span class="si">{</span><span class="n">n</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="si">}</span><span class="s2">, v</span><span class="si">{</span><span class="n">n</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">, v1"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"    return v</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"}"</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="n">count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="n">generate_fneg_fma_rec</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<p>Generate a large instance:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">python3</span><span class="w"> </span><span class="n">fneg</span><span class="p">.</span><span class="n">py</span><span class="w"> </span><span class="mi">100000</span><span class="w"> </span><span class="o">&gt;</span><span class="n">fneg100000</span><span class="p">.</span><span class="n">clif</span>
</code></pre></div>
<p>Compile with <code>clif-util</code> (at <code>v40.0.2</code>):</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">bin</span><span class="w"> </span><span class="n">clif</span><span class="o">-</span><span class="n">util</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="o">--</span><span class="n">target</span><span class="w"> </span><span class="n">aarch64</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="o">--</span><span class="n">disasm</span><span class="w"> </span><span class="n">fneg100000</span><span class="p">.</span><span class="n">clif</span>
</code></pre></div>
<h3>Expected Results</h3>
<p>Expect function to compile and execute successfully. Ideally, it would be<br>
optimized to a single <code>fma</code>.</p>
<h3>Actual Results</h3>
<p>Observe that rule recursion leads to stack overflow, for a sufficiently large<br>
instance.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="p">(</span><span class="mi">2897042</span><span class="p">)</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">overflowed</span><span class="w"> </span><span class="n">its</span><span class="w"> </span><span class="n">stack</span>
<span class="n">fatal</span><span class="w"> </span><span class="n">runtime</span><span class="w"> </span><span class="n">error</span><span class="p">:</span><span class="w"> </span><span class="nc">stack</span><span class="w"> </span><span class="n">overflow</span><span class="p">,</span><span class="w"> </span><span class="n">aborting</span>
<span class="n">fish</span><span class="p">:</span><span class="w"> </span><span class="nc">Job</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">'</span><span class="na">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">bin</span><span class="w"> </span><span class="n">clif</span><span class="o">-</span><span class="n">util</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="n">co</span><span class="err">…</span><span class="o">'</span><span class="w"> </span><span class="n">terminated</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">signal</span><span class="w"> </span><span class="n">SIGABRT</span><span class="w"> </span><span class="p">(</span><span class="n">Abort</span><span class="p">)</span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: v40.0.2</p>
<p>Operating system: Mac OSX</p>
<p>Architecture: AArch64</p>
<h3>Extra Info</h3>
<p>Related #12333</p>
</blockquote>



<a name="568633444"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312368%20Cranelift%3A%20aarch64%3A%20user-controll.../near/568633444" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312368.20Cranelift.3A.20aarch64.3A.20user-controll.2E.2E.2E.html#568633444">(Jan 18 2026 at 03:45)</a>:</h4>
<p>mmcloughlin edited <a href="https://github.com/bytecodealliance/wasmtime/issues/12368">issue #12368</a>:</p>
<blockquote>
<p>The following <code>lower_fmla</code> rules enable user-controlled recursion.</p>
<div class="codehilite" data-code-language="Common Lisp"><pre><span></span><code><span class="c1">;; Special case: if one of the multiplicands is `fneg` then peel that away,</span>
<span class="c1">;; reverse the operation being performed, and then recurse on `lower_fmla`</span>
<span class="c1">;; again to generate the actual instruction.</span>
<span class="c1">;;</span>
<span class="c1">;; Note that these are the highest priority cases for `lower_fmla` to peel</span>
<span class="c1">;; away as many `fneg` operations as possible.</span>
<span class="p">(</span><span class="nv">rule</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="p">(</span><span class="nv">lower_fmla</span><span class="w"> </span><span class="nv">op</span><span class="w"> </span><span class="p">(</span><span class="nv">fneg</span><span class="w"> </span><span class="nv">x</span><span class="p">)</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nv">z</span><span class="w"> </span><span class="nv">size</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="nv">lower_fmla</span><span class="w"> </span><span class="p">(</span><span class="nv">neg_fmla</span><span class="w"> </span><span class="nv">op</span><span class="p">)</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nv">z</span><span class="w"> </span><span class="nv">size</span><span class="p">))</span>
<span class="p">(</span><span class="nv">rule</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="p">(</span><span class="nv">lower_fmla</span><span class="w"> </span><span class="nv">op</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="p">(</span><span class="nv">fneg</span><span class="w"> </span><span class="nv">y</span><span class="p">)</span><span class="w"> </span><span class="nv">z</span><span class="w"> </span><span class="nv">size</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="nv">lower_fmla</span><span class="w"> </span><span class="p">(</span><span class="nv">neg_fmla</span><span class="w"> </span><span class="nv">op</span><span class="p">)</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nv">z</span><span class="w"> </span><span class="nv">size</span><span class="p">))</span>
</code></pre></div>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/v40.0.2/cranelift/codegen/src/isa/aarch64/lower.isle#L606-L615">https://github.com/bytecodealliance/wasmtime/blob/v40.0.2/cranelift/codegen/src/isa/aarch64/lower.isle#L606-L615</a></p>
<p>These rules will peel away an arbitrary number of <code>fneg</code> arguments to an <code>fma</code><br>
instruction, alternating between a fused-multiply-add and<br>
fused-multiply-subtract operation.</p>
<h3><code>.clif</code> Test Case</h3>
<p>Generate a CLIF function with a stack of <code>fneg</code> arguments using a script like<br>
<code>fneg.py</code>:</p>
<div class="codehilite" data-code-language="Python"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>


<span class="k">def</span><span class="w"> </span><span class="nf">generate_fneg_fma_rec</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"function </span><span class="si">%f</span><span class="s2">ma_fneg_rec(f32x4, f32x4, f32x4) -&gt; f32x4 {"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"block0(v1: f32x4, v2: f32x4, v3: f32x4):"</span><span class="p">)</span>

    <span class="n">n</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"    v</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2"> = fneg v</span><span class="si">{</span><span class="n">n</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"    v</span><span class="si">{</span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> = fneg v</span><span class="si">{</span><span class="n">n</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">+=</span> <span class="mi">2</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"    v</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2"> = fma v</span><span class="si">{</span><span class="n">n</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="si">}</span><span class="s2">, v</span><span class="si">{</span><span class="n">n</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">, v1"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"    return v</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"}"</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="n">count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="n">generate_fneg_fma_rec</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<p>Generate a large instance:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">python3</span><span class="w"> </span><span class="n">fneg</span><span class="p">.</span><span class="n">py</span><span class="w"> </span><span class="mi">100000</span><span class="w"> </span><span class="o">&gt;</span><span class="n">fneg100000</span><span class="p">.</span><span class="n">clif</span>
</code></pre></div>
<p>Compile with <code>clif-util</code> (at <code>v40.0.2</code>):</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">bin</span><span class="w"> </span><span class="n">clif</span><span class="o">-</span><span class="n">util</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="o">--</span><span class="n">target</span><span class="w"> </span><span class="n">aarch64</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="o">--</span><span class="n">disasm</span><span class="w"> </span><span class="n">fneg100000</span><span class="p">.</span><span class="n">clif</span>
</code></pre></div>
<h3>Expected Results</h3>
<p>Expect function to compile and execute successfully. Ideally, it would be<br>
optimized to a single <code>fma</code>.</p>
<h3>Actual Results</h3>
<p>Observe that rule recursion leads to stack overflow, for a sufficiently large<br>
instance.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="p">(</span><span class="mi">2897042</span><span class="p">)</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">overflowed</span><span class="w"> </span><span class="n">its</span><span class="w"> </span><span class="n">stack</span>
<span class="n">fatal</span><span class="w"> </span><span class="n">runtime</span><span class="w"> </span><span class="n">error</span><span class="p">:</span><span class="w"> </span><span class="nc">stack</span><span class="w"> </span><span class="n">overflow</span><span class="p">,</span><span class="w"> </span><span class="n">aborting</span>
<span class="n">fish</span><span class="p">:</span><span class="w"> </span><span class="nc">Job</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">'</span><span class="na">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">bin</span><span class="w"> </span><span class="n">clif</span><span class="o">-</span><span class="n">util</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="n">co</span><span class="err">…</span><span class="o">'</span><span class="w"> </span><span class="n">terminated</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">signal</span><span class="w"> </span><span class="n">SIGABRT</span><span class="w"> </span><span class="p">(</span><span class="n">Abort</span><span class="p">)</span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: v40.0.2</p>
<p>Operating system: Mac OSX</p>
<p>Architecture: AArch64</p>
<h3>Extra Info</h3>
<p>Related #12333</p>
</blockquote>



<a name="569117334"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312368%20Cranelift%3A%20aarch64%3A%20user-controll.../near/569117334" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312368.20Cranelift.3A.20aarch64.3A.20user-controll.2E.2E.2E.html#569117334">(Jan 20 2026 at 20:02)</a>:</h4>
<p>alexcrichton closed <a href="https://github.com/bytecodealliance/wasmtime/issues/12368">issue #12368</a>:</p>
<blockquote>
<p>The following <code>lower_fmla</code> rules enable user-controlled recursion.</p>
<div class="codehilite" data-code-language="Common Lisp"><pre><span></span><code><span class="c1">;; Special case: if one of the multiplicands is `fneg` then peel that away,</span>
<span class="c1">;; reverse the operation being performed, and then recurse on `lower_fmla`</span>
<span class="c1">;; again to generate the actual instruction.</span>
<span class="c1">;;</span>
<span class="c1">;; Note that these are the highest priority cases for `lower_fmla` to peel</span>
<span class="c1">;; away as many `fneg` operations as possible.</span>
<span class="p">(</span><span class="nv">rule</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="p">(</span><span class="nv">lower_fmla</span><span class="w"> </span><span class="nv">op</span><span class="w"> </span><span class="p">(</span><span class="nv">fneg</span><span class="w"> </span><span class="nv">x</span><span class="p">)</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nv">z</span><span class="w"> </span><span class="nv">size</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="nv">lower_fmla</span><span class="w"> </span><span class="p">(</span><span class="nv">neg_fmla</span><span class="w"> </span><span class="nv">op</span><span class="p">)</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nv">z</span><span class="w"> </span><span class="nv">size</span><span class="p">))</span>
<span class="p">(</span><span class="nv">rule</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="p">(</span><span class="nv">lower_fmla</span><span class="w"> </span><span class="nv">op</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="p">(</span><span class="nv">fneg</span><span class="w"> </span><span class="nv">y</span><span class="p">)</span><span class="w"> </span><span class="nv">z</span><span class="w"> </span><span class="nv">size</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="nv">lower_fmla</span><span class="w"> </span><span class="p">(</span><span class="nv">neg_fmla</span><span class="w"> </span><span class="nv">op</span><span class="p">)</span><span class="w"> </span><span class="nv">x</span><span class="w"> </span><span class="nv">y</span><span class="w"> </span><span class="nv">z</span><span class="w"> </span><span class="nv">size</span><span class="p">))</span>
</code></pre></div>
<p><a href="https://github.com/bytecodealliance/wasmtime/blob/v40.0.2/cranelift/codegen/src/isa/aarch64/lower.isle#L606-L615">https://github.com/bytecodealliance/wasmtime/blob/v40.0.2/cranelift/codegen/src/isa/aarch64/lower.isle#L606-L615</a></p>
<p>These rules will peel away an arbitrary number of <code>fneg</code> arguments to an <code>fma</code><br>
instruction, alternating between a fused-multiply-add and<br>
fused-multiply-subtract operation.</p>
<h3><code>.clif</code> Test Case</h3>
<p>Generate a CLIF function with a stack of <code>fneg</code> arguments using a script like<br>
<code>fneg.py</code>:</p>
<div class="codehilite" data-code-language="Python"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>


<span class="k">def</span><span class="w"> </span><span class="nf">generate_fneg_fma_rec</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"function </span><span class="si">%f</span><span class="s2">ma_fneg_rec(f32x4, f32x4, f32x4) -&gt; f32x4 {"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"block0(v1: f32x4, v2: f32x4, v3: f32x4):"</span><span class="p">)</span>

    <span class="n">n</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"    v</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2"> = fneg v</span><span class="si">{</span><span class="n">n</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"    v</span><span class="si">{</span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> = fneg v</span><span class="si">{</span><span class="n">n</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">+=</span> <span class="mi">2</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"    v</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2"> = fma v</span><span class="si">{</span><span class="n">n</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="si">}</span><span class="s2">, v</span><span class="si">{</span><span class="n">n</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">, v1"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"    return v</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"}"</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="n">count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="n">generate_fneg_fma_rec</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<h3>Steps to Reproduce</h3>
<p>Generate a large instance:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">python3</span><span class="w"> </span><span class="n">fneg</span><span class="p">.</span><span class="n">py</span><span class="w"> </span><span class="mi">100000</span><span class="w"> </span><span class="o">&gt;</span><span class="n">fneg100000</span><span class="p">.</span><span class="n">clif</span>
</code></pre></div>
<p>Compile with <code>clif-util</code> (at <code>v40.0.2</code>):</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">bin</span><span class="w"> </span><span class="n">clif</span><span class="o">-</span><span class="n">util</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="o">--</span><span class="n">target</span><span class="w"> </span><span class="n">aarch64</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="o">--</span><span class="n">disasm</span><span class="w"> </span><span class="n">fneg100000</span><span class="p">.</span><span class="n">clif</span>
</code></pre></div>
<h3>Expected Results</h3>
<p>Expect function to compile and execute successfully. Ideally, it would be<br>
optimized to a single <code>fma</code>.</p>
<h3>Actual Results</h3>
<p>Observe that rule recursion leads to stack overflow, for a sufficiently large<br>
instance.</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">thread</span><span class="w"> </span><span class="o">'</span><span class="na">main</span><span class="o">'</span><span class="w"> </span><span class="p">(</span><span class="mi">2897042</span><span class="p">)</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">overflowed</span><span class="w"> </span><span class="n">its</span><span class="w"> </span><span class="n">stack</span>
<span class="n">fatal</span><span class="w"> </span><span class="n">runtime</span><span class="w"> </span><span class="n">error</span><span class="p">:</span><span class="w"> </span><span class="nc">stack</span><span class="w"> </span><span class="n">overflow</span><span class="p">,</span><span class="w"> </span><span class="n">aborting</span>
<span class="n">fish</span><span class="p">:</span><span class="w"> </span><span class="nc">Job</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">'</span><span class="na">cargo</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">bin</span><span class="w"> </span><span class="n">clif</span><span class="o">-</span><span class="n">util</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="n">co</span><span class="err">…</span><span class="o">'</span><span class="w"> </span><span class="n">terminated</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">signal</span><span class="w"> </span><span class="n">SIGABRT</span><span class="w"> </span><span class="p">(</span><span class="n">Abort</span><span class="p">)</span>
</code></pre></div>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: v40.0.2</p>
<p>Operating system: Mac OSX</p>
<p>Architecture: AArch64</p>
<h3>Extra Info</h3>
<p>Related #12333</p>
</blockquote>



<hr><p>Last updated: Feb 22 2026 at 11:05 UTC</p>
</html>
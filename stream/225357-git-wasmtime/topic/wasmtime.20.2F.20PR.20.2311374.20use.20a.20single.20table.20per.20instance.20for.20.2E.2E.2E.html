<html>
<head><meta charset="utf-8"><title>wasmtime / PR #11374 use a single table per instance for ... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311374.20use.20a.20single.20table.20per.20instance.20for.20.2E.2E.2E.html">wasmtime / PR #11374 use a single table per instance for ...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="532386602"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311374%20use%20a%20single%20table%20per%20instance%20for%20.../near/532386602" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311374.20use.20a.20single.20table.20per.20instance.20for.20.2E.2E.2E.html#532386602">(Aug 01 2025 at 22:18)</a>:</h4>
<p><strong>dicej</strong> requested <a href="https://github.com/alexcrichton">alexcrichton</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/11374">PR #11374</a>.</p>



<a name="532386603"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311374%20use%20a%20single%20table%20per%20instance%20for%20.../near/532386603" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311374.20use.20a.20single.20table.20per.20instance.20for.20.2E.2E.2E.html#532386603">(Aug 01 2025 at 22:18)</a>:</h4>
<p>dicej opened <a href="https://github.com/bytecodealliance/wasmtime/pull/11374">PR #11374</a> from <code>dicej:all-handles-in-same-table</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>Per <a href="https://github.com/WebAssembly/component-model/pull/513">https://github.com/WebAssembly/component-model/pull/513</a>, the spec now puts resources, waitables, waitable sets, subtasks, and error contexts in the same table per instance.  This updates the implementation to match.</p>
<ul>
<li>
<p>Combine the <code>ResourceTable</code> and <code>StateTable</code> data structures into a single <code>HandleTable</code> structure</p>
</li>
<li>
<p>Rename <code>ComponentInstance::instance_resource_tables</code> to <code>instance_handle_tables</code></p>
</li>
<li>
<p>Remove <code>ConcurrentState::waitable_tables</code> and <code>error_context_tables</code> in favor of the above</p>
</li>
<li>
<p>Move various associated functions from <code>ConcurrentState</code> to <code>ComponentInstance</code> so they can access <code>instance_resource_tables</code></p>
</li>
</ul>
<p>While I was doing table-related things, I also updated <code>concurrent::Table::new</code> to reserve the zero handle to mean "invalid".  This won't affect what the guest sees in any way, but it allows us to use <code>TableId::new(0)</code> to invalidate host-owned handles in e.g. <code>{Stream,Future}{Reader,Writer}::close</code>.</p>
<p>Fixes #11189</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="532386604"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311374%20use%20a%20single%20table%20per%20instance%20for%20.../near/532386604" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311374.20use.20a.20single.20table.20per.20instance.20for.20.2E.2E.2E.html#532386604">(Aug 01 2025 at 22:18)</a>:</h4>
<p><strong>dicej</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers">wasmtime-core-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/11374">PR #11374</a>.</p>



<a name="532980763"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311374%20use%20a%20single%20table%20per%20instance%20for%20.../near/532980763" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311374.20use.20a.20single.20table.20per.20instance.20for.20.2E.2E.2E.html#532980763">(Aug 05 2025 at 19:53)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11374">PR #11374</a>.</p>



<a name="532982023"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311374%20use%20a%20single%20table%20per%20instance%20for%20.../near/532982023" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311374.20use.20a.20single.20table.20per.20instance.20for.20.2E.2E.2E.html#532982023">(Aug 05 2025 at 20:00)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11374#pullrequestreview-3089545532">PR review</a>:</p>
<blockquote>
<p>Thanks! I left one comment below and I also pushed up some refactorings I did as well. Mostly I wanted to move away from "resources over there async things over here" in the sense that they were still very distinctly separated and I found it difficult how to use a <code>HandleTable</code> as a result due to having to remember which method to use for which object. Instead now I've refactored it so <code>Slot</code> has a "more flat" representation.</p>
<p>This brings a minor size benefit (slot is 24 bytes, not 32, more is possible with some minor refactoring) but additionally helps encapsulate all the low-level details of handle management. I personally feel like this cleaned up code in <code>concurrent.rs</code> and <code>futures_and_streams.rs</code>. I'd naturally like to double-check you're ok with these refactorings though so lemme know if you feel they don't fit well.</p>
</blockquote>



<a name="532982025"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311374%20use%20a%20single%20table%20per%20instance%20for%20.../near/532982025" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311374.20use.20a.20single.20table.20per.20instance.20for.20.2E.2E.2E.html#532982025">(Aug 05 2025 at 20:00)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/11374#discussion_r2255216747">PR review comment</a>:</p>
<blockquote>
<p>This method, and the <code>reps_to_indexes</code> field, makes me feel uncomfortable and is something that I would prefer to remove entirely unless we otherwise have good motivation for it. Tracing this backwards I found two uses for this:</p>
<ol>
<li>For error-context this is used as the "make sure we always return the same error-context handle" logic to reuse the same handle. This is, IMO, a debatable part of the specification and also not something we're shipping with WASIp3. I'd prefer to remove the logic entirely and have an implementation-specific detail that lowers new error-context handles each time. That would remove the error-context dependency on this, keep programs working. In the future if we want this error-context behavior we can reevaluate.</li>
<li>For delivering an event this is used to do a reverse-lookup from the "rep" in the host to the handle that the guest has for the relevant waitable. Would it be possible to store the guest handle inside of the host's "rep" (or, rather, the host-state object for this) instead? I'm under the impression that guest-state handles can't be removed while they're being waited on which would mean that it should be safe to store the index on the host temporarily.</li>
</ol>
<p>I mostly want to double-check with (2) since I'm less familiar with the code. If you agree with both of the above that would remove the need for this entirely (and <code>reps_to_indexes</code>) which I think would be a good cleanup.</p>
</blockquote>



<a name="533994525"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311374%20use%20a%20single%20table%20per%20instance%20for%20.../near/533994525" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311374.20use.20a.20single.20table.20per.20instance.20for.20.2E.2E.2E.html#533994525">(Aug 12 2025 at 14:30)</a>:</h4>
<p>dicej submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11374#pullrequestreview-3110976812">PR review</a>.</p>



<a name="533994526"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311374%20use%20a%20single%20table%20per%20instance%20for%20.../near/533994526" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311374.20use.20a.20single.20table.20per.20instance.20for.20.2E.2E.2E.html#533994526">(Aug 12 2025 at 14:30)</a>:</h4>
<p>dicej created <a href="https://github.com/bytecodealliance/wasmtime/pull/11374#discussion_r2270067177">PR review comment</a>:</p>
<blockquote>
<p>Sounds reasonable; I'll give it a shot.</p>
</blockquote>



<a name="534005685"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311374%20use%20a%20single%20table%20per%20instance%20for%20.../near/534005685" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311374.20use.20a.20single.20table.20per.20instance.20for.20.2E.2E.2E.html#534005685">(Aug 12 2025 at 15:29)</a>:</h4>
<p>dicej <a href="https://github.com/bytecodealliance/wasmtime/pull/11374#issuecomment-3179850210">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11374">PR #11374</a>:</p>
<blockquote>
<blockquote>
<p>I'd naturally like to double-check you're ok with these refactorings though so lemme know if you feel they don't fit well.</p>
</blockquote>
<p>LGTM, thanks.</p>
</blockquote>



<a name="534009067"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311374%20use%20a%20single%20table%20per%20instance%20for%20.../near/534009067" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311374.20use.20a.20single.20table.20per.20instance.20for.20.2E.2E.2E.html#534009067">(Aug 12 2025 at 15:47)</a>:</h4>
<p>dicej updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11374">PR #11374</a>.</p>



<a name="534027119"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311374%20use%20a%20single%20table%20per%20instance%20for%20.../near/534027119" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311374.20use.20a.20single.20table.20per.20instance.20for.20.2E.2E.2E.html#534027119">(Aug 12 2025 at 17:35)</a>:</h4>
<p>dicej updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11374">PR #11374</a>.</p>



<a name="534027160"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311374%20use%20a%20single%20table%20per%20instance%20for%20.../near/534027160" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311374.20use.20a.20single.20table.20per.20instance.20for.20.2E.2E.2E.html#534027160">(Aug 12 2025 at 17:35)</a>:</h4>
<p>dicej submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11374#pullrequestreview-3112006131">PR review</a>.</p>



<a name="534027161"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311374%20use%20a%20single%20table%20per%20instance%20for%20.../near/534027161" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311374.20use.20a.20single.20table.20per.20instance.20for.20.2E.2E.2E.html#534027161">(Aug 12 2025 at 17:36)</a>:</h4>
<p>dicej created <a href="https://github.com/bytecodealliance/wasmtime/pull/11374#discussion_r2270652495">PR review comment</a>:</p>
<blockquote>
<p>I just pushed an update; please let me know what you think.</p>
</blockquote>



<a name="534029264"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311374%20use%20a%20single%20table%20per%20instance%20for%20.../near/534029264" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311374.20use.20a.20single.20table.20per.20instance.20for.20.2E.2E.2E.html#534029264">(Aug 12 2025 at 17:53)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11374#pullrequestreview-3112057569">PR review</a>:</p>
<blockquote>
<p><span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span> </p>
<p>To clarify though, in the commit message you say:</p>
<blockquote>
<p>For <code>error-context</code> handles, the spec requirement that we always lower the same<br>
handle for the same <code>error-context</code>, combined with the fact that an<br>
<code>error-context</code> may be referenced by more than one component instance at a time,<br>
means we still need some general way to convert a host rep plus component index<br>
into a handle.  </p>
</blockquote>
<p>Is the latter part here still a motivation for this "local" reference count? For example if <code>reps_to_indexes</code> were entirely removed then <code>error_context_insert</code> would always create a fresh new handle (a violation of the current spec) but there's still a "global" reference count for the cross-component reference count for an error-context. Given that would it be possible to delete <code>reps_to_indexes</code> and have a temporary spec violation while the upstream spec is being sorted out?</p>
</blockquote>



<a name="534046387"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311374%20use%20a%20single%20table%20per%20instance%20for%20.../near/534046387" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311374.20use.20a.20single.20table.20per.20instance.20for.20.2E.2E.2E.html#534046387">(Aug 12 2025 at 19:54)</a>:</h4>
<p>dicej <a href="https://github.com/bytecodealliance/wasmtime/pull/11374#issuecomment-3180815518">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11374">PR #11374</a>:</p>
<blockquote>
<blockquote>
<p><span aria-label="+1" class="emoji emoji-1f44d" role="img" title="+1">:+1:</span></p>
<p>To clarify though, in the commit message you say:</p>
<blockquote>
<p>For <code>error-context</code> handles, the spec requirement that we always lower the same<br>
handle for the same <code>error-context</code>, combined with the fact that an<br>
<code>error-context</code> may be referenced by more than one component instance at a time,<br>
means we still need some general way to convert a host rep plus component index<br>
into a handle.</p>
</blockquote>
<p>Is the latter part here still a motivation for this "local" reference count? For example if <code>reps_to_indexes</code> were entirely removed then <code>error_context_insert</code> would always create a fresh new handle (a violation of the current spec) but there's still a "global" reference count for the cross-component reference count for an error-context. Given that would it be possible to delete <code>reps_to_indexes</code> and have a temporary spec violation while the upstream spec is being sorted out?</p>
</blockquote>
<p>Looks like the <code>error-context</code> "same handle" requirement is no longer part of the spec anyway, so I'll go ahead and remove that.</p>
</blockquote>



<a name="534050056"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311374%20use%20a%20single%20table%20per%20instance%20for%20.../near/534050056" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311374.20use.20a.20single.20table.20per.20instance.20for.20.2E.2E.2E.html#534050056">(Aug 12 2025 at 20:21)</a>:</h4>
<p>dicej updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11374">PR #11374</a>.</p>



<a name="534050085"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311374%20use%20a%20single%20table%20per%20instance%20for%20.../near/534050085" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311374.20use.20a.20single.20table.20per.20instance.20for.20.2E.2E.2E.html#534050085">(Aug 12 2025 at 20:21)</a>:</h4>
<p>dicej has enabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/11374">PR #11374</a>.</p>



<a name="534054245"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311374%20use%20a%20single%20table%20per%20instance%20for%20.../near/534054245" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311374.20use.20a.20single.20table.20per.20instance.20for.20.2E.2E.2E.html#534054245">(Aug 12 2025 at 20:53)</a>:</h4>
<p>dicej merged <a href="https://github.com/bytecodealliance/wasmtime/pull/11374">PR #11374</a>.</p>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
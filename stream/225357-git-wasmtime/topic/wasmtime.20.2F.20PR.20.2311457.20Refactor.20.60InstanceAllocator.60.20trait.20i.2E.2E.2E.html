<html>
<head><meta charset="utf-8"><title>wasmtime / PR #11457 Refactor `InstanceAllocator` trait i... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311457.20Refactor.20.60InstanceAllocator.60.20trait.20i.2E.2E.2E.html">wasmtime / PR #11457 Refactor `InstanceAllocator` trait i...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="535146504"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311457%20Refactor%20%60InstanceAllocator%60%20trait%20i.../near/535146504" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311457.20Refactor.20.60InstanceAllocator.60.20trait.20i.2E.2E.2E.html#535146504">(Aug 19 2025 at 14:48)</a>:</h4>
<p>alexcrichton opened <a href="https://github.com/bytecodealliance/wasmtime/pull/11457">PR #11457</a> from <code>alexcrichton:instance-allocator-refactor</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>Prior to this commit Wasmtime had an <code>InstanceAllocatorImpl</code> trait with a number of required methods as well as an <code>InstanceAllocator</code> trait with a number of provided impls. The <code>InstanceAllocator</code> trait is implemented for everything implementing <code>InstanceAllocatorImpl</code> to force users to be unable to override the default methods. When adding <code>async</code> support internally to Wasmtime these are going to need to be <code>#[async_trait]</code>-annotated-traits which adds a cost to <code>async</code> functions as a future needs to be heap-allocated.</p>
<p>The goal of this commit is to make this future <code>async</code>-ification a bit more optimal. Notably the <code>InstanceAllocator</code> trait is removed and replaced with inherent methods on <code>impl dyn InstanceAllocatorImpl</code>. After that the previous <code>InstanceAllocatorImpl</code> trait was renamed to <code>InstanceAllocator</code> meaning that there's just one <code>InstanceAllocator</code> trait which has inherent methods which cannot be overridden. A consequence of this is that the inherent methods are also forced to do virtual dispatch unlike before where they would internally use monomorphization to have static dispatch. Given the complexity of instance allocation this is expected to be a negligible cost, however.</p>
<p>The main benefit is that <code>allocate_module</code>, <code>allocate_tables</code>, and <code>allocate_memories</code> all get to be native <code>async</code> functions without the cost of <code>#[async_trait]</code>. Only allocation of a single table/memory will require an allocation of a future which in profiling helps reduce the cost of instantiation slightly.</p>
<p>Note that <code>#[async_trait]</code> is not currently used, this commit is just preparation for its eventual use.</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="535146507"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311457%20Refactor%20%60InstanceAllocator%60%20trait%20i.../near/535146507" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311457.20Refactor.20.60InstanceAllocator.60.20trait.20i.2E.2E.2E.html#535146507">(Aug 19 2025 at 14:48)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/fitzgen">fitzgen</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/11457">PR #11457</a>.</p>



<a name="535146508"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311457%20Refactor%20%60InstanceAllocator%60%20trait%20i.../near/535146508" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311457.20Refactor.20.60InstanceAllocator.60.20trait.20i.2E.2E.2E.html#535146508">(Aug 19 2025 at 14:48)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers">wasmtime-core-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/11457">PR #11457</a>.</p>



<a name="535168121"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311457%20Refactor%20%60InstanceAllocator%60%20trait%20i.../near/535168121" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311457.20Refactor.20.60InstanceAllocator.60.20trait.20i.2E.2E.2E.html#535168121">(Aug 19 2025 at 16:43)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11457#pullrequestreview-3133092022">PR review</a>.</p>



<a name="535171209"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311457%20Refactor%20%60InstanceAllocator%60%20trait%20i.../near/535171209" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311457.20Refactor.20.60InstanceAllocator.60.20trait.20i.2E.2E.2E.html#535171209">(Aug 19 2025 at 17:04)</a>:</h4>
<p>fitzgen merged <a href="https://github.com/bytecodealliance/wasmtime/pull/11457">PR #11457</a>.</p>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
<html>
<head><meta charset="utf-8"><title>wasmtime / PR #10817 x64: Fix panic compiling 16-bit mult... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310817.20x64.3A.20Fix.20panic.20compiling.2016-bit.20mult.2E.2E.2E.html">wasmtime / PR #10817 x64: Fix panic compiling 16-bit mult...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="519460902"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310817%20x64%3A%20Fix%20panic%20compiling%2016-bit%20mult.../near/519460902" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310817.20x64.3A.20Fix.20panic.20compiling.2016-bit.20mult.2E.2E.2E.html#519460902">(May 20 2025 at 19:34)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/cfallin">cfallin</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/10817">PR #10817</a>.</p>



<a name="519460903"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310817%20x64%3A%20Fix%20panic%20compiling%2016-bit%20mult.../near/519460903" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310817.20x64.3A.20Fix.20panic.20compiling.2016-bit.20mult.2E.2E.2E.html#519460903">(May 20 2025 at 19:34)</a>:</h4>
<p>alexcrichton opened <a href="https://github.com/bytecodealliance/wasmtime/pull/10817">PR #10817</a> from <code>alexcrichton:fix-imul-fuzz</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>This commit fixes a minor regression from #10782 found via fuzzing. The regression is 16-bit immediates were forced to fit from an <code>i32</code> value into a <code>u16</code> for 16-bit multiplication. This meant though that negative numbers failed this conversion which meant that ISLE would panic due to the value not being matched. This fixes the logic to first fit the i32 into an i16 and then cast that to a u16 where the first phase should hit all the constants that are possible in Cranelift.</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="519460904"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310817%20x64%3A%20Fix%20panic%20compiling%2016-bit%20mult.../near/519460904" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310817.20x64.3A.20Fix.20panic.20compiling.2016-bit.20mult.2E.2E.2E.html#519460904">(May 20 2025 at 19:34)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/10817">PR #10817</a>.</p>



<a name="519460906"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310817%20x64%3A%20Fix%20panic%20compiling%2016-bit%20mult.../near/519460906" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310817.20x64.3A.20Fix.20panic.20compiling.2016-bit.20mult.2E.2E.2E.html#519460906">(May 20 2025 at 19:34)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/dicej">dicej</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/10817">PR #10817</a>.</p>



<a name="519460907"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310817%20x64%3A%20Fix%20panic%20compiling%2016-bit%20mult.../near/519460907" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310817.20x64.3A.20Fix.20panic.20compiling.2016-bit.20mult.2E.2E.2E.html#519460907">(May 20 2025 at 19:34)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers">wasmtime-core-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/10817">PR #10817</a>.</p>



<a name="519461265"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310817%20x64%3A%20Fix%20panic%20compiling%2016-bit%20mult.../near/519461265" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310817.20x64.3A.20Fix.20panic.20compiling.2016-bit.20mult.2E.2E.2E.html#519461265">(May 20 2025 at 19:36)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/10817#pullrequestreview-2855375400">PR review</a>.</p>



<a name="519461267"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310817%20x64%3A%20Fix%20panic%20compiling%2016-bit%20mult.../near/519461267" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310817.20x64.3A.20Fix.20panic.20compiling.2016-bit.20mult.2E.2E.2E.html#519461267">(May 20 2025 at 19:36)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/10817#discussion_r2098726101">PR review comment</a>:</p>
<blockquote>
<p>I'll admit this is testing the limits of my CLIF knowledge. This will fail when the <code>i32</code> value fits in a <code>u16</code>, but not an <code>i16</code>, meaning that we'll still panic during instruction selection from that. I don't know whether that's possible in CLIF though, or if <code>iconst</code> values are always sign-extended from their type.</p>
</blockquote>



<a name="519461268"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310817%20x64%3A%20Fix%20panic%20compiling%2016-bit%20mult.../near/519461268" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310817.20x64.3A.20Fix.20panic.20compiling.2016-bit.20mult.2E.2E.2E.html#519461268">(May 20 2025 at 19:36)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/10817#pullrequestreview-2855375444">PR review</a>.</p>



<a name="519461282"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310817%20x64%3A%20Fix%20panic%20compiling%2016-bit%20mult.../near/519461282" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310817.20x64.3A.20Fix.20panic.20compiling.2016-bit.20mult.2E.2E.2E.html#519461282">(May 20 2025 at 19:36)</a>:</h4>
<p>cfallin has enabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/10817">PR #10817</a>.</p>



<a name="519463608"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310817%20x64%3A%20Fix%20panic%20compiling%2016-bit%20mult.../near/519463608" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310817.20x64.3A.20Fix.20panic.20compiling.2016-bit.20mult.2E.2E.2E.html#519463608">(May 20 2025 at 19:52)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/10817#discussion_r2098747005">PR review comment</a>:</p>
<blockquote>
<p>Oh, missed that, sorry -- unfortunately we've standardized on zero extension instead (it keeps the majority of cases simpler). Fortunately if this extractor returns <code>None</code> then the rule just doesn't match -- no runtime panic unless there's not another fallback? Let's (i) add a test case with a value in that range (say 40000) and (ii) verify there is...</p>
</blockquote>



<a name="519463609"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310817%20x64%3A%20Fix%20panic%20compiling%2016-bit%20mult.../near/519463609" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310817.20x64.3A.20Fix.20panic.20compiling.2016-bit.20mult.2E.2E.2E.html#519463609">(May 20 2025 at 19:52)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/10817#pullrequestreview-2855408908">PR review</a>.</p>



<a name="519475998"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310817%20x64%3A%20Fix%20panic%20compiling%2016-bit%20mult.../near/519475998" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310817.20x64.3A.20Fix.20panic.20compiling.2016-bit.20mult.2E.2E.2E.html#519475998">(May 20 2025 at 21:17)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/10817">PR #10817</a>.</p>



<a name="519476270"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310817%20x64%3A%20Fix%20panic%20compiling%2016-bit%20mult.../near/519476270" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310817.20x64.3A.20Fix.20panic.20compiling.2016-bit.20mult.2E.2E.2E.html#519476270">(May 20 2025 at 21:19)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/10817#pullrequestreview-2855623454">PR review</a>.</p>



<a name="519476272"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310817%20x64%3A%20Fix%20panic%20compiling%2016-bit%20mult.../near/519476272" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310817.20x64.3A.20Fix.20panic.20compiling.2016-bit.20mult.2E.2E.2E.html#519476272">(May 20 2025 at 21:19)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/10817#discussion_r2098895239">PR review comment</a>:</p>
<blockquote>
<p>Ok I've added a few CLIF tests for this and it looks like things are actually working as intended. Looks like <a href="https://github.com/bytecodealliance/wasmtime/blob/24730416736955f370b5074f1874cea2dab2784d/cranelift/codegen/src/machinst/isle.rs#L222">when accessing the constant in ISLE</a> it gets sign-extended based on the type of the constant itself, which is why this ended up working out. Yay!</p>
</blockquote>



<a name="519476285"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310817%20x64%3A%20Fix%20panic%20compiling%2016-bit%20mult.../near/519476285" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310817.20x64.3A.20Fix.20panic.20compiling.2016-bit.20mult.2E.2E.2E.html#519476285">(May 20 2025 at 21:19)</a>:</h4>
<p>alexcrichton has enabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/10817">PR #10817</a>.</p>



<a name="519480417"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310817%20x64%3A%20Fix%20panic%20compiling%2016-bit%20mult.../near/519480417" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310817.20x64.3A.20Fix.20panic.20compiling.2016-bit.20mult.2E.2E.2E.html#519480417">(May 20 2025 at 21:52)</a>:</h4>
<p>alexcrichton merged <a href="https://github.com/bytecodealliance/wasmtime/pull/10817">PR #10817</a>.</p>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
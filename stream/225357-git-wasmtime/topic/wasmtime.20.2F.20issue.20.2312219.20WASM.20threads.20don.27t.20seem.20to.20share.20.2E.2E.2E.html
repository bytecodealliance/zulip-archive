<html>
<head><meta charset="utf-8"><title>wasmtime / issue #12219 WASM threads don&#x27;t seem to share ... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312219.20WASM.20threads.20don.27t.20seem.20to.20share.20.2E.2E.2E.html">wasmtime / issue #12219 WASM threads don&#x27;t seem to share ...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="565378907"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312219%20WASM%20threads%20don%27t%20seem%20to%20share%20.../near/565378907" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312219.20WASM.20threads.20don.27t.20seem.20to.20share.20.2E.2E.2E.html#565378907">(Dec 25 2025 at 15:46)</a>:</h4>
<p>fatlotus opened <a href="https://github.com/bytecodealliance/wasmtime/issues/12219">issue #12219</a>:</p>
<blockquote>
<p>Please take this report with a grain of salt as I'm fairly new with WASM.</p>
<h3>Test Case</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="p">#</span><span class="n">include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">cassert</span><span class="o">&gt;</span>
<span class="p">#</span><span class="n">include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">cstdint</span><span class="o">&gt;</span>
<span class="p">#</span><span class="n">include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">cstdio</span><span class="o">&gt;</span>
<span class="p">#</span><span class="n">include</span><span class="w"> </span><span class="o">&lt;</span><span class="n">unistd</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>

<span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="p">{</span>
<span class="n">__attribute__</span><span class="p">((</span><span class="n">import_module</span><span class="p">(</span><span class="s">"wasi"</span><span class="p">),</span><span class="w"> </span><span class="n">import_name</span><span class="p">(</span><span class="s">"thread-spawn"</span><span class="p">)))</span>
<span class="n">int32_t</span><span class="w"> </span><span class="n">spawn_a_thread</span><span class="p">(</span><span class="n">void</span><span class="w"> </span><span class="o">*</span><span class="n">thread_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">int</span><span class="w"> </span><span class="n">magic_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="p">[[</span><span class="n">clang</span><span class="p">::</span><span class="n">export_name</span><span class="p">(</span><span class="s">"wasi_thread_start"</span><span class="p">)]]</span>
<span class="n">void</span><span class="w"> </span><span class="n">wasi_thread_start</span><span class="p">(</span><span class="n">int32_t</span><span class="w"> </span><span class="n">tid</span><span class="p">,</span><span class="w"> </span><span class="n">int</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">"Running on a thread. tid=%d, arg=%p, magic_number=%d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">tid</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="p">,</span>
<span class="w">         </span><span class="n">magic_number</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">int</span><span class="w"> </span><span class="n">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">magic_number</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">  </span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">  </span><span class="n">int</span><span class="w"> </span><span class="n">thread_data</span><span class="p">;</span>
<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">"thread_data=%p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">thread_data</span><span class="p">);</span>
<span class="w">  </span><span class="n">int</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spawn_a_thread</span><span class="p">(</span><span class="o">&amp;</span><span class="n">thread_data</span><span class="p">);</span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">tid</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">  </span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">"After</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>Here's what this compiles to (apologies, it's pretty long) with Homebrew Clang 21.1.8:</p>
<p><a href="https://github.com/user-attachments/files/24339350/main.wat.txt">main.wat.txt</a></p>
<h3>Steps to Reproduce</h3>
<ul>
<li>wasmtime: <code>$ wasmtime run --wasi threads=y --wasm threads=y main.wat</code></li>
<li>WAMR: <code>$ iwasm --max-threads=2 main.wasm</code></li>
</ul>
<h3>Expected Results</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">iwasm</span><span class="w"> </span><span class="o">--</span><span class="n">max</span><span class="o">-</span><span class="n">threads</span><span class="o">=</span><span class="mi">2</span><span class="w"> </span><span class="n">main</span><span class="p">.</span><span class="n">wat</span>
<span class="n">thread_data</span><span class="o">=</span><span class="mh">0x113b8</span>
<span class="n">Running</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">thread</span><span class="p">.</span><span class="w"> </span><span class="n">tid</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="o">=</span><span class="mh">0x113b8</span><span class="p">,</span><span class="w"> </span><span class="n">magic_number</span><span class="o">=</span><span class="mi">1</span>
<span class="n">After</span>
</code></pre></div>
<h3>Actual Results</h3>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">wasi</span><span class="w"> </span><span class="n">threads</span><span class="o">=</span><span class="n">y</span><span class="w"> </span><span class="o">--</span><span class="n">wasm</span><span class="w"> </span><span class="n">threads</span><span class="o">=</span><span class="n">y</span><span class="w"> </span><span class="n">main</span><span class="p">.</span><span class="n">wat</span>
<span class="n">thread_data</span><span class="o">=</span><span class="mh">0x113b8</span>
<span class="n">Running</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">thread</span><span class="p">.</span><span class="w"> </span><span class="n">tid</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="o">=</span><span class="mh">0x113b8</span><span class="p">,</span><span class="w"> </span><span class="n">magic_number</span><span class="o">=</span><span class="mi">0</span>
<span class="n">After</span>
</code></pre></div>
<p>In particular, I think the thread should see a <code>magic_number</code> of 1, since it has been incremented by the main program before the thread started.</p>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: wasmtime 39.0.1</p>
<p>Operating system: macOS 14.6.1</p>
<p>Architecture: M1</p>
<h3>Extra Info</h3>
<p>There's some funny logic here (<a href="https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasi-threads/src/lib.rs#L165-L179">https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasi-threads/src/lib.rs#L165-L179</a>) in the wasi threads crate, where the shared memory is somehow re-injected into the linker. In the clang-generated code, the shared memory isn't imported — maybe that means the linker doesn't inject the same shared memory region to each thread?</p>
</blockquote>



<a name="565378908"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312219%20WASM%20threads%20don%27t%20seem%20to%20share%20.../near/565378908" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312219.20WASM.20threads.20don.27t.20seem.20to.20share.20.2E.2E.2E.html#565378908">(Dec 25 2025 at 15:46)</a>:</h4>
<p><a href="https://github.com/fatlotus">fatlotus</a> added the bug label to <a href="https://github.com/bytecodealliance/wasmtime/issues/12219">Issue #12219</a>.</p>



<a name="565378954"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312219%20WASM%20threads%20don%27t%20seem%20to%20share%20.../near/565378954" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312219.20WASM.20threads.20don.27t.20seem.20to.20share.20.2E.2E.2E.html#565378954">(Dec 25 2025 at 15:47)</a>:</h4>
<p>fatlotus edited <a href="https://github.com/bytecodealliance/wasmtime/issues/12219">issue #12219</a>:</p>
<blockquote>
<p>Please take this report with a grain of salt as I'm fairly new with WASM.</p>
<h3>Test Case</h3>
<div class="codehilite" data-code-language="C++"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cassert&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cstdint&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cstdio&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;unistd.h&gt;</span>

<span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="p">{</span>
<span class="n">__attribute__</span><span class="p">((</span><span class="n">import_module</span><span class="p">(</span><span class="s">"wasi"</span><span class="p">),</span><span class="w"> </span><span class="n">import_name</span><span class="p">(</span><span class="s">"thread-spawn"</span><span class="p">)))</span>
<span class="kt">int32_t</span><span class="w"> </span><span class="n">spawn_a_thread</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">thread_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="n">magic_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="p">[[</span><span class="n">clang</span><span class="o">::</span><span class="n">export_name</span><span class="p">(</span><span class="s">"wasi_thread_start"</span><span class="p">)]]</span>
<span class="kt">void</span><span class="w"> </span><span class="n">wasi_thread_start</span><span class="p">(</span><span class="kt">int32_t</span><span class="w"> </span><span class="n">tid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">"Running on a thread. tid=%d, arg=%p, magic_number=%d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">tid</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="p">,</span>
<span class="w">         </span><span class="n">magic_number</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="n">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">magic_number</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">  </span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">thread_data</span><span class="p">;</span>
<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">"thread_data=%p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">thread_data</span><span class="p">);</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spawn_a_thread</span><span class="p">(</span><span class="o">&amp;</span><span class="n">thread_data</span><span class="p">);</span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">tid</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">  </span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">"After</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>Here's what this compiles to (apologies, it's pretty long) with Homebrew Clang 21.1.8:</p>
<p><a href="https://github.com/user-attachments/files/24339350/main.wat.txt">main.wat.txt</a></p>
<h3>Steps to Reproduce</h3>
<ul>
<li>wasmtime: <code>$ wasmtime run --wasi threads=y --wasm threads=y main.wat</code></li>
<li>WAMR: <code>$ iwasm --max-threads=2 main.wasm</code></li>
</ul>
<h3>Expected Results</h3>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>$<span class="w"> </span>iwasm<span class="w"> </span>--max-threads<span class="o">=</span><span class="m">2</span><span class="w"> </span>main.wat
<span class="nv">thread_data</span><span class="o">=</span>0x113b8
Running<span class="w"> </span>on<span class="w"> </span>a<span class="w"> </span>thread.<span class="w"> </span><span class="nv">tid</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">arg</span><span class="o">=</span>0x113b8,<span class="w"> </span><span class="nv">magic_number</span><span class="o">=</span><span class="m">1</span>
After
</code></pre></div>
<h3>Actual Results</h3>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>$<span class="w"> </span>wasmtime<span class="w"> </span>run<span class="w"> </span>--wasi<span class="w"> </span><span class="nv">threads</span><span class="o">=</span>y<span class="w"> </span>--wasm<span class="w"> </span><span class="nv">threads</span><span class="o">=</span>y<span class="w"> </span>main.wat
<span class="nv">thread_data</span><span class="o">=</span>0x113b8
Running<span class="w"> </span>on<span class="w"> </span>a<span class="w"> </span>thread.<span class="w"> </span><span class="nv">tid</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">arg</span><span class="o">=</span>0x113b8,<span class="w"> </span><span class="nv">magic_number</span><span class="o">=</span><span class="m">0</span>
After
</code></pre></div>
<p>In particular, I think the thread should see a <code>magic_number</code> of 1, since it has been incremented by the main program before the thread started.</p>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: wasmtime 39.0.1</p>
<p>Operating system: macOS 14.6.1</p>
<p>Architecture: M1</p>
<h3>Extra Info</h3>
<p>There's some funny logic here (<a href="https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasi-threads/src/lib.rs#L165-L179">https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasi-threads/src/lib.rs#L165-L179</a>) in the wasi threads crate, where the shared memory is somehow re-injected into the linker. In the clang-generated code, the shared memory isn't imported — maybe that means the linker doesn't inject the same shared memory region to each thread?</p>
</blockquote>



<a name="565379012"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312219%20WASM%20threads%20don%27t%20seem%20to%20share%20.../near/565379012" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312219.20WASM.20threads.20don.27t.20seem.20to.20share.20.2E.2E.2E.html#565379012">(Dec 25 2025 at 15:49)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/12219#issuecomment-3691556740">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12219">issue #12219</a>:</p>
<blockquote>
<p>Did you compile for the wasm32-wasip1 or wasm32-wasip1-threads target?</p>
</blockquote>



<a name="565379113"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312219%20WASM%20threads%20don%27t%20seem%20to%20share%20.../near/565379113" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312219.20WASM.20threads.20don.27t.20seem.20to.20share.20.2E.2E.2E.html#565379113">(Dec 25 2025 at 15:51)</a>:</h4>
<p>fatlotus <a href="https://github.com/bytecodealliance/wasmtime/issues/12219#issuecomment-3691558267">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12219">issue #12219</a>:</p>
<blockquote>
<p>I'm using <code>wasm32-wasip1-threads</code>, but it reproduces on both targets. The full command line I'm using is:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">homebrew</span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">llvm</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">clang</span><span class="o">++</span><span class="w"> </span><span class="o">--</span><span class="n">std</span><span class="o">=</span><span class="n">c</span><span class="o">++</span><span class="mi">17</span><span class="w"> </span><span class="o">-</span><span class="n">g</span><span class="w"> </span><span class="o">--</span><span class="n">target</span><span class="o">=</span><span class="n">wasm32</span><span class="o">-</span><span class="n">wasip1</span><span class="o">-</span><span class="n">threads</span><span class="w"> </span><span class="o">--</span><span class="n">sysroot</span><span class="o">=/</span><span class="n">Users</span><span class="o">/</span><span class="n">jeremyarcher</span><span class="o">/</span><span class="n">Downloads</span><span class="o">/</span><span class="n">wasi</span><span class="o">-</span><span class="n">sdk</span><span class="o">-</span><span class="mf">29.0</span><span class="o">-</span><span class="n">arm64</span><span class="o">-</span><span class="n">macos</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">wasi</span><span class="o">-</span><span class="n">sysroot</span><span class="w"> </span><span class="n">main</span><span class="p">.</span><span class="n">cpp</span><span class="w"> </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="n">main</span><span class="p">.</span><span class="n">wasm</span>
</code></pre></div>
<p>(One other hypothesis I had was that the <code>start</code> function might be reinitializing main memory when starting the second <code>Instance</code> for the new thread.)</p>
</blockquote>



<a name="565379127"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312219%20WASM%20threads%20don%27t%20seem%20to%20share%20.../near/565379127" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312219.20WASM.20threads.20don.27t.20seem.20to.20share.20.2E.2E.2E.html#565379127">(Dec 25 2025 at 15:52)</a>:</h4>
<p>fatlotus edited a <a href="https://github.com/bytecodealliance/wasmtime/issues/12219#issuecomment-3691558267">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12219">issue #12219</a>:</p>
<blockquote>
<p>I'm using <code>wasm32-wasip1-threads</code>, but it reproduces on both targets. The full command line I'm using is:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="cp">$</span><span class="w"> </span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">homebrew</span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">llvm</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">clang</span><span class="o">++</span><span class="w"> </span><span class="o">--</span><span class="n">std</span><span class="o">=</span><span class="n">c</span><span class="o">++</span><span class="mi">17</span><span class="w"> </span><span class="o">-</span><span class="n">g</span><span class="w"> </span><span class="o">--</span><span class="n">target</span><span class="o">=</span><span class="n">wasm32</span><span class="o">-</span><span class="n">wasip1</span><span class="o">-</span><span class="n">threads</span><span class="w"> </span><span class="o">--</span><span class="n">sysroot</span><span class="o">=~/</span><span class="n">Downloads</span><span class="o">/</span><span class="n">wasi</span><span class="o">-</span><span class="n">sdk</span><span class="o">-</span><span class="mf">29.0</span><span class="o">-</span><span class="n">arm64</span><span class="o">-</span><span class="n">macos</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">wasi</span><span class="o">-</span><span class="n">sysroot</span><span class="w"> </span><span class="n">main</span><span class="p">.</span><span class="n">cpp</span><span class="w"> </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="n">main</span><span class="p">.</span><span class="n">wasm</span>
</code></pre></div>
<p>(One other hypothesis I had was that the <code>start</code> function might be reinitializing main memory when starting the second <code>Instance</code> for the new thread.)</p>
</blockquote>



<a name="565380421"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312219%20WASM%20threads%20don%27t%20seem%20to%20share%20.../near/565380421" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312219.20WASM.20threads.20don.27t.20seem.20to.20share.20.2E.2E.2E.html#565380421">(Dec 25 2025 at 16:22)</a>:</h4>
<p>bjorn3 <a href="https://github.com/bytecodealliance/wasmtime/issues/12219#issuecomment-3691580326">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12219">issue #12219</a>:</p>
<blockquote>
<p>Try linking with <code>-Wl,--import-memory,--export-memory</code></p>
</blockquote>



<a name="565387457"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312219%20WASM%20threads%20don%27t%20seem%20to%20share%20.../near/565387457" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312219.20WASM.20threads.20don.27t.20seem.20to.20share.20.2E.2E.2E.html#565387457">(Dec 25 2025 at 19:30)</a>:</h4>
<p>fatlotus <a href="https://github.com/bytecodealliance/wasmtime/issues/12219#issuecomment-3691691143">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12219">issue #12219</a>:</p>
<blockquote>
<p>Yep, that does the trick!</p>
<p>I wonder if that logic at the end of <code>add_to_linker</code> was meant to be:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">import</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">module</span><span class="p">.</span><span class="n">imports</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">import</span><span class="p">.</span><span class="n">ty</span><span class="p">().</span><span class="n">memory</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="n">is_shared</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">mem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SharedMemory</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">module</span><span class="p">.</span><span class="n">engine</span><span class="p">(),</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="n">clone</span><span class="p">())</span><span class="o">?</span><span class="p">;</span>
<span class="w">            </span><span class="n">linker</span><span class="p">.</span><span class="n">define</span><span class="p">(</span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="n">import</span><span class="p">.</span><span class="n">module</span><span class="p">(),</span><span class="w"> </span><span class="n">import</span><span class="p">.</span><span class="n">name</span><span class="p">(),</span><span class="w"> </span><span class="n">mem</span><span class="p">.</span><span class="n">clone</span><span class="p">())</span><span class="o">?</span><span class="p">;</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">anyhow</span><span class="o">!</span><span class="p">(</span>
<span class="w">      </span><span class="s">"memory was not shared; a `wasi-threads` must import \</span>
<span class="s">        a shared memory as </span><span class="se">\"</span><span class="s">memory</span><span class="se">\"</span><span class="s">"</span>
<span class="w">    </span><span class="p">));</span>
</code></pre></div>
<p>That way this case would be an error.</p>
</blockquote>



<a name="565389897"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312219%20WASM%20threads%20don%27t%20seem%20to%20share%20.../near/565389897" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312219.20WASM.20threads.20don.27t.20seem.20to.20share.20.2E.2E.2E.html#565389897">(Dec 25 2025 at 20:43)</a>:</h4>
<p>fatlotus edited <a href="https://github.com/bytecodealliance/wasmtime/issues/12219">issue #12219</a>:</p>
<blockquote>
<p>Please take this report with a grain of salt as I'm fairly new with WASM.</p>
<h3>Test Case</h3>
<div class="codehilite" data-code-language="C++"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cassert&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cstdint&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cstdio&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;unistd.h&gt;</span>

<span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="p">{</span>
<span class="n">__attribute__</span><span class="p">((</span><span class="n">import_module</span><span class="p">(</span><span class="s">"wasi"</span><span class="p">),</span><span class="w"> </span><span class="n">import_name</span><span class="p">(</span><span class="s">"thread-spawn"</span><span class="p">)))</span>
<span class="kt">int32_t</span><span class="w"> </span><span class="n">spawn_a_thread</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">thread_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="n">magic_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="p">[[</span><span class="n">clang</span><span class="o">::</span><span class="n">export_name</span><span class="p">(</span><span class="s">"wasi_thread_start"</span><span class="p">)]]</span>
<span class="kt">void</span><span class="w"> </span><span class="n">wasi_thread_start</span><span class="p">(</span><span class="kt">int32_t</span><span class="w"> </span><span class="n">tid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">"Running on a thread. tid=%d, arg=%p, magic_number=%d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">tid</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="p">,</span>
<span class="w">         </span><span class="n">magic_number</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="n">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">magic_number</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">  </span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">thread_data</span><span class="p">;</span>
<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">"thread_data=%p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">thread_data</span><span class="p">);</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spawn_a_thread</span><span class="p">(</span><span class="o">&amp;</span><span class="n">thread_data</span><span class="p">);</span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">tid</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">  </span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">"After</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>Here's what this compiles to (apologies, it's pretty long) with Homebrew Clang 21.1.8:</p>
<p><a href="https://github.com/user-attachments/files/24339350/main.wat.txt">main.wat.txt</a></p>
<h3>Steps to Reproduce</h3>
<ul>
<li>wasmtime: <code>$ wasmtime run --wasi threads=y --wasm threads=y main.wat</code></li>
<li>WAMR: <code>$ iwasm --max-threads=2 main.wasm</code></li>
</ul>
<h3>Expected Results</h3>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>$<span class="w"> </span>iwasm<span class="w"> </span>--max-threads<span class="o">=</span><span class="m">2</span><span class="w"> </span>main.wat
<span class="nv">thread_data</span><span class="o">=</span>0x113b8
Running<span class="w"> </span>on<span class="w"> </span>a<span class="w"> </span>thread.<span class="w"> </span><span class="nv">tid</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">arg</span><span class="o">=</span>0x113b8,<span class="w"> </span><span class="nv">magic_number</span><span class="o">=</span><span class="m">1</span>
After
</code></pre></div>
<h3>Actual Results</h3>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>$<span class="w"> </span>wasmtime<span class="w"> </span>run<span class="w"> </span>--wasi<span class="w"> </span><span class="nv">threads</span><span class="o">=</span>y<span class="w"> </span>--wasm<span class="w"> </span><span class="nv">threads</span><span class="o">=</span>y<span class="w"> </span>main.wat
<span class="nv">thread_data</span><span class="o">=</span>0x113b8
Running<span class="w"> </span>on<span class="w"> </span>a<span class="w"> </span>thread.<span class="w"> </span><span class="nv">tid</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">arg</span><span class="o">=</span>0x113b8,<span class="w"> </span><span class="nv">magic_number</span><span class="o">=</span><span class="m">0</span>
After
</code></pre></div>
<p>In particular, I think the thread should see a <code>magic_number</code> of 1, since it has been incremented by the main program before the thread started.</p>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: wasmtime 39.0.1</p>
<p>Operating system: macOS 14.6.1</p>
<p>Architecture: M1</p>
<h3>Extra Info</h3>
<p>There's some funny logic here (<a href="https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasi-threads/src/lib.rs#L165-L179">https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasi-threads/src/lib.rs#L165-L179</a>) in the wasi threads crate, where the shared memory is somehow re-injected into the linker. In the clang-generated code, the shared memory isn't imported — maybe that means the linker doesn't inject the same shared memory region to each thread?</p>
</blockquote>



<a name="565389901"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312219%20WASM%20threads%20don%27t%20seem%20to%20share%20.../near/565389901" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312219.20WASM.20threads.20don.27t.20seem.20to.20share.20.2E.2E.2E.html#565389901">(Dec 25 2025 at 20:44)</a>:</h4>
<p>fatlotus edited <a href="https://github.com/bytecodealliance/wasmtime/issues/12219">issue #12219</a>:</p>
<blockquote>
<p>Please take this report with a grain of salt as I'm fairly new with WASM.</p>
<h3>Test Case</h3>
<div class="codehilite" data-code-language="C++"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cassert&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cstdint&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cstdio&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;unistd.h&gt;</span>

<span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="p">{</span>
<span class="n">__attribute__</span><span class="p">((</span><span class="n">import_module</span><span class="p">(</span><span class="s">"wasi"</span><span class="p">),</span><span class="w"> </span><span class="n">import_name</span><span class="p">(</span><span class="s">"thread-spawn"</span><span class="p">)))</span>
<span class="kt">int32_t</span><span class="w"> </span><span class="n">spawn_a_thread</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">thread_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="n">magic_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="p">[[</span><span class="n">clang</span><span class="o">::</span><span class="n">export_name</span><span class="p">(</span><span class="s">"wasi_thread_start"</span><span class="p">)]]</span>
<span class="kt">void</span><span class="w"> </span><span class="n">wasi_thread_start</span><span class="p">(</span><span class="kt">int32_t</span><span class="w"> </span><span class="n">tid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">"Running on a thread. tid=%d, arg=%p, magic_number=%d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">tid</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="p">,</span>
<span class="w">         </span><span class="n">magic_number</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="n">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">magic_number</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">  </span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">thread_data</span><span class="p">;</span>
<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">"thread_data=%p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">thread_data</span><span class="p">);</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spawn_a_thread</span><span class="p">(</span><span class="o">&amp;</span><span class="n">thread_data</span><span class="p">);</span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">tid</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">  </span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">"After</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>Here's what this compiles to (apologies, it's pretty long) with Homebrew Clang 21.1.8:</p>
<p><a href="https://github.com/user-attachments/files/24339350/main.wat.txt">main.wat.txt</a></p>
<h3>Steps to Reproduce</h3>
<ul>
<li>wasmtime: <code>$ wasmtime run --wasi threads=y --wasm threads=y main.wat</code></li>
<li>WAMR: <code>$ iwasm --max-threads=2 main.wasm</code></li>
</ul>
<h3>Expected Results</h3>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>$<span class="w"> </span>iwasm<span class="w"> </span>--max-threads<span class="o">=</span><span class="m">2</span><span class="w"> </span>main.wat
<span class="nv">thread_data</span><span class="o">=</span>0x113b8
Running<span class="w"> </span>on<span class="w"> </span>a<span class="w"> </span>thread.<span class="w"> </span><span class="nv">tid</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">arg</span><span class="o">=</span>0x113b8,<span class="w"> </span><span class="nv">magic_number</span><span class="o">=</span><span class="m">1</span>
After
</code></pre></div>
<h3>Actual Results</h3>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>$<span class="w"> </span>wasmtime<span class="w"> </span>run<span class="w"> </span>--wasi<span class="w"> </span><span class="nv">threads</span><span class="o">=</span>y<span class="w"> </span>--wasm<span class="w"> </span><span class="nv">threads</span><span class="o">=</span>y<span class="w"> </span>main.wat
<span class="nv">thread_data</span><span class="o">=</span>0x113b8
Running<span class="w"> </span>on<span class="w"> </span>a<span class="w"> </span>thread.<span class="w"> </span><span class="nv">tid</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">arg</span><span class="o">=</span>0x113b8,<span class="w"> </span><span class="nv">magic_number</span><span class="o">=</span><span class="m">0</span>
After
</code></pre></div>
<p>In particular, I think the thread should see a <code>magic_number</code> of 1, since it has been incremented by the main program before the thread started.</p>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: wasmtime 39.0.1</p>
<p>Operating system: macOS 14.6.1</p>
<p>Architecture: M1</p>
<h3>Extra Info</h3>
<p>There's some funny logic here (<a href="https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasi-threads/src/lib.rs#L165-L179">https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasi-threads/src/lib.rs#L165-L179</a>) in the wasi threads crate, where the shared memory is somehow re-injected into the linker. In the clang-generated code, the shared memory isn't imported — maybe that means the linker doesn't inject the same shared memory region to each thread?</p>
</blockquote>



<a name="566375990"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312219%20WASM%20threads%20don%27t%20seem%20to%20share%20.../near/566375990" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312219.20WASM.20threads.20don.27t.20seem.20to.20share.20.2E.2E.2E.html#566375990">(Jan 05 2026 at 15:11)</a>:</h4>
<p>alexcrichton closed <a href="https://github.com/bytecodealliance/wasmtime/issues/12219">issue #12219</a>:</p>
<blockquote>
<p>Please take this report with a grain of salt as I'm fairly new with WASM.</p>
<h3>Test Case</h3>
<div class="codehilite" data-code-language="C++"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cassert&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cstdint&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cstdio&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;unistd.h&gt;</span>

<span class="k">extern</span><span class="w"> </span><span class="s">"C"</span><span class="w"> </span><span class="p">{</span>
<span class="n">__attribute__</span><span class="p">((</span><span class="n">import_module</span><span class="p">(</span><span class="s">"wasi"</span><span class="p">),</span><span class="w"> </span><span class="n">import_name</span><span class="p">(</span><span class="s">"thread-spawn"</span><span class="p">)))</span>
<span class="kt">int32_t</span><span class="w"> </span><span class="n">spawn_a_thread</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">thread_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="n">magic_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="p">[[</span><span class="n">clang</span><span class="o">::</span><span class="n">export_name</span><span class="p">(</span><span class="s">"wasi_thread_start"</span><span class="p">)]]</span>
<span class="kt">void</span><span class="w"> </span><span class="n">wasi_thread_start</span><span class="p">(</span><span class="kt">int32_t</span><span class="w"> </span><span class="n">tid</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">"Running on a thread. tid=%d, arg=%p, magic_number=%d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">tid</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="p">,</span>
<span class="w">         </span><span class="n">magic_number</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="n">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">magic_number</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">  </span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">thread_data</span><span class="p">;</span>
<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">"thread_data=%p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">thread_data</span><span class="p">);</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">spawn_a_thread</span><span class="p">(</span><span class="o">&amp;</span><span class="n">thread_data</span><span class="p">);</span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">tid</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">  </span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">"After</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>Here's what this compiles to (apologies, it's pretty long) with Homebrew Clang 21.1.8:</p>
<p><a href="https://github.com/user-attachments/files/24339350/main.wat.txt">main.wat.txt</a></p>
<h3>Steps to Reproduce</h3>
<ul>
<li>wasmtime: <code>$ wasmtime run --wasi threads=y --wasm threads=y main.wat</code></li>
<li>WAMR: <code>$ iwasm --max-threads=2 main.wasm</code></li>
</ul>
<h3>Expected Results</h3>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>$<span class="w"> </span>iwasm<span class="w"> </span>--max-threads<span class="o">=</span><span class="m">2</span><span class="w"> </span>main.wat
<span class="nv">thread_data</span><span class="o">=</span>0x113b8
Running<span class="w"> </span>on<span class="w"> </span>a<span class="w"> </span>thread.<span class="w"> </span><span class="nv">tid</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">arg</span><span class="o">=</span>0x113b8,<span class="w"> </span><span class="nv">magic_number</span><span class="o">=</span><span class="m">1</span>
After
</code></pre></div>
<h3>Actual Results</h3>
<div class="codehilite" data-code-language="Bash"><pre><span></span><code>$<span class="w"> </span>wasmtime<span class="w"> </span>run<span class="w"> </span>--wasi<span class="w"> </span><span class="nv">threads</span><span class="o">=</span>y<span class="w"> </span>--wasm<span class="w"> </span><span class="nv">threads</span><span class="o">=</span>y<span class="w"> </span>main.wat
<span class="nv">thread_data</span><span class="o">=</span>0x113b8
Running<span class="w"> </span>on<span class="w"> </span>a<span class="w"> </span>thread.<span class="w"> </span><span class="nv">tid</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">arg</span><span class="o">=</span>0x113b8,<span class="w"> </span><span class="nv">magic_number</span><span class="o">=</span><span class="m">0</span>
After
</code></pre></div>
<p>In particular, I think the thread should see a <code>magic_number</code> of 1, since it has been incremented by the main program before the thread started.</p>
<h3>Versions and Environment</h3>
<p>Wasmtime version or commit: wasmtime 39.0.1</p>
<p>Operating system: macOS 14.6.1</p>
<p>Architecture: M1</p>
<h3>Extra Info</h3>
<p>There's some funny logic here (<a href="https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasi-threads/src/lib.rs#L165-L179">https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasi-threads/src/lib.rs#L165-L179</a>) in the wasi threads crate, where the shared memory is somehow re-injected into the linker. In the clang-generated code, the shared memory isn't imported — maybe that means the linker doesn't inject the same shared memory region to each thread?</p>
</blockquote>



<a name="566375996"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312219%20WASM%20threads%20don%27t%20seem%20to%20share%20.../near/566375996" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312219.20WASM.20threads.20don.27t.20seem.20to.20share.20.2E.2E.2E.html#566375996">(Jan 05 2026 at 15:11)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/12219#issuecomment-3710833914">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12219">issue #12219</a>:</p>
<blockquote>
<p>Thanks for the report, and I agree with @bjorn3 that the main issue here would be compiling the module to import memory. I agree that the error message could in theory be better, but Wasmtime isn't exactly positioned to have such an error message at this time. For example that would mean that <code>-Sthreads</code> <em>requires</em> you to import a memory which means we couldn't ever turn <code>-Sthreads</code> on-by-default.</p>
<p>Given that I think that this is otherwise solved, so I'm going to close this.</p>
</blockquote>



<hr><p>Last updated: Feb 22 2026 at 11:05 UTC</p>
</html>
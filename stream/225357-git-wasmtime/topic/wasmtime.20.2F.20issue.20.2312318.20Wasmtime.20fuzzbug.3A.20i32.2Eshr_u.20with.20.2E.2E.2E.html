<html>
<head><meta charset="utf-8"><title>wasmtime / issue #12318 Wasmtime fuzzbug: i32.shr_u with ... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312318.20Wasmtime.20fuzzbug.3A.20i32.2Eshr_u.20with.20.2E.2E.2E.html">wasmtime / issue #12318 Wasmtime fuzzbug: i32.shr_u with ...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="567559141"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312318%20Wasmtime%20fuzzbug%3A%20i32.shr_u%20with%20.../near/567559141" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312318.20Wasmtime.20fuzzbug.3A.20i32.2Eshr_u.20with.20.2E.2E.2E.html#567559141">(Jan 12 2026 at 15:03)</a>:</h4>
<p>louismerlin opened <a href="https://github.com/bytecodealliance/wasmtime/issues/12318">issue #12318</a>:</p>
<blockquote>
<h2>Description</h2>
<p>When running with <code>cranelift_opt_level(OptLevel::None)</code>, Wasmtime returns a different value than the WebAssembly spec and other engines for <code>i32.shr_u</code> where the shift amount is 32. In this mode, Wasmtime yields the same result as if the shift amount were taken verbatim, rather than masked to 5 bits.</p>
<p>This bug was found during differential fuzzing of wasmi <code>1.0.7</code> against wasmtime <code>40.0.1</code> using <a href="https://github.com/srlabs/ziggy">ziggy</a> (which uses AFL++ and honggfuzz under the hood) instead of libfuzzer.</p>
<h2>Expected behavior</h2>
<p>The provided example should execute in the same way with wasmi and wasmtime.</p>
<p>Instead we get:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">wasmi</span><span class="w"> </span><span class="n">says</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="mi">25</span><span class="p">),</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"> </span><span class="n">says</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>
<p><code>Cargo.toml</code></p>
<div class="codehilite" data-code-language="TOML"><pre><span></span><code><span class="k">[package]</span>
<span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"reproducing_the_bug"</span>
<span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"0.1.0"</span>
<span class="n">edition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"2024"</span>

<span class="k">[dependencies]</span>
<span class="n">wasmi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"1.0.7"</span>
<span class="n">wasmtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"40.0.1"</span>
<span class="n">wat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"1.228.0"</span>
</code></pre></div>
<p><code>src/main.rs</code></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">error</span><span class="p">::</span><span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">wat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">r#"</span>
<span class="s">(module</span>
<span class="s">  (func (export "") (result i32)</span>
<span class="s">    i32.const 24</span>
<span class="s">    i32.const 32</span>
<span class="s">    i32.shr_u</span>
<span class="s">    i32.const 1</span>
<span class="s">    i32.const 0</span>
<span class="s">    i32.shl</span>
<span class="s">    i32.or)</span>
<span class="s">)</span>
<span class="s">    "#</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">wasm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wat</span><span class="p">::</span><span class="n">parse_str</span><span class="p">(</span><span class="n">wat</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">wasmi_config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmi</span><span class="p">::</span><span class="n">Config</span><span class="p">::</span><span class="n">default</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">wasmi_engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmi</span><span class="p">::</span><span class="n">Engine</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wasmi_config</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">wasmi_module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmi</span><span class="p">::</span><span class="n">Module</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wasmi_engine</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">wasm</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">wasmtime_config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">Config</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>

<span class="w">    </span><span class="n">wasmtime_config</span><span class="p">.</span><span class="n">cranelift_opt_level</span><span class="p">(</span><span class="n">wasmtime</span><span class="p">::</span><span class="n">OptLevel</span><span class="p">::</span><span class="nb">None</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">wasmtime_engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">Engine</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wasmtime_config</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">wasmtime_module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">Module</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wasmtime_engine</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">wasm</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">wasmi_store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmi</span><span class="p">::</span><span class="n">Store</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wasmi_engine</span><span class="p">,</span><span class="w"> </span><span class="p">());</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">wasmi_instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmi</span><span class="p">::</span><span class="n">Instance</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">wasmi_store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">wasmi_module</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[])</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">wasmtime_store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">Store</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wasmtime_engine</span><span class="p">,</span><span class="w"> </span><span class="p">());</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">wasmtime_instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">Instance</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">wasmtime_store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">wasmtime_module</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[])</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">wasmi_func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmi_instance</span><span class="p">.</span><span class="n">get_typed_func</span><span class="p">::</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="kt">i32</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wasmi_store</span><span class="p">,</span><span class="w"> </span><span class="s">""</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">wasmtime_func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime_instance</span><span class="p">.</span><span class="n">get_typed_func</span><span class="p">::</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="kt">i32</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">wasmtime_store</span><span class="p">,</span><span class="w"> </span><span class="s">""</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">();</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span>
<span class="w">        </span><span class="s">"wasmi says {:?}, but wasmtime says {:?}"</span><span class="p">,</span>
<span class="w">        </span><span class="n">wasmi_func</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">wasmi_store</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">),</span>
<span class="w">        </span><span class="n">wasmtime_func</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">wasmtime_store</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">),</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>
<p>This example was also tested against wasmer, which agrees with wasmi (result is 25).</p>
</blockquote>



<a name="567559145"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312318%20Wasmtime%20fuzzbug%3A%20i32.shr_u%20with%20.../near/567559145" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312318.20Wasmtime.20fuzzbug.3A.20i32.2Eshr_u.20with.20.2E.2E.2E.html#567559145">(Jan 12 2026 at 15:03)</a>:</h4>
<p><a href="https://github.com/louismerlin">louismerlin</a> added the bug label to <a href="https://github.com/bytecodealliance/wasmtime/issues/12318">Issue #12318</a>.</p>



<a name="567559146"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312318%20Wasmtime%20fuzzbug%3A%20i32.shr_u%20with%20.../near/567559146" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312318.20Wasmtime.20fuzzbug.3A.20i32.2Eshr_u.20with.20.2E.2E.2E.html#567559146">(Jan 12 2026 at 15:03)</a>:</h4>
<p><a href="https://github.com/louismerlin">louismerlin</a> added the fuzz-bug label to <a href="https://github.com/bytecodealliance/wasmtime/issues/12318">Issue #12318</a>.</p>



<a name="567581571"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312318%20Wasmtime%20fuzzbug%3A%20i32.shr_u%20with%20.../near/567581571" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312318.20Wasmtime.20fuzzbug.3A.20i32.2Eshr_u.20with.20.2E.2E.2E.html#567581571">(Jan 12 2026 at 16:21)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/12318#issuecomment-3739391093">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12318">issue #12318</a>:</p>
<blockquote>
<p>Thanks for the report! Should be fixed in <a href="https://github.com/bytecodealliance/wasmtime/pull/12321">https://github.com/bytecodealliance/wasmtime/pull/12321</a></p>
</blockquote>



<a name="567591586"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312318%20Wasmtime%20fuzzbug%3A%20i32.shr_u%20with%20.../near/567591586" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312318.20Wasmtime.20fuzzbug.3A.20i32.2Eshr_u.20with.20.2E.2E.2E.html#567591586">(Jan 12 2026 at 16:58)</a>:</h4>
<p>louismerlin <a href="https://github.com/bytecodealliance/wasmtime/issues/12318#issuecomment-3739547121">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12318">issue #12318</a>:</p>
<blockquote>
<p>Awesome thank you for the fast response! A colleague just mentioned to me that the issue was also present for i64x2.shr_s fyi.</p>
</blockquote>



<a name="567593271"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312318%20Wasmtime%20fuzzbug%3A%20i32.shr_u%20with%20.../near/567593271" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312318.20Wasmtime.20fuzzbug.3A.20i32.2Eshr_u.20with.20.2E.2E.2E.html#567593271">(Jan 12 2026 at 17:04)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/12318#issuecomment-3739570596">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12318">issue #12318</a>:</p>
<blockquote>
<p>Would you be able to share a test case for i64x2.shr_s too?</p>
</blockquote>



<a name="567598834"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312318%20Wasmtime%20fuzzbug%3A%20i32.shr_u%20with%20.../near/567598834" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312318.20Wasmtime.20fuzzbug.3A.20i32.2Eshr_u.20with.20.2E.2E.2E.html#567598834">(Jan 12 2026 at 17:27)</a>:</h4>
<p>louismerlin <a href="https://github.com/bytecodealliance/wasmtime/issues/12318#issuecomment-3739669199">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/12318">issue #12318</a>:</p>
<blockquote>
<p>I wasn't able to reproduce on my machine, I've asked him to share a test case (he only gave me the wasm). He or I will get back to you here.</p>
</blockquote>



<a name="567620724"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2312318%20Wasmtime%20fuzzbug%3A%20i32.shr_u%20with%20.../near/567620724" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2312318.20Wasmtime.20fuzzbug.3A.20i32.2Eshr_u.20with.20.2E.2E.2E.html#567620724">(Jan 12 2026 at 19:01)</a>:</h4>
<p>alexcrichton closed <a href="https://github.com/bytecodealliance/wasmtime/issues/12318">issue #12318</a>:</p>
<blockquote>
<h2>Description</h2>
<p>When running with <code>cranelift_opt_level(OptLevel::None)</code>, Wasmtime returns a different value than the WebAssembly spec and other engines for <code>i32.shr_u</code> where the shift amount is 32. In this mode, Wasmtime yields the same result as if the shift amount were taken verbatim, rather than masked to 5 bits.</p>
<p>This bug was found during differential fuzzing of wasmi <code>1.0.7</code> against wasmtime <code>40.0.1</code> using <a href="https://github.com/srlabs/ziggy">ziggy</a> (which uses AFL++ and honggfuzz under the hood) instead of libfuzzer.</p>
<h2>Expected behavior</h2>
<p>The provided example should execute in the same way with wasmi and wasmtime.</p>
<p>Instead we get:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">wasmi</span><span class="w"> </span><span class="n">says</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="mi">25</span><span class="p">),</span><span class="w"> </span><span class="n">but</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"> </span><span class="n">says</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>
<p><code>Cargo.toml</code></p>
<div class="codehilite" data-code-language="TOML"><pre><span></span><code><span class="k">[package]</span>
<span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"reproducing_the_bug"</span>
<span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"0.1.0"</span>
<span class="n">edition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"2024"</span>

<span class="k">[dependencies]</span>
<span class="n">wasmi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"1.0.7"</span>
<span class="n">wasmtime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"40.0.1"</span>
<span class="n">wat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"1.228.0"</span>
</code></pre></div>
<p><code>src/main.rs</code></p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span><span class="p">::</span><span class="n">error</span><span class="p">::</span><span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">wat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">r#"</span>
<span class="s">(module</span>
<span class="s">  (func (export "") (result i32)</span>
<span class="s">    i32.const 24</span>
<span class="s">    i32.const 32</span>
<span class="s">    i32.shr_u</span>
<span class="s">    i32.const 1</span>
<span class="s">    i32.const 0</span>
<span class="s">    i32.shl</span>
<span class="s">    i32.or)</span>
<span class="s">)</span>
<span class="s">    "#</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">wasm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wat</span><span class="p">::</span><span class="n">parse_str</span><span class="p">(</span><span class="n">wat</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">wasmi_config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmi</span><span class="p">::</span><span class="n">Config</span><span class="p">::</span><span class="n">default</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">wasmi_engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmi</span><span class="p">::</span><span class="n">Engine</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wasmi_config</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">wasmi_module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmi</span><span class="p">::</span><span class="n">Module</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wasmi_engine</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">wasm</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">wasmtime_config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">Config</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>

<span class="w">    </span><span class="n">wasmtime_config</span><span class="p">.</span><span class="n">cranelift_opt_level</span><span class="p">(</span><span class="n">wasmtime</span><span class="p">::</span><span class="n">OptLevel</span><span class="p">::</span><span class="nb">None</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">wasmtime_engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">Engine</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wasmtime_config</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">wasmtime_module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">Module</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wasmtime_engine</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">wasm</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">wasmi_store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmi</span><span class="p">::</span><span class="n">Store</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wasmi_engine</span><span class="p">,</span><span class="w"> </span><span class="p">());</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">wasmi_instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmi</span><span class="p">::</span><span class="n">Instance</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">wasmi_store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">wasmi_module</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[])</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">wasmtime_store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">Store</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wasmtime_engine</span><span class="p">,</span><span class="w"> </span><span class="p">());</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">wasmtime_instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime</span><span class="p">::</span><span class="n">Instance</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">wasmtime_store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">wasmtime_module</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[])</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">wasmi_func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmi_instance</span><span class="p">.</span><span class="n">get_typed_func</span><span class="p">::</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="kt">i32</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wasmi_store</span><span class="p">,</span><span class="w"> </span><span class="s">""</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">wasmtime_func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wasmtime_instance</span><span class="p">.</span><span class="n">get_typed_func</span><span class="p">::</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="kt">i32</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">wasmtime_store</span><span class="p">,</span><span class="w"> </span><span class="s">""</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">();</span>
<span class="w">    </span><span class="fm">println!</span><span class="p">(</span>
<span class="w">        </span><span class="s">"wasmi says {:?}, but wasmtime says {:?}"</span><span class="p">,</span>
<span class="w">        </span><span class="n">wasmi_func</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">wasmi_store</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">),</span>
<span class="w">        </span><span class="n">wasmtime_func</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">wasmtime_store</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">),</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div>
<p>This example was also tested against wasmer, which agrees with wasmi (result is 25).</p>
</blockquote>



<hr><p>Last updated: Feb 22 2026 at 11:05 UTC</p>
</html>
<html>
<head><meta charset="utf-8"><title>wasmtime / issue #11045 Cranelift: Unexpected negative op... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311045.20Cranelift.3A.20Unexpected.20negative.20op.2E.2E.2E.html">wasmtime / issue #11045 Cranelift: Unexpected negative op...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="524064292"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311045%20Cranelift%3A%20Unexpected%20negative%20op.../near/524064292" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311045.20Cranelift.3A.20Unexpected.20negative.20op.2E.2E.2E.html#524064292">(Jun 14 2025 at 13:10)</a>:</h4>
<p><a href="https://github.com/OwenWangbattle">OwenWangbattle</a> added the bug label to <a href="https://github.com/bytecodealliance/wasmtime/issues/11045">Issue #11045</a>.</p>



<a name="524064293"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311045%20Cranelift%3A%20Unexpected%20negative%20op.../near/524064293" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311045.20Cranelift.3A.20Unexpected.20negative.20op.2E.2E.2E.html#524064293">(Jun 14 2025 at 13:10)</a>:</h4>
<p>OwenWangbattle opened <a href="https://github.com/bytecodealliance/wasmtime/issues/11045">issue #11045</a>:</p>
<blockquote>
<h3>evalloop.c</h3>
<p>The full code is in <a href="http://url">https://github.com/llvm/llvm-test-suite/blob/main/SingleSource/Benchmarks/Misc/evalloop.c</a></p>
<h3>Compile Command</h3>
<p><code>emcc -O0/-O3 -s WASM=1 -s TOTAL_MEMORY=512MB evalloop.c -o evalloop.wasm
wasmtime compile -C compiler=cranelift -O opt-level=2 evalloop.wasm -o evalloop.cwasm</code></p>
<h3>Run Command</h3>
<p><code>wasmtime --wasm max-wasm-stack=8388608 --allow-precompiled evalloop.cwasm</code></p>
<h3>Results</h3>
<p>I ran the program 10 times and got the average execution time.<br>
Time for O3 optimization flag: 2.43s<br>
Time for O0 optimization flag: 0.81s<br>
Time for Wasmer LLVM Compiler AOT: 1.09s</p>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: wasmtime-cli 22.0.0 (761f044ef 2024-06-20)</p>
<p>Operating system: Ubuntu 22.04.5 LTS(Linux)</p>
<p>Architecture: x86_64</p>
<p>CPU: Intel(R) Xeon(R) Gold 5218R CPU @ 2.10GHz</p>
<h3>Extra Info</h3>
<p>I think there may be some negative optimization for the pattern that calling function in the switch structure.<br>
</p>
</blockquote>



<a name="524064294"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311045%20Cranelift%3A%20Unexpected%20negative%20op.../near/524064294" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311045.20Cranelift.3A.20Unexpected.20negative.20op.2E.2E.2E.html#524064294">(Jun 14 2025 at 13:10)</a>:</h4>
<p><a href="https://github.com/OwenWangbattle">OwenWangbattle</a> added the cranelift label to <a href="https://github.com/bytecodealliance/wasmtime/issues/11045">Issue #11045</a>.</p>



<a name="524064359"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311045%20Cranelift%3A%20Unexpected%20negative%20op.../near/524064359" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311045.20Cranelift.3A.20Unexpected.20negative.20op.2E.2E.2E.html#524064359">(Jun 14 2025 at 13:12)</a>:</h4>
<p>OwenWangbattle <a href="https://github.com/bytecodealliance/wasmtime/issues/11045#issuecomment-2972757453">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11045">issue #11045</a>:</p>
<blockquote>
<p>Sorry, the Compile Command is <br>
<code>emcc -O0/-O3 -s WASM=1 -s TOTAL_MEMORY=512MB evalloop.c -o evalloop.wasm</code><br>
<code>wasmtime compile -C compiler=cranelift -O opt-level=2 evalloop.wasm -o evalloop.cwasm</code></p>
</blockquote>



<a name="524143886"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311045%20Cranelift%3A%20Unexpected%20negative%20op.../near/524143886" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311045.20Cranelift.3A.20Unexpected.20negative.20op.2E.2E.2E.html#524143886">(Jun 15 2025 at 16:57)</a>:</h4>
<p>alexcrichton edited <a href="https://github.com/bytecodealliance/wasmtime/issues/11045">issue #11045</a>:</p>
<blockquote>
<h3>evalloop.c</h3>
<p>The full code is in <a href="https://github.com/llvm/llvm-test-suite/blob/main/SingleSource/Benchmarks/Misc/evalloop.c">https://github.com/llvm/llvm-test-suite/blob/main/SingleSource/Benchmarks/Misc/evalloop.c</a></p>
<h3>Compile Command</h3>
<p><code>emcc -O0/-O3 -s WASM=1 -s TOTAL_MEMORY=512MB evalloop.c -o evalloop.wasm
wasmtime compile -C compiler=cranelift -O opt-level=2 evalloop.wasm -o evalloop.cwasm</code></p>
<h3>Run Command</h3>
<p><code>wasmtime --wasm max-wasm-stack=8388608 --allow-precompiled evalloop.cwasm</code></p>
<h3>Results</h3>
<p>I ran the program 10 times and got the average execution time.<br>
Time for O3 optimization flag: 2.43s<br>
Time for O0 optimization flag: 0.81s<br>
Time for Wasmer LLVM Compiler AOT: 1.09s</p>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: wasmtime-cli 22.0.0 (761f044ef 2024-06-20)</p>
<p>Operating system: Ubuntu 22.04.5 LTS(Linux)</p>
<p>Architecture: x86_64</p>
<p>CPU: Intel(R) Xeon(R) Gold 5218R CPU @ 2.10GHz</p>
<h3>Extra Info</h3>
<p>I think there may be some negative optimization for the pattern that calling function in the switch structure.<br>
</p>
</blockquote>



<a name="524144311"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311045%20Cranelift%3A%20Unexpected%20negative%20op.../near/524144311" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311045.20Cranelift.3A.20Unexpected.20negative.20op.2E.2E.2E.html#524144311">(Jun 15 2025 at 17:03)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/11045#issuecomment-2974275667">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11045">issue #11045</a>:</p>
<blockquote>
<p>Originally the link in the issue pointed to <code>url</code> so I updated it to point to the file that the text of the link was showing, but just wanted to confirm -- if you follow that link is that the test you're interested in?</p>
<p>This may be a producer toolchain issue rather than a Wasmtime issue as well. The <code>emcc</code> compiler I believe by default runs <code>wasm-opt</code> which means that you're dealing with both the LLVM and <code>wasm-opt</code> optimization pipeline. I'd recommend narrowing this down further to figure out what optimization is causing the slowdown vs not as that will make this much easier to debug.</p>
<p>I used a small script:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"> </span><span class="kr">do</span>
<span class="w">  </span><span class="cp">$WASI_SDK_PATH</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">clang</span><span class="w"> </span><span class="n">foo</span><span class="p">.</span><span class="n">c</span><span class="w"> </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="n">o</span><span class="cp">$i</span><span class="p">.</span><span class="n">wasm</span><span class="w"> </span><span class="o">-</span><span class="n">O</span><span class="cp">$i</span>
<span class="w">  </span><span class="n">wasmtime</span><span class="w"> </span><span class="n">compile</span><span class="w"> </span><span class="n">o</span><span class="cp">$i</span><span class="p">.</span><span class="n">wasm</span>
<span class="w">  </span><span class="n">echo</span><span class="w"> </span><span class="s">"O$i"</span>
<span class="w">  </span><span class="n">time</span><span class="w"> </span><span class="n">wasmtime</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">allow</span><span class="o">-</span><span class="n">precompiled</span><span class="w"> </span><span class="n">o</span><span class="cp">$i</span><span class="p">.</span><span class="n">cwasm</span>
<span class="n">done</span>
</code></pre></div>
<p>which uses just wasi-sdk which is just LLVM, not <code>wasm-opt</code>, and I get:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="n">O0</span>
<span class="n">Sum</span><span class="p">:</span><span class="w"> </span><span class="mi">3273600000</span>

<span class="n">real</span><span class="w">    </span><span class="mi">0</span><span class="n">m0</span><span class="p">.</span><span class="mi">546</span><span class="n">s</span>
<span class="n">user</span><span class="w">    </span><span class="mi">0</span><span class="n">m0</span><span class="p">.</span><span class="mi">544</span><span class="n">s</span>
<span class="n">sys</span><span class="w">     </span><span class="mi">0</span><span class="n">m0</span><span class="p">.</span><span class="mi">006</span><span class="n">s</span>
<span class="n">O1</span>
<span class="n">Sum</span><span class="p">:</span><span class="w"> </span><span class="mi">3273600000</span>

<span class="n">real</span><span class="w">    </span><span class="mi">0</span><span class="n">m0</span><span class="p">.</span><span class="mi">306</span><span class="n">s</span>
<span class="n">user</span><span class="w">    </span><span class="mi">0</span><span class="n">m0</span><span class="p">.</span><span class="mi">301</span><span class="n">s</span>
<span class="n">sys</span><span class="w">     </span><span class="mi">0</span><span class="n">m0</span><span class="p">.</span><span class="mi">006</span><span class="n">s</span>
<span class="n">O2</span>
<span class="n">Sum</span><span class="p">:</span><span class="w"> </span><span class="mi">3273600000</span>

<span class="n">real</span><span class="w">    </span><span class="mi">0</span><span class="n">m0</span><span class="p">.</span><span class="mi">317</span><span class="n">s</span>
<span class="n">user</span><span class="w">    </span><span class="mi">0</span><span class="n">m0</span><span class="p">.</span><span class="mi">320</span><span class="n">s</span>
<span class="n">sys</span><span class="w">     </span><span class="mi">0</span><span class="n">m0</span><span class="p">.</span><span class="mi">003</span><span class="n">s</span>
<span class="n">O3</span>
<span class="n">Sum</span><span class="p">:</span><span class="w"> </span><span class="mi">3273600000</span>

<span class="n">real</span><span class="w">    </span><span class="mi">0</span><span class="n">m0</span><span class="p">.</span><span class="mi">308</span><span class="n">s</span>
<span class="n">user</span><span class="w">    </span><span class="mi">0</span><span class="n">m0</span><span class="p">.</span><span class="mi">305</span><span class="n">s</span>
<span class="n">sys</span><span class="w">     </span><span class="mi">0</span><span class="n">m0</span><span class="p">.</span><span class="mi">006</span><span class="n">s</span>
</code></pre></div>
<p>which looks like this doesn't show any slowdown with higher optimization levels, definitely nothing close to 2+ seconds as you're seeing.</p>
<p>For me though it's just a hunch that <code>wasm-opt</code> might be doing something here, I don't actually have either <code>emcc</code> or <code>wasm-opt</code> installed locally. Can you @OwenWangbattle work on debugging this more? Can you reproduce with just wasi-sdk? Can you disable <code>wasm-opt</code> (I'm not sure how to do this) with <code>emcc</code> and see if that's causing the issue? If so this might be an issue best for Binaryen rather than Wasmtime.</p>
</blockquote>



<a name="524378618"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311045%20Cranelift%3A%20Unexpected%20negative%20op.../near/524378618" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311045.20Cranelift.3A.20Unexpected.20negative.20op.2E.2E.2E.html#524378618">(Jun 17 2025 at 06:14)</a>:</h4>
<p>OwenWangbattle <a href="https://github.com/bytecodealliance/wasmtime/issues/11045#issuecomment-2979075993">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11045">issue #11045</a>:</p>
<blockquote>
<blockquote>
<p>Originally the link in the issue pointed to <code>url</code> so I updated it to point to the file that the text of the link was showing, but just wanted to confirm -- if you follow that link is that the test you're interested in?</p>
<p>This may be a producer toolchain issue rather than a Wasmtime issue as well. The <code>emcc</code> compiler I believe by default runs <code>wasm-opt</code> which means that you're dealing with both the LLVM and <code>wasm-opt</code> optimization pipeline. I'd recommend narrowing this down further to figure out what optimization is causing the slowdown vs not as that will make this much easier to debug.</p>
<p>I used a small script:</p>
<p><code>
for i in 0 1 2 3; do
  $WASI_SDK_PATH/bin/clang foo.c -o o$i.wasm -O$i
  wasmtime compile o$i.wasm
  echo "O$i"
  time wasmtime run --allow-precompiled o$i.cwasm
done
</code></p>
<p>which uses just wasi-sdk which is just LLVM, not <code>wasm-opt</code>, and I get:</p>
<p>```<br>
O0<br>
Sum: 3273600000</p>
<p>real    0m0.546s<br>
user    0m0.544s<br>
sys     0m0.006s<br>
O1<br>
Sum: 3273600000</p>
<p>real    0m0.306s<br>
user    0m0.301s<br>
sys     0m0.006s<br>
O2<br>
Sum: 3273600000</p>
<p>real    0m0.317s<br>
user    0m0.320s<br>
sys     0m0.003s<br>
O3<br>
Sum: 3273600000</p>
<p>real    0m0.308s<br>
user    0m0.305s<br>
sys     0m0.006s<br>
```</p>
<p>which looks like this doesn't show any slowdown with higher optimization levels, definitely nothing close to 2+ seconds as you're seeing.</p>
<p>For me though it's just a hunch that <code>wasm-opt</code> might be doing something here, I don't actually have either <code>emcc</code> or <code>wasm-opt</code> installed locally. Can you <a href="https://github.com/OwenWangbattle">@OwenWangbattle</a> work on debugging this more? Can you reproduce with just wasi-sdk? Can you disable <code>wasm-opt</code> (I'm not sure how to do this) with <code>emcc</code> and see if that's causing the issue? If so this might be an issue best for Binaryen rather than Wasmtime.</p>
</blockquote>
<p>I investigated this case further these days. I thought you might be right. <strong>It might be caused by Binaryen instead of wasmtime.</strong> <br>
<code>emcc -O3 -s WASM=1 -s TOTAL_MEMORY=512MB evalloop.c -o evalloop.wasm -v</code> to see how emscripten compiled this program to wasm module. I followed its process without the wasm-opt optimization. And I found that the execution time of the program reduced to 1.6s. If I only used wasi-sdk and clang to compile the program, the execution time for O3 optimization flag was 0.64s and for O0 was 0.86s. The result was the same as you mentioned. <br>
Thank you for your suggestion! </p>
</blockquote>



<a name="524467489"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311045%20Cranelift%3A%20Unexpected%20negative%20op.../near/524467489" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311045.20Cranelift.3A.20Unexpected.20negative.20op.2E.2E.2E.html#524467489">(Jun 17 2025 at 14:31)</a>:</h4>
<p>alexcrichton closed <a href="https://github.com/bytecodealliance/wasmtime/issues/11045">issue #11045</a>:</p>
<blockquote>
<h3>evalloop.c</h3>
<p>The full code is in <a href="https://github.com/llvm/llvm-test-suite/blob/main/SingleSource/Benchmarks/Misc/evalloop.c">https://github.com/llvm/llvm-test-suite/blob/main/SingleSource/Benchmarks/Misc/evalloop.c</a></p>
<h3>Compile Command</h3>
<p><code>emcc -O0/-O3 -s WASM=1 -s TOTAL_MEMORY=512MB evalloop.c -o evalloop.wasm
wasmtime compile -C compiler=cranelift -O opt-level=2 evalloop.wasm -o evalloop.cwasm</code></p>
<h3>Run Command</h3>
<p><code>wasmtime --wasm max-wasm-stack=8388608 --allow-precompiled evalloop.cwasm</code></p>
<h3>Results</h3>
<p>I ran the program 10 times and got the average execution time.<br>
Time for O3 optimization flag: 2.43s<br>
Time for O0 optimization flag: 0.81s<br>
Time for Wasmer LLVM Compiler AOT: 1.09s</p>
<h3>Versions and Environment</h3>
<p>Cranelift version or commit: wasmtime-cli 22.0.0 (761f044ef 2024-06-20)</p>
<p>Operating system: Ubuntu 22.04.5 LTS(Linux)</p>
<p>Architecture: x86_64</p>
<p>CPU: Intel(R) Xeon(R) Gold 5218R CPU @ 2.10GHz</p>
<h3>Extra Info</h3>
<p>I think there may be some negative optimization for the pattern that calling function in the switch structure.<br>
</p>
</blockquote>



<a name="524467502"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20issue%20%2311045%20Cranelift%3A%20Unexpected%20negative%20op.../near/524467502" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20issue.20.2311045.20Cranelift.3A.20Unexpected.20negative.20op.2E.2E.2E.html#524467502">(Jun 17 2025 at 14:31)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/issues/11045#issuecomment-2980619984">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/issues/11045">issue #11045</a>:</p>
<blockquote>
<p>Ok  sounds good! I'm going to close this then.</p>
</blockquote>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
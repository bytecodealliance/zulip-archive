<html>
<head><meta charset="utf-8"><title>wasmtime / PR #11353 ensure component value lowerings are... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311353.20ensure.20component.20value.20lowerings.20are.2E.2E.2E.html">wasmtime / PR #11353 ensure component value lowerings are...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="531918519"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311353%20ensure%20component%20value%20lowerings%20are.../near/531918519" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311353.20ensure.20component.20value.20lowerings.20are.2E.2E.2E.html#531918519">(Jul 30 2025 at 19:54)</a>:</h4>
<p><strong>dicej</strong> requested <a href="https://github.com/alexcrichton">alexcrichton</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/11353">PR #11353</a>.</p>



<a name="531918522"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311353%20ensure%20component%20value%20lowerings%20are.../near/531918522" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311353.20ensure.20component.20value.20lowerings.20are.2E.2E.2E.html#531918522">(Jul 30 2025 at 19:54)</a>:</h4>
<p><strong>dicej</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers">wasmtime-core-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/11353">PR #11353</a>.</p>



<a name="531918523"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311353%20ensure%20component%20value%20lowerings%20are.../near/531918523" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311353.20ensure.20component.20value.20lowerings.20are.2E.2E.2E.html#531918523">(Jul 30 2025 at 19:54)</a>:</h4>
<p>dicej opened <a href="https://github.com/bytecodealliance/wasmtime/pull/11353">PR #11353</a> from <code>dicej:lower-on-worker-fiber</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>This is necessary because lowering a component value may require calling realloc, which may involve epoch interruption, which may require suspending the current fiber.  Which obviously doesn't work if we're not running in a fiber. Also, we need to make sure there are no host frames on the stack.</p>
<p>Note the use of <code>Mutex</code> for <code>WorkItem::WorkerFunction</code> and <code>WorkerItem::Function</code>.  We never lock the mutex -- it's only used to plumb through the inner, non-<code>Sync</code> value while satisfying the compiler that <code>Store</code> is <code>Sync</code>.</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="531919216"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311353%20ensure%20component%20value%20lowerings%20are.../near/531919216" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311353.20ensure.20component.20value.20lowerings.20are.2E.2E.2E.html#531919216">(Jul 30 2025 at 19:58)</a>:</h4>
<p>dicej <a href="https://github.com/bytecodealliance/wasmtime/pull/11353#issuecomment-3137645041">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11353">PR #11353</a>:</p>
<blockquote>
<p>This should fix <a href="https://github.com/bytecodealliance/wasmtime/issues/11348">https://github.com/bytecodealliance/wasmtime/issues/11348</a></p>
</blockquote>



<a name="531919308"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311353%20ensure%20component%20value%20lowerings%20are.../near/531919308" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311353.20ensure.20component.20value.20lowerings.20are.2E.2E.2E.html#531919308">(Jul 30 2025 at 19:59)</a>:</h4>
<p>dicej edited a <a href="https://github.com/bytecodealliance/wasmtime/pull/11353#issuecomment-3137645041">comment</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11353">PR #11353</a>:</p>
<blockquote>
<p>This should fix <a href="https://github.com/bytecodealliance/wasmtime/issues/11348">https://github.com/bytecodealliance/wasmtime/issues/11348</a> (and I've verified tests pass with Alex's assertion).</p>
</blockquote>



<a name="531920358"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311353%20ensure%20component%20value%20lowerings%20are.../near/531920358" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311353.20ensure.20component.20value.20lowerings.20are.2E.2E.2E.html#531920358">(Jul 30 2025 at 20:04)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11353#pullrequestreview-3073143507">PR review</a>:</p>
<blockquote>
<p>Nice! That was easier to fix than expected. Happy to see this merged whenever, but a few thoughts too:</p>
<ul>
<li>For <code>Mutex</code> I've been wondering if we should have a wrapper of some kind that sort of looks like a <code>Mutex</code> but is just a newtype wrapper. Basically it would disallow access to the underlying data with <code>&amp;self</code> and would exclusively provide access via <code>&amp;mut self</code>. That would support <code>unsafe impl&lt;T: Send&gt; Sync for TheWrapper&lt;T&gt;</code>. There's another example of this in the codebase <a href="https://github.com/bytecodealliance/wasmtime/blob/69fecf4e7d914156ff2a2bf3e105fed5640c2a82/crates/wasmtime/src/runtime/store/func_refs.rs#L91-L94">here</a> too. The only benefit of this would be avoiding the cost of creating the mutex, which I don't think is too costly nowadays, so no need to get to this any time soon (but would be good to keep in our back pocket I think).</li>
<li>Could the assertion be added in this PR too? I'm imagining something like where do leave it in <code>LowerContext::new</code> and then for the "fast path" case we provide an alternate constructor which is something like <code>LowerContext::new_assert_no_realloc</code> which would panic if <code>realloc</code> is called (and avoid the debug assertion). Or something like that, basically still have the debug assertion as much as we can but provide a hatch for the fast-path we're thinking of adding.</li>
</ul>
</blockquote>



<a name="531922383"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311353%20ensure%20component%20value%20lowerings%20are.../near/531922383" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311353.20ensure.20component.20value.20lowerings.20are.2E.2E.2E.html#531922383">(Jul 30 2025 at 20:16)</a>:</h4>
<p>dicej updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11353">PR #11353</a>.</p>



<a name="531922608"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311353%20ensure%20component%20value%20lowerings%20are.../near/531922608" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311353.20ensure.20component.20value.20lowerings.20are.2E.2E.2E.html#531922608">(Jul 30 2025 at 20:17)</a>:</h4>
<p>dicej <a href="https://github.com/bytecodealliance/wasmtime/pull/11353#issuecomment-3137695699">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11353">PR #11353</a>:</p>
<blockquote>
<p>I just added the assertion.  I had to gate it on the <code>component-model-async</code> feature because <code>StoreOpaque::with_blocking</code> is gated on that.  Alternatively, we could ungate them both.</p>
</blockquote>



<a name="531922857"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311353%20ensure%20component%20value%20lowerings%20are.../near/531922857" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311353.20ensure.20component.20value.20lowerings.20are.2E.2E.2E.html#531922857">(Jul 30 2025 at 20:19)</a>:</h4>
<p>dicej <a href="https://github.com/bytecodealliance/wasmtime/pull/11353#issuecomment-3137702016">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11353">PR #11353</a>:</p>
<blockquote>
<p>Agreed about using something simpler than a <code>Mutex</code> to make stuff like this <code>Sync</code> -- performance aside, it's confusing to readers to have <code>Mutex</code>s all over the place that are never locked.</p>
</blockquote>



<a name="531923005"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311353%20ensure%20component%20value%20lowerings%20are.../near/531923005" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311353.20ensure.20component.20value.20lowerings.20are.2E.2E.2E.html#531923005">(Jul 30 2025 at 20:20)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/11353#issuecomment-3137705363">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11353">PR #11353</a>:</p>
<blockquote>
<p>It's ok to leave it gated for now, eventually I think we're going to want to lift more out of the feature gate but it's ok to defer that to later.</p>
</blockquote>



<a name="531932296"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311353%20ensure%20component%20value%20lowerings%20are.../near/531932296" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311353.20ensure.20component.20value.20lowerings.20are.2E.2E.2E.html#531932296">(Jul 30 2025 at 21:17)</a>:</h4>
<p>dicej merged <a href="https://github.com/bytecodealliance/wasmtime/pull/11353">PR #11353</a>.</p>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
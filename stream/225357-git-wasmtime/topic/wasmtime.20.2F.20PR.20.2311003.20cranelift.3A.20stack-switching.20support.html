<html>
<head><meta charset="utf-8"><title>wasmtime / PR #11003 cranelift: stack-switching support · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html">wasmtime / PR #11003 cranelift: stack-switching support</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="523342315"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/523342315" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#523342315">(Jun 10 2025 at 17:47)</a>:</h4>
<p>posborne opened <a href="https://github.com/bytecodealliance/wasmtime/pull/11003">PR #11003</a> from <code>posborne:stack-switching-cranelift</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>These changes pull in the cranelift changes from #10177 with some additional stacked changes to resolve conflicts, align with previous changes in the stack-switching series, and address feedback items which were raised on previous iterations of the PR (but mostly not changing anything of significant substance).  Tracking Issue: #10248.</p>
<p>The <code>stack-switching</code> feature flag is retained and used minimally in this changeset in order to avoid compilation problems, but not really used beyond that.  There is at least one item in the tracking issue already related to likely finding a way to drop these compilation flags in most places but I think it is worth deferring that here as it will required touching code more broadly.</p>
<p>CC @frank-emrich @dhil <br>
</p>
</blockquote>



<a name="523342320"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/523342320" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#523342320">(Jun 10 2025 at 17:47)</a>:</h4>
<p><strong>posborne</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/11003">PR #11003</a>.</p>



<a name="523342321"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/523342321" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#523342321">(Jun 10 2025 at 17:47)</a>:</h4>
<p><strong>posborne</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers">wasmtime-core-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/11003">PR #11003</a>.</p>



<a name="523342322"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/523342322" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#523342322">(Jun 10 2025 at 17:47)</a>:</h4>
<p><strong>posborne</strong> requested <a href="https://github.com/alexcrichton">alexcrichton</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/11003">PR #11003</a>.</p>



<a name="523342955"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/523342955" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#523342955">(Jun 10 2025 at 17:52)</a>:</h4>
<p>posborne submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#pullrequestreview-2914571577">PR review</a>.</p>



<a name="523342956"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/523342956" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#523342956">(Jun 10 2025 at 17:52)</a>:</h4>
<p>posborne created <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#discussion_r2138476543">PR review comment</a>:</p>
<blockquote>
<p>@frank-emrich @dhil I put this in here as passing as the only use of <code>allow_smaller</code> here is in the debug assertions which seemed like a potential defect, though I didn't do a deep dive into the full usage.</p>
</blockquote>



<a name="523346375"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/523346375" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#523346375">(Jun 10 2025 at 18:13)</a>:</h4>
<p><strong>fitzgen</strong> requested <a href="https://github.com/fitzgen">fitzgen</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/11003">PR #11003</a>.</p>



<a name="523389833"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/523389833" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#523389833">(Jun 11 2025 at 00:00)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#pullrequestreview-2914690454">PR review</a>:</p>
<blockquote>
<p>Thanks! Lots of comments below but for the most part these should be pretty straightforward to fix.</p>
</blockquote>



<a name="523389834"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/523389834" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#523389834">(Jun 11 2025 at 00:00)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#discussion_r2138547820">PR review comment</a>:</p>
<blockquote>
<p>This is fine to add, but fwiw the <code>sized_stack_slots</code> member is <code>pub</code> and implements <code>Index&lt;StackSlot&gt;</code> so you can always do</p>
<p><div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="o">&amp;</span><span class="n">func</span><span class="p">.</span><span class="n">sized_stack_slots</span><span class="p">[</span><span class="n">slot</span><span class="p">]</span>
</code></pre></div><br>
</p>
</blockquote>



<a name="523389835"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/523389835" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#523389835">(Jun 11 2025 at 00:00)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#discussion_r2138590700">PR review comment</a>:</p>
<blockquote>
<p>Can we fold the <code>is_vmgcref_type()</code> branch into the <code>match</code> here? Something like this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">match</span><span class="w"> </span><span class="n">ty</span><span class="p">.</span><span class="n">top</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">WasmHeapTopType</span><span class="p">::</span><span class="n">Any</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">WasmHeapTopType</span><span class="p">::</span><span class="n">Extern</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">..</span><span class="p">.,</span>
<span class="w">    </span><span class="n">WasmHeapTopType</span><span class="p">::</span><span class="n">Func</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">..</span><span class="p">.,</span>
<span class="w">    </span><span class="o">..</span><span class="p">.</span>
<span class="p">}</span>
</code></pre></div>
<p>This should allow us to exhaustively match and remove the <code>_ =&gt; panic!(...)</code> arm.</p>
</blockquote>



<a name="523389836"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/523389836" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#523389836">(Jun 11 2025 at 00:00)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#discussion_r2138579656">PR review comment</a>:</p>
<blockquote>
<p>If we move the <code>stack_switching</code> module from the top-level to being a submodule of <code>func_environ</code> (similar to the <code>func_environ::gc</code> module) then we don't need to make all those members of <code>FuncEnvironment</code> be <code>pub(crate)</code>, which is a little thing but a nice thing (especially if we consider all the future evolutions of this code and any changes to <code>FuncEnvironment</code> members that will also need or not need to become <code>pub(crate)</code>).</p>
</blockquote>



<a name="523389837"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/523389837" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#523389837">(Jun 11 2025 at 00:00)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#discussion_r2138872519">PR review comment</a>:</p>
<blockquote>
<p>And this could be a <code>smallvec</code> too.</p>
</blockquote>



<a name="523389839"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/523389839" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#523389839">(Jun 11 2025 at 00:00)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#discussion_r2138879190">PR review comment</a>:</p>
<blockquote>
<p>Instead of looking at the value's CLIF type, can you modify <code>translate_ref_is_null</code> to pass in the actual wasm type as an argument? We already map multiple Wasm types onto the same CLIF type, it just so happens that is not currently the case for the particular type used for pointers to stacks, but this code as-written is pretty fragile to rely on that incidental property.</p>
</blockquote>



<a name="523389840"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/523389840" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#523389840">(Jun 11 2025 at 00:00)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#discussion_r2138585321">PR review comment</a>:</p>
<blockquote>
<p>Nice to avoid the allocation when possible:</p>
<div class="codehilite" data-code-language="suggestion"><pre><span></span><code>        let mut args: SmallVec&lt;[_; 6]&gt; = smallvec![vmctx, table_index_arg, delta];
</code></pre></div>
<p>(I think I counted the max args correctly but feel free to fix the inline capacity if I messed up)</p>
</blockquote>



<a name="523389841"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/523389841" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#523389841">(Jun 11 2025 at 00:00)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#discussion_r2138897891">PR review comment</a>:</p>
<blockquote>
<p>I'd prefer defining a type containing the fat pointer's parts, something like</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">ContObj</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">revision</span><span class="p">:</span><span class="w"> </span><span class="nc">ir</span><span class="p">::</span><span class="n">Value</span><span class="p">,</span>
<span class="w">    </span><span class="n">contref</span><span class="p">:</span><span class="w"> </span><span class="nc">ir</span><span class="p">::</span><span class="n">Value</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">ContObj</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="sd">/// ...</span>
<span class="w">    </span><span class="k">pub</span><span class="p">(</span><span class="k">crate</span><span class="p">)</span><span class="w"> </span><span class="n">new</span><span class="p">(</span><span class="o">..</span><span class="p">.)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">Self</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* ... */</span><span class="w"> </span><span class="p">}</span>

<span class="w">    </span><span class="sd">/// getters for the parts...</span>
<span class="p">}</span>
</code></pre></div>
<p>rather than trying to use <code>ir::types::I128</code> here.</p>
<p>Then we could also add <code>ContObj::load</code> and <code>ContObj::store</code> helper methods as needed.</p>
<p>This lets us avoid the sketchy <code>transmute</code> alluded to above (which I don't believe actually exists anyways, because we pass <code>VMContObj</code>s by parts to libcalls already) and we also don't need to do all the packing and unpacking and extending/reducing that packing into and unpacing from <code>ir::types::I128</code> requires either.</p>
<p>The only reason <code>ir::types::I128</code> exists is for ABI compatibility with LLVM code, which isn't a concern we have here.</p>
</blockquote>



<a name="523389842"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/523389842" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#523389842">(Jun 11 2025 at 00:00)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#discussion_r2138907457">PR review comment</a>:</p>
<blockquote>
<p>My suggestion for a <code>ContObj</code> type instead of <code>ir::types::I128</code> is basically to do the same as what is happening here.</p>
</blockquote>



<a name="523389843"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/523389843" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#523389843">(Jun 11 2025 at 00:00)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#discussion_r2138882385">PR review comment</a>:</p>
<blockquote>
<p>TODO</p>
</blockquote>



<a name="523389844"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/523389844" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#523389844">(Jun 11 2025 at 00:00)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#discussion_r2138871893">PR review comment</a>:</p>
<blockquote>
<p>Similar here regarding exhaustively matching on the top type.</p>
</blockquote>



<a name="523389845"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/523389845" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#523389845">(Jun 11 2025 at 00:00)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#discussion_r2138937180">PR review comment</a>:</p>
<blockquote>
<p>Can we leave this as an error instead of a panic?</p>
</blockquote>



<a name="523389846"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/523389846" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#523389846">(Jun 11 2025 at 00:00)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#discussion_r2138905515">PR review comment</a>:</p>
<blockquote>
<p>Can we put this into a helper function something like this:</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">fn</span><span class="w"> </span><span class="nf">control_context_size</span><span class="p">(</span><span class="n">triple</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">target_lexicon</span><span class="p">::</span><span class="n">Triple</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">WasmResult</span><span class="o">&lt;</span><span class="kt">usize</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="p">(</span><span class="n">triple</span><span class="p">.</span><span class="n">architecture</span><span class="p">,</span><span class="w"> </span><span class="n">triple</span><span class="p">.</span><span class="n">operating_system</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">(</span><span class="n">target_lexicon</span><span class="p">::</span><span class="n">Architecture</span><span class="p">::</span><span class="n">X86_64</span><span class="p">,</span><span class="w"> </span><span class="n">target_lexicon</span><span class="p">::</span><span class="n">OperatingSystem</span><span class="p">::</span><span class="n">Linux</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="mi">24</span><span class="p">),</span>
<span class="w">        </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">wasm_unsupported</span><span class="o">!</span><span class="p">(</span><span class="s">"stack switching is not supported on {triple}"</span><span class="p">)),</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>This will future proof the code and give us a nice place to slot in updates when we expand platform support.</p>
</blockquote>



<a name="523389847"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/523389847" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#523389847">(Jun 11 2025 at 00:00)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#discussion_r2138912432">PR review comment</a>:</p>
<blockquote>
<p>This is not a <code>VMHostArray</code>, it is a pointer to a <code>VMHostArray</code>, right? Can we update the name to reflect that? <code>VMHostArrayPtr</code> or <code>VMHostArrayRef</code> perhaps?</p>
<p>Also, I don't think we need to separate the static offset and dynamic base address because nothing is (for example) determining whether we need to emit explicit bounds checks or can rely on guard pages for these accesses, so we can just have a single <code>address: ir::Value</code> field and trust Cranelift's instruction selection choose the best addressing mode it can given the input IR.</p>
</blockquote>



<a name="523389849"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/523389849" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#523389849">(Jun 11 2025 at 00:00)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#discussion_r2138933506">PR review comment</a>:</p>
<blockquote>
<p>These should be able to be <code>SmallVec</code>s too.</p>
</blockquote>



<a name="523389850"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/523389850" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#523389850">(Jun 11 2025 at 00:00)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#discussion_r2138937963">PR review comment</a>:</p>
<blockquote>
<p><code>SmallVec</code></p>
</blockquote>



<a name="523389851"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/523389851" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#523389851">(Jun 11 2025 at 00:00)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#discussion_r2138934542">PR review comment</a>:</p>
<blockquote>
<p>Can you make sure there is an item for this in the tracking issue?</p>
</blockquote>



<a name="523389852"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/523389852" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#523389852">(Jun 11 2025 at 00:00)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#discussion_r2138936450">PR review comment</a>:</p>
<blockquote>
<p>Can we name the local something else? Having both a <code>resume_table</code> and <code>resumetable</code> variable in scope at the same time is pretty confusing. Maybe we can have <code>wasm_resume_table</code> and <code>clif_resume_table</code>?</p>
</blockquote>



<a name="523389853"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/523389853" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#523389853">(Jun 11 2025 at 00:00)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#discussion_r2138934897">PR review comment</a>:</p>
<blockquote>
<p><code>SmallVec</code> here too.</p>
</blockquote>



<a name="523389854"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/523389854" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#523389854">(Jun 11 2025 at 00:00)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#discussion_r2138937445">PR review comment</a>:</p>
<blockquote>
<p><code>SmallVec</code></p>
</blockquote>



<a name="523530455"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/523530455" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#523530455">(Jun 11 2025 at 10:38)</a>:</h4>
<p>dhil submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#pullrequestreview-2916488494">PR review</a>.</p>



<a name="523530456"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/523530456" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#523530456">(Jun 11 2025 at 10:38)</a>:</h4>
<p>dhil created <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#discussion_r2139768791">PR review comment</a>:</p>
<blockquote>
<p>I think this code is harmless. It seems to be doing some confidence testing that the byte-encoding of the values will fit into the allocated space. If I read the above comment correctly (and the code below) then each encoded element is stored as if it had type <code>T</code>, so for elements of type <code>S</code> such that <code>|S| &lt; |T|</code>, then there will be some padding between each element. </p>
<p>I am not sure <code>allow_smaller</code> is useful, perhaps we can just have <code>debug_assert!(size &lt;= std::mem::size_of::&lt;T&gt;());</code>, or perhaps we can dispense with this particular confidence checking altogether.</p>
</blockquote>



<a name="523530457"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/523530457" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#523530457">(Jun 11 2025 at 10:38)</a>:</h4>
<p>dhil created <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#discussion_r2139740860">PR review comment</a>:</p>
<blockquote>
<p><div class="codehilite" data-code-language="suggestion"><pre><span></span><code>/// The Cranelift type used to represent all of the following:
</code></pre></div><br>
</p>
</blockquote>



<a name="523530458"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/523530458" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#523530458">(Jun 11 2025 at 10:38)</a>:</h4>
<p>dhil created <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#discussion_r2139780378">PR review comment</a>:</p>
<blockquote>
<p>Yes, good shout! I think I am to blame for the current state of affairs.</p>
</blockquote>



<a name="523616800"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/523616800" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#523616800">(Jun 11 2025 at 18:27)</a>:</h4>
<p>posborne updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11003">PR #11003</a>.</p>



<a name="523618118"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/523618118" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#523618118">(Jun 11 2025 at 18:36)</a>:</h4>
<p>posborne submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#pullrequestreview-2918308049">PR review</a>.</p>



<a name="523618119"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/523618119" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#523618119">(Jun 11 2025 at 18:36)</a>:</h4>
<p>posborne created <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#discussion_r2140836164">PR review comment</a>:</p>
<blockquote>
<p>I think 7 here, will do a commit with the smallvec changes.</p>
</blockquote>



<a name="523618529"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/523618529" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#523618529">(Jun 11 2025 at 18:39)</a>:</h4>
<p>posborne edited <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#discussion_r2140836164">PR review comment</a>.</p>



<a name="523623783"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/523623783" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#523623783">(Jun 11 2025 at 19:17)</a>:</h4>
<p>posborne created <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#discussion_r2140900521">PR review comment</a>:</p>
<blockquote>
<p>For args and returns, I guessed at a smallvec max of 8; I didn't see anywhere where we are bound to this, but smallvec will still fall back on heap allocations if we go beyond this.</p>
</blockquote>



<a name="523623784"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/523623784" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#523623784">(Jun 11 2025 at 19:17)</a>:</h4>
<p>posborne submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#pullrequestreview-2918413223">PR review</a>.</p>



<a name="523624456"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/523624456" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#523624456">(Jun 11 2025 at 19:23)</a>:</h4>
<p>posborne created <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#discussion_r2140909305">PR review comment</a>:</p>
<blockquote>
<p>Added to tracking.</p>
</blockquote>



<a name="523624459"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/523624459" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#523624459">(Jun 11 2025 at 19:23)</a>:</h4>
<p>posborne submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#pullrequestreview-2918426637">PR review</a>.</p>



<a name="523626674"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/523626674" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#523626674">(Jun 11 2025 at 19:39)</a>:</h4>
<p>posborne submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#pullrequestreview-2918460662">PR review</a>.</p>



<a name="523626675"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/523626675" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#523626675">(Jun 11 2025 at 19:39)</a>:</h4>
<p>posborne created <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#discussion_r2140931444">PR review comment</a>:</p>
<blockquote>
<p>For now, I'll keep a debug_assert! in place to check <code>size &lt;= std::mem::size_of::&lt;T&gt;()</code>.</p>
</blockquote>



<a name="523639329"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/523639329" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#523639329">(Jun 11 2025 at 21:11)</a>:</h4>
<p>posborne submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#pullrequestreview-2918764372">PR review</a>.</p>



<a name="523639331"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/523639331" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#523639331">(Jun 11 2025 at 21:11)</a>:</h4>
<p>posborne created <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#discussion_r2141127507">PR review comment</a>:</p>
<blockquote>
<p>Tracing through this, just wanted to confirm that in order to do this we'll need to update wasm-tools/wasmparser to pass through the heap type information (similar to RefNull)?  Or am I off in the weeds in tracking through the changes required?</p>
</blockquote>



<a name="523785979"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/523785979" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#523785979">(Jun 12 2025 at 15:46)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#pullrequestreview-2921757670">PR review</a>.</p>



<a name="523785980"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/523785980" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#523785980">(Jun 12 2025 at 15:46)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#discussion_r2143105262">PR review comment</a>:</p>
<blockquote>
<p>Argh. I forgot that <code>ref.is_null</code> doesn't have a type parameter. I'll see how hard it would be to add type information that can be used here (and elsewhere).</p>
</blockquote>



<a name="523816984"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/523816984" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#523816984">(Jun 12 2025 at 19:07)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#pullrequestreview-2922307626">PR review</a>.</p>



<a name="523816986"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/523816986" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#523816986">(Jun 12 2025 at 19:07)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#discussion_r2143434918">PR review comment</a>:</p>
<blockquote>
<p><a href="https://github.com/bytecodealliance/wasmtime/pull/11030">https://github.com/bytecodealliance/wasmtime/pull/11030</a> passes the wasm ref type through to <code>translate_ref_is_null</code>. A couple things need to happen before that can land tho, see the PR description.</p>
</blockquote>



<a name="524290722"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/524290722" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#524290722">(Jun 16 2025 at 16:19)</a>:</h4>
<p>posborne updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11003">PR #11003</a>.</p>



<a name="524291684"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/524291684" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#524291684">(Jun 16 2025 at 16:25)</a>:</h4>
<p>posborne submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#pullrequestreview-2932775091">PR review</a>.</p>



<a name="524291686"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/524291686" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#524291686">(Jun 16 2025 at 16:25)</a>:</h4>
<p>posborne created <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#discussion_r2150405090">PR review comment</a>:</p>
<blockquote>
<p>Just removed this for now as there's already an error at where this callsite will eventually be and its addition should be obvious.  Probably to follow the work that @cfallin does to land other exception bits.</p>
<p>I confirmed the tracking issues already has an item to track <code>resume.throw</code> addition (outside of the initial impl).</p>
</blockquote>



<a name="524292392"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/524292392" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#524292392">(Jun 16 2025 at 16:29)</a>:</h4>
<p>posborne <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#issuecomment-2977288151">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11003">PR #11003</a>:</p>
<blockquote>
<p>Pushed most of the updates but still need to make the suggested updates around the fat pointer stuff and resolve conflicts with upstream.</p>
</blockquote>



<a name="524769890"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/524769890" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#524769890">(Jun 18 2025 at 19:22)</a>:</h4>
<p>posborne updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11003">PR #11003</a>.</p>



<a name="524772558"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/524772558" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#524772558">(Jun 18 2025 at 19:42)</a>:</h4>
<p>posborne updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11003">PR #11003</a>.</p>



<a name="524772678"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/524772678" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#524772678">(Jun 18 2025 at 19:43)</a>:</h4>
<p>posborne submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#pullrequestreview-2940468002">PR review</a>.</p>



<a name="524772680"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/524772680" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#524772680">(Jun 18 2025 at 19:43)</a>:</h4>
<p>posborne created <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#discussion_r2155371631">PR review comment</a>:</p>
<blockquote>
<p>Updated to use the wasm type as part of merging upstream back into the branch.</p>
</blockquote>



<a name="524772854"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/524772854" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#524772854">(Jun 18 2025 at 19:44)</a>:</h4>
<p>posborne submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#pullrequestreview-2940470759">PR review</a>.</p>



<a name="524772857"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/524772857" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#524772857">(Jun 18 2025 at 19:44)</a>:</h4>
<p>posborne created <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#discussion_r2155373368">PR review comment</a>:</p>
<blockquote>
<p>Implemented this now.</p>
</blockquote>



<a name="524777253"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/524777253" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#524777253">(Jun 18 2025 at 20:16)</a>:</h4>
<p>posborne created <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#discussion_r2155422297">PR review comment</a>:</p>
<blockquote>
<p>Discussed this change a bit more with @fitzgen and played around with an impl.  Currently, we are thinking that to facilitate having a single wasm value be modeled by multiple ir values (as we want here), we'll need to do some updates to the code translator to support having a single translated wasm value map to multiple ir values.</p>
<p>This will be a larger change, so I am proposing that we move forward with changing the stack-switching code to be updated to use that mechanism when introduced in a later change.</p>
</blockquote>



<a name="524777254"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/524777254" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#524777254">(Jun 18 2025 at 20:16)</a>:</h4>
<p>posborne submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#pullrequestreview-2940546130">PR review</a>.</p>



<a name="524777397"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/524777397" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#524777397">(Jun 18 2025 at 20:18)</a>:</h4>
<p>posborne updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11003">PR #11003</a>.</p>



<a name="525366899"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/525366899" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#525366899">(Jun 23 2025 at 16:15)</a>:</h4>
<p>posborne <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#issuecomment-2997092761">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11003">PR #11003</a>:</p>
<blockquote>
<p>@fitzgen I believe this is ready for review again, let me know if there's pieces I missed in my previous updates.  As noted, I chose to defer fatpointer changes for now to be potentially addressed as part of (or following) changes to the translation stack.</p>
</blockquote>



<a name="525557954"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/525557954" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#525557954">(Jun 24 2025 at 16:44)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#pullrequestreview-2954464208">PR review</a>:</p>
<blockquote>
<p>LGTM modulo a few final comments below, we should be able to merge this and move on to follow ups after they are addressed.</p>
<p>Thanks!</p>
</blockquote>



<a name="525557955"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/525557955" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#525557955">(Jun 24 2025 at 16:44)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#discussion_r2164387365">PR review comment</a>:</p>
<blockquote>
<p>Ditto</p>
</blockquote>



<a name="525557956"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/525557956" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#525557956">(Jun 24 2025 at 16:44)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#discussion_r2164461278">PR review comment</a>:</p>
<blockquote>
<p>And then construction would become something like this:</p>
<div class="codehilite" data-code-language="suggestion"><pre><span></span><code>    assert!(env.pointer_type().bits() &lt;= 64);
    let contref_addr = pos.ins().uextend(ir::types::I28, contref_addr);

    let revision_counter = pos.ins().uextend(ir::types::I128, revision_counter);
    let shifted_counter = pos.ins().ishl_imm(revision_counter, 64);

    pos.ins().bor(shifted_counter, contref_addr)
</code></pre></div>
<p>Note: if you want to switch the order of the contref pointer and the counter in the fat pointer, that's fine (I think I unwittingly switched it from what is in the code now), but the important point is that we should be able do all of this fat pointer construction and destruction without branching on endianness and pointer width.</p>
</blockquote>



<a name="525557957"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/525557957" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#525557957">(Jun 24 2025 at 16:44)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#discussion_r2164428969">PR review comment</a>:</p>
<blockquote>
<p>I think it makes sense to <a href="https://github.com/bytecodealliance/wasmtime/tree/main/tests/disas">add <code>disas</code> tests</a> for these operations in <code>tests/disas/stack-switching/*</code>. Should be as easy as writing a couple <code>.wat</code> files and then running <code>WASMTIME_TEST_BLESS=1 cargo test --test disas</code> to initialize the golden output.</p>
<p>Doesn't need to be in this PR, but if not in this PR, then should be added to the tracking issue. </p>
</blockquote>



<a name="525557959"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/525557959" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#525557959">(Jun 24 2025 at 16:44)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#discussion_r2164445163">PR review comment</a>:</p>
<blockquote>
<p>Can this just be something like</p>
<div class="codehilite" data-code-language="suggestion"><pre><span></span><code>    let ptr_ty = env.pointer_type();
    assert!(ptr_ty.bits() &lt;= 64);

    let contref = pos.ins().ireduce(ptr_ty, contobj);

    let shifted = pos.ins().ushr_imm(contobj, 64);
    let revision_counter = pos.ins().ireduce(it::types::I64, shifted);

    (revision_counter, contref)
</code></pre></div>
<p>?</p>
<p>That is, we define the fat pointer as 128 bits where the upper 64 are the revision counter and the bottom <code>sizeof(pointer)</code> bits are the pointer to the continuation. This way I don't think we ever have to branch on endianness or pointer width.</p>
</blockquote>



<a name="525557960"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/525557960" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#525557960">(Jun 24 2025 at 16:44)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#discussion_r2164387084">PR review comment</a>:</p>
<blockquote>
<p>This shouldn't need to be <code>pub(crate)</code> after the <code>stack_switching</code> module moved to <code>func_environ::stack_switching</code>, right?</p>
</blockquote>



<a name="525804894"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/525804894" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#525804894">(Jun 25 2025 at 23:53)</a>:</h4>
<p>posborne submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#pullrequestreview-2959975446">PR review</a>.</p>



<a name="525804895"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/525804895" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#525804895">(Jun 25 2025 at 23:53)</a>:</h4>
<p>posborne created <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#discussion_r2167824936">PR review comment</a>:</p>
<blockquote>
<p>Yeah, this makes sense to me, will adopt this approach (with a quick round of testing) until we can split into individual ir values.</p>
</blockquote>



<a name="526449992"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/526449992" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#526449992">(Jun 30 2025 at 17:30)</a>:</h4>
<p>posborne updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11003">PR #11003</a>.</p>



<a name="526650861"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/526650861" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#526650861">(Jul 01 2025 at 17:03)</a>:</h4>
<p>posborne <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#issuecomment-3024857619">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11003">PR #11003</a>:</p>
<blockquote>
<p>@fitzgen I am hunting down one regression with the latest, probably around the changes to table ops based on wasm types (though I haven't found a smoking gun yet).  These tests passed prior to some of the latest changes on this branch and the test is doing a table.grow of continuations followed by a resume of the first added to the table which traps on a null reference.</p>
</blockquote>



<a name="526882800"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/526882800" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#526882800">(Jul 02 2025 at 21:33)</a>:</h4>
<p>posborne updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11003">PR #11003</a>.</p>



<a name="528712763"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/528712763" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#528712763">(Jul 14 2025 at 17:50)</a>:</h4>
<p>posborne updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11003">PR #11003</a>.</p>



<a name="528713211"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/528713211" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#528713211">(Jul 14 2025 at 17:53)</a>:</h4>
<p>posborne <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#issuecomment-3070453116">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11003">PR #11003</a>:</p>
<blockquote>
<p>Pulled in and resolved conflicts (some pretty mild ones from <a href="https://github.com/bytecodealliance/wasmtime/pull/11216">https://github.com/bytecodealliance/wasmtime/pull/11216</a>.  @fitzgen Review would be appreciated; I think in our last convos I had played around with a different fatpointer impl but I'm fine with this as-is (possibly to revisit later on).</p>
</blockquote>



<a name="528713378"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/528713378" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#528713378">(Jul 14 2025 at 17:54)</a>:</h4>
<p>posborne updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11003">PR #11003</a>.</p>



<a name="528715501"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/528715501" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#528715501">(Jul 14 2025 at 18:07)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#pullrequestreview-3017296649">PR review</a>.</p>



<a name="528715502"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/528715502" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#528715502">(Jul 14 2025 at 18:07)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#discussion_r2205517257">PR review comment</a>:</p>
<blockquote>
<p>This field is already public.</p>
</blockquote>



<a name="528715656"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/528715656" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#528715656">(Jul 14 2025 at 18:08)</a>:</h4>
<p>bjorn3 created <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#discussion_r2205519101">PR review comment</a>:</p>
<blockquote>
<p>Why is this necessary? Wasm doesn't have 128bit integers.</p>
</blockquote>



<a name="528715657"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/528715657" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#528715657">(Jul 14 2025 at 18:08)</a>:</h4>
<p>bjorn3 submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#pullrequestreview-3017300172">PR review</a>.</p>



<a name="528720911"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/528720911" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#528720911">(Jul 14 2025 at 18:48)</a>:</h4>
<p>posborne submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#pullrequestreview-3017417112">PR review</a>.</p>



<a name="528720912"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/528720912" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#528720912">(Jul 14 2025 at 18:48)</a>:</h4>
<p>posborne created <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#discussion_r2205589105">PR review comment</a>:</p>
<blockquote>
<p>At least in this iteration of the changes, the stack switching code is using an i128 for it's vmcontobj fat pointer (consisting of vmcontref pointer and revision).  @fitzgen and I have discussed a bit about how we can get rid of this and just have two ir values through the transformation, but it will require some additional changes to how we model the relationship between wasm and clif values to support having one of the former map to two distinct ir values.</p>
</blockquote>



<a name="528722998"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/528722998" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#528722998">(Jul 14 2025 at 19:02)</a>:</h4>
<p>posborne submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#pullrequestreview-3017450869">PR review</a>.</p>



<a name="528722999"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/528722999" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#528722999">(Jul 14 2025 at 19:02)</a>:</h4>
<p>posborne created <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#discussion_r2205611230">PR review comment</a>:</p>
<blockquote>
<p>I'll remove this in favor of using the pub field directly; probably just a miss on the visibility when the wasmfx contributors originally authored these changes (looks like field has been pub for a long time).</p>
</blockquote>



<a name="528724271"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/528724271" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#528724271">(Jul 14 2025 at 19:10)</a>:</h4>
<p>posborne updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11003">PR #11003</a>.</p>



<a name="529950058"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/529950058" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#529950058">(Jul 21 2025 at 18:58)</a>:</h4>
<p>posborne updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11003">PR #11003</a>.</p>



<a name="530623586"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/530623586" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#530623586">(Jul 24 2025 at 18:32)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#pullrequestreview-3052723095">PR review</a>:</p>
<blockquote>
<p>LGTM! Couple final nitpicks before this lands, but once those are addressed, feel free to add it to the merge queue or ask me to do that (I forget if you have those permissions or not).</p>
<p>Thanks for sticking through with this one!</p>
</blockquote>



<a name="530623587"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/530623587" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#530623587">(Jul 24 2025 at 18:32)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#discussion_r2229226724">PR review comment</a>:</p>
<blockquote>
<p>This field is only accessed in a submodule, so it does not need to be <code>pub(crate)</code>.</p>
</blockquote>



<a name="530623588"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/530623588" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#530623588">(Jul 24 2025 at 18:32)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#discussion_r2229230264">PR review comment</a>:</p>
<blockquote>
<p>Similarly, this is only accessed in submodules as well, and not across crate boundaries at all, so it does not need to be <code>pub</code>.</p>
</blockquote>



<a name="530623589"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/530623589" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#530623589">(Jul 24 2025 at 18:32)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#discussion_r2229243182">PR review comment</a>:</p>
<blockquote>
<p>And then this should be something like</p>
<p><div class="codehilite" data-code-language="suggestion"><pre><span></span><code>        u8::try_from(align(
            u32::from(self.vmcontobj_revision())
                + u32::try_from(core::mem::size_of::&lt;u64&gt;()).unwrap(),
            u32::from(self.size()),
        ))
        .unwrap()
</code></pre></div><br>
</p>
</blockquote>



<a name="530623590"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/530623590" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#530623590">(Jul 24 2025 at 18:32)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#discussion_r2229237980">PR review comment</a>:</p>
<blockquote>
<p>To work across non-64-bit ISAs, which we support today via, for example, the 32-bit Pulley interpreter, this needs to be</p>
<p><div class="codehilite" data-code-language="suggestion"><pre><span></span><code>        self.size()
</code></pre></div><br>
</p>
</blockquote>



<a name="530623591"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/530623591" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#530623591">(Jul 24 2025 at 18:32)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#discussion_r2229248535">PR review comment</a>:</p>
<blockquote>
<p>I don't think this align(16) needs to be here anymore, as described in the deleted <code>FIXME</code> comment? But if we are leaving it, then we should have a follow up item to investigate in the meta issue and also should adjust the <code>size_of_vmcontobj</code> method above to align to 16 instead of the natural alignment that my suggestion comment sketched out.</p>
</blockquote>



<a name="530650335"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/530650335" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#530650335">(Jul 24 2025 at 21:31)</a>:</h4>
<p>posborne submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#pullrequestreview-3053411334">PR review</a>.</p>



<a name="530650338"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/530650338" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#530650338">(Jul 24 2025 at 21:31)</a>:</h4>
<p>posborne created <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#discussion_r2229622936">PR review comment</a>:</p>
<blockquote>
<p>I wasn't sure if we wanted to pad out this struct to always be packed as 128 bits or as two words.  I think two words makes more sense and aligns with what you are saying but means that the cranelift generated code will definitely need to be updated to be able to support 32-bit target architectures (probably along with changes discussed before to change how we do the fatpointer handling).</p>
<p>I'll land changes after thinking this a bit more and update the meta-issue with any notes on 32-bit targets.</p>
</blockquote>



<a name="536320341"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/536320341" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#536320341">(Aug 26 2025 at 22:24)</a>:</h4>
<p>posborne updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11003">PR #11003</a>.</p>



<a name="536445555"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/536445555" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#536445555">(Aug 27 2025 at 15:24)</a>:</h4>
<p>fitzgen <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#issuecomment-3228668740">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11003">PR #11003</a>:</p>
<blockquote>
<p>@posborne is this ready for review now?</p>
</blockquote>



<a name="536454407"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/536454407" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#536454407">(Aug 27 2025 at 16:09)</a>:</h4>
<p>posborne <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#issuecomment-3228847906">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11003">PR #11003</a>:</p>
<blockquote>
<p>@fitzgen Yes, should be ready for review -- I'll just push a fixup for the CI issues.  I sent a side note in zulip but I'll repost here:</p>
<blockquote>
<p>Ok, I got around to updating the branch with (hopefully) a final set of changes. Since we had been going back-and-forth on VMContObj alignment a bit I did end up changing this to natural alignment with revision now being defined as a usize.</p>
<p>Along with that I updated the cranelift fatpointer code and libcalls to work with the usize and to use an appropriate fat pointer container ir type for two words -- for this I had to plumb through a size type for that layer matching what exists for components (<a href="https://github.com/bytecodealliance/wasmtime/pull/11003/commits/078002aa024fe825f148f9dbcf864049bcf708ba">https://github.com/bytecodealliance/wasmtime/pull/11003/commits/078002aa024fe825f148f9dbcf864049bcf708ba</a>).</p>
<p>Since the changes were a bit more substantive I will wait for a fresh review of that -- there were some merge conflicts related to the other changes in func_environ but they were pretty straightforward to address.</p>
<p>In parallel, I'll work on a rebase of the test changes to get a bit of extra validation as there isn't a lot in tree to cover things end-to-end on its own.</p>
</blockquote>
</blockquote>



<a name="536456337"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/536456337" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#536456337">(Aug 27 2025 at 16:20)</a>:</h4>
<p>posborne updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11003">PR #11003</a>.</p>



<a name="536483924"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/536483924" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#536483924">(Aug 27 2025 at 19:19)</a>:</h4>
<p>posborne <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#issuecomment-3229467019">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11003">PR #11003</a>:</p>
<blockquote>
<p>@fitzgen I did run the test changes now -- a subset of those tests are now failing as it looks like there are some codepaths hit due to upstream changes where we end up calling <code>Val::null_top</code> which currently panics for continuation types.</p>
</blockquote>



<a name="536505359"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/536505359" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#536505359">(Aug 27 2025 at 22:49)</a>:</h4>
<p>posborne updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11003">PR #11003</a>.</p>



<a name="536505493"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/536505493" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#536505493">(Aug 27 2025 at 22:51)</a>:</h4>
<p>posborne updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11003">PR #11003</a>.</p>



<a name="536505764"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/536505764" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#536505764">(Aug 27 2025 at 22:54)</a>:</h4>
<p>posborne <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#issuecomment-3229994059">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11003">PR #11003</a>:</p>
<blockquote>
<blockquote>
<p>@fitzgen I did run the test changes now -- a subset of those tests are now failing as it looks like there are some codepaths hit due to upstream changes where we end up calling Val::null_top which currently panics for continuation types.</p>
</blockquote>
<p>To get tests going with the upstream stuff, I did end up adding a minimal <code>Val::ContRef</code> member which doesn't seem avoidable.  I tried to keep this as small and I could bundle it with the test changes, but it does appear to be required in order to have ref.null globals for continuations and some other cases.</p>
</blockquote>



<a name="536520375"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/536520375" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#536520375">(Aug 28 2025 at 02:14)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#issuecomment-3231268137">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11003">PR #11003</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @fitzgen</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "cranelift", "cranelift:area:x64", "wasmtime:api", "wasmtime:ref-types"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>fitzgen: wasmtime:ref-types</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="536643449"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/536643449" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#536643449">(Aug 28 2025 at 16:21)</a>:</h4>
<p><strong>posborne</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-fuzz-reviewers">wasmtime-fuzz-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/11003">PR #11003</a>.</p>



<a name="536643451"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/536643451" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#536643451">(Aug 28 2025 at 16:21)</a>:</h4>
<p><strong>posborne</strong> requested <a href="https://github.com/alexcrichton">alexcrichton</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/11003">PR #11003</a>.</p>



<a name="536643452"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/536643452" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#536643452">(Aug 28 2025 at 16:21)</a>:</h4>
<p>posborne updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11003">PR #11003</a>.</p>



<a name="536656646"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/536656646" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#536656646">(Aug 28 2025 at 17:44)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#issuecomment-3234399931">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11003">PR #11003</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @fitzgen</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "fuzzing", "wasmtime:c-api"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>fitzgen: fuzzing</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="536672460"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/536672460" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#536672460">(Aug 28 2025 at 19:35)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#pullrequestreview-3166231115">PR review</a>:</p>
<blockquote>
<p>LGTM with the below addressed, thanks!</p>
</blockquote>



<a name="536672461"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/536672461" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#536672461">(Aug 28 2025 at 19:35)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#discussion_r2308346750">PR review comment</a>:</p>
<blockquote>
<p>This should still zero the global's definition, no?</p>
</blockquote>



<a name="536672462"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/536672462" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#536672462">(Aug 28 2025 at 19:35)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#discussion_r2308349488">PR review comment</a>:</p>
<blockquote>
<p>And similar here</p>
</blockquote>



<a name="536675170"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/536675170" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#536675170">(Aug 28 2025 at 19:57)</a>:</h4>
<p>posborne submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#pullrequestreview-3166309175">PR review</a>.</p>



<a name="536675171"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/536675171" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#536675171">(Aug 28 2025 at 19:57)</a>:</h4>
<p>posborne created <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#discussion_r2308403125">PR review comment</a>:</p>
<blockquote>
<p>Yeah, definitely.</p>
</blockquote>



<a name="536676488"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/536676488" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#536676488">(Aug 28 2025 at 20:08)</a>:</h4>
<p>posborne updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11003">PR #11003</a>.</p>



<a name="536676671"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/536676671" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#536676671">(Aug 28 2025 at 20:09)</a>:</h4>
<p>posborne has enabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/11003">PR #11003</a>.</p>



<a name="536696957"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/536696957" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#536696957">(Aug 28 2025 at 23:39)</a>:</h4>
<p>posborne updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11003">PR #11003</a>.</p>



<a name="536836715"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/536836715" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#536836715">(Aug 29 2025 at 17:50)</a>:</h4>
<p>posborne updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11003">PR #11003</a>.</p>



<a name="536841302"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/536841302" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#536841302">(Aug 29 2025 at 18:22)</a>:</h4>
<p>posborne updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11003">PR #11003</a>.</p>



<a name="536841481"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/536841481" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#536841481">(Aug 29 2025 at 18:23)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#pullrequestreview-3169656717">PR review</a>.</p>



<a name="536841483"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/536841483" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#536841483">(Aug 29 2025 at 18:23)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#discussion_r2310810947">PR review comment</a>:</p>
<blockquote>
<p>This stuff should be a method on the <code>PtrSize</code> trait that we define in <code>vmoffsets.rs</code> (maybe <code>fn vm_host_array_layout(&amp;self) -&gt; (u8, u32)</code>) and ultimately we should have access to that method here via <code>env.offsets.ptr</code>.</p>
<p>We should definitely avoid any kind of <code>std::mem::{size,align}_of</code> calls, as that ends up being pretty fragile (doesn't work for <code>f64</code> across 32- and 64-bit architectures, for example, where the alignment is different despite size being the same).</p>
</blockquote>



<a name="536841938"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/536841938" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#536841938">(Aug 29 2025 at 18:27)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#pullrequestreview-3169672962">PR review</a>.</p>



<a name="536841940"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/536841940" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#536841940">(Aug 29 2025 at 18:27)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#discussion_r2310823200">PR review comment</a>:</p>
<blockquote>
<p>To clarify a little more:</p>
<p>To avoid the <code>std::mem::{size,align}_of</code> calls, you may have to have different <code>PtrSize</code> methods for each concrete <code>T</code> that is used, and then bound <code>T</code> by <code>T: HostArrayLayout</code> and define</p>
<div class="codehilite" data-code-language="Rust"><pre><span></span><code><span class="k">trait</span><span class="w"> </span><span class="n">HostArrayLayout</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">host_array_layout</span><span class="o">&lt;</span><span class="n">P</span><span class="p">:</span><span class="w"> </span><span class="nc">PtrSize</span><span class="o">&gt;</span><span class="p">(</span><span class="n">p</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">P</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="kt">u32</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<p>and implement that for each concreate <code>T</code> such that it calls the appropriate <code>PtrSize</code> method.</p>
</blockquote>



<a name="536842355"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/536842355" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#536842355">(Aug 29 2025 at 18:30)</a>:</h4>
<p>posborne submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#pullrequestreview-3169679543">PR review</a>.</p>



<a name="536842358"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/536842358" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#536842358">(Aug 29 2025 at 18:30)</a>:</h4>
<p>posborne created <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#discussion_r2310828306">PR review comment</a>:</p>
<blockquote>
<p>Makes sense, I'll take a look at making changes to revise VMHostArray and any other problematic parts I can find (or see if @dhil can help out).  I wanted to get a basic version of the commit up to get this kind of feedback as doing operations on the generic T here (from the original impl) seemed problematic for the reasons you describe.</p>
</blockquote>



<a name="537346600"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/537346600" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#537346600">(Sep 02 2025 at 18:51)</a>:</h4>
<p>posborne updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11003">PR #11003</a>.</p>



<a name="537741396"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/537741396" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#537741396">(Sep 04 2025 at 19:54)</a>:</h4>
<p><strong>posborne</strong> requested <a href="https://github.com/fitzgen">fitzgen</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/11003">PR #11003</a>.</p>



<a name="537741489"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/537741489" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#537741489">(Sep 04 2025 at 19:55)</a>:</h4>
<p>posborne submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#pullrequestreview-3186981110">PR review</a>.</p>



<a name="537741490"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/537741490" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#537741490">(Sep 04 2025 at 19:55)</a>:</h4>
<p>posborne created <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#discussion_r2323358549">PR review comment</a>:</p>
<blockquote>
<p>Addressed in 9343ab99f2c07fb3f2a4dd778142422da9202d3f if my interpretation was correct.</p>
</blockquote>



<a name="537760878"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/537760878" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#537760878">(Sep 04 2025 at 21:50)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#pullrequestreview-3187357718">PR review</a>.</p>



<a name="537760879"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/537760879" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#537760879">(Sep 04 2025 at 21:50)</a>:</h4>
<p>fitzgen created <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#discussion_r2323624201">PR review comment</a>:</p>
<blockquote>
<p>Looks good, thanks!</p>
</blockquote>



<a name="537760999"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/537760999" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#537760999">(Sep 04 2025 at 21:51)</a>:</h4>
<p>fitzgen submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11003#pullrequestreview-3187360262">PR review</a>.</p>



<a name="537764091"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311003%20cranelift%3A%20stack-switching%20support/near/537764091" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311003.20cranelift.3A.20stack-switching.20support.html#537764091">(Sep 04 2025 at 22:20)</a>:</h4>
<p>posborne merged <a href="https://github.com/bytecodealliance/wasmtime/pull/11003">PR #11003</a>.</p>



<hr><p>Last updated: Feb 22 2026 at 11:05 UTC</p>
</html>
<html>
<head><meta charset="utf-8"><title>wasmtime / PR #12426 Added a thread_local guard to trigge... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312426.20Added.20a.20thread_local.20guard.20to.20trigge.2E.2E.2E.html">wasmtime / PR #12426 Added a thread_local guard to trigge...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="569893636"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312426%20Added%20a%20thread_local%20guard%20to%20trigge.../near/569893636" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312426.20Added.20a.20thread_local.20guard.20to.20trigge.2E.2E.2E.html#569893636">(Jan 24 2026 at 18:31)</a>:</h4>
<p>ohadravid opened <a href="https://github.com/bytecodealliance/wasmtime/pull/12426">PR #12426</a> from <code>ohadravid:windows-fls-thread-local-guard</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
<p>Follow to <a href="https://github.com/rust-lang/rust/pull/148799">https://github.com/rust-lang/rust/pull/148799</a>, specifically @alexcrichton's <a href="https://github.com/rust-lang/rust/pull/148799#issuecomment-3793025504">comment</a>.</p>
<p>Summary: <a href="https://github.com/rust-lang/rust/pull/148799">https://github.com/rust-lang/rust/pull/148799</a> switches the way destructors for thread locals are scheduled on Windows, and will now use Fiber Local Storage (<code>FlsAlloc</code> accepts a callback that is called on fiber/thread/process exit).</p>
<p>Because <code>wasmtime</code> uses Fibers on Windows to support async functions, it now need to make sure that this hook is registered before Fibers are used.</p>
<p>To do that, we create an additional TLS variable with a <code>Drop</code> impl, and use it just before calling <code>ConvertThreadToFiber</code>. Because <code>ConvertFiberToThread</code> is already called before exiting, this guarantees that the hook will both be registered correctly, and invoked when the thread exits.</p>
<p>If a fiber does exit abnormally, it's possible that <code>ConvertFiberToThread</code> won't be called, in which case thread locals with <code>Drop</code> impls will be leaked.</p>
<p>@alexcrichton - let me know if you want me to add a <code>resume_separate_thread</code>-like test that uses thread locals + a "native" os thread (== one that isn't initialized with the Rust runtime).</p>
</blockquote>



<a name="569893637"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312426%20Added%20a%20thread_local%20guard%20to%20trigge.../near/569893637" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312426.20Added.20a.20thread_local.20guard.20to.20trigge.2E.2E.2E.html#569893637">(Jan 24 2026 at 18:31)</a>:</h4>
<p><strong>ohadravid</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers">wasmtime-core-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/12426">PR #12426</a>.</p>



<a name="569893639"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312426%20Added%20a%20thread_local%20guard%20to%20trigge.../near/569893639" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312426.20Added.20a.20thread_local.20guard.20to.20trigge.2E.2E.2E.html#569893639">(Jan 24 2026 at 18:31)</a>:</h4>
<p><strong>ohadravid</strong> requested <a href="https://github.com/pchickey">pchickey</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/12426">PR #12426</a>.</p>



<a name="569909376"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312426%20Added%20a%20thread_local%20guard%20to%20trigge.../near/569909376" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312426.20Added.20a.20thread_local.20guard.20to.20trigge.2E.2E.2E.html#569909376">(Jan 24 2026 at 23:03)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/12426#issuecomment-3795676198">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/12426">PR #12426</a>:</p>
<blockquote>
<p>Thanks for this! If you've got a test that'd be awesome to add, but no need to go out of your way for that. You can feel free to add it to this crate itself or in the top level <code>tests/*</code> as appropriate</p>
</blockquote>



<a name="569909384"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312426%20Added%20a%20thread_local%20guard%20to%20trigge.../near/569909384" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312426.20Added.20a.20thread_local.20guard.20to.20trigge.2E.2E.2E.html#569909384">(Jan 24 2026 at 23:03)</a>:</h4>
<p>alexcrichton unassigned pchickey from <a href="https://github.com/bytecodealliance/wasmtime/pull/12426">PR #12426 Added a thread_local guard to trigger dtor hook before fibers are used</a>.</p>



<a name="569909385"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312426%20Added%20a%20thread_local%20guard%20to%20trigge.../near/569909385" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312426.20Added.20a.20thread_local.20guard.20to.20trigge.2E.2E.2E.html#569909385">(Jan 24 2026 at 23:03)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/alexcrichton">alexcrichton</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/12426">PR #12426</a>.</p>



<a name="570646187"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312426%20Added%20a%20thread_local%20guard%20to%20trigge.../near/570646187" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312426.20Added.20a.20thread_local.20guard.20to.20trigge.2E.2E.2E.html#570646187">(Jan 28 2026 at 19:42)</a>:</h4>
<p>ohadravid updated <a href="https://github.com/bytecodealliance/wasmtime/pull/12426">PR #12426</a>.</p>



<a name="570651231"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312426%20Added%20a%20thread_local%20guard%20to%20trigge.../near/570651231" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312426.20Added.20a.20thread_local.20guard.20to.20trigge.2E.2E.2E.html#570651231">(Jan 28 2026 at 20:12)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/12426#pullrequestreview-3718947469">PR review</a>.</p>



<a name="570651251"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312426%20Added%20a%20thread_local%20guard%20to%20trigge.../near/570651251" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312426.20Added.20a.20thread_local.20guard.20to.20trigge.2E.2E.2E.html#570651251">(Jan 28 2026 at 20:12)</a>:</h4>
<p>alexcrichton <a href="https://github.com/bytecodealliance/wasmtime/pull/12426#issuecomment-3813678823">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/12426">PR #12426</a>:</p>
<blockquote>
<p>Thanks so much again for this!</p>
</blockquote>



<a name="570651260"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312426%20Added%20a%20thread_local%20guard%20to%20trigge.../near/570651260" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312426.20Added.20a.20thread_local.20guard.20to.20trigge.2E.2E.2E.html#570651260">(Jan 28 2026 at 20:12)</a>:</h4>
<p>alexcrichton added <a href="https://github.com/bytecodealliance/wasmtime/pull/12426">PR #12426 Added a thread_local guard to trigger dtor hook before fibers are used</a> to the merge queue.</p>



<a name="570655909"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312426%20Added%20a%20thread_local%20guard%20to%20trigge.../near/570655909" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312426.20Added.20a.20thread_local.20guard.20to.20trigge.2E.2E.2E.html#570655909">(Jan 28 2026 at 20:40)</a>:</h4>
<p>alexcrichton merged <a href="https://github.com/bytecodealliance/wasmtime/pull/12426">PR #12426</a>.</p>



<a name="570655912"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2312426%20Added%20a%20thread_local%20guard%20to%20trigge.../near/570655912" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2312426.20Added.20a.20thread_local.20guard.20to.20trigge.2E.2E.2E.html#570655912">(Jan 28 2026 at 20:40)</a>:</h4>
<p>alexcrichton removed <a href="https://github.com/bytecodealliance/wasmtime/pull/12426">PR #12426 Added a thread_local guard to trigger dtor hook before fibers are used</a> from the merge queue.</p>



<hr><p>Last updated: Feb 22 2026 at 11:05 UTC</p>
</html>
<html>
<head><meta charset="utf-8"><title>wasmtime / PR #11570 aarch64: Add support for &quot;near&quot; in `... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311570.20aarch64.3A.20Add.20support.20for.20.22near.22.20in.20.60.2E.2E.2E.html">wasmtime / PR #11570 aarch64: Add support for &quot;near&quot; in `...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="536839154"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311570%20aarch64%3A%20Add%20support%20for%20%22near%22%20in%20%60.../near/536839154" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311570.20aarch64.3A.20Add.20support.20for.20.22near.22.20in.20.60.2E.2E.2E.html#536839154">(Aug 29 2025 at 18:06)</a>:</h4>
<p>alexcrichton opened <a href="https://github.com/bytecodealliance/wasmtime/pull/11570">PR #11570</a> from <code>alexcrichton:aarch64-near-symbol</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>The current aarch64 backend does not support <code>symbol_value</code> to get the value of a function, for example, with a "near" relocation using a relative relocation. Currently it uses an <code>Abs8</code> relocation which means that it's not suitable in Wasmtime, for example.</p>
<p>This commit refactors relocation/external name support in the aarch64 backend to support this mode of relocation. The previous <code>LoadExtName</code> was split into <code>LoadExtName{Got,Near,Far}</code> where the "near" bit is what's new to the backend. The preexisting <code>symbol-value.clif</code>-style tests were updated to match the x64 backend which has a more comprehensive suite of examples of what it looks like to refer to various symbols.</p>
<p>The goal of this commit is to enable Wasmtime to generate code which refers to a relative point elsewhere in the code (e.g. an exception handler) and load the value into a register. This part isn't filled out yet, but it seemed good to at least in the meantime fill out these missing relocations in the backend.</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="536839155"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311570%20aarch64%3A%20Add%20support%20for%20%22near%22%20in%20%60.../near/536839155" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311570.20aarch64.3A.20Add.20support.20for.20.22near.22.20in.20.60.2E.2E.2E.html#536839155">(Aug 29 2025 at 18:06)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/cfallin">cfallin</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/11570">PR #11570</a>.</p>



<a name="536839156"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311570%20aarch64%3A%20Add%20support%20for%20%22near%22%20in%20%60.../near/536839156" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311570.20aarch64.3A.20Add.20support.20for.20.22near.22.20in.20.60.2E.2E.2E.html#536839156">(Aug 29 2025 at 18:06)</a>:</h4>
<p><strong>alexcrichton</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/11570">PR #11570</a>.</p>



<a name="536843578"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311570%20aarch64%3A%20Add%20support%20for%20%22near%22%20in%20%60.../near/536843578" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311570.20aarch64.3A.20Add.20support.20for.20.22near.22.20in.20.60.2E.2E.2E.html#536843578">(Aug 29 2025 at 18:39)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11570#pullrequestreview-3169683118">PR review</a>:</p>
<blockquote>
<p>Thanks! This definitely makes sense to have.</p>
</blockquote>



<a name="536843579"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311570%20aarch64%3A%20Add%20support%20for%20%22near%22%20in%20%60.../near/536843579" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311570.20aarch64.3A.20Add.20support.20for.20.22near.22.20in.20.60.2E.2E.2E.html#536843579">(Aug 29 2025 at 18:39)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/11570#discussion_r2310845668">PR review comment</a>:</p>
<blockquote>
<p>On looking a bit further, it seems that <a href="https://github.com/bytecodealliance/wasmtime/blob/0744262f79e235b172331f5ba1a2c43b5aedcbfb/cranelift/codegen/src/ir/function.rs#L325"><code>Function::is_leaf</code></a> only looks to see if there are signatures -- so <code>func_addr</code> triggers the "not a leaf function" mode and forces the frame.</p>
<p>Mind filing an issue that we should probably determine leaf-ness by scanning VCode instead for any instructions that claim to be calls? It should be machine-dependent anyway since libcalls can happen even in functions without IR-level calls. (I suppose that <code>is_leaf</code> and the no-frame ABI optimization isn't even right, in that case -- but we get away with it because the aarch64 backend doesn't fall back to any libcalls for FP stuff, and also because this configuration isn't exposed to Wasmtime?)</p>
</blockquote>



<a name="536843580"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311570%20aarch64%3A%20Add%20support%20for%20%22near%22%20in%20%60.../near/536843580" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311570.20aarch64.3A.20Add.20support.20for.20.22near.22.20in.20.60.2E.2E.2E.html#536843580">(Aug 29 2025 at 18:39)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/11570#discussion_r2310830858">PR review comment</a>:</p>
<blockquote>
<p>Sort of curious that the leaf-function optimization is no longer happening here, and we're getting a frame now -- won't matter for Wasmtime since we always force frames, but is there a reason you're aware of that this is happening?</p>
</blockquote>



<a name="536859719"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311570%20aarch64%3A%20Add%20support%20for%20%22near%22%20in%20%60.../near/536859719" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311570.20aarch64.3A.20Add.20support.20for.20.22near.22.20in.20.60.2E.2E.2E.html#536859719">(Aug 29 2025 at 20:44)</a>:</h4>
<p>github-actions[bot] <a href="https://github.com/bytecodealliance/wasmtime/pull/11570#issuecomment-3238232005">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/11570">PR #11570</a>:</p>
<blockquote>
<h4>Subscribe to Label Action</h4>
<p>cc @cfallin, @fitzgen</p>
<p>&lt;details&gt;<br>
This issue or pull request has been labeled: "cranelift", "cranelift:area:aarch64", "cranelift:area:machinst", "cranelift:area:x64", "isle"</p>
<p>Thus the following users have been cc'd because of the following labels:</p>
<ul>
<li>cfallin: isle</li>
<li>fitzgen: isle</li>
</ul>
<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>
<p><a href="https://github.com/bytecodealliance/subscribe-to-label-action">Learn more.</a><br>
&lt;/details&gt;</p>
</blockquote>



<a name="536863000"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311570%20aarch64%3A%20Add%20support%20for%20%22near%22%20in%20%60.../near/536863000" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311570.20aarch64.3A.20Add.20support.20for.20.22near.22.20in.20.60.2E.2E.2E.html#536863000">(Aug 29 2025 at 21:15)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/11570#pullrequestreview-3170277898">PR review</a>.</p>



<a name="536863002"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311570%20aarch64%3A%20Add%20support%20for%20%22near%22%20in%20%60.../near/536863002" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311570.20aarch64.3A.20Add.20support.20for.20.22near.22.20in.20.60.2E.2E.2E.html#536863002">(Aug 29 2025 at 21:15)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/11570#discussion_r2311299720">PR review comment</a>:</p>
<blockquote>
<p>Sure thing! <a href="https://github.com/bytecodealliance/wasmtime/issues/11573">https://github.com/bytecodealliance/wasmtime/issues/11573</a></p>
<p>And yeah AFAIK we're ok in Wasmtime, but I''m not 100% sure in that judgment. Your reasoning sounds reasonable to me, however</p>
</blockquote>



<a name="536866332"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311570%20aarch64%3A%20Add%20support%20for%20%22near%22%20in%20%60.../near/536866332" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311570.20aarch64.3A.20Add.20support.20for.20.22near.22.20in.20.60.2E.2E.2E.html#536866332">(Aug 29 2025 at 21:58)</a>:</h4>
<p>alexcrichton updated <a href="https://github.com/bytecodealliance/wasmtime/pull/11570">PR #11570</a>.</p>



<a name="536874991"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311570%20aarch64%3A%20Add%20support%20for%20%22near%22%20in%20%60.../near/536874991" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311570.20aarch64.3A.20Add.20support.20for.20.22near.22.20in.20.60.2E.2E.2E.html#536874991">(Aug 30 2025 at 00:06)</a>:</h4>
<p>alexcrichton has enabled auto merge for <a href="https://github.com/bytecodealliance/wasmtime/pull/11570">PR #11570</a>.</p>



<a name="536876637"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2311570%20aarch64%3A%20Add%20support%20for%20%22near%22%20in%20%60.../near/536876637" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2311570.20aarch64.3A.20Add.20support.20for.20.22near.22.20in.20.60.2E.2E.2E.html#536876637">(Aug 30 2025 at 00:34)</a>:</h4>
<p>alexcrichton merged <a href="https://github.com/bytecodealliance/wasmtime/pull/11570">PR #11570</a>.</p>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
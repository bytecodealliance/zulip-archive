<html>
<head><meta charset="utf-8"><title>wasmtime / PR #10671 Support custom yield behavior for ep... · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310671.20Support.20custom.20yield.20behavior.20for.20ep.2E.2E.2E.html">wasmtime / PR #10671 Support custom yield behavior for ep...</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="514222649"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310671%20Support%20custom%20yield%20behavior%20for%20ep.../near/514222649" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310671.20Support.20custom.20yield.20behavior.20for.20ep.2E.2E.2E.html#514222649">(Apr 24 2025 at 20:25)</a>:</h4>
<p>posborne opened <a href="https://github.com/bytecodealliance/wasmtime/pull/10671">PR #10671</a> from <code>posborne:custom-async-yield</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>As described in<br>
<a href="https://github.com/bytecodealliance/wasmtime/issues/10667">https://github.com/bytecodealliance/wasmtime/issues/10667</a>, the yield future provided in-tree when a epoch callback cannot always trigger the specific behavior desired in async schedulers like tokio.</p>
<p>This change introduces a new variant to the UpdateDeadline callback with the future implementing the desired task suspension behavior desired for yielding control within the async runtime.</p>
<p>Note that this change does not allow for controlling this behavior for fuel yielding at this time.</p>
<p>CC @aturon @fitzgen -- at first I looked at adding a separate async callback but this felt a little cleaner but happy to change things up.  There's definitely some overhead here in needing to frequently do the future boxing so would be happy to look at other paths to optimize if we have concerns (though my gut says it shouldn't be _too_ bad).</p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="514222651"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310671%20Support%20custom%20yield%20behavior%20for%20ep.../near/514222651" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310671.20Support.20custom.20yield.20behavior.20for.20ep.2E.2E.2E.html#514222651">(Apr 24 2025 at 20:25)</a>:</h4>
<p><strong>posborne</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers">wasmtime-core-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/10671">PR #10671</a>.</p>



<a name="514222652"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310671%20Support%20custom%20yield%20behavior%20for%20ep.../near/514222652" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310671.20Support.20custom.20yield.20behavior.20for.20ep.2E.2E.2E.html#514222652">(Apr 24 2025 at 20:25)</a>:</h4>
<p><strong>posborne</strong> requested <a href="https://github.com/fitzgen">fitzgen</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/10671">PR #10671</a>.</p>



<a name="514232288"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310671%20Support%20custom%20yield%20behavior%20for%20ep.../near/514232288" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310671.20Support.20custom.20yield.20behavior.20for.20ep.2E.2E.2E.html#514232288">(Apr 24 2025 at 21:32)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/10671#discussion_r2059264701">PR review comment</a>:</p>
<blockquote>
<p>Drive-by-comment on this unrelated to this change, mind throwing <code>#[non_exhaustive]</code> on this enum definition? That'll help consumers work with this a bit more nicely with the <code>#[cfg]</code>'d variants</p>
</blockquote>



<a name="514232289"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310671%20Support%20custom%20yield%20behavior%20for%20ep.../near/514232289" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310671.20Support.20custom.20yield.20behavior.20for.20ep.2E.2E.2E.html#514232289">(Apr 24 2025 at 21:32)</a>:</h4>
<p>alexcrichton created <a href="https://github.com/bytecodealliance/wasmtime/pull/10671#discussion_r2059265544">PR review comment</a>:</p>
<blockquote>
<p>I realize this was probably copied from <code>async_yield_impl</code> but nowadays I think we can do <code>let mut future = core::pin::pin!(future);</code> to safely creat <code>Pin&lt;Thing&gt;</code> and then with some <code>future.as_mut()</code> or such invocations I think it can safely create <code>Pin&lt;&amp;mut T&gt;</code> to pass here</p>
</blockquote>



<a name="514232290"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310671%20Support%20custom%20yield%20behavior%20for%20ep.../near/514232290" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310671.20Support.20custom.20yield.20behavior.20for.20ep.2E.2E.2E.html#514232290">(Apr 24 2025 at 21:32)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/10671#pullrequestreview-2792564803">PR review</a>:</p>
<blockquote>
<p>Seems like a reasonable API to me! I think it's fine to add similar configuration options for fuel in the future if necessary as a Fuel-specific configuration option</p>
</blockquote>



<a name="514888659"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310671%20Support%20custom%20yield%20behavior%20for%20ep.../near/514888659" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310671.20Support.20custom.20yield.20behavior.20for.20ep.2E.2E.2E.html#514888659">(Apr 28 2025 at 19:25)</a>:</h4>
<p>posborne submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/10671#pullrequestreview-2800472104">PR review</a>.</p>



<a name="514888660"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310671%20Support%20custom%20yield%20behavior%20for%20ep.../near/514888660" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310671.20Support.20custom.20yield.20behavior.20for.20ep.2E.2E.2E.html#514888660">(Apr 28 2025 at 19:25)</a>:</h4>
<p>posborne created <a href="https://github.com/bytecodealliance/wasmtime/pull/10671#discussion_r2064376797">PR review comment</a>:</p>
<blockquote>
<p>In this particular case, I think we can just change the type signature of the future to be a <code>Pin&lt;Box&lt;dyn Future ...&gt;&gt;&gt;</code> to avoid having to do anything extra to mark the memory as pinned.</p>
</blockquote>



<a name="514898102"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310671%20Support%20custom%20yield%20behavior%20for%20ep.../near/514898102" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310671.20Support.20custom.20yield.20behavior.20for.20ep.2E.2E.2E.html#514898102">(Apr 28 2025 at 20:28)</a>:</h4>
<p>posborne updated <a href="https://github.com/bytecodealliance/wasmtime/pull/10671">PR #10671</a>.</p>



<a name="514901305"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310671%20Support%20custom%20yield%20behavior%20for%20ep.../near/514901305" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310671.20Support.20custom.20yield.20behavior.20for.20ep.2E.2E.2E.html#514901305">(Apr 28 2025 at 20:49)</a>:</h4>
<p>posborne <a href="https://github.com/bytecodealliance/wasmtime/pull/10671#issuecomment-2836558248">commented</a> on <a href="https://github.com/bytecodealliance/wasmtime/pull/10671">PR #10671</a>:</p>
<blockquote>
<p>I considered adding a new API such as <code>epoch_deadline_async_yield_and_update_custom</code> or modifying the existing API to take a duration or duration + future-yielding callback but that felt pretty heavy.  As-is, there's an option for embedders that have a need to customize the yield behavior but figured I would at least call things out.</p>
<p>The tokio behavior is subtle enough to probably not rightly be able to be considered a bug and most use cases will probably not run into issues with the stock yield behavior.</p>
</blockquote>



<a name="514910068"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310671%20Support%20custom%20yield%20behavior%20for%20ep.../near/514910068" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310671.20Support.20custom.20yield.20behavior.20for.20ep.2E.2E.2E.html#514910068">(Apr 28 2025 at 21:51)</a>:</h4>
<p>alexcrichton submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/10671#pullrequestreview-2801078631">PR review</a>.</p>



<a name="514912636"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310671%20Support%20custom%20yield%20behavior%20for%20ep.../near/514912636" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310671.20Support.20custom.20yield.20behavior.20for.20ep.2E.2E.2E.html#514912636">(Apr 28 2025 at 22:13)</a>:</h4>
<p>alexcrichton merged <a href="https://github.com/bytecodealliance/wasmtime/pull/10671">PR #10671</a>.</p>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
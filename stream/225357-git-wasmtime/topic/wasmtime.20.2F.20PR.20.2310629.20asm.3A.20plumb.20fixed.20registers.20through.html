<html>
<head><meta charset="utf-8"><title>wasmtime / PR #10629 asm: plumb fixed registers through · git-wasmtime · Zulip Chat Archive</title></head>
<h2>Stream: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/index.html">git-wasmtime</a></h2>
<h3>Topic: <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310629.20asm.3A.20plumb.20fixed.20registers.20through.html">wasmtime / PR #10629 asm: plumb fixed registers through</a></h3>

<hr>

<base href="https://bytecodealliance.zulipchat.com">

<head><link href="https://bytecodealliance.github.io/zulip-archive/style.css" rel="stylesheet"></head>

<a name="513482255"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310629%20asm%3A%20plumb%20fixed%20registers%20through/near/513482255" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310629.20asm.3A.20plumb.20fixed.20registers.20through.html#513482255">(Apr 21 2025 at 22:59)</a>:</h4>
<p>abrown opened <a href="https://github.com/bytecodealliance/wasmtime/pull/10629">PR #10629</a> from <code>abrown:asm-fixed</code> to <code>bytecodealliance:main</code>:</p>
<blockquote>
<p>This change introduces a new <code>Fixed</code> wrapper type that allows us to plumb fixed registers through the assembler. These instructions are not yet used by <code>cranelift-codegen</code>, but will be necessary at some point as described in [#10238]. The end result of this is that up at the <code>cranelift-codegen</code> level, fixed registers should look like run-of-the-mill virtual registers using the appropriate types, but down in <code>cranelift-assembler-x64</code> we panic if the register allocator does not give them the correct register.</p>
<p>[#10238]: <a href="https://github.com/bytecodealliance/wasmtime/issues/10238">https://github.com/bytecodealliance/wasmtime/issues/10238</a></p>
<p>&lt;!--<br>
Please make sure you include the following information:</p>
<ul>
<li>
<p>If this work has been discussed elsewhere, please include a link to that<br>
  conversation. If it was discussed in an issue, just mention "issue #...".</p>
</li>
<li>
<p>Explain why this change is needed. If the details are in an issue already,<br>
  this can be brief.</p>
</li>
</ul>
<p>Our development process is documented in the Wasmtime book:<br>
<a href="https://docs.wasmtime.dev/contributing-development-process.html">https://docs.wasmtime.dev/contributing-development-process.html</a></p>
<p>Please ensure all communication follows the code of conduct:<br>
<a href="https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>
--&gt;</p>
</blockquote>



<a name="513482256"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310629%20asm%3A%20plumb%20fixed%20registers%20through/near/513482256" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310629.20asm.3A.20plumb.20fixed.20registers.20through.html#513482256">(Apr 21 2025 at 22:59)</a>:</h4>
<p><strong>abrown</strong> requested <a href="https://github.com/cfallin">cfallin</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/10629">PR #10629</a>.</p>



<a name="513482257"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310629%20asm%3A%20plumb%20fixed%20registers%20through/near/513482257" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310629.20asm.3A.20plumb.20fixed.20registers.20through.html#513482257">(Apr 21 2025 at 22:59)</a>:</h4>
<p><strong>abrown</strong> requested <a href="https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers">wasmtime-compiler-reviewers</a> for a review on <a href="https://github.com/bytecodealliance/wasmtime/pull/10629">PR #10629</a>.</p>



<a name="513483905"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310629%20asm%3A%20plumb%20fixed%20registers%20through/near/513483905" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310629.20asm.3A.20plumb.20fixed.20registers.20through.html#513483905">(Apr 21 2025 at 23:15)</a>:</h4>
<p>abrown updated <a href="https://github.com/bytecodealliance/wasmtime/pull/10629">PR #10629</a>.</p>



<a name="513484620"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310629%20asm%3A%20plumb%20fixed%20registers%20through/near/513484620" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310629.20asm.3A.20plumb.20fixed.20registers.20through.html#513484620">(Apr 21 2025 at 23:24)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/10629#pullrequestreview-2782402950">PR review</a>:</p>
<blockquote>
<p>Looks good, thanks! Just some nits below.</p>
</blockquote>



<a name="513484621"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310629%20asm%3A%20plumb%20fixed%20registers%20through/near/513484621" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310629.20asm.3A.20plumb.20fixed.20registers.20through.html#513484621">(Apr 21 2025 at 23:24)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/10629#discussion_r2053098683">PR review comment</a>:</p>
<blockquote>
<p>Is there a reason (e.g. generic interface somewhere else) that we need to accept <code>reg</code> here as an argument, rather than just using the generic parameter <code>E</code> -- since there is only one valid value to pass in?</p>
</blockquote>



<a name="513484622"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310629%20asm%3A%20plumb%20fixed%20registers%20through/near/513484622" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310629.20asm.3A.20plumb.20fixed.20registers.20through.html#513484622">(Apr 21 2025 at 23:24)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/10629#discussion_r2053100499">PR review comment</a>:</p>
<blockquote>
<p>Nice! This is presumably because a reg that we carried as a (always the same value) <code>u32</code> previously now becomes a type parameter? Good to see reductions in any case.</p>
</blockquote>



<a name="513484623"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310629%20asm%3A%20plumb%20fixed%20registers%20through/near/513484623" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310629.20asm.3A.20plumb.20fixed.20registers.20through.html#513484623">(Apr 21 2025 at 23:24)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/10629#discussion_r2053099740">PR review comment</a>:</p>
<blockquote>
<p>Ah, I see below, this enables the idiom <code>Fixed(rax)</code> for example, where type inference carries <code>reg</code> through to the generic parameter.</p>
<p>Maybe there could be two entry points, <code>new()</code> and <code>from_const_reg(reg: u8)</code> or similar? Maybe not a huge deal; just trying to reduce confusing APIs.</p>
</blockquote>



<a name="513489822"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310629%20asm%3A%20plumb%20fixed%20registers%20through/near/513489822" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310629.20asm.3A.20plumb.20fixed.20registers.20through.html#513489822">(Apr 22 2025 at 00:18)</a>:</h4>
<p>abrown submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/10629#pullrequestreview-2782459867">PR review</a>.</p>



<a name="513489823"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310629%20asm%3A%20plumb%20fixed%20registers%20through/near/513489823" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310629.20asm.3A.20plumb.20fixed.20registers.20through.html#513489823">(Apr 22 2025 at 00:19)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/wasmtime/pull/10629#discussion_r2053138623">PR review comment</a>:</p>
<blockquote>
<p>I don't think we need a different entry point and, in fact, I've been trying to remove this <code>AsReg::new</code> somehow. It's only during fuzzing that we need the ability to construct an <code>AsReg</code>. I just can't seem to pull the right Jenga blocks out to get rid of this without things falling down.</p>
</blockquote>



<a name="513490282"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310629%20asm%3A%20plumb%20fixed%20registers%20through/near/513490282" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310629.20asm.3A.20plumb.20fixed.20registers.20through.html#513490282">(Apr 22 2025 at 00:24)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/10629#pullrequestreview-2782463855">PR review</a>.</p>



<a name="513490284"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310629%20asm%3A%20plumb%20fixed%20registers%20through/near/513490284" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310629.20asm.3A.20plumb.20fixed.20registers.20through.html#513490284">(Apr 22 2025 at 00:24)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/10629#discussion_r2053141631">PR review comment</a>:</p>
<blockquote>
<p>Ah, I see -- a few thoughts then:</p>
<ul>
<li>At the very least, <code>pub(crate) fn new(...)</code> so it's only exposed to where fuzzing needs it (the <code>Arbitrary</code> impl);</li>
<li>Perhaps removing the field (so it's a zero-sized struct, carrying <code>E</code> only at the type level); you still have <code>E</code> for <code>enc()</code> to work; the only part I'm not as clear on is where <code>AsRef</code> comes in and why you need a reference (vs. constructing an <code>R</code> on-the-fly as needed, as e.g. <code>fn to_reg(&amp;self) -&gt; R { R::new(E) }</code> or something like that)</li>
</ul>
</blockquote>



<a name="513492325"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310629%20asm%3A%20plumb%20fixed%20registers%20through/near/513492325" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310629.20asm.3A.20plumb.20fixed.20registers.20through.html#513492325">(Apr 22 2025 at 00:47)</a>:</h4>
<p>abrown merged <a href="https://github.com/bytecodealliance/wasmtime/pull/10629">PR #10629</a>.</p>



<a name="513494875"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310629%20asm%3A%20plumb%20fixed%20registers%20through/near/513494875" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310629.20asm.3A.20plumb.20fixed.20registers.20through.html#513494875">(Apr 22 2025 at 01:14)</a>:</h4>
<p>abrown submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/10629#pullrequestreview-2782504981">PR review</a>.</p>



<a name="513494876"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310629%20asm%3A%20plumb%20fixed%20registers%20through/near/513494876" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310629.20asm.3A.20plumb.20fixed.20registers.20through.html#513494876">(Apr 22 2025 at 01:14)</a>:</h4>
<p>abrown created <a href="https://github.com/bytecodealliance/wasmtime/pull/10629#discussion_r2053169823">PR review comment</a>:</p>
<blockquote>
<blockquote>
<ul>
<li>At the very least, <code>pub(crate) fn new(...)</code> so it's only exposed to where fuzzing needs it (the <code>Arbitrary</code> impl);</li>
</ul>
</blockquote>
<p>What I meant is that I want to remove the trait function <code>AsReg::new</code>--we can't make trait functions <code>pub(crate)</code>, right?</p>
<blockquote>
<ul>
<li>Perhaps removing the field (so it's a zero-sized struct, carrying <code>E</code> only at the type level); you still have <code>E</code> for <code>enc()</code> to work; the only part I'm not as clear on is where <code>AsRef</code> comes in and why you need a reference (vs. constructing an <code>R</code> on-the-fly as needed, as e.g. <code>fn to_reg(&amp;self) -&gt; R { R::new(E) }</code> or something like that)</li>
</ul>
</blockquote>
<p>I believe we still need the field because we need a place for the virtual register to live until register allocation happens.</p>
</blockquote>



<a name="513504273"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310629%20asm%3A%20plumb%20fixed%20registers%20through/near/513504273" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310629.20asm.3A.20plumb.20fixed.20registers.20through.html#513504273">(Apr 22 2025 at 02:54)</a>:</h4>
<p>cfallin submitted <a href="https://github.com/bytecodealliance/wasmtime/pull/10629#pullrequestreview-2782636399">PR review</a>.</p>



<a name="513504274"></a>
<h4><a href="https://bytecodealliance.zulipchat.com#narrow/stream/225357-git-wasmtime/topic/wasmtime%20/%20PR%20%2310629%20asm%3A%20plumb%20fixed%20registers%20through/near/513504274" class="zl"><img src="https://bytecodealliance.github.io/zulip-archive/assets/img/zulip.svg" alt="view this post on Zulip" style="width:20px;height:20px;"></a> Wasmtime GitHub notifications bot <a href="https://bytecodealliance.github.io/zulip-archive/stream/225357-git-wasmtime/topic/wasmtime.20.2F.20PR.20.2310629.20asm.3A.20plumb.20fixed.20registers.20through.html#513504274">(Apr 22 2025 at 02:54)</a>:</h4>
<p>cfallin created <a href="https://github.com/bytecodealliance/wasmtime/pull/10629#discussion_r2053250247">PR review comment</a>:</p>
<blockquote>
<p>Oh, d'oh, I had missed that <code>new</code> was part of the trait definition too, sorry! And you're of course right that we need an actual vreg too.</p>
</blockquote>



<hr><p>Last updated: Oct 25 2025 at 23:03 UTC</p>
</html>
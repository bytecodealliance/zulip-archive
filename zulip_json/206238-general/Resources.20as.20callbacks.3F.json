[
    {
        "content": "<p>Hello,</p>\n<p>Trying to understand if it's possible to use components to achieve a callback/dependency injection pattern between components.</p>\n<p>I want to declare a resource in a <code>callee</code> with a particular contract, import it, and then export a function from <code>callee</code> that takes an instance of the resource, and then I want to execute some function on that instance:</p>\n<div class=\"codehilite\" data-code-language=\"wit\"><pre><span></span><code>package callee:component;\n\ninterface callbacks {\n    resource some-contract {\n        constructor();\n        run: func(message: string);\n    }\n}\n\ninterface api {\n    use callbacks.{some-contract};\n    process: func(callback: some-contract);\n}\n\nworld component {\n    export api;\n}\n</code></pre></div>\n<p>The key is, I don't want to implement the callback type in the <code>callee</code>, it should be implemented in a caller. I just want the callee to define:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">#[allow(warnings)]</span>\n<span class=\"k\">mod</span><span class=\"w\"> </span><span class=\"nn\">bindings</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"k\">use</span><span class=\"w\"> </span><span class=\"k\">super</span><span class=\"p\">::</span><span class=\"n\">Callee</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wit_bindgen</span><span class=\"p\">::</span><span class=\"n\">generate</span><span class=\"o\">!</span><span class=\"p\">();</span>\n<span class=\"w\">    </span><span class=\"n\">export</span><span class=\"o\">!</span><span class=\"p\">(</span><span class=\"n\">Callee</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n\n<span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">exports</span><span class=\"p\">::</span><span class=\"n\">callee</span><span class=\"p\">::</span><span class=\"n\">component</span><span class=\"p\">::</span><span class=\"n\">api</span><span class=\"p\">;</span>\n<span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">callee</span><span class=\"p\">::</span><span class=\"n\">component</span><span class=\"p\">::</span><span class=\"n\">callbacks</span><span class=\"p\">;</span>\n\n<span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">Callee</span><span class=\"p\">;</span>\n\n<span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">api</span><span class=\"p\">::</span><span class=\"n\">Guest</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">Callee</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">process</span><span class=\"p\">(</span><span class=\"n\">callback</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">callbacks</span><span class=\"p\">::</span><span class=\"n\">SomeContract</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"n\">callback</span><span class=\"p\">.</span><span class=\"n\">run</span><span class=\"p\">(</span><span class=\"s\">\"Hello, world!\"</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>This seems to compile, but how do I implement a caller component that can define the callback implementation that it then passes to <code>callee:component/api::process</code>?</p>",
        "id": 573595871,
        "sender_full_name": "James Mart",
        "timestamp": 1770922183
    },
    {
        "content": "<p>You won't be able to implement the caller component due to <a href=\"https://github.com/WebAssembly/component-model/issues/272\">this limitation</a>.  There are unfortunately no good options for callbacks in the component model yet besides rolling your own ad-hoc version using e.g. a function table and u32 indexes into that table.</p>",
        "id": 573597458,
        "sender_full_name": "Joel Dice",
        "timestamp": 1770922721
    },
    {
        "content": "<p>Oh, and even the function table approach won't work given that recursive reentrance is disallowed currently (i.e. when the caller calls the callee and the callee tries to call back into the caller, that will trap).</p>\n<p>With the new <a href=\"https://github.com/WebAssembly/component-model/blob/main/design/mvp/Concurrency.md\">concurrency model</a>, you can have the callee export an async function which can yield control to the callee, and they can talk to each other via e.g. <code>stream&lt;T&gt;</code>s, where <code>T</code> could be a type representing a function call and its parameters, but I think that's the best we can do at this point.</p>",
        "id": 573598912,
        "sender_full_name": "Joel Dice",
        "timestamp": 1770923219
    },
    {
        "content": "<p>Unfortunate answer, but thanks for the quick response!</p>",
        "id": 573599485,
        "sender_full_name": "James Mart",
        "timestamp": 1770923335
    }
]
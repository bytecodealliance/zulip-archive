[
    {
        "content": "<p>Hi</p>\n<p>Is it possible to instrument wasmtime source code such that I can redirect all wasi calls to some monitor first before the actual wasi call?<br>\nIs this feasible?</p>\n<p>Thanks</p>",
        "id": 492797974,
        "sender_full_name": "celine santosh",
        "timestamp": 1736449772
    },
    {
        "content": "<p>At a conceptual level this is possible because WASI is inserted by calling <code>add_to_linker</code> and you can instead add whatever you want to the linker instead (and avoid calling <code>add_to_linker</code>). From a practical standpoint that's difficult to do because you'd have to duplicate all the type signatures and such, however.</p>",
        "id": 492799818,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1736450375
    },
    {
        "content": "<p>Thanks, could you please also show a file in wasmtime repo where add_to_linker is called on a wasi function</p>",
        "id": 492972032,
        "sender_full_name": "celine santosh",
        "timestamp": 1736522556
    },
    {
        "content": "<p>Ah alas I don't think we have an example of doing this, but the rough idea is that you'd call functions <a href=\"https://docs.rs/wasmtime-wasi/latest/wasmtime_wasi/preview1/wasi_snapshot_preview1/fn.environ_get.html\">like this</a> manually.</p>",
        "id": 492972343,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1736522659
    },
    {
        "content": "<p>e.g. you'd create a <code>Linker</code>, add a custom function to it, and your custom function would forward to that.</p>\n<p>Alternatively, now that I think about it, something that would be much more robust would be to write your own impl of <code>WasiSnapshotPreview1</code> which forwards to the <code>wasmtime-wasi</code> one, allowing you to interpose any function (although you're required to interpose all of them or at least forward arguments)</p>",
        "id": 492972545,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1736522746
    },
    {
        "content": "<p>Another option would be to create a component which both imports and exports all the interfaces in the <code>wasi-cli</code> <a href=\"https://github.com/WebAssembly/wasi-cli/blob/main/wit/imports.wit\">imports</a> world, forwarding every call to the host and also sending monitoring events via another, custom imported interface.</p>",
        "id": 492973804,
        "sender_full_name": "Joel Dice",
        "timestamp": 1736523137
    },
    {
        "content": "<p>Thanks</p>\n<p>I would require network calls to be redirected ,  I guess func_wrap is the one which replaces it<br>\nbut func_wrap() is not there in component model</p>",
        "id": 493012081,
        "sender_full_name": "celine santosh",
        "timestamp": 1736536979
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"253994\">Alex Crichton</span> <a href=\"#narrow/channel/206238-general/topic/Instrumenting.20wasi.20calls/near/492972545\">said</a>:</p>\n<blockquote>\n<p>e.g. you'd create a <code>Linker</code>, add a custom function to it, and your custom function would forward to that.</p>\n<p>Alternatively, now that I think about it, something that would be much more robust would be to write your own impl of <code>WasiSnapshotPreview1</code> which forwards to the <code>wasmtime-wasi</code> one, allowing you to interpose any function (although you're required to interpose all of them or at least forward arguments)</p>\n</blockquote>\n<p>Since I am using network calls especially tcp sockets this won't work in my case right</p>",
        "id": 493012205,
        "sender_full_name": "celine santosh",
        "timestamp": 1736537040
    },
    {
        "content": "<p>Is there simpler option like for example in wasmtime repository , in <a href=\"http://tcp.rs\">tcp.rs</a> file where start-connect is defined, I can call my custom function there? Changing the source code of wasmtime is what I meant by instrumenting.<br>\nwill it break any other functionality?</p>",
        "id": 493012450,
        "sender_full_name": "celine santosh",
        "timestamp": 1736537137
    },
    {
        "content": "<p>Yeah, you can certainly fork <code>wasmtime-wasi</code> and add your custom code there.  That's probably the quickest option, although you'd need to maintain that fork yourself if you plan to use it long-term.  Perhaps if the changes are generic and broadly useful, they could be upstreamed.</p>",
        "id": 493012778,
        "sender_full_name": "Joel Dice",
        "timestamp": 1736537261
    },
    {
        "content": "<p>Okay Thanks a lot</p>",
        "id": 493220179,
        "sender_full_name": "celine santosh",
        "timestamp": 1736714272
    },
    {
        "content": "<p>Hi</p>\n<p>So I have created a <a href=\"http://runner.rs\">runner.rs</a> where I create an engine , store, state linker etc.<br>\nand I have inserted all wasi calls except sockets/tcp.</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">add_to_linker_without_tcp</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">WasiView</span><span class=\"o\">&gt;</span><span class=\"p\">(</span>\n<span class=\"w\">    </span><span class=\"n\">linker</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kp\">&amp;</span><span class=\"nc\">mut</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"p\">::</span><span class=\"n\">component</span><span class=\"p\">::</span><span class=\"n\">Linker</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"p\">,</span>\n<span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">anyhow</span><span class=\"p\">::</span><span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"p\">()</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">type_annotate</span><span class=\"p\">::</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"o\">|</span><span class=\"n\">t</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">WasiImpl</span><span class=\"p\">(</span><span class=\"n\">t</span><span class=\"p\">));</span>\n\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">clocks</span><span class=\"p\">::</span><span class=\"n\">wall_clock</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">clocks</span><span class=\"p\">::</span><span class=\"n\">monotonic_clock</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">sync</span><span class=\"p\">::</span><span class=\"n\">filesystem</span><span class=\"p\">::</span><span class=\"n\">types</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">filesystem</span><span class=\"p\">::</span><span class=\"n\">preopens</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">io</span><span class=\"p\">::</span><span class=\"n\">error</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">sync</span><span class=\"p\">::</span><span class=\"n\">io</span><span class=\"p\">::</span><span class=\"n\">poll</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">sync</span><span class=\"p\">::</span><span class=\"n\">io</span><span class=\"p\">::</span><span class=\"n\">streams</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">random</span><span class=\"p\">::</span><span class=\"n\">random</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">random</span><span class=\"p\">::</span><span class=\"n\">insecure</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">random</span><span class=\"p\">::</span><span class=\"n\">insecure_seed</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">cli</span><span class=\"p\">::</span><span class=\"n\">exit</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">cli</span><span class=\"p\">::</span><span class=\"n\">environment</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">cli</span><span class=\"p\">::</span><span class=\"n\">stdin</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">cli</span><span class=\"p\">::</span><span class=\"n\">stdout</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">cli</span><span class=\"p\">::</span><span class=\"n\">stderr</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">cli</span><span class=\"p\">::</span><span class=\"n\">terminal_input</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">cli</span><span class=\"p\">::</span><span class=\"n\">terminal_output</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">cli</span><span class=\"p\">::</span><span class=\"n\">terminal_stdin</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">cli</span><span class=\"p\">::</span><span class=\"n\">terminal_stdout</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">cli</span><span class=\"p\">::</span><span class=\"n\">terminal_stderr</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"c1\">//wasmtime_wasi::bindings::sync::sockets::tcp::add_to_linker_get_host(l, closure)?;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">sockets</span><span class=\"p\">::</span><span class=\"n\">tcp_create_socket</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">sync</span><span class=\"p\">::</span><span class=\"n\">sockets</span><span class=\"p\">::</span><span class=\"n\">udp</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">sockets</span><span class=\"p\">::</span><span class=\"n\">udp_create_socket</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">sockets</span><span class=\"p\">::</span><span class=\"n\">instance_network</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">sockets</span><span class=\"p\">::</span><span class=\"n\">network</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">sockets</span><span class=\"p\">::</span><span class=\"n\">ip_name_lookup</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"nb\">Ok</span><span class=\"p\">(())</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>So Instead of the wasi call start-connect I want to add my own custom start-connect from another package say mwasi:sockets/tcp which is in wrapper module.<br>\nthis is the wit file of  wrapper module </p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">package</span><span class=\"w\"> </span><span class=\"n\">mwasi</span><span class=\"p\">:</span><span class=\"nc\">sockets</span><span class=\"o\">@</span><span class=\"mf\">0.2.0</span><span class=\"p\">;</span>\n\n<span class=\"n\">interface</span><span class=\"w\"> </span><span class=\"n\">tcp</span><span class=\"p\">{</span>\n\n<span class=\"w\">  </span><span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"p\">:</span><span class=\"nc\">sockets</span><span class=\"o\">/</span><span class=\"n\">network</span><span class=\"o\">@</span><span class=\"mf\">0.2.0.</span><span class=\"p\">{</span><span class=\"n\">network</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"o\">-</span><span class=\"n\">code</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ip</span><span class=\"o\">-</span><span class=\"n\">socket</span><span class=\"o\">-</span><span class=\"n\">address</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ip</span><span class=\"o\">-</span><span class=\"n\">address</span><span class=\"o\">-</span><span class=\"n\">family</span><span class=\"p\">};</span>\n\n<span class=\"w\">  </span><span class=\"n\">start</span><span class=\"o\">-</span><span class=\"n\">connect</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">func</span><span class=\"p\">(</span><span class=\"n\">networkinstance</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">network</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">remoteaddress</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">ip</span><span class=\"o\">-</span><span class=\"n\">socket</span><span class=\"o\">-</span><span class=\"n\">address</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">result</span><span class=\"o\">&lt;</span><span class=\"n\">_</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"o\">-</span><span class=\"n\">code</span><span class=\"o\">&gt;</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"c1\">//(result cm.Result[ error-code, struct{},  error-code])//result&lt;_, error-code&gt;;</span>\n\n<span class=\"p\">}</span>\n\n<span class=\"n\">world</span><span class=\"w\"> </span><span class=\"n\">wrapper</span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"p\">:</span><span class=\"nc\">io</span><span class=\"o\">/</span><span class=\"n\">error</span><span class=\"o\">@</span><span class=\"mf\">0.2.0</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"p\">:</span><span class=\"nc\">sockets</span><span class=\"o\">/</span><span class=\"n\">tcp</span><span class=\"o\">@</span><span class=\"mf\">0.2.0</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"p\">:</span><span class=\"nc\">sockets</span><span class=\"o\">/</span><span class=\"n\">network</span><span class=\"o\">@</span><span class=\"mf\">0.2.0</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">export</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"p\">:</span><span class=\"nc\">cli</span><span class=\"o\">/</span><span class=\"n\">run</span><span class=\"o\">@</span><span class=\"mf\">0.2.0</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">include</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"p\">:</span><span class=\"nc\">cli</span><span class=\"o\">/</span><span class=\"n\">imports</span><span class=\"o\">@</span><span class=\"mf\">0.2.0</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">export</span><span class=\"w\"> </span><span class=\"n\">tcp</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>The implementation of the start-connect is in Go.</p>\n<p>How can I insert this interface tcp (which I created) into linker so that when main app calls start-connect ,my version is triggered. I have seen the wit-bindgen macro. Is that the way?<br>\nI tried this method <a href=\"https://docs.wasmtime.dev/api/wasmtime/component/bindgen_examples/_5_all_world_export_kinds/index.html\">https://docs.wasmtime.dev/api/wasmtime/component/bindgen_examples/_5_all_world_export_kinds/index.html</a><br>\nBut I don't know where to write the implementation of my exported interface. Also I want to implement it in Go which will be easier for my further steps.<br>\nOr should I convert my wrapper module into wasm and load it as component in my runner and insert it in linker or something ?</p>\n<p>Thanks</p>",
        "id": 494892111,
        "sender_full_name": "celine santosh",
        "timestamp": 1737398660
    },
    {
        "content": "<p>Yes, you want to run the wasmtime::component::bindgen! macro on your wit file, and use <code>with</code> to point all of the wasi implementations at the wasmtime_wasi crate's implementations</p>",
        "id": 494892802,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1737398915
    },
    {
        "content": "<p>see the <code>with</code> section in <a href=\"https://docs.rs/wasmtime/latest/wasmtime/component/macro.bindgen.html#options-reference\">https://docs.rs/wasmtime/latest/wasmtime/component/macro.bindgen.html#options-reference</a></p>",
        "id": 494892901,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1737398958
    },
    {
        "content": "<p>also, you dont want your <code>world wrapper</code> to export both <code>cli/run</code> and <code>tcp</code> unless you intend to require that all components in your world provide both of those exports, my interpretation of the above is you really just want your components to be invoked by the <code>start-connect</code> function</p>",
        "id": 494893131,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1737399054
    },
    {
        "content": "<p>(I cant offer any help with your components being written in go, i'm not up to speed on anything go related)</p>",
        "id": 494893191,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1737399078
    },
    {
        "content": "<p>Thanks a lot.<br>\nActually I want the main application to call my start-connect instead of wasi start-connect, so that I can redirect all the network calls to a monitor which checks for compliance , and then proceed with the normal wasi start-connect.<br>\nSo as the first step I have disabled the wasi start-connect from linker. <br>\nNext I will proceed with wit bindgen macro but I am confused where do I give the implementation of my start-connect?<br>\nEven in this example there are no implementations of <code>bytes-to-string</code> and duration-to-string in units interface.</p>",
        "id": 494896603,
        "sender_full_name": "celine santosh",
        "timestamp": 1737400518
    },
    {
        "content": "<p>by exposing your package's <code>export tcp</code> and not `wasi:cli/run\", your world is saying \"the only way to invoke this component is to call tcp start-connect\"</p>",
        "id": 494903163,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1737403334
    },
    {
        "content": "<p>if instead what you want is for components, when they want to create a tcp connection, to go through your interface and not the one exposed by wasi:sockets, you want to change your wit to say <code>import tcp</code>, because its available as an import function to the component, just like <code>import wasi:sockets/network</code> is making the wasi network functions available as imports.</p>",
        "id": 494903595,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1737403529
    },
    {
        "content": "<p>when you list <code>export tcp</code>, bindgen produces wrappers for a component that has an exported interface <code>tcp</code> and that interface has a function <code>start_connect</code>. when bindgen makes wrappers for <code>wasi:cli/run</code> it makes this struct Command with <a href=\"https://docs.rs/wasmtime-wasi/latest/wasmtime_wasi/bindings/struct.Command.html#method.wasi_cli_run\">https://docs.rs/wasmtime-wasi/latest/wasmtime_wasi/bindings/struct.Command.html#method.wasi_cli_run</a></p>",
        "id": 494903841,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1737403637
    },
    {
        "content": "<p>and the return value of <code>wasi_cli_run</code> has a function <a href=\"https://docs.rs/wasmtime-wasi/latest/wasmtime_wasi/bindings/exports/wasi/cli/run/struct.Guest.html\"><code>call_run</code></a> for the function named <code>run</code> inside that interface <code>run</code> (yes, repeated word makes it confusing)</p>",
        "id": 494903938,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1737403684
    },
    {
        "content": "<p>changing that to <code>import tcp</code> will mean bindgen produces a totally different kind of wrapper. instead it will make a <code>mod your_namespace { mod your_packagename { mod tcp { trait Host { fn start_connect(...) }, fn add_to_linker(...) } } }</code></p>",
        "id": 494904297,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1737403818
    },
    {
        "content": "<p>and then you can follow the example of wasmtime-wasi for how you author an impl of that Host trait, and then you call that generated add_to_linker function into the custom one you made above.</p>",
        "id": 494904405,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1737403870
    },
    {
        "content": "<p>when you said \"the implementation of start-connect is in go\" thats what made me think you wanted to call a component written in go.</p>",
        "id": 494904537,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1737403925
    },
    {
        "content": "<p>when your tcp.start-connect is an <code>import</code>, you need to provide an <code>impl Host</code> of that trait in Rust, so you'll either need to reimplement that start-connect go code in Rust, or call out to the go code by some other means, maybe with std::process::Command to call an external go executable? idk, i'm not a go person but theres no straightforward way to call between go and rust that i know of.</p>",
        "id": 494904814,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1737404045
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"253992\">Pat Hickey</span> <a href=\"#narrow/channel/206238-general/topic/Instrumenting.20wasi.20calls/near/494904405\">said</a>:</p>\n<blockquote>\n<p>and then you can follow the example of wasmtime-wasi for how you author an impl of that Host trait, and then you call that generated add_to_linker function into the custom one you made above.</p>\n</blockquote>\n<p>oh great, understood now.</p>",
        "id": 495125138,
        "sender_full_name": "celine santosh",
        "timestamp": 1737486065
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"253992\">Pat Hickey</span> <a href=\"#narrow/channel/206238-general/topic/Instrumenting.20wasi.20calls/near/494904814\">said</a>:</p>\n<blockquote>\n<p>when your tcp.start-connect is an <code>import</code>, you need to provide an <code>impl Host</code> of that trait in Rust, so you'll either need to reimplement that start-connect go code in Rust, or call out to the go code by some other means, maybe with std::process::Command to call an external go executable? idk, i'm not a go person but theres no straightforward way to call between go and rust that i know of.</p>\n</blockquote>\n<p>I have a monitor which is implemented in Go , so I need to call one function from my custom start-connect function which check compliance and then proceeds with wasi start-connect. <br>\nIf I load my monitor as a wasm component in <a href=\"http://runner.rs\">runner.rs</a> and retrieve the function I want to call, then I can call it from my custom start-connect function even if its in rust right?</p>",
        "id": 495125447,
        "sender_full_name": "celine santosh",
        "timestamp": 1737486169
    },
    {
        "content": "<p>My understanding is that both Rust (via <code>extern \"C\"</code>) and Go (via Cgo) can make use of the C ABI, allowing Rust and Go code to be linked statically or dynamically.  I have experience with the Rust side of that, but none with the Go side.  You'll probably want to research <a href=\"https://pkg.go.dev/cmd/cgo#hdr-C_references_to_Go\">using Cgo</a> and ask in a Go-specific forum if you have questions about that.</p>",
        "id": 495130868,
        "sender_full_name": "Joel Dice",
        "timestamp": 1737488242
    },
    {
        "content": "<p>oh okay , But I don't understand , we can actually make use of wasm's language agnostic feature right?<br>\nBy loading monitor as a wasm component and call its function from rust implementation. Isn't that possible?</p>",
        "id": 495132029,
        "sender_full_name": "celine santosh",
        "timestamp": 1737488704
    },
    {
        "content": "<p>It depends on which approach you plan to use.  In this thread, we've laid out three possible approaches (at least):</p>\n<ol>\n<li>Virtualize WASI using component composition</li>\n<li>Provide a mix of <code>wasmtime-wasi</code> and custom WASI functions in the host embedding when populating the <code>Linker</code> with host functions.</li>\n<li>Fork <code>wasmtime-wasi</code> and add your instrumentation to it.</li>\n</ol>\n<p>Of those approaches, only #1 involves Wasm composition, whereas my understanding was that you are planning to use either #2 or #3.</p>\n<p>Perhaps you're proposing #2 or #3 but also recursively loading another component inside the host function?  If so, yes, that could work.  You'd just need to make sure you're using a separate <code>Store</code> for the instrumentation component.</p>",
        "id": 495133243,
        "sender_full_name": "Joel Dice",
        "timestamp": 1737489167
    },
    {
        "content": "<p>Thanks<br>\nRight now I am trying out #2. <br>\nSo I think it would be easier to load monitor as a component .</p>\n<p>I was facing errors in <a href=\"http://runner.rs\">runner.rs</a> Can anyone please help me in this </p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">add_to_linker_without_tcp</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">WasiView</span><span class=\"o\">&gt;</span><span class=\"p\">(</span>\n<span class=\"w\">    </span><span class=\"n\">linker</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kp\">&amp;</span><span class=\"nc\">mut</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"p\">::</span><span class=\"n\">component</span><span class=\"p\">::</span><span class=\"n\">Linker</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"p\">,</span>\n<span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">anyhow</span><span class=\"p\">::</span><span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"p\">()</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">type_annotate</span><span class=\"p\">::</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"o\">|</span><span class=\"n\">t</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">WasiImpl</span><span class=\"p\">(</span><span class=\"n\">t</span><span class=\"p\">));</span>\n\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">clocks</span><span class=\"p\">::</span><span class=\"n\">wall_clock</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">clocks</span><span class=\"p\">::</span><span class=\"n\">monotonic_clock</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">sync</span><span class=\"p\">::</span><span class=\"n\">filesystem</span><span class=\"p\">::</span><span class=\"n\">types</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">filesystem</span><span class=\"p\">::</span><span class=\"n\">preopens</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">io</span><span class=\"p\">::</span><span class=\"n\">error</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">sync</span><span class=\"p\">::</span><span class=\"n\">io</span><span class=\"p\">::</span><span class=\"n\">poll</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">sync</span><span class=\"p\">::</span><span class=\"n\">io</span><span class=\"p\">::</span><span class=\"n\">streams</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">random</span><span class=\"p\">::</span><span class=\"n\">random</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">random</span><span class=\"p\">::</span><span class=\"n\">insecure</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">random</span><span class=\"p\">::</span><span class=\"n\">insecure_seed</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">cli</span><span class=\"p\">::</span><span class=\"n\">exit</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">cli</span><span class=\"p\">::</span><span class=\"n\">environment</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">cli</span><span class=\"p\">::</span><span class=\"n\">stdin</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">cli</span><span class=\"p\">::</span><span class=\"n\">stdout</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">cli</span><span class=\"p\">::</span><span class=\"n\">stderr</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">cli</span><span class=\"p\">::</span><span class=\"n\">terminal_input</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">cli</span><span class=\"p\">::</span><span class=\"n\">terminal_output</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">cli</span><span class=\"p\">::</span><span class=\"n\">terminal_stdin</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">cli</span><span class=\"p\">::</span><span class=\"n\">terminal_stdout</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">cli</span><span class=\"p\">::</span><span class=\"n\">terminal_stderr</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"c1\">//wasmtime_wasi::bindings::sync::sockets::tcp::add_to_linker_get_host(l, closure)?;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">sockets</span><span class=\"p\">::</span><span class=\"n\">tcp_create_socket</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">sync</span><span class=\"p\">::</span><span class=\"n\">sockets</span><span class=\"p\">::</span><span class=\"n\">udp</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">sockets</span><span class=\"p\">::</span><span class=\"n\">udp_create_socket</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">sockets</span><span class=\"p\">::</span><span class=\"n\">instance_network</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">sockets</span><span class=\"p\">::</span><span class=\"n\">network</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">sockets</span><span class=\"p\">::</span><span class=\"n\">ip_name_lookup</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">Wrapper</span><span class=\"p\">::</span><span class=\"n\">add_to_linker</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"nb\">Ok</span><span class=\"p\">(())</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>I am not able to add the wrapper module which is generated by wit bindgen into the linker<br>\nI get error </p>\n<p><strong>error[E0271]</strong><strong>: expected <code>{closure@main.rs:74:41}</code> to be a closure that returns <code>&amp;mut _</code>, but it returns <code>WasiImpl&lt;&amp;mut T&gt;</code></strong></p>\n<p><strong>--&gt;</strong> src/main.rs:103:31</p>\n<p><strong>|</strong><br>\n<strong>103</strong> <strong>|</strong>     Wrapper::add_to_linker(l, closure)?;</p>\n<p><strong>|</strong>     <strong>----------------------</strong>    <strong>^^^^^^^</strong> <strong>expected <code>&amp;mut _</code>, found <code>WasiImpl&lt;&amp;mut T&gt;</code></strong></p>\n<p><strong>|</strong>     <strong>|</strong></p>\n<p><strong>|</strong>     <strong>required by a bound introduced by this call</strong></p>\n<p><strong>|</strong></p>\n<p><strong>=</strong> <strong>note</strong>: expected mutable reference <code>**&amp;mut _**</code></p>\n<p>found struct <code>**WasiImpl&lt;&amp;mut T&gt;**</code><br>\n<strong>note</strong>: required by a bound in <code>_::&lt;impl Wrapper&gt;::add_to_linker</code></p>",
        "id": 495531274,
        "sender_full_name": "celine santosh",
        "timestamp": 1737647481
    },
    {
        "content": "<p>Hello<br>\nPlease ignore the previous message.</p>\n<p>In my host embedding I have wit bindgen </p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">bindgen</span><span class=\"o\">!</span><span class=\"p\">({</span>\n<span class=\"w\">    </span><span class=\"n\">path</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s\">\"wit\"</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">world</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s\">\"wrapper\"</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">with</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"s\">\"wasi\"</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"p\">},</span>\n<span class=\"w\">    </span><span class=\"n\">require_store_data_send</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">true</span><span class=\"p\">,</span>\n<span class=\"p\">});</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">mwasi</span><span class=\"p\">::</span><span class=\"n\">sockets</span><span class=\"p\">::</span><span class=\"n\">tcp</span><span class=\"p\">::</span><span class=\"n\">Host</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">MyState</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">     </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">start_connect</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">network</span><span class=\"p\">:</span><span class=\"nc\">Resource</span><span class=\"o\">&lt;</span><span class=\"n\">Network</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">remote_address</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">IpSocketAddress</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">ErrorCode</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"fm\">println!</span><span class=\"p\">(</span><span class=\"s\">\"Intercepted TCP call: Printing from the monitor\"</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"fm\">println!</span><span class=\"p\">(</span><span class=\"s\">\"start-connect operation successful!\"</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"nb\">Ok</span><span class=\"p\">(())</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">add_to_linker_without_tcp</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">WasiView</span><span class=\"o\">&gt;</span><span class=\"p\">(</span>\n<span class=\"w\">    </span><span class=\"n\">linker</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kp\">&amp;</span><span class=\"nc\">mut</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"p\">::</span><span class=\"n\">component</span><span class=\"p\">::</span><span class=\"n\">Linker</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"p\">,</span>\n<span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">anyhow</span><span class=\"p\">::</span><span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"p\">()</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">l</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">type_annotate</span><span class=\"p\">::</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"o\">|</span><span class=\"n\">t</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">WasiImpl</span><span class=\"p\">(</span><span class=\"n\">t</span><span class=\"p\">));</span>\n<span class=\"w\">    </span><span class=\"c1\">//let closure = |state: &amp;mut T| state.ctx();</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">clocks</span><span class=\"p\">::</span><span class=\"n\">wall_clock</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">clocks</span><span class=\"p\">::</span><span class=\"n\">monotonic_clock</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">sync</span><span class=\"p\">::</span><span class=\"n\">filesystem</span><span class=\"p\">::</span><span class=\"n\">types</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">filesystem</span><span class=\"p\">::</span><span class=\"n\">preopens</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">io</span><span class=\"p\">::</span><span class=\"n\">error</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">sync</span><span class=\"p\">::</span><span class=\"n\">io</span><span class=\"p\">::</span><span class=\"n\">poll</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">sync</span><span class=\"p\">::</span><span class=\"n\">io</span><span class=\"p\">::</span><span class=\"n\">streams</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">random</span><span class=\"p\">::</span><span class=\"n\">random</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">random</span><span class=\"p\">::</span><span class=\"n\">insecure</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">random</span><span class=\"p\">::</span><span class=\"n\">insecure_seed</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">cli</span><span class=\"p\">::</span><span class=\"n\">exit</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">cli</span><span class=\"p\">::</span><span class=\"n\">environment</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">cli</span><span class=\"p\">::</span><span class=\"n\">stdin</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">cli</span><span class=\"p\">::</span><span class=\"n\">stdout</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">cli</span><span class=\"p\">::</span><span class=\"n\">stderr</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">cli</span><span class=\"p\">::</span><span class=\"n\">terminal_input</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">cli</span><span class=\"p\">::</span><span class=\"n\">terminal_output</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">cli</span><span class=\"p\">::</span><span class=\"n\">terminal_stdin</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">cli</span><span class=\"p\">::</span><span class=\"n\">terminal_stdout</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">cli</span><span class=\"p\">::</span><span class=\"n\">terminal_stderr</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">sockets</span><span class=\"p\">::</span><span class=\"n\">tcp_create_socket</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">sync</span><span class=\"p\">::</span><span class=\"n\">sockets</span><span class=\"p\">::</span><span class=\"n\">udp</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">sockets</span><span class=\"p\">::</span><span class=\"n\">udp_create_socket</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">sockets</span><span class=\"p\">::</span><span class=\"n\">instance_network</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">sockets</span><span class=\"p\">::</span><span class=\"n\">network</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">sockets</span><span class=\"p\">::</span><span class=\"n\">ip_name_lookup</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"o\">**</span><span class=\"n\">Wrapper</span><span class=\"p\">::</span><span class=\"n\">add_to_linker</span><span class=\"p\">(</span><span class=\"n\">l</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"n\">state</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kp\">&amp;</span><span class=\"nc\">mut</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span><span class=\"o\">**</span>\n<span class=\"w\">    </span><span class=\"nb\">Ok</span><span class=\"p\">(())</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>But why does this line <code>Wrapper::add_to_linker(l, |state: &amp;mut T| state)?;</code> give error <br>\n<strong>error[E0277]</strong><strong>: the trait bound <code>T: wasmtime_wasi::bindings::random::insecure_seed::Host</code> is not satisfied</strong></p>\n<p><strong>--&gt;</strong> src/main.rs:102:5</p>\n<p><strong>|</strong><br>\n<strong>102</strong> <strong>|</strong>     Wrapper::add_to_linker(l, |state: &amp;mut T| state)?;</p>\n<p><strong>|</strong>     <strong>^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</strong> <strong>the trait <code>wasmtime_wasi::bindings::random::insecure_seed::Host</code> is not implemented for <code>T</code></strong></p>\n<p><strong>|</strong><br>\n<strong>note</strong>: required by a bound in <code>_::&lt;impl Wrapper&gt;::add_to_linker</code></p>\n<p><strong>--&gt;</strong> src/main.rs:21:1</p>\n<p><strong>|</strong><br>\n<strong>21</strong>  <strong>|</strong> <strong>/</strong> bindgen!({<br>\n<strong>22</strong>  <strong>|</strong> <strong>|</strong>     path: \"wit\",<br>\n<strong>23</strong>  <strong>|</strong> <strong>|</strong>     world: \"wrapper\",<br>\n<strong>24</strong>  <strong>|</strong> <strong>|</strong>     with: {<br>\n<strong>...</strong>   <strong>|</strong><br>\n<strong>27</strong>  <strong>|</strong> <strong>|</strong>     require_store_data_send: true,<br>\n<strong>28</strong>  <strong>|</strong> <strong>|</strong> });</p>\n<p><strong>|</strong> <strong>|__^</strong> <strong>required by this bound in <code>_::&lt;impl Wrapper&gt;::add_to_linker</code></strong></p>\n<p><strong>=</strong> <strong>note</strong>: this error originates in the macro <code>bindgen</code> (in Nightly builds, run with -Z macro-backtrace for more info)<br>\n<strong>help</strong>: consider further restricting this bound</p>\n<p><strong>|</strong><br>\n<strong>70</strong>  <strong>|</strong> pub fn add_to_linker_without_tcp&lt;T: WasiView + wasmtime_wasi::bindings::random::insecure_seed::Host&gt;(</p>\n<p><strong>|</strong>                                              ++++++++++++++++++++++++++++++++++++++++++++++++++++++</p>\n<p>It gives 28 other errors saying each host trait not implemented.</p>\n<p>I have already given the <strong>with</strong> clause for wasmtime_wasi in the bindgen macro, so the host trait implementations are already specified then why am I getting this error ?</p>",
        "id": 495955039,
        "sender_full_name": "celine santosh",
        "timestamp": 1737887396
    },
    {
        "content": "<p>You might want to use <a href=\"https://crates.io/crates/cargo-expand\">cargo-expand</a> to examine the code generated by the <code>bindgen</code> macro, which might help explain what's going on.  The first thing I notice is that you're telling <code>bindgen</code> to use <code>wasmtime_wasi::bindings</code> for the entire <code>wasi</code> namespace, yet also providing an additional implementation of (part of) <code>wasi:sockets/tcp</code>, which seems like a contradiction.</p>\n<p>Would you mind posting a self-contained test case e.g. to GitHub which exhibits the issue you're seeing?  That would make this easier to debug.</p>",
        "id": 496140229,
        "sender_full_name": "Joel Dice",
        "timestamp": 1737989370
    }
]
[
    {
        "content": "<p>Hey all,</p>\n<p>I have been trying for a while to figure out how to implement a component in Rust that uses a resource; I have attached the relevant files.<br>\n<a href=\"/user_uploads/15107/El7C8FHubAtAahhs2iI-JRz4/field_db.wit\">field_db.wit</a><br>\n<a href=\"/user_uploads/15107/tBf7EfrfYQu1w1pt5QZJdIG3/lib.rs\">lib.rs</a><br>\n<a href=\"/user_uploads/15107/BawVM9bBeQXwJb64_OUluf0J/Cargo.toml\">Cargo.toml</a><br>\n<a href=\"/user_uploads/15107/8VjmYwdRSDtwKvqnts0AGpUX/expanded_51\">expanded_51</a></p>\n<p>I have tried a number of different things, but it seems that each thing I try, causes the compiler to direct me towards something different, in some cases contradictory; for instance, if I define the<code>get_iterator</code> function to return <code>FieldIterator</code>, it complains that it should be <code>Self::FieldIterator</code>.  If I then define it to be <code>Self::FieldIterator</code>, it complains that it expects it to be <code>FieldIterator</code>.</p>\n<p>Eventually, I used <code>cargo expand</code> so I could look at the generated code, but understanding that code is a bit beyond my current level of skill in Rust.  It seems like <code>FieldIterator</code> is already defined by the generated code, and that it acts on an implementation of <code>GuestFieldIterator</code>; should I be implementing that trait instead of trying to create <code>FieldIterator</code>?</p>\n<p>If anyone could offer assistance, or even better, an example of how to do something like this, it would be very helpful for me; I have been looking for examples but without much luck.</p>\n<p>Also, looking at issues in the <code>wit-bindgen</code> repository to try to find information or examples has led me to wonder how far along support for resources is; am I trying to use this too soon?</p>",
        "id": 571235457,
        "sender_full_name": "godotdot",
        "timestamp": 1769897847
    },
    {
        "content": "<p>You can’t use the generated binding type itself as the <code>Guest</code> resource implementation.</p>\n<p><code>type FieldIterator = crate::bindings::exports::...::FieldIterator</code> will not work because that <code>FieldIterator</code> is just the <em>generated interface</em>, not a concrete implementation.</p>\n<p>For WIT <code>resource</code>s, you need to:</p>\n<ol>\n<li>Define your own concrete struct that represents the resource state</li>\n<li>Implement the generated <code>crate::bindings::exports::...::FieldIterator</code> trait for that struct</li>\n<li>Assign that struct to <code>type FieldIterator</code> in your <code>Guest</code> impl</li>\n</ol>\n<p>For example:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">FieldIteratorImpl</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"c1\">// internal state here</span>\n<span class=\"p\">}</span>\n\n<span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"k\">crate</span><span class=\"p\">::</span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">exports</span><span class=\"p\">::</span><span class=\"o\">..</span><span class=\"p\">.::</span><span class=\"n\">FieldIterator</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">FieldIteratorImpl</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"c1\">// implement resource methods here</span>\n<span class=\"p\">}</span>\n\n<span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">Component</span><span class=\"p\">;</span>\n\n<span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">Guest</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">Component</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"k\">type</span><span class=\"w\"> </span><span class=\"nc\">FieldIterator</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">FieldIteratorImpl</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"c1\">// ...</span>\n<span class=\"p\">}</span>\n\n<span class=\"n\">export</span><span class=\"o\">!</span><span class=\"p\">(</span><span class=\"n\">Component</span><span class=\"p\">);</span>\n</code></pre></div>\n<p>In short:<br>\n<code>resource</code> types are <em>handles managed by the component</em>, not aliases to the generated binding types. The generated trait defines the interface; you must provide the backing implementation yourself.</p>",
        "id": 571253451,
        "sender_full_name": "ktz_alias",
        "timestamp": 1769919275
    },
    {
        "content": "<p>Thank you, this does clarify a few things.</p>\n<p>I am trying to follow this example, though, and hitting a snag when trying to implement <code>crate::...FieldIterator</code>.  The compiler states that it is a struct, not a trait, so it cannot be implemented.</p>\n<p>The only traits in the generated bindings appear to be:<br>\n<code>Guest</code>, <code>GuestFieldIterator</code>, and <code>WasmResource</code>; that being the case, am I right in thinking that the iterator trait I need to implement is <code>GuestFieldIterator</code>?</p>",
        "id": 571257442,
        "sender_full_name": "godotdot",
        "timestamp": 1769923275
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"875880\">@godotdot</span> </p>\n<blockquote>\n<p><code>crate::...FieldIterator</code>. The compiler states that it is a struct, not a trait, so it cannot be implemented.</p>\n</blockquote>\n<p>Sorry! I missed the example code.<br>\nit needs to fix using <code>GuestFieldIterator</code>.</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">GuestFieldIterator</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">FieldIteratorImpl</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"p\">}</span>\n</code></pre></div>",
        "id": 571258693,
        "sender_full_name": "ktz_alias",
        "timestamp": 1769924606
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"1001980\">@ktz_alias</span> No problem, thank you for confirming the trait I should be implementing.</p>\n<p>Though,  having spent a few more hours looking at the generated code and trying to get this to work, I am completely confused at this point.     <br>\n<br>\nThe generated code implements <code>FieldIterator</code> as a concrete type.     <br>\nIt implements <code>GuestFieldIterator</code> as a trait.     <br>\n<code>FieldIterator</code> uses <code>GuestFieldIterator</code>.     <br>\nThe <code>Guest</code> trait uses a <code>FieldIterator</code> type, but that type is required to implement the <code>GuestFieldIterator</code> type.      <br>\n<br>\nSo if I do something like:     <br>\n</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">GuestFieldIteratorStruct</span><span class=\"p\">;</span>\n<span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">GuestFieldIterator</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">GuestFieldIteratorStruct</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">   </span><span class=\"k\">unsafe</span><span class=\"w\"> </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">_resource_new</span><span class=\"p\">(</span><span class=\"n\">val</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"kt\">u8</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">u32</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">       </span><span class=\"mi\">12345</span>\n<span class=\"w\">   </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n\n<span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">GuestStruct</span><span class=\"p\">;</span>\n<span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">Guest</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">GuestStruct</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">   </span><span class=\"k\">type</span><span class=\"w\"> </span><span class=\"nc\">FieldIterator</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">GuestFieldIteratorStruct</span><span class=\"p\">;</span>\n\n<span class=\"w\">   </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">get_iterator</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">FieldIterator</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">   </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>The compiler complains that <code>FieldIterator</code> is not in scope for the <code>Guest</code> impl.     <br>\nIt then suggests either:                                                                                                     <br>\n1 - using <code>Self::FieldIterator</code>, i.e. implement <code>fn get_iterator -&gt; Self::FieldIterator</code>.               <br>\n2 - importing the concrete <code>FieldIterator</code> from the generated code.        <br>\n<br>\nIf I do 1, then it complains that it expected <code>FieldIterator</code>, and got <code>GuestFieldIteratorStruct</code>,     <br>\nand suggests that I use <code>FieldIterator</code>.     <br>\n<br>\nIf I do 2, then it complains that it needs me to return a <code>FieldIterator</code>; fair enough, that makes perfect sense.<br>\n<br>\nSo then I need to call <code>pub fn new&lt;T: GuestFieldIterator&gt;(val: T) -&gt; Self</code> and return the result.     <br>\nUnfortunately, it seems to me that takes a <code>GuestFieldIterator</code>, which does not implement <code>new</code>,       <br>\nso I can't create a new <code>GuestFieldIterator</code> as an argument to the concrete <code>FieldIterator::new()</code>.     <br>\n<br>\nI'm sure this is me being a complete newb to Rust and getting in over my head,     <br>\nbut I am really at a loss right now.</p>",
        "id": 571314651,
        "sender_full_name": "godotdot",
        "timestamp": 1769978663
    },
    {
        "content": "<p>The code is quite old and the instructions seem to be partially outdated, but I posted resource examples in many languages at <a href=\"https://github.com/cpetig/resource-demo\">https://github.com/cpetig/resource-demo</a> - perhaps this can give you some inspiration.</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/cpetig/resource-demo\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/e98fcccbf10d5a437ef2f538858591a9f1036c29/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f353332636162383030383063383161316231343234636563376232643033373730316564653566663238363434613261353232343365346464333439343736382f6370657469672f7265736f757263652d64656d6f&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/cpetig/resource-demo\" title=\"GitHub - cpetig/resource-demo: A demo showing WASM component model resources in various environments\">GitHub - cpetig/resource-demo: A demo showing WASM component model resources in various environments</a></div><div class=\"message_embed_description\">A demo showing WASM component model resources in various environments - cpetig/resource-demo</div></div></div>",
        "id": 571324020,
        "sender_full_name": "Christof Petig",
        "timestamp": 1769988686
    },
    {
        "content": "<p>Even if it's old, it may still be useful to me.<br>\nIf nothing else, it's already made me rethink my decision of having a <code>get_iterator</code> function rather than just using <code>constructor</code>; not sure why I did that at this point, but I should have considered that when I ran into issues due to  <code>GuestFieldIterator</code> not having a <code>new()</code>.</p>\n<p>Thank you for the examples.  If I have some questions about them later, do you mind if I ask?</p>",
        "id": 571328130,
        "sender_full_name": "godotdot",
        "timestamp": 1769992762
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"875880\">@godotdot</span> </p>\n<blockquote>\n<p>The compiler complains that <code>FieldIterator</code> is not in scope for the <code>Guest</code> impl.     <br>\nIt then suggests either:                                                                                                     <br>\n1 - using <code>Self::FieldIterator</code>, i.e. implement <code>fn get_iterator -&gt; Self::FieldIterator</code>.               <br>\n2 - importing the concrete <code>FieldIterator</code> from the generated code.</p>\n</blockquote>\n<p>Associated types are not brought into scope like generic type parameters.<br>\nThey always belong to a specific trait implementation, so Rust requires you<br>\nto qualify them explicitly.</p>\n<p><code>Self::FieldIterator</code> means “the <code>FieldIterator</code> associated type of this <code>impl Guest for GuestStruct</code>”.</p>",
        "id": 571344313,
        "sender_full_name": "ktz_alias",
        "timestamp": 1770005950
    },
    {
        "content": "<p>Ah, I see now.  Thank you for the explanation!</p>",
        "id": 571346647,
        "sender_full_name": "godotdot",
        "timestamp": 1770007545
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"875880\">godotdot</span> <a href=\"#narrow/channel/206238-general/topic/How.20to.20use.20a.20resource.20in.20a.20Rust.20component.3F/near/571328130\">said</a>:</p>\n<blockquote>\n<p>Thank you for the examples.  If I have some questions about them later, do you mind if I ask?</p>\n</blockquote>\n<p>I don't mind, feel free to ask.</p>",
        "id": 571346899,
        "sender_full_name": "Christof Petig",
        "timestamp": 1770007761
    }
]
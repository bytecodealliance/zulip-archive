[
    {
        "content": "<p>Hi guys, I try to call wasmtime C API to create multiple wasm instances and round robin to run them based on specified duration and then resume them. I think epoch based interruption can do this, but I am not sure. Does the C API now support what I want to do? I want to interrupt some instance and let another instance run, later on, I need to resume the previous interrupted instance, is this doable? Thank you very much.</p>",
        "id": 533162907,
        "sender_full_name": "lyuxiaosu",
        "timestamp": 1754506712
    },
    {
        "content": "<p>I  think with the <code>*_async</code> APIs of the C API you should be able to do this yeah</p>",
        "id": 533179947,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1754514630
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"253994\">@Alex Crichton</span> Thank you very much for the reply.  I saw most examples just terminate the interrupted wasm sandbox, not resume them, is there any example file showing how to resume the interrupted sandbox?</p>",
        "id": 533181796,
        "sender_full_name": "lyuxiaosu",
        "timestamp": 1754515533
    },
    {
        "content": "<p>The examples of async may be a bit light on details, but it should be possible to resume a suspended async function</p>",
        "id": 533181862,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1754515569
    },
    {
        "content": "<p>Thank you very much to confirm this,  I will see async APIs and async example file more carefully to figure this out <span aria-label=\"grinning face with smiling eyes\" class=\"emoji emoji-1f601\" role=\"img\" title=\"grinning face with smiling eyes\">:grinning_face_with_smiling_eyes:</span></p>",
        "id": 533182120,
        "sender_full_name": "lyuxiaosu",
        "timestamp": 1754515703
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"253994\">@Alex Crichton</span> , I wrote a test program with C API. I create an instance with ASYN and epoch interruption support. I initially call <code>wasmtime_context_epoch_deadline_async_yield_and_update(context, 1);</code> to set the deadline to current_epoch + 1.  Another thread will call <code>wasmtime_engine_increment_epoch</code> to increase the current epoch every 10 seconds. I loop call <code>wasmtime_call_future_poll</code>, then it returns false every 10 seconds, indicating the deadline setting and increasing current epoch works. However, within the loop calling <code>wasmtime_call_future_poll</code> at some point, like the counter equals to a specified number, I want to interrupt the instance <code>immediately</code>, I call <code>wasmtime_context_epoch_deadline_async_yield_and_update(context, 0);</code>, I thought this will trigger the instance yield immediately, however, it seems it doesn't work, it still triggers the yield every 10 seconds, not the one that I reset the deadline, is something I understood wrong or I missed? Thank you for your help</p>",
        "id": 534274078,
        "sender_full_name": "lyuxiaosu",
        "timestamp": 1755106240
    },
    {
        "content": "<p>ah yes that's expected, the only way to immediately interrupt an instance is to change the epoch, you can't change the epoch/yield counters while the instance is running (that's UB to do that from the C API)</p>",
        "id": 534275617,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1755106947
    },
    {
        "content": "<p>Thank you for your reply <span class=\"user-mention\" data-user-id=\"253994\">@Alex Crichton</span> . Then how I can let an instance yield immediately? When should I change the epoch? You said \"you can't change the epoch/yield counters while the instance is running\",  then after the <code>wasmtime_call_future_poll</code> return false, the instance is alive but pending, is it a \"running\" instance that you mean? Does that mean there is no way to let an running instance to yield immediately? Thank you for your help</p>\n<p>You said</p>",
        "id": 534283906,
        "sender_full_name": "lyuxiaosu",
        "timestamp": 1755110360
    },
    {
        "content": "<p>Ah, to clarify, once you've created the future computation you can't edit the store/instance at all. The future \"owns\" the store/instance at that time so you can't update the store-local yield counter (e.g. <code>wasmtime_context_*</code> methods). What you can do is increment the epoch counter in the engine from another thread, that's always safe to do.</p>\n<p>To force an instance to yield immediately while it's currently executing you'd have to previously arrange, before the execution, for the instance to yield at some epoch deadline (e.g. the <code>async_yield_and_update</code> method). Then to yield immediately you'd force the epoch to reach that point (e.g. increment it once or however many times necessary). That'll force the thread to yield and the poll will return \"not done\"</p>",
        "id": 534286197,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1755111274
    },
    {
        "content": "<p>Oh, thank you for the explanation. I want to do some real-time scheduling, that means we cannot plan in advance sometime, if a more urgent task comes in, I need to let some instance yield immediately and then run the new task. It seems the current C API cannot support this. Do I understand correctly?</p>",
        "id": 534287040,
        "sender_full_name": "lyuxiaosu",
        "timestamp": 1755111591
    },
    {
        "content": "<p>I'm not sure I fully understand, because if the store is configured to yield at every epoch then you could set it up to yield periodically and if something urgent comes in you do an early update of the epoch. On the yield you'd then determine whether to resume if nothing else needed priority or whether to resume.</p>\n<p>Basically I wouldn't say that the C API can't support this use case necessarily, but it may require subtle changes in how you model the problem</p>",
        "id": 534287319,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1755111682
    },
    {
        "content": "<p>\"and if something urgent comes in you do an early update of the epoch\", I used <code>wasmtime_context_epoch_deadline_async_yield_and_update(context, 0);</code> to update the deadline when I want to let an running instance yield in my test code , however, it doesn't work. The code is like this:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"c1\">// And call it!</span>\n<span class=\"w\">  </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">\"Entering infinite loop...</span><span class=\"se\">\\n</span><span class=\"s\">\"</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"n\">int</span><span class=\"w\"> </span><span class=\"n\">count</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"k\">while</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">!</span><span class=\"n\">wasmtime_call_future_poll</span><span class=\"p\">(</span><span class=\"n\">call_future</span><span class=\"p\">.</span><span class=\"n\">get</span><span class=\"p\">()))</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">count</span><span class=\"o\">++</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">count</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">      </span><span class=\"n\">wasmtime_engine_increment_epoch</span><span class=\"p\">(</span><span class=\"n\">engine</span><span class=\"p\">.</span><span class=\"n\">get</span><span class=\"p\">());</span>\n<span class=\"w\">      </span><span class=\"n\">wasmtime_context_epoch_deadline_async_yield_and_update</span><span class=\"p\">(</span><span class=\"n\">context</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">);</span>\n<span class=\"w\">      </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">\"let yield immediately</span><span class=\"se\">\\n</span><span class=\"s\">\"</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"w\">    </span><span class=\"n\">std</span><span class=\"p\">::</span><span class=\"n\">cout</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"s\">\"Yield, pending...\"</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"p\">::</span><span class=\"n\">endl</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"p\">}</span>\n<span class=\"w\">  </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">\"Excecution finished</span><span class=\"se\">\\n</span><span class=\"s\">\"</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>did I use wrong, it shouldn't be update the deadline within this loop calling <code>wasmtime_call_future_poll</code>?</p>",
        "id": 534288209,
        "sender_full_name": "lyuxiaosu",
        "timestamp": 1755111990
    },
    {
        "content": "<p>You might be able to fix this by swapping the increment/epoch_deadline lines. In general though while a future is running you can't call <code>wasmtime_context_*</code> functions as that's UB. If the epoch deadline is already 1 then incrementing the epoch should be all you need to make the future exit</p>",
        "id": 534289860,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1755112735
    },
    {
        "content": "<p>I tried to swap increment/epoch_deadline lines,  or even removed epoch deadline update but called  <code>wasmtime_engine_increment_epoch</code> multiple times, but it the same thing, not yield immediately but periodically yield at the previous setting interval. I paste my test code:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">template</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">typename</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">void</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"k\">fn</span><span class=\"p\">)(</span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">deleter</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"n\">void</span><span class=\"w\"> </span><span class=\"n\">operator</span><span class=\"p\">()(</span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">ptr</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"k\">fn</span><span class=\"p\">(</span><span class=\"n\">ptr</span><span class=\"p\">);</span><span class=\"w\"> </span><span class=\"p\">}</span>\n<span class=\"p\">};</span>\n<span class=\"n\">template</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">typename</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">void</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">*</span><span class=\"k\">fn</span><span class=\"p\">)(</span><span class=\"n\">T</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"o\">&gt;</span>\n<span class=\"n\">using</span><span class=\"w\"> </span><span class=\"n\">handle</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"p\">::</span><span class=\"n\">unique_ptr</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">deleter</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">fn</span><span class=\"o\">&gt;&gt;</span><span class=\"p\">;</span>\n\n<span class=\"k\">static</span><span class=\"w\"> </span><span class=\"n\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">helper</span><span class=\"p\">(</span><span class=\"n\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">_engine</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"n\">wasm_engine_t</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">engine</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">wasm_engine_t</span><span class=\"o\">*</span><span class=\"p\">)</span><span class=\"n\">_engine</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"k\">while</span><span class=\"p\">(</span><span class=\"kc\">true</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">timespec</span><span class=\"w\"> </span><span class=\"n\">sleep_dur</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">sleep_dur</span><span class=\"p\">.</span><span class=\"n\">tv_sec</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">sleep_dur</span><span class=\"p\">.</span><span class=\"n\">tv_nsec</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">\"sleep for 5 seconds</span><span class=\"se\">\\n</span><span class=\"s\">\"</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">nanosleep</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">sleep_dur</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">NULL</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">\"Sending an interrupt</span><span class=\"se\">\\n</span><span class=\"s\">\"</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_engine_increment_epoch</span><span class=\"p\">(</span><span class=\"n\">engine</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"p\">}</span>\n<span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n\n<span class=\"k\">static</span><span class=\"w\"> </span><span class=\"n\">void</span><span class=\"w\"> </span><span class=\"n\">spawn_interrupt</span><span class=\"p\">(</span><span class=\"n\">wasm_engine_t</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">engine</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"n\">pthread_t</span><span class=\"w\"> </span><span class=\"n\">child</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">int</span><span class=\"w\"> </span><span class=\"n\">rc</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">pthread_create</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">child</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">NULL</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">helper</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">engine</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"n\">assert</span><span class=\"p\">(</span><span class=\"n\">rc</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n<span class=\"p\">#</span><span class=\"n\">endif</span>\n\n<span class=\"k\">static</span><span class=\"w\"> </span><span class=\"n\">void</span><span class=\"w\"> </span><span class=\"n\">exit_with_error</span><span class=\"p\">(</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"kt\">char</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">message</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wasmtime_error_t</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">error</span><span class=\"p\">,</span>\n<span class=\"w\">                            </span><span class=\"n\">wasm_trap_t</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">trap</span><span class=\"p\">);</span>\n\n<span class=\"n\">handle</span><span class=\"o\">&lt;</span><span class=\"n\">wasm_engine_t</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wasm_engine_delete</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">create_engine</span><span class=\"p\">(</span><span class=\"n\">wasm_config_t</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">config</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"n\">assert</span><span class=\"p\">(</span><span class=\"n\">config</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"n\">nullptr</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"n\">wasmtime_config_async_support_set</span><span class=\"p\">(</span><span class=\"n\">config</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kc\">true</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"n\">wasmtime_config_epoch_interruption_set</span><span class=\"p\">(</span><span class=\"n\">config</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kc\">true</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"c1\">//wasmtime_config_consume_fuel_set(config, true);</span>\n<span class=\"w\">  </span><span class=\"n\">handle</span><span class=\"o\">&lt;</span><span class=\"n\">wasm_engine_t</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wasm_engine_delete</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">engine</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"c1\">// this takes ownership of config</span>\n<span class=\"w\">  </span><span class=\"n\">engine</span><span class=\"p\">.</span><span class=\"n\">reset</span><span class=\"p\">(</span><span class=\"n\">wasm_engine_new_with_config</span><span class=\"p\">(</span><span class=\"n\">config</span><span class=\"p\">));</span>\n<span class=\"w\">  </span><span class=\"n\">assert</span><span class=\"p\">(</span><span class=\"n\">engine</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">engine</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n\n<span class=\"n\">handle</span><span class=\"o\">&lt;</span><span class=\"n\">wasmtime_store_t</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wasmtime_store_delete</span><span class=\"o\">&gt;</span>\n<span class=\"n\">create_store</span><span class=\"p\">(</span><span class=\"n\">wasm_engine_t</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">engine</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"n\">handle</span><span class=\"o\">&lt;</span><span class=\"n\">wasmtime_store_t</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wasmtime_store_delete</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">store</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">reset</span><span class=\"p\">(</span><span class=\"n\">wasmtime_store_new</span><span class=\"p\">(</span><span class=\"n\">engine</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">nullptr</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">nullptr</span><span class=\"p\">));</span>\n<span class=\"w\">  </span><span class=\"n\">assert</span><span class=\"p\">(</span><span class=\"n\">store</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">store</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n\n<span class=\"n\">handle</span><span class=\"o\">&lt;</span><span class=\"n\">wasmtime_linker_t</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wasmtime_linker_delete</span><span class=\"o\">&gt;</span>\n<span class=\"n\">create_linker</span><span class=\"p\">(</span><span class=\"n\">wasm_engine_t</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">engine</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"n\">handle</span><span class=\"o\">&lt;</span><span class=\"n\">wasmtime_linker_t</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wasmtime_linker_delete</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">linker</span><span class=\"p\">.</span><span class=\"n\">reset</span><span class=\"p\">(</span><span class=\"n\">wasmtime_linker_new</span><span class=\"p\">(</span><span class=\"n\">engine</span><span class=\"p\">));</span>\n<span class=\"w\">  </span><span class=\"n\">assert</span><span class=\"p\">(</span><span class=\"n\">linker</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n\n<span class=\"n\">handle</span><span class=\"o\">&lt;</span><span class=\"n\">wasmtime_module_t</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wasmtime_module_delete</span><span class=\"o\">&gt;</span>\n<span class=\"n\">compile_wat_module_from_file</span><span class=\"p\">(</span><span class=\"n\">wasm_engine_t</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">engine</span><span class=\"p\">,</span>\n<span class=\"w\">                             </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"p\">::</span><span class=\"n\">string</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">filename</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"n\">std</span><span class=\"p\">::</span><span class=\"n\">ifstream</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"p\">(</span><span class=\"n\">filename</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"n\">std</span><span class=\"p\">::</span><span class=\"n\">stringstream</span><span class=\"w\"> </span><span class=\"n\">buffer</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">buffer</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"p\">.</span><span class=\"n\">rdbuf</span><span class=\"p\">();</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">t</span><span class=\"p\">.</span><span class=\"n\">bad</span><span class=\"p\">())</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">std</span><span class=\"p\">::</span><span class=\"n\">cerr</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"s\">\"error reading file: \"</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">filename</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"p\">::</span><span class=\"n\">endl</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">std</span><span class=\"p\">::</span><span class=\"n\">exit</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"p\">}</span>\n<span class=\"w\">  </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"p\">::</span><span class=\"n\">string</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">content</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">buffer</span><span class=\"p\">.</span><span class=\"kt\">str</span><span class=\"p\">();</span>\n<span class=\"w\">  </span><span class=\"n\">wasm_byte_vec_t</span><span class=\"w\"> </span><span class=\"n\">wasm_bytes</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">handle</span><span class=\"o\">&lt;</span><span class=\"n\">wasmtime_error_t</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wasmtime_error_delete</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"p\">{</span>\n<span class=\"w\">      </span><span class=\"n\">wasmtime_wat2wasm</span><span class=\"p\">(</span><span class=\"n\">content</span><span class=\"p\">.</span><span class=\"n\">data</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">content</span><span class=\"p\">.</span><span class=\"n\">size</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">wasm_bytes</span><span class=\"p\">)};</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">error</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">exit_with_error</span><span class=\"p\">(</span><span class=\"s\">\"failed to parse wat\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"p\">.</span><span class=\"n\">get</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">nullptr</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"p\">}</span>\n<span class=\"w\">  </span><span class=\"n\">wasmtime_module_t</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">mod_ptr</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">nullptr</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">error</span><span class=\"p\">.</span><span class=\"n\">reset</span><span class=\"p\">(</span><span class=\"n\">wasmtime_module_new</span><span class=\"p\">(</span><span class=\"n\">engine</span><span class=\"p\">,</span>\n<span class=\"w\">                                  </span><span class=\"n\">reinterpret_cast</span><span class=\"o\">&lt;</span><span class=\"n\">uint8_t</span><span class=\"w\"> </span><span class=\"o\">*&gt;</span><span class=\"p\">(</span><span class=\"n\">wasm_bytes</span><span class=\"p\">.</span><span class=\"n\">data</span><span class=\"p\">),</span>\n<span class=\"w\">                                  </span><span class=\"n\">wasm_bytes</span><span class=\"p\">.</span><span class=\"n\">size</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">mod_ptr</span><span class=\"p\">));</span>\n<span class=\"w\">  </span><span class=\"n\">wasm_byte_vec_delete</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">wasm_bytes</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"n\">handle</span><span class=\"o\">&lt;</span><span class=\"n\">wasmtime_module_t</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wasmtime_module_delete</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">mod</span><span class=\"p\">{</span><span class=\"n\">mod_ptr</span><span class=\"p\">};</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">!</span><span class=\"k\">mod</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">exit_with_error</span><span class=\"p\">(</span><span class=\"s\">\"failed to compile module\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"p\">.</span><span class=\"n\">get</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">nullptr</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"p\">}</span>\n<span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"k\">mod</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n\n<span class=\"n\">int</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"c1\">// Create a `wasm_store_t` with interrupts enabled</span>\n<span class=\"w\">  </span><span class=\"n\">wasm_config_t</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">config</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">wasm_config_new</span><span class=\"p\">();</span>\n<span class=\"w\">  </span><span class=\"n\">assert</span><span class=\"p\">(</span><span class=\"n\">config</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"n\">NULL</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"n\">handle</span><span class=\"o\">&lt;</span><span class=\"n\">wasmtime_error_t</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wasmtime_error_delete</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"p\">;</span>\n\n<span class=\"w\">  </span><span class=\"n\">auto</span><span class=\"w\"> </span><span class=\"n\">engine</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">create_engine</span><span class=\"p\">(</span><span class=\"n\">config</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"n\">assert</span><span class=\"p\">(</span><span class=\"n\">engine</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"n\">NULL</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"n\">auto</span><span class=\"w\"> </span><span class=\"n\">store</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">create_store</span><span class=\"p\">(</span><span class=\"n\">engine</span><span class=\"p\">.</span><span class=\"n\">get</span><span class=\"p\">());</span>\n<span class=\"w\">  </span><span class=\"n\">assert</span><span class=\"p\">(</span><span class=\"n\">store</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"n\">NULL</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"n\">wasmtime_context_t</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">context</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">wasmtime_store_context</span><span class=\"p\">(</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">get</span><span class=\"p\">());</span>\n\n<span class=\"w\">  </span><span class=\"c1\">// Configure the epoch deadline after which WebAssembly code will yield.</span>\n<span class=\"w\">  </span><span class=\"n\">wasmtime_context_epoch_deadline_async_yield_and_update</span><span class=\"p\">(</span><span class=\"n\">context</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">);</span>\n\n<span class=\"w\">  </span><span class=\"c1\">// Read our input file, which in this case is a wasm text file.</span>\n<span class=\"w\">  </span><span class=\"n\">auto</span><span class=\"w\"> </span><span class=\"n\">compiled_module</span><span class=\"w\"> </span><span class=\"o\">=</span>\n<span class=\"w\">      </span><span class=\"n\">compile_wat_module_from_file</span><span class=\"p\">(</span><span class=\"n\">engine</span><span class=\"p\">.</span><span class=\"n\">get</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"s\">\"examples/my_interrupt.wat\"</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"n\">auto</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">create_linker</span><span class=\"p\">(</span><span class=\"n\">engine</span><span class=\"p\">.</span><span class=\"n\">get</span><span class=\"p\">());</span>\n\n<span class=\"w\">  </span><span class=\"c1\">// Now instantiate our module using the linker.</span>\n<span class=\"w\">  </span><span class=\"n\">handle</span><span class=\"o\">&lt;</span><span class=\"n\">wasmtime_call_future_t</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wasmtime_call_future_delete</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">call_future</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">wasm_trap_t</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">trap_ptr</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">nullptr</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">wasmtime_error_t</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">error_ptr</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">nullptr</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">wasmtime_instance_t</span><span class=\"w\"> </span><span class=\"n\">instance</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">call_future</span><span class=\"p\">.</span><span class=\"n\">reset</span><span class=\"p\">(</span><span class=\"n\">wasmtime_linker_instantiate_async</span><span class=\"p\">(</span>\n<span class=\"w\">      </span><span class=\"n\">linker</span><span class=\"p\">.</span><span class=\"n\">get</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">context</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">compiled_module</span><span class=\"p\">.</span><span class=\"n\">get</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">instance</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">trap_ptr</span><span class=\"p\">,</span>\n<span class=\"w\">      </span><span class=\"o\">&amp;</span><span class=\"n\">error_ptr</span><span class=\"p\">));</span>\n<span class=\"w\">  </span><span class=\"k\">while</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">!</span><span class=\"n\">wasmtime_call_future_poll</span><span class=\"p\">(</span><span class=\"n\">call_future</span><span class=\"p\">.</span><span class=\"n\">get</span><span class=\"p\">()))</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">std</span><span class=\"p\">::</span><span class=\"n\">cout</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"s\">\"yielding instantiation!\"</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"p\">::</span><span class=\"n\">endl</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"p\">}</span>\n<span class=\"w\">  </span><span class=\"n\">error</span><span class=\"p\">.</span><span class=\"n\">reset</span><span class=\"p\">(</span><span class=\"n\">error_ptr</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"n\">handle</span><span class=\"o\">&lt;</span><span class=\"n\">wasm_trap_t</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wasm_trap_delete</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">trap</span><span class=\"p\">{</span><span class=\"n\">trap_ptr</span><span class=\"p\">};</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"o\">||</span><span class=\"w\"> </span><span class=\"n\">trap</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">exit_with_error</span><span class=\"p\">(</span><span class=\"s\">\"failed to instantiate module\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"p\">.</span><span class=\"n\">get</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">trap</span><span class=\"p\">.</span><span class=\"n\">get</span><span class=\"p\">());</span>\n<span class=\"w\">  </span><span class=\"p\">}</span>\n\n<span class=\"w\">  </span><span class=\"n\">call_future</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">nullptr</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">linker</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">nullptr</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"c1\">// Lookup our `run` export function</span>\n<span class=\"w\">  </span><span class=\"n\">wasmtime_extern_t</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"kt\">bool</span><span class=\"w\"> </span><span class=\"n\">ok</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">wasmtime_instance_export_get</span><span class=\"p\">(</span><span class=\"n\">context</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">instance</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">\"run\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">run</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"n\">assert</span><span class=\"p\">(</span><span class=\"n\">ok</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"n\">assert</span><span class=\"p\">(</span><span class=\"n\">run</span><span class=\"p\">.</span><span class=\"n\">kind</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">WASMTIME_EXTERN_FUNC</span><span class=\"p\">);</span>\n\n<span class=\"w\">  </span><span class=\"c1\">//get future</span>\n<span class=\"w\">  </span><span class=\"n\">std</span><span class=\"p\">::</span><span class=\"n\">array</span><span class=\"o\">&lt;</span><span class=\"n\">wasmtime_val_t</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">results</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">call_future</span><span class=\"p\">.</span><span class=\"n\">reset</span><span class=\"p\">(</span><span class=\"n\">wasmtime_func_call_async</span><span class=\"p\">(</span>\n<span class=\"w\">      </span><span class=\"n\">context</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">run</span><span class=\"p\">.</span><span class=\"n\">of</span><span class=\"p\">.</span><span class=\"n\">func</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">NULL</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span>\n<span class=\"w\">      </span><span class=\"n\">results</span><span class=\"p\">.</span><span class=\"n\">data</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">results</span><span class=\"p\">.</span><span class=\"n\">size</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">trap_ptr</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">error_ptr</span><span class=\"p\">));</span>\n\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">error_ptr</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">error</span><span class=\"p\">.</span><span class=\"n\">reset</span><span class=\"p\">(</span><span class=\"n\">error_ptr</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">exit_with_error</span><span class=\"p\">(</span><span class=\"s\">\"error during async call\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"p\">.</span><span class=\"n\">get</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">nullptr</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"p\">}</span>\n\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">trap_ptr</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">handle</span><span class=\"o\">&lt;</span><span class=\"n\">wasm_trap_t</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wasm_trap_delete</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">trap</span><span class=\"p\">{</span><span class=\"n\">trap_ptr</span><span class=\"p\">};</span>\n<span class=\"w\">    </span><span class=\"n\">exit_with_error</span><span class=\"p\">(</span><span class=\"s\">\"trap during async call\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">nullptr</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">trap</span><span class=\"p\">.</span><span class=\"n\">get</span><span class=\"p\">());</span>\n<span class=\"w\">  </span><span class=\"p\">}</span>\n<span class=\"w\">  </span><span class=\"c1\">// Spawn a thread to send us an interrupt after a period of time.</span>\n<span class=\"w\">  </span><span class=\"n\">spawn_interrupt</span><span class=\"p\">(</span><span class=\"n\">engine</span><span class=\"p\">.</span><span class=\"n\">get</span><span class=\"p\">());</span>\n\n<span class=\"w\">  </span><span class=\"c1\">// And call it!</span>\n<span class=\"w\">  </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">\"Entering infinite loop...</span><span class=\"se\">\\n</span><span class=\"s\">\"</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"n\">int</span><span class=\"w\"> </span><span class=\"n\">count</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"k\">while</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">!</span><span class=\"n\">wasmtime_call_future_poll</span><span class=\"p\">(</span><span class=\"n\">call_future</span><span class=\"p\">.</span><span class=\"n\">get</span><span class=\"p\">()))</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">count</span><span class=\"o\">++</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">count</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">      </span><span class=\"n\">wasmtime_engine_increment_epoch</span><span class=\"p\">(</span><span class=\"n\">engine</span><span class=\"p\">.</span><span class=\"n\">get</span><span class=\"p\">());</span>\n<span class=\"w\">      </span><span class=\"n\">wasmtime_engine_increment_epoch</span><span class=\"p\">(</span><span class=\"n\">engine</span><span class=\"p\">.</span><span class=\"n\">get</span><span class=\"p\">());</span>\n<span class=\"w\">      </span><span class=\"n\">wasmtime_engine_increment_epoch</span><span class=\"p\">(</span><span class=\"n\">engine</span><span class=\"p\">.</span><span class=\"n\">get</span><span class=\"p\">());</span>\n<span class=\"w\">      </span><span class=\"c1\">//wasmtime_context_epoch_deadline_async_yield_and_update(context, 0);</span>\n<span class=\"w\">      </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">\"let yield immediately</span><span class=\"se\">\\n</span><span class=\"s\">\"</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"w\">    </span><span class=\"n\">std</span><span class=\"p\">::</span><span class=\"n\">cout</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"s\">\"Yield, pending...\"</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"p\">::</span><span class=\"n\">endl</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"p\">}</span>\n<span class=\"w\">  </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">\"Excecution finished</span><span class=\"se\">\\n</span><span class=\"s\">\"</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n\n<span class=\"k\">static</span><span class=\"w\"> </span><span class=\"n\">void</span><span class=\"w\"> </span><span class=\"n\">exit_with_error</span><span class=\"p\">(</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"kt\">char</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">message</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wasmtime_error_t</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">error</span><span class=\"p\">,</span>\n<span class=\"w\">                            </span><span class=\"n\">wasm_trap_t</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">trap</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"n\">fprintf</span><span class=\"p\">(</span><span class=\"n\">stderr</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">\"error: %s</span><span class=\"se\">\\n</span><span class=\"s\">\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">message</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"n\">wasm_byte_vec_t</span><span class=\"w\"> </span><span class=\"n\">error_message</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"n\">NULL</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_error_message</span><span class=\"p\">(</span><span class=\"n\">error</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">error_message</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_error_delete</span><span class=\"p\">(</span><span class=\"n\">error</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">wasm_trap_message</span><span class=\"p\">(</span><span class=\"n\">trap</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">error_message</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">wasm_trap_delete</span><span class=\"p\">(</span><span class=\"n\">trap</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"p\">}</span>\n<span class=\"w\">  </span><span class=\"n\">fprintf</span><span class=\"p\">(</span><span class=\"n\">stderr</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">\"%.*s</span><span class=\"se\">\\n</span><span class=\"s\">\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">int</span><span class=\"p\">)</span><span class=\"n\">error_message</span><span class=\"p\">.</span><span class=\"n\">size</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">error_message</span><span class=\"p\">.</span><span class=\"n\">data</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"n\">wasm_byte_vec_delete</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">error_message</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"n\">exit</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>the output is:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">Entering</span><span class=\"w\"> </span><span class=\"n\">infinite</span><span class=\"w\"> </span><span class=\"k\">loop</span><span class=\"o\">..</span><span class=\"p\">.</span>\n<span class=\"n\">sleep</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"n\">seconds</span>\n<span class=\"n\">Yield</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">pending</span><span class=\"o\">..</span><span class=\"p\">.</span>\n\n<span class=\"p\">(</span><span class=\"n\">after</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"n\">seconds</span><span class=\"p\">)</span>\n<span class=\"n\">Sending</span><span class=\"w\"> </span><span class=\"n\">an</span><span class=\"w\"> </span><span class=\"n\">interrupt</span>\n<span class=\"n\">sleep</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"n\">seconds</span>\n<span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"kr\">yield</span><span class=\"w\"> </span><span class=\"n\">immediately</span>\n<span class=\"n\">Yield</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">pending</span><span class=\"o\">..</span><span class=\"p\">.</span>\n\n<span class=\"p\">(</span><span class=\"n\">after</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"n\">seconds</span><span class=\"p\">)</span>\n<span class=\"n\">Sending</span><span class=\"w\"> </span><span class=\"n\">an</span><span class=\"w\"> </span><span class=\"n\">interrupt</span>\n<span class=\"n\">sleep</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"n\">seconds</span>\n<span class=\"n\">Yield</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">pending</span><span class=\"o\">..</span><span class=\"p\">.</span>\n\n<span class=\"o\">......</span><span class=\"n\">repeat</span>\n</code></pre></div>\n<p>is there any thing I used wrong?</p>",
        "id": 534293002,
        "sender_full_name": "lyuxiaosu",
        "timestamp": 1755114047
    },
    {
        "content": "<p>Ah ok I expected that to work but I see why it's not working now. The problem is that <a href=\"https://github.com/bytecodealliance/wasmtime/blob/e895dd928b9f37e51355a8d3d0dbb74db7e6793d/crates/wasmtime/src/runtime/store.rs#L2332-L2367\">in the implementation of the \"new epoch point\"</a> it yields before calculating the new epoch. That means that your increments during the yield don't end up doing anything because the next epoch point is calculated relative away from the current epoch on resumption.</p>\n<p>How best to solve this I'm not sure, but that's at least what's happening</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/blob/e895dd928b9f37e51355a8d3d0dbb74db7e6793d/crates/wasmtime/src/runtime/store.rs#L2332-L2367\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/cec05a2f8735c750aee68f0d97ecd4fa76deea97/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f303335613265316562313261366562616534353766666262323334626462646133616265636261626262386538333462643830636139363631323538363162382f62797465636f6465616c6c69616e63652f7761736d74696d65&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/blob/e895dd928b9f37e51355a8d3d0dbb74db7e6793d/crates/wasmtime/src/runtime/store.rs#L2332-L2367\" title=\"wasmtime/crates/wasmtime/src/runtime/store.rs at e895dd928b9f37e51355a8d3d0dbb74db7e6793d  bytecodealliance/wasmtime\">wasmtime/crates/wasmtime/src/runtime/store.rs at e895dd928b9f37e51355a8d3d0dbb74db7e6793d  bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">A lightweight WebAssembly runtime that is fast, secure, and standards-compliant - bytecodealliance/wasmtime</div></div></div>",
        "id": 534293994,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1755114471
    },
    {
        "content": "<p>OK, thank you very much to find out the root reason though I don't fully understand the reason and the rust code, but at least I know immediate yield cannot do at this point.</p>",
        "id": 534302479,
        "sender_full_name": "lyuxiaosu",
        "timestamp": 1755118327
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"253994\">@Alex Crichton</span> following up on this -- is it possible to do similar with the Rust async APIs (I need to drive the futures by hand if I want to have control over when to resume?)</p>\n<p>And, can I do this using the fuel approach or only epochs (I'm fine either way but trying to plan ahead a bit).<br>\nFor context I really, really loved the call_resumable in wasmi but I really, really love the components / canonical ABI in wasmtime -- would love to have my cake and eat it too lol</p>",
        "id": 534599894,
        "sender_full_name": "Miles R-L",
        "timestamp": 1755235227
    },
    {
        "content": "<p>Reading up on this: <a href=\"https://docs.rs/wasmtime/latest/wasmtime/struct.Config.html#method.async_support\">https://docs.rs/wasmtime/latest/wasmtime/struct.Config.html#method.async_support</a></p>\n<p>It seems like typically I would drive this with an actual async runtime, but I don't have to. The thing I'm not clear on is, is it really as simple as setting up periodic yields by fuel / epoch, and then polling whenever I'm okay with it doing another batch of work? Do I need a waker or other fancy stuff?</p>",
        "id": 534601464,
        "sender_full_name": "Miles R-L",
        "timestamp": 1755236671
    },
    {
        "content": "<p>If your guest needs to call back into the host (like with wasi) then those calls will also need to be async and if those calls use existing async libraries then you will probably need a fully functional async executor.</p>",
        "id": 534644025,
        "sender_full_name": "Lann Martin",
        "timestamp": 1755260723
    },
    {
        "content": "<p>Wasmtime doesn't have a perfect equivalent to <code>call_resumable</code> in wasmi but the async support should get you what you want. It looks like in wasmi a function can be \"interrupted\" either for running out of fuel or manually being raised in the host. In Wasmtime a function is \"interrupted\" when it async-yields which could happen for the same reasons. If in Wasmtime you want a host function to manually trigger an async point you could drain the remaining fuel before the next yield point with the store in the host function call.</p>\n<p>Both fuel and epochs can be used for async yield points. I think you can build everything necessary with the APIs in Wasmtime today, but if you find anything is missing please feel free to open an issue.</p>\n<blockquote>\n<p>If your guest needs to call back into the host (like with wasi) then those calls will also need to be async</p>\n</blockquote>\n<p>I'll note that this isn't necessary actually, when <code>async_support</code> is enabled in Wasmtime it's required that all entrypoints into wasm are async (e.g. <code>call_async</code>) but host functions can be synchronous, so there's no need to use an async runtime, you'll just have to call <code>poll</code> on the <code>call_async</code> future yourself</p>",
        "id": 534665091,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1755269105
    },
    {
        "content": "<p>Ah I was thinking <code>func_wrap</code> asserted !async too. Good to know!</p>",
        "id": 534668205,
        "sender_full_name": "Lann Martin",
        "timestamp": 1755270330
    },
    {
        "content": "<p>Thank you!! I ended up getting it working! <br>\n<a href=\"https://github.com/uberblah/wasm-wit-embedding-sample\">https://github.com/uberblah/wasm-wit-embedding-sample</a></p>\n<p>I am really loving it, and I'm going to start talking people's ears off to see what I can unlock with this. </p>\n<p>Tbh for several years I've been looking for an embeddable programming environment that can be fully sandboxed, stepped in fixed quantities and accept full, production programming languages and I'm pretty sure this is it :)</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/uberblah/wasm-wit-embedding-sample\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/df344ec84e5caaf23b6979c576bef1edeab1ead2/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f643664623431333461616234333431656661303065666463633932356163643265646461306339643761366538386139666362613863663435326333323766342f75626572626c61682f7761736d2d7769742d656d62656464696e672d73616d706c65&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/uberblah/wasm-wit-embedding-sample\" title=\"GitHub - uberblah/wasm-wit-embedding-sample: An example of WIT-defined interface used to host WASM in a Rust application\">GitHub - uberblah/wasm-wit-embedding-sample: An example of WIT-defined interface used to host WASM in a Rust application</a></div><div class=\"message_embed_description\">An example of WIT-defined interface used to host WASM in a Rust application - uberblah/wasm-wit-embedding-sample</div></div></div>",
        "id": 534738420,
        "sender_full_name": "Miles R-L",
        "timestamp": 1755319944
    }
]
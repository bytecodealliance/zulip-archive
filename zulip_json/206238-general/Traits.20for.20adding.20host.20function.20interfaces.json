[
    {
        "content": "<p>I'm involved in a project where we are building a bunch of different host interfaces that will ultimately all need to be linked into to a single Wasmtime runtime.  An idea that I've been toying with is to come up with a single trait that each crate will implement for its host interfaces, so that we can compose them all together without having to manually define views into the <code>Store&lt;T&gt;</code>'s <code>T</code>.</p>\n<p>I've been experimenting with a macro that lets you encapsulate all the additions to the runtime in a common trait implementation on the host interface's state to go in the <code>Store</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">#[derive(Default)]</span>\n<span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">CounterState</span><span class=\"p\">(</span><span class=\"kt\">i64</span><span class=\"p\">);</span>\n<span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">HostInterface</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">CounterState</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">link</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">HostInterfaceStateView</span><span class=\"o\">&lt;</span><span class=\"bp\">Self</span><span class=\"o\">&gt;&gt;</span><span class=\"p\">(</span><span class=\"n\">linker</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kp\">&amp;</span><span class=\"nc\">mut</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"p\">::</span><span class=\"n\">component</span><span class=\"p\">::</span><span class=\"n\">Linker</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"c1\">// Add host functions to the linker</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n\n<span class=\"cp\">#[derive(Default)]</span>\n<span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">StaticState</span><span class=\"p\">(</span><span class=\"kt\">i64</span><span class=\"p\">);</span>\n<span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">HostInterface</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">StaticState</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">link</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">HostInterfaceStateView</span><span class=\"o\">&lt;</span><span class=\"bp\">Self</span><span class=\"o\">&gt;&gt;</span><span class=\"p\">(</span><span class=\"n\">linker</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kp\">&amp;</span><span class=\"nc\">mut</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"p\">::</span><span class=\"n\">component</span><span class=\"p\">::</span><span class=\"n\">Linker</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"c1\">// Add host functions to the linker</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>Then you can compose them together:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">wasmtime_extensions</span><span class=\"o\">!</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">MiniState</span><span class=\"w\"> </span><span class=\"p\">(</span>\n<span class=\"w\">        </span><span class=\"n\">CounterState</span>\n<span class=\"w\">    </span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n\n<span class=\"n\">wasmtime_extensions</span><span class=\"o\">!</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">State</span><span class=\"w\"> </span><span class=\"p\">(</span>\n<span class=\"w\">        </span><span class=\"n\">MiniState</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"n\">StaticState</span>\n<span class=\"w\">    </span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>but also add them (edit: all at once) to a <code>Linker</code> with a single static method:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">State</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"nb\">Default</span><span class=\"p\">::</span><span class=\"n\">default</span><span class=\"p\">();</span>\n<span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">store</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"p\">::</span><span class=\"n\">Store</span><span class=\"p\">::</span><span class=\"n\">new</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">engine</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"p\">);</span>\n<span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"p\">::</span><span class=\"n\">component</span><span class=\"p\">::</span><span class=\"n\">Linker</span><span class=\"p\">::</span><span class=\"n\">new</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">engine</span><span class=\"p\">);</span>\n\n<span class=\"n\">State</span><span class=\"p\">::</span><span class=\"n\">link</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"p\">);</span>\n</code></pre></div>\n<p>But before I go down the rabbit-hole of solving some of its limitations (mainly dealing with configuration) and learning to tidy it up into a proc macro that can be <code>#[derive]</code>ed, is there something out there like this already that I've somehow missed, that would allow these host interfaces to be encapsulated and then aggregated together in a more-or-less tidy way in the same way that <code>wasmtime-wasi</code> does?</p>",
        "id": 573559308,
        "sender_full_name": "Lachlan Gunn",
        "timestamp": 1770911878
    },
    {
        "content": "<p>Or is this something that might be better done using <code>bindgen!</code> directly?</p>",
        "id": 573574979,
        "sender_full_name": "Lachlan Gunn",
        "timestamp": 1770915665
    },
    {
        "content": "<p>One piece of inspiration I might recommend here is <a href=\"https://github.com/spinframework/spin/tree/main/crates/factors\">Spin <code>Factor</code>s</a> which while I haven't heavily used them myself I feel have done a really good job of enabling separate crates to build various implementations to get relatively easily woven in at the end</p>",
        "id": 573604360,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1770924949
    },
    {
        "content": "<p>Thanks! I'll take a look</p>",
        "id": 573672055,
        "sender_full_name": "Lachlan Gunn",
        "timestamp": 1770963376
    },
    {
        "content": "<p>This looks great. Sadly it comes with a little bit of baggage from Spin that prevents it from being used as-is, but as you say, it looks like great inspiration, and I'm glad to have some confirmation that it's not a completely terrible idea. I had that doubt in my mind of _this seems obvious enough that if it were a good idea, then it would probably have been built into Wasmtime or some associated crate already_.</p>",
        "id": 573688521,
        "sender_full_name": "Lachlan Gunn",
        "timestamp": 1770971302
    }
]
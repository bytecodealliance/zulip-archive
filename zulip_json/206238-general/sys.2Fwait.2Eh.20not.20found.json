[
    {
        "content": "<p>I'm working on compiling fail-components/webtransport to WASM for use in the browser as server and client (using Direct Sockets <code>UDPSocket</code>). The original code was written to compile to Node.js Addon, not WASM or WASI. I got to 32% compiled before encounting Google's Protobuf including <code>sys/wait.h</code>. I'm already using wasi-threads. How to get around this?</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">cmake</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">DCMAKE_TOOLCHAIN_FILE</span><span class=\"o\">=</span><span class=\"cp\">$</span><span class=\"p\">{</span><span class=\"n\">WASI_SDK_PATH</span><span class=\"p\">}</span><span class=\"o\">/</span><span class=\"n\">share</span><span class=\"o\">/</span><span class=\"n\">cmake</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">sdk</span><span class=\"o\">-</span><span class=\"n\">pthread</span><span class=\"p\">.</span><span class=\"n\">cmake</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"o\">-</span><span class=\"n\">DCMAKE_LIBRARY_OUTPUT_DIRECTORY</span><span class=\"o\">=</span><span class=\"s\">\"/media/user/1/webtransport/transports/http3-quiche/build-wasm/Release\"</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"o\">-</span><span class=\"n\">DCMAKE_JS_INC</span><span class=\"o\">=</span><span class=\"s\">\"/media/user/1/webtransport/node_modules/node-api-headers/include;/media/user/1/webtransport/node_modules/node-addon-api\"</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"o\">-</span><span class=\"n\">DCMAKE_MSVC_RUNTIME_LIBRARY</span><span class=\"o\">=</span><span class=\"s\">\"MultiThreaded$&lt;$&lt;CONFIG:Debug&gt;:Debug&gt;\"</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"o\">-</span><span class=\"n\">DCMAKE_JS_INC</span><span class=\"o\">=</span><span class=\"s\">\"/media/user/1/webtransport/node_modules/node-api-headers/include;/media/user/1/webtransport/node_modules/node-addon-api\"</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"o\">-</span><span class=\"n\">DCMAKE_JS_SRC</span><span class=\"o\">=</span><span class=\"s\">\"\"</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">DNODE_RUNTIME</span><span class=\"o\">=</span><span class=\"s\">\"node\"</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">DNODE_RUNTIMEVERSION</span><span class=\"o\">=</span><span class=\"s\">\"26.0.0-nightly20251023f819aec288\"</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"o\">-</span><span class=\"n\">DNODE_ARCH</span><span class=\"o\">=</span><span class=\"s\">\"x64\"</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">Dnapi_build_version</span><span class=\"o\">=</span><span class=\"s\">\"6\"</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">DCMAKE_JS_LIB</span><span class=\"o\">=</span><span class=\"s\">\"\"</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"o\">-</span><span class=\"n\">DCMAKE_CXX_FLAGS</span><span class=\"o\">=</span><span class=\"s\">\"-DBUILDING_NODE_EXTENSION -D_WASI_EMULATED_SIGNAL -lwasi-emulated-signal\"</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"o\">-</span><span class=\"n\">DCMAKE_JS_VERSION</span><span class=\"o\">=</span><span class=\"s\">\"7.3.1\"</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"o\">-</span><span class=\"n\">DCMAKE_BUILD_TYPE</span><span class=\"o\">=</span><span class=\"s\">\"Release\"</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"o\">--</span><span class=\"n\">no</span><span class=\"o\">-</span><span class=\"n\">warn</span><span class=\"o\">-</span><span class=\"n\">unused</span><span class=\"o\">-</span><span class=\"n\">cli</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">make</span>\n<span class=\"p\">#</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"p\">.</span>\n\n<span class=\"n\">clang</span><span class=\"o\">++</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">warning</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">lwasi</span><span class=\"o\">-</span><span class=\"n\">emulated</span><span class=\"o\">-</span><span class=\"n\">signal</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">linker</span><span class=\"o\">'</span><span class=\"w\"> </span><span class=\"nc\">input</span><span class=\"w\"> </span><span class=\"n\">unused</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"o\">-</span><span class=\"n\">Wunused</span><span class=\"o\">-</span><span class=\"n\">command</span><span class=\"o\">-</span><span class=\"n\">line</span><span class=\"o\">-</span><span class=\"n\">argument</span><span class=\"p\">]</span>\n<span class=\"p\">[</span><span class=\"w\"> </span><span class=\"mi\">32</span><span class=\"o\">%</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">Building</span><span class=\"w\"> </span><span class=\"n\">CXX</span><span class=\"w\"> </span><span class=\"n\">object</span><span class=\"w\"> </span><span class=\"n\">third_party</span><span class=\"o\">/</span><span class=\"n\">protobuf</span><span class=\"o\">/</span><span class=\"n\">CMakeFiles</span><span class=\"o\">/</span><span class=\"n\">libprotoc</span><span class=\"p\">.</span><span class=\"n\">dir</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">google</span><span class=\"o\">/</span><span class=\"n\">protobuf</span><span class=\"o\">/</span><span class=\"n\">compiler</span><span class=\"o\">/</span><span class=\"n\">subprocess</span><span class=\"p\">.</span><span class=\"n\">cc</span><span class=\"p\">.</span><span class=\"n\">obj</span>\n<span class=\"n\">clang</span><span class=\"o\">++</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">warning</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">lwasi</span><span class=\"o\">-</span><span class=\"n\">emulated</span><span class=\"o\">-</span><span class=\"n\">signal</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">linker</span><span class=\"o\">'</span><span class=\"w\"> </span><span class=\"nc\">input</span><span class=\"w\"> </span><span class=\"n\">unused</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"o\">-</span><span class=\"n\">Wunused</span><span class=\"o\">-</span><span class=\"n\">command</span><span class=\"o\">-</span><span class=\"n\">line</span><span class=\"o\">-</span><span class=\"n\">argument</span><span class=\"p\">]</span>\n<span class=\"o\">/</span><span class=\"n\">media</span><span class=\"o\">/</span><span class=\"n\">user</span><span class=\"o\">/</span><span class=\"mi\">1</span><span class=\"o\">/</span><span class=\"n\">webtransport</span><span class=\"o\">/</span><span class=\"n\">transports</span><span class=\"o\">/</span><span class=\"n\">http3</span><span class=\"o\">-</span><span class=\"n\">quiche</span><span class=\"o\">/</span><span class=\"n\">third_party</span><span class=\"o\">/</span><span class=\"n\">protobuf</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">google</span><span class=\"o\">/</span><span class=\"n\">protobuf</span><span class=\"o\">/</span><span class=\"n\">compiler</span><span class=\"o\">/</span><span class=\"n\">subprocess</span><span class=\"p\">.</span><span class=\"n\">cc</span><span class=\"p\">:</span><span class=\"mi\">43</span><span class=\"p\">:</span><span class=\"mi\">10</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">fatal</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">sys</span><span class=\"o\">/</span><span class=\"n\">wait</span><span class=\"p\">.</span><span class=\"n\">h</span><span class=\"o\">'</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">found</span>\n<span class=\"w\">   </span><span class=\"mi\">43</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"p\">#</span><span class=\"n\">include</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">sys</span><span class=\"o\">/</span><span class=\"n\">wait</span><span class=\"p\">.</span><span class=\"n\">h</span><span class=\"o\">&gt;</span>\n<span class=\"w\">      </span><span class=\"o\">|</span><span class=\"w\">          </span><span class=\"o\">^~~~~~~~~~~~</span>\n<span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"n\">generated</span><span class=\"p\">.</span>\n<span class=\"n\">make</span><span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"p\">]:</span><span class=\"w\"> </span><span class=\"o\">***</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">third_party</span><span class=\"o\">/</span><span class=\"n\">protobuf</span><span class=\"o\">/</span><span class=\"n\">CMakeFiles</span><span class=\"o\">/</span><span class=\"n\">libprotoc</span><span class=\"p\">.</span><span class=\"n\">dir</span><span class=\"o\">/</span><span class=\"n\">build</span><span class=\"p\">.</span><span class=\"n\">make</span><span class=\"p\">:</span><span class=\"mi\">1213</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">third_party</span><span class=\"o\">/</span><span class=\"n\">protobuf</span><span class=\"o\">/</span><span class=\"n\">CMakeFiles</span><span class=\"o\">/</span><span class=\"n\">libprotoc</span><span class=\"p\">.</span><span class=\"n\">dir</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">google</span><span class=\"o\">/</span><span class=\"n\">protobuf</span><span class=\"o\">/</span><span class=\"n\">compiler</span><span class=\"o\">/</span><span class=\"n\">subprocess</span><span class=\"p\">.</span><span class=\"n\">cc</span><span class=\"p\">.</span><span class=\"n\">obj</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">Error</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"n\">make</span><span class=\"p\">[</span><span class=\"mi\">1</span><span class=\"p\">]:</span><span class=\"w\"> </span><span class=\"o\">***</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">CMakeFiles</span><span class=\"o\">/</span><span class=\"n\">Makefile2</span><span class=\"p\">:</span><span class=\"mi\">5416</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">third_party</span><span class=\"o\">/</span><span class=\"n\">protobuf</span><span class=\"o\">/</span><span class=\"n\">CMakeFiles</span><span class=\"o\">/</span><span class=\"n\">libprotoc</span><span class=\"p\">.</span><span class=\"n\">dir</span><span class=\"o\">/</span><span class=\"n\">all</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">Error</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n<span class=\"n\">make</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"o\">***</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">Makefile</span><span class=\"p\">:</span><span class=\"mi\">156</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">all</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">Error</span><span class=\"w\"> </span><span class=\"mi\">2</span>\n</code></pre></div>",
        "id": 547626408,
        "sender_full_name": "guest271314",
        "timestamp": 1761711629
    },
    {
        "content": "<p>I believe this is intended, wasi-libc doesn't have a <code>sys/wait.h</code> header</p>",
        "id": 547651492,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1761725908
    },
    {
        "content": "<p>Any thoughts on approaches to proceed in spite of that?</p>",
        "id": 547711884,
        "sender_full_name": "guest271314",
        "timestamp": 1761743440
    },
    {
        "content": "<p>You'll need to patch the code somehow -- unfortunately the WASI platform doesn't have that header because the functionality therein (waitpid, etc) doesn't exist</p>",
        "id": 547720786,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1761745763
    },
    {
        "content": "<p>Hmm, this got a 'lil further along using Rust <a href=\"https://github.com/guest271314/quinn-wasm/tree/direct-sockets\">https://github.com/guest271314/quinn-wasm/tree/direct-sockets</a>.</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/guest271314/quinn-wasm/tree/direct-sockets\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/b0fc5d944a9345fe443c149823537fb482b28623/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f353034346537616431383435373362636464333838616636373161333863363331633337613762643534343066326333646532346466396535636531613934662f67756573743237313331342f7175696e6e2d7761736d&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/guest271314/quinn-wasm/tree/direct-sockets\" title=\"GitHub - guest271314/quinn-wasm at direct-sockets\">GitHub - guest271314/quinn-wasm at direct-sockets</a></div><div class=\"message_embed_description\">Contribute to guest271314/quinn-wasm development by creating an account on GitHub.</div></div></div>",
        "id": 547722983,
        "sender_full_name": "guest271314",
        "timestamp": 1761746227
    },
    {
        "content": "<p>From the maintainer, modification of this in CMakeLists.txt targeting WASM/WASI might do something.</p>\n<p>I don't know CMake functions, and what to substitute for WASI-SDK</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">IF</span><span class=\"p\">(</span><span class=\"n\">APPLE</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"n\">set_target_properties</span><span class=\"p\">(</span><span class=\"n\">protoc</span><span class=\"w\"> </span><span class=\"n\">libprotoc</span><span class=\"w\"> </span><span class=\"n\">libprotobuf</span><span class=\"w\"> </span><span class=\"n\">PROPERTIES</span><span class=\"w\"> </span><span class=\"n\">OSX_ARCHITECTURES</span><span class=\"w\"> </span><span class=\"s\">\"arm64;x86_64\"</span><span class=\"w\"> </span><span class=\"n\">CACHE</span><span class=\"w\"> </span><span class=\"n\">STRING</span><span class=\"w\"> </span><span class=\"s\">\"Build architectures for Mac OS X\"</span><span class=\"w\"> </span><span class=\"n\">FORCE</span><span class=\"w\"> </span><span class=\"p\">)</span>\n<span class=\"n\">ENDIF</span><span class=\"p\">(</span><span class=\"n\">APPLE</span><span class=\"p\">)</span>\n</code></pre></div>",
        "id": 548265943,
        "sender_full_name": "guest271314",
        "timestamp": 1761961452
    }
]
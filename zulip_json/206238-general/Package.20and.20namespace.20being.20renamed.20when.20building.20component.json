[
    {
        "content": "<p>Hi everyone,</p>\n<p>I am facing a weird issue and I'm not quite sure what the relevant tool is -- whether JCO, wkg, warg, etc.</p>\n<p>I am trying to <code>wkg wit fetch</code> a package that was published to a warg registry that I am self-hosting. The package is called <code>example:hello</code>, version 0.1.0. Here's the WIT:</p>\n<div class=\"codehilite\" data-code-language=\"wit\"><pre><span></span><code>package example:hello@0.1.0;\n\ninterface greeting {\n  greet: func(name: string);\n}\n\nworld hello {\n  export greeting;\n}\n</code></pre></div>\n<p>I am building this with JCO:</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>jco<span class=\"w\"> </span>componentize<span class=\"w\"> </span>hello.js<span class=\"w\"> </span>--wit<span class=\"w\"> </span>wit/<span class=\"w\"> </span>--world-name<span class=\"w\"> </span>hello<span class=\"w\"> </span>--out<span class=\"w\"> </span>hello.wasm\n</code></pre></div>\n<p>Here's the <code>hello.js</code> file:</p>\n<div class=\"codehilite\" data-code-language=\"JavaScript\"><pre><span></span><code><span class=\"k\">export</span><span class=\"w\"> </span><span class=\"kd\">const</span><span class=\"w\"> </span><span class=\"nx\">greet</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nx\">name</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">=&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"nx\">console</span><span class=\"p\">.</span><span class=\"nx\">log</span><span class=\"p\">(</span><span class=\"sb\">`hello </span><span class=\"si\">${</span><span class=\"nx\">name</span><span class=\"si\">}</span><span class=\"sb\">!`</span><span class=\"p\">);</span>\n<span class=\"p\">};</span>\n\n<span class=\"k\">export</span><span class=\"w\"> </span><span class=\"kd\">const</span><span class=\"w\"> </span><span class=\"nx\">greeting</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"nx\">greet</span><span class=\"p\">,</span>\n<span class=\"p\">};</span>\n</code></pre></div>\n<p>It compiles seemingly correctly, and I can use this as a dynamic library if I import it with wasmtime and pass my local <code>.wit</code> file.</p>\n<p>The problem is that I can't fetch the <code>.wit</code> file with <code>wkg wit fetch</code>. I am trying to fetch it from this other component's <code>.wit</code>:</p>\n<div class=\"codehilite\" data-code-language=\"wit\"><pre><span></span><code>package example:component;\n\nworld a-whole-new-world {\n    import example:hello/greeting@0.1.0;\n\n    export add: func(x: s32, y: s32) -&gt; s32;\n}\n</code></pre></div>\n<p>But when I run <code>wkg wit fetch</code>, I get this error:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">Error</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">merge</span><span class=\"w\"> </span><span class=\"n\">package</span><span class=\"w\"> </span><span class=\"n\">from</span><span class=\"w\"> </span><span class=\"n\">directory</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"o\">/</span><span class=\"n\">project</span><span class=\"o\">-</span><span class=\"n\">path</span><span class=\"o\">/</span><span class=\"n\">wit</span><span class=\"err\">`</span>\n\n<span class=\"n\">Caused</span><span class=\"w\"> </span><span class=\"n\">by</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"nc\">package</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">example</span><span class=\"p\">:</span><span class=\"nc\">hello</span><span class=\"o\">@</span><span class=\"mf\">0.1.0</span><span class=\"o\">'</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">found</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"n\">known</span><span class=\"w\"> </span><span class=\"n\">packages</span><span class=\"p\">:</span>\n<span class=\"w\">        </span><span class=\"nc\">root</span><span class=\"p\">:</span><span class=\"nc\">component</span>\n\n<span class=\"w\">         </span><span class=\"o\">-</span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">project</span><span class=\"o\">-</span><span class=\"n\">path</span><span class=\"o\">/</span><span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">component</span><span class=\"p\">.</span><span class=\"n\">wit</span><span class=\"p\">:</span><span class=\"mi\">8</span><span class=\"p\">:</span><span class=\"mi\">12</span>\n<span class=\"w\">          </span><span class=\"o\">|</span>\n<span class=\"w\">        </span><span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">     </span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"n\">example</span><span class=\"p\">:</span><span class=\"nc\">hello</span><span class=\"o\">/</span><span class=\"n\">greeting</span><span class=\"o\">@</span><span class=\"mf\">0.1.0</span><span class=\"p\">;</span>\n<span class=\"w\">          </span><span class=\"o\">|</span><span class=\"w\">            </span><span class=\"o\">^------------</span>\n</code></pre></div>\n<p>So <code>root:component</code> is a known package, but not <code>example:component</code>.</p>\n<p>I inspected the published package, <code>hello.wasm</code>, with <code>jco wit hello.wasm</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">package</span><span class=\"w\"> </span><span class=\"n\">root</span><span class=\"p\">:</span><span class=\"nc\">component</span><span class=\"p\">;</span>\n\n<span class=\"n\">world</span><span class=\"w\"> </span><span class=\"n\">root</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"p\">:</span><span class=\"nc\">io</span><span class=\"o\">/</span><span class=\"n\">poll</span><span class=\"o\">@</span><span class=\"mf\">0.2.3</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"p\">:</span><span class=\"nc\">clocks</span><span class=\"o\">/</span><span class=\"n\">monotonic</span><span class=\"o\">-</span><span class=\"n\">clock</span><span class=\"o\">@</span><span class=\"mf\">0.2.3</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"p\">:</span><span class=\"nc\">io</span><span class=\"o\">/</span><span class=\"n\">error</span><span class=\"o\">@</span><span class=\"mf\">0.2.3</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"p\">:</span><span class=\"nc\">io</span><span class=\"o\">/</span><span class=\"n\">streams</span><span class=\"o\">@</span><span class=\"mf\">0.2.3</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"p\">:</span><span class=\"nc\">http</span><span class=\"o\">/</span><span class=\"n\">types</span><span class=\"o\">@</span><span class=\"mf\">0.2.0</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"p\">:</span><span class=\"nc\">http</span><span class=\"o\">/</span><span class=\"n\">outgoing</span><span class=\"o\">-</span><span class=\"n\">handler</span><span class=\"o\">@</span><span class=\"mf\">0.2.0</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"p\">:</span><span class=\"nc\">cli</span><span class=\"o\">/</span><span class=\"n\">stdin</span><span class=\"o\">@</span><span class=\"mf\">0.2.3</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"p\">:</span><span class=\"nc\">cli</span><span class=\"o\">/</span><span class=\"n\">stdout</span><span class=\"o\">@</span><span class=\"mf\">0.2.3</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"p\">:</span><span class=\"nc\">cli</span><span class=\"o\">/</span><span class=\"n\">stderr</span><span class=\"o\">@</span><span class=\"mf\">0.2.3</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"p\">:</span><span class=\"nc\">cli</span><span class=\"o\">/</span><span class=\"n\">terminal</span><span class=\"o\">-</span><span class=\"n\">input</span><span class=\"o\">@</span><span class=\"mf\">0.2.3</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"p\">:</span><span class=\"nc\">cli</span><span class=\"o\">/</span><span class=\"n\">terminal</span><span class=\"o\">-</span><span class=\"n\">output</span><span class=\"o\">@</span><span class=\"mf\">0.2.3</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"p\">:</span><span class=\"nc\">cli</span><span class=\"o\">/</span><span class=\"n\">terminal</span><span class=\"o\">-</span><span class=\"n\">stdin</span><span class=\"o\">@</span><span class=\"mf\">0.2.3</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"p\">:</span><span class=\"nc\">cli</span><span class=\"o\">/</span><span class=\"n\">terminal</span><span class=\"o\">-</span><span class=\"n\">stdout</span><span class=\"o\">@</span><span class=\"mf\">0.2.3</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"p\">:</span><span class=\"nc\">cli</span><span class=\"o\">/</span><span class=\"n\">terminal</span><span class=\"o\">-</span><span class=\"n\">stderr</span><span class=\"o\">@</span><span class=\"mf\">0.2.3</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"p\">:</span><span class=\"nc\">clocks</span><span class=\"o\">/</span><span class=\"n\">wall</span><span class=\"o\">-</span><span class=\"n\">clock</span><span class=\"o\">@</span><span class=\"mf\">0.2.3</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"p\">:</span><span class=\"nc\">filesystem</span><span class=\"o\">/</span><span class=\"n\">types</span><span class=\"o\">@</span><span class=\"mf\">0.2.3</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"p\">:</span><span class=\"nc\">filesystem</span><span class=\"o\">/</span><span class=\"n\">preopens</span><span class=\"o\">@</span><span class=\"mf\">0.2.3</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"p\">:</span><span class=\"nc\">random</span><span class=\"o\">/</span><span class=\"n\">random</span><span class=\"o\">@</span><span class=\"mf\">0.2.3</span><span class=\"p\">;</span>\n\n<span class=\"w\">  </span><span class=\"n\">export</span><span class=\"w\"> </span><span class=\"n\">example</span><span class=\"p\">:</span><span class=\"nc\">hello</span><span class=\"o\">/</span><span class=\"n\">greeting</span><span class=\"o\">@</span><span class=\"mf\">0.1.0</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>So it looks like the problem is that my package is being renamed to <code>root:component</code>, which then has a world and exports my package from that world. But I want to publish the package itself, not for it to be wrapped in another <code>root:component</code> package?</p>\n<p>I may be misunderstanding how packages work, not sure.</p>\n<p>btw I posted this same issue <a href=\"#narrow/channel/217126-wasmtime/topic/Warg.20Server.20.2B.20wkg.20wit.20build\">in the wasmtime channel</a> before I realised there were different channels (lol). Sorry for the duplicate.</p>",
        "id": 497593971,
        "sender_full_name": "Lorenzo",
        "timestamp": 1738651950
    },
    {
        "content": "<p>Hey glad you were able to get <code>jco</code> working and able to use the components your produced.</p>\n<p>As far as pushing your WIT up to a registry, did you make to use <code>wkg publish</code>? I'm thinking you might have used <code>wkg publish</code> on the built component, and as you've noticed when you build a component, the WITs are combined (and renamed) so that there is one \"root\" world.</p>\n<p>While you can use it however you'd want, I like to think of the ability to push a component to a registry to be for types-only components -- not components that are fully built with functionality as well (though of course the tooling will work with both. </p>\n<p>I think the idiomatic way to  right way to solve this is likely to use <code>wkg wit build</code> on your <code>wit/</code> directory and push <em>that</em> component, not the result of the build (which has one or more WITs unified into the <code>root</code>)</p>",
        "id": 497601252,
        "sender_full_name": "Victor Adossi",
        "timestamp": 1738655770
    }
]
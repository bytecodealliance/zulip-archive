[
    {
        "content": "<p>Hi!</p>\n<p>After upgrading Wasmtime to v41 (from v34), I started getting:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">thread</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">tokio</span><span class=\"o\">-</span><span class=\"n\">runtime</span><span class=\"o\">-</span><span class=\"n\">worker</span><span class=\"o\">'</span><span class=\"w\"> </span><span class=\"n\">panicked</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"o\">-</span><span class=\"mf\">41.0.3</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">runtime</span><span class=\"o\">/</span><span class=\"n\">component</span><span class=\"o\">/</span><span class=\"n\">concurrent</span><span class=\"p\">.</span><span class=\"n\">rs</span><span class=\"p\">:</span><span class=\"mi\">4384</span><span class=\"p\">:</span><span class=\"mi\">9</span>\n<span class=\"n\">assertion</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">self</span><span class=\"p\">.</span><span class=\"n\">threads</span><span class=\"p\">.</span><span class=\"n\">is_empty</span><span class=\"p\">()</span>\n</code></pre></div>\n<p>Worth noting that I reuse the store for a short period of time (10-20 calls) to reduce the overhead of instantiating components.</p>\n<p>What happens:</p>\n<ul>\n<li>We create an async call future (via <code>TypedFunc::call_async</code>).</li>\n<li>The future gets dropped before it’s ever polled.</li>\n<li><code>TaskId::host_future_dropped</code> called.</li>\n<li>Because the future was never polled, the call parameters were never lowered (<code>already_lowered_parameters == false</code>), or there is no params.</li>\n<li><code>Waitable::Guest(self.task).delete_from(...)</code> called and  it asserts that the task has no guest threads (<code>self.threads.is_empty()</code>), and that assertion fails, causing the panic.</li>\n</ul>\n<p>Reproduce: <a href=\"https://github.com/bmartynov/wasmtime-threads-assert\">https://github.com/bmartynov/wasmtime-threads-assert</a> (cargo run)</p>",
        "id": 574438798,
        "sender_full_name": "Boris",
        "timestamp": 1771397485
    },
    {
        "content": "<p>Thanks for reporting this!  Have you tried running the same test using the <code>main</code> branch of Wasmtime?  We've been doing a lot of work related to that code recently.</p>",
        "id": 574518029,
        "sender_full_name": "Joel Dice",
        "timestamp": 1771424045
    },
    {
        "content": "<p>No, will try soon, thanks.</p>\n<p>For now I just disabled <code>component-model-async</code> feature</p>",
        "id": 574518484,
        "sender_full_name": "Boris",
        "timestamp": 1771424159
    },
    {
        "content": "<p>It doesn’t reproduce on the main branch(bbfcd588641e7ce0f69b3627d7eed69a57af67cf)</p>",
        "id": 574578086,
        "sender_full_name": "Boris",
        "timestamp": 1771439493
    }
]
[
    {
        "content": "<p>I have a simple wit world with a single async function:</p>\n<div class=\"codehilite\" data-code-language=\"wit\"><pre><span></span><code>package component:df@0.1.0;\n\ninterface df-interface {\n    fromcsv: async func(path: string) -&gt; s64;\n}\n\nworld root {\n    export df-interface;\n}\n</code></pre></div>\n<p>In Rust I am attempting to implement the interface with this</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">mod</span><span class=\"w\"> </span><span class=\"nn\">bindings</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">wit_bindgen</span><span class=\"p\">::</span><span class=\"n\">generate</span><span class=\"o\">!</span><span class=\"p\">();</span>\n\n<span class=\"w\">    </span><span class=\"k\">use</span><span class=\"w\"> </span><span class=\"k\">super</span><span class=\"p\">::</span><span class=\"n\">Module</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">export</span><span class=\"o\">!</span><span class=\"p\">(</span><span class=\"n\">Module</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n\n\n<span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">Module</span><span class=\"p\">;</span>\n\n<span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">bindings</span><span class=\"p\">::</span><span class=\"n\">exports</span><span class=\"p\">::</span><span class=\"n\">component</span><span class=\"p\">::</span><span class=\"n\">df</span><span class=\"p\">::</span><span class=\"n\">df_interface</span><span class=\"p\">::</span><span class=\"n\">Guest</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">Module</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"k\">async</span><span class=\"w\"> </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">fromcsv</span><span class=\"p\">(</span><span class=\"n\">path</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nb\">String</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">i64</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"c1\">// Actual implementation doesn't matter</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>However when building the component with </p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">target</span><span class=\"o\">=</span><span class=\"n\">wasm32</span><span class=\"o\">-</span><span class=\"n\">wasip2</span>\n</code></pre></div>\n<p>I get a linking error</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">error</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">parse</span><span class=\"w\"> </span><span class=\"n\">core</span><span class=\"w\"> </span><span class=\"n\">wasm</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">componentization</span>\n\n<span class=\"w\">          </span><span class=\"n\">Caused</span><span class=\"w\"> </span><span class=\"n\">by</span><span class=\"p\">:</span>\n<span class=\"w\">              </span><span class=\"mi\">0</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">decoding</span><span class=\"w\"> </span><span class=\"n\">custom</span><span class=\"w\"> </span><span class=\"n\">section</span><span class=\"w\"> </span><span class=\"n\">component</span><span class=\"o\">-</span><span class=\"k\">type</span><span class=\"p\">:</span><span class=\"nc\">wit</span><span class=\"o\">-</span><span class=\"n\">bindgen</span><span class=\"p\">:</span><span class=\"mf\">0.49.0</span><span class=\"p\">:</span><span class=\"nc\">component</span><span class=\"p\">:</span><span class=\"nc\">df</span><span class=\"o\">@</span><span class=\"mf\">0.1.0</span><span class=\"p\">:</span><span class=\"nc\">root</span><span class=\"p\">:</span><span class=\"nc\">encoded</span><span class=\"w\"> </span><span class=\"n\">world</span>\n<span class=\"w\">              </span><span class=\"mi\">1</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">invalid</span><span class=\"w\"> </span><span class=\"n\">leading</span><span class=\"w\"> </span><span class=\"n\">byte</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mh\">0x43</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">component</span><span class=\"w\"> </span><span class=\"n\">defined</span><span class=\"w\"> </span><span class=\"k\">type</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">offset</span><span class=\"w\"> </span><span class=\"mh\">0x2f</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>Reading the spec I can see the <code>0x43</code> is the marker for an async function. If I remove the async aspect of the function everything builds but naturally I am not able to call async code in the implementation.</p>\n<p>Happy to file a bug report on the right repo wasn't sure if this was a <code>wasm-component-ld</code> issue or further upstream before linking.</p>",
        "id": 561982868,
        "sender_full_name": "Nathaniel Cook",
        "timestamp": 1764886078
    },
    {
        "content": "<p>You'll want to use the latest nightly toolchain or build the latest <code>wasm-component-ld</code> and pass <code>-Clinker=path/to/wasm-component-ld</code> to rustc (via <code>RUSTFLAGS</code> through Cargo) -- what you're seeing here is that the <code>wasm-component-ld</code> shipped with Rust stable doesn't understand the latest async stuff</p>",
        "id": 561983967,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1764886570
    },
    {
        "content": "<p>Ok great, I am on latest stable, will try nightly thanks</p>",
        "id": 561984054,
        "sender_full_name": "Nathaniel Cook",
        "timestamp": 1764886611
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"439345\">@Nathaniel Cook</span> This is a work around.  You can use <code>wasm-tools</code> to get around this issue:</p>\n<ol>\n<li>Compiling your code with the<code>wasm32-wasip1</code> target.</li>\n<li>Run <code>wasm-tools component new</code> to convert the the resulting module to <code>wasip3</code> component.<p>- You will need to pass the appropriate adapter for WASI-P3 using the <code>--adapt</code> option (e.g. <code>wasi_snapshot_preview1.reactor.wasi</code>, etc.).<br>\n  - Just be aware that adapter compatibility depends on the <code>wasm-tools</code> version youâ€™re using.</p>\n</li>\n</ol>",
        "id": 562017806,
        "sender_full_name": "ktz_alias",
        "timestamp": 1764908182
    },
    {
        "content": "<p>Thanks</p>",
        "id": 562019860,
        "sender_full_name": "Nathaniel Cook",
        "timestamp": 1764909753
    }
]
[
    {
        "content": "<p>Hello I have a very simple question about jco components. I have a simple wasm component compiled from the following js</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">export</span><span class=\"w\"> </span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"n\">handlerInterface</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">handleevent</span><span class=\"p\">(</span><span class=\"n\">event</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">event</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"p\">};</span>\n</code></pre></div>\n<p>using <code>jco componentize handler.js --wit ../component.wit -d all -o handler.wasm</code><br>\nwith the following wit</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">package</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"p\">:</span><span class=\"nc\">test</span><span class=\"p\">;</span>\n\n<span class=\"n\">interface</span><span class=\"w\"> </span><span class=\"n\">handler</span><span class=\"o\">-</span><span class=\"n\">interface</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">record</span><span class=\"w\"> </span><span class=\"n\">request</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"n\">uri</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">string</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n\n<span class=\"w\">    </span><span class=\"n\">handleevent</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">func</span><span class=\"p\">(</span><span class=\"n\">event</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">request</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">request</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n\n<span class=\"n\">world</span><span class=\"w\"> </span><span class=\"n\">handler</span><span class=\"o\">-</span><span class=\"n\">world</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">export</span><span class=\"w\"> </span><span class=\"n\">handler</span><span class=\"o\">-</span><span class=\"n\">interface</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>I'm using wasmtime to call the <code>handleevent</code> guest function on the component in an infinite loop. It seems that RES memory of the process is constantly increasing over time. Is this expected with components compiled with <code>jco</code>? I don't see the same memory usage using cargo-component for example. Maybe it's expected with a javascript runtime and JIT or whatnot, but it would seem weird to me? Any help appreciated.</p>\n<p>Small repro is here <a href=\"https://github.com/ludfjig/jco-vs-cargo-component-memory-usage\">https://github.com/ludfjig/jco-vs-cargo-component-memory-usage</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/ludfjig/jco-vs-cargo-component-memory-usage\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/508b75e3206043e81775104674fac1f58aa0da2a/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f666663613363313634306162363838333861613361373238386162633137316631653563343161366334383166333532623163386530323063316137373761392f6c7564666a69672f6a636f2d76732d636172676f2d636f6d706f6e656e742d6d656d6f72792d7573616765&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/ludfjig/jco-vs-cargo-component-memory-usage\" title=\"GitHub - ludfjig/jco-vs-cargo-component-memory-usage: Compares memory usage of jco vs cargo-component\">GitHub - ludfjig/jco-vs-cargo-component-memory-usage: Compares memory usage of jco vs cargo-component</a></div><div class=\"message_embed_description\">Compares memory usage of jco vs cargo-component. Contribute to ludfjig/jco-vs-cargo-component-memory-usage development by creating an account on GitHub.</div></div></div>",
        "id": 532187059,
        "sender_full_name": "Ludvig Liljenberg",
        "timestamp": 1754004818
    },
    {
        "content": "<p>Hey Ludvig, thank you for the repro. No, this is not expected behavior. Unfortunately, StarlingMonkey hasn't been thoroughly tested for long-running use cases, so it's entirely possible that we have a memory leak somewhere. I would start by ensuring you're using the latest <code>jco</code> version, as there were some memory-related fixes in the most recent StarlingMonkey release, and I will have a look at your example to see if I'm able to track the leak.</p>",
        "id": 532232442,
        "sender_full_name": "Tomasz Andrzejak",
        "timestamp": 1754028688
    },
    {
        "content": "<p>To provide additional context: I would also say it's normal to see memory usage fluctuations in JS components due to garbage collection. The GC will allow memory to accumulate temporarily before triggering a collection that should eventually bring memory usage down, but FWIU what you're observing is linear increase until oom?</p>",
        "id": 532239780,
        "sender_full_name": "Tomasz Andrzejak",
        "timestamp": 1754031780
    },
    {
        "content": "<p>Thanks for the reply. Indeed memory increases linearly with no signs of stabilizing. I tried most recent <code>jco</code> version as well, but unfortunately I'm still seeing it</p>",
        "id": 532347874,
        "sender_full_name": "Ludvig Liljenberg",
        "timestamp": 1754068633
    },
    {
        "content": "<p>Hey <span class=\"user-mention\" data-user-id=\"648901\">@Ludvig Liljenberg</span> would you mind filing an issue about this? The most appropriate place might be either componentize-js or StarlingMonkey , but I'd love to track this so that we can be sure it's fixed long-term. </p>\n<p>I mention this because I originally thought this might be a case of <a href=\"https://github.com/bytecodealliance/jco/issues/568\">this bug from Jco</a>, but it doesn't seem to be, so I'm thinking we should make sure it's tracked.</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/jco/issues/568\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/882f6f3d47f8693b7f3813831a4c30289c76285f/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f656131646365626139663863333631633839313037303231336263373330353066323063353066396461363261396633663266336434613137633332326235332f62797465636f6465616c6c69616e63652f6a636f2f6973737565732f353638&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/jco/issues/568\" title=\"jco componentize out of memory 路 Issue #568 路 bytecodealliance/jco\">jco componentize out of memory 路 Issue #568 路 bytecodealliance/jco</a></div><div class=\"message_embed_description\">Hey all, thanks for the cool project! I've been following various talks in the space for the last year and am really excited to be trying out some stuff! Background I'm working in a Rust codebase t...</div></div></div>",
        "id": 532687618,
        "sender_full_name": "Victor Adossi",
        "timestamp": 1754300160
    },
    {
        "content": "<p>This topic was moved to <a class=\"stream-topic\" data-stream-id=\"459697\" href=\"/#narrow/channel/459697-StarlingMonkey/topic/Continuous.20memory.20growth.20in.20jco.20component/with/532983620\">#StarlingMonkey &gt; Continuous memory growth in jco component</a> by <span class=\"user-mention silent\" data-user-id=\"253990\">fitzgen (he/him)</span>.</p>",
        "id": 532983621,
        "sender_full_name": "Notification Bot",
        "timestamp": 1754424737
    }
]
[
    {
        "content": "<p>Hey all <span aria-label=\"wave\" class=\"emoji emoji-1f44b\" role=\"img\" title=\"wave\">:wave:</span> </p>\n<p>I've been experimenting with <a href=\"https://github.com/dotnet/eShop\">https://github.com/dotnet/eShop</a> and the viability of compiling some of the microservices there to WASI. I couldn't quite get it working out of the box, but I did try and replicate one of the services to test WASI compatibility. </p>\n<p>I'm able to get it to build, but when I try and <code>wasmtime run</code> the component it drops a stacktrace regrading the mono runtime.</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"err\">➜</span><span class=\"w\"> </span><span class=\"n\">WASMTIME_BACKTRACE_DETAILS</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">Scli</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">Shttp</span><span class=\"w\"> </span><span class=\"n\">bin</span><span class=\"o\">/</span><span class=\"n\">Release</span><span class=\"o\">/</span><span class=\"n\">net10</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">wasm</span><span class=\"o\">/</span><span class=\"n\">publish</span><span class=\"o\">/</span><span class=\"n\">dotnet</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n<span class=\"o\">/</span><span class=\"n\">__w</span><span class=\"o\">/</span><span class=\"mi\">1</span><span class=\"o\">/</span><span class=\"n\">s</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">runtime</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">mono</span><span class=\"o\">/</span><span class=\"n\">mono</span><span class=\"o\">/</span><span class=\"n\">eglib</span><span class=\"o\">/</span><span class=\"n\">gmem</span><span class=\"p\">.</span><span class=\"n\">c</span><span class=\"p\">:</span><span class=\"mi\">134</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">disabled</span><span class=\"o\">&gt;</span>\n<span class=\"n\">Error</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">bin</span><span class=\"o\">/</span><span class=\"n\">Release</span><span class=\"o\">/</span><span class=\"n\">net10</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">wasm</span><span class=\"o\">/</span><span class=\"n\">publish</span><span class=\"o\">/</span><span class=\"n\">dotnet</span><span class=\"p\">.</span><span class=\"n\">wasm</span><span class=\"err\">`</span>\n\n<span class=\"n\">Caused</span><span class=\"w\"> </span><span class=\"n\">by</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"mi\">0</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">invoke</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">run</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">function</span>\n<span class=\"w\">    </span><span class=\"mi\">1</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">error</span><span class=\"w\"> </span><span class=\"k\">while</span><span class=\"w\"> </span><span class=\"n\">executing</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">wasm</span><span class=\"w\"> </span><span class=\"n\">backtrace</span><span class=\"p\">:</span>\n<span class=\"w\">           </span><span class=\"mi\">0</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mh\">0x295512</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">abort</span>\n<span class=\"w\">                           </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">wasisdk</span><span class=\"p\">:</span><span class=\"c1\">//v25.0/build/sysroot/wasi-libc-wasm32-wasip2/libc-bottom-half/sources/abort.c:5:5</span>\n<span class=\"w\">           </span><span class=\"mi\">1</span><span class=\"p\">:</span><span class=\"w\">  </span><span class=\"mh\">0x46613</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">monoeg_assert_abort</span>\n<span class=\"w\">                           </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">__w</span><span class=\"o\">/</span><span class=\"mi\">1</span><span class=\"o\">/</span><span class=\"n\">s</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">runtime</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">mono</span><span class=\"o\">/</span><span class=\"n\">mono</span><span class=\"o\">/</span><span class=\"n\">eglib</span><span class=\"o\">/</span><span class=\"n\">goutput</span><span class=\"p\">.</span><span class=\"n\">c</span><span class=\"p\">:</span><span class=\"mi\">57</span><span class=\"p\">:</span><span class=\"mi\">3</span>\n<span class=\"w\">                       </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">monoeg_log_default_handler</span>\n<span class=\"w\">                           </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">__w</span><span class=\"o\">/</span><span class=\"mi\">1</span><span class=\"o\">/</span><span class=\"n\">s</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">runtime</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">mono</span><span class=\"o\">/</span><span class=\"n\">mono</span><span class=\"o\">/</span><span class=\"n\">eglib</span><span class=\"o\">/</span><span class=\"n\">goutput</span><span class=\"p\">.</span><span class=\"n\">c</span><span class=\"p\">:</span><span class=\"mi\">399</span><span class=\"p\">:</span><span class=\"mi\">3</span>\n<span class=\"w\">           </span><span class=\"mi\">2</span><span class=\"p\">:</span><span class=\"w\">  </span><span class=\"mh\">0x4652a</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">monoeg_g_logstr</span>\n<span class=\"w\">                           </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">__w</span><span class=\"o\">/</span><span class=\"mi\">1</span><span class=\"o\">/</span><span class=\"n\">s</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">runtime</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">mono</span><span class=\"o\">/</span><span class=\"n\">mono</span><span class=\"o\">/</span><span class=\"n\">eglib</span><span class=\"o\">/</span><span class=\"n\">goutput</span><span class=\"p\">.</span><span class=\"n\">c</span><span class=\"p\">:</span><span class=\"mi\">151</span><span class=\"p\">:</span><span class=\"mi\">2</span>\n<span class=\"w\">                       </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">monoeg_g_logv_nofree</span>\n<span class=\"w\">                           </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">__w</span><span class=\"o\">/</span><span class=\"mi\">1</span><span class=\"o\">/</span><span class=\"n\">s</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">runtime</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">mono</span><span class=\"o\">/</span><span class=\"n\">mono</span><span class=\"o\">/</span><span class=\"n\">eglib</span><span class=\"o\">/</span><span class=\"n\">goutput</span><span class=\"p\">.</span><span class=\"n\">c</span><span class=\"p\">:</span><span class=\"mi\">166</span><span class=\"p\">:</span><span class=\"mi\">2</span>\n<span class=\"w\">           </span><span class=\"mi\">3</span><span class=\"p\">:</span><span class=\"w\">  </span><span class=\"mh\">0x4663f</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">monoeg_g_logv</span>\n<span class=\"w\">                           </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">__w</span><span class=\"o\">/</span><span class=\"mi\">1</span><span class=\"o\">/</span><span class=\"n\">s</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">runtime</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">mono</span><span class=\"o\">/</span><span class=\"n\">mono</span><span class=\"o\">/</span><span class=\"n\">eglib</span><span class=\"o\">/</span><span class=\"n\">goutput</span><span class=\"p\">.</span><span class=\"n\">c</span><span class=\"p\">:</span><span class=\"mi\">173</span><span class=\"p\">:</span><span class=\"mi\">10</span>\n<span class=\"w\">                       </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">monoeg_g_log</span>\n<span class=\"w\">                           </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">__w</span><span class=\"o\">/</span><span class=\"mi\">1</span><span class=\"o\">/</span><span class=\"n\">s</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">runtime</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">mono</span><span class=\"o\">/</span><span class=\"n\">mono</span><span class=\"o\">/</span><span class=\"n\">eglib</span><span class=\"o\">/</span><span class=\"n\">goutput</span><span class=\"p\">.</span><span class=\"n\">c</span><span class=\"p\">:</span><span class=\"mi\">182</span><span class=\"p\">:</span><span class=\"mi\">2</span>\n<span class=\"w\">           </span><span class=\"mi\">4</span><span class=\"p\">:</span><span class=\"w\">  </span><span class=\"mh\">0x4668d</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">monoeg_g_log_disabled</span>\n<span class=\"w\">                           </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">__w</span><span class=\"o\">/</span><span class=\"mi\">1</span><span class=\"o\">/</span><span class=\"n\">s</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">runtime</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">mono</span><span class=\"o\">/</span><span class=\"n\">mono</span><span class=\"o\">/</span><span class=\"n\">eglib</span><span class=\"o\">/</span><span class=\"n\">goutput</span><span class=\"p\">.</span><span class=\"n\">c</span><span class=\"p\">:</span><span class=\"mi\">189</span><span class=\"p\">:</span><span class=\"mi\">2</span>\n<span class=\"w\">           </span><span class=\"mi\">5</span><span class=\"p\">:</span><span class=\"w\">  </span><span class=\"mh\">0x4622f</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">monoeg_g_calloc</span>\n<span class=\"w\">                           </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">__w</span><span class=\"o\">/</span><span class=\"mi\">1</span><span class=\"o\">/</span><span class=\"n\">s</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">runtime</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">mono</span><span class=\"o\">/</span><span class=\"n\">mono</span><span class=\"o\">/</span><span class=\"n\">eglib</span><span class=\"o\">/</span><span class=\"n\">gmem</span><span class=\"p\">.</span><span class=\"n\">c</span><span class=\"p\">:</span><span class=\"mi\">134</span><span class=\"p\">:</span><span class=\"mi\">2</span>\n<span class=\"w\">           </span><span class=\"mi\">6</span><span class=\"p\">:</span><span class=\"w\">  </span><span class=\"mh\">0x46244</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">monoeg_malloc0</span>\n<span class=\"w\">                           </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">__w</span><span class=\"o\">/</span><span class=\"mi\">1</span><span class=\"o\">/</span><span class=\"n\">s</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">runtime</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">mono</span><span class=\"o\">/</span><span class=\"n\">mono</span><span class=\"o\">/</span><span class=\"n\">eglib</span><span class=\"o\">/</span><span class=\"n\">gmem</span><span class=\"p\">.</span><span class=\"n\">c</span><span class=\"p\">:</span><span class=\"mi\">138</span><span class=\"p\">:</span><span class=\"mi\">9</span>\n<span class=\"w\">           </span><span class=\"mi\">7</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mh\">0x13ad57</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">mono_jit_parse_options</span>\n<span class=\"w\">                           </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">__w</span><span class=\"o\">/</span><span class=\"mi\">1</span><span class=\"o\">/</span><span class=\"n\">s</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">runtime</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">mono</span><span class=\"o\">/</span><span class=\"n\">mono</span><span class=\"o\">/</span><span class=\"n\">mini</span><span class=\"o\">/</span><span class=\"n\">driver</span><span class=\"p\">.</span><span class=\"n\">c</span><span class=\"p\">:</span><span class=\"mi\">1759</span><span class=\"p\">:</span><span class=\"mi\">21</span>\n<span class=\"w\">           </span><span class=\"mi\">8</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mh\">0xc729</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">dotnet</span><span class=\"p\">.</span><span class=\"n\">wasm</span><span class=\"o\">!</span><span class=\"n\">main</span>\n<span class=\"w\">           </span><span class=\"mi\">9</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mh\">0x294f80</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">dotnet</span><span class=\"p\">.</span><span class=\"n\">wasm</span><span class=\"o\">!</span><span class=\"n\">__main_void</span>\n<span class=\"w\">          </span><span class=\"mi\">10</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mh\">0xaea7</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">_start</span>\n<span class=\"w\">                           </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">wasisdk</span><span class=\"p\">:</span><span class=\"c1\">//v25.0/build/sysroot/wasi-libc-wasm32-wasip2/libc-bottom-half/crt/crt1-command.c:43:13</span>\n<span class=\"w\">          </span><span class=\"mi\">11</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mh\">0xbd2937</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">wit</span><span class=\"o\">-</span><span class=\"n\">component</span><span class=\"p\">:</span><span class=\"nc\">adapter</span><span class=\"p\">:</span><span class=\"nc\">wasi_snapshot_preview1</span><span class=\"o\">!</span><span class=\"n\">wasi</span><span class=\"p\">:</span><span class=\"nc\">cli</span><span class=\"o\">/</span><span class=\"n\">run</span><span class=\"o\">@</span><span class=\"mf\">0.2.0</span><span class=\"p\">#</span><span class=\"n\">run</span>\n<span class=\"w\">    </span><span class=\"mi\">2</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">wasm</span><span class=\"w\"> </span><span class=\"n\">trap</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">wasm</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">unreachable</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">instruction</span><span class=\"w\"> </span><span class=\"n\">executed</span>\n</code></pre></div>\n<p>I'm not a C# expert, so would love guidance if I'm missing anything!</p>\n<p>Here's the diff / changes if that helps anyone, I compiled with the latest dotnet 10 preview: <a href=\"https://github.com/brooksmtownsend/eShop/compare/main...brooksmtownsend:eShop:feat/wasi?expand=1\">https://github.com/brooksmtownsend/eShop/compare/main...brooksmtownsend:eShop:feat/wasi?expand=1</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/dotnet/eShop\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/96efd8f4e83904aaf22c2698796323202eab65d4/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f613662643161333333363539623265326364306366643738646563326236343433646139333935626236333839386566393930663339376336393537373838382f646f746e65742f6553686f70&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/dotnet/eShop\" title=\"GitHub - dotnet/eShop: A reference .NET application implementing an eCommerce site\">GitHub - dotnet/eShop: A reference .NET application implementing an eCommerce site</a></div><div class=\"message_embed_description\">A reference .NET application implementing an eCommerce site - dotnet/eShop</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/brooksmtownsend/eShop/compare/main...brooksmtownsend:eShop:feat/wasi?expand=1\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/b0325d8356ffc7d92f465a6ec23030edc68dab29/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f333762343238343237323834626331326436666138333165393231313264623838363632373338323638663835373533353135643239343265383765346634392f62726f6f6b736d746f776e73656e642f6553686f70&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/brooksmtownsend/eShop/compare/main...brooksmtownsend:eShop:feat/wasi?expand=1\" title=\"Comparing main...feat/wasi · brooksmtownsend/eShop\">Comparing main...feat/wasi · brooksmtownsend/eShop</a></div><div class=\"message_embed_description\">A reference .NET application implementing an eCommerce site - Comparing main...feat/wasi · brooksmtownsend/eShop</div></div></div>",
        "id": 531388461,
        "sender_full_name": "Brooks Townsend",
        "timestamp": 1753713741
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"625613\">@James Sturtevant</span> if you have any thoughts....</p>",
        "id": 531388911,
        "sender_full_name": "Ralph",
        "timestamp": 1753713850
    },
    {
        "content": "<p>From the trace it is hitting an assert in a some default logger?  That could be an issue depending on what kind of IO it is doing.  Does mono have any environment variable to turn off logging completely?  Could also try NAOT to see if it is the same.</p>",
        "id": 531389523,
        "sender_full_name": "Scott Waye",
        "timestamp": 1753714019
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"471788\">@Pavel Šavara</span>  might also have an idea....</p>",
        "id": 531390859,
        "sender_full_name": "Ralph",
        "timestamp": 1753714399
    },
    {
        "content": "<p>this looks like OOM with <code>monoeg_malloc0</code> in the trace. </p>\n<p>WASI experiment is on pause on main (mono) repo. You can switch to NAOT_LLVM branch and perhaps get bit further. </p>\n<p>The eShop demo's next question would be pgsql connectivity, which depends on missing TLS. There is some work in progress. </p>\n<p>Overall, it's too early for such complex app.</p>",
        "id": 531395694,
        "sender_full_name": "Pavel Šavara",
        "timestamp": 1753715617
    },
    {
        "content": "<p>Yeah there's plenty of stuff in the eShop that would have trouble with Wasm at the moment. I was hoping to get just part of it working, didn't have an expectation of the postgres / LLM / rabbit MQ pieces quite yet!</p>",
        "id": 531397085,
        "sender_full_name": "Brooks Townsend",
        "timestamp": 1753715974
    },
    {
        "content": "<p>FWIW, James and I did a proof-of-concept SqlClient demo with <code>wasi-tls</code>; you might be able to hack something together for pgsql, too, but it would be demoware at this point rather than a supported project.</p>",
        "id": 531405681,
        "sender_full_name": "Joel Dice",
        "timestamp": 1753718413
    }
]
[
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"509936\">@Joel Dice</span> I've updated to the latest naot and witbind gen packages. Everything is compiling properly but I am not able to run the http example with wasmtime, I am getting.</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"n\">serve</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"err\">\\</span><span class=\"n\">bin</span><span class=\"err\">\\</span><span class=\"n\">Debug</span><span class=\"err\">\\</span><span class=\"n\">net8</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"err\">\\</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">wasm</span><span class=\"err\">\\</span><span class=\"n\">native</span><span class=\"err\">\\</span><span class=\"n\">MyApp</span><span class=\"p\">.</span><span class=\"n\">wasm</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">addr</span><span class=\"w\"> </span><span class=\"mf\">127.0.0.1</span><span class=\"p\">:</span><span class=\"mi\">3000</span>\n<span class=\"n\">Error</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">component</span><span class=\"w\"> </span><span class=\"n\">imports</span><span class=\"w\"> </span><span class=\"n\">instance</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">wasi</span><span class=\"p\">:</span><span class=\"nc\">cli</span><span class=\"o\">/</span><span class=\"n\">environment</span><span class=\"o\">@</span><span class=\"mf\">0.2.0</span><span class=\"err\">`</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">but</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">matching</span><span class=\"w\"> </span><span class=\"n\">implementation</span><span class=\"w\"> </span><span class=\"n\">was</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">found</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">linker</span>\n\n<span class=\"n\">Caused</span><span class=\"w\"> </span><span class=\"n\">by</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"mi\">0</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">instance</span><span class=\"w\"> </span><span class=\"n\">export</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">get</span><span class=\"o\">-</span><span class=\"n\">environment</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">wrong</span><span class=\"w\"> </span><span class=\"k\">type</span>\n<span class=\"w\">    </span><span class=\"mi\">1</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">function</span><span class=\"w\"> </span><span class=\"n\">implementation</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">missing</span>\n</code></pre></div>\n<p>Any ideas on what I am missing? I thought it might be the wit for cli imports in the linker but got a different error when that ran</p>",
        "id": 462601200,
        "sender_full_name": "James Sturtevant",
        "timestamp": 1723743437
    },
    {
        "content": "<p>looking at the proxy component_type.wit generated by wit-bindgen it seems to have a <code>package wasi:cli@0.2.0 </code> but I don't see the <code>get-environment</code> import.  but the final binary has it: </p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">wasm</span><span class=\"o\">-</span><span class=\"n\">tools</span><span class=\"p\">.</span><span class=\"n\">exe</span><span class=\"w\"> </span><span class=\"n\">component</span><span class=\"w\"> </span><span class=\"n\">wit</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"err\">\\</span><span class=\"n\">bin</span><span class=\"err\">\\</span><span class=\"n\">Debug</span><span class=\"err\">\\</span><span class=\"n\">net8</span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"err\">\\</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">wasm</span><span class=\"err\">\\</span><span class=\"n\">native</span><span class=\"err\">\\</span><span class=\"n\">MyApp</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n<span class=\"n\">package</span><span class=\"w\"> </span><span class=\"n\">root</span><span class=\"p\">:</span><span class=\"nc\">component</span><span class=\"p\">;</span>\n\n<span class=\"n\">world</span><span class=\"w\"> </span><span class=\"n\">root</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"p\">:</span><span class=\"nc\">cli</span><span class=\"o\">/</span><span class=\"n\">environment</span><span class=\"o\">@</span><span class=\"mf\">0.2.0</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"p\">:</span><span class=\"nc\">cli</span><span class=\"o\">/</span><span class=\"n\">exit</span><span class=\"o\">@</span><span class=\"mf\">0.2.0</span><span class=\"p\">;</span>\n</code></pre></div>",
        "id": 462605499,
        "sender_full_name": "James Sturtevant",
        "timestamp": 1723744935
    },
    {
        "content": "<p>try <code>wasmtime serve -S cli ...</code></p>",
        "id": 462609187,
        "sender_full_name": "Joel Dice",
        "timestamp": 1723745562
    },
    {
        "content": "<p>I don't think there's currently a way to tell the ILC/runtime to stub out and omit <code>wasi:cli</code> stuff, so we have to tell <code>wasmtime</code> to provide it.</p>",
        "id": 462609473,
        "sender_full_name": "Joel Dice",
        "timestamp": 1723745614
    },
    {
        "content": "<p>that work! what's adding the adding <code>import wasi:cli/environment@0.2.0;</code>?  is that the dotnet compiler?</p>",
        "id": 462610076,
        "sender_full_name": "James Sturtevant",
        "timestamp": 1723745718
    },
    {
        "content": "<p><a href=\"https://github.com/jsturtevant/wasi-http-oci\">https://github.com/jsturtevant/wasi-http-oci</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/jsturtevant/wasi-http-oci\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/d000913a31c8b0196ef0d0fbfb36365f726f3142/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f303735613838356261326432633932323933326538656261316135393335633131313435626239306438336362633833613331373061643733306637353238662f6a73747572746576616e742f776173692d687474702d6f6369&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/jsturtevant/wasi-http-oci\" title=\"GitHub - jsturtevant/wasi-http-oci\">GitHub - jsturtevant/wasi-http-oci</a></div><div class=\"message_embed_description\">Contribute to jsturtevant/wasi-http-oci development by creating an account on GitHub.</div></div></div>",
        "id": 462611755,
        "sender_full_name": "James Sturtevant",
        "timestamp": 1723746182
    },
    {
        "content": "<p>Yeah, presumably either the .NET runtime or <code>wasi-libc</code> are pulling those in such that they can't be trimmed away.  I'll bet you could stub them out by passing <code>-Wl,--wasi-adapter,proxy</code> as a linker flag.</p>",
        "id": 462613147,
        "sender_full_name": "Joel Dice",
        "timestamp": 1723746545
    },
    {
        "content": "<p>It would be better to have those not generated right? I guess I should create an issue in dotnet repo to start to track?</p>",
        "id": 462613505,
        "sender_full_name": "James Sturtevant",
        "timestamp": 1723746635
    },
    {
        "content": "<p>Well, they <em>should</em> be generated if the application uses environment variables and/or calls <code>exit</code>.  Ideally they wouldn't be generated if the application doesn't use such features, I suppose, but I don't know how easy it is to detect that, nor if either the .NET runtime or wasi-libc proactively grabs environment variables just in case the application might need them.</p>\n<p>Feel free to open an issue, but we should be careful not to veer to the other extreme and omit imports when the app actually needs them.</p>",
        "id": 462614566,
        "sender_full_name": "Joel Dice",
        "timestamp": 1723747069
    },
    {
        "content": "<p>ah, ok that make sense.  I was discussing that the other day with some folks, how it is detected if something like an env is needed in the runtime and what would happen</p>",
        "id": 462618064,
        "sender_full_name": "James Sturtevant",
        "timestamp": 1723748487
    },
    {
        "content": "<p>good issue to add to that repo -- they either have an answer, or are on default as it's being built (which, understandable)</p>",
        "id": 462782840,
        "sender_full_name": "Ralph",
        "timestamp": 1723813446
    },
    {
        "content": "<p>It tells me that wasi-http/proxy probably needs to import <code>wasi:cli/environment</code></p>",
        "id": 467615230,
        "sender_full_name": "Mossaka (Joe)",
        "timestamp": 1725471213
    },
    {
        "content": "<p>I don't think wasi-http should import, it isn't needed for the functionality.  It would be perferable to have smaller independent functionality and then let the user bring it toget as needed.  Ideally the lanaguage compiler could dectect if ENVs/exit are in use and either bring them in or leave them out but maybe that's pretty hard to do and is why its there be default</p>",
        "id": 467898778,
        "sender_full_name": "James Sturtevant",
        "timestamp": 1725550400
    },
    {
        "content": "<p>created an issue <a href=\"https://github.com/dotnet/runtime/issues/107405\">https://github.com/dotnet/runtime/issues/107405</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/dotnet/runtime/issues/107405\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/32285797e2e3ba52096e75d83611c97ffc464480/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f653638383863333163623139623631656365636365383736663733313039323339383864313835616564666433393930626339303163356433343335666465652f646f746e65742f72756e74696d652f6973737565732f313037343035&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/dotnet/runtime/issues/107405\" title=\"WASI components import `wasi:cli/environemnt` and `wasi:cli/exit` when not being used 路 Issue #107405 路 dotnet/runtime\">WASI components import `wasi:cli/environemnt` and `wasi:cli/exit` when not being used 路 Issue #107405 路 dotnet/runtime</a></div><div class=\"message_embed_description\">problem statement When building a component for wasi:http when running in wasmtime I get the following error: wasmtime serve .\\bin\\Debug\\net8.0\\wasi-wasm\\native\\MyApp.wasm --addr 127.0.0.1:3000 Err...</div></div></div>",
        "id": 467901536,
        "sender_full_name": "James Sturtevant",
        "timestamp": 1725550967
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"509936\">Joel Dice</span> <a href=\"#narrow/stream/407028-C.23.2F.2Enet-collaboration/topic/missing.20implementation.20was.20not.20found.20in.20linker/near/462613147\">said</a>:</p>\n<blockquote>\n<p>by passing <code>-Wl,--wasi-adapter,proxy</code> as a linker flag.</p>\n</blockquote>\n<p>This works for cli, but then you can get </p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">called</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"nb\">Result</span><span class=\"p\">::</span><span class=\"n\">unwrap</span><span class=\"p\">()</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"n\">an</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"nb\">Err</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">component</span><span class=\"w\"> </span><span class=\"n\">imports</span><span class=\"w\"> </span><span class=\"n\">instance</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">wasi</span><span class=\"p\">:</span><span class=\"nc\">io</span><span class=\"o\">/</span><span class=\"n\">error</span><span class=\"o\">@</span><span class=\"mf\">0.2.0</span><span class=\"err\">`</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">but</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">matching</span><span class=\"w\"> </span><span class=\"n\">implementation</span><span class=\"w\"> </span><span class=\"n\">was</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">found</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">linker</span>\n\n<span class=\"n\">Caused</span><span class=\"w\"> </span><span class=\"n\">by</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"mi\">0</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">instance</span><span class=\"w\"> </span><span class=\"n\">export</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">error</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">wrong</span><span class=\"w\"> </span><span class=\"k\">type</span>\n<span class=\"w\">    </span><span class=\"mi\">1</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">resource</span><span class=\"w\"> </span><span class=\"n\">implementation</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">missing</span>\n</code></pre></div>\n<p>Is there an equivalent for <code>-S cli</code> etc but when linking or instantiating components in rust ?</p>",
        "id": 468623877,
        "sender_full_name": "Scott Waye",
        "timestamp": 1725827706
    },
    {
        "content": "<p>Adding these was what I wanted</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">    </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">type_annotate_wasi</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">F</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"n\">val</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">F</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">F</span>\n<span class=\"w\">    </span><span class=\"k\">where</span>\n<span class=\"w\">        </span><span class=\"n\">F</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nb\">Fn</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"kp\">&amp;</span><span class=\"nc\">mut</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"n\">val</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">wasi_closure</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">type_annotate_wasi</span><span class=\"p\">::</span><span class=\"o\">&lt;</span><span class=\"n\">HostState</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"o\">|</span><span class=\"n\">t</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">t</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">stdin</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wasi_closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">stdout</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wasi_closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">stderr</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wasi_closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">error</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wasi_closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">monotonic_clock</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wasi_closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">wall_clock</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wasi_closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">tcp</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wasi_closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">udp</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wasi_closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">random</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_get_host</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wasi_closure</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>I now have an unaligned pointer but that's a different problem.</p>",
        "id": 468641819,
        "sender_full_name": "Scott Waye",
        "timestamp": 1725839003
    }
]
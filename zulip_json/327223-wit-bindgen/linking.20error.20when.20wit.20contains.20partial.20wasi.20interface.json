[
    {
        "content": "<p>I get a linking error when the WIT file contains a partial WASI interface, feels like a bug somewhere. Here are the steps to reproduce the error:</p>\n<ol>\n<li><code>cargo new hello</code></li>\n<li><code>cargo build --target=wasm32-wasip2</code></li>\n<li><code>wasm-tools component wit hello.wasm --out-dir wit</code></li>\n<li><code>wit-bindgen-cli rust wit --generate-all --stubs</code></li>\n<li>Build the generated bindgen file with <code>cargo build --target=wasm32-wasip2</code>, and get the following error:</li>\n</ol>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">error</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">linking</span><span class=\"w\"> </span><span class=\"n\">with</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">wasm</span><span class=\"o\">-</span><span class=\"n\">component</span><span class=\"o\">-</span><span class=\"n\">ld</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">exit</span><span class=\"w\"> </span><span class=\"n\">status</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"o\">|</span>\n<span class=\"w\">  </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">note</span><span class=\"p\">:</span><span class=\"w\">  </span><span class=\"s\">\"wasm-component-ld\"</span><span class=\"w\"> </span><span class=\"s\">\"-flavor\"</span><span class=\"w\"> </span><span class=\"s\">\"wasm\"</span><span class=\"w\"> </span><span class=\"s\">\"--export\"</span><span class=\"w\"> </span><span class=\"s\">\"wasi:cli/run@0.2.3#run\"</span><span class=\"w\"> </span><span class=\"s\">\"--export\"</span><span class=\"w\"> </span><span class=\"s\">\"cabi_realloc\"</span><span class=\"w\"> </span><span class=\"s\">\"-z\"</span><span class=\"w\"> </span><span class=\"s\">\"stack-size=1048576\"</span><span class=\"w\"> </span><span class=\"s\">\"--stack-first\"</span><span class=\"w\"> </span><span class=\"s\">\"--allow-undefined\"</span><span class=\"w\"> </span><span class=\"s\">\"--no-demangle\"</span><span class=\"w\"> </span><span class=\"s\">\"&lt;15 object files omitted&gt;\"</span><span class=\"w\"> </span><span class=\"s\">\"/private/tmp/tt/target/wasm32-wasip2/debug/deps/{libwit_bindgen_rt-4a4c516dfc37d215.rlib}.rlib\"</span><span class=\"w\"> </span><span class=\"s\">\"&lt;sysroot&gt;/lib/rustlib/wasm32-wasip2/lib/{libstd-*,libpanic_abort-*,libwasi-*,librustc_demangle-*,libstd_detect-*,libhashbrown-*,librustc_std_workspace_alloc-*,libminiz_oxide-*,libadler2-*,libunwind-*,libcfg_if-*,liblibc-*}.rlib\"</span><span class=\"w\"> </span><span class=\"s\">\"-l\"</span><span class=\"w\"> </span><span class=\"s\">\"c\"</span><span class=\"w\"> </span><span class=\"s\">\"&lt;sysroot&gt;/lib/rustlib/wasm32-wasip2/lib/{liballoc-*,librustc_std_workspace_core-*,libcore-*,libcompiler_builtins-*}.rlib\"</span><span class=\"w\"> </span><span class=\"s\">\"-L\"</span><span class=\"w\"> </span><span class=\"s\">\"/private/tmp/tt/target/wasm32-wasip2/debug/build/wit-bindgen-rt-0de5cf11dd12c7f4/out\"</span><span class=\"w\"> </span><span class=\"s\">\"-L\"</span><span class=\"w\"> </span><span class=\"s\">\"&lt;sysroot&gt;/lib/rustlib/wasm32-wasip2/lib/self-contained\"</span><span class=\"w\"> </span><span class=\"s\">\"-o\"</span><span class=\"w\"> </span><span class=\"s\">\"/private/tmp/tt/target/wasm32-wasip2/debug/deps/tt.wasm\"</span><span class=\"w\"> </span><span class=\"s\">\"--gc-sections\"</span><span class=\"w\"> </span><span class=\"s\">\"--no-entry\"</span><span class=\"w\"> </span><span class=\"s\">\"-O0\"</span>\n<span class=\"w\">  </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">note</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">some</span><span class=\"w\"> </span><span class=\"n\">arguments</span><span class=\"w\"> </span><span class=\"n\">are</span><span class=\"w\"> </span><span class=\"n\">omitted</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"k\">use</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"o\">--</span><span class=\"n\">verbose</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">show</span><span class=\"w\"> </span><span class=\"n\">all</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"w\"> </span><span class=\"n\">arguments</span>\n<span class=\"w\">  </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">note</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">error</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">inject</span><span class=\"w\"> </span><span class=\"n\">adapter</span>\n\n<span class=\"w\">          </span><span class=\"n\">Caused</span><span class=\"w\"> </span><span class=\"n\">by</span><span class=\"p\">:</span>\n<span class=\"w\">              </span><span class=\"mi\">0</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">merge</span><span class=\"w\"> </span><span class=\"n\">WIT</span><span class=\"w\"> </span><span class=\"n\">packages</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">adapter</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">wasi_snapshot_preview1</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">into</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"n\">packages</span>\n<span class=\"w\">              </span><span class=\"mi\">1</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">merge</span><span class=\"w\"> </span><span class=\"n\">WIT</span><span class=\"w\"> </span><span class=\"n\">package</span><span class=\"w\"> </span><span class=\"n\">sets</span><span class=\"w\"> </span><span class=\"n\">together</span>\n<span class=\"w\">              </span><span class=\"mi\">2</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">merge</span><span class=\"w\"> </span><span class=\"n\">package</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">wasi</span><span class=\"p\">:</span><span class=\"nc\">io</span><span class=\"o\">@</span><span class=\"mf\">0.2.3</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">into</span><span class=\"w\"> </span><span class=\"n\">existing</span><span class=\"w\"> </span><span class=\"n\">copy</span>\n<span class=\"w\">              </span><span class=\"mi\">3</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">merge</span><span class=\"w\"> </span><span class=\"n\">interface</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">error</span><span class=\"err\">`</span>\n<span class=\"w\">              </span><span class=\"mi\">4</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">expected</span><span class=\"w\"> </span><span class=\"n\">function</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"p\">[</span><span class=\"n\">method</span><span class=\"p\">]</span><span class=\"n\">error</span><span class=\"p\">.</span><span class=\"n\">to</span><span class=\"o\">-</span><span class=\"n\">debug</span><span class=\"o\">-</span><span class=\"n\">string</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">present</span>\n</code></pre></div>\n<p>The generated <code>io.wit</code> from <code>wasm-tools</code> doesn't contain the <code>to-debug-string</code> method. I guess it's because it's not used by the code and gets removed? But it feels like this round-trip should just work..</p>\n<p>The same bindgen file can be compiled with <code>wasm32-unknown-unknown</code>, but it doesn't produce a valid component.</p>",
        "id": 529708330,
        "sender_full_name": "Yan Chen",
        "timestamp": 1753039570
    },
    {
        "content": "<p>The root of this problem is a relatively obscure issue -- <a href=\"https://github.com/bytecodealliance/wasm-tools/issues/1897\">https://github.com/bytecodealliance/wasm-tools/issues/1897</a> -- but I believe that's what's happening here</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasm-tools/issues/1897\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/e488a289e212c244090e3b6f7cbbd11c2ea0af51/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f333137343663383232326363623262613264316133386165666366613134383533363466646433656665326465623566323465373637346131656534636539322f62797465636f6465616c6c69616e63652f7761736d2d746f6f6c732f6973737565732f31383937&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasm-tools/issues/1897\" title=\"merging `wit` is not commutative · Issue #1897 · bytecodealliance/wasm-tools\">merging `wit` is not commutative · Issue #1897 · bytecodealliance/wasm-tools</a></div><div class=\"message_embed_description\">As the title states merging wit fails when trying to merge a non minimized package into a minimized package but the other way works. An example is the wit extracted from a component after it has pa...</div></div></div>",
        "id": 530155942,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1753193476
    },
    {
        "content": "<p>hmm, non-commutative looks fine to me. If we are following subtyping, merging is not commutative by definition. Commutative holds only when the two packages are disjoint. In <code>cargo build</code>, can we merge the main package into WASI, instead of the other way around? That seems to always work?</p>",
        "id": 530182352,
        "sender_full_name": "Yan Chen",
        "timestamp": 1753201459
    },
    {
        "content": "<p>the lack of commutativity is what's the problem here, you shouldn't have to order the merges since everything has the same source of truth as WASI with the original WITs, and in theory it shouldn't require doing things in the other order to get things to work. If you can arrange that though \"do things in the other order\" can get things to temporarily work</p>",
        "id": 530185330,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1753202480
    }
]
[
    {
        "content": "<p>HI, has [async] been dropped from the wasm function names, if so, does that mean a new version of wasmtime is needed?</p>",
        "id": 562261520,
        "sender_full_name": "Scott Waye",
        "timestamp": 1765050022
    },
    {
        "content": "<p>Correct; it's due to <a href=\"https://github.com/WebAssembly/component-model/pull/578\">https://github.com/WebAssembly/component-model/pull/578</a>.  If you're using the latest wasm-tools and wit-bindgen, you'll need to use Wasmtime's <code>main</code> branch until v40.0.0 is released.</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/WebAssembly/component-model/pull/578\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/4f7eae3bba5145187fee22be1aa91f48e34016fd/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f343433326535313233646438373062663336666163633637336666383534396461363163666135323938376331336130636236306632313961646430343833652f576562417373656d626c792f636f6d706f6e656e742d6d6f64656c2f70756c6c2f353738&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/WebAssembly/component-model/pull/578\" title=\"Make 'async' part of the function type, not a hint by lukewagner · Pull Request #578 · WebAssembly/component-model\">Make 'async' part of the function type, not a hint by lukewagner · Pull Request #578 · WebAssembly/component-model</a></div><div class=\"message_embed_description\">This PR moves async from being a hint that is textually mangled into function names to an optional effect type that is part of a function type.  WIT is not changed; just how it&#39;s encoded as a c...</div></div></div>",
        "id": 562275455,
        "sender_full_name": "Joel Dice",
        "timestamp": 1765069442
    },
    {
        "content": "<p>Thanks!   Looking at this wit <a href=\"https://github.com/bytecodealliance/wit-bindgen/blob/4284ea88f0b98e2e20e366298e95c9aa2ca4b488/tests/runtime-async/async/simple-import-params-results/test.wit#L18\">https://github.com/bytecodealliance/wit-bindgen/blob/4284ea88f0b98e2e20e366298e95c9aa2ca4b488/tests/runtime-async/async/simple-import-params-results/test.wit#L18</a><br>\nIt generates this c code</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">__attribute__</span><span class=\"p\">((</span><span class=\"n\">__export_name__</span><span class=\"p\">(</span><span class=\"s\">\"run\"</span><span class=\"p\">)))</span>\n<span class=\"n\">void</span><span class=\"w\"> </span><span class=\"n\">__wasm_export_exports_runner_run</span><span class=\"p\">(</span><span class=\"n\">void</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"n\">exports_runner_run</span><span class=\"p\">();</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>and nothing to indicate it is async.  Is that right?</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wit-bindgen/blob/4284ea88f0b98e2e20e366298e95c9aa2ca4b488/tests/runtime-async/async/simple-import-params-results/test.wit#L18\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/f65fa6008b9e96aa195060ca7f7c3e583f5fe0b5/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f623966383266613966313036373337363566366134346561366633303138336166613339313036373335393239356361636336616432393038373430376466652f62797465636f6465616c6c69616e63652f7769742d62696e6467656e&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wit-bindgen/blob/4284ea88f0b98e2e20e366298e95c9aa2ca4b488/tests/runtime-async/async/simple-import-params-results/test.wit#L18\" title=\"wit-bindgen/tests/runtime-async/async/simple-import-params-results/test.wit at 4284ea88f0b98e2e20e366298e95c9aa2ca4b488 · bytecodealliance/wit-bindgen\">wit-bindgen/tests/runtime-async/async/simple-import-params-results/test.wit at 4284ea88f0b98e2e20e366298e95c9aa2ca4b488 · bytecodealliance/wit-bindgen</a></div><div class=\"message_embed_description\">A language binding generator for WebAssembly interface types - bytecodealliance/wit-bindgen</div></div></div>",
        "id": 562465049,
        "sender_full_name": "Scott Waye",
        "timestamp": 1765200121
    },
    {
        "content": "<p>I suppose more specifically why isn't <code>[async-lift]</code> required here any more?</p>",
        "id": 562467911,
        "sender_full_name": "Scott Waye",
        "timestamp": 1765200936
    },
    {
        "content": "<p><code>async</code>-ness is now (Wasmtime <code>main</code> / the above PR) part of the function signature so the flag doesn't need to be part of the name any more.</p>",
        "id": 562472364,
        "sender_full_name": "Lann Martin",
        "timestamp": 1765202073
    },
    {
        "content": "<p>How is asyncness expressed in <code>c</code> in the signature?   I'm wondering how that would be  expressed in LLVM and c would give me a clue.</p>",
        "id": 562472741,
        "sender_full_name": "Scott Waye",
        "timestamp": 1765202175
    },
    {
        "content": "<p>I'm not sure if async support has even been added to the C bindings generator yet.</p>",
        "id": 562473554,
        "sender_full_name": "Lann Martin",
        "timestamp": 1765202378
    },
    {
        "content": "<p>ah ok, that might explain my confusion</p>",
        "id": 562473631,
        "sender_full_name": "Scott Waye",
        "timestamp": 1765202401
    },
    {
        "content": "<p>Semantically, <code>async</code> now means \"may block before returning\".</p>",
        "id": 562473662,
        "sender_full_name": "Lann Martin",
        "timestamp": 1765202407
    },
    {
        "content": "<p>Oh the C generator does have async support yeah. That specific test is <a href=\"https://github.com/bytecodealliance/wit-bindgen/blob/4284ea88f0b98e2e20e366298e95c9aa2ca4b488/tests/runtime-async/async/simple-import-params-results/runner.c#L1\">this one</a> which specifies that the <code>run</code> function does a sync lift into an async type, hence the lack of <code>[async-lift]</code></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wit-bindgen/blob/4284ea88f0b98e2e20e366298e95c9aa2ca4b488/tests/runtime-async/async/simple-import-params-results/runner.c#L1\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/f65fa6008b9e96aa195060ca7f7c3e583f5fe0b5/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f623966383266613966313036373337363566366134346561366633303138336166613339313036373335393239356361636336616432393038373430376466652f62797465636f6465616c6c69616e63652f7769742d62696e6467656e&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wit-bindgen/blob/4284ea88f0b98e2e20e366298e95c9aa2ca4b488/tests/runtime-async/async/simple-import-params-results/runner.c#L1\" title=\"wit-bindgen/tests/runtime-async/async/simple-import-params-results/runner.c at 4284ea88f0b98e2e20e366298e95c9aa2ca4b488 · bytecodealliance/wit-bindgen\">wit-bindgen/tests/runtime-async/async/simple-import-params-results/runner.c at 4284ea88f0b98e2e20e366298e95c9aa2ca4b488 · bytecodealliance/wit-bindgen</a></div><div class=\"message_embed_description\">A language binding generator for WebAssembly interface types - bytecodealliance/wit-bindgen</div></div></div>",
        "id": 562478915,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1765203745
    },
    {
        "content": "<p>The C bindings generator definitely supports async, and yes, the export should include <code>[async-lift]</code> by default for <code>async</code>-typed functions.  This is what I see when I run <code>wit-bindgen</code> on <code>main</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Bash Session\"><pre><span></span><code><span class=\"gp\"> $ </span>cargo<span class=\"w\"> </span>run<span class=\"w\"> </span>--<span class=\"w\"> </span>c<span class=\"w\"> </span>-w<span class=\"w\"> </span>runner<span class=\"w\"> </span>tests/runtime-async/async/simple-import-params-results/test.wit\n<span class=\"go\">    Finished `dev` profile [unoptimized + debuginfo] target(s) in 0.02s</span>\n<span class=\"go\">     Running `target/debug/wit-bindgen c -w runner tests/runtime-async/async/simple-import-params-results/test.wit`</span>\n<span class=\"go\">Generating \"runner.c\"</span>\n<span class=\"go\">Generating \"runner.h\"</span>\n<span class=\"go\">Generating \"runner_component_type.o\"</span>\n<span class=\"gp\"> $ </span>grep<span class=\"w\"> </span>-B<span class=\"w\"> </span><span class=\"m\">5</span><span class=\"w\"> </span>-A<span class=\"w\"> </span><span class=\"m\">5</span><span class=\"w\"> </span><span class=\"s1\">'\\[async-lift\\]run'</span><span class=\"w\"> </span>runner.c\n<span class=\"go\">  return ret;</span>\n<span class=\"go\">}</span>\n\n<span class=\"go\">// Helper Functions</span>\n\n<span class=\"go\">__attribute__((__export_name__(\"[callback][async-lift]run\")))</span>\n<span class=\"go\">uint32_t __wasm_export_exports_runner_run_callback(uint32_t event_raw, uint32_t waitable, uint32_t code) {</span>\n<span class=\"go\">  runner_event_t event;</span>\n<span class=\"go\">  event.event = (runner_event_code_t) event_raw;</span>\n<span class=\"go\">  event.waitable = waitable;</span>\n<span class=\"go\">  event.code = code;</span>\n<span class=\"go\">--</span>\n\n<span class=\"go\">runner_subtask_status_t a_b_i_two_arguments_and_result(uint32_t x, uint32_t y, uint32_t *result) {</span>\n<span class=\"go\">  return __wasm_import_a_b_i_two_arguments_and_result((int32_t) (x), (int32_t) (y), (uint8_t*) result);</span>\n<span class=\"go\">}</span>\n\n<span class=\"go\">__attribute__((__export_name__(\"[async-lift]run\")))</span>\n<span class=\"go\">int32_t __wasm_export_exports_runner_run(void) {</span>\n<span class=\"go\">  runner_callback_code_t ret = exports_runner_run();</span>\n<span class=\"go\">  return ret;</span>\n<span class=\"go\">}</span>\n</code></pre></div>",
        "id": 562479823,
        "sender_full_name": "Joel Dice",
        "timestamp": 1765203990
    },
    {
        "content": "<p>with main wit-bindgen ?</p>",
        "id": 562480019,
        "sender_full_name": "Scott Waye",
        "timestamp": 1765204030
    },
    {
        "content": "<p>correct</p>",
        "id": 562480042,
        "sender_full_name": "Joel Dice",
        "timestamp": 1765204036
    },
    {
        "content": "<p>0.48/0.49 should work the same way too</p>",
        "id": 562481234,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1765204287
    },
    {
        "content": "<p>Interesting, when I run <code>target\\debug\\wit-bindgen.exe test --languages rust,c tests/runtime-async/async --artifacts target/artifacts --rust-wit-bindgen-path ./crates/guest-rust --runner \"wasmtime -W component-model-async\"</code> I don't get that c generated.  Let me debug to see where I've gone wrong</p>",
        "id": 562481536,
        "sender_full_name": "Scott Waye",
        "timestamp": 1765204361
    },
    {
        "content": "<p>Ah; I'll bet it's this directive in runner.c: <code>//@ args = '--rename a:b/i=test --async=-run'</code></p>",
        "id": 562481920,
        "sender_full_name": "Joel Dice",
        "timestamp": 1765204460
    },
    {
        "content": "<p>That tells the test crate to disable async lift for the run function.  When I run <code>wit-bindgen-cli</code>, it ignores that directive, hence the difference between my results and yours.</p>",
        "id": 562482193,
        "sender_full_name": "Joel Dice",
        "timestamp": 1765204514
    },
    {
        "content": "<p>The upshot is that <code>[async-lift]</code> is indeed the default, but can be overridden via <code>--async=-run</code></p>",
        "id": 562482347,
        "sender_full_name": "Joel Dice",
        "timestamp": 1765204550
    }
]
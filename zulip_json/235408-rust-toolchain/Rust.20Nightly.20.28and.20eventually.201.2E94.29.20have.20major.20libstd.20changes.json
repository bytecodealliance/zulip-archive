[
    {
        "content": "<p>As a (belated) heads up to everyone using the Rust toolchain -- <a href=\"https://github.com/rust-lang/rust/pull/147572\">rust-lang/rust#147572</a> is a major change to how the <code>wasm32-wasip{1,2}</code> targets are implemented in Rust. The PR there has a thorough description, but the general idea is that lots of functions within the standard library have been reimplemented in terms of libc-based symbols instead of Rust-specific code in libstd. This has the immediate benefit of removing the need for the wasip1-to-wasip2 adapter for Rust, for example.</p>\n<p>As a big refactoring change this is inevitably having fallout. There's a mixture of bugs in libc being discovered to ramifications to precise behavior differences. I wanted to make a message here as a PSA to help diagnose anything that might come up. Basically if you see weird nightly behavior (and eventually Rust 1.94) this might be the cause. Feel free to cc me on anything and I can help out.</p>\n<p>Example bugs found so far are:</p>\n<ul>\n<li><a href=\"https://github.com/rust-lang/rust/pull/149864\"><code>linkat</code> was broken in libc</a></li>\n<li><a href=\"https://github.com/rust-lang/rust/issues/150290\"><code>thread::sleep</code> was panicking/broken in libc</a></li>\n<li><a href=\"https://github.com/rust-lang/rust/pull/150881\"><code>fs::copy</code> didn't work</a></li>\n<li><a href=\"https://github.com/rust-lang/rust/pull/151016\"><code>rayon</code> is panicking vs gracefully handling error</a></li>\n</ul>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/rust-lang/rust/pull/147572\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/3d97ea7da82ac4edf6ce6eec7648822166d783d2/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f616364326565666664616635396532643230623861643239323765323139653835666438313930383637663931343537353763343461333861363264336461632f727573742d6c616e672f727573742f70756c6c2f313437353732&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/rust-lang/rust/pull/147572\" title=\"std: Use more `unix.rs` code on WASI targets by alexcrichton · Pull Request #147572 · rust-lang/rust\">std: Use more `unix.rs` code on WASI targets by alexcrichton · Pull Request #147572 · rust-lang/rust</a></div><div class=\"message_embed_description\">This commit is a large change to the implementation of filesystem and\nother system-related operations on WASI targets. Previously the standard\nlibrary explicitly used the wasi crate at the 0.11.x v...</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/rust-lang/rust/pull/149864\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/f986d69dd73f98e1fcf62b0a69757bf797a4ba62/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f353136633363303064346634333661616333313732623864366635333936323831353731656264613237396164633862316439653831346535363930363662622f727573742d6c616e672f727573742f70756c6c2f313439383634&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/rust-lang/rust/pull/149864\" title=\"std: Don't use `linkat` on the `wasm32-wasi*` targets by alexcrichton · Pull Request #149864 · rust-lang/rust\">std: Don't use `linkat` on the `wasm32-wasi*` targets by alexcrichton · Pull Request #149864 · rust-lang/rust</a></div><div class=\"message_embed_description\">This commit is a follow-up to #147572 and the issue reported at the end of that PR where the std::fs::hard_link function is broken after that PR landed. The true culprit and bug here is fixed in We...</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/rust-lang/rust/issues/150290\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/78c8d78efd3fdfa80f5e3e23334f594ca3c6d20b/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f383264306464653833646131326136633630633739326131333862303862346665303165373466363635616330386563383538363733396363386337643933302f727573742d6c616e672f727573742f6973737565732f313530323930&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/rust-lang/rust/issues/150290\" title=\"Thread sleep wasm32-wasip2 nightly panics · Issue #150290 · rust-lang/rust\">Thread sleep wasm32-wasip2 nightly panics · Issue #150290 · rust-lang/rust</a></div><div class=\"message_embed_description\">I tried this code: use std::{thread, time::Duration}; fn main() { thread::sleep(Duration::from_secs(1)); } I expected to see this happen: Waits 1s then exit Instead, this happened: Panic Meta The c...</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/rust-lang/rust/pull/150881\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/72f347c2d46541560b3b533fd3a57aa4b660ca36/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f653433643631663734656131343038396131623739303531366530653239326336306132396263653930633830363963326231313565613765353230353461302f727573742d6c616e672f727573742f70756c6c2f313530383831&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/rust-lang/rust/pull/150881\" title=\"Fix std::fs::copy on WASI by setting proper OpenOptions flags by cdmurph32 · Pull Request #150881 · rust-lang/rust\">Fix std::fs::copy on WASI by setting proper OpenOptions flags by cdmurph32 · Pull Request #150881 · rust-lang/rust</a></div><div class=\"message_embed_description\">When PR #147572 switched WASI to use Unix-style filesystem APIs, the open_to_and_set_permissions function for WASI was implemented to call OpenOptions::new().open() without setting any access mode ...</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/rust-lang/rust/pull/151016\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/d4fd55f2dd6ef566e823b57288da0f2ae02d0131/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f333438396233623133373639393064306334363434393030336131633061363139646465383932633938346338313765353763653630396665386461623330352f727573742d6c616e672f727573742f70756c6c2f313531303136&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/rust-lang/rust/pull/151016\" title=\"fix: WASI threading regression by disabling pthread usage by cdmurph32 · Pull Request #151016 · rust-lang/rust\">fix: WASI threading regression by disabling pthread usage by cdmurph32 · Pull Request #151016 · rust-lang/rust</a></div><div class=\"message_embed_description\">PR #147572 changed WASI to use the Unix threading implementation, but WASI does not support threading. When the Unix code tries to call pthread_create, it fails with EAGAIN, causing libraries like ...</div></div></div>",
        "id": 567629503,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1768247073
    }
]
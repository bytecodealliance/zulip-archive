[
    {
        "content": "<p>Hey folks,<br>\nWhile compiling a <code>wasm32</code> canister on ICP, I bumped into a linking error which boils down to this simple repro:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">#[unsafe(export_name = </span><span class=\"s\">\"name with spaces\"</span><span class=\"cp\">)]</span>\n<span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">name</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{}</span>\n</code></pre></div>\n<p>Compiling it with Rust 1.84-1.87 both for <code>wasm32-unknown-unknown</code> and <code>x86_64</code> gives the <code>syntax error in VERSION script</code> error.</p>\n<p>Here is the repro: <a href=\"https://github.com/berestovskyy/linker-bug\">https://github.com/berestovskyy/linker-bug</a></p>\n<p>I also found two workarounds:</p>\n<ol>\n<li>Specifying the target directly in the command line: <code>cargo build --target=wasm32-unknown-unknown</code>. This does not work though on the latest Rust nightly... :(</li>\n<li>Removing spaces from the exported function (not a real workaround for the ICP, but listing it here for completeness).</li>\n</ol>\n<p>The nightly produces a more specific <code>; expected, but got with</code> error:</p>\n<div class=\"spoiler-block\"><div class=\"spoiler-header\">\n<p>Compilation log on 1.89.0-nightly (47c911e9e 2025-05-14)</p>\n</div><div class=\"spoiler-content\" aria-hidden=\"true\">\n<p>Compiling linker-bug v0.1.0 (/home/a/tmp/linker-bug)<br>\nerror: linking with <code>cc</code> failed: exit status: 1<br>\n  |<br>\n  = note:  \"cc\" \"-Wl,--version-script=/tmp/rustcTzaYvJ/list\" \"-Wl,--no-undefined-version\" \"-m64\" \"/tmp/rustcTzaYvJ/symbols.o\" \"&lt;2 object files omitted&gt;\" \"-Wl,--as-needed\" \"-Wl,-Bstatic\" \"&lt;sysroot&gt;/lib/rustlib/x86_64-unknown-linux-gnu/lib/{libstd-<em>,libpanic_unwind-</em>,libobject-<em>,libmemchr-</em>,libaddr2line-<em>,libgimli-</em>,librustc_demangle-<em>,libstd_detect-</em>,libhashbrown-<em>,librustc_std_workspace_alloc-</em>,libminiz_oxide-<em>,libadler2-</em>,libunwind-<em>,libcfg_if-</em>,liblibc-<em>,liballoc-</em>,librustc_std_workspace_core-<em>,libcore-</em>,libcompiler_builtins-*}.rlib\" \"-Wl,-Bdynamic\" \"-lgcc_s\" \"-lutil\" \"-lrt\" \"-lpthread\" \"-lm\" \"-ldl\" \"-lc\" \"-L\" \"/tmp/rustcTzaYvJ/raw-dylibs\" \"-B&lt;sysroot&gt;/lib/rustlib/x86_64-unknown-linux-gnu/bin/gcc-ld\" \"-fuse-ld=lld\" \"-Wl,-znostart-stop-gc\" \"-Wl,--eh-frame-hdr\" \"-Wl,-z,noexecstack\" \"-L\" \"&lt;sysroot&gt;/lib/rustlib/x86_64-unknown-linux-gnu/lib\" \"-o\" \"/home/a/tmp/linker-bug/target/x86_64-unknown-linux-gnu/debug/deps/liblinker_bug.so\" \"-Wl,--gc-sections\" \"-shared\" \"-Wl,-z,relro,-z,now\" \"-nodefaultlibs\"<br>\n  = note: some arguments are omitted. use <code>--verbose</code> to show all linker arguments<br>\n  = note: rust-lld: error: /tmp/rustcTzaYvJ/list<span aria-label=\"3\" class=\"emoji emoji-1f970\" role=\"img\" title=\"3\">:3:</span> ; expected, but got with<br>\n          &gt;&gt;&gt;     name with spaces;<br>\n          &gt;&gt;&gt;          ^<br>\n          collect2: error: ld returned 1 exit status</p>\n</div></div>\n<p>Does this mean that the exports with spaces soon won't be supported by the toolchain?</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/berestovskyy/linker-bug\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/82a3f43a5705a45ecfe2e7c4ac259fcf59779414/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f613930313163613231646563333130363238373661363930306431326634313539356665343331386562336661373166313338636330656437323362663637332f6265726573746f76736b79792f6c696e6b65722d627567&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/berestovskyy/linker-bug\" title=\"GitHub - berestovskyy/linker-bug: A repro for `wasm32` linker bug\">GitHub - berestovskyy/linker-bug: A repro for `wasm32` linker bug</a></div><div class=\"message_embed_description\">A repro for `wasm32` linker bug. Contribute to berestovskyy/linker-bug development by creating an account on GitHub.</div></div></div>",
        "id": 519464458,
        "sender_full_name": "Andriy Berestovskyy",
        "timestamp": 1747771116
    },
    {
        "content": "<p>The error message you've linked here looks like it's for compiling to native, e.g. <code>\"-L\" \"&lt;sysroot&gt;/lib/rustlib/x86_64-unknown-linux-gnu/lib\"</code> is in the arguments, so are you sure this is project compiled to wasm?</p>",
        "id": 519475244,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1747775500
    },
    {
        "content": "<p>Apologies, I think I confused <code>rust-toolchain.toml</code> (targets to install) and <code>.cargo/config.toml</code> (target to build). That's why adding an explicit target was fixing the issue...</p>",
        "id": 519477338,
        "sender_full_name": "Andriy Berestovskyy",
        "timestamp": 1747776516
    }
]
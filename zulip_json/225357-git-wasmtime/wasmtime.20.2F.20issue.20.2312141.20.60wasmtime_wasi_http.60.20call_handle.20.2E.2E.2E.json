[
    {
        "content": "<p>if0ne opened <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12141\">issue #12141</a>:</p>\n<blockquote>\n<p>Hi there!</p>\n<p>If I try to return an array with a size of 2 MB, everything works fine:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">wasmcloud_component</span><span class=\"p\">::</span><span class=\"n\">http</span><span class=\"p\">;</span>\n\n<span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">Component</span><span class=\"p\">;</span>\n\n<span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">http</span><span class=\"p\">::</span><span class=\"n\">Server</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">Component</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">handle</span><span class=\"p\">(</span>\n<span class=\"w\">        </span><span class=\"n\">_request</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">http</span><span class=\"p\">::</span><span class=\"n\">IncomingRequest</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">http</span><span class=\"p\">::</span><span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"n\">http</span><span class=\"p\">::</span><span class=\"n\">Response</span><span class=\"o\">&lt;</span><span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">http</span><span class=\"p\">::</span><span class=\"n\">OutgoingBody</span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">bytes</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"fm\">vec!</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"k\">u8</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">1024</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">1024</span><span class=\"p\">];</span>\n<span class=\"w\">        </span><span class=\"nb\">Ok</span><span class=\"p\">(</span><span class=\"n\">http</span><span class=\"p\">::</span><span class=\"n\">Response</span><span class=\"p\">::</span><span class=\"n\">new</span><span class=\"p\">(</span><span class=\"n\">bytes</span><span class=\"p\">))</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n\n<span class=\"n\">http</span><span class=\"p\">::</span><span class=\"n\">export</span><span class=\"o\">!</span><span class=\"p\">(</span><span class=\"n\">Component</span><span class=\"p\">);</span>\n</code></pre></div>\n<p>Output:</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>curl<span class=\"w\"> </span>localhost:8000<span class=\"w\"> </span>--output<span class=\"w\"> </span>output.txt\n<span class=\"w\">  </span>%<span class=\"w\"> </span>Total<span class=\"w\">    </span>%<span class=\"w\"> </span>Received<span class=\"w\"> </span>%<span class=\"w\"> </span>Xferd<span class=\"w\">  </span>Average<span class=\"w\"> </span>Speed<span class=\"w\">   </span>Time<span class=\"w\">    </span>Time<span class=\"w\">     </span>Time<span class=\"w\">  </span>Current\n<span class=\"w\">                                 </span>Dload<span class=\"w\">  </span>Upload<span class=\"w\">   </span>Total<span class=\"w\">   </span>Spent<span class=\"w\">    </span>Left<span class=\"w\">  </span>Speed\n<span class=\"m\">100</span><span class=\"w\"> </span>2048k<span class=\"w\">    </span><span class=\"m\">0</span><span class=\"w\"> </span>2048k<span class=\"w\">    </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">0</span><span class=\"w\">  </span><span class=\"m\">81</span>.7M<span class=\"w\">      </span><span class=\"m\">0</span><span class=\"w\"> </span>--:--:--<span class=\"w\"> </span>--:--:--<span class=\"w\"> </span>--:--:--<span class=\"w\"> </span><span class=\"m\">83</span>.3M\n</code></pre></div>\n<p>But if I make the vector larger than 2 MB:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">wasmcloud_component</span><span class=\"p\">::</span><span class=\"n\">http</span><span class=\"p\">;</span>\n\n<span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">Component</span><span class=\"p\">;</span>\n\n<span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">http</span><span class=\"p\">::</span><span class=\"n\">Server</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">Component</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">handle</span><span class=\"p\">(</span>\n<span class=\"w\">        </span><span class=\"n\">_request</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">http</span><span class=\"p\">::</span><span class=\"n\">IncomingRequest</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">http</span><span class=\"p\">::</span><span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"n\">http</span><span class=\"p\">::</span><span class=\"n\">Response</span><span class=\"o\">&lt;</span><span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">http</span><span class=\"p\">::</span><span class=\"n\">OutgoingBody</span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">bytes</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"fm\">vec!</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"k\">u8</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">1024</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">1024</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">];</span>\n<span class=\"w\">        </span><span class=\"nb\">Ok</span><span class=\"p\">(</span><span class=\"n\">http</span><span class=\"p\">::</span><span class=\"n\">Response</span><span class=\"p\">::</span><span class=\"n\">new</span><span class=\"p\">(</span><span class=\"n\">bytes</span><span class=\"p\">))</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n\n<span class=\"n\">http</span><span class=\"p\">::</span><span class=\"n\">export</span><span class=\"o\">!</span><span class=\"p\">(</span><span class=\"n\">Component</span><span class=\"p\">);</span>\n</code></pre></div>\n<p>Output:</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>curl<span class=\"w\"> </span>localhost:8000<span class=\"w\"> </span>--output<span class=\"w\"> </span>output.txt\n<span class=\"w\">  </span>%<span class=\"w\"> </span>Total<span class=\"w\">    </span>%<span class=\"w\"> </span>Received<span class=\"w\"> </span>%<span class=\"w\"> </span>Xferd<span class=\"w\">  </span>Average<span class=\"w\"> </span>Speed<span class=\"w\">   </span>Time<span class=\"w\">    </span>Time<span class=\"w\">     </span>Time<span class=\"w\">  </span>Current\n<span class=\"w\">                                 </span>Dload<span class=\"w\">  </span>Upload<span class=\"w\">   </span>Total<span class=\"w\">   </span>Spent<span class=\"w\">    </span>Left<span class=\"w\">  </span>Speed\n<span class=\"w\">  </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">0</span><span class=\"w\">    </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">0</span><span class=\"w\">    </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">0</span><span class=\"w\">      </span><span class=\"m\">0</span><span class=\"w\">      </span><span class=\"m\">0</span><span class=\"w\"> </span>--:--:--<span class=\"w\">  </span><span class=\"m\">0</span>:01:55<span class=\"w\"> </span>--:--:--<span class=\"w\">     </span><span class=\"m\">0</span>\n</code></pre></div>\n<p>I debugged the wasmCloud runtime and found that the code freezes on <code>call_handle</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">sender</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">receiver</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">tokio</span><span class=\"p\">::</span><span class=\"n\">sync</span><span class=\"p\">::</span><span class=\"n\">oneshot</span><span class=\"p\">::</span><span class=\"n\">channel</span><span class=\"p\">();</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">scheme</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">req</span><span class=\"p\">.</span><span class=\"n\">uri</span><span class=\"p\">().</span><span class=\"n\">scheme</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"nb\">Some</span><span class=\"p\">(</span><span class=\"n\">scheme</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">scheme</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">hyper</span><span class=\"p\">::</span><span class=\"n\">http</span><span class=\"p\">::</span><span class=\"n\">uri</span><span class=\"p\">::</span><span class=\"n\">Scheme</span><span class=\"p\">::</span><span class=\"n\">HTTP</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Scheme</span><span class=\"p\">::</span><span class=\"n\">Http</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"nb\">Some</span><span class=\"p\">(</span><span class=\"n\">scheme</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">scheme</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">hyper</span><span class=\"p\">::</span><span class=\"n\">http</span><span class=\"p\">::</span><span class=\"n\">uri</span><span class=\"p\">::</span><span class=\"n\">Scheme</span><span class=\"p\">::</span><span class=\"n\">HTTPS</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Scheme</span><span class=\"p\">::</span><span class=\"n\">Https</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"nb\">Some</span><span class=\"p\">(</span><span class=\"n\">scheme</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Scheme</span><span class=\"p\">::</span><span class=\"n\">Other</span><span class=\"p\">(</span><span class=\"n\">scheme</span><span class=\"p\">.</span><span class=\"n\">as_str</span><span class=\"p\">().</span><span class=\"n\">to_string</span><span class=\"p\">()),</span>\n<span class=\"w\">        </span><span class=\"c1\">// Fallback to HTTP if no scheme is present</span>\n<span class=\"w\">        </span><span class=\"nb\">None</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Scheme</span><span class=\"p\">::</span><span class=\"n\">Http</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"p\">};</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">req</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">data_mut</span><span class=\"p\">().</span><span class=\"n\">new_incoming_request</span><span class=\"p\">(</span><span class=\"n\">scheme</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">req</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">data_mut</span><span class=\"p\">().</span><span class=\"n\">new_response_outparam</span><span class=\"p\">(</span><span class=\"n\">sender</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">pre</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ProxyPre</span><span class=\"p\">::</span><span class=\"n\">new</span><span class=\"p\">(</span><span class=\"n\">pre</span><span class=\"p\">).</span><span class=\"n\">context</span><span class=\"p\">(</span><span class=\"s\">\"failed to instantiate proxy pre\"</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// Run the http request itself by instantiating and calling the component</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">proxy</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">pre</span><span class=\"p\">.</span><span class=\"n\">instantiate_async</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">store</span><span class=\"p\">).</span><span class=\"k\">await</span><span class=\"o\">?</span><span class=\"p\">;</span>\n\n<span class=\"w\">    </span><span class=\"n\">proxy</span>\n<span class=\"w\">        </span><span class=\"p\">.</span><span class=\"n\">wasi_http_incoming_handler</span><span class=\"p\">()</span>\n<span class=\"w\">        </span><span class=\"p\">.</span><span class=\"n\">call_handle</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">store</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">req</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"p\">)</span>\n<span class=\"w\">        </span><span class=\"p\">.</span><span class=\"k\">await</span><span class=\"o\">?</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>I use default <code>outgoing_body_buffer_chunks</code> and <code>outgoing_body_chunk_size</code> in examples above</p>\n<h3>Expected Results</h3>\n<p>I think that if the body exceeds the outgoing parameter limits, <code>call_handle</code> should return an error instead of freezing.</p>\n<h3>Actual Results</h3>\n<p>TODO: What actually happens? Panic? Segfault? Incorrect result?</p>\n<h3>Versions and Environment</h3>\n<p>wasmtime = { version = \"38\", default-features = false }<br>\nwasmtime-wasi = { version = \"38\", default-features = false }<br>\nwasmtime-wasi-io = { version = \"38\", default-features = false }<br>\nwasmtime-wasi-http = { version = \"38\", default-features = false }</p>\n<h3>Extra Info</h3>\n<p>Anything else you'd like to add?<br>\n</p>\n</blockquote>",
        "id": 562502314,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1765208968
    },
    {
        "content": "<p><a href=\"https://github.com/if0ne\">if0ne</a> added the bug label to <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12141\">Issue #12141</a>.</p>",
        "id": 562502315,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1765208969
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12141#issuecomment-3628377665\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12141\">issue #12141</a>:</p>\n<blockquote>\n<p>Thanks for the report! Would you be able to reduce this to a component which you could upload + a <code>wasmtime serve</code> invocation + a <code>curl</code> invocation? If the bug lies in Wasmtime I believe that should be a possible reproduction path.</p>\n</blockquote>",
        "id": 562531934,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1765217473
    },
    {
        "content": "<p>if0ne closed <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12141\">issue #12141</a>:</p>\n<blockquote>\n<p>Hi there!</p>\n<p>If I try to return an array with a size of 2 MB, everything works fine:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">wasmcloud_component</span><span class=\"p\">::</span><span class=\"n\">http</span><span class=\"p\">;</span>\n\n<span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">Component</span><span class=\"p\">;</span>\n\n<span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">http</span><span class=\"p\">::</span><span class=\"n\">Server</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">Component</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">handle</span><span class=\"p\">(</span>\n<span class=\"w\">        </span><span class=\"n\">_request</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">http</span><span class=\"p\">::</span><span class=\"n\">IncomingRequest</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">http</span><span class=\"p\">::</span><span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"n\">http</span><span class=\"p\">::</span><span class=\"n\">Response</span><span class=\"o\">&lt;</span><span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">http</span><span class=\"p\">::</span><span class=\"n\">OutgoingBody</span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">bytes</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"fm\">vec!</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"k\">u8</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">1024</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">1024</span><span class=\"p\">];</span>\n<span class=\"w\">        </span><span class=\"nb\">Ok</span><span class=\"p\">(</span><span class=\"n\">http</span><span class=\"p\">::</span><span class=\"n\">Response</span><span class=\"p\">::</span><span class=\"n\">new</span><span class=\"p\">(</span><span class=\"n\">bytes</span><span class=\"p\">))</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n\n<span class=\"n\">http</span><span class=\"p\">::</span><span class=\"n\">export</span><span class=\"o\">!</span><span class=\"p\">(</span><span class=\"n\">Component</span><span class=\"p\">);</span>\n</code></pre></div>\n<p>Output:</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>curl<span class=\"w\"> </span>localhost:8000<span class=\"w\"> </span>--output<span class=\"w\"> </span>output.txt\n<span class=\"w\">  </span>%<span class=\"w\"> </span>Total<span class=\"w\">    </span>%<span class=\"w\"> </span>Received<span class=\"w\"> </span>%<span class=\"w\"> </span>Xferd<span class=\"w\">  </span>Average<span class=\"w\"> </span>Speed<span class=\"w\">   </span>Time<span class=\"w\">    </span>Time<span class=\"w\">     </span>Time<span class=\"w\">  </span>Current\n<span class=\"w\">                                 </span>Dload<span class=\"w\">  </span>Upload<span class=\"w\">   </span>Total<span class=\"w\">   </span>Spent<span class=\"w\">    </span>Left<span class=\"w\">  </span>Speed\n<span class=\"m\">100</span><span class=\"w\"> </span>2048k<span class=\"w\">    </span><span class=\"m\">0</span><span class=\"w\"> </span>2048k<span class=\"w\">    </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">0</span><span class=\"w\">  </span><span class=\"m\">81</span>.7M<span class=\"w\">      </span><span class=\"m\">0</span><span class=\"w\"> </span>--:--:--<span class=\"w\"> </span>--:--:--<span class=\"w\"> </span>--:--:--<span class=\"w\"> </span><span class=\"m\">83</span>.3M\n</code></pre></div>\n<p>But if I make the vector larger than 2 MB:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">wasmcloud_component</span><span class=\"p\">::</span><span class=\"n\">http</span><span class=\"p\">;</span>\n\n<span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">Component</span><span class=\"p\">;</span>\n\n<span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">http</span><span class=\"p\">::</span><span class=\"n\">Server</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">Component</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">handle</span><span class=\"p\">(</span>\n<span class=\"w\">        </span><span class=\"n\">_request</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">http</span><span class=\"p\">::</span><span class=\"n\">IncomingRequest</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">http</span><span class=\"p\">::</span><span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"n\">http</span><span class=\"p\">::</span><span class=\"n\">Response</span><span class=\"o\">&lt;</span><span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">http</span><span class=\"p\">::</span><span class=\"n\">OutgoingBody</span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">bytes</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"fm\">vec!</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"k\">u8</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">1024</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">1024</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">];</span>\n<span class=\"w\">        </span><span class=\"nb\">Ok</span><span class=\"p\">(</span><span class=\"n\">http</span><span class=\"p\">::</span><span class=\"n\">Response</span><span class=\"p\">::</span><span class=\"n\">new</span><span class=\"p\">(</span><span class=\"n\">bytes</span><span class=\"p\">))</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n\n<span class=\"n\">http</span><span class=\"p\">::</span><span class=\"n\">export</span><span class=\"o\">!</span><span class=\"p\">(</span><span class=\"n\">Component</span><span class=\"p\">);</span>\n</code></pre></div>\n<p>Output:</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>curl<span class=\"w\"> </span>localhost:8000<span class=\"w\"> </span>--output<span class=\"w\"> </span>output.txt\n<span class=\"w\">  </span>%<span class=\"w\"> </span>Total<span class=\"w\">    </span>%<span class=\"w\"> </span>Received<span class=\"w\"> </span>%<span class=\"w\"> </span>Xferd<span class=\"w\">  </span>Average<span class=\"w\"> </span>Speed<span class=\"w\">   </span>Time<span class=\"w\">    </span>Time<span class=\"w\">     </span>Time<span class=\"w\">  </span>Current\n<span class=\"w\">                                 </span>Dload<span class=\"w\">  </span>Upload<span class=\"w\">   </span>Total<span class=\"w\">   </span>Spent<span class=\"w\">    </span>Left<span class=\"w\">  </span>Speed\n<span class=\"w\">  </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">0</span><span class=\"w\">    </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">0</span><span class=\"w\">    </span><span class=\"m\">0</span><span class=\"w\">     </span><span class=\"m\">0</span><span class=\"w\">      </span><span class=\"m\">0</span><span class=\"w\">      </span><span class=\"m\">0</span><span class=\"w\"> </span>--:--:--<span class=\"w\">  </span><span class=\"m\">0</span>:01:55<span class=\"w\"> </span>--:--:--<span class=\"w\">     </span><span class=\"m\">0</span>\n</code></pre></div>\n<p>I debugged the wasmCloud runtime and found that the code freezes on <code>call_handle</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">sender</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">receiver</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">tokio</span><span class=\"p\">::</span><span class=\"n\">sync</span><span class=\"p\">::</span><span class=\"n\">oneshot</span><span class=\"p\">::</span><span class=\"n\">channel</span><span class=\"p\">();</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">scheme</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">req</span><span class=\"p\">.</span><span class=\"n\">uri</span><span class=\"p\">().</span><span class=\"n\">scheme</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"nb\">Some</span><span class=\"p\">(</span><span class=\"n\">scheme</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">scheme</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">hyper</span><span class=\"p\">::</span><span class=\"n\">http</span><span class=\"p\">::</span><span class=\"n\">uri</span><span class=\"p\">::</span><span class=\"n\">Scheme</span><span class=\"p\">::</span><span class=\"n\">HTTP</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Scheme</span><span class=\"p\">::</span><span class=\"n\">Http</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"nb\">Some</span><span class=\"p\">(</span><span class=\"n\">scheme</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">scheme</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">hyper</span><span class=\"p\">::</span><span class=\"n\">http</span><span class=\"p\">::</span><span class=\"n\">uri</span><span class=\"p\">::</span><span class=\"n\">Scheme</span><span class=\"p\">::</span><span class=\"n\">HTTPS</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Scheme</span><span class=\"p\">::</span><span class=\"n\">Https</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"nb\">Some</span><span class=\"p\">(</span><span class=\"n\">scheme</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Scheme</span><span class=\"p\">::</span><span class=\"n\">Other</span><span class=\"p\">(</span><span class=\"n\">scheme</span><span class=\"p\">.</span><span class=\"n\">as_str</span><span class=\"p\">().</span><span class=\"n\">to_string</span><span class=\"p\">()),</span>\n<span class=\"w\">        </span><span class=\"c1\">// Fallback to HTTP if no scheme is present</span>\n<span class=\"w\">        </span><span class=\"nb\">None</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">Scheme</span><span class=\"p\">::</span><span class=\"n\">Http</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"p\">};</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">req</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">data_mut</span><span class=\"p\">().</span><span class=\"n\">new_incoming_request</span><span class=\"p\">(</span><span class=\"n\">scheme</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">req</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">data_mut</span><span class=\"p\">().</span><span class=\"n\">new_response_outparam</span><span class=\"p\">(</span><span class=\"n\">sender</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">pre</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ProxyPre</span><span class=\"p\">::</span><span class=\"n\">new</span><span class=\"p\">(</span><span class=\"n\">pre</span><span class=\"p\">).</span><span class=\"n\">context</span><span class=\"p\">(</span><span class=\"s\">\"failed to instantiate proxy pre\"</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// Run the http request itself by instantiating and calling the component</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">proxy</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">pre</span><span class=\"p\">.</span><span class=\"n\">instantiate_async</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">store</span><span class=\"p\">).</span><span class=\"k\">await</span><span class=\"o\">?</span><span class=\"p\">;</span>\n\n<span class=\"w\">    </span><span class=\"n\">proxy</span>\n<span class=\"w\">        </span><span class=\"p\">.</span><span class=\"n\">wasi_http_incoming_handler</span><span class=\"p\">()</span>\n<span class=\"w\">        </span><span class=\"p\">.</span><span class=\"n\">call_handle</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">store</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">req</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"p\">)</span>\n<span class=\"w\">        </span><span class=\"p\">.</span><span class=\"k\">await</span><span class=\"o\">?</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>I use default <code>outgoing_body_buffer_chunks</code> and <code>outgoing_body_chunk_size</code> in examples above</p>\n<h3>Expected Results</h3>\n<p>I think that if the body exceeds the outgoing parameter limits, <code>call_handle</code> should return an error instead of freezing.</p>\n<h3>Actual Results</h3>\n<p>TODO: What actually happens? Panic? Segfault? Incorrect result?</p>\n<h3>Versions and Environment</h3>\n<p>wasmtime = { version = \"38\", default-features = false }<br>\nwasmtime-wasi = { version = \"38\", default-features = false }<br>\nwasmtime-wasi-io = { version = \"38\", default-features = false }<br>\nwasmtime-wasi-http = { version = \"38\", default-features = false }</p>\n<h3>Extra Info</h3>\n<p>Anything else you'd like to add?<br>\n</p>\n</blockquote>",
        "id": 562561521,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1765229381
    },
    {
        "content": "<p>if0ne <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12141#issuecomment-3629082069\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12141\">issue #12141</a>:</p>\n<blockquote>\n<p>I tested it using wasmtime serve. Everything works.</p>\n</blockquote>",
        "id": 562561522,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1765229381
    },
    {
        "content": "<p>if0ne <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12141#issuecomment-3631769876\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12141\">issue #12141</a>:</p>\n<blockquote>\n<p>@alexcrichton the solution is to call call_handle in a separate <code>tokio::task</code>.</p>\n</blockquote>",
        "id": 562660002,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1765279830
    }
]
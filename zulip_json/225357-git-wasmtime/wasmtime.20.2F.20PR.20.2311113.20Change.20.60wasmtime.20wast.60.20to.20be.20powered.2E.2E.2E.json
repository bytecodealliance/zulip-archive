[
    {
        "content": "<p>alexcrichton opened <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11113\">PR #11113</a> from <code>alexcrichton:wast-json</code> to <code>bytecodealliance:main</code>:</p>\n<blockquote>\n<p>This commit is a refactoring of the <code>wasmtime-wast</code> crate to use the <code>json-from-wast</code> crate added in <a href=\"https://github.com/bytecodealliance/wasm-tools/issues/2247\">bytecodealliance/wasm-tools#2247</a> instead of the <code>wast</code> crate directly. The primary motivation for this PR is to make spec tests more suitable for running inside of Miri. There are two primary factors in how Miri is slow with wast tests today:</p>\n<ul>\n<li>\n<p>Compiling WebAssembly modules. These are all embedded throughout <code>*.wast</code> files and basically need to be precompiled to run in Miri.</p>\n</li>\n<li>\n<p>Parsing the <code>*.wast</code> script itself. The scripts are generally quite large in the upstream spec test suite and parsing the script requires parsing all modules as well, so this can take quite some time.</p>\n</li>\n</ul>\n<p>The goal of this commit was to leverage <code>json-from-wast</code> to perform much of the heavy lifting on the host and then have a \"cheap\" parse step in Miri which deserializes the JSON and runs precompiled <code>*.cwasm</code> files. The main change then required of <code>wasmtime-wast</code> was to use the JSON AST as its \"IR\" instead of <code>wast</code> directly. The actual transformation of the <code>wasmtime-wast</code> crate isn't too bad, mostly just some refactorings here and there.</p>\n<p>A new <code>./ci/miri-wast.sh</code> script is added which first runs on native with <code>wasmtime wast --precompile-save</code> and then runs in Miri with <code>wasmtime wast --precompile-load</code>. In this manner I was able to get a number of spec test <code>*.wast</code> files running in Miri.</p>\n<p>Unfortunately, though, Miri is still far too slow to run in CI. One major bottleneck is that the <code>*.json</code> files are pretty large and take a nontrivial amount of time to parse. Another issue is that these tests run a fair bit of code which with Miri's ~million-x slowdown. For the first problem I tried using other more-binary serialization formats but the JSON AST is unfortunately not compatible with many of them (e.g. <code>postcard</code>, which we use for Wasmtime, is not compatible with the JSON AST's structure in Rust types). For the latter I'm not sure what to do...</p>\n<p>In the end I figured this might be a reasonable refactoring to go ahead and land anyway. It at least enables running <code>*.wast</code> tests in Miri while removing a large part of the runtime slowdown. We can in theory still allow-list some tests to run as they don't all take forever. Some future breakthrough is still going to be required though to run everything through Miri.</p>\n<p>&lt;!--<br>\nPlease make sure you include the following information:</p>\n<ul>\n<li>\n<p>If this work has been discussed elsewhere, please include a link to that<br>\n  conversation. If it was discussed in an issue, just mention \"issue #...\".</p>\n</li>\n<li>\n<p>Explain why this change is needed. If the details are in an issue already,<br>\n  this can be brief.</p>\n</li>\n</ul>\n<p>Our development process is documented in the Wasmtime book:<br>\n<a href=\"https://docs.wasmtime.dev/contributing-development-process.html\">https://docs.wasmtime.dev/contributing-development-process.html</a></p>\n<p>Please ensure all communication follows the code of conduct:<br>\n<a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md\">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>\n--&gt;</p>\n</blockquote>",
        "id": 525403315,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1750710531
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11113#issuecomment-2997853226\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11113\">PR #11113</a>:</p>\n<blockquote>\n<p>My rough hope here is that we can at least use this to run scripts during development, but I'm also curious what others' thoughts on this are.</p>\n</blockquote>",
        "id": 525403358,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1750710551
    },
    {
        "content": "<p>github-actions[bot] <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11113#issuecomment-2998033814\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11113\">PR #11113</a>:</p>\n<blockquote>\n<h4>Subscribe to Label Action</h4>\n<p>cc @fitzgen</p>\n<p>&lt;details&gt;<br>\nThis issue or pull request has been labeled: \"fuzzing\"</p>\n<p>Thus the following users have been cc'd because of the following labels:</p>\n<ul>\n<li>fitzgen: fuzzing</li>\n</ul>\n<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>\n<p><a href=\"https://github.com/bytecodealliance/subscribe-to-label-action\">Learn more.</a><br>\n&lt;/details&gt;</p>\n</blockquote>",
        "id": 525411725,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1750715125
    },
    {
        "content": "<p>fitzgen submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11113#pullrequestreview-2954357298\">PR review</a>:</p>\n<blockquote>\n<p>In general, I like the approach.</p>\n<p>We can potentially try <code>bincode</code> or <code>peekpoke</code> or something for the serialization.</p>\n</blockquote>",
        "id": 525544227,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1750778887
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11113#discussion_r2164320586\">PR review comment</a>:</p>\n<blockquote>\n<p>Can you put a comment at the top with an example usage, showing the CLI args expected and all that?</p>\n</blockquote>",
        "id": 525544228,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1750778887
    },
    {
        "content": "<p>alexcrichton updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11113\">PR #11113</a>.</p>",
        "id": 531452019,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753733052
    },
    {
        "content": "<p>alexcrichton updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11113\">PR #11113</a>.</p>",
        "id": 531452204,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753733139
    },
    {
        "content": "<p>alexcrichton updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11113\">PR #11113</a>.</p>",
        "id": 531452333,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753733187
    },
    {
        "content": "<p><strong>alexcrichton</strong> has marked <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11113\">PR #11113</a> as ready for review.</p>",
        "id": 531452348,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753733191
    },
    {
        "content": "<p><strong>alexcrichton</strong> requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-fuzz-reviewers\">wasmtime-fuzz-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11113\">PR #11113</a>.</p>",
        "id": 531452354,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753733192
    },
    {
        "content": "<p><strong>alexcrichton</strong> requested <a href=\"https://github.com/fitzgen\">fitzgen</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11113\">PR #11113</a>.</p>",
        "id": 531452355,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753733192
    },
    {
        "content": "<p><strong>alexcrichton</strong> requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers\">wasmtime-compiler-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11113\">PR #11113</a>.</p>",
        "id": 531452357,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753733193
    },
    {
        "content": "<p><strong>alexcrichton</strong> requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers\">wasmtime-core-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11113\">PR #11113</a>.</p>",
        "id": 531452358,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753733193
    },
    {
        "content": "<p><strong>alexcrichton</strong> requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-default-reviewers\">wasmtime-default-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11113\">PR #11113</a>.</p>",
        "id": 531452359,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753733193
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11113#issuecomment-3129312770\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11113\">PR #11113</a>:</p>\n<blockquote>\n<p>Ok with the publication of wasm-tools this is now ready to go. I tried <code>bincode</code> and <code>postcard</code> but unfortunately neither works with the <code>#[serde]</code> attributes being used in <code>json-from-wast</code> which are done to match the <code>wast2json</code> output (mostly). This still ends up accelerating wast tests by a fair bit by skipping the whole compilation stage though, but there's still work to be done to improve the json parsing (or actually get it onto a binary format)</p>\n</blockquote>",
        "id": 531452518,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753733259
    },
    {
        "content": "<p>alexcrichton updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11113\">PR #11113</a>.</p>",
        "id": 531626530,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753799692
    },
    {
        "content": "<p>fitzgen submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11113#pullrequestreview-3068431870\">PR review</a>.</p>",
        "id": 531658421,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753808308
    },
    {
        "content": "<p>alexcrichton updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11113\">PR #11113</a>.</p>",
        "id": 531694728,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753821442
    },
    {
        "content": "<p>alexcrichton has enabled auto merge for <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11113\">PR #11113</a>.</p>",
        "id": 531694737,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753821448
    },
    {
        "content": "<p>alexcrichton has disabled auto merge for <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11113\">PR #11113</a>.</p>",
        "id": 531697850,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753822692
    },
    {
        "content": "<p>alexcrichton merged <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11113\">PR #11113</a>.</p>",
        "id": 531700424,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753823678
    }
]
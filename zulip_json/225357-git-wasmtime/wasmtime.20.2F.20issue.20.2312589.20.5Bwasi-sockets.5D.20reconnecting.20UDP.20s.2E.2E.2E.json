[
    {
        "content": "<p>dicej edited <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12589\">issue #12589</a>:</p>\n<blockquote>\n<p>I've been <a href=\"https://github.com/tokio-rs/mio/pull/1836\">adding WASIp2 support to <code>mio</code></a> and triaging failures in its test suite.  <a href=\"https://github.com/tokio-rs/mio/blob/66ac9fab79bf191218488c4f35c99d13935b7e12/tests/udp_socket.rs#L396\">This test</a> is failing, which I tracked down to <code>wasmtime-wasi</code> spuriously changing the local address of a UDP socket when <code>wasi:sockets/udp#udp-socket.stream</code> is called a second time on the same socket (equivalent to calling <code>connect(2)</code> a second time in POSIX).  The test fails because it uses the old local address, not realizing the socket suddenly has a new local address.</p>\n<p>Here's a minimal test case:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"c1\">// udp.rs</span>\n<span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"p\">::{</span><span class=\"n\">error</span><span class=\"p\">::</span><span class=\"n\">Error</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">net</span><span class=\"p\">::</span><span class=\"n\">UdpSocket</span><span class=\"p\">};</span>\n\n<span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"nb\">Box</span><span class=\"o\">&lt;</span><span class=\"k\">dyn</span><span class=\"w\"> </span><span class=\"n\">Error</span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">socket1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">UdpSocket</span><span class=\"p\">::</span><span class=\"n\">bind</span><span class=\"p\">(</span><span class=\"s\">\"127.0.0.1:0\"</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">socket2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">UdpSocket</span><span class=\"p\">::</span><span class=\"n\">bind</span><span class=\"p\">(</span><span class=\"s\">\"127.0.0.1:0\"</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">address1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">socket1</span><span class=\"p\">.</span><span class=\"n\">local_addr</span><span class=\"p\">()</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">address2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">socket2</span><span class=\"p\">.</span><span class=\"n\">local_addr</span><span class=\"p\">()</span><span class=\"o\">?</span><span class=\"p\">;</span>\n\n<span class=\"w\">    </span><span class=\"fm\">println!</span><span class=\"p\">(</span>\n<span class=\"w\">        </span><span class=\"s\">\"before:</span><span class=\"se\">\\n</span><span class=\"s\">  \\</span>\n<span class=\"s\">         socket1 local address: {address1:?}</span><span class=\"se\">\\n</span><span class=\"s\">  \\</span>\n<span class=\"s\">         socket2 local address: {address2:?}\"</span>\n<span class=\"w\">    </span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"n\">socket1</span><span class=\"p\">.</span><span class=\"n\">connect</span><span class=\"p\">(</span><span class=\"n\">address1</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">socket1</span><span class=\"p\">.</span><span class=\"n\">connect</span><span class=\"p\">(</span><span class=\"n\">address2</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">socket2</span><span class=\"p\">.</span><span class=\"n\">connect</span><span class=\"p\">(</span><span class=\"n\">address1</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n\n<span class=\"w\">    </span><span class=\"fm\">println!</span><span class=\"p\">(</span>\n<span class=\"w\">        </span><span class=\"s\">\"after:</span><span class=\"se\">\\n</span><span class=\"s\">  \\</span>\n<span class=\"s\">         socket1 local address: {address1:?} remote address: {remote1:?}</span><span class=\"se\">\\n</span><span class=\"s\">  \\</span>\n<span class=\"s\">         socket2 local address: {address2:?} remote address: {remote2:?}\"</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"n\">address1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">socket1</span><span class=\"p\">.</span><span class=\"n\">local_addr</span><span class=\"p\">()</span><span class=\"o\">?</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"n\">address2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">socket2</span><span class=\"p\">.</span><span class=\"n\">local_addr</span><span class=\"p\">()</span><span class=\"o\">?</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"n\">remote1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">socket1</span><span class=\"p\">.</span><span class=\"n\">peer_addr</span><span class=\"p\">()</span><span class=\"o\">?</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"n\">remote2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">socket2</span><span class=\"p\">.</span><span class=\"n\">peer_addr</span><span class=\"p\">()</span><span class=\"o\">?</span>\n<span class=\"w\">    </span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s\">b\"foobar\"</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">socket1</span><span class=\"p\">.</span><span class=\"n\">send</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">buffer</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"k\">u8</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"mi\">20</span><span class=\"p\">];</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">count</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">socket2</span><span class=\"p\">.</span><span class=\"n\">recv</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">buffer</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n\n<span class=\"w\">    </span><span class=\"fm\">assert_eq!</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">buffer</span><span class=\"p\">[</span><span class=\"o\">..</span><span class=\"n\">count</span><span class=\"p\">]);</span>\n\n<span class=\"w\">    </span><span class=\"fm\">println!</span><span class=\"p\">(</span><span class=\"s\">\"success!\"</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"nb\">Ok</span><span class=\"p\">(())</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>If you build and run that natively on e.g. Linux using <code>rustc udp.rs &amp;&amp; ./udp</code>, you'll see it succeed, with <code>socket1</code>'s local address remaining unchanged before and after the <code>UdpSocket::connect</code> calls.</p>\n<p>If you build and run for WASIp2 using <code>rustc --target=wasm32-wasip2 udp.rs &amp;&amp; wasmtime run -Sudp,inherit-network udp.wasm</code>, you'll see it hang indefinitely due to <code>socket1</code>'s local address changing due to the second <code>UdpSocket::connect</code> call.</p>\n<p>While digging into this, I found that <code>wasmtime-wasi</code> proactively disconnects the socket by calling <code>rustix::net::connect_unspec</code> prior to reconnecting.  When I comment out that code, the issue is fixed:</p>\n<div class=\"codehilite\" data-code-language=\"Diff\"><pre><span></span><code><span class=\"gh\">diff --git a/crates/wasi/src/p2/host/udp.rs b/crates/wasi/src/p2/host/udp.rs</span>\n<span class=\"gh\">index 1ef8350399..5dd426e736 100644</span>\n<span class=\"gd\">--- a/crates/wasi/src/p2/host/udp.rs</span>\n<span class=\"gi\">+++ b/crates/wasi/src/p2/host/udp.rs</span>\n<span class=\"gu\">@@ -71,9 +71,9 @@ impl udp::HostUdpSocket for WasiSocketsCtxView&lt;'_&gt; {</span>\n<span class=\"w\"> </span>        //   if there isn't a disconnect in between.\n\n<span class=\"w\"> </span>        // Step #1: Disconnect\n<span class=\"gd\">-        if socket.is_connected() {</span>\n<span class=\"gd\">-            socket.disconnect()?;</span>\n<span class=\"gd\">-        }</span>\n<span class=\"gi\">+        // if socket.is_connected() {</span>\n<span class=\"gi\">+        //     socket.disconnect()?;</span>\n<span class=\"gi\">+        // }</span>\n\n<span class=\"w\"> </span>        // Step #2: (Re)connect\n<span class=\"w\"> </span>        if let Some(connect_addr) = remote_address {\n<span class=\"gh\">diff --git a/crates/wasi/src/sockets/udp.rs b/crates/wasi/src/sockets/udp.rs</span>\n<span class=\"gh\">index 482c6aa090..ba1e93f18d 100644</span>\n<span class=\"gd\">--- a/crates/wasi/src/sockets/udp.rs</span>\n<span class=\"gi\">+++ b/crates/wasi/src/sockets/udp.rs</span>\n<span class=\"gu\">@@ -162,10 +162,10 @@ impl UdpSocket {</span>\n<span class=\"w\"> </span>        //   if there isn't a disconnect in between.\n\n<span class=\"w\"> </span>        // Step #1: Disconnect\n<span class=\"gd\">-        if let UdpState::Connected(..) = self.udp_state {</span>\n<span class=\"gd\">-            udp_disconnect(&amp;self.socket)?;</span>\n<span class=\"gd\">-            self.udp_state = UdpState::Bound;</span>\n<span class=\"gd\">-        }</span>\n<span class=\"gi\">+        // if let UdpState::Connected(..) = self.udp_state {</span>\n<span class=\"gi\">+        //     udp_disconnect(&amp;self.socket)?;</span>\n<span class=\"gi\">+        //     self.udp_state = UdpState::Bound;</span>\n<span class=\"gi\">+        // }</span>\n<span class=\"w\"> </span>        // Step #2: (Re)connect\n<span class=\"w\"> </span>        connect(&amp;self.socket, &amp;addr).map_err(|error| match error {\n<span class=\"w\"> </span>            Errno::AFNOSUPPORT =&gt; ErrorCode::InvalidArgument, // See `udp_bind` implementation.\n</code></pre></div>\n<p>However, per the surrounding comments, that code is there for a reason, so I assume that removing it isn't the right solution.  @badeend this seems to be related to <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7411\">https://github.com/bytecodealliance/wasmtime/pull/7411</a>, so perhaps you have thoughts?</p>\n</blockquote>",
        "id": 573826475,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1771016157
    },
    {
        "content": "<p><a href=\"https://github.com/dicej\">dicej</a> added the bug label to <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12589\">Issue #12589</a>.</p>",
        "id": 573826529,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1771016181
    },
    {
        "content": "<p>badeend <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12589#issuecomment-3899721453\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12589\">issue #12589</a>:</p>\n<blockquote>\n<p>Every call to <code>udp-socket::connect</code> is allowed to change the local socket address. This is documented on the method itself: <a href=\"https://github.com/WebAssembly/WASI/blob/41d0de898ec7568e032129156a3bc567d7ebea5d/proposals/sockets/wit-0.3.0-draft/types.wit#L547-L550\">https://github.com/WebAssembly/WASI/blob/41d0de898ec7568e032129156a3bc567d7ebea5d/proposals/sockets/wit-0.3.0-draft/types.wit#L547-L550</a></p>\n<p>AFAIK, this is standard POSIX behavior. Are you sure you're testing exactly the same code as the mio test? Because the mio test you linked reads: (no local address rebinding)</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">    </span><span class=\"n\">socket1</span><span class=\"p\">.</span><span class=\"n\">connect</span><span class=\"p\">(</span><span class=\"n\">address2</span><span class=\"p\">).</span><span class=\"n\">unwrap</span><span class=\"p\">();</span>\n<span class=\"w\">    </span><span class=\"n\">socket2</span><span class=\"p\">.</span><span class=\"n\">connect</span><span class=\"p\">(</span><span class=\"n\">address1</span><span class=\"p\">).</span><span class=\"n\">unwrap</span><span class=\"p\">();</span>\n<span class=\"w\">    </span><span class=\"n\">socket3</span><span class=\"p\">.</span><span class=\"n\">connect</span><span class=\"p\">(</span><span class=\"n\">address1</span><span class=\"p\">).</span><span class=\"n\">unwrap</span><span class=\"p\">();</span>\n</code></pre></div>\n<p>whereas the code snippet you posted rebinds <code>socket1</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">    </span><span class=\"n\">socket1</span><span class=\"p\">.</span><span class=\"n\">connect</span><span class=\"p\">(</span><span class=\"n\">address1</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">socket1</span><span class=\"p\">.</span><span class=\"n\">connect</span><span class=\"p\">(</span><span class=\"n\">address2</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">socket2</span><span class=\"p\">.</span><span class=\"n\">connect</span><span class=\"p\">(</span><span class=\"n\">address1</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n</code></pre></div>\n</blockquote>",
        "id": 573833930,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1771019731
    },
    {
        "content": "<p>dicej <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12589#issuecomment-3899885205\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12589\">issue #12589</a>:</p>\n<blockquote>\n<blockquote>\n<p>Are you sure you're testing exactly the same code as the mio test?</p>\n</blockquote>\n<p>No, it's not exactly the same; I reduced the <code>mio</code> test to a minimal reproduction.  Note that the <code>mio</code> test _does_ call <code>connect</code> twice on <code>socket1</code>: scroll down to <a href=\"https://github.com/tokio-rs/mio/blob/66ac9fab79bf191218488c4f35c99d13935b7e12/tests/udp_socket.rs#L442\">https://github.com/tokio-rs/mio/blob/66ac9fab79bf191218488c4f35c99d13935b7e12/tests/udp_socket.rs#L442</a></p>\n</blockquote>",
        "id": 573837393,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1771021637
    },
    {
        "content": "<p>dicej <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12589#issuecomment-3899914511\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12589\">issue #12589</a>:</p>\n<blockquote>\n<p>BTW, if POSIX allows <code>connect</code> to change the local address, then the <code>mio</code> test is just wrong, and I can submit a PR to fix it (e.g. by calling <code>socket3.connect(socket1.local_addr().unwrap()).unwrap()</code> after the <code>socket1.connect(address3).unwrap()</code> line).  It would help to have a document to reference to justify that, though, since apparently WASI is the only platform where the test currently fails.</p>\n</blockquote>",
        "id": 573837936,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1771021944
    },
    {
        "content": "<p>dicej <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12589#issuecomment-3899928689\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12589\">issue #12589</a>:</p>\n<blockquote>\n<blockquote>\n<p>(e.g. by calling <code>socket3.connect(socket1.local_addr().unwrap()).unwrap()</code> after the <code>socket1.connect(address3).unwrap()</code> line)</p>\n</blockquote>\n<p>Oof, actually not sure that would work, because then <code>socket3</code>'s local address could change.  So I guess I'm not even sure how I would fix it, since every call to <code>connect</code> would invalidate the local address previously used.</p>\n</blockquote>",
        "id": 573838229,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1771022138
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12589#issuecomment-3900032998\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12589\">issue #12589</a>:</p>\n<blockquote>\n<p>@badeend do you have further links for where the clause you linked in the WASI docs come from? Naively to me that seems pretty surprising that <code>connect</code> can arbitrarily change the locally bound address, so I'd be curious to read up more there. Is this something, for example, where platforms disagree on behavior and WASI is specifying a sort of least-common-denominator semantics?</p>\n</blockquote>",
        "id": 573841281,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1771024214
    },
    {
        "content": "<p>dicej edited a <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12589#issuecomment-3899928689\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12589\">issue #12589</a>:</p>\n<blockquote>\n<blockquote>\n<p>(e.g. by calling <code>socket3.connect(socket1.local_addr().unwrap()).unwrap()</code> after the <code>socket1.connect(address3).unwrap()</code> line)</p>\n</blockquote>\n<p>Oof, actually not sure that would work, because then <code>socket3</code>'s local address could change.  So I guess I'm not even sure how I would fix it, since every call to <code>connect</code> could invalidate the local address previously used.</p>\n</blockquote>",
        "id": 573842883,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1771025330
    },
    {
        "content": "<p>badeend <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12589#issuecomment-3902108561\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12589\">issue #12589</a>:</p>\n<blockquote>\n<blockquote>\n<p>to me that seems pretty surprising that connect can arbitrarily change the locally bound address</p>\n</blockquote>\n<p>Yes, it is surprising, and Yes it does happen :P But only if the socket wasn't bound to a specific address/port.</p>\n<p>Let's say, the first connect is to <code>127.0.0.1</code>. The socket's local address will become some address on the loopback interface. Most likely, also <code>127.0.0.1</code>.</p>\n<p>Then, the same socket is reused to connect to <code>123.234.12.34</code>. The loopback interface has no network path to that remote, so the local binding has to change in order to do something useful. On my machine (example below) that is <code>192.168.178.13</code> (windows), <code>172.22.83.10</code> (linux)</p>\n<hr>\n<p>I was not able to find any authoritative documentation describing this in detail, or: at all. The current WASI spec is purely based on observed behavior. </p>\n<p>To make sure I'm not going mad, I just ran <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12595/changes#diff-0dc06545bd7eb62d95d41039d419c576f0243f6850d45bdc46343ee83e0de5ba\">this test</a> twice on Windows and Linux; once with wasmtime as-is (_with_ the explicit disconnect), and once with the disconnect commented out:</p>\n<h5>Windows _with_ disconnect</h5>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"p\">#</span><span class=\"mf\">1.</span><span class=\"w\"> </span><span class=\"n\">connect</span><span class=\"p\">(</span><span class=\"w\">    </span><span class=\"mf\">127.0.0.1</span><span class=\"p\">:</span><span class=\"mi\">4321</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">changed</span><span class=\"w\"> </span><span class=\"n\">local</span><span class=\"w\"> </span><span class=\"n\">address</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"p\">:</span><span class=\"w\">      </span><span class=\"mf\">127.0.0.1</span><span class=\"p\">:</span><span class=\"mi\">64916</span>\n<span class=\"p\">#</span><span class=\"mf\">2.</span><span class=\"w\"> </span><span class=\"n\">connect</span><span class=\"p\">(</span><span class=\"w\">    </span><span class=\"mf\">127.0.0.1</span><span class=\"p\">:</span><span class=\"mi\">4322</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">changed</span><span class=\"w\"> </span><span class=\"n\">local</span><span class=\"w\"> </span><span class=\"n\">address</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"p\">:</span><span class=\"w\">      </span><span class=\"mf\">127.0.0.1</span><span class=\"p\">:</span><span class=\"mi\">64916</span>\n<span class=\"p\">#</span><span class=\"mf\">3.</span><span class=\"w\"> </span><span class=\"n\">connect</span><span class=\"p\">(</span><span class=\"mf\">123.234.12.34</span><span class=\"p\">:</span><span class=\"mi\">4323</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">changed</span><span class=\"w\"> </span><span class=\"n\">local</span><span class=\"w\"> </span><span class=\"n\">address</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mf\">192.168.178.13</span><span class=\"p\">:</span><span class=\"mi\">64916</span>\n</code></pre></div>\n<h5>Windows _without_ disconnect</h5>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"p\">#</span><span class=\"mf\">1.</span><span class=\"w\"> </span><span class=\"n\">connect</span><span class=\"p\">(</span><span class=\"w\">    </span><span class=\"mf\">127.0.0.1</span><span class=\"p\">:</span><span class=\"mi\">4321</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">changed</span><span class=\"w\"> </span><span class=\"n\">local</span><span class=\"w\"> </span><span class=\"n\">address</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"p\">:</span><span class=\"w\">      </span><span class=\"mf\">127.0.0.1</span><span class=\"p\">:</span><span class=\"mi\">61198</span>\n<span class=\"p\">#</span><span class=\"mf\">2.</span><span class=\"w\"> </span><span class=\"n\">connect</span><span class=\"p\">(</span><span class=\"w\">    </span><span class=\"mf\">127.0.0.1</span><span class=\"p\">:</span><span class=\"mi\">4322</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">changed</span><span class=\"w\"> </span><span class=\"n\">local</span><span class=\"w\"> </span><span class=\"n\">address</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"p\">:</span><span class=\"w\">      </span><span class=\"mf\">127.0.0.1</span><span class=\"p\">:</span><span class=\"mi\">61198</span>\n<span class=\"p\">#</span><span class=\"mf\">3.</span><span class=\"w\"> </span><span class=\"n\">connect</span><span class=\"p\">(</span><span class=\"mf\">123.234.12.34</span><span class=\"p\">:</span><span class=\"mi\">4323</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">changed</span><span class=\"w\"> </span><span class=\"n\">local</span><span class=\"w\"> </span><span class=\"n\">address</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mf\">192.168.178.13</span><span class=\"p\">:</span><span class=\"mi\">61198</span>\n</code></pre></div>\n<h5>Linux _with_ disconnect</h5>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"p\">#</span><span class=\"mf\">1.</span><span class=\"w\"> </span><span class=\"n\">connect</span><span class=\"p\">(</span><span class=\"w\">    </span><span class=\"mf\">127.0.0.1</span><span class=\"p\">:</span><span class=\"mi\">4321</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">changed</span><span class=\"w\"> </span><span class=\"n\">local</span><span class=\"w\"> </span><span class=\"n\">address</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"p\">:</span><span class=\"w\">      </span><span class=\"mf\">127.0.0.1</span><span class=\"p\">:</span><span class=\"mi\">37851</span>\n<span class=\"p\">#</span><span class=\"mf\">2.</span><span class=\"w\"> </span><span class=\"n\">connect</span><span class=\"p\">(</span><span class=\"w\">    </span><span class=\"mf\">127.0.0.1</span><span class=\"p\">:</span><span class=\"mi\">4322</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">changed</span><span class=\"w\"> </span><span class=\"n\">local</span><span class=\"w\"> </span><span class=\"n\">address</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"p\">:</span><span class=\"w\">      </span><span class=\"mf\">127.0.0.1</span><span class=\"p\">:</span><span class=\"mi\">44532</span>\n<span class=\"p\">#</span><span class=\"mf\">3.</span><span class=\"w\"> </span><span class=\"n\">connect</span><span class=\"p\">(</span><span class=\"mf\">123.234.12.34</span><span class=\"p\">:</span><span class=\"mi\">4323</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">changed</span><span class=\"w\"> </span><span class=\"n\">local</span><span class=\"w\"> </span><span class=\"n\">address</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mf\">172.22.83.10</span><span class=\"p\">:</span><span class=\"mi\">49662</span>\n</code></pre></div>\n<h5>Linux _without_ disconnect</h5>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"p\">#</span><span class=\"mf\">1.</span><span class=\"w\"> </span><span class=\"n\">connect</span><span class=\"p\">(</span><span class=\"w\">    </span><span class=\"mf\">127.0.0.1</span><span class=\"p\">:</span><span class=\"mi\">4321</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">changed</span><span class=\"w\"> </span><span class=\"n\">local</span><span class=\"w\"> </span><span class=\"n\">address</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"p\">:</span><span class=\"w\">      </span><span class=\"mf\">127.0.0.1</span><span class=\"p\">:</span><span class=\"mi\">32810</span>\n<span class=\"p\">#</span><span class=\"mf\">2.</span><span class=\"w\"> </span><span class=\"n\">connect</span><span class=\"p\">(</span><span class=\"w\">    </span><span class=\"mf\">127.0.0.1</span><span class=\"p\">:</span><span class=\"mi\">4322</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">changed</span><span class=\"w\"> </span><span class=\"n\">local</span><span class=\"w\"> </span><span class=\"n\">address</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"p\">:</span><span class=\"w\">      </span><span class=\"mf\">127.0.0.1</span><span class=\"p\">:</span><span class=\"mi\">32810</span>\n<span class=\"p\">#</span><span class=\"mf\">3.</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"n\">connect</span><span class=\"w\"> </span><span class=\"n\">fails</span><span class=\"w\"> </span><span class=\"n\">with</span><span class=\"w\"> </span><span class=\"n\">EINVAL</span><span class=\"o\">&gt;&gt;</span>\n</code></pre></div>\n<p>Notes:</p>\n<ul>\n<li>Even without an explicit disconnect, Windows automatically adjusts the local binding when the remote requires a different interface.</li>\n<li>Windows preserves the local port across disconnects.</li>\n<li>Windows does not require the explicit disconnect; behavior is identical either way.</li>\n<li>From recollection, MacOS behaves the same as Windows. But I don't have a Mac machine to verify.</li>\n<li>Linux allocates a new ephemeral port when disconnecting.</li>\n<li>Linux returns <code>EINVAL</code> if the existing local binding is not suitable for the new remote. This appears to be Linux-specific and is the reason wasmtime currently performs the explicit disconnect.</li>\n</ul>\n<hr>\n<blockquote>\n<p>if POSIX allows connect to change the local address, then the mio test is just wrong,</p>\n</blockquote>\n<p>Their test consistently passes on major platforms, so it is not obviously incorrect. However, it does rely on behavior that is not strictly guaranteed. With the specific parameters they use, that behavior just happens to be stable across current platforms.</p>\n<p>My takeaways:</p>\n<ul>\n<li>The <a href=\"https://github.com/WebAssembly/WASI/blob/41d0de898ec7568e032129156a3bc567d7ebea5d/proposals/sockets/wit-0.3.0-draft/types.wit#L547-L550\">wasi:sockets documentation</a> is indeed correct. But now we know for sure :P </li>\n<li>If a program depends on a stable local socket address, they should explicitly <code>bind</code> the socket instead of relying on undocumented behavior. That sidesteps all these problems.</li>\n<li>This problem surfaces in wasmtime because we pre-emptively disconnect the socket. We could change this to first optimistically attempt the connect syscall, and only if that fails retry with the disconnect/reconnect dance. On Linux this changes the outcome of the test to:</li>\n</ul>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"p\">#</span><span class=\"mf\">1.</span><span class=\"w\"> </span><span class=\"n\">connect</span><span class=\"p\">(</span><span class=\"w\">    </span><span class=\"mf\">127.0.0.1</span><span class=\"p\">:</span><span class=\"mi\">4321</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">changed</span><span class=\"w\"> </span><span class=\"n\">local</span><span class=\"w\"> </span><span class=\"n\">address</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"p\">:</span><span class=\"w\">    </span><span class=\"mf\">127.0.0.1</span><span class=\"p\">:</span><span class=\"mi\">37494</span>\n<span class=\"p\">#</span><span class=\"mf\">2.</span><span class=\"w\"> </span><span class=\"n\">connect</span><span class=\"p\">(</span><span class=\"w\">    </span><span class=\"mf\">127.0.0.1</span><span class=\"p\">:</span><span class=\"mi\">4322</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">changed</span><span class=\"w\"> </span><span class=\"n\">local</span><span class=\"w\"> </span><span class=\"n\">address</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"p\">:</span><span class=\"w\">    </span><span class=\"mf\">127.0.0.1</span><span class=\"p\">:</span><span class=\"mi\">37494</span>\n<span class=\"p\">#</span><span class=\"mf\">3.</span><span class=\"w\"> </span><span class=\"n\">connect</span><span class=\"p\">(</span><span class=\"mf\">123.234.12.34</span><span class=\"p\">:</span><span class=\"mi\">4323</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">changed</span><span class=\"w\"> </span><span class=\"n\">local</span><span class=\"w\"> </span><span class=\"n\">address</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mf\">172.22.83.10</span><span class=\"p\">:</span><span class=\"mi\">33292</span>\n</code></pre></div>\n<p>This likely restores the behavior expected by the mio test while still handling the Linux EINVAL case when necessary.</p>\n<p>I've opened <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12595\">https://github.com/bytecodealliance/wasmtime/pull/12595</a> as a potential fix.</p>\n</blockquote>",
        "id": 573908565,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1771085253
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12589#issuecomment-3902490045\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12589\">issue #12589</a>:</p>\n<blockquote>\n<p>Oh wow that's fascinating! Thanks so much for taking the time to test and investigate this, and I agree that #12595 is the way to go here. Definitely  learn something new every day :)</p>\n</blockquote>",
        "id": 573925538,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1771101823
    },
    {
        "content": "<p>dicej closed <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12589\">issue #12589</a>:</p>\n<blockquote>\n<p>I've been <a href=\"https://github.com/tokio-rs/mio/pull/1836\">adding WASIp2 support to <code>mio</code></a> and triaging failures in its test suite.  <a href=\"https://github.com/tokio-rs/mio/blob/66ac9fab79bf191218488c4f35c99d13935b7e12/tests/udp_socket.rs#L396\">This test</a> is failing, which I tracked down to <code>wasmtime-wasi</code> spuriously changing the local address of a UDP socket when <code>wasi:sockets/udp#udp-socket.stream</code> is called a second time on the same socket (equivalent to calling <code>connect(2)</code> a second time in POSIX).  The test fails because it uses the old local address, not realizing the socket suddenly has a new local address.</p>\n<p>Here's a minimal test case:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"c1\">// udp.rs</span>\n<span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"p\">::{</span><span class=\"n\">error</span><span class=\"p\">::</span><span class=\"n\">Error</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">net</span><span class=\"p\">::</span><span class=\"n\">UdpSocket</span><span class=\"p\">};</span>\n\n<span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"nb\">Box</span><span class=\"o\">&lt;</span><span class=\"k\">dyn</span><span class=\"w\"> </span><span class=\"n\">Error</span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">socket1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">UdpSocket</span><span class=\"p\">::</span><span class=\"n\">bind</span><span class=\"p\">(</span><span class=\"s\">\"127.0.0.1:0\"</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">socket2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">UdpSocket</span><span class=\"p\">::</span><span class=\"n\">bind</span><span class=\"p\">(</span><span class=\"s\">\"127.0.0.1:0\"</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">address1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">socket1</span><span class=\"p\">.</span><span class=\"n\">local_addr</span><span class=\"p\">()</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">address2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">socket2</span><span class=\"p\">.</span><span class=\"n\">local_addr</span><span class=\"p\">()</span><span class=\"o\">?</span><span class=\"p\">;</span>\n\n<span class=\"w\">    </span><span class=\"fm\">println!</span><span class=\"p\">(</span>\n<span class=\"w\">        </span><span class=\"s\">\"before:</span><span class=\"se\">\\n</span><span class=\"s\">  \\</span>\n<span class=\"s\">         socket1 local address: {address1:?}</span><span class=\"se\">\\n</span><span class=\"s\">  \\</span>\n<span class=\"s\">         socket2 local address: {address2:?}\"</span>\n<span class=\"w\">    </span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"n\">socket1</span><span class=\"p\">.</span><span class=\"n\">connect</span><span class=\"p\">(</span><span class=\"n\">address1</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">socket1</span><span class=\"p\">.</span><span class=\"n\">connect</span><span class=\"p\">(</span><span class=\"n\">address2</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">socket2</span><span class=\"p\">.</span><span class=\"n\">connect</span><span class=\"p\">(</span><span class=\"n\">address1</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n\n<span class=\"w\">    </span><span class=\"fm\">println!</span><span class=\"p\">(</span>\n<span class=\"w\">        </span><span class=\"s\">\"after:</span><span class=\"se\">\\n</span><span class=\"s\">  \\</span>\n<span class=\"s\">         socket1 local address: {address1:?} remote address: {remote1:?}</span><span class=\"se\">\\n</span><span class=\"s\">  \\</span>\n<span class=\"s\">         socket2 local address: {address2:?} remote address: {remote2:?}\"</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"n\">address1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">socket1</span><span class=\"p\">.</span><span class=\"n\">local_addr</span><span class=\"p\">()</span><span class=\"o\">?</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"n\">address2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">socket2</span><span class=\"p\">.</span><span class=\"n\">local_addr</span><span class=\"p\">()</span><span class=\"o\">?</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"n\">remote1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">socket1</span><span class=\"p\">.</span><span class=\"n\">peer_addr</span><span class=\"p\">()</span><span class=\"o\">?</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"n\">remote2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">socket2</span><span class=\"p\">.</span><span class=\"n\">peer_addr</span><span class=\"p\">()</span><span class=\"o\">?</span>\n<span class=\"w\">    </span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s\">b\"foobar\"</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">socket1</span><span class=\"p\">.</span><span class=\"n\">send</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">buffer</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"k\">u8</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"mi\">20</span><span class=\"p\">];</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">count</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">socket2</span><span class=\"p\">.</span><span class=\"n\">recv</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">buffer</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n\n<span class=\"w\">    </span><span class=\"fm\">assert_eq!</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">buffer</span><span class=\"p\">[</span><span class=\"o\">..</span><span class=\"n\">count</span><span class=\"p\">]);</span>\n\n<span class=\"w\">    </span><span class=\"fm\">println!</span><span class=\"p\">(</span><span class=\"s\">\"success!\"</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"nb\">Ok</span><span class=\"p\">(())</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>If you build and run that natively on e.g. Linux using <code>rustc udp.rs &amp;&amp; ./udp</code>, you'll see it succeed, with <code>socket1</code>'s local address remaining unchanged before and after the <code>UdpSocket::connect</code> calls.</p>\n<p>If you build and run for WASIp2 using <code>rustc --target=wasm32-wasip2 udp.rs &amp;&amp; wasmtime run -Sudp,inherit-network udp.wasm</code>, you'll see it hang indefinitely due to <code>socket1</code>'s local address changing due to the second <code>UdpSocket::connect</code> call.</p>\n<p>While digging into this, I found that <code>wasmtime-wasi</code> proactively disconnects the socket by calling <code>rustix::net::connect_unspec</code> prior to reconnecting.  When I comment out that code, the issue is fixed:</p>\n<div class=\"codehilite\" data-code-language=\"Diff\"><pre><span></span><code><span class=\"gh\">diff --git a/crates/wasi/src/p2/host/udp.rs b/crates/wasi/src/p2/host/udp.rs</span>\n<span class=\"gh\">index 1ef8350399..5dd426e736 100644</span>\n<span class=\"gd\">--- a/crates/wasi/src/p2/host/udp.rs</span>\n<span class=\"gi\">+++ b/crates/wasi/src/p2/host/udp.rs</span>\n<span class=\"gu\">@@ -71,9 +71,9 @@ impl udp::HostUdpSocket for WasiSocketsCtxView&lt;'_&gt; {</span>\n<span class=\"w\"> </span>        //   if there isn't a disconnect in between.\n\n<span class=\"w\"> </span>        // Step #1: Disconnect\n<span class=\"gd\">-        if socket.is_connected() {</span>\n<span class=\"gd\">-            socket.disconnect()?;</span>\n<span class=\"gd\">-        }</span>\n<span class=\"gi\">+        // if socket.is_connected() {</span>\n<span class=\"gi\">+        //     socket.disconnect()?;</span>\n<span class=\"gi\">+        // }</span>\n\n<span class=\"w\"> </span>        // Step #2: (Re)connect\n<span class=\"w\"> </span>        if let Some(connect_addr) = remote_address {\n<span class=\"gh\">diff --git a/crates/wasi/src/sockets/udp.rs b/crates/wasi/src/sockets/udp.rs</span>\n<span class=\"gh\">index 482c6aa090..ba1e93f18d 100644</span>\n<span class=\"gd\">--- a/crates/wasi/src/sockets/udp.rs</span>\n<span class=\"gi\">+++ b/crates/wasi/src/sockets/udp.rs</span>\n<span class=\"gu\">@@ -162,10 +162,10 @@ impl UdpSocket {</span>\n<span class=\"w\"> </span>        //   if there isn't a disconnect in between.\n\n<span class=\"w\"> </span>        // Step #1: Disconnect\n<span class=\"gd\">-        if let UdpState::Connected(..) = self.udp_state {</span>\n<span class=\"gd\">-            udp_disconnect(&amp;self.socket)?;</span>\n<span class=\"gd\">-            self.udp_state = UdpState::Bound;</span>\n<span class=\"gd\">-        }</span>\n<span class=\"gi\">+        // if let UdpState::Connected(..) = self.udp_state {</span>\n<span class=\"gi\">+        //     udp_disconnect(&amp;self.socket)?;</span>\n<span class=\"gi\">+        //     self.udp_state = UdpState::Bound;</span>\n<span class=\"gi\">+        // }</span>\n<span class=\"w\"> </span>        // Step #2: (Re)connect\n<span class=\"w\"> </span>        connect(&amp;self.socket, &amp;addr).map_err(|error| match error {\n<span class=\"w\"> </span>            Errno::AFNOSUPPORT =&gt; ErrorCode::InvalidArgument, // See `udp_bind` implementation.\n</code></pre></div>\n<p>However, per the surrounding comments, that code is there for a reason, so I assume that removing it isn't the right solution.  @badeend this seems to be related to <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7411\">https://github.com/bytecodealliance/wasmtime/pull/7411</a>, so perhaps you have thoughts?</p>\n</blockquote>",
        "id": 574022556,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1771205856
    },
    {
        "content": "<p>badeend <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12589#issuecomment-3909992237\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12589\">issue #12589</a>:</p>\n<blockquote>\n<blockquote>\n<p>From recollection, MacOS behaves the same as Windows. But I don't have a Mac machine to verify.</p>\n</blockquote>\n<p>For posterity; the PR passed CI without special considerations for MacOS. This implies that it indeed behaves the same as Windows.</p>\n</blockquote>",
        "id": 574166805,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1771267208
    },
    {
        "content": "<p>badeend <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12589#issuecomment-3910356065\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12589\">issue #12589</a>:</p>\n<blockquote>\n<p>So... fun fact. The same thing happens on TCP sockets as well. :monocle_face:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">client</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">TcpSocket</span><span class=\"p\">::</span><span class=\"n\">create</span><span class=\"p\">(</span><span class=\"n\">family</span><span class=\"p\">).</span><span class=\"n\">unwrap</span><span class=\"p\">();</span>\n<span class=\"n\">client</span><span class=\"p\">.</span><span class=\"n\">bind</span><span class=\"p\">(</span><span class=\"n\">IpSocketAddress</span><span class=\"p\">::</span><span class=\"n\">new</span><span class=\"p\">(</span><span class=\"n\">IpAddress</span><span class=\"p\">::</span><span class=\"n\">new_unspecified</span><span class=\"p\">(</span><span class=\"n\">family</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">)).</span><span class=\"n\">unwrap</span><span class=\"p\">();</span>\n<span class=\"fm\">println!</span><span class=\"p\">(</span><span class=\"s\">\"local address: {:?}\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">client</span><span class=\"p\">.</span><span class=\"n\">get_local_address</span><span class=\"p\">().</span><span class=\"n\">unwrap</span><span class=\"p\">());</span>\n<span class=\"n\">client</span><span class=\"p\">.</span><span class=\"n\">connect</span><span class=\"p\">(</span><span class=\"n\">listener_address</span><span class=\"p\">).</span><span class=\"k\">await</span><span class=\"p\">.</span><span class=\"n\">unwrap</span><span class=\"p\">();</span>\n<span class=\"fm\">println!</span><span class=\"p\">(</span><span class=\"s\">\"local address: {:?}\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">client</span><span class=\"p\">.</span><span class=\"n\">get_local_address</span><span class=\"p\">().</span><span class=\"n\">unwrap</span><span class=\"p\">());</span>\n</code></pre></div>\n<p>prints:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">local</span><span class=\"w\"> </span><span class=\"n\">address</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mf\">0.0.0.0</span><span class=\"p\">:</span><span class=\"mi\">36431</span>\n<span class=\"n\">local</span><span class=\"w\"> </span><span class=\"n\">address</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mf\">127.0.0.1</span><span class=\"p\">:</span><span class=\"mi\">36431</span>\n</code></pre></div>\n<p>I've opened <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12601\">https://github.com/bytecodealliance/wasmtime/pull/12601</a> to test this</p>\n</blockquote>",
        "id": 574177701,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1771272783
    }
]
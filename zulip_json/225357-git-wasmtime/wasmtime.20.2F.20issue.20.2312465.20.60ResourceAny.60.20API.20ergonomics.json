[
    {
        "content": "<p>crepererum opened <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12465\">issue #12465</a>:</p>\n<blockquote>\n<h4>Feature</h4>\n<p><code>ResourceAny</code> is in the component model, both when the guest returns resources but also when <code>borrow&lt;...&gt;</code> resources are passed to the guest. The <code>ResourceAny</code> type <code>Copy</code>able handle and is usually passed by value. To destroy a resource <code>resource_drop[_async]</code> is called. Since the handle itself is <code>Copy</code>, you may still have copies of that handle around. Accidently reusing the handle results in:</p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>host-owned resource is being used with the wrong type\n</code></pre></div>\n<p>as this test shows:</p>\n<p><a href=\"https://github.com/bytecodealliance/wasmtime/blob/23c0f09d0ba1041fc300bc4aabada0ded783c538/tests/all/component_model/resources.rs#L181-L203\">https://github.com/bytecodealliance/wasmtime/blob/23c0f09d0ba1041fc300bc4aabada0ded783c538/tests/all/component_model/resources.rs#L181-L203</a></p>\n<p>Now there are two DX issues here:</p>\n<ul>\n<li>the error message is somewhat misleading (it actually even happens when you allocate the same resource type into the slot, i.e. if the test would have used <code>t1</code> &amp; <code>t1</code> instead of <code>t</code> and <code>u</code>)</li>\n<li>since the handle doesn't have any form of refcounting, it is hard to enforce a \"don't reuse a de-allocated resource\" in a codebase esp. since <code>ResourceAny</code> is <code>Copy</code> and is often passed by value, hence you cannot really build a strong ref-count guard around it</li>\n</ul>\n<h4>Benefit</h4>\n<p>Improving the situation may prevent certain \"used after free\" bugs (even though they don't panic or SEGFAULT, they are still not great)</p>\n<h4>Implementation</h4>\n<p>Ideally <code>ResourceAny</code> wouldn't be <code>Copy</code> and would be passed by reference. Then <code>resource_drop[_async]</code> could consume the type. However there might be other API considerations that could prevent that.</p>\n<h4>Alternatives</h4>\n<p>If the type stays <code>Copy</code>, could we at least make the error message a bit clearer?<br>\n</p>\n</blockquote>",
        "id": 570756679,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769682477
    },
    {
        "content": "<p><a href=\"https://github.com/fitzgen\">fitzgen</a> added the wasmtime:api label to <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12465\">Issue #12465</a>.</p>",
        "id": 570852768,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769706890
    },
    {
        "content": "<p><a href=\"https://github.com/fitzgen\">fitzgen</a> added the wasm-proposal:component-model label to <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12465\">Issue #12465</a>.</p>",
        "id": 570852770,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769706890
    },
    {
        "content": "<p>fitzgen <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12465#issuecomment-3819091443\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12465\">issue #12465</a>:</p>\n<blockquote>\n<p>cc @alexcrichton @rvolosatovs </p>\n</blockquote>",
        "id": 570853018,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769706940
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12465#issuecomment-3819655355\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12465\">issue #12465</a>:</p>\n<blockquote>\n<p>This is definitely a known deficiency of the API design of <code>ResourceAny</code>, but it was currently designed as a sort of least-bad version of the functionality to provide. Destroying a resource, or cloning a resource, requires access to a store which means that this can't use normal Rust traits. Additionally destroying a resource involves executing WebAssembly meaning it might be an async operation.</p>\n<p>I do think that the error messages could be improved here, yeah, but I'm not aware of a great way to manage the resource here in a more automatic Rust-y fashion.</p>\n</blockquote>",
        "id": 570872479,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769712839
    }
]
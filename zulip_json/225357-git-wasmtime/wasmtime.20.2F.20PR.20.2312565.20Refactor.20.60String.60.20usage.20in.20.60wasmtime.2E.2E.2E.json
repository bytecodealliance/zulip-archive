[
    {
        "content": "<p>fitzgen opened <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12565\">PR #12565</a> from <code>fitzgen:use-oom-handling-string-in-env-module</code> to <code>bytecodealliance:main</code>:</p>\n<blockquote>\n<p>Do not hold regular <code>String</code>s; instead use our own OOM-handling<br>\n<code>wasmtime_core::alloc::String</code> or, even better, an interned <code>Atom</code> from the<br>\n<code>StringPool</code>.</p>\n<p>Also avoid <code>IndexMap</code>, as it doesn't handle OOMs.</p>\n<p>Depends on</p>\n<ul>\n<li><a href=\"https://github.com/bytecodealliance/wasmtime/pull/12564\">https://github.com/bytecodealliance/wasmtime/pull/12564</a></li>\n<li><a href=\"https://github.com/bytecodealliance/wasmtime/pull/12563\">https://github.com/bytecodealliance/wasmtime/pull/12563</a></li>\n<li><a href=\"https://github.com/bytecodealliance/wasmtime/pull/12562\">https://github.com/bytecodealliance/wasmtime/pull/12562</a></li>\n</ul>\n</blockquote>",
        "id": 573160961,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1770761932
    },
    {
        "content": "<p><strong>fitzgen</strong> requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers\">wasmtime-compiler-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12565\">PR #12565</a>.</p>",
        "id": 573160962,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1770761932
    },
    {
        "content": "<p><strong>fitzgen</strong> requested <a href=\"https://github.com/cfallin\">cfallin</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12565\">PR #12565</a>.</p>",
        "id": 573160963,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1770761932
    },
    {
        "content": "<p><strong>fitzgen</strong> requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers\">wasmtime-core-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12565\">PR #12565</a>.</p>",
        "id": 573160964,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1770761932
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12565#issuecomment-3881064791\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12565\">PR #12565</a>:</p>\n<blockquote>\n<p>Knee-jerk reaction before you have too many more PRs that depend on this -- <code>IndexMap</code> is a relatively fundamental dependency especially for components, so I'm not sure we'll be able to escape making an OOM friendly version. Or at least I recall my impression being that we have quite a lot of <code>IndexMap</code>s throughout compilation/etc. Is the usage pretty localized to just one or two locations though?</p>\n</blockquote>",
        "id": 573161802,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1770762279
    },
    {
        "content": "<p>fitzgen <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12565#issuecomment-3881097091\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12565\">PR #12565</a>:</p>\n<blockquote>\n<blockquote>\n<p>Knee-jerk reaction before you have too many more PRs that depend on this -- <code>IndexMap</code> is a relatively fundamental dependency especially for components, so I'm not sure we'll be able to escape making an OOM friendly version. Or at least I recall my impression being that we have quite a lot of <code>IndexMap</code>s throughout compilation/etc. Is the usage pretty localized to just one or two locations though?</p>\n</blockquote>\n<p><code>IndexMap</code> is either <code>index_map::IndexMap</code> or a <code>BTreeMap</code> depending on <code>wasmparser</code> configuration:</p>\n<p><a href=\"https://github.com/bytecodealliance/wasmtime/blob/755979dd81eb79ff746fb4e63d4570513216e731/crates/environ/src/prelude.rs#L30\">https://github.com/bytecodealliance/wasmtime/blob/755979dd81eb79ff746fb4e63d4570513216e731/crates/environ/src/prelude.rs#L30</a></p>\n<p><code>std</code>/<code>alloc</code> does not provide a way to fallibly reserve/insert/allocate for <code>BTreeMap</code>s.</p>\n<p>And <code>index_map::IndexMap</code> does not provide a <code>try_reserve</code> method either. Additionally, <code>index_map::IndexMap</code>'s <code>Deserialize</code> implementation requires that the key be <code>Clone</code>, which our OOM-handling <code>String</code>s are most definitely not.</p>\n<p>So it seems like continuing to use <code>IndexMap</code> is going to be an uphill battle.</p>\n<p>We <em>could</em> make our own <code>IndexMap</code> that is a full implementation, rather than simply a newtype wrapper over either of those existing implementations. But that also seems pretty annoying and like more of a maintenance burden than is ideal... But maybe not, given that what I did with <code>exports</code> here is basically inlining/hard-coding one specific instance of that?</p>\n<p>Thoughts?</p>\n</blockquote>",
        "id": 573163166,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1770762828
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12565#issuecomment-3881527738\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12565\">PR #12565</a>:</p>\n<blockquote>\n<p>One possible fix might be to use <code>indexmap::IndexMap</code> (directly from the crate, not <code>wasmparser</code>). That should support no_std and it looks like it's got a <code>try_reserve</code> to work for us as well. For <code>Deserialize</code> wouldn't we be writing custom impls as opposed to using any built-in ones too?</p>\n<p>I guess what I'm saying is that my leaning is that we should have an <code>indexmap::IndexMap</code> wrapper the same way we have a <code>Vec</code> wrapper and then replace the usage of <code>wasmparser::IndexMap</code> with that fallible <code>IndexMap</code>. </p>\n</blockquote>",
        "id": 573178351,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1770770884
    },
    {
        "content": "<p>github-actions[bot] added the label <code>cranelift</code> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12565\">PR #12565</a>.</p>",
        "id": 573194242,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1770781190
    },
    {
        "content": "<p>github-actions[bot] added the label <code>wasmtime:api</code> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12565\">PR #12565</a>.</p>",
        "id": 573194244,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1770781191
    },
    {
        "content": "<p>fitzgen updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12565\">PR #12565</a>.</p>",
        "id": 573606694,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1770925804
    },
    {
        "content": "<p>fitzgen <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12565#issuecomment-3893060695\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12565\">PR #12565</a>:</p>\n<blockquote>\n<blockquote>\n<p>I guess what I'm saying is that my leaning is that we should have an <code>indexmap::IndexMap</code> wrapper the same way we have a <code>Vec</code> wrapper and then replace the usage of <code>wasmparser::IndexMap</code> with that fallible <code>IndexMap</code>.</p>\n</blockquote>\n<p>Okay, that has been done and I've pushed a new commit that switches this back to using <code>IndexMap</code> instead of multiple <code>{Primary,Secondary}Map</code>s.</p>\n<p>Also this depends on these other PRs now:</p>\n<ul>\n<li><a href=\"https://github.com/bytecodealliance/wasmtime/pull/12580\">https://github.com/bytecodealliance/wasmtime/pull/12580</a></li>\n<li><a href=\"https://github.com/bytecodealliance/wasmtime/pull/12579\">https://github.com/bytecodealliance/wasmtime/pull/12579</a></li>\n</ul>\n</blockquote>",
        "id": 573606925,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1770925894
    },
    {
        "content": "<p>fitzgen updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12565\">PR #12565</a>.</p>",
        "id": 573618236,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1770930768
    },
    {
        "content": "<p>alexcrichton submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12565#pullrequestreview-3793695112\">PR review</a>.</p>",
        "id": 573618238,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1770930769
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12565#discussion_r2801080702\">PR review comment</a>:</p>\n<blockquote>\n<p>This I think is no longer needed?</p>\n</blockquote>",
        "id": 573618239,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1770930769
    },
    {
        "content": "<p>fitzgen updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12565\">PR #12565</a>.</p>",
        "id": 573618307,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1770930802
    },
    {
        "content": "<p>fitzgen has enabled auto merge for <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12565\">PR #12565</a>.</p>",
        "id": 573618348,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1770930812
    },
    {
        "content": "<p>fitzgen added <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12565\">PR #12565 Refactor <code>String</code> usage in <code>wasmtime_environ::Module</code></a> to the merge queue</p>",
        "id": 573620098,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1770931626
    },
    {
        "content": "<p>fitzgen merged <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12565\">PR #12565</a>.</p>",
        "id": 573627604,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1770934527
    },
    {
        "content": "<p>fitzgen removed <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12565\">PR #12565 Refactor <code>String</code> usage in <code>wasmtime_environ::Module</code></a> from the merge queue</p>",
        "id": 573627608,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1770934528
    }
]
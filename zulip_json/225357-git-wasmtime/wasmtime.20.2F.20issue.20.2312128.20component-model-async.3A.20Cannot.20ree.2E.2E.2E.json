[
    {
        "content": "<p>alexcrichton opened <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12128\">issue #12128</a>:</p>\n<blockquote>\n<p>This test case:</p>\n<div class=\"codehilite\" data-code-language=\"wasm\"><pre><span></span><code>(component\n  (component $a\n    (core module $a\n      (import \"\" \"yield\" (func $yield (result i32)))\n\n      (func (export \"yield-loop\") (result i32)\n        ;; simulate `waitable-set.poll` with a yield loop\n        (loop\n          call $yield\n          drop\n          br 0\n        )\n        unreachable\n      )\n\n      ;; not reached\n      (func (export \"callback\") (param i32 i32 i32) (result i32) unreachable)\n\n      (func (export \"noop\"))\n    )\n    (core func $yield (canon thread.yield))\n    (core instance $a (instantiate $a\n      (with \"\" (instance\n        (export \"yield\" (func $yield))\n      ))\n    ))\n    (func (export \"yield-loop\")\n      (canon lift\n        (core func $a \"yield-loop\")\n        async\n        (callback (func $a \"callback\"))\n      )\n    )\n    (func (export \"noop\") (canon lift (core func $a \"noop\")))\n  )\n  (instance $a (instantiate $a))\n\n  (component $b\n    (import \"yield-loop\" (func $yield-loop))\n    (import \"noop\" (func $noop))\n\n    (core func $yield-loop (canon lower (func $yield-loop) async))\n    (core func $noop (canon lower (func $noop)))\n\n    (core module $b\n      (import \"\" \"yield-loop\" (func $yield-loop (result i32)))\n      (import \"\" \"noop\" (func $noop))\n\n      (func (export \"run\")\n        ;; call `yield-loop`, double-check it's in the \"started\" state.\n        call $yield-loop\n        i32.const 0xf\n        i32.and\n        i32.const 1\n        i32.ne\n        if unreachable end\n\n        ;; now try to reenter the other component with some other function.\n        call $noop\n      )\n    )\n    (core instance $b (instantiate $b\n      (with \"\" (instance\n        (export \"yield-loop\" (func $yield-loop))\n        (export \"noop\" (func $noop))\n      ))\n    ))\n    (func (export \"run\") (canon lift (core func $b \"run\")))\n  )\n  (instance $b (instantiate $b\n    (with \"yield-loop\" (func $a \"yield-loop\"))\n    (with \"noop\" (func $a \"noop\"))\n  ))\n  (export \"run\" (func $b \"run\"))\n)\n\n(assert_return (invoke \"run\"))\n</code></pre></div>\n<p>fails with:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"n\">WASMTIME_BACKTRACE_DETAILS</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"n\">wast</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"p\">.</span><span class=\"n\">wast</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">W</span><span class=\"w\"> </span><span class=\"n\">component</span><span class=\"o\">-</span><span class=\"n\">model</span><span class=\"o\">-</span><span class=\"k\">async</span>\n<span class=\"n\">Error</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">script</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">foo</span><span class=\"p\">.</span><span class=\"n\">wast</span><span class=\"o\">'</span>\n\n<span class=\"n\">Caused</span><span class=\"w\"> </span><span class=\"n\">by</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"mi\">0</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">directive</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"p\">.</span><span class=\"n\">wast</span><span class=\"p\">:</span><span class=\"mi\">77</span>\n<span class=\"w\">    </span><span class=\"mi\">1</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">error</span><span class=\"w\"> </span><span class=\"k\">while</span><span class=\"w\"> </span><span class=\"n\">executing</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">wasm</span><span class=\"w\"> </span><span class=\"n\">backtrace</span><span class=\"p\">:</span>\n<span class=\"w\">           </span><span class=\"mi\">0</span><span class=\"p\">:</span><span class=\"w\">    </span><span class=\"mh\">0x185</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">unknown</span><span class=\"o\">&gt;!&lt;</span><span class=\"n\">wasm</span><span class=\"w\"> </span><span class=\"n\">function</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"o\">&gt;</span>\n<span class=\"w\">           </span><span class=\"mi\">1</span><span class=\"p\">:</span><span class=\"w\">    </span><span class=\"mh\">0x333</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">wasm</span><span class=\"o\">-</span><span class=\"n\">function</span><span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"p\">]</span>\n<span class=\"w\">                           </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">foo</span><span class=\"p\">.</span><span class=\"n\">wast</span><span class=\"p\">:</span><span class=\"mi\">59</span><span class=\"p\">:</span><span class=\"mi\">9</span>\n<span class=\"w\">    </span><span class=\"mi\">2</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">wasm</span><span class=\"w\"> </span><span class=\"n\">trap</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">wasm</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">unreachable</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">instruction</span><span class=\"w\"> </span><span class=\"n\">executed</span>\n</code></pre></div>\n<p>Specifically <code>$yield-loop</code> is, well, yielding, and then the second call to <code>$noop</code> I believe is dying in the fused adapter. My best guess is due to component reentrance, but I'm not 100% certain since errors from the fused adapter are pretty opaque.</p>\n<p>Is this intended behavior? Accidental behavior?</p>\n</blockquote>",
        "id": 562136079,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764950733
    },
    {
        "content": "<p><a href=\"https://github.com/alexcrichton\">alexcrichton</a> added the wasm-proposal:component-model-async label to <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12128\">Issue #12128</a>.</p>",
        "id": 562136080,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764950733
    },
    {
        "content": "<p>alexcrichton edited <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12128\">issue #12128</a>:</p>\n<blockquote>\n<p>This test case:</p>\n<div class=\"codehilite\" data-code-language=\"wasm\"><pre><span></span><code>(component\n  (component $a\n    (core module $a\n      (import \"\" \"yield\" (func $yield (result i32)))\n\n      (func (export \"yield-loop\") (result i32)\n        ;; simulate `waitable-set.poll` with a yield loop\n        (loop\n          call $yield\n          drop\n          br 0\n        )\n        unreachable\n      )\n\n      ;; not reached\n      (func (export \"callback\") (param i32 i32 i32) (result i32) unreachable)\n\n      (func (export \"noop\"))\n    )\n    (core func $yield (canon thread.yield))\n    (core instance $a (instantiate $a\n      (with \"\" (instance\n        (export \"yield\" (func $yield))\n      ))\n    ))\n    (func (export \"yield-loop\") async\n      (canon lift\n        (core func $a \"yield-loop\")\n        async\n        (callback (func $a \"callback\"))\n      )\n    )\n    (func (export \"noop\") (canon lift (core func $a \"noop\")))\n  )\n  (instance $a (instantiate $a))\n\n  (component $b\n    (import \"yield-loop\" (func $yield-loop async))\n    (import \"noop\" (func $noop))\n\n    (core func $yield-loop (canon lower (func $yield-loop) async))\n    (core func $noop (canon lower (func $noop)))\n\n    (core module $b\n      (import \"\" \"yield-loop\" (func $yield-loop (result i32)))\n      (import \"\" \"noop\" (func $noop))\n\n      (func (export \"run\")\n        ;; call `yield-loop`, double-check it's in the \"started\" state.\n        call $yield-loop\n        i32.const 0xf\n        i32.and\n        i32.const 1\n        i32.ne\n        if unreachable end\n\n        ;; now try to reenter the other component with some other function.\n        call $noop\n      )\n    )\n    (core instance $b (instantiate $b\n      (with \"\" (instance\n        (export \"yield-loop\" (func $yield-loop))\n        (export \"noop\" (func $noop))\n      ))\n    ))\n    (func (export \"run\") async (canon lift (core func $b \"run\")))\n  )\n  (instance $b (instantiate $b\n    (with \"yield-loop\" (func $a \"yield-loop\"))\n    (with \"noop\" (func $a \"noop\"))\n  ))\n  (export \"run\" (func $b \"run\"))\n)\n\n(assert_return (invoke \"run\"))\n</code></pre></div>\n<p>fails with:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"n\">WASMTIME_BACKTRACE_DETAILS</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"n\">wast</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"p\">.</span><span class=\"n\">wast</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">W</span><span class=\"w\"> </span><span class=\"n\">component</span><span class=\"o\">-</span><span class=\"n\">model</span><span class=\"o\">-</span><span class=\"k\">async</span>\n<span class=\"n\">Error</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">script</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">foo</span><span class=\"p\">.</span><span class=\"n\">wast</span><span class=\"o\">'</span>\n\n<span class=\"n\">Caused</span><span class=\"w\"> </span><span class=\"n\">by</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"mi\">0</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">directive</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"p\">.</span><span class=\"n\">wast</span><span class=\"p\">:</span><span class=\"mi\">77</span>\n<span class=\"w\">    </span><span class=\"mi\">1</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">error</span><span class=\"w\"> </span><span class=\"k\">while</span><span class=\"w\"> </span><span class=\"n\">executing</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">wasm</span><span class=\"w\"> </span><span class=\"n\">backtrace</span><span class=\"p\">:</span>\n<span class=\"w\">           </span><span class=\"mi\">0</span><span class=\"p\">:</span><span class=\"w\">    </span><span class=\"mh\">0x185</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">unknown</span><span class=\"o\">&gt;!&lt;</span><span class=\"n\">wasm</span><span class=\"w\"> </span><span class=\"n\">function</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"o\">&gt;</span>\n<span class=\"w\">           </span><span class=\"mi\">1</span><span class=\"p\">:</span><span class=\"w\">    </span><span class=\"mh\">0x333</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">wasm</span><span class=\"o\">-</span><span class=\"n\">function</span><span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"p\">]</span>\n<span class=\"w\">                           </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">foo</span><span class=\"p\">.</span><span class=\"n\">wast</span><span class=\"p\">:</span><span class=\"mi\">59</span><span class=\"p\">:</span><span class=\"mi\">9</span>\n<span class=\"w\">    </span><span class=\"mi\">2</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">wasm</span><span class=\"w\"> </span><span class=\"n\">trap</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">wasm</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">unreachable</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">instruction</span><span class=\"w\"> </span><span class=\"n\">executed</span>\n</code></pre></div>\n<p>Specifically <code>$yield-loop</code> is, well, yielding, and then the second call to <code>$noop</code> I believe is dying in the fused adapter. My best guess is due to component reentrance, but I'm not 100% certain since errors from the fused adapter are pretty opaque.</p>\n<p>Is this intended behavior? Accidental behavior?</p>\n</blockquote>",
        "id": 562182515,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764968576
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12128#issuecomment-3618596235\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12128\">issue #12128</a>:</p>\n<blockquote>\n<p>Ok in discussion with @lukewagner the conclusion is:</p>\n<ul>\n<li>Prior to #12043 this test should block forever. Notably the <code>noop</code> call sould be blocked on backpressure being turned on as part of <code>yield-loop</code></li>\n<li>Post-#12043 this test should pass (with some minor <code>async</code> edits I've applied to the OP now)</li>\n</ul>\n<p>With #12043 as-is this test still traps in pretty much the same place, so this is something we'll want to fix.</p>\n</blockquote>",
        "id": 562182578,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764968608
    },
    {
        "content": "<p>alexcrichton assigned dicej to <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12128\">issue #12128</a>.</p>",
        "id": 562182582,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764968610
    },
    {
        "content": "<p>dicej closed <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12128\">issue #12128</a>:</p>\n<blockquote>\n<p>This test case:</p>\n<div class=\"codehilite\" data-code-language=\"wasm\"><pre><span></span><code>(component\n  (component $a\n    (core module $a\n      (import \"\" \"yield\" (func $yield (result i32)))\n\n      (func (export \"yield-loop\") (result i32)\n        ;; simulate `waitable-set.poll` with a yield loop\n        (loop\n          call $yield\n          drop\n          br 0\n        )\n        unreachable\n      )\n\n      ;; not reached\n      (func (export \"callback\") (param i32 i32 i32) (result i32) unreachable)\n\n      (func (export \"noop\"))\n    )\n    (core func $yield (canon thread.yield))\n    (core instance $a (instantiate $a\n      (with \"\" (instance\n        (export \"yield\" (func $yield))\n      ))\n    ))\n    (func (export \"yield-loop\") async\n      (canon lift\n        (core func $a \"yield-loop\")\n        async\n        (callback (func $a \"callback\"))\n      )\n    )\n    (func (export \"noop\") (canon lift (core func $a \"noop\")))\n  )\n  (instance $a (instantiate $a))\n\n  (component $b\n    (import \"yield-loop\" (func $yield-loop async))\n    (import \"noop\" (func $noop))\n\n    (core func $yield-loop (canon lower (func $yield-loop) async))\n    (core func $noop (canon lower (func $noop)))\n\n    (core module $b\n      (import \"\" \"yield-loop\" (func $yield-loop (result i32)))\n      (import \"\" \"noop\" (func $noop))\n\n      (func (export \"run\")\n        ;; call `yield-loop`, double-check it's in the \"started\" state.\n        call $yield-loop\n        i32.const 0xf\n        i32.and\n        i32.const 1\n        i32.ne\n        if unreachable end\n\n        ;; now try to reenter the other component with some other function.\n        call $noop\n      )\n    )\n    (core instance $b (instantiate $b\n      (with \"\" (instance\n        (export \"yield-loop\" (func $yield-loop))\n        (export \"noop\" (func $noop))\n      ))\n    ))\n    (func (export \"run\") async (canon lift (core func $b \"run\")))\n  )\n  (instance $b (instantiate $b\n    (with \"yield-loop\" (func $a \"yield-loop\"))\n    (with \"noop\" (func $a \"noop\"))\n  ))\n  (export \"run\" (func $b \"run\"))\n)\n\n(assert_return (invoke \"run\"))\n</code></pre></div>\n<p>fails with:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"n\">WASMTIME_BACKTRACE_DETAILS</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"n\">wast</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"p\">.</span><span class=\"n\">wast</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">W</span><span class=\"w\"> </span><span class=\"n\">component</span><span class=\"o\">-</span><span class=\"n\">model</span><span class=\"o\">-</span><span class=\"k\">async</span>\n<span class=\"n\">Error</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">script</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">foo</span><span class=\"p\">.</span><span class=\"n\">wast</span><span class=\"o\">'</span>\n\n<span class=\"n\">Caused</span><span class=\"w\"> </span><span class=\"n\">by</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"mi\">0</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">directive</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"p\">.</span><span class=\"n\">wast</span><span class=\"p\">:</span><span class=\"mi\">77</span>\n<span class=\"w\">    </span><span class=\"mi\">1</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">error</span><span class=\"w\"> </span><span class=\"k\">while</span><span class=\"w\"> </span><span class=\"n\">executing</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">wasm</span><span class=\"w\"> </span><span class=\"n\">backtrace</span><span class=\"p\">:</span>\n<span class=\"w\">           </span><span class=\"mi\">0</span><span class=\"p\">:</span><span class=\"w\">    </span><span class=\"mh\">0x185</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">unknown</span><span class=\"o\">&gt;!&lt;</span><span class=\"n\">wasm</span><span class=\"w\"> </span><span class=\"n\">function</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"o\">&gt;</span>\n<span class=\"w\">           </span><span class=\"mi\">1</span><span class=\"p\">:</span><span class=\"w\">    </span><span class=\"mh\">0x333</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">wasm</span><span class=\"o\">-</span><span class=\"n\">function</span><span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"p\">]</span>\n<span class=\"w\">                           </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">foo</span><span class=\"p\">.</span><span class=\"n\">wast</span><span class=\"p\">:</span><span class=\"mi\">59</span><span class=\"p\">:</span><span class=\"mi\">9</span>\n<span class=\"w\">    </span><span class=\"mi\">2</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">wasm</span><span class=\"w\"> </span><span class=\"n\">trap</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">wasm</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">unreachable</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">instruction</span><span class=\"w\"> </span><span class=\"n\">executed</span>\n</code></pre></div>\n<p>Specifically <code>$yield-loop</code> is, well, yielding, and then the second call to <code>$noop</code> I believe is dying in the fused adapter. My best guess is due to component reentrance, but I'm not 100% certain since errors from the fused adapter are pretty opaque.</p>\n<p>Is this intended behavior? Accidental behavior?</p>\n</blockquote>",
        "id": 568094575,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768431113
    }
]
[
    {
        "content": "<p>crowforkotlin opened <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229\">issue #12229</a>:</p>\n<blockquote>\n<h3><strong>Subject:</strong> \"Code for function is too large\" error and 1.6GB Memory Spike during JIT compilation of a 781KB Kotlin/Wasm module</h3>\n<p><strong>Environment:</strong></p>\n<ul>\n<li><strong>Wasmtime version:</strong> v40.0.0 (Release #12192)</li>\n<li><strong>Host Machine (Build):</strong> Mac M2 (aarch64)</li>\n<li><strong>Target Device (Runtime):</strong> Android (aarch64)</li>\n<li><strong>Compiler:</strong> Kotlin/Wasm (WASI) via <code>compileProductionExecutableKotlinWasmWasiOptimize</code></li>\n<li><strong>Project Link:</strong> <a href=\"https://github.com/crowforkotlin/wasmline\">crowforkotlin/wasmline</a></li>\n<li><strong>Source File:</strong> <a href=\"https://github.com/crowforkotlin/wasmline/blob/main/wasmline-multiplatform/wasmline-core/plugin/src/wasmWasiMain/kotlin/crow/wasmtime/wasmline/Plugin.kt\">Plugin.kt</a></li>\n</ul>\n<p><strong>Description:</strong><br>\nI am reporting a <code>Compilation error: Code for function is too large</code> that occurs during the JIT loading phase on Android. </p>\n<p>Despite the generated <code>.wasm</code> binary being only <strong>781.63 KB</strong>, the compilation fails when a single Kotlin function contains a large amount of logic/content. During the attempt to compile this module, I observed a massive RSS memory spike on the Android device, jumping from <strong>~235 MB to over 1.6 GB</strong> in just 4 seconds, eventually resulting in the \"function too large\" error.</p>\n<p><strong>Wasmtime Configuration:</strong><br>\nThe engine is configured specifically for Android compatibility to avoid signal conflicts with ART and minimize VSS overhead:</p>\n<div class=\"codehilite\" data-code-language=\"C++\"><pre><span></span><code><span class=\"cm\">/**</span>\n<span class=\"cm\"> * Creates and configures the Wasm Config object.</span>\n<span class=\"cm\"> *</span>\n<span class=\"cm\"> * Critical Android Settings:</span>\n<span class=\"cm\"> * 1. Signals-based traps DISABLED: To prevent conflicts with Android ART signal handlers (SIGSEGV).</span>\n<span class=\"cm\"> * 2. Memory Guard Size = 0: To prevent VSS (Virtual Set Size) OOM on 32-bit or limited devices.</span>\n<span class=\"cm\"> * 3. GC / Exceptions: Enabled for Kotlin/Wasm support.</span>\n<span class=\"cm\"> */</span>\n<span class=\"n\">wasm_config_t</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"nf\">Engine::createConfig</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">wasm_config_t</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">conf</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">wasm_config_new</span><span class=\"p\">();</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// Feature Flags for Kotlin/Wasm support</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_config_wasm_gc_set</span><span class=\"p\">(</span><span class=\"n\">conf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">true</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_config_wasm_function_references_set</span><span class=\"p\">(</span><span class=\"n\">conf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">true</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_config_wasm_exceptions_set</span><span class=\"p\">(</span><span class=\"n\">conf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">true</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// Optimization: Disable SIMD if not strictly needed (improves compatibility)</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_config_wasm_simd_set</span><span class=\"p\">(</span><span class=\"n\">conf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">false</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_config_wasm_relaxed_simd_set</span><span class=\"p\">(</span><span class=\"n\">conf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">false</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// [CRITICAL] Disable signal handlers to avoid crash conflicts with Android Runtime (ART)</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_config_signals_based_traps_set</span><span class=\"p\">(</span><span class=\"n\">conf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">false</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// [CRITICAL] Set guard pages to 0 to minimize Virtual Memory usage (prevents OOM)</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_config_memory_guard_size_set</span><span class=\"p\">(</span><span class=\"n\">conf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// Set max stack size (512KB is usually sufficient for mobile logic)</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_config_max_wasm_stack_set</span><span class=\"p\">(</span><span class=\"n\">conf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">512</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">1024</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// Compiler Optimization Strategy: Optimize for Speed and Binary Size</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_config_cranelift_opt_level_set</span><span class=\"p\">(</span><span class=\"n\">conf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">WASMTIME_OPT_LEVEL_SPEED_AND_SIZE</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_config_cranelift_debug_verifier_set</span><span class=\"p\">(</span><span class=\"n\">conf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">false</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">conf</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p><strong>Reproduction Steps:</strong></p>\n<ol>\n<li>Add a large amount of content/logic into the <code>wasmWasiMain</code> function in <code>Plugin.kt</code>.</li>\n<li>Build the wasm file: <code>./gradlew wasmtime-core:plugin:compileProductionExecutableKotlinWasmWasiOptimize</code>.</li>\n<li>The resulting <code>plugin.wasm</code> is ~781 KB.</li>\n<li>Load the module on an Android device using the configuration above.</li>\n</ol>\n<p><strong>Observed Behavior:</strong></p>\n<ul>\n<li><strong>Total Wasm Size:</strong> 781.63 KB (Small)</li>\n<li><strong>Memory Usage:</strong> Spikes from 234MB to 1.6GB.</li>\n<li><strong>Result:</strong> <code>Compilation error: Code for function is too large</code>.</li>\n</ul>\n<p><strong>Full Android Logs:</strong></p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>00:49:34.204  I  [MotionEvent] ViewRootImpl windowName 'crow.wasmtime.wasmline/crow.mordecai.wasmline.MainActivity', { action=ACTION_DOWN, id[0]=0, pointerCount=1, eventTime=51746485, downTime=51746485, phoneEventTime=00:49:34.191 } moveCount:0\n00:49:34.206  D  getMiuiFreeformStackInfo mTmpFrames.miuiFreeFormStackInfo: null\n00:49:34.217  I  CreateGraphicsPipeline pipeline cache hit. elpased time: 0.32 ms.\n00:49:34.218  E  FrameInsert open fail: No such file or directory\n00:49:34.230  I  This is non sticky GC, maxfree is 33554432 minfree is 8388608\n00:49:34.227  W  type=1400 audit(0.0:2008818): avc:  denied  { getopt } for  path=\"/dev/socket/usap_pool_primary\" scontext=u:r:untrusted_app:s0:c190,c257,c512,c768 tcontext=u:r:zygote:s0 tclass=unix_stream_socket permissive=0 app=crow.wasmtime.wasmline\n00:49:34.322  I  [MotionEvent] ViewRootImpl windowName 'crow.wasmtime.wasmline/crow.mordecai.wasmline.MainActivity', { action=ACTION_UP, id[0]=0, pointerCount=1, eventTime=51746611, downTime=51746485, phoneEventTime=00:49:34.316 } moveCount:0\n00:49:34.332  I  ==============================================\n00:49:34.337  I  [Android] Wasm file : plugin.wasm    ||    wasm file exits : true    ||    wasm file path :  /data/user/0/crow.wasmtime.wasmline/cache/plugin.wasm\n00:49:34.338  I  [Android] Cwasm cache file : plugin.cwasm    ||    cache file exits : false    ||    cache file path :  /data/user/0/crow.wasmtime.wasmline/cache/plugin.cwasm\n00:49:34.345  I  [Wasmtime] Module --&gt; Jit Compiling for /data/user/0/crow.wasmtime.wasmline/cache/plugin.wasm...\n00:49:34.363  W  type=1400 audit(0.0:2008819): avc:  denied  { read } for  name=\"cpu.cfs_quota_us\" dev=\"cgroup\" ino=64 scontext=u:r:untrusted_app:s0:c190,c257,c512,c768 tcontext=u:object_r:cgroup:s0 tclass=file permissive=0 app=crow.wasmtime.wasmline\n00:49:34.363  W  type=1400 audit(0.0:2008820): avc:  denied  { read } for  name=\"cpu.cfs_period_us\" dev=\"cgroup\" ino=65 scontext=u:r:untrusted_app:s0:c190,c257,c512,c768 tcontext=u:object_r:cgroup:s0 tclass=file permissive=0 app=crow.wasmtime.wasmline\n00:49:34.363  W  type=1400 audit(0.0:2008821): avc:  denied  { read } for  name=\"cpu.cfs_quota_us\" dev=\"cgroup\" ino=10 scontext=u:r:untrusted_app:s0:c190,c257,c512,c768 tcontext=u:object_r:cgroup:s0 tclass=file permissive=0 app=crow.wasmtime.wasmline\n00:49:34.363  W  type=1400 audit(0.0:2008822): avc:  denied  { read } for  name=\"cpu.cfs_period_us\" dev=\"cgroup\" ino=11 scontext=u:r:untrusted_app:s0:c190,c257,c512,c768 tcontext=u:object_r:cgroup:s0 tclass=file permissive=0 app=crow.wasmtime.wasmline\n00:49:34.441  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 234952kb -&gt; 342100kb\n00:49:34.494  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 342100kb -&gt; 428844kb\n00:49:34.544  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 428844kb -&gt; 541612kb\n00:49:34.602  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 541612kb -&gt; 657240kb\n00:49:34.928  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 657240kb -&gt; 860432kb\n00:49:35.761  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 860432kb -&gt; 959324kb\n00:49:36.012  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 959324kb -&gt; 1075892kb\n00:49:36.184  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 1075892kb -&gt; 1183820kb\n00:49:37.835  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 1183820kb -&gt; 1306888kb\n00:49:38.482  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 1306888kb -&gt; 1450064kb\n00:49:38.639  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 1450064kb -&gt; 1612484kb\n00:49:38.700  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 1612484kb -&gt; 1389664kb\n00:49:38.700  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 1389664kb -&gt; 1011816kb\n00:49:38.702  E  [Wasmtime] Module --&gt; Error loading module /data/user/0/crow.wasmtime.wasmline/cache/plugin.wasm: Compilation error: Code for function is too large\n00:49:38.708  I  [Wasmline] Load failure, because native load return false, file path is :  /data/user/0/crow.wasmtime.wasmline/cache/plugin.wasm\n00:49:38.790  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 1011816kb -&gt; 727648kb\n</code></pre></div>\n<p><strong>Artifacts:</strong><br>\n<a href=\"https://github.com/user-attachments/files/24371302/Wasmline-wasmline-core-plugin.wasm.zip\">Wasmline-wasmline-core-plugin.wasm.zip</a></p>\n<ul>\n<li>\n<p><strong>Wasm File Size (781.63 KB):</strong><br>\n    ![Image](<a href=\"https://github.com/user-attachments/assets/eb138f47-365b-4acb-bf95-231109ef1595\">https://github.com/user-attachments/assets/eb138f47-365b-4acb-bf95-231109ef1595</a>)</p>\n</li>\n<li>\n<p><strong>Error Detail:</strong><br>\n    ![Image](<a href=\"https://github.com/user-attachments/assets/c7c95257-15e5-48ec-8dfd-48474d289ddd\">https://github.com/user-attachments/assets/c7c95257-15e5-48ec-8dfd-48474d289ddd</a>)</p>\n</li>\n<li>\n<p><strong>Success state (after reducing content):</strong><br>\n    ![Image](<a href=\"https://github.com/user-attachments/assets/7dac5f71-1e53-4475-87ff-3b4e553cee25\">https://github.com/user-attachments/assets/7dac5f71-1e53-4475-87ff-3b4e553cee25</a>)</p>\n</li>\n</ul>\n<p><strong>Analysis &amp; Questions:</strong></p>\n<ol>\n<li>Why does a relatively small Wasm file (under 1MB) trigger a \"Code too large\" error? It seems the Kotlin/Wasm compiler is generating a single function with extremely high complexity.</li>\n<li>The memory usage spike to 1.6GB suggests that Cranelift might be hitting a worst-case scenario in its e-graph optimization or register allocation phase.</li>\n<li>Are there any specific Cranelift settings to mitigate this, or is this a fundamental limit on function complexity regardless of the total <code>.wasm</code> file size?</li>\n</ol>\n</blockquote>",
        "id": 565699380,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767027797
    },
    {
        "content": "<p><a href=\"https://github.com/crowforkotlin\">crowforkotlin</a> added the bug label to <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229\">Issue #12229</a>.</p>",
        "id": 565699382,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767027797
    },
    {
        "content": "<p>crowforkotlin edited <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229\">issue #12229</a>:</p>\n<blockquote>\n<h1><strong>Subject:</strong> \"Code for function is too large\" error and 1.6GB Memory Spike during JIT compilation of a 781KB Kotlin/Wasm module</h1>\n<p><strong>Environment:</strong></p>\n<ul>\n<li><strong>Wasmtime version:</strong> v40.0.0 (Release #12192)</li>\n<li><strong>Host Machine (Build):</strong> Mac M2 (aarch64)</li>\n<li><strong>Target Device (Runtime):</strong> Android (aarch64)</li>\n<li><strong>Compiler:</strong> Kotlin/Wasm (WASI) via <code>compileProductionExecutableKotlinWasmWasiOptimize</code></li>\n<li><strong>Project Link:</strong> <a href=\"https://github.com/crowforkotlin/wasmline\">crowforkotlin/wasmline</a></li>\n<li><strong>Source File:</strong> <a href=\"https://github.com/crowforkotlin/wasmline/blob/main/wasmline-multiplatform/wasmline-core/plugin/src/wasmWasiMain/kotlin/crow/wasmtime/wasmline/Plugin.kt\">Plugin.kt</a></li>\n</ul>\n<p><strong>Description:</strong><br>\nI am reporting a <code>Compilation error: Code for function is too large</code> that occurs during the JIT loading phase on Android. </p>\n<p>Despite the generated <code>.wasm</code> binary being only <strong>781.63 KB</strong>, the compilation fails when a single Kotlin function contains a large amount of logic/content. During the attempt to compile this module, I observed a massive RSS memory spike on the Android device, jumping from <strong>~235 MB to over 1.6 GB</strong> in just 4 seconds, eventually resulting in the \"function too large\" error.</p>\n<p><strong>Wasmtime Configuration:</strong><br>\nThe engine is configured specifically for Android compatibility to avoid signal conflicts with ART and minimize VSS overhead:</p>\n<div class=\"codehilite\" data-code-language=\"C++\"><pre><span></span><code><span class=\"cm\">/**</span>\n<span class=\"cm\"> * Creates and configures the Wasm Config object.</span>\n<span class=\"cm\"> *</span>\n<span class=\"cm\"> * Critical Android Settings:</span>\n<span class=\"cm\"> * 1. Signals-based traps DISABLED: To prevent conflicts with Android ART signal handlers (SIGSEGV).</span>\n<span class=\"cm\"> * 2. Memory Guard Size = 0: To prevent VSS (Virtual Set Size) OOM on 32-bit or limited devices.</span>\n<span class=\"cm\"> * 3. GC / Exceptions: Enabled for Kotlin/Wasm support.</span>\n<span class=\"cm\"> */</span>\n<span class=\"n\">wasm_config_t</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"nf\">Engine::createConfig</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">wasm_config_t</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">conf</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">wasm_config_new</span><span class=\"p\">();</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// Feature Flags for Kotlin/Wasm support</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_config_wasm_gc_set</span><span class=\"p\">(</span><span class=\"n\">conf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">true</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_config_wasm_function_references_set</span><span class=\"p\">(</span><span class=\"n\">conf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">true</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_config_wasm_exceptions_set</span><span class=\"p\">(</span><span class=\"n\">conf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">true</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// Optimization: Disable SIMD if not strictly needed (improves compatibility)</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_config_wasm_simd_set</span><span class=\"p\">(</span><span class=\"n\">conf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">false</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_config_wasm_relaxed_simd_set</span><span class=\"p\">(</span><span class=\"n\">conf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">false</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// [CRITICAL] Disable signal handlers to avoid crash conflicts with Android Runtime (ART)</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_config_signals_based_traps_set</span><span class=\"p\">(</span><span class=\"n\">conf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">false</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// [CRITICAL] Set guard pages to 0 to minimize Virtual Memory usage (prevents OOM)</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_config_memory_guard_size_set</span><span class=\"p\">(</span><span class=\"n\">conf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// Set max stack size (512KB is usually sufficient for mobile logic)</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_config_max_wasm_stack_set</span><span class=\"p\">(</span><span class=\"n\">conf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">512</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">1024</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// Compiler Optimization Strategy: Optimize for Speed and Binary Size</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_config_cranelift_opt_level_set</span><span class=\"p\">(</span><span class=\"n\">conf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">WASMTIME_OPT_LEVEL_SPEED_AND_SIZE</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_config_cranelift_debug_verifier_set</span><span class=\"p\">(</span><span class=\"n\">conf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">false</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">conf</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p><strong>Reproduction Steps:</strong></p>\n<ol>\n<li>Add a large amount of content/logic into the <code>wasmWasiMain</code> function in <code>Plugin.kt</code>.</li>\n<li>Build the wasm file: <code>./gradlew wasmtime-core:plugin:compileProductionExecutableKotlinWasmWasiOptimize</code>.</li>\n<li>The resulting <code>plugin.wasm</code> is ~781 KB.</li>\n<li>Load the module on an Android device using the configuration above.</li>\n</ol>\n<p><strong>Observed Behavior:</strong></p>\n<ul>\n<li><strong>Total Wasm Size:</strong> 781.63 KB (Small)</li>\n<li><strong>Memory Usage:</strong> Spikes from 234MB to 1.6GB.</li>\n<li><strong>Result:</strong> <code>Compilation error: Code for function is too large</code>.</li>\n</ul>\n<p><strong>Full Android Logs:</strong></p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>00:49:34.204  I  [MotionEvent] ViewRootImpl windowName 'crow.wasmtime.wasmline/crow.mordecai.wasmline.MainActivity', { action=ACTION_DOWN, id[0]=0, pointerCount=1, eventTime=51746485, downTime=51746485, phoneEventTime=00:49:34.191 } moveCount:0\n00:49:34.206  D  getMiuiFreeformStackInfo mTmpFrames.miuiFreeFormStackInfo: null\n00:49:34.217  I  CreateGraphicsPipeline pipeline cache hit. elpased time: 0.32 ms.\n00:49:34.218  E  FrameInsert open fail: No such file or directory\n00:49:34.230  I  This is non sticky GC, maxfree is 33554432 minfree is 8388608\n00:49:34.227  W  type=1400 audit(0.0:2008818): avc:  denied  { getopt } for  path=\"/dev/socket/usap_pool_primary\" scontext=u:r:untrusted_app:s0:c190,c257,c512,c768 tcontext=u:r:zygote:s0 tclass=unix_stream_socket permissive=0 app=crow.wasmtime.wasmline\n00:49:34.322  I  [MotionEvent] ViewRootImpl windowName 'crow.wasmtime.wasmline/crow.mordecai.wasmline.MainActivity', { action=ACTION_UP, id[0]=0, pointerCount=1, eventTime=51746611, downTime=51746485, phoneEventTime=00:49:34.316 } moveCount:0\n00:49:34.332  I  ==============================================\n00:49:34.337  I  [Android] Wasm file : plugin.wasm    ||    wasm file exits : true    ||    wasm file path :  /data/user/0/crow.wasmtime.wasmline/cache/plugin.wasm\n00:49:34.338  I  [Android] Cwasm cache file : plugin.cwasm    ||    cache file exits : false    ||    cache file path :  /data/user/0/crow.wasmtime.wasmline/cache/plugin.cwasm\n00:49:34.345  I  [Wasmtime] Module --&gt; Jit Compiling for /data/user/0/crow.wasmtime.wasmline/cache/plugin.wasm...\n00:49:34.363  W  type=1400 audit(0.0:2008819): avc:  denied  { read } for  name=\"cpu.cfs_quota_us\" dev=\"cgroup\" ino=64 scontext=u:r:untrusted_app:s0:c190,c257,c512,c768 tcontext=u:object_r:cgroup:s0 tclass=file permissive=0 app=crow.wasmtime.wasmline\n00:49:34.363  W  type=1400 audit(0.0:2008820): avc:  denied  { read } for  name=\"cpu.cfs_period_us\" dev=\"cgroup\" ino=65 scontext=u:r:untrusted_app:s0:c190,c257,c512,c768 tcontext=u:object_r:cgroup:s0 tclass=file permissive=0 app=crow.wasmtime.wasmline\n00:49:34.363  W  type=1400 audit(0.0:2008821): avc:  denied  { read } for  name=\"cpu.cfs_quota_us\" dev=\"cgroup\" ino=10 scontext=u:r:untrusted_app:s0:c190,c257,c512,c768 tcontext=u:object_r:cgroup:s0 tclass=file permissive=0 app=crow.wasmtime.wasmline\n00:49:34.363  W  type=1400 audit(0.0:2008822): avc:  denied  { read } for  name=\"cpu.cfs_period_us\" dev=\"cgroup\" ino=11 scontext=u:r:untrusted_app:s0:c190,c257,c512,c768 tcontext=u:object_r:cgroup:s0 tclass=file permissive=0 app=crow.wasmtime.wasmline\n00:49:34.441  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 234952kb -&gt; 342100kb\n00:49:34.494  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 342100kb -&gt; 428844kb\n00:49:34.544  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 428844kb -&gt; 541612kb\n00:49:34.602  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 541612kb -&gt; 657240kb\n00:49:34.928  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 657240kb -&gt; 860432kb\n00:49:35.761  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 860432kb -&gt; 959324kb\n00:49:36.012  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 959324kb -&gt; 1075892kb\n00:49:36.184  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 1075892kb -&gt; 1183820kb\n00:49:37.835  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 1183820kb -&gt; 1306888kb\n00:49:38.482  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 1306888kb -&gt; 1450064kb\n00:49:38.639  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 1450064kb -&gt; 1612484kb\n00:49:38.700  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 1612484kb -&gt; 1389664kb\n00:49:38.700  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 1389664kb -&gt; 1011816kb\n00:49:38.702  E  [Wasmtime] Module --&gt; Error loading module /data/user/0/crow.wasmtime.wasmline/cache/plugin.wasm: Compilation error: Code for function is too large\n00:49:38.708  I  [Wasmline] Load failure, because native load return false, file path is :  /data/user/0/crow.wasmtime.wasmline/cache/plugin.wasm\n00:49:38.790  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 1011816kb -&gt; 727648kb\n</code></pre></div>\n<p><strong>Artifacts:</strong><br>\n<a href=\"https://github.com/user-attachments/files/24371302/Wasmline-wasmline-core-plugin.wasm.zip\">Wasmline-wasmline-core-plugin.wasm.zip</a></p>\n<ul>\n<li>\n<p><strong>Wasm File Size (781.63 KB):</strong><br>\n    ![Image](<a href=\"https://github.com/user-attachments/assets/eb138f47-365b-4acb-bf95-231109ef1595\">https://github.com/user-attachments/assets/eb138f47-365b-4acb-bf95-231109ef1595</a>)</p>\n</li>\n<li>\n<p><strong>Error Detail:</strong><br>\n    ![Image](<a href=\"https://github.com/user-attachments/assets/c7c95257-15e5-48ec-8dfd-48474d289ddd\">https://github.com/user-attachments/assets/c7c95257-15e5-48ec-8dfd-48474d289ddd</a>)</p>\n</li>\n<li>\n<p><strong>Success state (after reducing content):</strong><br>\n    ![Image](<a href=\"https://github.com/user-attachments/assets/7dac5f71-1e53-4475-87ff-3b4e553cee25\">https://github.com/user-attachments/assets/7dac5f71-1e53-4475-87ff-3b4e553cee25</a>)</p>\n</li>\n</ul>\n<p><strong>Analysis &amp; Questions:</strong></p>\n<ol>\n<li>Why does a relatively small Wasm file (under 1MB) trigger a \"Code too large\" error? It seems the Kotlin/Wasm compiler is generating a single function with extremely high complexity.</li>\n<li>The memory usage spike to 1.6GB suggests that Cranelift might be hitting a worst-case scenario in its e-graph optimization or register allocation phase.</li>\n<li>Are there any specific Cranelift settings to mitigate this, or is this a fundamental limit on function complexity regardless of the total <code>.wasm</code> file size?</li>\n</ol>\n</blockquote>",
        "id": 565699466,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767027836
    },
    {
        "content": "<p>crowforkotlin <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229#issuecomment-3697049070\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229\">issue #12229</a>:</p>\n<blockquote>\n<p>#11682 @cfallin </p>\n</blockquote>",
        "id": 565699499,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767027864
    },
    {
        "content": "<p>crowforkotlin edited <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229\">issue #12229</a>:</p>\n<blockquote>\n<h1>\"Code for function is too large\" error and 1.6GB Memory Spike during JIT compilation of a 781KB Kotlin/Wasm module</h1>\n<p><strong>Environment:</strong></p>\n<ul>\n<li><strong>Wasmtime version:</strong> v40.0.0 (Release #12192)</li>\n<li><strong>Host Machine (Build):</strong> Mac M2 (aarch64)</li>\n<li><strong>Target Device (Runtime):</strong> Android (aarch64)</li>\n<li><strong>Compiler:</strong> Kotlin/Wasm (WASI) via <code>compileProductionExecutableKotlinWasmWasiOptimize</code></li>\n<li><strong>Project Link:</strong> <a href=\"https://github.com/crowforkotlin/wasmline\">crowforkotlin/wasmline</a></li>\n<li><strong>Source File:</strong> <a href=\"https://github.com/crowforkotlin/wasmline/blob/main/wasmline-multiplatform/wasmline-core/plugin/src/wasmWasiMain/kotlin/crow/wasmtime/wasmline/Plugin.kt\">Plugin.kt</a></li>\n</ul>\n<p><strong>Description:</strong><br>\nI am reporting a <code>Compilation error: Code for function is too large</code> that occurs during the JIT loading phase on Android. </p>\n<p>Despite the generated <code>.wasm</code> binary being only <strong>781.63 KB</strong>, the compilation fails when a single Kotlin function contains a large amount of logic/content. During the attempt to compile this module, I observed a massive RSS memory spike on the Android device, jumping from <strong>~235 MB to over 1.6 GB</strong> in just 4 seconds, eventually resulting in the \"function too large\" error.</p>\n<p><strong>Wasmtime Configuration:</strong><br>\nThe engine is configured specifically for Android compatibility to avoid signal conflicts with ART and minimize VSS overhead:</p>\n<div class=\"codehilite\" data-code-language=\"C++\"><pre><span></span><code><span class=\"cm\">/**</span>\n<span class=\"cm\"> * Creates and configures the Wasm Config object.</span>\n<span class=\"cm\"> *</span>\n<span class=\"cm\"> * Critical Android Settings:</span>\n<span class=\"cm\"> * 1. Signals-based traps DISABLED: To prevent conflicts with Android ART signal handlers (SIGSEGV).</span>\n<span class=\"cm\"> * 2. Memory Guard Size = 0: To prevent VSS (Virtual Set Size) OOM on 32-bit or limited devices.</span>\n<span class=\"cm\"> * 3. GC / Exceptions: Enabled for Kotlin/Wasm support.</span>\n<span class=\"cm\"> */</span>\n<span class=\"n\">wasm_config_t</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"nf\">Engine::createConfig</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">wasm_config_t</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">conf</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">wasm_config_new</span><span class=\"p\">();</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// Feature Flags for Kotlin/Wasm support</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_config_wasm_gc_set</span><span class=\"p\">(</span><span class=\"n\">conf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">true</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_config_wasm_function_references_set</span><span class=\"p\">(</span><span class=\"n\">conf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">true</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_config_wasm_exceptions_set</span><span class=\"p\">(</span><span class=\"n\">conf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">true</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// Optimization: Disable SIMD if not strictly needed (improves compatibility)</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_config_wasm_simd_set</span><span class=\"p\">(</span><span class=\"n\">conf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">false</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_config_wasm_relaxed_simd_set</span><span class=\"p\">(</span><span class=\"n\">conf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">false</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// [CRITICAL] Disable signal handlers to avoid crash conflicts with Android Runtime (ART)</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_config_signals_based_traps_set</span><span class=\"p\">(</span><span class=\"n\">conf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">false</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// [CRITICAL] Set guard pages to 0 to minimize Virtual Memory usage (prevents OOM)</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_config_memory_guard_size_set</span><span class=\"p\">(</span><span class=\"n\">conf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// Set max stack size (512KB is usually sufficient for mobile logic)</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_config_max_wasm_stack_set</span><span class=\"p\">(</span><span class=\"n\">conf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">512</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">1024</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// Compiler Optimization Strategy: Optimize for Speed and Binary Size</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_config_cranelift_opt_level_set</span><span class=\"p\">(</span><span class=\"n\">conf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">WASMTIME_OPT_LEVEL_SPEED_AND_SIZE</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_config_cranelift_debug_verifier_set</span><span class=\"p\">(</span><span class=\"n\">conf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">false</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">conf</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p><strong>Reproduction Steps:</strong></p>\n<ol>\n<li>Add a large amount of content/logic into the <code>wasmWasiMain</code> function in <code>Plugin.kt</code>.</li>\n<li>Build the wasm file: <code>./gradlew wasmtime-core:plugin:compileProductionExecutableKotlinWasmWasiOptimize</code>.</li>\n<li>The resulting <code>plugin.wasm</code> is ~781 KB.</li>\n<li>Load the module on an Android device using the configuration above.</li>\n</ol>\n<p><strong>Observed Behavior:</strong></p>\n<ul>\n<li><strong>Total Wasm Size:</strong> 781.63 KB (Small)</li>\n<li><strong>Memory Usage:</strong> Spikes from 234MB to 1.6GB.</li>\n<li><strong>Result:</strong> <code>Compilation error: Code for function is too large</code>.</li>\n</ul>\n<p><strong>Full Android Logs:</strong></p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>00:49:34.204  I  [MotionEvent] ViewRootImpl windowName 'crow.wasmtime.wasmline/crow.mordecai.wasmline.MainActivity', { action=ACTION_DOWN, id[0]=0, pointerCount=1, eventTime=51746485, downTime=51746485, phoneEventTime=00:49:34.191 } moveCount:0\n00:49:34.206  D  getMiuiFreeformStackInfo mTmpFrames.miuiFreeFormStackInfo: null\n00:49:34.217  I  CreateGraphicsPipeline pipeline cache hit. elpased time: 0.32 ms.\n00:49:34.218  E  FrameInsert open fail: No such file or directory\n00:49:34.230  I  This is non sticky GC, maxfree is 33554432 minfree is 8388608\n00:49:34.227  W  type=1400 audit(0.0:2008818): avc:  denied  { getopt } for  path=\"/dev/socket/usap_pool_primary\" scontext=u:r:untrusted_app:s0:c190,c257,c512,c768 tcontext=u:r:zygote:s0 tclass=unix_stream_socket permissive=0 app=crow.wasmtime.wasmline\n00:49:34.322  I  [MotionEvent] ViewRootImpl windowName 'crow.wasmtime.wasmline/crow.mordecai.wasmline.MainActivity', { action=ACTION_UP, id[0]=0, pointerCount=1, eventTime=51746611, downTime=51746485, phoneEventTime=00:49:34.316 } moveCount:0\n00:49:34.332  I  ==============================================\n00:49:34.337  I  [Android] Wasm file : plugin.wasm    ||    wasm file exits : true    ||    wasm file path :  /data/user/0/crow.wasmtime.wasmline/cache/plugin.wasm\n00:49:34.338  I  [Android] Cwasm cache file : plugin.cwasm    ||    cache file exits : false    ||    cache file path :  /data/user/0/crow.wasmtime.wasmline/cache/plugin.cwasm\n00:49:34.345  I  [Wasmtime] Module --&gt; Jit Compiling for /data/user/0/crow.wasmtime.wasmline/cache/plugin.wasm...\n00:49:34.363  W  type=1400 audit(0.0:2008819): avc:  denied  { read } for  name=\"cpu.cfs_quota_us\" dev=\"cgroup\" ino=64 scontext=u:r:untrusted_app:s0:c190,c257,c512,c768 tcontext=u:object_r:cgroup:s0 tclass=file permissive=0 app=crow.wasmtime.wasmline\n00:49:34.363  W  type=1400 audit(0.0:2008820): avc:  denied  { read } for  name=\"cpu.cfs_period_us\" dev=\"cgroup\" ino=65 scontext=u:r:untrusted_app:s0:c190,c257,c512,c768 tcontext=u:object_r:cgroup:s0 tclass=file permissive=0 app=crow.wasmtime.wasmline\n00:49:34.363  W  type=1400 audit(0.0:2008821): avc:  denied  { read } for  name=\"cpu.cfs_quota_us\" dev=\"cgroup\" ino=10 scontext=u:r:untrusted_app:s0:c190,c257,c512,c768 tcontext=u:object_r:cgroup:s0 tclass=file permissive=0 app=crow.wasmtime.wasmline\n00:49:34.363  W  type=1400 audit(0.0:2008822): avc:  denied  { read } for  name=\"cpu.cfs_period_us\" dev=\"cgroup\" ino=11 scontext=u:r:untrusted_app:s0:c190,c257,c512,c768 tcontext=u:object_r:cgroup:s0 tclass=file permissive=0 app=crow.wasmtime.wasmline\n00:49:34.441  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 234952kb -&gt; 342100kb\n00:49:34.494  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 342100kb -&gt; 428844kb\n00:49:34.544  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 428844kb -&gt; 541612kb\n00:49:34.602  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 541612kb -&gt; 657240kb\n00:49:34.928  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 657240kb -&gt; 860432kb\n00:49:35.761  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 860432kb -&gt; 959324kb\n00:49:36.012  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 959324kb -&gt; 1075892kb\n00:49:36.184  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 1075892kb -&gt; 1183820kb\n00:49:37.835  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 1183820kb -&gt; 1306888kb\n00:49:38.482  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 1306888kb -&gt; 1450064kb\n00:49:38.639  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 1450064kb -&gt; 1612484kb\n00:49:38.700  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 1612484kb -&gt; 1389664kb\n00:49:38.700  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 1389664kb -&gt; 1011816kb\n00:49:38.702  E  [Wasmtime] Module --&gt; Error loading module /data/user/0/crow.wasmtime.wasmline/cache/plugin.wasm: Compilation error: Code for function is too large\n00:49:38.708  I  [Wasmline] Load failure, because native load return false, file path is :  /data/user/0/crow.wasmtime.wasmline/cache/plugin.wasm\n00:49:38.790  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 1011816kb -&gt; 727648kb\n</code></pre></div>\n<p><strong>Artifacts:</strong><br>\n<a href=\"https://github.com/user-attachments/files/24371302/Wasmline-wasmline-core-plugin.wasm.zip\">Wasmline-wasmline-core-plugin.wasm.zip</a></p>\n<ul>\n<li>\n<p><strong>Wasm File Size (781.63 KB):</strong><br>\n    ![Image](<a href=\"https://github.com/user-attachments/assets/eb138f47-365b-4acb-bf95-231109ef1595\">https://github.com/user-attachments/assets/eb138f47-365b-4acb-bf95-231109ef1595</a>)</p>\n</li>\n<li>\n<p><strong>Error Detail:</strong><br>\n    ![Image](<a href=\"https://github.com/user-attachments/assets/c7c95257-15e5-48ec-8dfd-48474d289ddd\">https://github.com/user-attachments/assets/c7c95257-15e5-48ec-8dfd-48474d289ddd</a>)</p>\n</li>\n<li>\n<p><strong>Success state (after reducing content):</strong><br>\n    ![Image](<a href=\"https://github.com/user-attachments/assets/7dac5f71-1e53-4475-87ff-3b4e553cee25\">https://github.com/user-attachments/assets/7dac5f71-1e53-4475-87ff-3b4e553cee25</a>)</p>\n</li>\n</ul>\n<p><strong>Analysis &amp; Questions:</strong></p>\n<ol>\n<li>Why does a relatively small Wasm file (under 1MB) trigger a \"Code too large\" error? It seems the Kotlin/Wasm compiler is generating a single function with extremely high complexity.</li>\n<li>The memory usage spike to 1.6GB suggests that Cranelift might be hitting a worst-case scenario in its e-graph optimization or register allocation phase.</li>\n<li>Are there any specific Cranelift settings to mitigate this, or is this a fundamental limit on function complexity regardless of the total <code>.wasm</code> file size?</li>\n</ol>\n</blockquote>",
        "id": 565699529,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767027884
    },
    {
        "content": "<p>crowforkotlin <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229#issuecomment-3697061748\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229\">issue #12229</a>:</p>\n<blockquote>\n<p>&lt;img width=\"1739\" height=\"467\" alt=\"Image\" src=\"<a href=\"https://github.com/user-attachments/assets/54509e4b-a92b-4792-a6ac-13ac5f82e617\">https://github.com/user-attachments/assets/54509e4b-a92b-4792-a6ac-13ac5f82e617</a>\" /&gt;</p>\n<p><a href=\"https://github.com/user-attachments/files/24371389/Wasmline-wasmline-core-plugin.wasm.zip\">Wasmline-wasmline-core-plugin.wasm.zip</a></p>\n<p>./wasmtime compile Wasmline-wasmline-core-plugin.wasm -o plugin.cwasm \\<br>\n    --target aarch64-linux-android \\<br>\n    -W gc=y \\<br>\n    -W function-references=y \\<br>\n    -W exceptions=y \\<br>\n    -W simd=n \\<br>\n    -W relaxed-simd=n \\<br>\n    -O static-memory-guard-size=0 \\<br>\n    -O dynamic-memory-guard-size=0 \\<br>\n    -O signals-based-traps=n \\<br>\n    -O opt-level=2 \\<br>\n    -C cranelift-debug-verifier=no</p>\n</blockquote>",
        "id": 565700279,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767028249
    },
    {
        "content": "<p>crowforkotlin edited a <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229#issuecomment-3697061748\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229\">issue #12229</a>:</p>\n<blockquote>\n<p>&lt;img width=\"1739\" height=\"467\" alt=\"Image\" src=\"<a href=\"https://github.com/user-attachments/assets/54509e4b-a92b-4792-a6ac-13ac5f82e617\">https://github.com/user-attachments/assets/54509e4b-a92b-4792-a6ac-13ac5f82e617</a>\" /&gt;</p>\n<p><a href=\"https://github.com/user-attachments/files/24371389/Wasmline-wasmline-core-plugin.wasm.zip\">Wasmline-wasmline-core-plugin.wasm.zip</a></p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"n\">compile</span><span class=\"w\"> </span><span class=\"n\">Wasmline</span><span class=\"o\">-</span><span class=\"n\">wasmline</span><span class=\"o\">-</span><span class=\"n\">core</span><span class=\"o\">-</span><span class=\"n\">plugin</span><span class=\"p\">.</span><span class=\"n\">wasm</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"n\">plugin</span><span class=\"p\">.</span><span class=\"n\">cwasm</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"w\">    </span><span class=\"o\">--</span><span class=\"n\">target</span><span class=\"w\"> </span><span class=\"n\">aarch64</span><span class=\"o\">-</span><span class=\"n\">linux</span><span class=\"o\">-</span><span class=\"n\">android</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"w\">    </span><span class=\"o\">-</span><span class=\"n\">W</span><span class=\"w\"> </span><span class=\"n\">gc</span><span class=\"o\">=</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"w\">    </span><span class=\"o\">-</span><span class=\"n\">W</span><span class=\"w\"> </span><span class=\"n\">function</span><span class=\"o\">-</span><span class=\"n\">references</span><span class=\"o\">=</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"w\">    </span><span class=\"o\">-</span><span class=\"n\">W</span><span class=\"w\"> </span><span class=\"n\">exceptions</span><span class=\"o\">=</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"w\">    </span><span class=\"o\">-</span><span class=\"n\">W</span><span class=\"w\"> </span><span class=\"n\">simd</span><span class=\"o\">=</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"w\">    </span><span class=\"o\">-</span><span class=\"n\">W</span><span class=\"w\"> </span><span class=\"n\">relaxed</span><span class=\"o\">-</span><span class=\"n\">simd</span><span class=\"o\">=</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"w\">    </span><span class=\"o\">-</span><span class=\"n\">O</span><span class=\"w\"> </span><span class=\"k\">static</span><span class=\"o\">-</span><span class=\"n\">memory</span><span class=\"o\">-</span><span class=\"n\">guard</span><span class=\"o\">-</span><span class=\"n\">size</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"w\">    </span><span class=\"o\">-</span><span class=\"n\">O</span><span class=\"w\"> </span><span class=\"n\">dynamic</span><span class=\"o\">-</span><span class=\"n\">memory</span><span class=\"o\">-</span><span class=\"n\">guard</span><span class=\"o\">-</span><span class=\"n\">size</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"w\">    </span><span class=\"o\">-</span><span class=\"n\">O</span><span class=\"w\"> </span><span class=\"n\">signals</span><span class=\"o\">-</span><span class=\"n\">based</span><span class=\"o\">-</span><span class=\"n\">traps</span><span class=\"o\">=</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"w\">    </span><span class=\"o\">-</span><span class=\"n\">O</span><span class=\"w\"> </span><span class=\"n\">opt</span><span class=\"o\">-</span><span class=\"n\">level</span><span class=\"o\">=</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"w\">    </span><span class=\"o\">-</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"n\">cranelift</span><span class=\"o\">-</span><span class=\"n\">debug</span><span class=\"o\">-</span><span class=\"n\">verifier</span><span class=\"o\">=</span><span class=\"n\">no</span>\n</code></pre></div>\n</blockquote>",
        "id": 565700299,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767028261
    },
    {
        "content": "<p>crowforkotlin <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229#issuecomment-3697072772\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229\">issue #12229</a>:</p>\n<blockquote>\n<p>&lt;img width=\"2860\" height=\"676\" alt=\"Image\" src=\"<a href=\"https://github.com/user-attachments/assets/c1d23ee4-febb-4cfa-964a-b84c2fd47dd3\">https://github.com/user-attachments/assets/c1d23ee4-febb-4cfa-964a-b84c2fd47dd3</a>\" /&gt;</p>\n<p><a href=\"https://github.com/user-attachments/files/24371447/wasm.zip\">wasm.zip</a></p>\n</blockquote>",
        "id": 565700875,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767028580
    },
    {
        "content": "<p>crowforkotlin edited <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229\">issue #12229</a>:</p>\n<blockquote>\n<h1>\"Code for function is too large\" error and 1.6GB Memory Spike during JIT compilation of a 781KB Kotlin/Wasm module</h1>\n<p><strong>Environment:</strong></p>\n<ul>\n<li><strong>Wasmtime version:</strong> v40.0.0 (Release #12192)</li>\n<li><strong>Host Machine (Build):</strong> Mac M2 (aarch64)</li>\n<li><strong>Target Device (Runtime):</strong> Android (aarch64)</li>\n<li><strong>Compiler:</strong> Kotlin/Wasm (WASI) via <code>compileProductionExecutableKotlinWasmWasiOptimize</code></li>\n<li><strong>Project Link:</strong> <a href=\"https://github.com/crowforkotlin/wasmline\">crowforkotlin/wasmline</a></li>\n<li><strong>Source File:</strong> <a href=\"https://github.com/crowforkotlin/wasmline/blob/main/wasmline-multiplatform/wasmline-core/plugin/src/wasmWasiMain/kotlin/crow/wasmtime/wasmline/Plugin.kt\">Plugin.kt</a></li>\n</ul>\n<p><strong>Description:</strong><br>\nI am reporting a <code>Compilation error: Code for function is too large</code> that occurs during the JIT loading phase on Android. </p>\n<p>Despite the generated <code>.wasm</code> binary being only <strong>781.63 KB</strong>, the compilation fails when a single Kotlin function contains a large amount of logic/content. During the attempt to compile this module, I observed a massive RSS memory spike on the Android device, jumping from <strong>~235 MB to over 1.6 GB</strong> in just 4 seconds, eventually resulting in the \"function too large\" error.</p>\n<p><strong>Wasmtime Configuration:</strong><br>\nThe engine is configured specifically for Android compatibility to avoid signal conflicts with ART and minimize VSS overhead:</p>\n<div class=\"codehilite\" data-code-language=\"C++\"><pre><span></span><code><span class=\"cm\">/**</span>\n<span class=\"cm\"> * Creates and configures the Wasm Config object.</span>\n<span class=\"cm\"> *</span>\n<span class=\"cm\"> * Critical Android Settings:</span>\n<span class=\"cm\"> * 1. Signals-based traps DISABLED: To prevent conflicts with Android ART signal handlers (SIGSEGV).</span>\n<span class=\"cm\"> * 2. Memory Guard Size = 0: To prevent VSS (Virtual Set Size) OOM on 32-bit or limited devices.</span>\n<span class=\"cm\"> * 3. GC / Exceptions: Enabled for Kotlin/Wasm support.</span>\n<span class=\"cm\"> */</span>\n<span class=\"n\">wasm_config_t</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"nf\">Engine::createConfig</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">wasm_config_t</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">conf</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">wasm_config_new</span><span class=\"p\">();</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// Feature Flags for Kotlin/Wasm support</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_config_wasm_gc_set</span><span class=\"p\">(</span><span class=\"n\">conf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">true</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_config_wasm_function_references_set</span><span class=\"p\">(</span><span class=\"n\">conf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">true</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_config_wasm_exceptions_set</span><span class=\"p\">(</span><span class=\"n\">conf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">true</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// Optimization: Disable SIMD if not strictly needed (improves compatibility)</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_config_wasm_simd_set</span><span class=\"p\">(</span><span class=\"n\">conf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">false</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_config_wasm_relaxed_simd_set</span><span class=\"p\">(</span><span class=\"n\">conf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">false</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// [CRITICAL] Disable signal handlers to avoid crash conflicts with Android Runtime (ART)</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_config_signals_based_traps_set</span><span class=\"p\">(</span><span class=\"n\">conf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">false</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// [CRITICAL] Set guard pages to 0 to minimize Virtual Memory usage (prevents OOM)</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_config_memory_guard_size_set</span><span class=\"p\">(</span><span class=\"n\">conf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// Set max stack size (512KB is usually sufficient for mobile logic)</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_config_max_wasm_stack_set</span><span class=\"p\">(</span><span class=\"n\">conf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">512</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">1024</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// Compiler Optimization Strategy: Optimize for Speed and Binary Size</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_config_cranelift_opt_level_set</span><span class=\"p\">(</span><span class=\"n\">conf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">WASMTIME_OPT_LEVEL_SPEED_AND_SIZE</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_config_cranelift_debug_verifier_set</span><span class=\"p\">(</span><span class=\"n\">conf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">false</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">conf</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p><strong>Reproduction Steps:</strong></p>\n<ol>\n<li>Add a large amount of content/logic into the <code>wasmWasiMain</code> function in <code>Plugin.kt</code>.</li>\n<li>Build the wasm file: <code>./gradlew wasmtime-core:plugin:compileProductionExecutableKotlinWasmWasiOptimize</code>.</li>\n<li>The resulting <code>plugin.wasm</code> is ~781 KB.</li>\n<li>Load the module on an Android device using the configuration above.</li>\n</ol>\n<p><strong>Observed Behavior:</strong></p>\n<ul>\n<li><strong>Total Wasm Size:</strong> 781.63 KB (Small)</li>\n<li><strong>Memory Usage:</strong> Spikes from 234MB to 1.6GB.</li>\n<li><strong>Result:</strong> <code>Compilation error: Code for function is too large</code>.</li>\n</ul>\n<p><strong>Full Android Logs:</strong></p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>00:49:34.204  I  [MotionEvent] ViewRootImpl windowName 'crow.wasmtime.wasmline/crow.mordecai.wasmline.MainActivity', { action=ACTION_DOWN, id[0]=0, pointerCount=1, eventTime=51746485, downTime=51746485, phoneEventTime=00:49:34.191 } moveCount:0\n00:49:34.206  D  getMiuiFreeformStackInfo mTmpFrames.miuiFreeFormStackInfo: null\n00:49:34.217  I  CreateGraphicsPipeline pipeline cache hit. elpased time: 0.32 ms.\n00:49:34.218  E  FrameInsert open fail: No such file or directory\n00:49:34.230  I  This is non sticky GC, maxfree is 33554432 minfree is 8388608\n00:49:34.227  W  type=1400 audit(0.0:2008818): avc:  denied  { getopt } for  path=\"/dev/socket/usap_pool_primary\" scontext=u:r:untrusted_app:s0:c190,c257,c512,c768 tcontext=u:r:zygote:s0 tclass=unix_stream_socket permissive=0 app=crow.wasmtime.wasmline\n00:49:34.322  I  [MotionEvent] ViewRootImpl windowName 'crow.wasmtime.wasmline/crow.mordecai.wasmline.MainActivity', { action=ACTION_UP, id[0]=0, pointerCount=1, eventTime=51746611, downTime=51746485, phoneEventTime=00:49:34.316 } moveCount:0\n00:49:34.332  I  ==============================================\n00:49:34.337  I  [Android] Wasm file : plugin.wasm    ||    wasm file exits : true    ||    wasm file path :  /data/user/0/crow.wasmtime.wasmline/cache/plugin.wasm\n00:49:34.338  I  [Android] Cwasm cache file : plugin.cwasm    ||    cache file exits : false    ||    cache file path :  /data/user/0/crow.wasmtime.wasmline/cache/plugin.cwasm\n00:49:34.345  I  [Wasmtime] Module --&gt; Jit Compiling for /data/user/0/crow.wasmtime.wasmline/cache/plugin.wasm...\n00:49:34.363  W  type=1400 audit(0.0:2008819): avc:  denied  { read } for  name=\"cpu.cfs_quota_us\" dev=\"cgroup\" ino=64 scontext=u:r:untrusted_app:s0:c190,c257,c512,c768 tcontext=u:object_r:cgroup:s0 tclass=file permissive=0 app=crow.wasmtime.wasmline\n00:49:34.363  W  type=1400 audit(0.0:2008820): avc:  denied  { read } for  name=\"cpu.cfs_period_us\" dev=\"cgroup\" ino=65 scontext=u:r:untrusted_app:s0:c190,c257,c512,c768 tcontext=u:object_r:cgroup:s0 tclass=file permissive=0 app=crow.wasmtime.wasmline\n00:49:34.363  W  type=1400 audit(0.0:2008821): avc:  denied  { read } for  name=\"cpu.cfs_quota_us\" dev=\"cgroup\" ino=10 scontext=u:r:untrusted_app:s0:c190,c257,c512,c768 tcontext=u:object_r:cgroup:s0 tclass=file permissive=0 app=crow.wasmtime.wasmline\n00:49:34.363  W  type=1400 audit(0.0:2008822): avc:  denied  { read } for  name=\"cpu.cfs_period_us\" dev=\"cgroup\" ino=11 scontext=u:r:untrusted_app:s0:c190,c257,c512,c768 tcontext=u:object_r:cgroup:s0 tclass=file permissive=0 app=crow.wasmtime.wasmline\n00:49:34.441  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 234952kb -&gt; 342100kb\n00:49:34.494  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 342100kb -&gt; 428844kb\n00:49:34.544  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 428844kb -&gt; 541612kb\n00:49:34.602  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 541612kb -&gt; 657240kb\n00:49:34.928  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 657240kb -&gt; 860432kb\n00:49:35.761  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 860432kb -&gt; 959324kb\n00:49:36.012  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 959324kb -&gt; 1075892kb\n00:49:36.184  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 1075892kb -&gt; 1183820kb\n00:49:37.835  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 1183820kb -&gt; 1306888kb\n00:49:38.482  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 1306888kb -&gt; 1450064kb\n00:49:38.639  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 1450064kb -&gt; 1612484kb\n00:49:38.700  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 1612484kb -&gt; 1389664kb\n00:49:38.700  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 1389664kb -&gt; 1011816kb\n00:49:38.702  E  [Wasmtime] Module --&gt; Error loading module /data/user/0/crow.wasmtime.wasmline/cache/plugin.wasm: Compilation error: Code for function is too large\n00:49:38.708  I  [Wasmline] Load failure, because native load return false, file path is :  /data/user/0/crow.wasmtime.wasmline/cache/plugin.wasm\n00:49:38.790  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 1011816kb -&gt; 727648kb\n</code></pre></div>\n<p><strong>Artifacts:</strong><br>\n<a href=\"https://github.com/user-attachments/files/24371302/Wasmline-wasmline-core-plugin.wasm.zip\">Wasmline-wasmline-core-plugin.wasm.zip</a></p>\n<ul>\n<li>\n<p><strong>Wasm File Size (781.63 KB):</strong><br>\n    ![Image](<a href=\"https://github.com/user-attachments/assets/eb138f47-365b-4acb-bf95-231109ef1595\">https://github.com/user-attachments/assets/eb138f47-365b-4acb-bf95-231109ef1595</a>)</p>\n</li>\n<li>\n<p><strong>Error Detail:</strong><br>\n    ![Image](<a href=\"https://github.com/user-attachments/assets/c7c95257-15e5-48ec-8dfd-48474d289ddd\">https://github.com/user-attachments/assets/c7c95257-15e5-48ec-8dfd-48474d289ddd</a>)</p>\n</li>\n<li>\n<p><strong>Success state (after reducing content):</strong><br>\n    ![Image](<a href=\"https://github.com/user-attachments/assets/7dac5f71-1e53-4475-87ff-3b4e553cee25\">https://github.com/user-attachments/assets/7dac5f71-1e53-4475-87ff-3b4e553cee25</a>)</p>\n</li>\n</ul>\n<p><strong>Analysis &amp; Questions:</strong></p>\n<ol>\n<li>Why does a relatively small Wasm file (under 1MB) trigger a \"Code too large\" error? It seems the Kotlin/Wasm compiler is generating a single function with extremely high complexity.</li>\n<li>The memory usage spike to 1.6GB suggests that Cranelift might be hitting a worst-case scenario in its e-graph optimization or register allocation phase.</li>\n<li>Are there any specific Cranelift settings to mitigate this, or is this a fundamental limit on function complexity regardless of the total <code>.wasm</code> file size?</li>\n</ol>\n</blockquote>",
        "id": 565701376,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767028842
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229#issuecomment-3698009170\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229\">issue #12229</a>:</p>\n<blockquote>\n<p>Just an FYI -- I am on PTO and then at a conference, so I will be able to investigate this starting Mon, Jan 12. (Thanks for the report!)</p>\n</blockquote>",
        "id": 565735765,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767058660
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229#issuecomment-3698189842\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229\">issue #12229</a>:</p>\n<blockquote>\n<p>Actually, this was bothering me and I at least wanted to verify, so I double-checked with your provided Wasm module and the command</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"n\">compile</span><span class=\"w\"> </span><span class=\"n\">Wasmline</span><span class=\"o\">-</span><span class=\"n\">wasmline</span><span class=\"o\">-</span><span class=\"n\">core</span><span class=\"o\">-</span><span class=\"n\">plugin</span><span class=\"p\">.</span><span class=\"n\">wasm</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"n\">plugin</span><span class=\"p\">.</span><span class=\"n\">cwasm</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"w\">    </span><span class=\"o\">--</span><span class=\"n\">target</span><span class=\"w\"> </span><span class=\"n\">aarch64</span><span class=\"o\">-</span><span class=\"n\">linux</span><span class=\"o\">-</span><span class=\"n\">android</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"w\">    </span><span class=\"o\">-</span><span class=\"n\">W</span><span class=\"w\"> </span><span class=\"n\">gc</span><span class=\"o\">=</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"w\">    </span><span class=\"o\">-</span><span class=\"n\">W</span><span class=\"w\"> </span><span class=\"n\">function</span><span class=\"o\">-</span><span class=\"n\">references</span><span class=\"o\">=</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"w\">    </span><span class=\"o\">-</span><span class=\"n\">W</span><span class=\"w\"> </span><span class=\"n\">exceptions</span><span class=\"o\">=</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"w\">    </span><span class=\"o\">-</span><span class=\"n\">W</span><span class=\"w\"> </span><span class=\"n\">simd</span><span class=\"o\">=</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"w\">    </span><span class=\"o\">-</span><span class=\"n\">W</span><span class=\"w\"> </span><span class=\"n\">relaxed</span><span class=\"o\">-</span><span class=\"n\">simd</span><span class=\"o\">=</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"w\">    </span><span class=\"o\">-</span><span class=\"n\">O</span><span class=\"w\"> </span><span class=\"k\">static</span><span class=\"o\">-</span><span class=\"n\">memory</span><span class=\"o\">-</span><span class=\"n\">guard</span><span class=\"o\">-</span><span class=\"n\">size</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"w\">    </span><span class=\"o\">-</span><span class=\"n\">O</span><span class=\"w\"> </span><span class=\"n\">dynamic</span><span class=\"o\">-</span><span class=\"n\">memory</span><span class=\"o\">-</span><span class=\"n\">guard</span><span class=\"o\">-</span><span class=\"n\">size</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"w\">    </span><span class=\"o\">-</span><span class=\"n\">O</span><span class=\"w\"> </span><span class=\"n\">signals</span><span class=\"o\">-</span><span class=\"n\">based</span><span class=\"o\">-</span><span class=\"n\">traps</span><span class=\"o\">=</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"w\">    </span><span class=\"o\">-</span><span class=\"n\">O</span><span class=\"w\"> </span><span class=\"n\">opt</span><span class=\"o\">-</span><span class=\"n\">level</span><span class=\"o\">=</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"w\">    </span><span class=\"o\">-</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"n\">cranelift</span><span class=\"o\">-</span><span class=\"n\">debug</span><span class=\"o\">-</span><span class=\"n\">verifier</span><span class=\"o\">=</span><span class=\"n\">no</span>\n</code></pre></div>\n<p>However, both with a <code>wasmtime</code> built from <code>main</code> (b5272a5f103053f5ada2a38d5302a8d1e2de442d) and from just before the 40.0 branch was cut (ac3358b1c9a1b4ca2794236966e47946d76606ea), running on macOS/aarch64 as you specify, I see the command complete just fine with minimal time taken, and definitely no \"Code for function is too large\" error -- e.g. from <code>time</code>,</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">target</span><span class=\"o\">/</span><span class=\"n\">release</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"n\">compile</span><span class=\"w\"> </span><span class=\"n\">Wasmline</span><span class=\"o\">-</span><span class=\"n\">wasmline</span><span class=\"o\">-</span><span class=\"n\">core</span><span class=\"o\">-</span><span class=\"n\">plugin</span><span class=\"p\">.</span><span class=\"n\">wasm</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">o</span><span class=\"w\">    </span><span class=\"o\">-</span><span class=\"n\">W</span><span class=\"w\">    </span><span class=\"mf\">0.38</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"n\">user</span><span class=\"w\"> </span><span class=\"mf\">0.03</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"n\">system</span><span class=\"w\"> </span><span class=\"mi\">328</span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"n\">cpu</span><span class=\"w\"> </span><span class=\"mf\">0.126</span><span class=\"w\"> </span><span class=\"n\">total</span>\n</code></pre></div>\n<p>Am I missing some setting? I'm inclined to close as \"cannot reproduce\" if not but want to make sure I'm running exactly what you are.</p>\n</blockquote>",
        "id": 565740408,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767064816
    },
    {
        "content": "<p>crowforkotlin <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229#issuecomment-3698195510\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229\">issue #12229</a>:</p>\n<blockquote>\n<blockquote>\n<p>Actually, this was bothering me and I at least wanted to verify, so I double-checked with your provided Wasm module and the command Wasm </p>\n<p><code>\n./wasmtime compile Wasmline-wasmline-core-plugin.wasm -o plugin.cwasm \\\n    --target aarch64-linux-android \\\n    -W gc=y \\\n    -W function-references=y \\\n    -W exceptions=y \\\n    -W simd=n \\\n    -W relaxed-simd=n \\\n    -O static-memory-guard-size=0 \\\n    -O dynamic-memory-guard-size=0 \\\n    -O signals-based-traps=n \\\n    -O opt-level=2 \\\n    -C cranelift-debug-verifier=no\n</code></p>\n<p>However, both with a <code>wasmtime</code> built from <code>main</code> (<a href=\"https://github.com/bytecodealliance/wasmtime/commit/b5272a5f103053f5ada2a38d5302a8d1e2de442d\">b5272a5</a>) and from just before the 40.0 branch was cut (<a href=\"https://github.com/bytecodealliance/wasmtime/commit/ac3358b1c9a1b4ca2794236966e47946d76606ea\">ac3358b</a>), running on macOS/aarch64 as you specify, I see the command complete just fine with minimal time taken, and definitely no \"Code for function is too large\" error -- e.g. from <code>time</code>, <code>main</code> () <code>wasmtime</code>  40.0  <code>wasmtime</code> macOS/aarch64  -  <code>time</code></p>\n<p><code>\ntarget/release/wasmtime compile Wasmline-wasmline-core-plugin.wasm -o    -W    0.38s user 0.03s system 328% cpu 0.126 total\n</code></p>\n<p>Am I missing some setting? I'm inclined to close as \"cannot reproduce\" if not but want to make sure I'm running exactly what you are.</p>\n</blockquote>\n<p>The file download was incorrect. You used a WASM file generated from a small amount of code; it was my oversight for sending it to the wrong location. While the CWASM generated from that file works fine, using the larger WASM file (700KB+) to generate a CWASM triggers an exception. Im sending you the latest version now for you to check.</p>\n<p><a href=\"https://github.com/user-attachments/files/24376649/wasm.zip\">wasm.zip</a></p>\n</blockquote>",
        "id": 565740622,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767065139
    },
    {
        "content": "<p>crowforkotlin <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229#issuecomment-3698199300\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229\">issue #12229</a>:</p>\n<blockquote>\n<blockquote>\n<blockquote>\n<p>Actually, this was bothering me and I at least wanted to verify, so I double-checked with your provided Wasm module and the command Wasm  Wasm <br>\n<code>\n./wasmtime compile Wasmline-wasmline-core-plugin.wasm -o plugin.cwasm \\\n    --target aarch64-linux-android \\\n    -W gc=y \\\n    -W function-references=y \\\n    -W exceptions=y \\\n    -W simd=n \\\n    -W relaxed-simd=n \\\n    -O static-memory-guard-size=0 \\\n    -O dynamic-memory-guard-size=0 \\\n    -O signals-based-traps=n \\\n    -O opt-level=2 \\\n    -C cranelift-debug-verifier=no\n</code></p>\n<p>However, both with a <code>wasmtime</code> built from <code>main</code> (<a href=\"https://github.com/bytecodealliance/wasmtime/commit/b5272a5f103053f5ada2a38d5302a8d1e2de442d\">b5272a5</a>) and from just before the 40.0 branch was cut (<a href=\"https://github.com/bytecodealliance/wasmtime/commit/ac3358b1c9a1b4ca2794236966e47946d76606ea\">ac3358b</a>), running on macOS/aarch64 as you specify, I see the command complete just fine with minimal time taken, and definitely no \"Code for function is too large\" error -- e.g. from <code>time</code>, <code>main</code> () <code>wasmtime</code>  40.0  <code>wasmtime</code> macOS/aarch64  -  <code>time</code> <code>main</code> () <code>wasmtime</code>  40.0  <code>wasmtime</code> macOS/aarch64  -  <code>time</code><br>\n<code>\ntarget/release/wasmtime compile Wasmline-wasmline-core-plugin.wasm -o    -W    0.38s user 0.03s system 328% cpu 0.126 total\n</code></p>\n<p>Am I missing some setting? I'm inclined to close as \"cannot reproduce\" if not but want to make sure I'm running exactly what you are.</p>\n</blockquote>\n<p>The file download was incorrect. You used a WASM file generated from a small amount of code; it was my oversight for sending it to the wrong location. While the CWASM generated from that file works fine, using the larger WASM file (700KB+) to generate a CWASM triggers an exception. Im sending you the latest version now for you to check. WASM  CWASM  WASM 700KB+ CWASM </p>\n<p><a href=\"https://github.com/user-attachments/files/24376649/wasm.zip\">wasm.zip</a></p>\n</blockquote>\n<p>The Kotlin/WASI build process uses Gradle tasks to generate WASM artifacts. The output ZIP includes 'kotlin' and 'optimize' folders, which seem to act as a size-optimization toggle similar to a release environment switch.[<a href=\"https://www.google.com/url?sa=E&amp;q=https%3A%2F%2Fvertexaisearch.cloud.google.com%2Fgrounding-api-redirect%2FAUZIYQE3iJQLONBMHFucRZIkbDGH1Aj1xc18Y5cePPlw2w1mAI5X746z7syXbFkIWZy-Au75hdHGjHCvDtC5qGQd08wchL6G6AiTFhItQoJnaReb_BdO872m6iXBohJ6inLZ16xwQ9f71P2kTZTJu1gXOUmX-sukuGDL9Hgwg4Ma34vLrzKBZ85LlQZIARmb5pGEE37ENY_pt_5FkNFLHg%3D%3D\">1</a>] Yesterday, I inspected the WASM file with wasmtime-tools and discovered it contains over 22,000 global variables.[<a href=\"https://www.google.com/url?sa=E&amp;q=https%3A%2F%2Fvertexaisearch.cloud.google.com%2Fgrounding-api-redirect%2FAUZIYQE3iJQLONBMHFucRZIkbDGH1Aj1xc18Y5cePPlw2w1mAI5X746z7syXbFkIWZy-Au75hdHGjHCvDtC5qGQd08wchL6G6AiTFhItQoJnaReb_BdO872m6iXBohJ6inLZ16xwQ9f71P2kTZTJu1gXOUmX-sukuGDL9Hgwg4Ma34vLrzKBZ85LlQZIARmb5pGEE37ENY_pt_5FkNFLHg%3D%3D\">1</a>] I realize this is not an ideal implementation, but I'm concerned that if a user implements extensive logic in the future, the resulting large file size might trigger exceptions during CWASM generation.</p>\n</blockquote>",
        "id": 565740795,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767065370
    },
    {
        "content": "<p>crowforkotlin deleted a <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229#issuecomment-3698195510\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229\">issue #12229</a>:</p>\n<blockquote>\n<blockquote>\n<p>Actually, this was bothering me and I at least wanted to verify, so I double-checked with your provided Wasm module and the command Wasm </p>\n<p><code>\n./wasmtime compile Wasmline-wasmline-core-plugin.wasm -o plugin.cwasm \\\n    --target aarch64-linux-android \\\n    -W gc=y \\\n    -W function-references=y \\\n    -W exceptions=y \\\n    -W simd=n \\\n    -W relaxed-simd=n \\\n    -O static-memory-guard-size=0 \\\n    -O dynamic-memory-guard-size=0 \\\n    -O signals-based-traps=n \\\n    -O opt-level=2 \\\n    -C cranelift-debug-verifier=no\n</code></p>\n<p>However, both with a <code>wasmtime</code> built from <code>main</code> (<a href=\"https://github.com/bytecodealliance/wasmtime/commit/b5272a5f103053f5ada2a38d5302a8d1e2de442d\">b5272a5</a>) and from just before the 40.0 branch was cut (<a href=\"https://github.com/bytecodealliance/wasmtime/commit/ac3358b1c9a1b4ca2794236966e47946d76606ea\">ac3358b</a>), running on macOS/aarch64 as you specify, I see the command complete just fine with minimal time taken, and definitely no \"Code for function is too large\" error -- e.g. from <code>time</code>, <code>main</code> () <code>wasmtime</code>  40.0  <code>wasmtime</code> macOS/aarch64  -  <code>time</code></p>\n<p><code>\ntarget/release/wasmtime compile Wasmline-wasmline-core-plugin.wasm -o    -W    0.38s user 0.03s system 328% cpu 0.126 total\n</code></p>\n<p>Am I missing some setting? I'm inclined to close as \"cannot reproduce\" if not but want to make sure I'm running exactly what you are.</p>\n</blockquote>\n<p>The file download was incorrect. You used a WASM file generated from a small amount of code; it was my oversight for sending it to the wrong location. While the CWASM generated from that file works fine, using the larger WASM file (700KB+) to generate a CWASM triggers an exception. Im sending you the latest version now for you to check.</p>\n<p><a href=\"https://github.com/user-attachments/files/24376649/wasm.zip\">wasm.zip</a></p>\n</blockquote>",
        "id": 565740849,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767065434
    },
    {
        "content": "<p>crowforkotlin edited a <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229#issuecomment-3698199300\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229\">issue #12229</a>:</p>\n<blockquote>\n<blockquote>\n<blockquote>\n<p>Actually, this was bothering me and I at least wanted to verify, so I double-checked with your provided Wasm module and the command Wasm  Wasm <br>\n<code>\n./wasmtime compile Wasmline-wasmline-core-plugin.wasm -o plugin.cwasm \\\n    --target aarch64-linux-android \\\n    -W gc=y \\\n    -W function-references=y \\\n    -W exceptions=y \\\n    -W simd=n \\\n    -W relaxed-simd=n \\\n    -O static-memory-guard-size=0 \\\n    -O dynamic-memory-guard-size=0 \\\n    -O signals-based-traps=n \\\n    -O opt-level=2 \\\n    -C cranelift-debug-verifier=no\n</code></p>\n<p>However, both with a <code>wasmtime</code> built from <code>main</code> (<a href=\"https://github.com/bytecodealliance/wasmtime/commit/b5272a5f103053f5ada2a38d5302a8d1e2de442d\">b5272a5</a>) and from just before the 40.0 branch was cut (<a href=\"https://github.com/bytecodealliance/wasmtime/commit/ac3358b1c9a1b4ca2794236966e47946d76606ea\">ac3358b</a>), running on macOS/aarch64 as you specify, I see the command complete just fine with minimal time taken, and definitely no \"Code for function is too large\" error -- e.g. from <code>time</code>, <code>main</code> () <code>wasmtime</code>  40.0  <code>wasmtime</code> macOS/aarch64  -  <code>time</code> <code>main</code> () <code>wasmtime</code>  40.0  <code>wasmtime</code> macOS/aarch64  -  <code>time</code><br>\n<code>\ntarget/release/wasmtime compile Wasmline-wasmline-core-plugin.wasm -o    -W    0.38s user 0.03s system 328% cpu 0.126 total\n</code></p>\n<p>Am I missing some setting? I'm inclined to close as \"cannot reproduce\" if not but want to make sure I'm running exactly what you are.</p>\n</blockquote>\n<p>The file download was incorrect. You used a WASM file generated from a small amount of code; it was my oversight for sending it to the wrong location. While the CWASM generated from that file works fine, using the larger WASM file (700KB+) to generate a CWASM triggers an exception. Im sending you the latest version now for you to check. WASM  CWASM  WASM 700KB+ CWASM </p>\n</blockquote>\n<p><a href=\"https://github.com/user-attachments/files/24376649/wasm.zip\">wasm.zip</a></p>\n<p>The Kotlin/WASI build process uses Gradle tasks to generate WASM artifacts. The output ZIP includes 'kotlin' and 'optimize' folders, which seem to act as a size-optimization toggle similar to a release environment switch.[<a href=\"https://www.google.com/url?sa=E&amp;q=https%3A%2F%2Fvertexaisearch.cloud.google.com%2Fgrounding-api-redirect%2FAUZIYQE3iJQLONBMHFucRZIkbDGH1Aj1xc18Y5cePPlw2w1mAI5X746z7syXbFkIWZy-Au75hdHGjHCvDtC5qGQd08wchL6G6AiTFhItQoJnaReb_BdO872m6iXBohJ6inLZ16xwQ9f71P2kTZTJu1gXOUmX-sukuGDL9Hgwg4Ma34vLrzKBZ85LlQZIARmb5pGEE37ENY_pt_5FkNFLHg%3D%3D\">1</a>] Yesterday, I inspected the WASM file with wasmtime-tools and discovered it contains over 22,000 global variables.[<a href=\"https://www.google.com/url?sa=E&amp;q=https%3A%2F%2Fvertexaisearch.cloud.google.com%2Fgrounding-api-redirect%2FAUZIYQE3iJQLONBMHFucRZIkbDGH1Aj1xc18Y5cePPlw2w1mAI5X746z7syXbFkIWZy-Au75hdHGjHCvDtC5qGQd08wchL6G6AiTFhItQoJnaReb_BdO872m6iXBohJ6inLZ16xwQ9f71P2kTZTJu1gXOUmX-sukuGDL9Hgwg4Ma34vLrzKBZ85LlQZIARmb5pGEE37ENY_pt_5FkNFLHg%3D%3D\">1</a>] I realize this is not an ideal implementation, but I'm concerned that if a user implements extensive logic in the future, the resulting large file size might trigger exceptions during CWASM generation.</p>\n</blockquote>",
        "id": 565740871,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767065474
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229#issuecomment-3698281027\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229\">issue #12229</a>:</p>\n<blockquote>\n<p>Thanks for that. A few stats from your <code>optimized/Wasmline-wasmline-core-plugin.wasm</code> in your latest zip file, function 127 in the module:</p>\n<ul>\n<li>There are 4005519 (4 million) SSA values in the CLIF generated from that function body;</li>\n<li>There are 488081 (488k) basic blocks in that CLIF;</li>\n<li>There are 61796 Wasm bytecode operators in the function body;</li>\n<li>Those operators are distributed according to this histogram:</li>\n</ul>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"mi\">22433</span><span class=\"w\"> </span><span class=\"n\">global</span><span class=\"p\">.</span><span class=\"n\">get</span>\n<span class=\"mi\">16819</span><span class=\"w\"> </span><span class=\"n\">call</span>\n<span class=\"mi\">11238</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">.</span><span class=\"k\">const</span>\n<span class=\"mi\">5612</span><span class=\"w\"> </span><span class=\"n\">global</span><span class=\"p\">.</span><span class=\"n\">set</span>\n<span class=\"mi\">5608</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"p\">.</span><span class=\"n\">new</span>\n<span class=\"w\">  </span><span class=\"mi\">20</span><span class=\"w\"> </span><span class=\"n\">local</span><span class=\"p\">.</span><span class=\"n\">get</span>\n<span class=\"w\">  </span><span class=\"mi\">12</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"p\">.</span><span class=\"n\">set</span>\n<span class=\"w\">   </span><span class=\"mi\">9</span><span class=\"w\"> </span><span class=\"n\">end</span>\n<span class=\"w\">   </span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"n\">local</span><span class=\"p\">.</span><span class=\"n\">set</span>\n<span class=\"w\">   </span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"nb\">drop</span>\n<span class=\"w\">   </span><span class=\"mi\">6</span><span class=\"w\"> </span><span class=\"k\">ref</span><span class=\"p\">.</span><span class=\"n\">null</span>\n<span class=\"w\">   </span><span class=\"mi\">6</span><span class=\"w\"> </span><span class=\"k\">ref</span><span class=\"p\">.</span><span class=\"n\">is_null</span>\n<span class=\"w\">   </span><span class=\"mi\">6</span><span class=\"w\"> </span><span class=\"n\">local</span><span class=\"p\">.</span><span class=\"n\">tee</span>\n<span class=\"w\">   </span><span class=\"mi\">6</span><span class=\"w\"> </span><span class=\"k\">if</span>\n<span class=\"w\">   </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"n\">block</span>\n<span class=\"w\">   </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">unreachable</span>\n<span class=\"w\">   </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">try_table</span>\n<span class=\"w\">   </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">throw_ref</span>\n<span class=\"w\">   </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">br</span>\n<span class=\"w\">   </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">array</span><span class=\"p\">.</span><span class=\"n\">new_data</span>\n</code></pre></div>\n<p>So, my thoughts:</p>\n<ul>\n<li>It's not surprising at all that feeding a CFG of 488k basic blocks into an optimizing compiler causes memory usage to grow, potentially to over a gigabyte. That's the nature of the beast: we build IR in memory and do passes over it. Just representing the IR itself, nevermind the analysis results, is going to take a large fraction of the usage you observed. Our optimizing compiler is not designed to have linear-time overhead (that would be impossible while still performing the kinds of optimizations we want to do), so any function this large is likely to blow up.</li>\n<li><code>struct.new</code> in particular is expanding to a lot of IR, because of its inlined fast-path. I don't think that's the wrong choice though -- it makes sense to make allocation fast for the usual program structure that has maybe a few allocation sites per function, rather than try to optimize for code size for the uncommon case of a single function with 5608 <code>struct.new</code>s (!).</li>\n</ul>\n<p>The immediate issue is that lowering runs out of VRegs, for which we allow only 2M (2^21), because of bitpacking for efficiency. We could in theory look at increasing that. But at least we are returning a clean error (\"function too large\") rather than panic'ing.</p>\n<p>On a broader scale, I don't think Cranelift (or any optimizing backend) is going to meet your requirements/expectations if that is the code that you need to compile. I would thus recommend either:</p>\n<ul>\n<li>Using Winch, once it supports exceptions and GC (it currently does not support either); or</li>\n<li>Modifying your codegen to not produce such a function, e.g. by splitting it up, using table-driven setup, using initializer expressions for the globals if the graph is acyclic, or something else.</li>\n</ul>\n<p>cc @fitzgen for any thoughts on <code>struct.new</code>...</p>\n</blockquote>",
        "id": 565743848,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767068869
    },
    {
        "content": "<p>crowforkotlin <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229#issuecomment-3698516167\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229\">issue #12229</a>:</p>\n<blockquote>\n<blockquote>\n<ul>\n<li>histogram</li>\n</ul>\n</blockquote>\n<p>Hello, could you please share how you generated this histogram? Id like to learn the method to help with my future debugging.</p>\n</blockquote>",
        "id": 565754911,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767079259
    },
    {
        "content": "<p>crowforkotlin deleted a <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229#issuecomment-3698516167\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229\">issue #12229</a>:</p>\n<blockquote>\n<blockquote>\n<ul>\n<li>histogram</li>\n</ul>\n</blockquote>\n<p>Hello, could you please share how you generated this histogram? Id like to learn the method to help with my future debugging.</p>\n</blockquote>",
        "id": 565757562,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767081597
    },
    {
        "content": "<p>crowforkotlin <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229#issuecomment-3698808412\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229\">issue #12229</a>:</p>\n<blockquote>\n<p>Interestingly, after refining my Kotlin/Wasm (WASI) implementation, a 700KB Wasm file successfully compiled into a 28MB CWASM via JIT without triggering the \"Code for function is too large\" error. I suspect the Kotlin/Wasm compiler might be performing aggressive inlining, potentially collapsing numerous function implementations into a single entry point (e.g., the main function). If this aggressive inlining could be disabled or tuned, the issue might be resolved. For context, I have successfully tested the build and execution on an Android app.<br>\nAdditionally, I have a question regarding Wasmtime: is there a hard limit of 2 million virtual registers? Im trying to understand if this issue stems from the generation of approximately 4 million (4M) virtual register values.<br>\nI am planning to report this to the Kotlin team with the relevant details. While I am not entirely certain about the underlying mechanism, the issue is consistently reproducible.</p>\n<p><a href=\"https://github.com/user-attachments/files/24380037/wasm-success-size28mb.zip\">wasm-success-size28mb.zip</a></p>\n<p>@cfallin </p>\n</blockquote>",
        "id": 565765986,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767087200
    },
    {
        "content": "<p>fitzgen <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229#issuecomment-3702745029\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229\">issue #12229</a>:</p>\n<blockquote>\n<blockquote>\n<p><code>struct.new</code> in particular is expanding to a lot of IR, because of its inlined fast-path. I don't think that's the wrong choice though -- it makes sense to make allocation fast for the usual program structure that has maybe a few allocation sites per function, rather than try to optimize for code size for the uncommon case of a single function with 5608 <code>struct.new</code>s (!).</p>\n</blockquote>\n<p>We could possibly have a fuel counter for inlining the GC allocation fast path, and start deferring to out-of-line calls once the fuel is spent. This is nice because we already have out-of-line paths for allocation that we can reuse.</p>\n<p>Except... the (default) DRC collector <em>already</em> does allocation out-of-line; it only does field initialization inline. I expect that it is this field initialization that is what is blowing up the CLIF size relative to the input Wasm size. The DRC collector's barriers are <a href=\"https://github.com/bytecodealliance/wasmtime/blob/b5272a5f103053f5ada2a38d5302a8d1e2de442d/tests/disas/gc/drc/struct-new.wat\">not small</a>.</p>\n<p>That said, we don't have any existing code path to do allocation and field initialization out of line, so adding such a path would be purely new maintenance burden.</p>\n<p>Chris, did you check that this function doesn't blow any <a href=\"https://webassembly.github.io/spec/js-api/index.html#limits\">implementation limits</a>? We should be able to compile anything within those limits in theory (even if it hits slow paths or whatever). Those limits should in theory be caught by <code>wasmparser</code>'s validation, but it is always possible we missed something... Looking into this a little more now.</p>\n</blockquote>",
        "id": 565925869,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767208694
    },
    {
        "content": "<p>fitzgen <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229#issuecomment-3702760016\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229\">issue #12229</a>:</p>\n<blockquote>\n<blockquote>\n<p>Chris, did you check that this function doesn't blow any <a href=\"https://webassembly.github.io/spec/js-api/index.html#limits\">implementation limits</a>? We should be able to compile anything within those limits in theory (even if it hits slow paths or whatever). Those limits should in theory be caught by <code>wasmparser</code>'s validation, but it is always possible we missed something... Looking into this a little more now.</p>\n</blockquote>\n<p>I'm not seeing this break any limits, fwiw.</p>\n</blockquote>",
        "id": 565926569,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767209453
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229#issuecomment-3702846513\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229\">issue #12229</a>:</p>\n<blockquote>\n<blockquote>\n<p>is there a hard limit of 2 million virtual registers? Im trying to understand if this issue stems from the generation of approximately 4 million (4M) virtual register values.</p>\n</blockquote>\n<p>That's correct. (And yes, this doesn't hit any implementation limits; there are \"only\" 61k Wasm instructions in the function, which is far below the ~7MB limit.)</p>\n<p>I agree that \"should be able to compile any function at all within limits without a 'too large' error\" is a good goal to have, and is the ideal state to end up in. I also think that's a large project in general: not only the VReg limit (which we could raise today, at a ~few-percent compile time cost) but the blowup in the IR in general is likely going to lead to OOMs etc in worst-cases as long as we have a lot of inlined logic for some operators.</p>\n<p>I wonder if it would make sense to have a \"small operator footprint\" mode where anything nontrivial (more than one or two CLIF operators) becomes a libcall? And then select this mode if the function is too large or contains too many of a certain kind of operator? I guess that's an eager form of your \"fuel\" idea; starting that way rather than switching partway through. Though fuel seems workable too.</p>\n<p>For what it's worth, to ask the usual \"what would SpiderMonkey do?\" question, it seems that <a href=\"https://searchfox.org/firefox-main/rev/0d81523fc001f74ee970a750c20d994216f4f161/js/src/wasm/WasmHeuristics.h#69\">a tier-up heuristic</a> that estimates compilation cost will effectively prevent optimizing compilation if the function body is \"too large\". So we're in kind of a unique position where the standard Wasm implementation limits are agreed upon by engines that can always fall back to baseline but we must always use the optimizing compiler on every function if we're set up to use it at all. So we're trying to solve a much harder problem (and one that the implementation limits are arguably not designed to guard against).</p>\n</blockquote>",
        "id": 565929725,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767212197
    },
    {
        "content": "<p>crowforkotlin edited a <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229#issuecomment-3698199300\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229\">issue #12229</a>:</p>\n<blockquote>\n<blockquote>\n<blockquote>\n<p>Actually, this was bothering me and I at least wanted to verify, so I double-checked with your provided Wasm module and the command<br>\n<code>\n./wasmtime compile Wasmline-wasmline-core-plugin.wasm -o plugin.cwasm \\\n    --target aarch64-linux-android \\\n    -W gc=y \\\n    -W function-references=y \\\n    -W exceptions=y \\\n    -W simd=n \\\n    -W relaxed-simd=n \\\n    -O static-memory-guard-size=0 \\\n    -O dynamic-memory-guard-size=0 \\\n    -O signals-based-traps=n \\\n    -O opt-level=2 \\\n    -C cranelift-debug-verifier=no\n</code></p>\n<p>However, both with a <code>wasmtime</code> built from <code>main</code> (<a href=\"https://github.com/bytecodealliance/wasmtime/commit/b5272a5f103053f5ada2a38d5302a8d1e2de442d\">b5272a5</a>) and from just before the 40.0 branch was cut (<a href=\"https://github.com/bytecodealliance/wasmtime/commit/ac3358b1c9a1b4ca2794236966e47946d76606ea\">ac3358b</a>), running on macOS/aarch64 as you specify, I see the command complete just fine with minimal time taken, and definitely no \"Code for function is too large\" error -- e.g. from <code>time</code><br>\n<code>\ntarget/release/wasmtime compile Wasmline-wasmline-core-plugin.wasm -o    -W    0.38s user 0.03s system 328% cpu 0.126 total\n</code></p>\n<p>Am I missing some setting? I'm inclined to close as \"cannot reproduce\" if not but want to make sure I'm running exactly what you are.</p>\n</blockquote>\n<p>The file download was incorrect. You used a WASM file generated from a small amount of code; it was my oversight for sending it to the wrong location. While the CWASM generated from that file works fine, using the larger WASM file (700KB+) to generate a CWASM triggers an exception. Im sending you the latest version now for you to check.</p>\n</blockquote>\n<p><a href=\"https://github.com/user-attachments/files/24376649/wasm.zip\">wasm.zip</a></p>\n<p>The Kotlin/WASI build process uses Gradle tasks to generate WASM artifacts. The output ZIP includes 'kotlin' and 'optimize' folders, which seem to act as a size-optimization toggle similar to a release environment switch.[<a href=\"https://www.google.com/url?sa=E&amp;q=https%3A%2F%2Fvertexaisearch.cloud.google.com%2Fgrounding-api-redirect%2FAUZIYQE3iJQLONBMHFucRZIkbDGH1Aj1xc18Y5cePPlw2w1mAI5X746z7syXbFkIWZy-Au75hdHGjHCvDtC5qGQd08wchL6G6AiTFhItQoJnaReb_BdO872m6iXBohJ6inLZ16xwQ9f71P2kTZTJu1gXOUmX-sukuGDL9Hgwg4Ma34vLrzKBZ85LlQZIARmb5pGEE37ENY_pt_5FkNFLHg%3D%3D\">1</a>] Yesterday, I inspected the WASM file with wasmtime-tools and discovered it contains over 22,000 global variables.[<a href=\"https://www.google.com/url?sa=E&amp;q=https%3A%2F%2Fvertexaisearch.cloud.google.com%2Fgrounding-api-redirect%2FAUZIYQE3iJQLONBMHFucRZIkbDGH1Aj1xc18Y5cePPlw2w1mAI5X746z7syXbFkIWZy-Au75hdHGjHCvDtC5qGQd08wchL6G6AiTFhItQoJnaReb_BdO872m6iXBohJ6inLZ16xwQ9f71P2kTZTJu1gXOUmX-sukuGDL9Hgwg4Ma34vLrzKBZ85LlQZIARmb5pGEE37ENY_pt_5FkNFLHg%3D%3D\">1</a>] I realize this is not an ideal implementation, but I'm concerned that if a user implements extensive logic in the future, the resulting large file size might trigger exceptions during CWASM generation.</p>\n</blockquote>",
        "id": 565960630,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767254251
    },
    {
        "content": "<p><a href=\"https://github.com/alexcrichton\">alexcrichton</a> added the wasm-proposal:gc label to <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229\">Issue #12229</a>.</p>",
        "id": 566380898,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767627142
    },
    {
        "content": "<p>crowforkotlin <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229#issuecomment-3719105825\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229\">issue #12229</a>:</p>\n<blockquote>\n<p>I have reported the upstream issue regarding the IR explosion to the Kotlin team (see <a href=\"https://youtrack.jetbrains.com/issue/KT-83497/Kotlin-Wasm-Wasi-Monolithic-initialization-logic-triggers-Code-for-function-is-too-large-in-Wasmtime-due-to-IR-explosion\">KT-83497</a>). While we await a fix on their end, I would like to highlight a critical bottleneck in Wasmtime's JIT compilation.<br>\ncurrently, the JIT behavior is unstable for our use case. I observing exponential memory growth when processing these large initialization functions, which rapidly leads to OOM errors. Consequently, I have been forced to migrate my project entirely to AOT compilation to maintain stability.</p>\n</blockquote>",
        "id": 566744267,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767795639
    },
    {
        "content": "<p>fitzgen <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229#issuecomment-3720028343\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229\">issue #12229</a>:</p>\n<blockquote>\n<p>@crowforkotlin The JIT and AOT compilation pipelines are identical, the only difference is that when JITing we then map the resulting code as executable into the current process, rather than writing it to disk or giving it to the caller as a <code>Vec&lt;u8&gt;</code>. That is, if you observing exponential memory growth in one, then you should also see it in the other. Can you provide additional details for this new JIT vs AOT issue? Test case, steps to reproduce, etc. Thanks!</p>\n</blockquote>",
        "id": 566789305,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767808026
    },
    {
        "content": "<p>crowforkotlin <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229#issuecomment-3720075815\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229\">issue #12229</a>:</p>\n<blockquote>\n<blockquote>\n<p><a href=\"https://github.com/crowforkotlin\">@crowforkotlin</a> The JIT and AOT compilation pipelines are identical, the only difference is that when JITing we then map the resulting code as executable into the current process, rather than writing it to disk or giving it to the caller as a <code>Vec&lt;u8&gt;</code>. That is, if you observing exponential memory growth in one, then you should also see it in the other. Can you provide additional details for this new JIT vs AOT issue? Test case, steps to reproduce, etc. Thanks!</p>\n</blockquote>\n<p>Okay, I'll debug and output the details of AOT and JIT on Android when I have some free time in the next couple of days. If you need the sample, you might need to install <a href=\"https://developer.android.com/studio\">Android Studio</a> to run the <a href=\"https://github.com/crowforkotlin/wasmline/blob/main/wasmline-multiplatform/wasmline-sample/android/src/androidMain/kotlin/crow/mordecai/wasmline/MainActivity.kt\">wasmline-sample</a> test cases on a real Android device or emulator. If needed, I can provide remote assistance or technical support to help with setup and running. The sample isn't very complete right now, mainly because I haven't had much time to implement some features. I've been busy researching the removal of features from the wasmtime library, cross-platform building, and stability testing on different platforms.<br>\n</p>\n</blockquote>",
        "id": 566791722,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767808795
    },
    {
        "content": "<p>crowforkotlin edited a <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229#issuecomment-3720075815\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229\">issue #12229</a>:</p>\n<blockquote>\n<blockquote>\n<p><a href=\"https://github.com/crowforkotlin\">@crowforkotlin</a> The JIT and AOT compilation pipelines are identical, the only difference is that when JITing we then map the resulting code as executable into the current process, rather than writing it to disk or giving it to the caller as a <code>Vec&lt;u8&gt;</code>. That is, if you observing exponential memory growth in one, then you should also see it in the other. Can you provide additional details for this new JIT vs AOT issue? Test case, steps to reproduce, etc. Thanks!</p>\n</blockquote>\n<p>Okay, I'll debug and output the details of AOT and JIT on Android when I have some free time in the next couple of days. If you need the sample, you might need to install <a href=\"https://developer.android.com/studio\">Android Studio</a> to run the <a href=\"https://github.com/crowforkotlin/wasmline/blob/main/wasmline-multiplatform/wasmline-sample/android/src/androidMain/kotlin/crow/mordecai/wasmline/MainActivity.kt\">wasmline-sample</a> test cases on a real Android device or emulator. If needed, I can provide remote assistance or technical support to help with setup and running. The sample isn't very complete right now, and building it might be tricky for users who aren't familiar with KMP., mainly because I haven't had much time to implement some features. I've been busy researching the removal of features from the wasmtime library, cross-platform building, and stability testing on different platforms.<br>\n</p>\n</blockquote>",
        "id": 566792496,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767809025
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229#issuecomment-3720193257\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229\">issue #12229</a>:</p>\n<blockquote>\n<p>@crowforkotlin thanks for noting this new issue -- for reference though I don't think we maintainers will be able to install Android Studio and build your project; it would be best if you can provide us with a Wasm or WAT and compilation flags such that this reproduces with <code>wasmtime compile</code>. (For pure compilation issues, none of your other integration details should be relevant.)</p>\n</blockquote>",
        "id": 566797368,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767810628
    },
    {
        "content": "<p>crowforkotlin <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229#issuecomment-3728239059\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229\">issue #12229</a>:</p>\n<blockquote>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"err\"></span><span class=\"w\"> </span><span class=\"err\"></span><span class=\"w\"> </span><span class=\"o\">~/</span><span class=\"n\">Dow</span><span class=\"o\">/</span><span class=\"n\">kotlin</span><span class=\"o\">-</span><span class=\"mf\">2.3.2</span><span class=\"o\">/</span><span class=\"n\">p</span><span class=\"o\">/</span><span class=\"n\">optimized</span><span class=\"w\"> </span><span class=\"err\"></span><span class=\"w\"> </span><span class=\"n\">sh</span><span class=\"w\"> </span><span class=\"n\">check</span><span class=\"p\">.</span><span class=\"n\">sh</span><span class=\"w\">                                                             </span><span class=\"err\"></span><span class=\"w\"> </span><span class=\"mi\">18</span><span class=\"p\">:</span><span class=\"mi\">04</span><span class=\"p\">:</span><span class=\"mi\">12</span>\n<span class=\"n\">Starting</span><span class=\"w\"> </span><span class=\"n\">AOT</span><span class=\"w\"> </span><span class=\"n\">compilation</span><span class=\"w\"> </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">resource</span><span class=\"w\"> </span><span class=\"n\">monitoring</span><span class=\"o\">..</span><span class=\"p\">.</span>\n<span class=\"o\">----------------------------------------------------</span>\n<span class=\"w\">        </span><span class=\"n\">Command</span><span class=\"w\"> </span><span class=\"n\">being</span><span class=\"w\"> </span><span class=\"n\">timed</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s\">\"wasmtime compile ./wasmline-multiplatform-wasmline-sample-plugin.wasm -o ./plugin.cwasm --target aarch64-linux-android -W gc=y -W function-references=y -W exceptions=y -W simd=n -W relaxed-simd=n -O static-memory-guard-size=0 -O dynamic-memory-guard-size=0 -O signals-based-traps=n -O opt-level=2 -C cranelift-debug-verifier=n\"</span>\n<span class=\"w\">        </span><span class=\"n\">User</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">seconds</span><span class=\"p\">):</span><span class=\"w\"> </span><span class=\"mf\">0.00</span>\n<span class=\"w\">        </span><span class=\"n\">System</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">seconds</span><span class=\"p\">):</span><span class=\"w\"> </span><span class=\"mf\">0.00</span>\n<span class=\"w\">        </span><span class=\"n\">Percent</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">CPU</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"w\"> </span><span class=\"n\">job</span><span class=\"w\"> </span><span class=\"n\">got</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">%</span>\n<span class=\"w\">        </span><span class=\"n\">Elapsed</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">wall</span><span class=\"w\"> </span><span class=\"n\">clock</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">h</span><span class=\"p\">:</span><span class=\"nc\">mm</span><span class=\"p\">:</span><span class=\"nc\">ss</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"p\">:</span><span class=\"nc\">ss</span><span class=\"p\">):</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">:</span><span class=\"mf\">00.23</span>\n<span class=\"w\">        </span><span class=\"n\">Average</span><span class=\"w\"> </span><span class=\"n\">shared</span><span class=\"w\"> </span><span class=\"n\">text</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">kbytes</span><span class=\"p\">):</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">        </span><span class=\"n\">Average</span><span class=\"w\"> </span><span class=\"n\">unshared</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">kbytes</span><span class=\"p\">):</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">        </span><span class=\"n\">Average</span><span class=\"w\"> </span><span class=\"n\">stack</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">kbytes</span><span class=\"p\">):</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">        </span><span class=\"n\">Average</span><span class=\"w\"> </span><span class=\"n\">total</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">kbytes</span><span class=\"p\">):</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">        </span><span class=\"n\">Maximum</span><span class=\"w\"> </span><span class=\"n\">resident</span><span class=\"w\"> </span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">kbytes</span><span class=\"p\">):</span><span class=\"w\"> </span><span class=\"mi\">5380</span>\n<span class=\"w\">        </span><span class=\"n\">Average</span><span class=\"w\"> </span><span class=\"n\">resident</span><span class=\"w\"> </span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">kbytes</span><span class=\"p\">):</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">        </span><span class=\"n\">Major</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">requiring</span><span class=\"w\"> </span><span class=\"n\">I</span><span class=\"o\">/</span><span class=\"n\">O</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">page</span><span class=\"w\"> </span><span class=\"n\">faults</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">1411</span>\n<span class=\"w\">        </span><span class=\"n\">Minor</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">reclaiming</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">frame</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">page</span><span class=\"w\"> </span><span class=\"n\">faults</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">        </span><span class=\"n\">Voluntary</span><span class=\"w\"> </span><span class=\"n\">context</span><span class=\"w\"> </span><span class=\"n\">switches</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">        </span><span class=\"n\">Involuntary</span><span class=\"w\"> </span><span class=\"n\">context</span><span class=\"w\"> </span><span class=\"n\">switches</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">        </span><span class=\"n\">Swaps</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">        </span><span class=\"n\">File</span><span class=\"w\"> </span><span class=\"n\">system</span><span class=\"w\"> </span><span class=\"n\">inputs</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">        </span><span class=\"n\">File</span><span class=\"w\"> </span><span class=\"n\">system</span><span class=\"w\"> </span><span class=\"n\">outputs</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">        </span><span class=\"n\">Socket</span><span class=\"w\"> </span><span class=\"n\">messages</span><span class=\"w\"> </span><span class=\"n\">sent</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">        </span><span class=\"n\">Socket</span><span class=\"w\"> </span><span class=\"n\">messages</span><span class=\"w\"> </span><span class=\"n\">received</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">        </span><span class=\"n\">Signals</span><span class=\"w\"> </span><span class=\"n\">delivered</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">        </span><span class=\"n\">Page</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">bytes</span><span class=\"p\">):</span><span class=\"w\"> </span><span class=\"mi\">65536</span>\n<span class=\"w\">        </span><span class=\"n\">Exit</span><span class=\"w\"> </span><span class=\"n\">status</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"o\">----------------------------------------------------</span>\n<span class=\"n\">Compilation</span><span class=\"w\"> </span><span class=\"n\">successful</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">plugin</span><span class=\"p\">.</span><span class=\"n\">cwasm</span><span class=\"w\"> </span><span class=\"n\">generated</span><span class=\"p\">.</span>\n<span class=\"err\"></span><span class=\"w\"> </span><span class=\"err\"></span><span class=\"w\"> </span><span class=\"o\">~/</span><span class=\"n\">Dow</span><span class=\"o\">/</span><span class=\"n\">kotlin</span><span class=\"o\">-</span><span class=\"mf\">2.3.2</span><span class=\"o\">/</span><span class=\"n\">p</span><span class=\"o\">/</span><span class=\"n\">optimized</span><span class=\"w\"> </span><span class=\"err\"></span><span class=\"w\"> </span><span class=\"n\">bat</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">check</span><span class=\"p\">.</span><span class=\"n\">sh</span><span class=\"w\">                                                       </span><span class=\"err\"></span><span class=\"w\"> </span><span class=\"mi\">18</span><span class=\"p\">:</span><span class=\"mi\">04</span><span class=\"p\">:</span><span class=\"mi\">14</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">#!/bin/bash</span>\n\n<span class=\"p\">#</span><span class=\"w\"> </span><span class=\"n\">Configuration</span>\n<span class=\"n\">SOURCE_WASM</span><span class=\"o\">=</span><span class=\"s\">\"./wasmline-multiplatform-wasmline-sample-plugin.wasm\"</span>\n<span class=\"n\">OUTPUT_CWASM</span><span class=\"o\">=</span><span class=\"s\">\"./plugin.cwasm\"</span>\n<span class=\"n\">TARGET</span><span class=\"o\">=</span><span class=\"s\">\"aarch64-linux-android\"</span>\n\n<span class=\"n\">echo</span><span class=\"w\"> </span><span class=\"s\">\"Starting AOT compilation and resource monitoring...\"</span>\n<span class=\"n\">echo</span><span class=\"w\"> </span><span class=\"s\">\"----------------------------------------------------\"</span>\n\n<span class=\"p\">#</span><span class=\"w\"> </span><span class=\"n\">Using</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">usr</span><span class=\"o\">/</span><span class=\"n\">bin</span><span class=\"o\">/</span><span class=\"n\">time</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">detailed</span><span class=\"w\"> </span><span class=\"n\">resource</span><span class=\"w\"> </span><span class=\"n\">usage</span><span class=\"w\"> </span><span class=\"n\">report</span>\n<span class=\"p\">#</span><span class=\"w\"> </span><span class=\"n\">The</span><span class=\"w\"> </span><span class=\"n\">output</span><span class=\"w\"> </span><span class=\"n\">will</span><span class=\"w\"> </span><span class=\"n\">show</span><span class=\"w\"> </span><span class=\"n\">Peak</span><span class=\"w\"> </span><span class=\"n\">Memory</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">RSS</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">CPU</span><span class=\"w\"> </span><span class=\"n\">usage</span>\n<span class=\"o\">/</span><span class=\"n\">usr</span><span class=\"o\">/</span><span class=\"n\">bin</span><span class=\"o\">/</span><span class=\"n\">time</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"n\">compile</span><span class=\"w\"> </span><span class=\"s\">\"$SOURCE_WASM\"</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"s\">\"$OUTPUT_CWASM\"</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"w\">  </span><span class=\"o\">--</span><span class=\"n\">target</span><span class=\"w\"> </span><span class=\"s\">\"$TARGET\"</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"w\">  </span><span class=\"o\">-</span><span class=\"n\">W</span><span class=\"w\"> </span><span class=\"n\">gc</span><span class=\"o\">=</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"w\">  </span><span class=\"o\">-</span><span class=\"n\">W</span><span class=\"w\"> </span><span class=\"n\">function</span><span class=\"o\">-</span><span class=\"n\">references</span><span class=\"o\">=</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"w\">  </span><span class=\"o\">-</span><span class=\"n\">W</span><span class=\"w\"> </span><span class=\"n\">exceptions</span><span class=\"o\">=</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"w\">  </span><span class=\"o\">-</span><span class=\"n\">W</span><span class=\"w\"> </span><span class=\"n\">simd</span><span class=\"o\">=</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"w\">  </span><span class=\"o\">-</span><span class=\"n\">W</span><span class=\"w\"> </span><span class=\"n\">relaxed</span><span class=\"o\">-</span><span class=\"n\">simd</span><span class=\"o\">=</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"w\">  </span><span class=\"o\">-</span><span class=\"n\">O</span><span class=\"w\"> </span><span class=\"k\">static</span><span class=\"o\">-</span><span class=\"n\">memory</span><span class=\"o\">-</span><span class=\"n\">guard</span><span class=\"o\">-</span><span class=\"n\">size</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"w\">  </span><span class=\"o\">-</span><span class=\"n\">O</span><span class=\"w\"> </span><span class=\"n\">dynamic</span><span class=\"o\">-</span><span class=\"n\">memory</span><span class=\"o\">-</span><span class=\"n\">guard</span><span class=\"o\">-</span><span class=\"n\">size</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"w\">  </span><span class=\"o\">-</span><span class=\"n\">O</span><span class=\"w\"> </span><span class=\"n\">signals</span><span class=\"o\">-</span><span class=\"n\">based</span><span class=\"o\">-</span><span class=\"n\">traps</span><span class=\"o\">=</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"w\">  </span><span class=\"o\">-</span><span class=\"n\">O</span><span class=\"w\"> </span><span class=\"n\">opt</span><span class=\"o\">-</span><span class=\"n\">level</span><span class=\"o\">=</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"w\">  </span><span class=\"o\">-</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"n\">cranelift</span><span class=\"o\">-</span><span class=\"n\">debug</span><span class=\"o\">-</span><span class=\"n\">verifier</span><span class=\"o\">=</span><span class=\"n\">n</span>\n\n<span class=\"n\">EXIT_CODE</span><span class=\"o\">=</span><span class=\"cp\">$</span><span class=\"o\">?</span>\n\n<span class=\"n\">echo</span><span class=\"w\"> </span><span class=\"s\">\"----------------------------------------------------\"</span>\n<span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\"> </span><span class=\"cp\">$EXIT_CODE</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">eq</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">];</span><span class=\"w\"> </span><span class=\"n\">then</span>\n<span class=\"w\">    </span><span class=\"n\">echo</span><span class=\"w\"> </span><span class=\"s\">\"Compilation successful: $OUTPUT_CWASM generated.\"</span>\n<span class=\"k\">else</span>\n<span class=\"w\">    </span><span class=\"n\">echo</span><span class=\"w\"> </span><span class=\"s\">\"Error: Compilation failed with exit code $EXIT_CODE.\"</span>\n<span class=\"n\">fi</span>\n</code></pre></div>\n<p><a href=\"https://github.com/user-attachments/assets/4a1f4326-4dc0-4952-a9a8-6cc2d4f5667b\">https://github.com/user-attachments/assets/4a1f4326-4dc0-4952-a9a8-6cc2d4f5667b</a></p>\n<ul>\n<li>That's roughly the process. Honestly, it's not easy to observe this memory usage through the command line. However, it might take some time for me to refine the C++ sample, after which I can directly call the Wasmtime API to troubleshoot this issue. The specific location is here.</li>\n</ul>\n<p><a href=\"https://github.com/crowforkotlin/wasmline/blob/715f19fbd72f556da6e4a38ff6bb14e0ccda3b14/wasmline-core/src/Module.cpp#L58\">https://github.com/crowforkotlin/wasmline/blob/715f19fbd72f556da6e4a38ff6bb14e0ccda3b14/wasmline-core/src/Module.cpp#L58</a></p>\n<p><div class=\"codehilite\" data-code-language=\"C++\"><pre><span></span><code><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">isJit</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">LOGI</span><span class=\"p\">(</span><span class=\"s\">\"[Wasmtime] Module --&gt; Jit Compiling for %s...\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">filePath</span><span class=\"p\">.</span><span class=\"n\">c_str</span><span class=\"p\">());</span>\n<span class=\"w\">    </span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">wasmtime_module_new</span><span class=\"p\">(</span><span class=\"n\">engine</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"p\">.</span><span class=\"n\">data</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"p\">.</span><span class=\"n\">size</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"k\">module</span><span class=\"p\">);</span>\n<span class=\"p\">}</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">LOGI</span><span class=\"p\">(</span><span class=\"s\">\"[Wasmtime] Module --&gt; Aot Deserializing for %s...\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">filePath</span><span class=\"p\">.</span><span class=\"n\">c_str</span><span class=\"p\">());</span>\n<span class=\"w\">    </span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">wasmtime_module_deserialize</span><span class=\"p\">(</span><span class=\"n\">engine</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"p\">.</span><span class=\"n\">data</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"p\">.</span><span class=\"n\">size</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"k\">module</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n</code></pre></div><br>\n</p>\n</blockquote>",
        "id": 567107558,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767953360
    },
    {
        "content": "<p>crowforkotlin edited a <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229#issuecomment-3728239059\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229\">issue #12229</a>:</p>\n<blockquote>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"err\"></span><span class=\"w\"> </span><span class=\"err\"></span><span class=\"w\"> </span><span class=\"o\">~/</span><span class=\"n\">Dow</span><span class=\"o\">/</span><span class=\"n\">kotlin</span><span class=\"o\">-</span><span class=\"mf\">2.3.2</span><span class=\"o\">/</span><span class=\"n\">p</span><span class=\"o\">/</span><span class=\"n\">optimized</span><span class=\"w\"> </span><span class=\"err\"></span><span class=\"w\"> </span><span class=\"n\">sh</span><span class=\"w\"> </span><span class=\"n\">check</span><span class=\"p\">.</span><span class=\"n\">sh</span><span class=\"w\">                                                             </span><span class=\"err\"></span><span class=\"w\"> </span><span class=\"mi\">18</span><span class=\"p\">:</span><span class=\"mi\">04</span><span class=\"p\">:</span><span class=\"mi\">12</span>\n<span class=\"n\">Starting</span><span class=\"w\"> </span><span class=\"n\">AOT</span><span class=\"w\"> </span><span class=\"n\">compilation</span><span class=\"w\"> </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">resource</span><span class=\"w\"> </span><span class=\"n\">monitoring</span><span class=\"o\">..</span><span class=\"p\">.</span>\n<span class=\"o\">----------------------------------------------------</span>\n<span class=\"w\">        </span><span class=\"n\">Command</span><span class=\"w\"> </span><span class=\"n\">being</span><span class=\"w\"> </span><span class=\"n\">timed</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s\">\"wasmtime compile ./wasmline-multiplatform-wasmline-sample-plugin.wasm -o ./plugin.cwasm --target aarch64-linux-android -W gc=y -W function-references=y -W exceptions=y -W simd=n -W relaxed-simd=n -O static-memory-guard-size=0 -O dynamic-memory-guard-size=0 -O signals-based-traps=n -O opt-level=2 -C cranelift-debug-verifier=n\"</span>\n<span class=\"w\">        </span><span class=\"n\">User</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">seconds</span><span class=\"p\">):</span><span class=\"w\"> </span><span class=\"mf\">0.00</span>\n<span class=\"w\">        </span><span class=\"n\">System</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">seconds</span><span class=\"p\">):</span><span class=\"w\"> </span><span class=\"mf\">0.00</span>\n<span class=\"w\">        </span><span class=\"n\">Percent</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">CPU</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"w\"> </span><span class=\"n\">job</span><span class=\"w\"> </span><span class=\"n\">got</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">%</span>\n<span class=\"w\">        </span><span class=\"n\">Elapsed</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">wall</span><span class=\"w\"> </span><span class=\"n\">clock</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">h</span><span class=\"p\">:</span><span class=\"nc\">mm</span><span class=\"p\">:</span><span class=\"nc\">ss</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"p\">:</span><span class=\"nc\">ss</span><span class=\"p\">):</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">:</span><span class=\"mf\">00.23</span>\n<span class=\"w\">        </span><span class=\"n\">Average</span><span class=\"w\"> </span><span class=\"n\">shared</span><span class=\"w\"> </span><span class=\"n\">text</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">kbytes</span><span class=\"p\">):</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">        </span><span class=\"n\">Average</span><span class=\"w\"> </span><span class=\"n\">unshared</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">kbytes</span><span class=\"p\">):</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">        </span><span class=\"n\">Average</span><span class=\"w\"> </span><span class=\"n\">stack</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">kbytes</span><span class=\"p\">):</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">        </span><span class=\"n\">Average</span><span class=\"w\"> </span><span class=\"n\">total</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">kbytes</span><span class=\"p\">):</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">        </span><span class=\"n\">Maximum</span><span class=\"w\"> </span><span class=\"n\">resident</span><span class=\"w\"> </span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">kbytes</span><span class=\"p\">):</span><span class=\"w\"> </span><span class=\"mi\">5380</span>\n<span class=\"w\">        </span><span class=\"n\">Average</span><span class=\"w\"> </span><span class=\"n\">resident</span><span class=\"w\"> </span><span class=\"n\">set</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">kbytes</span><span class=\"p\">):</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">        </span><span class=\"n\">Major</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">requiring</span><span class=\"w\"> </span><span class=\"n\">I</span><span class=\"o\">/</span><span class=\"n\">O</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">page</span><span class=\"w\"> </span><span class=\"n\">faults</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">1411</span>\n<span class=\"w\">        </span><span class=\"n\">Minor</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">reclaiming</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">frame</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">page</span><span class=\"w\"> </span><span class=\"n\">faults</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">        </span><span class=\"n\">Voluntary</span><span class=\"w\"> </span><span class=\"n\">context</span><span class=\"w\"> </span><span class=\"n\">switches</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">        </span><span class=\"n\">Involuntary</span><span class=\"w\"> </span><span class=\"n\">context</span><span class=\"w\"> </span><span class=\"n\">switches</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">        </span><span class=\"n\">Swaps</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">        </span><span class=\"n\">File</span><span class=\"w\"> </span><span class=\"n\">system</span><span class=\"w\"> </span><span class=\"n\">inputs</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">        </span><span class=\"n\">File</span><span class=\"w\"> </span><span class=\"n\">system</span><span class=\"w\"> </span><span class=\"n\">outputs</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">        </span><span class=\"n\">Socket</span><span class=\"w\"> </span><span class=\"n\">messages</span><span class=\"w\"> </span><span class=\"n\">sent</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">        </span><span class=\"n\">Socket</span><span class=\"w\"> </span><span class=\"n\">messages</span><span class=\"w\"> </span><span class=\"n\">received</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">        </span><span class=\"n\">Signals</span><span class=\"w\"> </span><span class=\"n\">delivered</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"w\">        </span><span class=\"n\">Page</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">bytes</span><span class=\"p\">):</span><span class=\"w\"> </span><span class=\"mi\">65536</span>\n<span class=\"w\">        </span><span class=\"n\">Exit</span><span class=\"w\"> </span><span class=\"n\">status</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"o\">----------------------------------------------------</span>\n<span class=\"n\">Compilation</span><span class=\"w\"> </span><span class=\"n\">successful</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">plugin</span><span class=\"p\">.</span><span class=\"n\">cwasm</span><span class=\"w\"> </span><span class=\"n\">generated</span><span class=\"p\">.</span>\n<span class=\"err\"></span><span class=\"w\"> </span><span class=\"err\"></span><span class=\"w\"> </span><span class=\"o\">~/</span><span class=\"n\">Dow</span><span class=\"o\">/</span><span class=\"n\">kotlin</span><span class=\"o\">-</span><span class=\"mf\">2.3.2</span><span class=\"o\">/</span><span class=\"n\">p</span><span class=\"o\">/</span><span class=\"n\">optimized</span><span class=\"w\"> </span><span class=\"err\"></span><span class=\"w\"> </span><span class=\"n\">bat</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">P</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">check</span><span class=\"p\">.</span><span class=\"n\">sh</span><span class=\"w\">                                                       </span><span class=\"err\"></span><span class=\"w\"> </span><span class=\"mi\">18</span><span class=\"p\">:</span><span class=\"mi\">04</span><span class=\"p\">:</span><span class=\"mi\">14</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">#!/bin/bash</span>\n\n<span class=\"p\">#</span><span class=\"w\"> </span><span class=\"n\">Configuration</span>\n<span class=\"n\">SOURCE_WASM</span><span class=\"o\">=</span><span class=\"s\">\"./wasmline-multiplatform-wasmline-sample-plugin.wasm\"</span>\n<span class=\"n\">OUTPUT_CWASM</span><span class=\"o\">=</span><span class=\"s\">\"./plugin.cwasm\"</span>\n<span class=\"n\">TARGET</span><span class=\"o\">=</span><span class=\"s\">\"aarch64-linux-android\"</span>\n\n<span class=\"n\">echo</span><span class=\"w\"> </span><span class=\"s\">\"Starting AOT compilation and resource monitoring...\"</span>\n<span class=\"n\">echo</span><span class=\"w\"> </span><span class=\"s\">\"----------------------------------------------------\"</span>\n\n<span class=\"p\">#</span><span class=\"w\"> </span><span class=\"n\">Using</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">usr</span><span class=\"o\">/</span><span class=\"n\">bin</span><span class=\"o\">/</span><span class=\"n\">time</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">detailed</span><span class=\"w\"> </span><span class=\"n\">resource</span><span class=\"w\"> </span><span class=\"n\">usage</span><span class=\"w\"> </span><span class=\"n\">report</span>\n<span class=\"p\">#</span><span class=\"w\"> </span><span class=\"n\">The</span><span class=\"w\"> </span><span class=\"n\">output</span><span class=\"w\"> </span><span class=\"n\">will</span><span class=\"w\"> </span><span class=\"n\">show</span><span class=\"w\"> </span><span class=\"n\">Peak</span><span class=\"w\"> </span><span class=\"n\">Memory</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">RSS</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">CPU</span><span class=\"w\"> </span><span class=\"n\">usage</span>\n<span class=\"o\">/</span><span class=\"n\">usr</span><span class=\"o\">/</span><span class=\"n\">bin</span><span class=\"o\">/</span><span class=\"n\">time</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"n\">compile</span><span class=\"w\"> </span><span class=\"s\">\"$SOURCE_WASM\"</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"s\">\"$OUTPUT_CWASM\"</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"w\">  </span><span class=\"o\">--</span><span class=\"n\">target</span><span class=\"w\"> </span><span class=\"s\">\"$TARGET\"</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"w\">  </span><span class=\"o\">-</span><span class=\"n\">W</span><span class=\"w\"> </span><span class=\"n\">gc</span><span class=\"o\">=</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"w\">  </span><span class=\"o\">-</span><span class=\"n\">W</span><span class=\"w\"> </span><span class=\"n\">function</span><span class=\"o\">-</span><span class=\"n\">references</span><span class=\"o\">=</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"w\">  </span><span class=\"o\">-</span><span class=\"n\">W</span><span class=\"w\"> </span><span class=\"n\">exceptions</span><span class=\"o\">=</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"w\">  </span><span class=\"o\">-</span><span class=\"n\">W</span><span class=\"w\"> </span><span class=\"n\">simd</span><span class=\"o\">=</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"w\">  </span><span class=\"o\">-</span><span class=\"n\">W</span><span class=\"w\"> </span><span class=\"n\">relaxed</span><span class=\"o\">-</span><span class=\"n\">simd</span><span class=\"o\">=</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"w\">  </span><span class=\"o\">-</span><span class=\"n\">O</span><span class=\"w\"> </span><span class=\"k\">static</span><span class=\"o\">-</span><span class=\"n\">memory</span><span class=\"o\">-</span><span class=\"n\">guard</span><span class=\"o\">-</span><span class=\"n\">size</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"w\">  </span><span class=\"o\">-</span><span class=\"n\">O</span><span class=\"w\"> </span><span class=\"n\">dynamic</span><span class=\"o\">-</span><span class=\"n\">memory</span><span class=\"o\">-</span><span class=\"n\">guard</span><span class=\"o\">-</span><span class=\"n\">size</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"w\">  </span><span class=\"o\">-</span><span class=\"n\">O</span><span class=\"w\"> </span><span class=\"n\">signals</span><span class=\"o\">-</span><span class=\"n\">based</span><span class=\"o\">-</span><span class=\"n\">traps</span><span class=\"o\">=</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"w\">  </span><span class=\"o\">-</span><span class=\"n\">O</span><span class=\"w\"> </span><span class=\"n\">opt</span><span class=\"o\">-</span><span class=\"n\">level</span><span class=\"o\">=</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"err\">\\</span>\n<span class=\"w\">  </span><span class=\"o\">-</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"n\">cranelift</span><span class=\"o\">-</span><span class=\"n\">debug</span><span class=\"o\">-</span><span class=\"n\">verifier</span><span class=\"o\">=</span><span class=\"n\">n</span>\n\n<span class=\"n\">EXIT_CODE</span><span class=\"o\">=</span><span class=\"cp\">$</span><span class=\"o\">?</span>\n\n<span class=\"n\">echo</span><span class=\"w\"> </span><span class=\"s\">\"----------------------------------------------------\"</span>\n<span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"w\"> </span><span class=\"cp\">$EXIT_CODE</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">eq</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">];</span><span class=\"w\"> </span><span class=\"n\">then</span>\n<span class=\"w\">    </span><span class=\"n\">echo</span><span class=\"w\"> </span><span class=\"s\">\"Compilation successful: $OUTPUT_CWASM generated.\"</span>\n<span class=\"k\">else</span>\n<span class=\"w\">    </span><span class=\"n\">echo</span><span class=\"w\"> </span><span class=\"s\">\"Error: Compilation failed with exit code $EXIT_CODE.\"</span>\n<span class=\"n\">fi</span>\n</code></pre></div>\n<p><a href=\"https://github.com/user-attachments/assets/4a1f4326-4dc0-4952-a9a8-6cc2d4f5667b\">https://github.com/user-attachments/assets/4a1f4326-4dc0-4952-a9a8-6cc2d4f5667b</a></p>\n<ul>\n<li>That's roughly the process. Honestly, it's not easy to observe this memory usage through the command line. However, it might take some time for me to refine the C++ sample, after which I can directly call the Wasmtime API to troubleshoot this issue. The specific location is here.</li>\n</ul>\n<p><a href=\"https://github.com/crowforkotlin/wasmline/blob/715f19fbd72f556da6e4a38ff6bb14e0ccda3b14/wasmline-core/src/Module.cpp#L58\">https://github.com/crowforkotlin/wasmline/blob/715f19fbd72f556da6e4a38ff6bb14e0ccda3b14/wasmline-core/src/Module.cpp#L58</a></p>\n<div class=\"codehilite\" data-code-language=\"C++\"><pre><span></span><code><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">isJit</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">LOGI</span><span class=\"p\">(</span><span class=\"s\">\"[Wasmtime] Module --&gt; Jit Compiling for %s...\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">filePath</span><span class=\"p\">.</span><span class=\"n\">c_str</span><span class=\"p\">());</span>\n<span class=\"w\">    </span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">wasmtime_module_new</span><span class=\"p\">(</span><span class=\"n\">engine</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"p\">.</span><span class=\"n\">data</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"p\">.</span><span class=\"n\">size</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"k\">module</span><span class=\"p\">);</span>\n<span class=\"p\">}</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">LOGI</span><span class=\"p\">(</span><span class=\"s\">\"[Wasmtime] Module --&gt; Aot Deserializing for %s...\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">filePath</span><span class=\"p\">.</span><span class=\"n\">c_str</span><span class=\"p\">());</span>\n<span class=\"w\">    </span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">wasmtime_module_deserialize</span><span class=\"p\">(</span><span class=\"n\">engine</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"p\">.</span><span class=\"n\">data</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"p\">.</span><span class=\"n\">size</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"k\">module</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p><a href=\"https://github.com/user-attachments/files/24524681/wasmtime.zip\">wasmtime.zip</a></p>\n</blockquote>",
        "id": 567107825,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767953437
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229#issuecomment-3756228688\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229\">issue #12229</a>:</p>\n<blockquote>\n<p>We discussed this issue in the Wasmtime meeting today; our conclusion was that we do want to aspire to compile any possible Wasm function within the implementation limits without returning a \"too large\" error. Concretely that means making a change to regalloc2 to allow for more VRegs, and in the future may also mean other sorts of adaptivity in our frontend Wasm-to-IR translator to generate less verbose IR for large functions. I'll tackle the regalloc2 bit soon.</p>\n</blockquote>",
        "id": 568282724,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768500831
    },
    {
        "content": "<p>crowforkotlin <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229#issuecomment-3757680222\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229\">issue #12229</a>:</p>\n<blockquote>\n<p>That sounds like great news, thanks for the update!</p>\n<p>Regarding my framework, I have currently deprecated the JIT approach in favor of Pulley. I have successfully managed to load and run Wasm files using the Pulley interpreter across iOS, Android, and Desktop.</p>\n<p>However, Ive encountered a critical issue: if the Wasm file is not pre-compiled (AOT) and is instead passed directly to Cranelift for IR analysis and optimization, the memory usage spikes significantly. While the behavior differs slightly from the JIT modewhere memory hits a peak almost instantaneouslyPulley exhibits a continuous and massive memory surge during the Cranelift processing phase. I will provide a more detailed feedback report specifically regarding this Pulley behavior shortly.</p>\n<p>Consequently, my current solution is to abandon both the JIT scheme and the Pulley \"JIT-style\" pre-compile stage. I am shifting entirely to a full AOT workflow using Cranelift AOT and Pulley AOT.</p>\n</blockquote>",
        "id": 568341388,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768527298
    },
    {
        "content": "<p>crowforkotlin edited a <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229#issuecomment-3757680222\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229\">issue #12229</a>:</p>\n<blockquote>\n<p>That sounds like great news, thanks for the update!</p>\n<p>Regarding my framework, I have currently deprecated the JIT approach in favor of Pulley. I have successfully managed to load and run Wasm files using the Pulley interpreter across iOS, Android, and Desktop.</p>\n<p>However, Ive encountered a critical issue: if the Wasm file is not pre-compiled (AOT) and is instead passed directly to Cranelift for IR analysis and optimization, the memory usage spikes significantly. While the behavior differs slightly from the JIT modewhere memory hits a peak almost instantaneouslyPulley exhibits a continuous and massive memory surge during the Cranelift processing phase.</p>\n<p>Furthermore, Ive noticed a substantial memory gap between the AOT solutions of Pulley and Cranelift. Specifically, when executing a pre-compiled .cwasm file, Pulleys memory footprint reaches nearly 150MB, which is unexpectedly high compared to Cranelift. I will provide a more detailed feedback report and performance data regarding these Pulley-related issues shortly.</p>\n<p>Consequently, my current strategy is to abandon both the JIT scheme and the Pulley \"JIT-style\" pre-compile stage, shifting entirely to a full AOT workflow using Cranelift AOT and Pulley AOT.</p>\n</blockquote>",
        "id": 568341923,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768527737
    },
    {
        "content": "<p>crowforkotlin edited a <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229#issuecomment-3757680222\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229\">issue #12229</a>:</p>\n<blockquote>\n<p>That sounds like great news, thanks for the update!</p>\n<p>I also have an update from the upstream: The Kotlin team has addressed the \"Code for function is too large\" issue in their latest Beta release, optimizing the IR generation to avoid such massive function bodies. This should significantly reduce the pressure on the compiler.</p>\n<p>Regarding my framework, I have currently deprecated the JIT approach in favor of Pulley. I have successfully managed to load and run Wasm files using the Pulley interpreter across iOS, Android, and Desktop.</p>\n<p>However, Ive encountered a critical issue: if the Wasm file is not pre-compiled (AOT) and is instead passed directly to Cranelift for IR analysis and optimization, the memory usage spikes significantly. While the behavior differs slightly from the JIT modewhere memory hits a peak almost instantaneouslyPulley exhibits a continuous and massive memory surge during the Cranelift processing phase.</p>\n<p>Furthermore, Ive noticed a substantial memory gap between the AOT solutions of Pulley and Cranelift. Specifically, when executing a pre-compiled .cwasm file, Pulleys memory footprint reaches nearly 150MB, which is unexpectedly high compared to Cranelift. I will provide a more detailed feedback report and performance data regarding these Pulley-related issues shortly.</p>\n<p>Consequently, my current strategy is to abandon both the JIT scheme and the Pulley \"JIT-style\" pre-compile stage, shifting entirely to a full AOT workflow using Cranelift AOT and Pulley AOT.</p>\n</blockquote>",
        "id": 568343237,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768528013
    },
    {
        "content": "<p>jkbz64 <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229#issuecomment-3902264182\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229\">issue #12229</a>:</p>\n<blockquote>\n<p>I've just bumped into the same issue with my <a href=\"https://github.com/usagi-coffee/tree-sitter-abl\">tree-sitter-abl</a> parser, the generated .wasm file is 64MB and what's interesting is that it only happens when using <code>-Os</code>, compiling using <code>-O0</code> compiles fine in <code>wasmtime</code> so it seems -Os explodes the code function size. I'd love to get this fixed upstream as <code>tree-sitter</code> uses -Os by default even though the size difference between <code>-Os</code> and <code>-O0</code> is miniscule.</p>\n</blockquote>",
        "id": 573915699,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1771091774
    },
    {
        "content": "<p>jkbz64 edited a <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229#issuecomment-3902264182\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229\">issue #12229</a>:</p>\n<blockquote>\n<p>I've just bumped into the same issue with my <a href=\"https://github.com/usagi-coffee/tree-sitter-abl\">tree-sitter-abl</a> parser, the generated .wasm file is 64MB and what's interesting is that it only happens when using <code>-Os</code>, compiling using <code>-O0</code> compiles fine in <code>wasmtime</code> so it seems <code>-Os</code> explodes the code function size. I'd love to get this fixed upstream as <code>tree-sitter</code> uses -Os by default even though the size difference between <code>-Os</code> and <code>-O0</code> is miniscule.</p>\n</blockquote>",
        "id": 573915709,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1771091791
    },
    {
        "content": "<p>jkbz64 edited a <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229#issuecomment-3902264182\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229\">issue #12229</a>:</p>\n<blockquote>\n<p>I've just bumped into the same issue with my <a href=\"https://github.com/usagi-coffee/tree-sitter-abl\">tree-sitter-abl</a> parser, the generated .wasm file is 64MB and what's interesting is that it only happens when using <code>-Os</code>, compiling using <code>-O0</code> compiles fine in <code>wasmtime</code> so it seems <code>-Os</code> explodes the code function size. I'd love to get this fixed upstream as <code>tree-sitter</code> uses <code>-Os</code> by default even though the size difference between <code>-Os</code> and <code>-O0</code> is miniscule.</p>\n</blockquote>",
        "id": 573915721,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1771091803
    },
    {
        "content": "<p>jkbz64 edited a <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229#issuecomment-3902264182\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229\">issue #12229</a>:</p>\n<blockquote>\n<p>I've just bumped into the same issue with my <a href=\"https://github.com/usagi-coffee/tree-sitter-abl\">tree-sitter-abl</a> parser, the generated .wasm file is 64MB and what's interesting is that it only happens when using <code>-Os</code>, compiling using <code>-O0</code> compiles fine in <code>wasmtime</code> so it seems <code>-Os</code> explodes the code function size. I'd love to get this fixed upstream as <code>tree-sitter build -w</code> uses <code>-Os</code> by default even though the size difference between <code>-Os</code> and <code>-O0</code> is miniscule.</p>\n</blockquote>",
        "id": 573915761,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1771091836
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229#issuecomment-3902883526\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229\">issue #12229</a>:</p>\n<blockquote>\n<p>I had some time today so I put together the changes to allow for more virtual registers in the regalloc (the underlying cause) -- <a href=\"https://github.com/bytecodealliance/regalloc2/issues/255\">bytecodealliance/regalloc2#255</a>, <a href=\"https://github.com/bytecodealliance/regalloc2/issues/256\">bytecodealliance/regalloc2#256</a>, <a href=\"https://github.com/bytecodealliance/regalloc2/issues/257\">bytecodealliance/regalloc2#257</a>, <a href=\"https://github.com/bytecodealliance/regalloc2/issues/258\">bytecodealliance/regalloc2#258</a>, #12596, and one final upcoming PR here after <a href=\"https://github.com/bytecodealliance/regalloc2/issues/258\">bytecodealliance/regalloc2#258</a> merges and I publish the RA2 release.</p>\n</blockquote>",
        "id": 573936786,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1771115850
    },
    {
        "content": "<p>cfallin closed <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12229\">issue #12229</a>:</p>\n<blockquote>\n<h1>\"Code for function is too large\" error and 1.6GB Memory Spike during JIT compilation of a 781KB Kotlin/Wasm module</h1>\n<p><strong>Environment:</strong></p>\n<ul>\n<li><strong>Wasmtime version:</strong> v40.0.0 (Release #12192)</li>\n<li><strong>Host Machine (Build):</strong> Mac M2 (aarch64)</li>\n<li><strong>Target Device (Runtime):</strong> Android (aarch64)</li>\n<li><strong>Compiler:</strong> Kotlin/Wasm (WASI) via <code>compileProductionExecutableKotlinWasmWasiOptimize</code></li>\n<li><strong>Project Link:</strong> <a href=\"https://github.com/crowforkotlin/wasmline\">crowforkotlin/wasmline</a></li>\n<li><strong>Source File:</strong> <a href=\"https://github.com/crowforkotlin/wasmline/blob/main/wasmline-multiplatform/wasmline-core/plugin/src/wasmWasiMain/kotlin/crow/wasmtime/wasmline/Plugin.kt\">Plugin.kt</a></li>\n</ul>\n<p><strong>Description:</strong><br>\nI am reporting a <code>Compilation error: Code for function is too large</code> that occurs during the JIT loading phase on Android. </p>\n<p>Despite the generated <code>.wasm</code> binary being only <strong>781.63 KB</strong>, the compilation fails when a single Kotlin function contains a large amount of logic/content. During the attempt to compile this module, I observed a massive RSS memory spike on the Android device, jumping from <strong>~235 MB to over 1.6 GB</strong> in just 4 seconds, eventually resulting in the \"function too large\" error.</p>\n<p><strong>Wasmtime Configuration:</strong><br>\nThe engine is configured specifically for Android compatibility to avoid signal conflicts with ART and minimize VSS overhead:</p>\n<div class=\"codehilite\" data-code-language=\"C++\"><pre><span></span><code><span class=\"cm\">/**</span>\n<span class=\"cm\"> * Creates and configures the Wasm Config object.</span>\n<span class=\"cm\"> *</span>\n<span class=\"cm\"> * Critical Android Settings:</span>\n<span class=\"cm\"> * 1. Signals-based traps DISABLED: To prevent conflicts with Android ART signal handlers (SIGSEGV).</span>\n<span class=\"cm\"> * 2. Memory Guard Size = 0: To prevent VSS (Virtual Set Size) OOM on 32-bit or limited devices.</span>\n<span class=\"cm\"> * 3. GC / Exceptions: Enabled for Kotlin/Wasm support.</span>\n<span class=\"cm\"> */</span>\n<span class=\"n\">wasm_config_t</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"nf\">Engine::createConfig</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">wasm_config_t</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">conf</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">wasm_config_new</span><span class=\"p\">();</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// Feature Flags for Kotlin/Wasm support</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_config_wasm_gc_set</span><span class=\"p\">(</span><span class=\"n\">conf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">true</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_config_wasm_function_references_set</span><span class=\"p\">(</span><span class=\"n\">conf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">true</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_config_wasm_exceptions_set</span><span class=\"p\">(</span><span class=\"n\">conf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">true</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// Optimization: Disable SIMD if not strictly needed (improves compatibility)</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_config_wasm_simd_set</span><span class=\"p\">(</span><span class=\"n\">conf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">false</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_config_wasm_relaxed_simd_set</span><span class=\"p\">(</span><span class=\"n\">conf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">false</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// [CRITICAL] Disable signal handlers to avoid crash conflicts with Android Runtime (ART)</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_config_signals_based_traps_set</span><span class=\"p\">(</span><span class=\"n\">conf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">false</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// [CRITICAL] Set guard pages to 0 to minimize Virtual Memory usage (prevents OOM)</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_config_memory_guard_size_set</span><span class=\"p\">(</span><span class=\"n\">conf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// Set max stack size (512KB is usually sufficient for mobile logic)</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_config_max_wasm_stack_set</span><span class=\"p\">(</span><span class=\"n\">conf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">512</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"w\"> </span><span class=\"mi\">1024</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// Compiler Optimization Strategy: Optimize for Speed and Binary Size</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_config_cranelift_opt_level_set</span><span class=\"p\">(</span><span class=\"n\">conf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">WASMTIME_OPT_LEVEL_SPEED_AND_SIZE</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_config_cranelift_debug_verifier_set</span><span class=\"p\">(</span><span class=\"n\">conf</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">false</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">conf</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p><strong>Reproduction Steps:</strong></p>\n<ol>\n<li>Add a large amount of content/logic into the <code>wasmWasiMain</code> function in <code>Plugin.kt</code>.</li>\n<li>Build the wasm file: <code>./gradlew wasmtime-core:plugin:compileProductionExecutableKotlinWasmWasiOptimize</code>.</li>\n<li>The resulting <code>plugin.wasm</code> is ~781 KB.</li>\n<li>Load the module on an Android device using the configuration above.</li>\n</ol>\n<p><strong>Observed Behavior:</strong></p>\n<ul>\n<li><strong>Total Wasm Size:</strong> 781.63 KB (Small)</li>\n<li><strong>Memory Usage:</strong> Spikes from 234MB to 1.6GB.</li>\n<li><strong>Result:</strong> <code>Compilation error: Code for function is too large</code>.</li>\n</ul>\n<p><strong>Full Android Logs:</strong></p>\n<div class=\"codehilite\" data-code-language=\"Text only\"><pre><span></span><code>00:49:34.204  I  [MotionEvent] ViewRootImpl windowName 'crow.wasmtime.wasmline/crow.mordecai.wasmline.MainActivity', { action=ACTION_DOWN, id[0]=0, pointerCount=1, eventTime=51746485, downTime=51746485, phoneEventTime=00:49:34.191 } moveCount:0\n00:49:34.206  D  getMiuiFreeformStackInfo mTmpFrames.miuiFreeFormStackInfo: null\n00:49:34.217  I  CreateGraphicsPipeline pipeline cache hit. elpased time: 0.32 ms.\n00:49:34.218  E  FrameInsert open fail: No such file or directory\n00:49:34.230  I  This is non sticky GC, maxfree is 33554432 minfree is 8388608\n00:49:34.227  W  type=1400 audit(0.0:2008818): avc:  denied  { getopt } for  path=\"/dev/socket/usap_pool_primary\" scontext=u:r:untrusted_app:s0:c190,c257,c512,c768 tcontext=u:r:zygote:s0 tclass=unix_stream_socket permissive=0 app=crow.wasmtime.wasmline\n00:49:34.322  I  [MotionEvent] ViewRootImpl windowName 'crow.wasmtime.wasmline/crow.mordecai.wasmline.MainActivity', { action=ACTION_UP, id[0]=0, pointerCount=1, eventTime=51746611, downTime=51746485, phoneEventTime=00:49:34.316 } moveCount:0\n00:49:34.332  I  ==============================================\n00:49:34.337  I  [Android] Wasm file : plugin.wasm    ||    wasm file exits : true    ||    wasm file path :  /data/user/0/crow.wasmtime.wasmline/cache/plugin.wasm\n00:49:34.338  I  [Android] Cwasm cache file : plugin.cwasm    ||    cache file exits : false    ||    cache file path :  /data/user/0/crow.wasmtime.wasmline/cache/plugin.cwasm\n00:49:34.345  I  [Wasmtime] Module --&gt; Jit Compiling for /data/user/0/crow.wasmtime.wasmline/cache/plugin.wasm...\n00:49:34.363  W  type=1400 audit(0.0:2008819): avc:  denied  { read } for  name=\"cpu.cfs_quota_us\" dev=\"cgroup\" ino=64 scontext=u:r:untrusted_app:s0:c190,c257,c512,c768 tcontext=u:object_r:cgroup:s0 tclass=file permissive=0 app=crow.wasmtime.wasmline\n00:49:34.363  W  type=1400 audit(0.0:2008820): avc:  denied  { read } for  name=\"cpu.cfs_period_us\" dev=\"cgroup\" ino=65 scontext=u:r:untrusted_app:s0:c190,c257,c512,c768 tcontext=u:object_r:cgroup:s0 tclass=file permissive=0 app=crow.wasmtime.wasmline\n00:49:34.363  W  type=1400 audit(0.0:2008821): avc:  denied  { read } for  name=\"cpu.cfs_quota_us\" dev=\"cgroup\" ino=10 scontext=u:r:untrusted_app:s0:c190,c257,c512,c768 tcontext=u:object_r:cgroup:s0 tclass=file permissive=0 app=crow.wasmtime.wasmline\n00:49:34.363  W  type=1400 audit(0.0:2008822): avc:  denied  { read } for  name=\"cpu.cfs_period_us\" dev=\"cgroup\" ino=11 scontext=u:r:untrusted_app:s0:c190,c257,c512,c768 tcontext=u:object_r:cgroup:s0 tclass=file permissive=0 app=crow.wasmtime.wasmline\n00:49:34.441  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 234952kb -&gt; 342100kb\n00:49:34.494  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 342100kb -&gt; 428844kb\n00:49:34.544  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 428844kb -&gt; 541612kb\n00:49:34.602  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 541612kb -&gt; 657240kb\n00:49:34.928  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 657240kb -&gt; 860432kb\n00:49:35.761  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 860432kb -&gt; 959324kb\n00:49:36.012  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 959324kb -&gt; 1075892kb\n00:49:36.184  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 1075892kb -&gt; 1183820kb\n00:49:37.835  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 1183820kb -&gt; 1306888kb\n00:49:38.482  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 1306888kb -&gt; 1450064kb\n00:49:38.639  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 1450064kb -&gt; 1612484kb\n00:49:38.700  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 1612484kb -&gt; 1389664kb\n00:49:38.700  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 1389664kb -&gt; 1011816kb\n00:49:38.702  E  [Wasmtime] Module --&gt; Error loading module /data/user/0/crow.wasmtime.wasmline/cache/plugin.wasm: Compilation error: Code for function is too large\n00:49:38.708  I  [Wasmline] Load failure, because native load return false, file path is :  /data/user/0/crow.wasmtime.wasmline/cache/plugin.wasm\n00:49:38.790  E  -&gt;pid:19641,processName:\"crow.wasmtime.wasmline\",Rss Memory Size Change 1011816kb -&gt; 727648kb\n</code></pre></div>\n<p><strong>Artifacts:</strong><br>\n<a href=\"https://github.com/user-attachments/files/24371302/Wasmline-wasmline-core-plugin.wasm.zip\">Wasmline-wasmline-core-plugin.wasm.zip</a></p>\n<ul>\n<li>\n<p><strong>Wasm File Size (781.63 KB):</strong><br>\n    ![Image](<a href=\"https://github.com/user-attachments/assets/eb138f47-365b-4acb-bf95-231109ef1595\">https://github.com/user-attachments/assets/eb138f47-365b-4acb-bf95-231109ef1595</a>)</p>\n</li>\n<li>\n<p><strong>Error Detail:</strong><br>\n    ![Image](<a href=\"https://github.com/user-attachments/assets/c7c95257-15e5-48ec-8dfd-48474d289ddd\">https://github.com/user-attachments/assets/c7c95257-15e5-48ec-8dfd-48474d289ddd</a>)</p>\n</li>\n<li>\n<p><strong>Success state (after reducing content):</strong><br>\n    ![Image](<a href=\"https://github.com/user-attachments/assets/7dac5f71-1e53-4475-87ff-3b4e553cee25\">https://github.com/user-attachments/assets/7dac5f71-1e53-4475-87ff-3b4e553cee25</a>)</p>\n</li>\n</ul>\n<p><strong>Analysis &amp; Questions:</strong></p>\n<ol>\n<li>Why does a relatively small Wasm file (under 1MB) trigger a \"Code too large\" error? It seems the Kotlin/Wasm compiler is generating a single function with extremely high complexity.</li>\n<li>The memory usage spike to 1.6GB suggests that Cranelift might be hitting a worst-case scenario in its e-graph optimization or register allocation phase.</li>\n<li>Are there any specific Cranelift settings to mitigate this, or is this a fundamental limit on function complexity regardless of the total <code>.wasm</code> file size?</li>\n</ol>\n</blockquote>",
        "id": 574412454,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1771376671
    }
]
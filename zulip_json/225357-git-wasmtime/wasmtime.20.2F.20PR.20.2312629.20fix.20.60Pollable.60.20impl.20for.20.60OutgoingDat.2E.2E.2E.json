[
    {
        "content": "<p>dicej requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-wasi-reviewers\">wasmtime-wasi-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12629\">PR #12629</a>.</p>",
        "id": 575014492,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1771615604
    },
    {
        "content": "<p>dicej opened <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12629\">PR #12629</a> from <code>dicej:outgoing-datagram-stream-pollable-fix</code> to <code>bytecodealliance:main</code>:</p>\n<blockquote>\n<p>Previously, <code>OutgoingDatagramStream</code> used its <code>send_state</code> field to determine whether the socket was ready for writing without necessarily polling the <code>tokio::net::UdpSocket</code>.  The underlying assumption was that a freshly-bound socket would be immediately ready for writing, but that's not true for <code>tokio</code>. <code>tokio</code> assumes a socket is not ready for _anything_ by default and relies on e.g. <code>epoll</code> to tell it otherwise.</p>\n<p>In practice, this meant the <code>Pollable::ready</code> impl for <code>OutgoingDatagramStream</code> would resolve immediately for a fresh socket, leaving the guest to race with <code>tokio</code>'s use of <code>epoll</code>.  Usually, <code>tokio</code> won and all was well, but occasionally it lost and the <code>OutgoingDatagramStream::send</code> call would return <code>Ok(0)</code> (meaning \"would block\") leaving the guest confused since it was just told that the socket was ready for writing.</p>\n<p>This commit removes <code>SendState</code> entirely, relying exclusively on <code>tokio::net::UdpSocket::ready</code> for the <code>Pollable</code> and <code>check_send</code> implementations.  As a side effect, we no longer attempt to prevent the guest from sending more datagrams than <code>check_send</code> indicated since the number returned by <code>check_send</code> is only a guess anyway, and <code>tokio</code> will push back if it needs to.  For <code>p3</code>, the whole <code>check_send</code>/<code>send</code> pattern is gone, so we won't need to concern ourselves with it going forward.</p>\n<p>Fixes #12612</p>\n<p>&lt;!--<br>\nPlease make sure you include the following information:</p>\n<ul>\n<li>\n<p>If this work has been discussed elsewhere, please include a link to that<br>\n  conversation. If it was discussed in an issue, just mention \"issue #...\".</p>\n</li>\n<li>\n<p>Explain why this change is needed. If the details are in an issue already,<br>\n  this can be brief.</p>\n</li>\n</ul>\n<p>Our development process is documented in the Wasmtime book:<br>\n<a href=\"https://docs.wasmtime.dev/contributing-development-process.html\">https://docs.wasmtime.dev/contributing-development-process.html</a></p>\n<p>Please ensure all communication follows the code of conduct:<br>\n<a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md\">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>\n--&gt;</p>\n</blockquote>",
        "id": 575014493,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1771615604
    },
    {
        "content": "<p>dicej requested <a href=\"https://github.com/cfallin\">cfallin</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12629\">PR #12629</a>.</p>",
        "id": 575014495,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1771615604
    },
    {
        "content": "<p>dicej requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers\">wasmtime-core-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12629\">PR #12629</a>.</p>",
        "id": 575014496,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1771615604
    },
    {
        "content": "<p>dicej requested <a href=\"https://github.com/alexcrichton\">alexcrichton</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12629\">PR #12629</a>.</p>",
        "id": 575014525,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1771615619
    },
    {
        "content": "<p>dicej unassigned cfallin from <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12629\">PR #12629 fix <code>Pollable</code> impl for <code>OutgoingDatagramStream</code></a>.</p>",
        "id": 575014577,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1771615634
    },
    {
        "content": "<p>dicej <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12629#issuecomment-3936690129\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12629\">PR #12629</a>:</p>\n<blockquote>\n<p>cc @badeend in case you're interested</p>\n</blockquote>",
        "id": 575014668,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1771615668
    },
    {
        "content": "<p>alexcrichton submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12629#pullrequestreview-3833866243\">PR review</a>.</p>",
        "id": 575015060,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1771615829
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12629#discussion_r2834781343\">PR review comment</a>:</p>\n<blockquote>\n<p>Could this additionally <code>debug_assert!</code> that <code>count == 0</code>?</p>\n</blockquote>",
        "id": 575015061,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1771615829
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12629#issuecomment-3936705261\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12629\">PR #12629</a>:</p>\n<blockquote>\n<p>Also, if you're up for it, I think it'd be good to test this on p3 too (semantically at least)</p>\n</blockquote>",
        "id": 575015105,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1771615853
    },
    {
        "content": "<p>dicej updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12629\">PR #12629</a>.</p>",
        "id": 575021493,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1771618595
    },
    {
        "content": "<p>dicej has enabled auto merge for <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12629\">PR #12629</a>.</p>",
        "id": 575021540,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1771618618
    },
    {
        "content": "<p>dicej added <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12629\">PR #12629 fix <code>Pollable</code> impl for <code>OutgoingDatagramStream</code></a> to the merge queue</p>",
        "id": 575023391,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1771619403
    },
    {
        "content": "<p>dicej merged <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12629\">PR #12629</a>.</p>",
        "id": 575026488,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1771620830
    },
    {
        "content": "<p>dicej removed <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12629\">PR #12629 fix <code>Pollable</code> impl for <code>OutgoingDatagramStream</code></a> from the merge queue</p>",
        "id": 575026489,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1771620830
    },
    {
        "content": "<p>badeend <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12629#issuecomment-3938401148\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12629\">PR #12629</a>:</p>\n<blockquote>\n<blockquote>\n<p>As a side effect, we no longer attempt to prevent the guest from sending more datagrams than check_send indicated since the number returned by check_send is only a guess anyway</p>\n</blockquote>\n<p>@dicej This violates the <a href=\"https://github.com/WebAssembly/WASI/blob/41d0de898ec7568e032129156a3bc567d7ebea5d/proposals/sockets/wit/udp.wit#L256C1-L257C111\">P2 spec</a>:</p>\n<blockquote>\n<p>Each call to <code>send</code> must be permitted by a preceding <code>check-send</code>. Implementations must trap if either <code>check-send</code> was not called or <code>datagrams</code> contains more items than <code>check-send</code> permitted.</p>\n</blockquote>\n<p>Can the check be reintroduced?</p>\n</blockquote>",
        "id": 575068978,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1771660142
    },
    {
        "content": "<p>dicej <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12629#issuecomment-3939183415\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12629\">PR #12629</a>:</p>\n<blockquote>\n<blockquote>\n<p>@dicej This violates the <a href=\"https://github.com/WebAssembly/WASI/blob/41d0de898ec7568e032129156a3bc567d7ebea5d/proposals/sockets/wit/udp.wit#L256C1-L257C111\">P2 spec</a>:</p>\n<blockquote>\n<p>Each call to <code>send</code> must be permitted by a preceding <code>check-send</code>. Implementations must trap if either <code>check-send</code> was not called or <code>datagrams</code> contains more items than <code>check-send</code> permitted.</p>\n</blockquote>\n<p>Can the check be reintroduced?</p>\n</blockquote>\n<p><span aria-label=\"face palm\" class=\"emoji emoji-1f926\" role=\"img\" title=\"face palm\">:face_palm:</span> Yes, I'll do that on Monday.  Thanks for catching that.</p>\n</blockquote>",
        "id": 575104150,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1771697209
    }
]
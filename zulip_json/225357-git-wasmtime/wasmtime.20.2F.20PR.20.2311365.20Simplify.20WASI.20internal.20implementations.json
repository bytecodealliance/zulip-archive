[
    {
        "content": "<p>alexcrichton opened <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11365\">PR #11365</a> from <code>alexcrichton:wasi-refactor</code> to <code>bytecodealliance:main</code>:</p>\n<blockquote>\n<p>This commit migrates the WASIp2 implementation to be closer to the upcoming WASIp3 implementation in terms of how things are implemented internally. Previously the way things worked with WASIp2 is:</p>\n<ul>\n<li>Embedders call <code>add_to_linker</code> with <code>T: WasiView</code></li>\n<li>Internally <code>add_to_linker</code> is called which creates <code>WasiImpl&lt;&amp;mut T&gt;</code></li>\n<li>All internal implementations were <code>impl&lt;T&gt; Host for WasiImpl&lt;T&gt; where T: WasiView</code></li>\n<li>A forwarding impl of <code>impl&lt;T: WasiView&gt; WasiView for &amp;mut T</code> was required</li>\n</ul>\n<p>While this all worked it's a bit complicated for a few reasons:</p>\n<ol>\n<li>Dealing with generically named structures like <code>WasiImpl</code> (or <code>IoImpl</code> or <code>WasiHttpImpl</code>) is a bit baroque and not always obvious as to what's going on.</li>\n<li>The extra layer of generics in <code>impl&lt;T&gt; Host for WasiImpl&lt;T&gt;</code> adds a layer of conceptual indirection which is non-obvious.</li>\n<li>Other WASI proposal implementations do not use this strategy and instead use \"view\" types or <code>impl Host for TheType</code> for example.</li>\n<li>Internal incantations of <code>add_to_linker</code> had to deal with mixtures of <code>IoImpl</code> and <code>WasiImpl</code> and aligning everything just right.</li>\n<li>An extra layer of generics on all impls meant that everything was generic meaning that <code>wasmtime-wasi</code>-the-crate didn't generate much code, causing longer codegen times for consumers.</li>\n</ol>\n<p>The goal of this commit is to migrate towards the style of what WASIp3 is prototyping for how impls are modeled. This is done to increase the amount of code that can be shared between WASIp2 and WASIp3. This has a number of benefits such as being easier to understand and also being more modular where <code>wasi:clocks</code> implementations of traits don't require filesystem context to be present (as is the case today). This in theory helps a more mix-and-match paradigm of blending together various bits and pieces of <code>wasmtime-wasi</code> implementations.</p>\n<p>Concretely the changes made here are:</p>\n<ul>\n<li><code>WasiView</code> no longer inherits from <code>IoView</code>, they're unrelated traits now.</li>\n<li><code>WasiView</code> now returns <code>WasiViewCtx&lt;'a&gt;</code> which has <code>ctx: &amp;'a mut WasiCtx</code> and <code>table: &amp;'a mut ResourceTable</code>. That means it basically does the same thing before but in a slightly different fashion.</li>\n<li>Implementations of <code>Host</code> traits are now directly for <code>WasiCtxView&lt;'_&gt;</code> and don't involve any generics at all. These are hopefully easier to understand and also better from a codegen/compile-time perspective.</li>\n<li>Embedders no longer need to implement <code>IoView</code> directly and instead fold that functionality into <code>WasiView</code>.</li>\n<li><code>WasiHttpView</code> no longer inherits from <code>IoView</code> and instead has a direct <code>fn table</code> method. Additionally <code>WasiHttpImpl</code> no longer embeds <code>IoImpl</code> inside of it.</li>\n<li>Host traits for <code>wasi:io</code> are now implemented directly for <code>ResourceTable</code> instead of <code>IoImpl&lt;T&gt;</code>.</li>\n</ul>\n<p>The immediate goal of this refactoring is to enable more sharing along the lines of #11362. This was not possible prior because WASIp3 requires a simultaneous borrow on the table/ctx while the trait hierarchy previously gave you one-or-the-other. With this new organization it will be possible to get both at the same time meaning more structure/contexts/etc can be shared between implementations.</p>\n<p>prtest:full</p>\n<p>&lt;!--<br>\nPlease make sure you include the following information:</p>\n<ul>\n<li>\n<p>If this work has been discussed elsewhere, please include a link to that<br>\n  conversation. If it was discussed in an issue, just mention \"issue #...\".</p>\n</li>\n<li>\n<p>Explain why this change is needed. If the details are in an issue already,<br>\n  this can be brief.</p>\n</li>\n</ul>\n<p>Our development process is documented in the Wasmtime book:<br>\n<a href=\"https://docs.wasmtime.dev/contributing-development-process.html\">https://docs.wasmtime.dev/contributing-development-process.html</a></p>\n<p>Please ensure all communication follows the code of conduct:<br>\n<a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md\">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>\n--&gt;</p>\n</blockquote>",
        "id": 532161620,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753993445
    },
    {
        "content": "<p><strong>alexcrichton</strong> requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-wasi-reviewers\">wasmtime-wasi-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11365\">PR #11365</a>.</p>",
        "id": 532161621,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753993445
    },
    {
        "content": "<p><strong>alexcrichton</strong> requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers\">wasmtime-core-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11365\">PR #11365</a>.</p>",
        "id": 532161623,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753993446
    },
    {
        "content": "<p><strong>alexcrichton</strong> requested <a href=\"https://github.com/fitzgen\">fitzgen</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11365\">PR #11365</a>.</p>",
        "id": 532161625,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753993447
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11365#issuecomment-3141242763\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11365\">PR #11365</a>:</p>\n<blockquote>\n<p>I can sort of preemptively apologize to embedders about this. I feel like every few versions of Wasmtime we rejigger how WASI traits work and how the impls are set up. I feel like we continue to march towards something that fits for all use cases and feels right but this is inevitably an iterative progress where we can't leapfrog to the end.</p>\n<p>If anyone runs across this and has difficulty updating I'm happy to help out in updates, feel free to ping me on Zulip or here or an issue.</p>\n</blockquote>",
        "id": 532161859,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753993535
    },
    {
        "content": "<p>pchickey submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11365#pullrequestreview-3076926255\">PR review</a>.</p>",
        "id": 532170635,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753997260
    },
    {
        "content": "<p>pchickey <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11365#issuecomment-3141387626\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11365\">PR #11365</a>:</p>\n<blockquote>\n<p>There are still some more places to thread through this change (CI found wasi-keyvalue) but the design change looks good. Glad this is possible now that we got rid of get_host for HasData.</p>\n</blockquote>",
        "id": 532170878,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753997340
    },
    {
        "content": "<p>alexcrichton updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11365\">PR #11365</a>.</p>",
        "id": 532195760,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1754009162
    },
    {
        "content": "<p>alexcrichton updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11365\">PR #11365</a>.</p>",
        "id": 532196099,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1754009324
    },
    {
        "content": "<p>alexcrichton has enabled auto merge for <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11365\">PR #11365</a>.</p>",
        "id": 532196113,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1754009330
    },
    {
        "content": "<p>alexcrichton updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11365\">PR #11365</a>.</p>",
        "id": 532197382,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1754010015
    },
    {
        "content": "<p>alexcrichton merged <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11365\">PR #11365</a>.</p>",
        "id": 532202965,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1754012915
    }
]
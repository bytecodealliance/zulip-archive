[
    {
        "content": "<p><strong>alexcrichton</strong> requested <a href=\"https://github.com/fitzgen\">fitzgen</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11878\">PR #11878</a>.</p>",
        "id": 545458723,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1760657431
    },
    {
        "content": "<p><strong>alexcrichton</strong> requested <a href=\"https://github.com/dicej\">dicej</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11878\">PR #11878</a>.</p>",
        "id": 545458724,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1760657431
    },
    {
        "content": "<p>alexcrichton opened <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11878\">PR #11878</a> from <code>alexcrichton:wizer-component-init</code> to <code>bytecodealliance:main</code>:</p>\n<blockquote>\n<p>This commit is the next phase of merging the wizer and component-init repositories into Wasmtime. This does not take the same approach as merging wizer where the git histories were merged, but instead this takes an entirely different approach for component-init. Effectively I read the code in component-init and copied over the spirit of the code into the wasmtime-wizer crate. Very little was literally copied over due to such large changes in the internals of organization and implementation. The main goal of merging this repository is to replace the core wasm tracking of state in component-init with what wasmtime-wizer already has. Sort of like the runtime in the <code>wasmtime</code> crate the goal is to build component support entirely on top of core support to avoid duplicating anything.</p>\n<p>The general strategy for pre-init components is that unlike core wasm where more exports are added a component has a new module and new accessor functions injected for all state found in the component. For example an <code>i32</code> global results in a <code>(func (result s32))</code> in WIT. Memories result in <code>(func (result (list u8)))</code>. This \"accessor module\" is synthetically built during the instrumentation pass of Wizer and then used to acquire snapshot results afterwards.</p>\n<p>All of this support is added in a new <code>component</code> submodule of the <code>wasmtime-wizer</code> crate. This submodule has the same structure as its core wasm counterpart at the root of the crate, but the internal implementations are entirely different. Anything encountering a core wasm module delegates to the core wasm support in the root of the crate for Wizer.</p>\n<p>There is one new limitation at this time over what component-init supports which is that nested components are not supported just yet. Currently in component-init nested components are copied over as-is which ends up producing a faulty initialization if the components actually have core wasm instances associated with them. For now this implementation sidesteps this by forbidding nested components entirely. To support wizening the output of <code>wasm-tools component {new,link}</code>, however, some support for nested components will be required. I plan on adding that in a follow-up commit.</p>\n<p>Testing of component-init is pretty light right now so this commit copies over a few <code>*.wat</code> tests \"in spirit\" but does not literally copy over the preexisting tests. There are a few tests in component-init which initialize the real output of <code>wasm-tools component new</code> which may want to be migrated eventually but my hope is that this repo can stick to smaller more focused tests for now.</p>\n<p>One large-ish change made to <code>wasmtime-wizer</code> during this merge was to change snapshotting functionality to being an <code>async</code> function. This is required for components because reading state requires invoking a function, which in the context of the <code>wasmtime run</code> subcommand is always done in \"async mode\". This meant that the <code>async</code> propagates outwards to much of <code>wasmtime-wizer</code>, even the core wasm traits. My hope is that this isn't a big issue as the CLI can deal with it and embedders can throw an <code>async</code> in there.</p>\n<p>Overall this is intended to be a mostly-complete skeleton plus basic functionality for component-init. I have not done thorough testing with real-world components just yet (e.g. componentize-py) so there will likely be follow-up PRs to address various inevitable shortcomings I've introduced in this merge.</p>\n<p>&lt;!--<br>\nPlease make sure you include the following information:</p>\n<ul>\n<li>\n<p>If this work has been discussed elsewhere, please include a link to that<br>\n  conversation. If it was discussed in an issue, just mention \"issue #...\".</p>\n</li>\n<li>\n<p>Explain why this change is needed. If the details are in an issue already,<br>\n  this can be brief.</p>\n</li>\n</ul>\n<p>Our development process is documented in the Wasmtime book:<br>\n<a href=\"https://docs.wasmtime.dev/contributing-development-process.html\">https://docs.wasmtime.dev/contributing-development-process.html</a></p>\n<p>Please ensure all communication follows the code of conduct:<br>\n<a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md\">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>\n--&gt;</p>\n</blockquote>",
        "id": 545458726,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1760657432
    },
    {
        "content": "<p><strong>alexcrichton</strong> requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers\">wasmtime-core-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11878\">PR #11878</a>.</p>",
        "id": 545458727,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1760657432
    },
    {
        "content": "<p><strong>alexcrichton</strong> requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-default-reviewers\">wasmtime-default-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11878\">PR #11878</a>.</p>",
        "id": 545458728,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1760657432
    },
    {
        "content": "<p>alexcrichton updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11878\">PR #11878</a>.</p>",
        "id": 545460701,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1760658997
    },
    {
        "content": "<p>pchickey submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11878#pullrequestreview-3347533887\">PR review</a>.</p>",
        "id": 545462783,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1760660471
    },
    {
        "content": "<p>github-actions[bot] <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11878#issuecomment-3413611529\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11878\">PR #11878</a>:</p>\n<blockquote>\n<h4>Subscribe to Label Action</h4>\n<p>cc @fitzgen</p>\n<p>&lt;details&gt;<br>\nThis issue or pull request has been labeled: \"wizer\"</p>\n<p>Thus the following users have been cc'd because of the following labels:</p>\n<ul>\n<li>fitzgen: wizer</li>\n</ul>\n<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>\n<p><a href=\"https://github.com/bytecodealliance/subscribe-to-label-action\">Learn more.</a><br>\n&lt;/details&gt;</p>\n</blockquote>",
        "id": 545476560,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1760670201
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11878#issuecomment-3416083269\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11878\">PR #11878</a>:</p>\n<blockquote>\n<p>Oh, another thing not yet implemented -- the init function is not deleted from the component just yet.</p>\n</blockquote>",
        "id": 545598568,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1760715387
    },
    {
        "content": "<p>fitzgen submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11878#pullrequestreview-3351786718\">PR review</a>.</p>",
        "id": 545681991,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1760731797
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11878#discussion_r2441072939\">PR review comment</a>:</p>\n<blockquote>\n<p>Should the memory accessors be a little more fine-grained? Copying out the whole memory seems like maybe not the foundational primitive we want here. I could imagine a cursor thing to iterate over non-zero regions of memory, or even just returning a <code>list&lt;(u32, list&lt;u8&gt;)&gt;</code> to skip over zero regions.</p>\n</blockquote>",
        "id": 545681993,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1760731798
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11878#discussion_r2441104950\">PR review comment</a>:</p>\n<blockquote>\n<p>Can you additionally add a test for multiple instantiations of the same core module? I believe this is not currently supported, right? Because it would otherwise require pulling out memories and turning them into imports into the core module, to prevent duplicating code. So just asserting that it fails wizening with a helpful \"blah blah is unsupported\" message should be good.</p>\n</blockquote>",
        "id": 545681994,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1760731798
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11878#discussion_r2441099659\">PR review comment</a>:</p>\n<blockquote>\n<p>Can we continue to have a default value here, since it shows up in the help text, but just make it the same for components and core modules? It can't be <code>wizer.initialize</code> anymore because the <code>.</code> means it isn't a valid component export name. And <code>component-init</code> doesn't make sense for core modules. How about <code>wizer-init</code> or <code>wizer-initialize</code>?</p>\n</blockquote>",
        "id": 545681995,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1760731798
    },
    {
        "content": "<p>alexcrichton submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11878#pullrequestreview-3352045736\">PR review</a>.</p>",
        "id": 545692764,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1760734415
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11878#discussion_r2441225670\">PR review comment</a>:</p>\n<blockquote>\n<p>Right yeah that's not supported. There's a test <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11878/files#diff-c6cb9c57a03314d524cad9847bc248cecc22a548c0eea69239b1de4ac5fb4170R76\">here</a> for that, but to confirm you aren't thinking of anything more comprehensive than that?</p>\n</blockquote>",
        "id": 545692767,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1760734416
    },
    {
        "content": "<p>alexcrichton submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11878#pullrequestreview-3352060278\">PR review</a>.</p>",
        "id": 545693819,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1760734678
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11878#discussion_r2441234954\">PR review comment</a>:</p>\n<blockquote>\n<p>Technically this is how core wasm sort of works right now anyway where we use <code>memory.data(&amp;store).to_vec()</code> to get the contents of memory. Building up something like <code>list&lt;(u32, list&lt;u8&gt;)&gt;</code> would require to write the loop in-wasm and, while possible, would have to handle things like dynamically allocating the outer list and managing the size/length of that. Efficiency-wise we could improve on things here by using the <code>WasmList&lt;u8&gt;</code> type instead of <code>Vec&lt;u8&gt;</code> if this becomes a problem though and that'll enable the host to do the zero-searching without actually copying out the entire memory. There'd be some refactoring of the various internals of that, however.</p>\n<p>Want me to try and push on such a refactoring and see if it works?</p>\n</blockquote>",
        "id": 545693822,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1760734679
    },
    {
        "content": "<p>alexcrichton submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11878#pullrequestreview-3352061827\">PR review</a>.</p>",
        "id": 545693997,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1760734715
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11878#discussion_r2441235997\">PR review comment</a>:</p>\n<blockquote>\n<p>Would you be ok with the break of compatibility with wizer-from-before by defaulting to <code>wizer-initialize</code> for core wasm instead of <code>wizer.initialize</code>?</p>\n</blockquote>",
        "id": 545694000,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1760734715
    },
    {
        "content": "<p>fitzgen submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11878#pullrequestreview-3352090864\">PR review</a>.</p>",
        "id": 545695925,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1760735227
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11878#discussion_r2441254319\">PR review comment</a>:</p>\n<blockquote>\n<p>Ah I just missed that test. Thanks!</p>\n</blockquote>",
        "id": 545695927,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1760735227
    },
    {
        "content": "<p>fitzgen submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11878#pullrequestreview-3352100549\">PR review</a>.</p>",
        "id": 545696249,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1760735397
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11878#discussion_r2441258763\">PR review comment</a>:</p>\n<blockquote>\n<p>I didn't realize we already copied memories for core Wasm; thought we were using borrows. I guess it isn't a blocker in that case, but if you have cycles to poke at it, seems worth exploring. But not the highest priority, I guess.</p>\n</blockquote>",
        "id": 545696251,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1760735397
    },
    {
        "content": "<p>fitzgen submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11878#pullrequestreview-3352104222\">PR review</a>.</p>",
        "id": 545696588,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1760735469
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11878#discussion_r2441260747\">PR review comment</a>:</p>\n<blockquote>\n<p>Yeah, seems fine by me. We are already moving from a standalone CLI to a subcommand of <code>wasmtime</code>, so seems like an otherwise opportune moment to bundle in little things like this.</p>\n</blockquote>",
        "id": 545696590,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1760735469
    },
    {
        "content": "<p>alexcrichton updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11878\">PR #11878</a>.</p>",
        "id": 545707838,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1760739347
    },
    {
        "content": "<p>alexcrichton submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11878#pullrequestreview-3352286248\">PR review</a>.</p>",
        "id": 545707879,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1760739373
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11878#discussion_r2441377942\">PR review comment</a>:</p>\n<blockquote>\n<p>Nah easy enough to test, mind taking a look at the latest commit?</p>\n</blockquote>",
        "id": 545707881,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1760739373
    },
    {
        "content": "<p>alexcrichton updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11878\">PR #11878</a>.</p>",
        "id": 545708737,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1760739913
    },
    {
        "content": "<p>fitzgen submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11878#pullrequestreview-3352394542\">PR review</a>.</p>",
        "id": 545714480,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1760745006
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11878#discussion_r2441456234\">PR review comment</a>:</p>\n<blockquote>\n<p>Hmm... I'm a little worried about some lurking accidental quadratic stuff in here. I don't have time at this very moment, but if you do, could you look at how <code>merge</code> is used below and double check that we don't call merge <code>O(len(data segments))</code> times? If all looks good, then feel free to merge.</p>\n<p>Otherwise, I can take a closer look on Monday.</p>\n</blockquote>",
        "id": 545714482,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1760745006
    },
    {
        "content": "<p>fitzgen submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11878#pullrequestreview-3352395301\">PR review</a>.</p>",
        "id": 545714550,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1760745076
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11878#discussion_r2441456862\">PR review comment</a>:</p>\n<blockquote>\n<p>That is, maybe the original copying of everythign the once was better than trying to minimize copies but then copying the copies multiple times :-/</p>\n</blockquote>",
        "id": 545714551,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1760745076
    },
    {
        "content": "<p>alexcrichton submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11878#pullrequestreview-3356764827\">PR review</a>.</p>",
        "id": 545999666,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1760971581
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11878#discussion_r2445239952\">PR review comment</a>:</p>\n<blockquote>\n<p>Oh this most definitely is quadratic now that I look at it. I'm going to revert this change in this PR, and I think I see how to do a follow-up PR which only copies out the nonzero portions. Would you be ok landing this to split out that part?</p>\n</blockquote>",
        "id": 545999670,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1760971582
    },
    {
        "content": "<p>alexcrichton updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11878\">PR #11878</a>.</p>",
        "id": 545999972,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1760971642
    },
    {
        "content": "<p>fitzgen submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11878#pullrequestreview-3357412782\">PR review</a>.</p>",
        "id": 546046815,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1760982932
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11878#discussion_r2445721173\">PR review comment</a>:</p>\n<blockquote>\n<blockquote>\n<p>Would you be ok landing this to split out that part?</p>\n</blockquote>\n<p>Yeah, definitely <span aria-label=\"+1\" class=\"emoji emoji-1f44d\" role=\"img\" title=\"+1\">:+1:</span> </p>\n</blockquote>",
        "id": 546046816,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1760982932
    },
    {
        "content": "<p>fitzgen merged <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11878\">PR #11878</a>.</p>",
        "id": 546051932,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1760984441
    }
]
[
    {
        "content": "<p><a href=\"https://github.com/alexcrichton\">alexcrichton</a> added the wasm-proposal:threads label to <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11747\">Issue #11747</a>.</p>",
        "id": 541734765,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1758915754
    },
    {
        "content": "<p>alexcrichton opened <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11747\">issue #11747</a>:</p>\n<blockquote>\n<p>Awhile back I <a href=\"https://rust-lang.zulipchat.com/#narrow/channel/213817-t-lang/topic/Writing.20a.20WebAssembly.20interpreter.20in.20Rust.20for.20wasm.20threads/with/541643681\">started a discussion</a> on the Rust Zulip about implementing the wasm threads proposal in Pulley. The conclusion at the time was that (a) this isn't possible in safe Rust, (b) it should be possible with inline assembly, and (c) we weren't going to pursue it for Pulley due to the portability goal of Pulley in the meantime. The consequence of this in Wasmtime is <a href=\"https://github.com/bytecodealliance/wasmtime/blob/df21758b250366717d56ae9b972860de4e3d71bd/crates/wasmtime/src/config.rs#L2095\">this line of code</a> and a notable lack of anything atomic in Pulley's interpreter.</p>\n<p>In the meantime the discussion on the Zulip issue continued on and resulted in publishing a crate named <a href=\"https://crates.io/crates/ecmascript_atomics\"><code>ecmascript_atomics</code></a> which is targeted at this exact use case. This crate looks to be drawn from SpiderMonkey's implementation of the same. There are two reasons I think we'll want to integrate this crate:</p>\n<ul>\n<li>The primary one is the resolution of <a href=\"https://github.com/bytecodealliance/wasmtime/issues/4203\">https://github.com/bytecodealliance/wasmtime/issues/4203</a>. For example <a href=\"https://github.com/bytecodealliance/wasmtime/blob/df21758b250366717d56ae9b972860de4e3d71bd/crates/wasmtime/src/runtime/vm/instance.rs#L1031\">this memcpy</a>, entirely unrelated to Pulley, is almost surely \"technically not sound\" given Rust's memory model. Functions like <a href=\"https://docs.rs/ecmascript_atomics/latest/ecmascript_atomics/struct.RacySlice.html#method.copy_from_slice\"><code>RacySlice::copy_from_slice</code></a>, however, look tailor made for this use case.</li>\n<li>Integrating this crate into Pulley would enable implementing the wasm threads proposal. Integrating this would require adding atomic instructions to Pulley and additionally updating <strong>all</strong> reads and writes to use this crate. Ordinary reads/writes would use <code>Unordered</code> and atomics would use <code>SeqCst</code>.</li>\n</ul>\n<p>The main barrier to adopting this crate is portability at this time. As of the time of this writing it has support for x86, x86_64, aarch64, and arm. This notably does not include platforms Cranelift supports such as s390x and riscv64 and does not include \"theoretically all platforms Rust compiles to\" for Pulley. Nevertheless I think this would be worthwhile to integrate into Wasmtime as so:</p>\n<ul>\n<li>[ ] Add a wrapper around this crate to <code>wasmtime-internal-math</code> in-tree (probably renaming this to maybe <code>wasmtime-internal-core</code> in the process). This would use <code>ecmascript_atomics</code> on supported platforms and some emulated fallback on unsupported platforms (e.g. the unsound <code>std::ptr::copy</code> for a memcpy-based move).</li>\n<li>[ ] Update Pulley's support of the wasm threads proposal to be architecture-specific. For example it would support the proposal on platforms that <code>ecmascript_atomics</code> supports, but it would continue to not have support on other platforms (e.g. Pulley powerpc would not have support for the atomics proposal)</li>\n<li>[ ] Update Pulley's reads/writes of today to use <code>Unordered</code> atomic reads/writes</li>\n<li>[ ] Add atomic instructions, probably in the \"extended\" opcode namespace for Pulley, and equivalent lowerings to Cranelift to support generating atomics.</li>\n</ul>\n<p>With all that in place we could still benefit from this crate, despite the lack of portability. While it probably isn't too hard to add s390x/riscv64 the lack of portability in this approach is pretty fundamental. I don't think that should block us from integrating it at all, however, but conditionally disabling threads in Pulley would be a reasonable consequence that reflects an accurate depiction of support.</p>\n</blockquote>",
        "id": 541734766,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1758915754
    }
]
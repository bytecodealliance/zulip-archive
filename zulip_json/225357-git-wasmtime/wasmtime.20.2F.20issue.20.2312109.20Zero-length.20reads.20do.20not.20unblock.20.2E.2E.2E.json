[
    {
        "content": "<p>alexcrichton assigned dicej to <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12109\">issue #12109</a>.</p>",
        "id": 561506556,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764705107
    },
    {
        "content": "<p>alexcrichton opened <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12109\">issue #12109</a>:</p>\n<blockquote>\n<p>Given this input:</p>\n<div class=\"codehilite\" data-code-language=\"wasm\"><pre><span></span><code>(component\n  (type $s (stream u32))\n  (core module $libc (memory (export \"m\") 1))\n\n  (component $a\n    (core instance $libc (instantiate $libc))\n    (core func $stream.read (canon stream.read $s async (memory $libc \"m\")))\n\n    (core module $m\n      (import \"\" \"stream.read\" (func $stream.read (param i32 i32 i32) (result i32)))\n\n      (func (export \"run\") (param $r i32)\n        (call $stream.read (local.get $r) (i32.const 0) (i32.const 0))\n        if unreachable end\n      )\n    )\n\n    (core instance $i (instantiate $m\n      (with \"\" (instance\n        (export \"stream.read\" (func $stream.read))\n      ))\n    ))\n\n    (func (export \"run\") (param \"s\" $s) (canon lift (core func $i \"run\")))\n  )\n\n  (component $b\n    (import \"a\" (func $a (param \"s\" $s)))\n    (core instance $libc (instantiate $libc))\n\n    (core func $stream.new (canon stream.new $s))\n    (core func $stream.write (canon stream.write $s async (memory $libc \"m\")))\n    (core func $a (canon lower (func $a)))\n\n    (core func $waitable-set.new (canon waitable-set.new))\n    (core func $waitable-set.poll (canon waitable-set.poll (memory $libc \"m\")))\n    (core func $waitable.join (canon waitable.join))\n\n    (core module $m\n      (import \"\" \"stream.new\" (func $stream.new (result i64)))\n      (import \"\" \"stream.write\" (func $stream.write (param i32 i32 i32) (result i32)))\n      (import \"\" \"a\" (func $a (param i32)))\n      (import \"\" \"waitable-set.new\" (func $waitable-set.new (result i32)))\n      (import \"\" \"waitable-set.poll\" (func $waitable-set.poll (param i32 i32) (result i32)))\n      (import \"\" \"waitable.join\" (func $waitable.join (param i32 i32)))\n      (import \"\" \"m\" (memory 1))\n\n      (func (export \"run\")\n        (local $tmp i64)\n        (local $r i32)\n        (local $w i32)\n        (local $s i32)\n        (local $rc i32)\n        (local.set $tmp (call $stream.new))\n\n        (local.set $r (i32.wrap_i64 (local.get $tmp)))\n        (local.set $w (i32.wrap_i64 (i64.shr_u (local.get $tmp) (i64.const 32))))\n\n        (call $stream.write (local.get $w) (i32.const 0) (i32.const 1))\n        i32.const -1\n        i32.ne\n        if unreachable end\n\n        (call $a (local.get $r))\n\n        (local.set $s (call $waitable-set.new))\n        (call $waitable.join (local.get $w) (local.get $s))\n        (local.set $rc (call $waitable-set.poll (local.get $s) (i32.const 100)))\n\n        (i32.ne (local.get $rc) (i32.const 3)) ;; EVENT_STREAM_WRITE\n        if unreachable end\n      )\n    )\n\n    (core instance $i (instantiate $m\n      (with \"\" (instance\n        (export \"stream.new\" (func $stream.new))\n        (export \"stream.write\" (func $stream.write))\n        (export \"a\" (func $a))\n        (export \"waitable-set.new\" (func $waitable-set.new))\n        (export \"waitable-set.poll\" (func $waitable-set.poll))\n        (export \"waitable.join\" (func $waitable.join))\n        (export \"m\" (memory $libc \"m\"))\n      ))\n    ))\n\n    (func (export \"run\") async (canon lift (core func $i \"run\")))\n  )\n\n  (instance $a (instantiate $a))\n  (instance $b (instantiate $b (with \"a\" (func $a \"run\"))))\n  (export \"run\" (func $b \"run\"))\n)\n\n(assert_return (invoke \"run\"))\n</code></pre></div>\n<p>I see:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"n\">WASMTIME_BACKTRACE_DETAILS</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">wast</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"p\">.</span><span class=\"n\">wast</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">W</span><span class=\"w\"> </span><span class=\"n\">component</span><span class=\"o\">-</span><span class=\"n\">model</span><span class=\"o\">-</span><span class=\"k\">async</span>\n<span class=\"w\">    </span><span class=\"n\">Finished</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">dev</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">profile</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">unoptimized</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">debuginfo</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"p\">(</span><span class=\"n\">s</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"mf\">0.10</span><span class=\"n\">s</span>\n<span class=\"w\">     </span><span class=\"n\">Running</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">target</span><span class=\"o\">/</span><span class=\"n\">x86_64</span><span class=\"o\">-</span><span class=\"n\">unknown</span><span class=\"o\">-</span><span class=\"n\">linux</span><span class=\"o\">-</span><span class=\"n\">gnu</span><span class=\"o\">/</span><span class=\"n\">debug</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"n\">wast</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"p\">.</span><span class=\"n\">wast</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">W</span><span class=\"w\"> </span><span class=\"n\">component</span><span class=\"o\">-</span><span class=\"n\">model</span><span class=\"o\">-</span><span class=\"k\">async</span><span class=\"err\">`</span>\n<span class=\"n\">Error</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">script</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">foo</span><span class=\"p\">.</span><span class=\"n\">wast</span><span class=\"o\">'</span>\n\n<span class=\"n\">Caused</span><span class=\"w\"> </span><span class=\"n\">by</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"mi\">0</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">directive</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"p\">.</span><span class=\"n\">wast</span><span class=\"p\">:</span><span class=\"mi\">95</span>\n<span class=\"w\">    </span><span class=\"mi\">1</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">error</span><span class=\"w\"> </span><span class=\"k\">while</span><span class=\"w\"> </span><span class=\"n\">executing</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">wasm</span><span class=\"w\"> </span><span class=\"n\">backtrace</span><span class=\"p\">:</span>\n<span class=\"w\">           </span><span class=\"mi\">0</span><span class=\"p\">:</span><span class=\"w\">    </span><span class=\"mh\">0x41e</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">wasm</span><span class=\"o\">-</span><span class=\"n\">function</span><span class=\"p\">[</span><span class=\"mi\">6</span><span class=\"p\">]</span>\n<span class=\"w\">                           </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">foo</span><span class=\"p\">.</span><span class=\"n\">wast</span><span class=\"p\">:</span><span class=\"mi\">71</span><span class=\"p\">:</span><span class=\"mi\">24</span>\n<span class=\"w\">    </span><span class=\"mi\">2</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">wasm</span><span class=\"w\"> </span><span class=\"n\">trap</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">wasm</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">unreachable</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">instruction</span><span class=\"w\"> </span><span class=\"n\">executed</span>\n</code></pre></div>\n<p>Reading over <a href=\"https://github.com/WebAssembly/component-model/tree/main/design/mvp#stream-state\">this documentation</a>, namely the definitions of <code>read</code> and <code>write</code>, I believe that a zero-length read should unblock a nonzero-length write (or, well, any write). The only special case is that a zero-length-read with a zero-length-write unblocks the write only (not the read).</p>\n<p>cc @lukewagner on this too</p>\n</blockquote>",
        "id": 561506563,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764705108
    },
    {
        "content": "<p><a href=\"https://github.com/alexcrichton\">alexcrichton</a> added the wasm-proposal:component-model-async label to <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12109\">Issue #12109</a>.</p>",
        "id": 561506564,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764705108
    },
    {
        "content": "<p>lukewagner <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12109#issuecomment-3603876194\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12109\">issue #12109</a>:</p>\n<blockquote>\n<p>There may be some wording or code that needs to be improved, but I think (and re-reading it just now, CanonicalABI.md#stream-state seems to match): a zero-length {read or write} should never unblock a non-zero-length {read or write}.  Specifically, if the writer arrives first and blocks, then the read will be guarded <a href=\"https://github.com/WebAssembly/component-model/blob/main/design/mvp/CanonicalABI.md?plain=1#L1455-L1458\">here</a> by <code>if dst_buffer.remain() &gt; 0</code> (where <code>dst_buffer.remain()</code> is the length passed to <code>stream.read</code>) and thus <code>pending_on_copy</code> is <em>not</em> called (which would have woken the writer) while <code>on_copy_done</code> <em>is</em> called (which makes <code>stream.read</code> complete eagerly).</p>\n</blockquote>",
        "id": 561514368,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764707950
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12109#issuecomment-3604102635\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12109\">issue #12109</a>:</p>\n<blockquote>\n<p>Ah ok I think I confused myself as to what I was reading. So it's expected that zero-length-things never wakeup non-zero-length-things, but two zero-length-things always have the writer wake up?</p>\n</blockquote>",
        "id": 561525288,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764712010
    },
    {
        "content": "<p>lukewagner <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12109#issuecomment-3604280506\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12109\">issue #12109</a>:</p>\n<blockquote>\n<p>Yep!</p>\n</blockquote>",
        "id": 561535168,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764716078
    },
    {
        "content": "<p>alexcrichton closed <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12109\">issue #12109</a>:</p>\n<blockquote>\n<p>Given this input:</p>\n<div class=\"codehilite\" data-code-language=\"wasm\"><pre><span></span><code>(component\n  (type $s (stream u32))\n  (core module $libc (memory (export \"m\") 1))\n\n  (component $a\n    (core instance $libc (instantiate $libc))\n    (core func $stream.read (canon stream.read $s async (memory $libc \"m\")))\n\n    (core module $m\n      (import \"\" \"stream.read\" (func $stream.read (param i32 i32 i32) (result i32)))\n\n      (func (export \"run\") (param $r i32)\n        (call $stream.read (local.get $r) (i32.const 0) (i32.const 0))\n        if unreachable end\n      )\n    )\n\n    (core instance $i (instantiate $m\n      (with \"\" (instance\n        (export \"stream.read\" (func $stream.read))\n      ))\n    ))\n\n    (func (export \"run\") (param \"s\" $s) (canon lift (core func $i \"run\")))\n  )\n\n  (component $b\n    (import \"a\" (func $a (param \"s\" $s)))\n    (core instance $libc (instantiate $libc))\n\n    (core func $stream.new (canon stream.new $s))\n    (core func $stream.write (canon stream.write $s async (memory $libc \"m\")))\n    (core func $a (canon lower (func $a)))\n\n    (core func $waitable-set.new (canon waitable-set.new))\n    (core func $waitable-set.poll (canon waitable-set.poll (memory $libc \"m\")))\n    (core func $waitable.join (canon waitable.join))\n\n    (core module $m\n      (import \"\" \"stream.new\" (func $stream.new (result i64)))\n      (import \"\" \"stream.write\" (func $stream.write (param i32 i32 i32) (result i32)))\n      (import \"\" \"a\" (func $a (param i32)))\n      (import \"\" \"waitable-set.new\" (func $waitable-set.new (result i32)))\n      (import \"\" \"waitable-set.poll\" (func $waitable-set.poll (param i32 i32) (result i32)))\n      (import \"\" \"waitable.join\" (func $waitable.join (param i32 i32)))\n      (import \"\" \"m\" (memory 1))\n\n      (func (export \"run\")\n        (local $tmp i64)\n        (local $r i32)\n        (local $w i32)\n        (local $s i32)\n        (local $rc i32)\n        (local.set $tmp (call $stream.new))\n\n        (local.set $r (i32.wrap_i64 (local.get $tmp)))\n        (local.set $w (i32.wrap_i64 (i64.shr_u (local.get $tmp) (i64.const 32))))\n\n        (call $stream.write (local.get $w) (i32.const 0) (i32.const 1))\n        i32.const -1\n        i32.ne\n        if unreachable end\n\n        (call $a (local.get $r))\n\n        (local.set $s (call $waitable-set.new))\n        (call $waitable.join (local.get $w) (local.get $s))\n        (local.set $rc (call $waitable-set.poll (local.get $s) (i32.const 100)))\n\n        (i32.ne (local.get $rc) (i32.const 3)) ;; EVENT_STREAM_WRITE\n        if unreachable end\n      )\n    )\n\n    (core instance $i (instantiate $m\n      (with \"\" (instance\n        (export \"stream.new\" (func $stream.new))\n        (export \"stream.write\" (func $stream.write))\n        (export \"a\" (func $a))\n        (export \"waitable-set.new\" (func $waitable-set.new))\n        (export \"waitable-set.poll\" (func $waitable-set.poll))\n        (export \"waitable.join\" (func $waitable.join))\n        (export \"m\" (memory $libc \"m\"))\n      ))\n    ))\n\n    (func (export \"run\") async (canon lift (core func $i \"run\")))\n  )\n\n  (instance $a (instantiate $a))\n  (instance $b (instantiate $b (with \"a\" (func $a \"run\"))))\n  (export \"run\" (func $b \"run\"))\n)\n\n(assert_return (invoke \"run\"))\n</code></pre></div>\n<p>I see:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"n\">WASMTIME_BACKTRACE_DETAILS</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">wast</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"p\">.</span><span class=\"n\">wast</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">W</span><span class=\"w\"> </span><span class=\"n\">component</span><span class=\"o\">-</span><span class=\"n\">model</span><span class=\"o\">-</span><span class=\"k\">async</span>\n<span class=\"w\">    </span><span class=\"n\">Finished</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">dev</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">profile</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">unoptimized</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">debuginfo</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"p\">(</span><span class=\"n\">s</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"mf\">0.10</span><span class=\"n\">s</span>\n<span class=\"w\">     </span><span class=\"n\">Running</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">target</span><span class=\"o\">/</span><span class=\"n\">x86_64</span><span class=\"o\">-</span><span class=\"n\">unknown</span><span class=\"o\">-</span><span class=\"n\">linux</span><span class=\"o\">-</span><span class=\"n\">gnu</span><span class=\"o\">/</span><span class=\"n\">debug</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"n\">wast</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"p\">.</span><span class=\"n\">wast</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">W</span><span class=\"w\"> </span><span class=\"n\">component</span><span class=\"o\">-</span><span class=\"n\">model</span><span class=\"o\">-</span><span class=\"k\">async</span><span class=\"err\">`</span>\n<span class=\"n\">Error</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">script</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">foo</span><span class=\"p\">.</span><span class=\"n\">wast</span><span class=\"o\">'</span>\n\n<span class=\"n\">Caused</span><span class=\"w\"> </span><span class=\"n\">by</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"mi\">0</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">directive</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"p\">.</span><span class=\"n\">wast</span><span class=\"p\">:</span><span class=\"mi\">95</span>\n<span class=\"w\">    </span><span class=\"mi\">1</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">error</span><span class=\"w\"> </span><span class=\"k\">while</span><span class=\"w\"> </span><span class=\"n\">executing</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">wasm</span><span class=\"w\"> </span><span class=\"n\">backtrace</span><span class=\"p\">:</span>\n<span class=\"w\">           </span><span class=\"mi\">0</span><span class=\"p\">:</span><span class=\"w\">    </span><span class=\"mh\">0x41e</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">wasm</span><span class=\"o\">-</span><span class=\"n\">function</span><span class=\"p\">[</span><span class=\"mi\">6</span><span class=\"p\">]</span>\n<span class=\"w\">                           </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">foo</span><span class=\"p\">.</span><span class=\"n\">wast</span><span class=\"p\">:</span><span class=\"mi\">71</span><span class=\"p\">:</span><span class=\"mi\">24</span>\n<span class=\"w\">    </span><span class=\"mi\">2</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">wasm</span><span class=\"w\"> </span><span class=\"n\">trap</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">wasm</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">unreachable</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">instruction</span><span class=\"w\"> </span><span class=\"n\">executed</span>\n</code></pre></div>\n<p>Reading over <a href=\"https://github.com/WebAssembly/component-model/tree/main/design/mvp#stream-state\">this documentation</a>, namely the definitions of <code>read</code> and <code>write</code>, I believe that a zero-length read should unblock a nonzero-length write (or, well, any write). The only special case is that a zero-length-read with a zero-length-write unblocks the write only (not the read).</p>\n<p>cc @lukewagner on this too</p>\n</blockquote>",
        "id": 561539671,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764718418
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12109#issuecomment-3604390539\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12109\">issue #12109</a>:</p>\n<blockquote>\n<p>Ok cool sounds good! In that case I'll close this and work on adjusting my fuzzer-to-be...</p>\n</blockquote>",
        "id": 561539672,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764718418
    }
]
[
    {
        "content": "<p><strong>dicej</strong> requested <a href=\"https://github.com/alexcrichton\">alexcrichton</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12153\">PR #12153</a>.</p>",
        "id": 563073390,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1765406215
    },
    {
        "content": "<p>dicej opened <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12153\">PR #12153</a> from <code>dicej:fix-12128</code> to <code>bytecodealliance:main</code>:</p>\n<blockquote>\n<p>The spec says we should allow this, so now we do.</p>\n<p>Thansk to Alex for the test case!</p>\n<p>Fixes #12128</p>\n<p>&lt;!--<br>\nPlease make sure you include the following information:</p>\n<ul>\n<li>\n<p>If this work has been discussed elsewhere, please include a link to that<br>\n  conversation. If it was discussed in an issue, just mention \"issue #...\".</p>\n</li>\n<li>\n<p>Explain why this change is needed. If the details are in an issue already,<br>\n  this can be brief.</p>\n</li>\n</ul>\n<p>Our development process is documented in the Wasmtime book:<br>\n<a href=\"https://docs.wasmtime.dev/contributing-development-process.html\">https://docs.wasmtime.dev/contributing-development-process.html</a></p>\n<p>Please ensure all communication follows the code of conduct:<br>\n<a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md\">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>\n--&gt;</p>\n</blockquote>",
        "id": 563073393,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1765406215
    },
    {
        "content": "<p><strong>dicej</strong> requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers\">wasmtime-core-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12153\">PR #12153</a>.</p>",
        "id": 563073394,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1765406216
    },
    {
        "content": "<p>alexcrichton submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12153#pullrequestreview-3564797910\">PR review</a>:</p>\n<blockquote>\n<p>Code/test all look fine, but I'm trying to correlate this with the spec as well. I thought I remember that historically <code>may_enter</code> was a thing but it's no longer present in <code>CanonicalABI.md</code>. Can you clarify which point in the spec I should be looking at to double-check this? (and probably queue up some sort of rename/refactor to handle <code>may_enter</code> to align with the spec)</p>\n</blockquote>",
        "id": 563074447,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1765406746
    },
    {
        "content": "<p>dicej <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12153#issuecomment-3639279475\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12153\">PR #12153</a>:</p>\n<blockquote>\n<blockquote>\n<p>Code/test all look fine, but I'm trying to correlate this with the spec as well. I thought I remember that historically <code>may_enter</code> was a thing but it's no longer present in <code>CanonicalABI.md</code>. Can you clarify which point in the spec I should be looking at to double-check this? (and probably queue up some sort of rename/refactor to handle <code>may_enter</code> to align with the spec)</p>\n</blockquote>\n<p>Search for <code>trap_of_on_the_stack</code> in <code>CanonicalABI.md</code> and the prose that follows.  I agree that some renaming and/or refactoring may be due.</p>\n</blockquote>",
        "id": 563075249,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1765407212
    },
    {
        "content": "<p>dicej edited a <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12153#issuecomment-3639279475\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12153\">PR #12153</a>:</p>\n<blockquote>\n<blockquote>\n<p>Code/test all look fine, but I'm trying to correlate this with the spec as well. I thought I remember that historically <code>may_enter</code> was a thing but it's no longer present in <code>CanonicalABI.md</code>. Can you clarify which point in the spec I should be looking at to double-check this? (and probably queue up some sort of rename/refactor to handle <code>may_enter</code> to align with the spec)</p>\n</blockquote>\n<p>Search for <code>trap_if_on_the_stack</code> in <code>CanonicalABI.md</code> and the prose that follows.  I agree that some renaming and/or refactoring may be due.</p>\n</blockquote>",
        "id": 563075273,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1765407231
    },
    {
        "content": "<p>dicej <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12153#issuecomment-3639297275\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12153\">PR #12153</a>:</p>\n<blockquote>\n<p>I'm investigating the test failure; looks like dropping a subtask while it's yielding in an infinite loop will require some extra care.</p>\n</blockquote>",
        "id": 563076081,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1765407642
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12153#issuecomment-3641633056\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12153\">PR #12153</a>:</p>\n<blockquote>\n<p>Joel and I discussed this and the conclusion is that the <code>may_enter</code> handling in Wasmtime is outdated and no longer in sync with the spec after component-model-async refactors. Effectively we need to rebuild the reentrance check from scratch throughout Wasmtime and avoid using <code>may_enter</code> for the triple-purpose of: preventing reentrance, requiring <code>post_return</code>, and lockdown-on-trap. This'll require refactors internally to use a new component-model-async helper but will <a href=\"#narrow/channel/217126-wasmtime/topic/Wasmtime.20sync.3C-.3Esync.20adapter.20optimizability/near/563170820\">have an impact on component adapter performance</a> as well. This all corresponds to <a href=\"https://github.com/WebAssembly/component-model/blob/main/design/mvp/CanonicalABI.md#task-state\"><code>trap_if_on_the_stack</code> in the spec</a> (scroll down a bit)</p>\n</blockquote>",
        "id": 563171179,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1765455097
    },
    {
        "content": "<p>dicej edited a <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12153#issuecomment-3639297275\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12153\">PR #12153</a>:</p>\n<blockquote>\n<p>I'm investigating the test failure; <del>looks like dropping a subtask while it's yielding in an infinite loop will require some extra care.</del> EDIT: the problem is more fundamental than that, and the refactoring Alex suggested above is going to be necessary in order to fix #12128 properly.</p>\n</blockquote>",
        "id": 563207020,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1765464822
    },
    {
        "content": "<p><strong>dicej</strong> requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers\">wasmtime-compiler-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12153\">PR #12153</a>.</p>",
        "id": 564140798,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1765922680
    },
    {
        "content": "<p><strong>dicej</strong> requested <a href=\"https://github.com/cfallin\">cfallin</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12153\">PR #12153</a>.</p>",
        "id": 564140799,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1765922680
    },
    {
        "content": "<p>dicej updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12153\">PR #12153</a>.</p>",
        "id": 564140800,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1765922680
    },
    {
        "content": "<p>dicej updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12153\">PR #12153</a>.</p>",
        "id": 564143501,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1765923969
    },
    {
        "content": "<p>dicej updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12153\">PR #12153</a>.</p>",
        "id": 564144990,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1765924769
    },
    {
        "content": "<p>dicej updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12153\">PR #12153</a>.</p>",
        "id": 564153595,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1765930380
    },
    {
        "content": "<p>dicej updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12153\">PR #12153</a>.</p>",
        "id": 564154348,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1765931064
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12153#issuecomment-3683744163\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12153\">PR #12153</a>:</p>\n<blockquote>\n<p>Current thinking, assuming I'm remembering this all correctly:</p>\n<ul>\n<li>Wasmtime will analyze/store a boolean that indicates, for a component, \"components with core modules contain no components\", aka core modules are located only in the leaves of a component composition. If this is <code>true</code>, then reentrance checks in component&lt;-&gt;component adapters can be skipped entirely. If this is <code>false</code>, which is expected to be quite rare today, then this PR's slow path will kick in.</li>\n<li>The slow path is expected to be tweaked at the spec level. Right now flags a per-component-instance but they sort of need to be \"find the least upper bound\" in the path of components-to-the-root to set the reentrance flag on to ensure that implementation details of where implementations live aren't leaked (precise details TBD). This effectively means, however, that the <code>may_enter</code> flag for the host-level component will be component-wide.</li>\n<li>There will be a new check on the sync&lt;-&gt;sync adapter which will manage <code>can_block</code>-style flags. This is necessary to ensure that when a sync-typed function is called it's not allowed to block. This is an accidental omission and bug in today's implementation which will be fixed.</li>\n</ul>\n<p>In short, sync&lt;-&gt;sync adapters will get faster on one axis (removing reentrance checks) but slower on another access (manipulating the <code>can_block</code>) flag. The <code>can_block</code> flag will live per-<code>vm::ComponentInstance</code> and will be as fast as the current reentrance check. In essence the sync&lt;-&gt;sync adapter performance profile is not expected to change.</p>\n</blockquote>",
        "id": 565057120,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1766430445
    },
    {
        "content": "<p>dicej updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12153\">PR #12153</a>.</p>",
        "id": 565081279,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1766445658
    },
    {
        "content": "<p>dicej updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12153\">PR #12153</a>.</p>",
        "id": 565081479,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1766445838
    },
    {
        "content": "<p>dicej updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12153\">PR #12153</a>.</p>",
        "id": 565082328,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1766446635
    },
    {
        "content": "<p>dicej updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12153\">PR #12153</a>.</p>",
        "id": 565083121,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1766447455
    },
    {
        "content": "<p>dicej updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12153\">PR #12153</a>.</p>",
        "id": 565168855,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1766501507
    },
    {
        "content": "<p>dicej updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12153\">PR #12153</a>.</p>",
        "id": 565215919,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1766526370
    },
    {
        "content": "<p>dicej <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12153#issuecomment-3715720276\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12153\">PR #12153</a>:</p>\n<blockquote>\n<p>@alexcrichton Would you mind taking another look at this when you have time?  I'm also happy to walk through it with you synchronously if that helps.</p>\n</blockquote>",
        "id": 566595271,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767722404
    },
    {
        "content": "<p>dicej closed without merge <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12153\">PR #12153</a>.</p>",
        "id": 566790468,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767808402
    },
    {
        "content": "<p>dicej <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12153#issuecomment-3720051357\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12153\">PR #12153</a>:</p>\n<blockquote>\n<p>After chatting with @alexcrichton about this, we decided to break this up into smaller PRs that address reentrance checks and may-block checks separately.</p>\n</blockquote>",
        "id": 566790471,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767808403
    }
]
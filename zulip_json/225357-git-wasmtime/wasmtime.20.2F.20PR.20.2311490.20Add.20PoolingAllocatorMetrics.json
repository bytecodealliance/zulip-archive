[
    {
        "content": "<p>lann opened <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11490\">PR #11490</a> from <code>lann:pooling-metrics</code> to <code>bytecodealliance:main</code>:</p>\n<blockquote>\n<p>This exposes some basic runtime metrics derived from the internal state of a <code>PoolingInstanceAllocator</code>.</p>\n<p>Two new atomics were added to PoolingInstanceAllocator: <code>live_memories</code> and <code>live_tables</code>. While these counts could be derived from existing state it would require acquiring mutexes on some inner state.</p>\n<p>Fixes <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11449\">https://github.com/bytecodealliance/wasmtime/issues/11449</a><br>\n&lt;!--<br>\nPlease make sure you include the following information:</p>\n<ul>\n<li>\n<p>If this work has been discussed elsewhere, please include a link to that<br>\n  conversation. If it was discussed in an issue, just mention \"issue #...\".</p>\n</li>\n<li>\n<p>Explain why this change is needed. If the details are in an issue already,<br>\n  this can be brief.</p>\n</li>\n</ul>\n<p>Our development process is documented in the Wasmtime book:<br>\n<a href=\"https://docs.wasmtime.dev/contributing-development-process.html\">https://docs.wasmtime.dev/contributing-development-process.html</a></p>\n<p>Please ensure all communication follows the code of conduct:<br>\n<a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md\">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>\n--&gt;</p>\n</blockquote>",
        "id": 535537308,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755792831
    },
    {
        "content": "<p><strong>lann</strong> requested <a href=\"https://github.com/pchickey\">pchickey</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11490\">PR #11490</a>.</p>",
        "id": 535537313,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755792832
    },
    {
        "content": "<p><strong>lann</strong> requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers\">wasmtime-core-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11490\">PR #11490</a>.</p>",
        "id": 535537316,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755792832
    },
    {
        "content": "<p>lann updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11490\">PR #11490</a>.</p>",
        "id": 535542383,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755794652
    },
    {
        "content": "<p><strong>lann</strong> has marked <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11490\">PR #11490</a> as ready for review.</p>",
        "id": 535542529,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755794724
    },
    {
        "content": "<p>lann submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11490#pullrequestreview-3141544756\">PR review</a>.</p>",
        "id": 535543121,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755795025
    },
    {
        "content": "<p>lann created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11490#discussion_r2291630286\">PR review comment</a>:</p>\n<blockquote>\n<p>I copied this approach from <code>increment_component_instance_count</code> but I could easily be convinced that it would be fine to just increment after successful allocation.</p>\n</blockquote>",
        "id": 535543122,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755795026
    },
    {
        "content": "<p>lann created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11490#discussion_r2291633842\">PR review comment</a>:</p>\n<blockquote>\n<p>I was on the fence about whether to just do <code>Ordering::Relaxed</code> here, but if someone ends up using metrics in actual business logic (like server backpressure) it would be a pretty nasty surprise for these to underflow...</p>\n</blockquote>",
        "id": 535543341,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755795123
    },
    {
        "content": "<p>lann submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11490#pullrequestreview-3141549246\">PR review</a>.</p>",
        "id": 535543342,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755795123
    },
    {
        "content": "<p>lann edited <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11490#discussion_r2291633842\">PR review comment</a>.</p>",
        "id": 535543379,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755795143
    },
    {
        "content": "<p>alexcrichton submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11490#pullrequestreview-3141909185\">PR review</a>.</p>",
        "id": 535560867,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755802439
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11490#discussion_r2291883813\">PR review comment</a>:</p>\n<blockquote>\n<p>Similar to above, I'd say that using <code>Relaxed</code> here is fine since these aren't actually synchronizing with anything other than themselves.</p>\n</blockquote>",
        "id": 535560868,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755802439
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11490#discussion_r2291880387\">PR review comment</a>:</p>\n<blockquote>\n<p>You'll want to switch this to using a <code>Drop</code> implementation because otherwise this won't be correctly accounted for if the future is cancelled/dropped.</p>\n</blockquote>",
        "id": 535560869,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755802439
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11490#discussion_r2291882238\">PR review comment</a>:</p>\n<blockquote>\n<p>Given the need to have a <code>Drop</code> to handle the cancelled-the-future case I'd be ok just putting this in the <code>Ok</code> path since that would avoid the need for <code>Drop</code> entirely</p>\n</blockquote>",
        "id": 535560870,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755802439
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11490#discussion_r2291878913\">PR review comment</a>:</p>\n<blockquote>\n<p>I'd actually opt towards using <code>Relaxed</code> here since there's explicitly no data dependency with anything else in the system (e.g. this isn't looking for memory effects of another operation or publishing its own memory effects). Could you detail more about the underflow point though? How would atomic ordering affect that?</p>\n</blockquote>",
        "id": 535560871,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755802439
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11490#discussion_r2291882623\">PR review comment</a>:</p>\n<blockquote>\n<p>Perhaps <code>debug_assert!</code> the previous value is <code>&gt; 0</code>?</p>\n</blockquote>",
        "id": 535560872,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755802439
    },
    {
        "content": "<p>lann submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11490#pullrequestreview-3141956824\">PR review</a>.</p>",
        "id": 535562904,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755803194
    },
    {
        "content": "<p>lann created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11490#discussion_r2291907673\">PR review comment</a>:</p>\n<blockquote>\n<p>Ah good point; I didn't think about this hard enough when I rebased on #11470. I'll just switch to incrementing on Ok anyway.</p>\n</blockquote>",
        "id": 535562906,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755803194
    },
    {
        "content": "<p>lann submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11490#pullrequestreview-3141971659\">PR review</a>.</p>",
        "id": 535563607,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755803483
    },
    {
        "content": "<p>lann created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11490#discussion_r2291916695\">PR review comment</a>:</p>\n<blockquote>\n<p>Sounds good. I don't really have a good grasp of relaxed atomic semantics so I just pessimistically assume that a concurrent thread would be able to go back in time and kill its own grandparent or whatever.</p>\n</blockquote>",
        "id": 535563610,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755803484
    },
    {
        "content": "<p>lann updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11490\">PR #11490</a>.</p>",
        "id": 535564139,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755803705
    },
    {
        "content": "<p>alexcrichton submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11490#pullrequestreview-3141984490\">PR review</a>.</p>",
        "id": 535564245,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755803761
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11490#discussion_r2291925765\">PR review comment</a>:</p>\n<blockquote>\n<p>Heh nah makes sense. I'm by no means an expert but I'm confident enough in my understanding that if atomics are used for things like metric purposes it's fine to use relaxed. Relaxed ordering, AFAIK, basically means that you get no guarantees about other memory locations in the program when you observe a value. For the memory location in question, though, everything is still just as atomic as you'd expect (e.g. fetch-and-add still does that, it doesn't like switch to non-atomics). This happens because relaxed atomics can be reordered around each other by the compiler, so you can't for example say \"I saw N memories in use, therefore I must see N+1 tables in use next\", that's not valid.</p>\n</blockquote>",
        "id": 535564247,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755803761
    },
    {
        "content": "<p>lann updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11490\">PR #11490</a>.</p>",
        "id": 535564599,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755803918
    },
    {
        "content": "<p>lann submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11490#pullrequestreview-3142000301\">PR review</a>.</p>",
        "id": 535565048,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755804132
    },
    {
        "content": "<p>lann created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11490#discussion_r2291937484\">PR review comment</a>:</p>\n<blockquote>\n<p>Yeah makes sense. I guess I'm not entirely clear on what makes <code>increment_component_instance_count</code> different here that it would need <code>AcqRel</code>?</p>\n</blockquote>",
        "id": 535565051,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755804132
    },
    {
        "content": "<p>lann edited <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11490#discussion_r2291937484\">PR review comment</a>.</p>",
        "id": 535565265,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755804230
    },
    {
        "content": "<p>alexcrichton submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11490#pullrequestreview-3142012942\">PR review</a>.</p>",
        "id": 535565774,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755804433
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11490#discussion_r2291946567\">PR review comment</a>:</p>\n<blockquote>\n<p>Oh it's not, the main difference is I saw this here and no one saw it there most likely. There's no need for that to use <code>AcqRel</code> either and IMO it should also be using <code>Relaxed</code></p>\n</blockquote>",
        "id": 535565775,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755804433
    },
    {
        "content": "<p>alexcrichton has enabled auto merge for <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11490\">PR #11490</a>.</p>",
        "id": 535565806,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755804448
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11490#issuecomment-3212170627\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11490\">PR #11490</a>:</p>\n<blockquote>\n<p>While the vet error is spurious, the <a href=\"https://github.com/bytecodealliance/wasmtime/actions/runs/17137044780/job/48615486728\">miri failure</a> looks legitimate.</p>\n</blockquote>",
        "id": 535583483,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755812722
    },
    {
        "content": "<p>lann <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11490#issuecomment-3214812642\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11490\">PR #11490</a>:</p>\n<blockquote>\n<p>This does indeed fail under miri locally: <a href=\"https://github.com/bytecodealliance/wasmtime/blob/fc3f429d72fabd4fb669f17c977c11752e078313/crates/wasmtime/src/runtime/vm/instance/allocator/pooling/metrics.rs#L76-L77\">https://github.com/bytecodealliance/wasmtime/blob/fc3f429d72fabd4fb669f17c977c11752e078313/crates/wasmtime/src/runtime/vm/instance/allocator/pooling/metrics.rs#L76-L77</a></p>\n<p>Presumably I can work around this by overriding some default config, but is it a bug that the defaults don't work with miri?</p>\n</blockquote>",
        "id": 535709552,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755877278
    },
    {
        "content": "<p>lann <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11490#issuecomment-3214822829\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11490\">PR #11490</a>:</p>\n<blockquote>\n<p>Oh well I guess that's pretty straightforward: <a href=\"https://github.com/bytecodealliance/wasmtime/blob/fc3f429d72fabd4fb669f17c977c11752e078313/crates/environ/src/tunables.rs#L149-L150\">https://github.com/bytecodealliance/wasmtime/blob/fc3f429d72fabd4fb669f17c977c11752e078313/crates/environ/src/tunables.rs#L149-L150</a></p>\n<p>Any preference on how to fix this?</p>\n<ul>\n<li>Add a <code>cfg!(miri)</code> for default <code>max_memory_size</code></li>\n<li>Just set <code>max_memory_size</code> in the test</li>\n</ul>\n</blockquote>",
        "id": 535710052,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755877440
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11490#issuecomment-3214840333\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11490\">PR #11490</a>:</p>\n<blockquote>\n<p>The main test suite has a <a href=\"https://github.com/bytecodealliance/wasmtime/blob/f5af05e25533246f8f0750f3bfff5ba6456072f0/tests/all/main.rs#L94-L113\">helper function for a \"small pool config\"</a> which could be modeled here as well, but this test isn't too interesting for miri so it's also fine to slap a <code>#[cfg_attr(miri, ignore)]</code> on the test</p>\n</blockquote>",
        "id": 535710695,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755877629
    },
    {
        "content": "<p>lann updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11490\">PR #11490</a>.</p>",
        "id": 535711499,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755877899
    },
    {
        "content": "<p>alexcrichton has enabled auto merge for <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11490\">PR #11490</a>.</p>",
        "id": 535712612,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755878258
    },
    {
        "content": "<p>alexcrichton merged <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11490\">PR #11490</a>.</p>",
        "id": 535717405,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755879938
    }
]
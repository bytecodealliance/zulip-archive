[
    {
        "content": "<p><strong>bongjunj</strong> requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers\">wasmtime-compiler-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12303\">PR #12303</a>.</p>",
        "id": 567093967,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767948518
    },
    {
        "content": "<p>bongjunj opened <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12303\">PR #12303</a> from <code>bongjunj:optimize-isle-compilation</code> to <code>bytecodealliance:main</code>:</p>\n<blockquote>\n<p>&lt;!--<br>\nPlease make sure you include the following information:</p>\n<ul>\n<li>\n<p>If this work has been discussed elsewhere, please include a link to that<br>\n  conversation. If it was discussed in an issue, just mention \"issue #...\".</p>\n</li>\n<li>\n<p>Explain why this change is needed. If the details are in an issue already,<br>\n  this can be brief.</p>\n</li>\n</ul>\n<p>Our development process is documented in the Wasmtime book:<br>\n<a href=\"https://docs.wasmtime.dev/contributing-development-process.html\">https://docs.wasmtime.dev/contributing-development-process.html</a></p>\n<p>Please ensure all communication follows the code of conduct:<br>\n<a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md\">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>\n--&gt;</p>\n<h2>Overview</h2>\n<p>The current implementation of ISLE code generation emits a single Rust function for each ISLE term, and <code>rustc</code> compiles the Rust code to integrate ISLE with other modules of Cranelift.</p>\n<p>This can cause a compilation bottleneck when a ISLE term contains numerous rules ending up with producing a very very large Rust function, since <code>rustc</code> cannot efficiently compile such functions. Notably, the term <code>simplify</code> which implements the mid-end peephole optimizations has about 500 rules, and the symptom is already visible. (And the ruleset is growing!) You can check, compiling Cranelift, <code>cranelift-codegen</code> takes most of the time in the following report: <a href=\"https://github.com/user-attachments/files/24522422/cargo-timing.html\">cargo-timing.html</a></p>\n<p>Plus: a timing report for compiling wasmtime: </p>\n<p>With this PR, the ISLE codegen helps <code>rustc</code> by wrapping a large match statement generated by <code>islec</code> in a closure. By introducing closures, a portion of a huge Rust function (for a ISLE term) can be split into several smaller compilation units for <code>rustc</code>, reducing the compilation time.</p>\n<h2>Evaluation</h2>\n<p>On the <code>main</code> branch, the build times for <code>cranelift-codegen</code> before/after this optimization are measured. This PR saves ~2 seconds.</p>\n<ul>\n<li>Before: 23.81 sec</li>\n</ul>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"o\">~/</span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">optimize</span><span class=\"o\">-</span><span class=\"n\">isle</span><span class=\"o\">-</span><span class=\"n\">compilation</span><span class=\"p\">)</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">clean</span>\n<span class=\"w\">     </span><span class=\"n\">Removed</span><span class=\"w\"> </span><span class=\"mi\">10031</span><span class=\"w\"> </span><span class=\"n\">files</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mf\">12.6</span><span class=\"n\">GiB</span><span class=\"w\"> </span><span class=\"n\">total</span>\n<span class=\"o\">~/</span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">optimize</span><span class=\"o\">-</span><span class=\"n\">isle</span><span class=\"o\">-</span><span class=\"n\">compilation</span><span class=\"p\">)</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">cranelift</span><span class=\"o\">-</span><span class=\"n\">codegen</span>\n\n<span class=\"n\">________________________________________________________</span>\n<span class=\"n\">Executed</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\">   </span><span class=\"mf\">23.81</span><span class=\"w\"> </span><span class=\"n\">secs</span><span class=\"w\">    </span><span class=\"n\">fish</span><span class=\"w\">           </span><span class=\"n\">external</span>\n<span class=\"w\">   </span><span class=\"n\">usr</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\">   </span><span class=\"mf\">43.59</span><span class=\"w\"> </span><span class=\"n\">secs</span><span class=\"w\">    </span><span class=\"mf\">0.00</span><span class=\"w\"> </span><span class=\"n\">micros</span><span class=\"w\">   </span><span class=\"mf\">43.59</span><span class=\"w\"> </span><span class=\"n\">secs</span>\n<span class=\"w\">   </span><span class=\"n\">sys</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\">    </span><span class=\"mf\">5.04</span><span class=\"w\"> </span><span class=\"n\">secs</span><span class=\"w\">  </span><span class=\"mf\">592.00</span><span class=\"w\"> </span><span class=\"n\">micros</span><span class=\"w\">    </span><span class=\"mf\">5.04</span><span class=\"w\"> </span><span class=\"n\">secs</span>\n</code></pre></div>\n<ul>\n<li>After: 26.04 sec</li>\n</ul>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"o\">~/</span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"n\">dev</span><span class=\"p\">))</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">clean</span>\n<span class=\"n\">t</span><span class=\"w\">     </span><span class=\"n\">Removed</span><span class=\"w\"> </span><span class=\"mi\">1356</span><span class=\"w\"> </span><span class=\"n\">files</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mf\">1.0</span><span class=\"n\">GiB</span><span class=\"w\"> </span><span class=\"n\">total</span>\n<span class=\"o\">~/</span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"n\">dev</span><span class=\"p\">))</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">cranelift</span><span class=\"o\">-</span><span class=\"n\">codegen</span>\n\n<span class=\"n\">________________________________________________________</span>\n<span class=\"n\">Executed</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\">   </span><span class=\"mf\">26.04</span><span class=\"w\"> </span><span class=\"n\">secs</span><span class=\"w\">    </span><span class=\"n\">fish</span><span class=\"w\">           </span><span class=\"n\">external</span>\n<span class=\"w\">   </span><span class=\"n\">usr</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\">   </span><span class=\"mf\">46.58</span><span class=\"w\"> </span><span class=\"n\">secs</span><span class=\"w\">    </span><span class=\"mf\">0.00</span><span class=\"w\"> </span><span class=\"n\">micros</span><span class=\"w\">   </span><span class=\"mf\">46.58</span><span class=\"w\"> </span><span class=\"n\">secs</span>\n<span class=\"w\">   </span><span class=\"n\">sys</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\">    </span><span class=\"mf\">5.15</span><span class=\"w\"> </span><span class=\"n\">secs</span><span class=\"w\">  </span><span class=\"mf\">583.00</span><span class=\"w\"> </span><span class=\"n\">micros</span><span class=\"w\">    </span><span class=\"mf\">5.15</span><span class=\"w\"> </span><span class=\"n\">secs</span>\n</code></pre></div>\n<ul>\n<li>\n<p>Cargo Timing Reports</p>\n<ul>\n<li>\n<p>Before: <br>\n<a href=\"https://github.com/user-attachments/files/24523107/cargo-timing-old.html\">cargo-timing-old.html</a></p>\n</li>\n<li>\n<p>After: <br>\n<a href=\"https://github.com/user-attachments/files/24523109/cargo-timing-new.html\">cargo-timing-new.html</a></p>\n</li>\n</ul>\n</li>\n</ul>\n<h2>Extra</h2>\n<p>I am experimenting with over 6,000 ISLE <code>simplify</code> rules.<br>\nThe compilation time reduced from 841.37 seconds to 69.34 seconds with this PR. (+11x speedup)</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"o\">~/</span><span class=\"n\">w</span><span class=\"o\">/</span><span class=\"n\">cranelift</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"n\">many</span><span class=\"o\">-</span><span class=\"n\">rules</span><span class=\"o\">-</span><span class=\"n\">no</span><span class=\"o\">-</span><span class=\"n\">opt</span><span class=\"p\">))</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">clean</span><span class=\"w\"> </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">cranelift</span><span class=\"o\">-</span><span class=\"n\">codegen</span>\n<span class=\"n\">________________________________________________________</span>\n<span class=\"n\">Executed</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\">  </span><span class=\"mf\">841.37</span><span class=\"w\"> </span><span class=\"n\">secs</span><span class=\"w\">    </span><span class=\"n\">fish</span><span class=\"w\">           </span><span class=\"n\">external</span>\n<span class=\"w\">   </span><span class=\"n\">usr</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\">  </span><span class=\"mf\">826.92</span><span class=\"w\"> </span><span class=\"n\">secs</span><span class=\"w\">  </span><span class=\"mf\">325.00</span><span class=\"w\"> </span><span class=\"n\">micros</span><span class=\"w\">  </span><span class=\"mf\">826.92</span><span class=\"w\"> </span><span class=\"n\">secs</span>\n<span class=\"w\">   </span><span class=\"n\">sys</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\">   </span><span class=\"mf\">49.98</span><span class=\"w\"> </span><span class=\"n\">secs</span><span class=\"w\">  </span><span class=\"mf\">135.00</span><span class=\"w\"> </span><span class=\"n\">micros</span><span class=\"w\">   </span><span class=\"mf\">49.98</span><span class=\"w\"> </span><span class=\"n\">secs</span>\n\n<span class=\"w\"> </span><span class=\"o\">~/</span><span class=\"n\">w</span><span class=\"o\">/</span><span class=\"n\">cranelift</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">many</span><span class=\"o\">-</span><span class=\"n\">rules</span><span class=\"o\">-</span><span class=\"n\">opt</span><span class=\"p\">)</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">clean</span><span class=\"w\"> </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">cranelift</span><span class=\"o\">-</span><span class=\"n\">codegen</span>\n<span class=\"n\">________________________________________________________</span>\n<span class=\"n\">Executed</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\">   </span><span class=\"mf\">69.34</span><span class=\"w\"> </span><span class=\"n\">secs</span><span class=\"w\">    </span><span class=\"n\">fish</span><span class=\"w\">           </span><span class=\"n\">external</span>\n<span class=\"w\">   </span><span class=\"n\">usr</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\">   </span><span class=\"mf\">98.32</span><span class=\"w\"> </span><span class=\"n\">secs</span><span class=\"w\">  </span><span class=\"mf\">362.00</span><span class=\"w\"> </span><span class=\"n\">micros</span><span class=\"w\">   </span><span class=\"mf\">98.32</span><span class=\"w\"> </span><span class=\"n\">secs</span>\n<span class=\"w\">   </span><span class=\"n\">sys</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\">    </span><span class=\"mf\">6.42</span><span class=\"w\"> </span><span class=\"n\">secs</span><span class=\"w\">  </span><span class=\"mf\">149.00</span><span class=\"w\"> </span><span class=\"n\">micros</span><span class=\"w\">    </span><span class=\"mf\">6.42</span><span class=\"w\"> </span><span class=\"n\">secs</span>\n</code></pre></div>\n</blockquote>",
        "id": 567093968,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767948518
    },
    {
        "content": "<p><strong>bongjunj</strong> requested <a href=\"https://github.com/fitzgen\">fitzgen</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12303\">PR #12303</a>.</p>",
        "id": 567093970,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767948518
    },
    {
        "content": "<p>bongjunj edited <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12303\">PR #12303</a>:</p>\n<blockquote>\n<p>&lt;!--<br>\nPlease make sure you include the following information:</p>\n<ul>\n<li>\n<p>If this work has been discussed elsewhere, please include a link to that<br>\n  conversation. If it was discussed in an issue, just mention \"issue #...\".</p>\n</li>\n<li>\n<p>Explain why this change is needed. If the details are in an issue already,<br>\n  this can be brief.</p>\n</li>\n</ul>\n<p>Our development process is documented in the Wasmtime book:<br>\n<a href=\"https://docs.wasmtime.dev/contributing-development-process.html\">https://docs.wasmtime.dev/contributing-development-process.html</a></p>\n<p>Please ensure all communication follows the code of conduct:<br>\n<a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md\">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>\n--&gt;</p>\n<h2>Overview</h2>\n<p>The current implementation of ISLE code generation emits a single Rust function for each ISLE term, and <code>rustc</code> compiles the Rust code to integrate ISLE with other modules of Cranelift.</p>\n<p>This can cause a compilation bottleneck when a ISLE term contains numerous rules ending up with producing a very very large Rust function, since <code>rustc</code> cannot efficiently compile such functions. Notably, the term <code>simplify</code> which implements the mid-end peephole optimizations has about 500 rules, and the symptom is already visible. (And the ruleset is growing!) You can check, compiling Cranelift, <code>cranelift-codegen</code> takes most of the time in the following report: <a href=\"https://github.com/user-attachments/files/24522422/cargo-timing.html\">cargo-timing.html</a></p>\n<p>Plus: a timing report for compiling wasmtime: </p>\n<p>With this PR, the ISLE codegen helps <code>rustc</code> by wrapping a large match statement generated by <code>islec</code> in a closure. By introducing closures, a portion of a huge Rust function (for a ISLE term) can be split into several smaller compilation units for <code>rustc</code>, reducing the compilation time.</p>\n<h2>Evaluation</h2>\n<p>On the <code>main</code> branch, the build times for <code>cranelift-codegen</code> before/after this optimization are measured. This PR saves ~2 seconds.</p>\n<ul>\n<li>Before: 23.81 sec</li>\n</ul>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"o\">~/</span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">optimize</span><span class=\"o\">-</span><span class=\"n\">isle</span><span class=\"o\">-</span><span class=\"n\">compilation</span><span class=\"p\">)</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">clean</span>\n<span class=\"w\">     </span><span class=\"n\">Removed</span><span class=\"w\"> </span><span class=\"mi\">10031</span><span class=\"w\"> </span><span class=\"n\">files</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mf\">12.6</span><span class=\"n\">GiB</span><span class=\"w\"> </span><span class=\"n\">total</span>\n<span class=\"o\">~/</span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">optimize</span><span class=\"o\">-</span><span class=\"n\">isle</span><span class=\"o\">-</span><span class=\"n\">compilation</span><span class=\"p\">)</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">cranelift</span><span class=\"o\">-</span><span class=\"n\">codegen</span>\n\n<span class=\"n\">________________________________________________________</span>\n<span class=\"n\">Executed</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\">   </span><span class=\"mf\">23.81</span><span class=\"w\"> </span><span class=\"n\">secs</span><span class=\"w\">    </span><span class=\"n\">fish</span><span class=\"w\">           </span><span class=\"n\">external</span>\n<span class=\"w\">   </span><span class=\"n\">usr</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\">   </span><span class=\"mf\">43.59</span><span class=\"w\"> </span><span class=\"n\">secs</span><span class=\"w\">    </span><span class=\"mf\">0.00</span><span class=\"w\"> </span><span class=\"n\">micros</span><span class=\"w\">   </span><span class=\"mf\">43.59</span><span class=\"w\"> </span><span class=\"n\">secs</span>\n<span class=\"w\">   </span><span class=\"n\">sys</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\">    </span><span class=\"mf\">5.04</span><span class=\"w\"> </span><span class=\"n\">secs</span><span class=\"w\">  </span><span class=\"mf\">592.00</span><span class=\"w\"> </span><span class=\"n\">micros</span><span class=\"w\">    </span><span class=\"mf\">5.04</span><span class=\"w\"> </span><span class=\"n\">secs</span>\n</code></pre></div>\n<ul>\n<li>After: 26.04 sec</li>\n</ul>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"o\">~/</span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"n\">dev</span><span class=\"p\">))</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">clean</span>\n<span class=\"n\">t</span><span class=\"w\">     </span><span class=\"n\">Removed</span><span class=\"w\"> </span><span class=\"mi\">1356</span><span class=\"w\"> </span><span class=\"n\">files</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mf\">1.0</span><span class=\"n\">GiB</span><span class=\"w\"> </span><span class=\"n\">total</span>\n<span class=\"o\">~/</span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"n\">dev</span><span class=\"p\">))</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">cranelift</span><span class=\"o\">-</span><span class=\"n\">codegen</span>\n\n<span class=\"n\">________________________________________________________</span>\n<span class=\"n\">Executed</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\">   </span><span class=\"mf\">26.04</span><span class=\"w\"> </span><span class=\"n\">secs</span><span class=\"w\">    </span><span class=\"n\">fish</span><span class=\"w\">           </span><span class=\"n\">external</span>\n<span class=\"w\">   </span><span class=\"n\">usr</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\">   </span><span class=\"mf\">46.58</span><span class=\"w\"> </span><span class=\"n\">secs</span><span class=\"w\">    </span><span class=\"mf\">0.00</span><span class=\"w\"> </span><span class=\"n\">micros</span><span class=\"w\">   </span><span class=\"mf\">46.58</span><span class=\"w\"> </span><span class=\"n\">secs</span>\n<span class=\"w\">   </span><span class=\"n\">sys</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\">    </span><span class=\"mf\">5.15</span><span class=\"w\"> </span><span class=\"n\">secs</span><span class=\"w\">  </span><span class=\"mf\">583.00</span><span class=\"w\"> </span><span class=\"n\">micros</span><span class=\"w\">    </span><span class=\"mf\">5.15</span><span class=\"w\"> </span><span class=\"n\">secs</span>\n</code></pre></div>\n<ul>\n<li>Cargo Timing Reports<ul>\n<li>Before: <a href=\"https://github.com/user-attachments/files/24523107/cargo-timing-old.html\">cargo-timing-old.html</a></li>\n<li>After: <a href=\"https://github.com/user-attachments/files/24523109/cargo-timing-new.html\">cargo-timing-new.html</a></li>\n</ul>\n</li>\n</ul>\n<h2>Extra</h2>\n<p>I am experimenting with over 6,000 ISLE <code>simplify</code> rules.<br>\nThe compilation time reduced from 841.37 seconds to 69.34 seconds with this PR. (+11x speedup)</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"o\">~/</span><span class=\"n\">w</span><span class=\"o\">/</span><span class=\"n\">cranelift</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"n\">many</span><span class=\"o\">-</span><span class=\"n\">rules</span><span class=\"o\">-</span><span class=\"n\">no</span><span class=\"o\">-</span><span class=\"n\">opt</span><span class=\"p\">))</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">clean</span><span class=\"w\"> </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">cranelift</span><span class=\"o\">-</span><span class=\"n\">codegen</span>\n<span class=\"n\">________________________________________________________</span>\n<span class=\"n\">Executed</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\">  </span><span class=\"mf\">841.37</span><span class=\"w\"> </span><span class=\"n\">secs</span><span class=\"w\">    </span><span class=\"n\">fish</span><span class=\"w\">           </span><span class=\"n\">external</span>\n<span class=\"w\">   </span><span class=\"n\">usr</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\">  </span><span class=\"mf\">826.92</span><span class=\"w\"> </span><span class=\"n\">secs</span><span class=\"w\">  </span><span class=\"mf\">325.00</span><span class=\"w\"> </span><span class=\"n\">micros</span><span class=\"w\">  </span><span class=\"mf\">826.92</span><span class=\"w\"> </span><span class=\"n\">secs</span>\n<span class=\"w\">   </span><span class=\"n\">sys</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\">   </span><span class=\"mf\">49.98</span><span class=\"w\"> </span><span class=\"n\">secs</span><span class=\"w\">  </span><span class=\"mf\">135.00</span><span class=\"w\"> </span><span class=\"n\">micros</span><span class=\"w\">   </span><span class=\"mf\">49.98</span><span class=\"w\"> </span><span class=\"n\">secs</span>\n\n<span class=\"w\"> </span><span class=\"o\">~/</span><span class=\"n\">w</span><span class=\"o\">/</span><span class=\"n\">cranelift</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">many</span><span class=\"o\">-</span><span class=\"n\">rules</span><span class=\"o\">-</span><span class=\"n\">opt</span><span class=\"p\">)</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">clean</span><span class=\"w\"> </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">cranelift</span><span class=\"o\">-</span><span class=\"n\">codegen</span>\n<span class=\"n\">________________________________________________________</span>\n<span class=\"n\">Executed</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\">   </span><span class=\"mf\">69.34</span><span class=\"w\"> </span><span class=\"n\">secs</span><span class=\"w\">    </span><span class=\"n\">fish</span><span class=\"w\">           </span><span class=\"n\">external</span>\n<span class=\"w\">   </span><span class=\"n\">usr</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\">   </span><span class=\"mf\">98.32</span><span class=\"w\"> </span><span class=\"n\">secs</span><span class=\"w\">  </span><span class=\"mf\">362.00</span><span class=\"w\"> </span><span class=\"n\">micros</span><span class=\"w\">   </span><span class=\"mf\">98.32</span><span class=\"w\"> </span><span class=\"n\">secs</span>\n<span class=\"w\">   </span><span class=\"n\">sys</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\">    </span><span class=\"mf\">6.42</span><span class=\"w\"> </span><span class=\"n\">secs</span><span class=\"w\">  </span><span class=\"mf\">149.00</span><span class=\"w\"> </span><span class=\"n\">micros</span><span class=\"w\">    </span><span class=\"mf\">6.42</span><span class=\"w\"> </span><span class=\"n\">secs</span>\n</code></pre></div>\n</blockquote>",
        "id": 567094013,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767948537
    },
    {
        "content": "<p>bongjunj edited <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12303\">PR #12303</a>:</p>\n<blockquote>\n<p>&lt;!--<br>\nPlease make sure you include the following information:</p>\n<ul>\n<li>\n<p>If this work has been discussed elsewhere, please include a link to that<br>\n  conversation. If it was discussed in an issue, just mention \"issue #...\".</p>\n</li>\n<li>\n<p>Explain why this change is needed. If the details are in an issue already,<br>\n  this can be brief.</p>\n</li>\n</ul>\n<p>Our development process is documented in the Wasmtime book:<br>\n<a href=\"https://docs.wasmtime.dev/contributing-development-process.html\">https://docs.wasmtime.dev/contributing-development-process.html</a></p>\n<p>Please ensure all communication follows the code of conduct:<br>\n<a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md\">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>\n--&gt;</p>\n<h2>Overview</h2>\n<p>The current implementation of ISLE code generation emits a single Rust function for each ISLE term, and <code>rustc</code> compiles the Rust code to integrate ISLE with other modules of Cranelift.</p>\n<p>This can cause a compilation bottleneck when a ISLE term contains numerous rules ending up with producing a very very large Rust function, since <code>rustc</code> cannot efficiently compile such functions. Notably, the term <code>simplify</code> which implements the mid-end peephole optimizations has about 500 rules, and the symptom is already visible. (And the ruleset is growing!) You can check, compiling Cranelift, <code>cranelift-codegen</code> takes most of the time in the following report: <a href=\"https://github.com/user-attachments/files/24522422/cargo-timing.html\">cargo-timing.html</a></p>\n<p>Plus: a timing report for compiling wasmtime: </p>\n<p>With this PR, the ISLE codegen helps <code>rustc</code> by wrapping a large match statement generated by <code>islec</code> in a closure. By introducing closures, a portion of a huge Rust function (for a ISLE term) can be split into several smaller compilation units for <code>rustc</code>, reducing the compilation time.</p>\n<h2>Evaluation</h2>\n<p>On the <code>main</code> branch, the build times for <code>cranelift-codegen</code> before/after this optimization are measured. This PR saves ~2 seconds on my machine (x86-64, 64 core, 512GB memory)</p>\n<ul>\n<li>Before: 23.81 sec</li>\n</ul>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"o\">~/</span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">optimize</span><span class=\"o\">-</span><span class=\"n\">isle</span><span class=\"o\">-</span><span class=\"n\">compilation</span><span class=\"p\">)</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">clean</span>\n<span class=\"w\">     </span><span class=\"n\">Removed</span><span class=\"w\"> </span><span class=\"mi\">10031</span><span class=\"w\"> </span><span class=\"n\">files</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mf\">12.6</span><span class=\"n\">GiB</span><span class=\"w\"> </span><span class=\"n\">total</span>\n<span class=\"o\">~/</span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">optimize</span><span class=\"o\">-</span><span class=\"n\">isle</span><span class=\"o\">-</span><span class=\"n\">compilation</span><span class=\"p\">)</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">cranelift</span><span class=\"o\">-</span><span class=\"n\">codegen</span>\n\n<span class=\"n\">________________________________________________________</span>\n<span class=\"n\">Executed</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\">   </span><span class=\"mf\">23.81</span><span class=\"w\"> </span><span class=\"n\">secs</span><span class=\"w\">    </span><span class=\"n\">fish</span><span class=\"w\">           </span><span class=\"n\">external</span>\n<span class=\"w\">   </span><span class=\"n\">usr</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\">   </span><span class=\"mf\">43.59</span><span class=\"w\"> </span><span class=\"n\">secs</span><span class=\"w\">    </span><span class=\"mf\">0.00</span><span class=\"w\"> </span><span class=\"n\">micros</span><span class=\"w\">   </span><span class=\"mf\">43.59</span><span class=\"w\"> </span><span class=\"n\">secs</span>\n<span class=\"w\">   </span><span class=\"n\">sys</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\">    </span><span class=\"mf\">5.04</span><span class=\"w\"> </span><span class=\"n\">secs</span><span class=\"w\">  </span><span class=\"mf\">592.00</span><span class=\"w\"> </span><span class=\"n\">micros</span><span class=\"w\">    </span><span class=\"mf\">5.04</span><span class=\"w\"> </span><span class=\"n\">secs</span>\n</code></pre></div>\n<ul>\n<li>After: 26.04 sec</li>\n</ul>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"o\">~/</span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"n\">dev</span><span class=\"p\">))</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">clean</span>\n<span class=\"n\">t</span><span class=\"w\">     </span><span class=\"n\">Removed</span><span class=\"w\"> </span><span class=\"mi\">1356</span><span class=\"w\"> </span><span class=\"n\">files</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mf\">1.0</span><span class=\"n\">GiB</span><span class=\"w\"> </span><span class=\"n\">total</span>\n<span class=\"o\">~/</span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"n\">dev</span><span class=\"p\">))</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">cranelift</span><span class=\"o\">-</span><span class=\"n\">codegen</span>\n\n<span class=\"n\">________________________________________________________</span>\n<span class=\"n\">Executed</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\">   </span><span class=\"mf\">26.04</span><span class=\"w\"> </span><span class=\"n\">secs</span><span class=\"w\">    </span><span class=\"n\">fish</span><span class=\"w\">           </span><span class=\"n\">external</span>\n<span class=\"w\">   </span><span class=\"n\">usr</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\">   </span><span class=\"mf\">46.58</span><span class=\"w\"> </span><span class=\"n\">secs</span><span class=\"w\">    </span><span class=\"mf\">0.00</span><span class=\"w\"> </span><span class=\"n\">micros</span><span class=\"w\">   </span><span class=\"mf\">46.58</span><span class=\"w\"> </span><span class=\"n\">secs</span>\n<span class=\"w\">   </span><span class=\"n\">sys</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\">    </span><span class=\"mf\">5.15</span><span class=\"w\"> </span><span class=\"n\">secs</span><span class=\"w\">  </span><span class=\"mf\">583.00</span><span class=\"w\"> </span><span class=\"n\">micros</span><span class=\"w\">    </span><span class=\"mf\">5.15</span><span class=\"w\"> </span><span class=\"n\">secs</span>\n</code></pre></div>\n<ul>\n<li>Cargo Timing Reports<ul>\n<li>Before: <a href=\"https://github.com/user-attachments/files/24523107/cargo-timing-old.html\">cargo-timing-old.html</a></li>\n<li>After: <a href=\"https://github.com/user-attachments/files/24523109/cargo-timing-new.html\">cargo-timing-new.html</a></li>\n</ul>\n</li>\n</ul>\n<h2>Extra</h2>\n<p>I am experimenting with over 6,000 ISLE <code>simplify</code> rules.<br>\nThe compilation time reduced from 841.37 seconds to 69.34 seconds with this PR. (+11x speedup)</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"o\">~/</span><span class=\"n\">w</span><span class=\"o\">/</span><span class=\"n\">cranelift</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"n\">many</span><span class=\"o\">-</span><span class=\"n\">rules</span><span class=\"o\">-</span><span class=\"n\">no</span><span class=\"o\">-</span><span class=\"n\">opt</span><span class=\"p\">))</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">clean</span><span class=\"w\"> </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">cranelift</span><span class=\"o\">-</span><span class=\"n\">codegen</span>\n<span class=\"n\">________________________________________________________</span>\n<span class=\"n\">Executed</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\">  </span><span class=\"mf\">841.37</span><span class=\"w\"> </span><span class=\"n\">secs</span><span class=\"w\">    </span><span class=\"n\">fish</span><span class=\"w\">           </span><span class=\"n\">external</span>\n<span class=\"w\">   </span><span class=\"n\">usr</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\">  </span><span class=\"mf\">826.92</span><span class=\"w\"> </span><span class=\"n\">secs</span><span class=\"w\">  </span><span class=\"mf\">325.00</span><span class=\"w\"> </span><span class=\"n\">micros</span><span class=\"w\">  </span><span class=\"mf\">826.92</span><span class=\"w\"> </span><span class=\"n\">secs</span>\n<span class=\"w\">   </span><span class=\"n\">sys</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\">   </span><span class=\"mf\">49.98</span><span class=\"w\"> </span><span class=\"n\">secs</span><span class=\"w\">  </span><span class=\"mf\">135.00</span><span class=\"w\"> </span><span class=\"n\">micros</span><span class=\"w\">   </span><span class=\"mf\">49.98</span><span class=\"w\"> </span><span class=\"n\">secs</span>\n\n<span class=\"w\"> </span><span class=\"o\">~/</span><span class=\"n\">w</span><span class=\"o\">/</span><span class=\"n\">cranelift</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">many</span><span class=\"o\">-</span><span class=\"n\">rules</span><span class=\"o\">-</span><span class=\"n\">opt</span><span class=\"p\">)</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">clean</span><span class=\"w\"> </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">cranelift</span><span class=\"o\">-</span><span class=\"n\">codegen</span>\n<span class=\"n\">________________________________________________________</span>\n<span class=\"n\">Executed</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\">   </span><span class=\"mf\">69.34</span><span class=\"w\"> </span><span class=\"n\">secs</span><span class=\"w\">    </span><span class=\"n\">fish</span><span class=\"w\">           </span><span class=\"n\">external</span>\n<span class=\"w\">   </span><span class=\"n\">usr</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\">   </span><span class=\"mf\">98.32</span><span class=\"w\"> </span><span class=\"n\">secs</span><span class=\"w\">  </span><span class=\"mf\">362.00</span><span class=\"w\"> </span><span class=\"n\">micros</span><span class=\"w\">   </span><span class=\"mf\">98.32</span><span class=\"w\"> </span><span class=\"n\">secs</span>\n<span class=\"w\">   </span><span class=\"n\">sys</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\">    </span><span class=\"mf\">6.42</span><span class=\"w\"> </span><span class=\"n\">secs</span><span class=\"w\">  </span><span class=\"mf\">149.00</span><span class=\"w\"> </span><span class=\"n\">micros</span><span class=\"w\">    </span><span class=\"mf\">6.42</span><span class=\"w\"> </span><span class=\"n\">secs</span>\n</code></pre></div>\n</blockquote>",
        "id": 567094540,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767948766
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12303#issuecomment-3728001237\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12303\">PR #12303</a>:</p>\n<blockquote>\n<p>@bongjunj thanks for this experimentation!</p>\n<p>Before moving further, would you mind benchmarking compilation time as well? One of the reasons for putting all of the codegen for an ISLE term in one function is so that the compiler can optimize the code together; splitting that code between functions and (especially) introducing ABI boundaries may produce slowdowns when Cranelift runs. IMHO, it's worth it to spend a few extra seconds when compiling Cranelift if it makes Cranelift itself run faster. If no effect, of course, then no problem and I'll be happy to review this. Thanks!</p>\n</blockquote>",
        "id": 567098107,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767950212
    },
    {
        "content": "<p>github-actions[bot] <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12303#issuecomment-3728832557\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12303\">PR #12303</a>:</p>\n<blockquote>\n<h4>Subscribe to Label Action</h4>\n<p>cc @cfallin, @fitzgen</p>\n<p>&lt;details&gt;<br>\nThis issue or pull request has been labeled: \"cranelift\", \"isle\"</p>\n<p>Thus the following users have been cc'd because of the following labels:</p>\n<ul>\n<li>cfallin: isle</li>\n<li>fitzgen: isle</li>\n</ul>\n<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>\n<p><a href=\"https://github.com/bytecodealliance/subscribe-to-label-action\">Learn more.</a><br>\n&lt;/details&gt;</p>\n</blockquote>",
        "id": 567137171,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767963788
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12303#issuecomment-3729580673\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12303\">PR #12303</a>:</p>\n<blockquote>\n<p>An 11x reduction in compile time is quite massive, so even if this is a ~NN% regression in compile-time-of-wasm-code I think this would be a great thing to land at least for debug builds and maybe optionally for release builds with some sort of tunable too.</p>\n</blockquote>",
        "id": 567176492,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767974954
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12303#issuecomment-3729593374\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12303\">PR #12303</a>:</p>\n<blockquote>\n<p>Note, that's an 11x reduction with Bongjun's huge new ruleset; ~10% on <code>main</code>. That's neat but I wouldn't regress compile time for it IMHO.</p>\n</blockquote>",
        "id": 567177066,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767975078
    },
    {
        "content": "<p>fitzgen <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12303#issuecomment-3729911057\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12303\">PR #12303</a>:</p>\n<blockquote>\n<p>If it does result in Wasm compilation time regressions, it may still make sense to have this as an option of the ISLE compiler that we can enable during development or something, if we can make the maintenance burden minimal.</p>\n</blockquote>",
        "id": 567195021,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767979927
    },
    {
        "content": "<p>fitzgen submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12303#pullrequestreview-3644924393\">PR review</a>.</p>",
        "id": 567195660,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767980153
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12303#discussion_r2677041935\">PR review comment</a>:</p>\n<blockquote>\n<p>Regarding my previous comment: it could potentially make sense to make <code>MATCH_ARM_BODY_CLOSURE_THRESHOLD</code> a dynamic ISLE compilation option, rather than a constant, and then tweak that value in Cranelift's invocation of the ISLE compiler depending on if a cargo feature is enabled or whether this is a release vs debug build of Cranelift or something.</p>\n</blockquote>",
        "id": 567195661,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767980153
    },
    {
        "content": "<p>bongjunj edited <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12303\">PR #12303</a>:</p>\n<blockquote>\n<p>&lt;!--<br>\nPlease make sure you include the following information:</p>\n<ul>\n<li>\n<p>If this work has been discussed elsewhere, please include a link to that<br>\n  conversation. If it was discussed in an issue, just mention \"issue #...\".</p>\n</li>\n<li>\n<p>Explain why this change is needed. If the details are in an issue already,<br>\n  this can be brief.</p>\n</li>\n</ul>\n<p>Our development process is documented in the Wasmtime book:<br>\n<a href=\"https://docs.wasmtime.dev/contributing-development-process.html\">https://docs.wasmtime.dev/contributing-development-process.html</a></p>\n<p>Please ensure all communication follows the code of conduct:<br>\n<a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md\">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>\n--&gt;</p>\n<h2>Overview</h2>\n<p>The current implementation of ISLE code generation emits a single Rust function for each ISLE term, and <code>rustc</code> compiles the Rust code to integrate ISLE with other modules of Cranelift.</p>\n<p>This can cause a compilation bottleneck when a ISLE term contains numerous rules ending up with producing a very very large Rust function, since <code>rustc</code> cannot efficiently compile such functions. Notably, the term <code>simplify</code> which implements the mid-end peephole optimizations has about 500 rules, and the symptom is already visible. (And the ruleset is growing!) You can check, compiling Cranelift, <code>cranelift-codegen</code> takes most of the time in the following report: <a href=\"https://github.com/user-attachments/files/24522422/cargo-timing.html\">cargo-timing.html</a></p>\n<p>Plus: a timing report for compiling wasmtime: </p>\n<p>With this PR, the ISLE codegen helps <code>rustc</code> by wrapping a large match statement generated by <code>islec</code> in a closure. By introducing closures, a portion of a huge Rust function (for a ISLE term) can be split into several smaller compilation units for <code>rustc</code>, reducing the compilation time.</p>\n<h2>Evaluation</h2>\n<p>On the <code>main</code> branch, the build times for <code>cranelift-codegen</code> before/after this optimization are measured. This PR saves ~2 seconds on my machine (x86-64, 64 core, 512GB memory)</p>\n<ul>\n<li>After: 23.81 sec</li>\n</ul>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"o\">~/</span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">optimize</span><span class=\"o\">-</span><span class=\"n\">isle</span><span class=\"o\">-</span><span class=\"n\">compilation</span><span class=\"p\">)</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">clean</span>\n<span class=\"w\">     </span><span class=\"n\">Removed</span><span class=\"w\"> </span><span class=\"mi\">10031</span><span class=\"w\"> </span><span class=\"n\">files</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mf\">12.6</span><span class=\"n\">GiB</span><span class=\"w\"> </span><span class=\"n\">total</span>\n<span class=\"o\">~/</span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">optimize</span><span class=\"o\">-</span><span class=\"n\">isle</span><span class=\"o\">-</span><span class=\"n\">compilation</span><span class=\"p\">)</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">cranelift</span><span class=\"o\">-</span><span class=\"n\">codegen</span>\n\n<span class=\"n\">________________________________________________________</span>\n<span class=\"n\">Executed</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\">   </span><span class=\"mf\">23.81</span><span class=\"w\"> </span><span class=\"n\">secs</span><span class=\"w\">    </span><span class=\"n\">fish</span><span class=\"w\">           </span><span class=\"n\">external</span>\n<span class=\"w\">   </span><span class=\"n\">usr</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\">   </span><span class=\"mf\">43.59</span><span class=\"w\"> </span><span class=\"n\">secs</span><span class=\"w\">    </span><span class=\"mf\">0.00</span><span class=\"w\"> </span><span class=\"n\">micros</span><span class=\"w\">   </span><span class=\"mf\">43.59</span><span class=\"w\"> </span><span class=\"n\">secs</span>\n<span class=\"w\">   </span><span class=\"n\">sys</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\">    </span><span class=\"mf\">5.04</span><span class=\"w\"> </span><span class=\"n\">secs</span><span class=\"w\">  </span><span class=\"mf\">592.00</span><span class=\"w\"> </span><span class=\"n\">micros</span><span class=\"w\">    </span><span class=\"mf\">5.04</span><span class=\"w\"> </span><span class=\"n\">secs</span>\n</code></pre></div>\n<ul>\n<li>Before: 26.04 sec</li>\n</ul>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"o\">~/</span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"n\">dev</span><span class=\"p\">))</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">clean</span>\n<span class=\"n\">t</span><span class=\"w\">     </span><span class=\"n\">Removed</span><span class=\"w\"> </span><span class=\"mi\">1356</span><span class=\"w\"> </span><span class=\"n\">files</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mf\">1.0</span><span class=\"n\">GiB</span><span class=\"w\"> </span><span class=\"n\">total</span>\n<span class=\"o\">~/</span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"n\">dev</span><span class=\"p\">))</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">cranelift</span><span class=\"o\">-</span><span class=\"n\">codegen</span>\n\n<span class=\"n\">________________________________________________________</span>\n<span class=\"n\">Executed</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\">   </span><span class=\"mf\">26.04</span><span class=\"w\"> </span><span class=\"n\">secs</span><span class=\"w\">    </span><span class=\"n\">fish</span><span class=\"w\">           </span><span class=\"n\">external</span>\n<span class=\"w\">   </span><span class=\"n\">usr</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\">   </span><span class=\"mf\">46.58</span><span class=\"w\"> </span><span class=\"n\">secs</span><span class=\"w\">    </span><span class=\"mf\">0.00</span><span class=\"w\"> </span><span class=\"n\">micros</span><span class=\"w\">   </span><span class=\"mf\">46.58</span><span class=\"w\"> </span><span class=\"n\">secs</span>\n<span class=\"w\">   </span><span class=\"n\">sys</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\">    </span><span class=\"mf\">5.15</span><span class=\"w\"> </span><span class=\"n\">secs</span><span class=\"w\">  </span><span class=\"mf\">583.00</span><span class=\"w\"> </span><span class=\"n\">micros</span><span class=\"w\">    </span><span class=\"mf\">5.15</span><span class=\"w\"> </span><span class=\"n\">secs</span>\n</code></pre></div>\n<ul>\n<li>Cargo Timing Reports<ul>\n<li>Before: <a href=\"https://github.com/user-attachments/files/24523107/cargo-timing-old.html\">cargo-timing-old.html</a></li>\n<li>After: <a href=\"https://github.com/user-attachments/files/24523109/cargo-timing-new.html\">cargo-timing-new.html</a></li>\n</ul>\n</li>\n</ul>\n<h2>Extra</h2>\n<p>I am experimenting with over 6,000 ISLE <code>simplify</code> rules.<br>\nThe compilation time reduced from 841.37 seconds to 69.34 seconds with this PR. (+11x speedup)</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"o\">~/</span><span class=\"n\">w</span><span class=\"o\">/</span><span class=\"n\">cranelift</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"n\">many</span><span class=\"o\">-</span><span class=\"n\">rules</span><span class=\"o\">-</span><span class=\"n\">no</span><span class=\"o\">-</span><span class=\"n\">opt</span><span class=\"p\">))</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">clean</span><span class=\"w\"> </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">cranelift</span><span class=\"o\">-</span><span class=\"n\">codegen</span>\n<span class=\"n\">________________________________________________________</span>\n<span class=\"n\">Executed</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\">  </span><span class=\"mf\">841.37</span><span class=\"w\"> </span><span class=\"n\">secs</span><span class=\"w\">    </span><span class=\"n\">fish</span><span class=\"w\">           </span><span class=\"n\">external</span>\n<span class=\"w\">   </span><span class=\"n\">usr</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\">  </span><span class=\"mf\">826.92</span><span class=\"w\"> </span><span class=\"n\">secs</span><span class=\"w\">  </span><span class=\"mf\">325.00</span><span class=\"w\"> </span><span class=\"n\">micros</span><span class=\"w\">  </span><span class=\"mf\">826.92</span><span class=\"w\"> </span><span class=\"n\">secs</span>\n<span class=\"w\">   </span><span class=\"n\">sys</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\">   </span><span class=\"mf\">49.98</span><span class=\"w\"> </span><span class=\"n\">secs</span><span class=\"w\">  </span><span class=\"mf\">135.00</span><span class=\"w\"> </span><span class=\"n\">micros</span><span class=\"w\">   </span><span class=\"mf\">49.98</span><span class=\"w\"> </span><span class=\"n\">secs</span>\n\n<span class=\"w\"> </span><span class=\"o\">~/</span><span class=\"n\">w</span><span class=\"o\">/</span><span class=\"n\">cranelift</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">many</span><span class=\"o\">-</span><span class=\"n\">rules</span><span class=\"o\">-</span><span class=\"n\">opt</span><span class=\"p\">)</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">clean</span><span class=\"w\"> </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">cranelift</span><span class=\"o\">-</span><span class=\"n\">codegen</span>\n<span class=\"n\">________________________________________________________</span>\n<span class=\"n\">Executed</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\">   </span><span class=\"mf\">69.34</span><span class=\"w\"> </span><span class=\"n\">secs</span><span class=\"w\">    </span><span class=\"n\">fish</span><span class=\"w\">           </span><span class=\"n\">external</span>\n<span class=\"w\">   </span><span class=\"n\">usr</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\">   </span><span class=\"mf\">98.32</span><span class=\"w\"> </span><span class=\"n\">secs</span><span class=\"w\">  </span><span class=\"mf\">362.00</span><span class=\"w\"> </span><span class=\"n\">micros</span><span class=\"w\">   </span><span class=\"mf\">98.32</span><span class=\"w\"> </span><span class=\"n\">secs</span>\n<span class=\"w\">   </span><span class=\"n\">sys</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\">    </span><span class=\"mf\">6.42</span><span class=\"w\"> </span><span class=\"n\">secs</span><span class=\"w\">  </span><span class=\"mf\">149.00</span><span class=\"w\"> </span><span class=\"n\">micros</span><span class=\"w\">    </span><span class=\"mf\">6.42</span><span class=\"w\"> </span><span class=\"n\">secs</span>\n</code></pre></div>\n</blockquote>",
        "id": 567431387,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768183354
    },
    {
        "content": "<p>bongjunj edited <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12303\">PR #12303</a>:</p>\n<blockquote>\n<p>&lt;!--<br>\nPlease make sure you include the following information:</p>\n<ul>\n<li>\n<p>If this work has been discussed elsewhere, please include a link to that<br>\n  conversation. If it was discussed in an issue, just mention \"issue #...\".</p>\n</li>\n<li>\n<p>Explain why this change is needed. If the details are in an issue already,<br>\n  this can be brief.</p>\n</li>\n</ul>\n<p>Our development process is documented in the Wasmtime book:<br>\n<a href=\"https://docs.wasmtime.dev/contributing-development-process.html\">https://docs.wasmtime.dev/contributing-development-process.html</a></p>\n<p>Please ensure all communication follows the code of conduct:<br>\n<a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md\">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>\n--&gt;</p>\n<h2>Overview</h2>\n<p>The current implementation of ISLE code generation emits a single Rust function for each ISLE term, and <code>rustc</code> compiles the Rust code to integrate ISLE with other modules of Cranelift.</p>\n<p>This can cause a compilation bottleneck when a ISLE term contains numerous rules ending up with producing a very very large Rust function, since <code>rustc</code> cannot efficiently compile such functions. Notably, the term <code>simplify</code> which implements the mid-end peephole optimizations has about 500 rules, and the symptom is already visible. (And the ruleset is growing!) You can check, compiling Cranelift, <code>cranelift-codegen</code> takes most of the time in the following report: <a href=\"https://github.com/user-attachments/files/24522422/cargo-timing.html\">cargo-timing.html</a></p>\n<p>With this PR, the ISLE codegen helps <code>rustc</code> by wrapping a large match statement generated by <code>islec</code> in a closure. By introducing closures, a portion of a huge Rust function (for a ISLE term) can be split into several smaller compilation units for <code>rustc</code>, reducing the compilation time.</p>\n<h2>Evaluation</h2>\n<p>On the <code>main</code> branch, the build times for <code>cranelift-codegen</code> before/after this optimization are measured. This PR saves ~2 seconds on my machine (x86-64, 64 core, 512GB memory)</p>\n<ul>\n<li>After: 23.81 sec</li>\n</ul>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"o\">~/</span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">optimize</span><span class=\"o\">-</span><span class=\"n\">isle</span><span class=\"o\">-</span><span class=\"n\">compilation</span><span class=\"p\">)</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">clean</span>\n<span class=\"w\">     </span><span class=\"n\">Removed</span><span class=\"w\"> </span><span class=\"mi\">10031</span><span class=\"w\"> </span><span class=\"n\">files</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mf\">12.6</span><span class=\"n\">GiB</span><span class=\"w\"> </span><span class=\"n\">total</span>\n<span class=\"o\">~/</span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">optimize</span><span class=\"o\">-</span><span class=\"n\">isle</span><span class=\"o\">-</span><span class=\"n\">compilation</span><span class=\"p\">)</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">cranelift</span><span class=\"o\">-</span><span class=\"n\">codegen</span>\n\n<span class=\"n\">________________________________________________________</span>\n<span class=\"n\">Executed</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\">   </span><span class=\"mf\">23.81</span><span class=\"w\"> </span><span class=\"n\">secs</span><span class=\"w\">    </span><span class=\"n\">fish</span><span class=\"w\">           </span><span class=\"n\">external</span>\n<span class=\"w\">   </span><span class=\"n\">usr</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\">   </span><span class=\"mf\">43.59</span><span class=\"w\"> </span><span class=\"n\">secs</span><span class=\"w\">    </span><span class=\"mf\">0.00</span><span class=\"w\"> </span><span class=\"n\">micros</span><span class=\"w\">   </span><span class=\"mf\">43.59</span><span class=\"w\"> </span><span class=\"n\">secs</span>\n<span class=\"w\">   </span><span class=\"n\">sys</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\">    </span><span class=\"mf\">5.04</span><span class=\"w\"> </span><span class=\"n\">secs</span><span class=\"w\">  </span><span class=\"mf\">592.00</span><span class=\"w\"> </span><span class=\"n\">micros</span><span class=\"w\">    </span><span class=\"mf\">5.04</span><span class=\"w\"> </span><span class=\"n\">secs</span>\n</code></pre></div>\n<ul>\n<li>Before: 26.04 sec</li>\n</ul>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"o\">~/</span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"n\">dev</span><span class=\"p\">))</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">clean</span>\n<span class=\"n\">t</span><span class=\"w\">     </span><span class=\"n\">Removed</span><span class=\"w\"> </span><span class=\"mi\">1356</span><span class=\"w\"> </span><span class=\"n\">files</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mf\">1.0</span><span class=\"n\">GiB</span><span class=\"w\"> </span><span class=\"n\">total</span>\n<span class=\"o\">~/</span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"n\">dev</span><span class=\"p\">))</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">cranelift</span><span class=\"o\">-</span><span class=\"n\">codegen</span>\n\n<span class=\"n\">________________________________________________________</span>\n<span class=\"n\">Executed</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\">   </span><span class=\"mf\">26.04</span><span class=\"w\"> </span><span class=\"n\">secs</span><span class=\"w\">    </span><span class=\"n\">fish</span><span class=\"w\">           </span><span class=\"n\">external</span>\n<span class=\"w\">   </span><span class=\"n\">usr</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\">   </span><span class=\"mf\">46.58</span><span class=\"w\"> </span><span class=\"n\">secs</span><span class=\"w\">    </span><span class=\"mf\">0.00</span><span class=\"w\"> </span><span class=\"n\">micros</span><span class=\"w\">   </span><span class=\"mf\">46.58</span><span class=\"w\"> </span><span class=\"n\">secs</span>\n<span class=\"w\">   </span><span class=\"n\">sys</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\">    </span><span class=\"mf\">5.15</span><span class=\"w\"> </span><span class=\"n\">secs</span><span class=\"w\">  </span><span class=\"mf\">583.00</span><span class=\"w\"> </span><span class=\"n\">micros</span><span class=\"w\">    </span><span class=\"mf\">5.15</span><span class=\"w\"> </span><span class=\"n\">secs</span>\n</code></pre></div>\n<ul>\n<li>Cargo Timing Reports<ul>\n<li>Before: <a href=\"https://github.com/user-attachments/files/24523107/cargo-timing-old.html\">cargo-timing-old.html</a></li>\n<li>After: <a href=\"https://github.com/user-attachments/files/24523109/cargo-timing-new.html\">cargo-timing-new.html</a></li>\n</ul>\n</li>\n</ul>\n<h2>Extra</h2>\n<p>I am experimenting with over 6,000 ISLE <code>simplify</code> rules.<br>\nThe compilation time reduced from 841.37 seconds to 69.34 seconds with this PR. (+11x speedup)</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"o\">~/</span><span class=\"n\">w</span><span class=\"o\">/</span><span class=\"n\">cranelift</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"n\">many</span><span class=\"o\">-</span><span class=\"n\">rules</span><span class=\"o\">-</span><span class=\"n\">no</span><span class=\"o\">-</span><span class=\"n\">opt</span><span class=\"p\">))</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">clean</span><span class=\"w\"> </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">cranelift</span><span class=\"o\">-</span><span class=\"n\">codegen</span>\n<span class=\"n\">________________________________________________________</span>\n<span class=\"n\">Executed</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\">  </span><span class=\"mf\">841.37</span><span class=\"w\"> </span><span class=\"n\">secs</span><span class=\"w\">    </span><span class=\"n\">fish</span><span class=\"w\">           </span><span class=\"n\">external</span>\n<span class=\"w\">   </span><span class=\"n\">usr</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\">  </span><span class=\"mf\">826.92</span><span class=\"w\"> </span><span class=\"n\">secs</span><span class=\"w\">  </span><span class=\"mf\">325.00</span><span class=\"w\"> </span><span class=\"n\">micros</span><span class=\"w\">  </span><span class=\"mf\">826.92</span><span class=\"w\"> </span><span class=\"n\">secs</span>\n<span class=\"w\">   </span><span class=\"n\">sys</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\">   </span><span class=\"mf\">49.98</span><span class=\"w\"> </span><span class=\"n\">secs</span><span class=\"w\">  </span><span class=\"mf\">135.00</span><span class=\"w\"> </span><span class=\"n\">micros</span><span class=\"w\">   </span><span class=\"mf\">49.98</span><span class=\"w\"> </span><span class=\"n\">secs</span>\n\n<span class=\"w\"> </span><span class=\"o\">~/</span><span class=\"n\">w</span><span class=\"o\">/</span><span class=\"n\">cranelift</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">many</span><span class=\"o\">-</span><span class=\"n\">rules</span><span class=\"o\">-</span><span class=\"n\">opt</span><span class=\"p\">)</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">clean</span><span class=\"w\"> </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">cranelift</span><span class=\"o\">-</span><span class=\"n\">codegen</span>\n<span class=\"n\">________________________________________________________</span>\n<span class=\"n\">Executed</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\">   </span><span class=\"mf\">69.34</span><span class=\"w\"> </span><span class=\"n\">secs</span><span class=\"w\">    </span><span class=\"n\">fish</span><span class=\"w\">           </span><span class=\"n\">external</span>\n<span class=\"w\">   </span><span class=\"n\">usr</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\">   </span><span class=\"mf\">98.32</span><span class=\"w\"> </span><span class=\"n\">secs</span><span class=\"w\">  </span><span class=\"mf\">362.00</span><span class=\"w\"> </span><span class=\"n\">micros</span><span class=\"w\">   </span><span class=\"mf\">98.32</span><span class=\"w\"> </span><span class=\"n\">secs</span>\n<span class=\"w\">   </span><span class=\"n\">sys</span><span class=\"w\"> </span><span class=\"n\">time</span><span class=\"w\">    </span><span class=\"mf\">6.42</span><span class=\"w\"> </span><span class=\"n\">secs</span><span class=\"w\">  </span><span class=\"mf\">149.00</span><span class=\"w\"> </span><span class=\"n\">micros</span><span class=\"w\">    </span><span class=\"mf\">6.42</span><span class=\"w\"> </span><span class=\"n\">secs</span>\n</code></pre></div>\n</blockquote>",
        "id": 567438286,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768191948
    },
    {
        "content": "<p>bongjunj <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12303#issuecomment-3736895588\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12303\">PR #12303</a>:</p>\n<blockquote>\n<p>@cfallin </p>\n<p>Thanks for the comment! I've ran the benchmarks and measure the compilation time.<br>\nIt turned out that the compilation overhead is almost next to zero.<br>\nThis is probably because it introduces closures only for large pattern matches.<br>\nThe raw data (for 10 iterations -- default setting of sightglass-cli) is as below:</p>\n<table>\n<thead>\n<tr>\n<th>bench</th>\n<th>optimize-isle-compilation</th>\n<th>main</th>\n<th>overhead</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>bz2</td>\n<td>273,462,445</td>\n<td>271,631,283</td>\n<td>0.67%</td>\n</tr>\n<tr>\n<td>pulldown-cmark</td>\n<td>623,480,512</td>\n<td>622,976,525</td>\n<td>0.08%</td>\n</tr>\n<tr>\n<td>spidermonkey</td>\n<td>21,592,595,980</td>\n<td>21,523,101,083</td>\n<td>0.32%</td>\n</tr>\n</tbody>\n</table>\n</blockquote>",
        "id": 567442666,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768194277
    },
    {
        "content": "<p>bongjunj submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12303#pullrequestreview-3649193466\">PR review</a>.</p>",
        "id": 567443008,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768194671
    },
    {
        "content": "<p>bongjunj created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12303#discussion_r2680890907\">PR review comment</a>:</p>\n<blockquote>\n<p>FYI I experimented three values for this: 128, 256, 512.<br>\nThe best one was 256 for the current ruleset (~500 rules), and 512 for my massive ruleset (~6,700 rules).<br>\nThere could be some relation between threshold value and the ruleset size. Additionally, the parallelism available of the development environment could affect too.</p>\n<p>However, as this could affect the quality of the compiled cranelift, I assumed at first sticking to the best value was a good idea.  </p>\n</blockquote>",
        "id": 567443009,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768194672
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12303#issuecomment-3770564582\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12303\">PR #12303</a>:</p>\n<blockquote>\n<p>Sorry for the delayed response here -- was traveling then lost track of this PR.</p>\n<p>Thanks for the experiments! I think I agree with Nick that this would be good to have as an option, probably off by default. 0.67% compile time is still an unfortunate regression to take (on the flip side, 1% speedups make us pretty happy and take work to find), and is more important than the time taken to compile Cranelift, since usually you compile Cranelift once then use that compiled Cranelift-containing program many times. But when developing Cranelift, it would be useful to have this option.</p>\n<p>Could you put this under a Cargo feature that alters the behavior of <code>islec</code> as invoked by <code>cranelift-codegen</code>'s <code>build.rs</code>?</p>\n</blockquote>",
        "id": 568924652,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768869867
    },
    {
        "content": "<p>cfallin edited a <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12303#issuecomment-3770564582\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12303\">PR #12303</a>:</p>\n<blockquote>\n<p>Sorry for the delayed response here -- was traveling then lost track of this PR.</p>\n<p>Thanks for the experiments! I think I agree with Nick that this would be good to have as an option, probably off by default. 0.67% compile time is still an unfortunate regression to take (on the flip side, 1% speedups make us pretty happy and take work to find), and is (usually) more important than the time taken to compile Cranelift, since usually you compile Cranelift once then use that compiled Cranelift-containing program many times. But when developing Cranelift, it would be useful to have this option.</p>\n<p>Could you put this under a Cargo feature that alters the behavior of <code>islec</code> as invoked by <code>cranelift-codegen</code>'s <code>build.rs</code>?</p>\n</blockquote>",
        "id": 568924686,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768869895
    },
    {
        "content": "<p>bongjunj <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12303#issuecomment-3777401331\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12303\">PR #12303</a>:</p>\n<blockquote>\n<p>@cfallin thanks for the comment!<br>\nI think I could handle this until this weekend. Will mention you when I finish the feature.</p>\n<p>Thank you.</p>\n</blockquote>",
        "id": 569221308,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768992160
    },
    {
        "content": "<p>bongjunj updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12303\">PR #12303</a>.</p>",
        "id": 570229610,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769485299
    },
    {
        "content": "<p>bongjunj updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12303\">PR #12303</a>.</p>",
        "id": 570232042,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769487319
    },
    {
        "content": "<p>bongjunj updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12303\">PR #12303</a>.</p>",
        "id": 570232447,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769487653
    },
    {
        "content": "<p>bongjunj <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12303#issuecomment-3803028826\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12303\">PR #12303</a>:</p>\n<blockquote>\n<p>@cfallin This is now wrapped under a Cargo feature <code>isle-split-match</code> on the crate <code>cranelift-codegen</code>.</p>\n<p>@fitzgen Now we have a controllable splitting threshold, via setting an environment variable: <code>ISLE_SPLIT_MATCH_THRESHOLD=512</code></p>\n</blockquote>",
        "id": 570232583,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769487747
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12303#pullrequestreview-3712261670\">PR review</a>:</p>\n<blockquote>\n<p>LGTM -- thanks very much for the patience here!</p>\n</blockquote>",
        "id": 570369443,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769531976
    },
    {
        "content": "<p>cfallin added <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12303\">PR #12303 Optimize ISLE compilation</a> to the merge queue.</p>",
        "id": 570369508,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769531990
    },
    {
        "content": "<p>cfallin merged <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12303\">PR #12303</a>.</p>",
        "id": 570376238,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769533714
    },
    {
        "content": "<p>cfallin removed <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12303\">PR #12303 Optimize ISLE compilation</a> from the merge queue.</p>",
        "id": 570376240,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769533714
    }
]
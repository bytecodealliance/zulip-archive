[
    {
        "content": "<p><a href=\"https://github.com/vouillon\">vouillon</a> added the bug label to <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10181\">Issue #10181</a>.</p>",
        "id": 497669714,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1738676884
    },
    {
        "content": "<p>vouillon opened <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10181\">issue #10181</a>:</p>\n<blockquote>\n<h3>Test Case</h3>\n<p><a href=\"https://github.com/user-attachments/files/18657925/constprop.zip\">constprop.zip</a></p>\n<h3>Steps to Reproduce</h3>\n<p>Run the following command:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">target</span><span class=\"o\">/</span><span class=\"n\">debug</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"w\">  </span><span class=\"o\">-</span><span class=\"n\">W</span><span class=\"o\">=</span><span class=\"n\">all</span><span class=\"o\">-</span><span class=\"n\">proposals</span><span class=\"o\">=</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"n\">constprop</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n</code></pre></div>\n<h3>Expected Results</h3>\n<p>This works fine if one add the <code>-C collector=null</code> option:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">target</span><span class=\"o\">/</span><span class=\"n\">debug</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">C</span><span class=\"w\"> </span><span class=\"n\">collector</span><span class=\"o\">=</span><span class=\"n\">null</span><span class=\"w\">  </span><span class=\"o\">-</span><span class=\"n\">W</span><span class=\"o\">=</span><span class=\"n\">all</span><span class=\"o\">-</span><span class=\"n\">proposals</span><span class=\"o\">=</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"n\">constprop</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n<span class=\"n\">booleans</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">passed</span>\n<span class=\"n\">integers</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">passed</span>\n<span class=\"n\">floats</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">passed</span>\n<span class=\"mi\">32</span><span class=\"o\">-</span><span class=\"n\">bit</span><span class=\"w\"> </span><span class=\"n\">integers</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">passed</span>\n<span class=\"n\">native</span><span class=\"w\"> </span><span class=\"n\">integers</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">passed</span>\n<span class=\"mi\">64</span><span class=\"o\">-</span><span class=\"n\">bit</span><span class=\"w\"> </span><span class=\"n\">integers</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">passed</span>\n<span class=\"n\">integer</span><span class=\"w\"> </span><span class=\"n\">conversions</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">passed</span>\n<span class=\"mi\">32</span><span class=\"o\">-</span><span class=\"n\">bit</span><span class=\"w\"> </span><span class=\"n\">integer</span><span class=\"w\"> </span><span class=\"n\">conversions</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">passed</span>\n<span class=\"n\">native</span><span class=\"w\"> </span><span class=\"n\">integer</span><span class=\"w\"> </span><span class=\"n\">conversions</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">passed</span>\n<span class=\"mi\">64</span><span class=\"o\">-</span><span class=\"n\">bit</span><span class=\"w\"> </span><span class=\"n\">integer</span><span class=\"w\"> </span><span class=\"n\">conversions</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">passed</span>\n</code></pre></div>\n<h3>Actual Results</h3>\n<p>This crashes with an <code>Illegal instruction</code> error.</p>\n<h3>Versions and Environment</h3>\n<p>Wasmtime commit: 0e0560087beff704bc111a1abb1d6a80c1b5da70</p>\n<p>Operating system: Linux</p>\n<p>Architecture: x64<br>\n</p>\n</blockquote>",
        "id": 497669719,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1738676886
    },
    {
        "content": "<p>alexcrichton assigned afonso360 to <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10181\">issue #10181</a>.</p>",
        "id": 497672093,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1738677515
    },
    {
        "content": "<p>alexcrichton assigned fitzgen to <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10181\">issue #10181</a>.</p>",
        "id": 497672096,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1738677515
    },
    {
        "content": "<p>alexcrichton unassigned afonso360 from <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10181\">issue #10181</a>.</p>",
        "id": 497672122,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1738677521
    },
    {
        "content": "<p>fitzgen <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10181#issuecomment-2634556893\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10181\">issue #10181</a>:</p>\n<blockquote>\n<p>Thanks for the bug report!</p>\n<p>If you have time, minimizing the test case <code>wat</code> with <code>creduce</code> would be very appreciated and make diagnosing and fixing this easier. If not, I'll get around to that eventually.</p>\n</blockquote>",
        "id": 497714404,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1738688442
    },
    {
        "content": "<p><a href=\"https://github.com/fitzgen\">fitzgen</a> added the wasm-proposal:gc label to <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10181\">Issue #10181</a>.</p>",
        "id": 497714843,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1738688559
    },
    {
        "content": "<p>just-an-engineer <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10181#issuecomment-2634713961\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10181\">issue #10181</a>:</p>\n<blockquote>\n<p>I'll take this.<br>\nAfter some initial looking, it has to do with the async stuff, I'm guessing it pops the wrong address somehow.</p>\n</blockquote>",
        "id": 497727795,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1738692622
    },
    {
        "content": "<p>just-an-engineer <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10181#issuecomment-2634801367\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10181\">issue #10181</a>:</p>\n<blockquote>\n<p>Where is this wasm file from, and how did you compile it?<br>\nI suspect it may be from an invalid wasm file, which the code _should_ check for currently, but doesn't seem to. Running <code>wasm-validate</code> on it gives me an error of invalid type a few bytes in, but I imagine that tools stops after the first error, so no idea how many more.<br>\nAnyways, it could be that there's some invalid stuff here that operates outside of the specification, that leds to an incorrect address being jumped to during the async execution stuffs.</p>\n</blockquote>",
        "id": 497734647,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1738695170
    },
    {
        "content": "<p>vouillon <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10181#issuecomment-2635007625\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10181\">issue #10181</a>:</p>\n<blockquote>\n<p>This code relies on the Wasm GC proposal. This proposal is not supported by <code>wasm-validate</code>. That's why you get errors.<br>\nThe code is generated using <a href=\"https://github.com/ocsigen/js_of_ocaml/blob/7c6c20949ebff14ba0d069ba1b5ff99a0f3be434/README_wasm_of_ocaml.md\">wasm_of_ocaml</a>, which compiles OCaml code to Wam.<br>\nThe <a href=\"https://github.com/ocsigen/js_of_ocaml/blob/7c6c20949ebff14ba0d069ba1b5ff99a0f3be434/compiler/tests-ocaml/basic/constprop.ml.c\">source code</a> comes from the OCaml test suite, so it is a bit weird.<br>\n<code>wasm-opt</code> from the binaryen toolchain is used to optimize the code. And the code runs fine in <code>node</code>. So I'm quite confident regarding its validity.<br>\n</p>\n</blockquote>",
        "id": 497751452,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1738701240
    },
    {
        "content": "<p>fitzgen <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10181#issuecomment-2635172664\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10181\">issue #10181</a>:</p>\n<blockquote>\n<p>@just-an-engineer </p>\n<blockquote>\n<p>I'll take this.</p>\n</blockquote>\n<p>You're definitely welcome to investigate this bug, but this isn't likely the best good-first-issue kind of bug if you aren't already somewhat familiar with Wasmtime and Cranelift.</p>\n<p>What would be super helpful whether you continue to investigate this bug or leave it for someone else would be to run <code>creduce</code> on the <code>.wat</code> disassembly of the test case and reduce it to a minimal example that triggers the illegal instruction fault. This would involve something like:</p>\n<ul>\n<li><code>wasm-tools wasm2wat test.wasm -o test.wat</code></li>\n<li>\n<p>Writing a <code>predicate.sh</code> that does something like<br>\n<code>sh\n  #!/usr/bin/env bash\n  set -eu\n  cargo run --manifest-path ~/path/to/wasmtime/Cargo.toml -- \\\n      -C collector=null -W=all-proposals=y \\\n      test.wat \\\n      2&gt;&amp;1 | grep -q 'Illegal instruction'\n  </code><br>\n  (Note: the above is untested, you would want to make sure that it exits <code>1</code> if <code>test.wasm</code> doesn't trigger the illegal instruction and <code>0</code> if it does trigger the illegal instruction.)</p>\n</li>\n<li>\n<p>And finally run <code>creduce</code> something like<br>\n<code>\n  creduce --not-c predicate.sh test.wat\n  </code></p>\n</li>\n</ul>\n<p>And when <code>creduce</code> is finished, post the reduced test case here.</p>\n<blockquote>\n<p>I suspect it may be from an invalid wasm file</p>\n</blockquote>\n<p>Wasmtime always validates the Wasm as part of its process of translating it to Cranelift's IR (called CLIF) so, barring validator bugs, we should never actually execute any invalid Wasm file.</p>\n</blockquote>",
        "id": 497765079,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1738706564
    },
    {
        "content": "<p>vouillon <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10181#issuecomment-2642608130\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10181\">issue #10181</a>:</p>\n<blockquote>\n<p>I have used <code>wasm-reduce</code> (from the Binaryen toolchain) and <code>creduce</code>, plus some manual rewriting, to reduce the size of the code. It remains a bit large, probably because one needs a specific allocation pattern to trigger the bug. In particular, there is a global array which is not used anywhere, and some values that are dropped right after being allocated.<br>\nA circular datastructure is built using <code>struct.set</code>. Maybe this confuses the GC? I don't see anything else suspicious.<br>\n<a href=\"https://github.com/user-attachments/files/18705401/constprop.wat.txt\">constprop.wat.txt</a></p>\n</blockquote>",
        "id": 498314120,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1738926403
    },
    {
        "content": "<p>tanishiking <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10181#issuecomment-2665004815\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10181\">issue #10181</a>:</p>\n<blockquote>\n<p>We encountered an \"Illegal Instruction\" error in our project (<a href=\"https://github.com/scala-wasm/scala-wasm/pull/5\">scala-wasm</a> fork of Scala.js to support wasm component model).</p>\n<p>I'm not sure if this is the only case, but the error occurs at least when we try to set an <code>i31</code> value (converted from i32 with the MSB has 1) to an <code>anyref</code> struct field.</p>\n<div class=\"codehilite\" data-code-language=\"WebAssembly\"><pre><span></span><code><span class=\"p\">(</span><span class=\"k\">module</span>\n  <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"nv\">$c.scala.Tuple1</span> <span class=\"p\">(</span><span class=\"err\">sub</span> <span class=\"p\">(</span><span class=\"err\">struct</span>\n    <span class=\"p\">(</span><span class=\"err\">field</span> <span class=\"nv\">$f.scala.Tuple1._1</span> <span class=\"p\">(</span><span class=\"k\">mut</span> <span class=\"err\">anyref</span><span class=\"p\">)))))</span>\n\n  <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"p\">(</span><span class=\"k\">export</span> <span class=\"s2\">\"test\"</span><span class=\"p\">)</span>\n    <span class=\"p\">(</span><span class=\"k\">local</span> <span class=\"nv\">$instance</span> <span class=\"p\">(</span><span class=\"err\">ref</span> <span class=\"nv\">$c.scala.Tuple1</span><span class=\"p\">))</span>\n    <span class=\"nb\">i32.const</span> <span class=\"mi\">-2</span>\n    <span class=\"err\">ref.i</span><span class=\"mi\">31</span>\n    <span class=\"err\">struct.new</span> <span class=\"nv\">$c.scala.Tuple1</span>\n    <span class=\"nb\">drop</span>\n  <span class=\"p\">)</span>\n<span class=\"p\">)</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>$<span class=\"w\"> </span>wasm-tools<span class=\"w\"> </span>parse<span class=\"w\"> </span>test.wat<span class=\"w\"> </span>-o<span class=\"w\"> </span>test.wasm\n$<span class=\"w\"> </span>wasmtime<span class=\"w\"> </span>run<span class=\"w\"> </span>-W<span class=\"w\"> </span><span class=\"k\">function</span>-references,gc<span class=\"w\"> </span>--invoke<span class=\"w\"> </span><span class=\"nb\">test</span><span class=\"w\"> </span>test.wasm\nmake:<span class=\"w\"> </span>***<span class=\"w\"> </span><span class=\"o\">[</span>run<span class=\"o\">]</span><span class=\"w\"> </span>Illegal<span class=\"w\"> </span>instruction:<span class=\"w\"> </span><span class=\"m\">4</span>\n</code></pre></div>\n<p>see: <a href=\"https://github.com/tanishiking/kitchensink/tree/main/wasmtime-illegal-instruction\">https://github.com/tanishiking/kitchensink/tree/main/wasmtime-illegal-instruction</a></p>\n<p>As @vouillon mentioned, the problem doesn't happen when using the <code>-C collector=null</code> option.</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">version</span>\n<span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"mf\">29.0.1</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">58282</span><span class=\"n\">df89</span><span class=\"w\"> </span><span class=\"mi\">2025</span><span class=\"o\">-</span><span class=\"mi\">01</span><span class=\"o\">-</span><span class=\"mi\">21</span><span class=\"p\">)</span>\n</code></pre></div>\n</blockquote>",
        "id": 500350026,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1739869482
    },
    {
        "content": "<p>tanishiking edited a <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10181#issuecomment-2665004815\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10181\">issue #10181</a>:</p>\n<blockquote>\n<p>We encountered an \"Illegal Instruction\" error in our project (<a href=\"https://github.com/scala-wasm/scala-wasm/pull/5\">scala-wasm</a> fork of Scala.js to support wasm component model).</p>\n<p>I'm not sure if this is the only case, but the error occurs at least when we try to set an <code>i31</code> value (converted from i32 with the MSB has 1) to an <code>anyref</code> struct field.</p>\n<div class=\"codehilite\" data-code-language=\"WebAssembly\"><pre><span></span><code><span class=\"p\">(</span><span class=\"k\">module</span>\n  <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"nv\">$c.scala.Tuple1</span> <span class=\"p\">(</span><span class=\"err\">sub</span> <span class=\"p\">(</span><span class=\"err\">struct</span>\n    <span class=\"p\">(</span><span class=\"err\">field</span> <span class=\"nv\">$f.scala.Tuple1._1</span> <span class=\"p\">(</span><span class=\"k\">mut</span> <span class=\"err\">anyref</span><span class=\"p\">)))))</span>\n\n  <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"p\">(</span><span class=\"k\">export</span> <span class=\"s2\">\"test\"</span><span class=\"p\">)</span>\n    <span class=\"p\">(</span><span class=\"k\">local</span> <span class=\"nv\">$instance</span> <span class=\"p\">(</span><span class=\"err\">ref</span> <span class=\"nv\">$c.scala.Tuple1</span><span class=\"p\">))</span>\n    <span class=\"nb\">i32.const</span> <span class=\"mi\">-2</span>\n    <span class=\"err\">ref.i</span><span class=\"mi\">31</span>\n    <span class=\"err\">struct.new</span> <span class=\"nv\">$c.scala.Tuple1</span>\n    <span class=\"nb\">drop</span>\n  <span class=\"p\">)</span>\n<span class=\"p\">)</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>$<span class=\"w\"> </span>wasm-tools<span class=\"w\"> </span>parse<span class=\"w\"> </span>test.wat<span class=\"w\"> </span>-o<span class=\"w\"> </span>test.wasm\n$<span class=\"w\"> </span>wasmtime<span class=\"w\"> </span>run<span class=\"w\"> </span>-W<span class=\"w\"> </span><span class=\"k\">function</span>-references,gc<span class=\"w\"> </span>--invoke<span class=\"w\"> </span><span class=\"nb\">test</span><span class=\"w\"> </span>test.wasm\nmake:<span class=\"w\"> </span>***<span class=\"w\"> </span><span class=\"o\">[</span>run<span class=\"o\">]</span><span class=\"w\"> </span>Illegal<span class=\"w\"> </span>instruction:<span class=\"w\"> </span><span class=\"m\">4</span>\n</code></pre></div>\n<p>see: <a href=\"https://github.com/tanishiking/kitchensink/tree/main/wasmtime-illegal-instruction\">https://github.com/tanishiking/kitchensink/tree/main/wasmtime-illegal-instruction</a></p>\n<ul>\n<li>As @vouillon mentioned, the problem doesn't happen when using the <code>-C collector=null</code> option.</li>\n<li>I guess there're other reproductions as well, because I find there's only <code>(ref.i31 (i32.const 0))</code> in @vouillon 's reproduction case.</li>\n</ul>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">version</span>\n<span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"mf\">29.0.1</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">58282</span><span class=\"n\">df89</span><span class=\"w\"> </span><span class=\"mi\">2025</span><span class=\"o\">-</span><span class=\"mi\">01</span><span class=\"o\">-</span><span class=\"mi\">21</span><span class=\"p\">)</span>\n</code></pre></div>\n</blockquote>",
        "id": 500350742,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1739869723
    },
    {
        "content": "<p>tanishiking edited a <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10181#issuecomment-2665004815\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10181\">issue #10181</a>:</p>\n<blockquote>\n<p>We encountered an \"Illegal Instruction\" error in our project (<a href=\"https://github.com/scala-wasm/scala-wasm/pull/5\">scala-wasm</a> fork of Scala.js to support wasm component model).</p>\n<p>I'm not sure if this is the only case, but the error occurs at least when we try to set an <code>i31</code> value (converted from i32 with the MSB has 1) to an <code>anyref</code> struct field.</p>\n<div class=\"codehilite\" data-code-language=\"WebAssembly\"><pre><span></span><code><span class=\"p\">(</span><span class=\"k\">module</span>\n  <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"nv\">$c.scala.Tuple1</span> <span class=\"p\">(</span><span class=\"err\">sub</span> <span class=\"p\">(</span><span class=\"err\">struct</span>\n    <span class=\"p\">(</span><span class=\"err\">field</span> <span class=\"nv\">$f.scala.Tuple1._1</span> <span class=\"p\">(</span><span class=\"k\">mut</span> <span class=\"err\">anyref</span><span class=\"p\">)))))</span>\n\n  <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"p\">(</span><span class=\"k\">export</span> <span class=\"s2\">\"test\"</span><span class=\"p\">)</span>\n    <span class=\"p\">(</span><span class=\"k\">local</span> <span class=\"nv\">$instance</span> <span class=\"p\">(</span><span class=\"err\">ref</span> <span class=\"nv\">$c.scala.Tuple1</span><span class=\"p\">))</span>\n    <span class=\"nb\">i32.const</span> <span class=\"mi\">-1</span>\n    <span class=\"err\">ref.i</span><span class=\"mi\">31</span>\n    <span class=\"err\">struct.new</span> <span class=\"nv\">$c.scala.Tuple1</span>\n    <span class=\"nb\">drop</span>\n  <span class=\"p\">)</span>\n<span class=\"p\">)</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>$<span class=\"w\"> </span>wasm-tools<span class=\"w\"> </span>parse<span class=\"w\"> </span>test.wat<span class=\"w\"> </span>-o<span class=\"w\"> </span>test.wasm\n$<span class=\"w\"> </span>wasmtime<span class=\"w\"> </span>run<span class=\"w\"> </span>-W<span class=\"w\"> </span><span class=\"k\">function</span>-references,gc<span class=\"w\"> </span>--invoke<span class=\"w\"> </span><span class=\"nb\">test</span><span class=\"w\"> </span>test.wasm\nmake:<span class=\"w\"> </span>***<span class=\"w\"> </span><span class=\"o\">[</span>run<span class=\"o\">]</span><span class=\"w\"> </span>Illegal<span class=\"w\"> </span>instruction:<span class=\"w\"> </span><span class=\"m\">4</span>\n</code></pre></div>\n<p>see: <a href=\"https://github.com/tanishiking/kitchensink/tree/main/wasmtime-illegal-instruction\">https://github.com/tanishiking/kitchensink/tree/main/wasmtime-illegal-instruction</a></p>\n<ul>\n<li>As @vouillon mentioned, the problem doesn't happen when using the <code>-C collector=null</code> option.</li>\n<li>I guess there're other reproductions as well, because I find there's only <code>(ref.i31 (i32.const 0))</code> in @vouillon 's reproduction case.</li>\n</ul>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">version</span>\n<span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"mf\">29.0.1</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">58282</span><span class=\"n\">df89</span><span class=\"w\"> </span><span class=\"mi\">2025</span><span class=\"o\">-</span><span class=\"mi\">01</span><span class=\"o\">-</span><span class=\"mi\">21</span><span class=\"p\">)</span>\n</code></pre></div>\n</blockquote>",
        "id": 500350835,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1739869758
    },
    {
        "content": "<p>tanishiking edited a <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10181#issuecomment-2665004815\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10181\">issue #10181</a>:</p>\n<blockquote>\n<p>We encountered an \"Illegal Instruction\" error in our project (<a href=\"https://github.com/scala-wasm/scala-wasm/pull/5\">scala-wasm</a> fork of Scala.js to support wasm component model).</p>\n<p>The error occurs at least when we try to set an <code>i31</code> value (converted from i32 with the MSB has 1) to an <code>anyref</code> struct field.</p>\n<div class=\"codehilite\" data-code-language=\"WebAssembly\"><pre><span></span><code><span class=\"p\">(</span><span class=\"k\">module</span>\n  <span class=\"p\">(</span><span class=\"k\">type</span> <span class=\"nv\">$c.scala.Tuple1</span> <span class=\"p\">(</span><span class=\"err\">sub</span> <span class=\"p\">(</span><span class=\"err\">struct</span>\n    <span class=\"p\">(</span><span class=\"err\">field</span> <span class=\"nv\">$f.scala.Tuple1._1</span> <span class=\"p\">(</span><span class=\"k\">mut</span> <span class=\"err\">anyref</span><span class=\"p\">)))))</span>\n\n  <span class=\"p\">(</span><span class=\"k\">func</span> <span class=\"p\">(</span><span class=\"k\">export</span> <span class=\"s2\">\"test\"</span><span class=\"p\">)</span>\n    <span class=\"p\">(</span><span class=\"k\">local</span> <span class=\"nv\">$instance</span> <span class=\"p\">(</span><span class=\"err\">ref</span> <span class=\"nv\">$c.scala.Tuple1</span><span class=\"p\">))</span>\n    <span class=\"nb\">i32.const</span> <span class=\"mi\">-1</span>\n    <span class=\"err\">ref.i</span><span class=\"mi\">31</span>\n    <span class=\"err\">struct.new</span> <span class=\"nv\">$c.scala.Tuple1</span>\n    <span class=\"nb\">drop</span>\n  <span class=\"p\">)</span>\n<span class=\"p\">)</span>\n</code></pre></div>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>$<span class=\"w\"> </span>wasm-tools<span class=\"w\"> </span>parse<span class=\"w\"> </span>test.wat<span class=\"w\"> </span>-o<span class=\"w\"> </span>test.wasm\n$<span class=\"w\"> </span>wasmtime<span class=\"w\"> </span>run<span class=\"w\"> </span>-W<span class=\"w\"> </span><span class=\"k\">function</span>-references,gc<span class=\"w\"> </span>--invoke<span class=\"w\"> </span><span class=\"nb\">test</span><span class=\"w\"> </span>test.wasm\nmake:<span class=\"w\"> </span>***<span class=\"w\"> </span><span class=\"o\">[</span>run<span class=\"o\">]</span><span class=\"w\"> </span>Illegal<span class=\"w\"> </span>instruction:<span class=\"w\"> </span><span class=\"m\">4</span>\n</code></pre></div>\n<p>see: <a href=\"https://github.com/tanishiking/kitchensink/tree/main/wasmtime-illegal-instruction\">https://github.com/tanishiking/kitchensink/tree/main/wasmtime-illegal-instruction</a></p>\n<ul>\n<li>As @vouillon mentioned, the problem doesn't happen when using the <code>-C collector=null</code> option.</li>\n<li>I guess there're other reproductions as well, because I find there's only <code>(ref.i31 (i32.const 0))</code> in @vouillon 's reproduction case.</li>\n</ul>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">version</span>\n<span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"mf\">29.0.1</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">58282</span><span class=\"n\">df89</span><span class=\"w\"> </span><span class=\"mi\">2025</span><span class=\"o\">-</span><span class=\"mi\">01</span><span class=\"o\">-</span><span class=\"mi\">21</span><span class=\"p\">)</span>\n</code></pre></div>\n</blockquote>",
        "id": 500353073,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1739870518
    },
    {
        "content": "<p>tanishiking <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10181#issuecomment-2673953316\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10181\">issue #10181</a>:</p>\n<blockquote>\n<p>This particular example <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10181#issuecomment-2665004815\">https://github.com/bytecodealliance/wasmtime/issues/10181#issuecomment-2665004815</a> has fixed in local-built wasmtime  (287e8fb5405a943f67babf08643e23bea449e7bf) <span aria-label=\"tada\" class=\"emoji emoji-1f389\" role=\"img\" title=\"tada\">:tada:</span> thanks! maybe <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10091\">https://github.com/bytecodealliance/wasmtime/pull/10091</a> was the fix?</p>\n<p>but we still hit the <code>Illegal instruction: 4</code> error in larger binary, I'll share it when I could make a bit smaller reproducible example.</p>\n</blockquote>",
        "id": 501051914,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1740127879
    },
    {
        "content": "<p>tanishiking edited a <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10181#issuecomment-2673953316\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10181\">issue #10181</a>:</p>\n<blockquote>\n<p>This particular example <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10181#issuecomment-2665004815\">https://github.com/bytecodealliance/wasmtime/issues/10181#issuecomment-2665004815</a> has fixed in local-built wasmtime  (287e8fb5405a943f67babf08643e23bea449e7bf) <span aria-label=\"tada\" class=\"emoji emoji-1f389\" role=\"img\" title=\"tada\">:tada:</span> not sure what was the fix though.</p>\n<p>but we still hit the <code>Illegal instruction: 4</code> error in larger binary, I'll share it when I could make a bit smaller reproducible example.</p>\n</blockquote>",
        "id": 501052086,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1740127928
    },
    {
        "content": "<p>tanishiking edited a <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10181#issuecomment-2673953316\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10181\">issue #10181</a>:</p>\n<blockquote>\n<p>This particular example <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10181#issuecomment-2665004815\">https://github.com/bytecodealliance/wasmtime/issues/10181#issuecomment-2665004815</a> has fixed in local-built wasmtime  (287e8fb5405a943f67babf08643e23bea449e7bf) <span aria-label=\"tada\" class=\"emoji emoji-1f389\" role=\"img\" title=\"tada\">:tada:</span> not sure what was the fix though.</p>\n<p>We still hit the <code>Illegal instruction: 4</code> error in larger binary, I'll share it when I could make a bit smaller reproducible example.</p>\n</blockquote>",
        "id": 501052116,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1740127938
    },
    {
        "content": "<p>fitzgen <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10181#issuecomment-2715011157\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10181\">issue #10181</a>:</p>\n<blockquote>\n<p>@tanishiking could you check whether <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10371\">https://github.com/bytecodealliance/wasmtime/pull/10371</a> fixes the issue locally for you? It fixes illegal instruction faults for me locally (which are the externally visible symptoms of internal debug assertions inside the compiled Wasm code failing). Thanks!</p>\n</blockquote>",
        "id": 504896953,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1741710985
    }
]
[
    {
        "content": "<p>alexcrichton assigned dicej to <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12108\">issue #12108</a>.</p>",
        "id": 561499837,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764702958
    },
    {
        "content": "<p>alexcrichton opened <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12108\">issue #12108</a>:</p>\n<blockquote>\n<p>For this test case:</p>\n<div class=\"codehilite\" data-code-language=\"wasm\"><pre><span></span><code>(component\n  (core module $libc (memory (export \"m\") 1))\n  (core instance $libc (instantiate $libc))\n\n  (type $s (stream u32))\n  (core func $stream.new (canon stream.new $s))\n  (core func $stream.read (canon stream.read $s async (memory $libc \"m\")))\n  (core func $stream.write (canon stream.write $s async (memory $libc \"m\")))\n\n  (core module $m\n    (import \"\" \"stream.new\" (func $stream.new (result i64)))\n    (import \"\" \"stream.read\" (func $stream.read (param i32 i32 i32) (result i32)))\n    (import \"\" \"stream.write\" (func $stream.write (param i32 i32 i32) (result i32)))\n\n    (func (export \"run\")\n      (local $tmp i64)\n      (local $r i32)\n      (local $w i32)\n      (local.set $tmp (call $stream.new))\n\n      (local.set $r (i32.wrap_i64 (local.get $tmp)))\n      (local.set $w (i32.wrap_i64 (i64.shr_u (local.get $tmp) (i64.const 32))))\n\n      (call $stream.read (local.get $r) (i32.const 0) (i32.const 4))\n      i32.const -1 ;; BLOCKED\n      i32.ne\n      if unreachable end\n\n      (call $stream.write (local.get $w) (i32.const 0) (i32.const 4))\n      drop\n    )\n  )\n\n  (core instance $i (instantiate $m\n    (with \"\" (instance\n      (export \"stream.new\" (func $stream.new))\n      (export \"stream.read\" (func $stream.read))\n      (export \"stream.write\" (func $stream.write))\n    ))\n  ))\n\n  (func (export \"run\") (canon lift (core func $i \"run\")))\n)\n\n(assert_trap (invoke \"run\") \"some message here\")\n</code></pre></div>\n<p>this yields:</p>\n<p><div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">wast</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"p\">.</span><span class=\"n\">wast</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">W</span><span class=\"w\"> </span><span class=\"n\">component</span><span class=\"o\">-</span><span class=\"n\">model</span><span class=\"o\">-</span><span class=\"k\">async</span>\n<span class=\"w\">    </span><span class=\"n\">Finished</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">dev</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">profile</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">unoptimized</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">debuginfo</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"p\">(</span><span class=\"n\">s</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"mf\">0.10</span><span class=\"n\">s</span>\n<span class=\"w\">     </span><span class=\"n\">Running</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">target</span><span class=\"o\">/</span><span class=\"n\">x86_64</span><span class=\"o\">-</span><span class=\"n\">unknown</span><span class=\"o\">-</span><span class=\"n\">linux</span><span class=\"o\">-</span><span class=\"n\">gnu</span><span class=\"o\">/</span><span class=\"n\">debug</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"n\">wast</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"p\">.</span><span class=\"n\">wast</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">W</span><span class=\"w\"> </span><span class=\"n\">component</span><span class=\"o\">-</span><span class=\"n\">model</span><span class=\"o\">-</span><span class=\"k\">async</span><span class=\"err\">`</span>\n<span class=\"n\">Error</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">script</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">foo</span><span class=\"p\">.</span><span class=\"n\">wast</span><span class=\"o\">'</span>\n\n<span class=\"n\">Caused</span><span class=\"w\"> </span><span class=\"n\">by</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"mi\">0</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">directive</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"p\">.</span><span class=\"n\">wast</span><span class=\"p\">:</span><span class=\"mi\">45</span>\n<span class=\"w\">    </span><span class=\"mi\">1</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">expected</span><span class=\"w\"> </span><span class=\"n\">trap</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">got</span><span class=\"w\"> </span><span class=\"n\">Component</span><span class=\"p\">([])</span>\n</code></pre></div><br>\n</p>\n</blockquote>",
        "id": 561499841,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764702959
    },
    {
        "content": "<p><a href=\"https://github.com/alexcrichton\">alexcrichton</a> added the wasm-proposal:component-model-async label to <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12108\">Issue #12108</a>.</p>",
        "id": 561499842,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764702959
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12108#issuecomment-3603600072\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12108\">issue #12108</a>:</p>\n<blockquote>\n<p>Same for futures:</p>\n<p><div class=\"codehilite\" data-code-language=\"wasm\"><pre><span></span><code>(component\n  (core module $libc (memory (export \"m\") 1))\n  (core instance $libc (instantiate $libc))\n\n  (type $s (future u32))\n  (core func $future.new (canon future.new $s))\n  (core func $future.read (canon future.read $s async (memory $libc \"m\")))\n  (core func $future.write (canon future.write $s async (memory $libc \"m\")))\n\n  (core module $m\n    (import \"\" \"future.new\" (func $future.new (result i64)))\n    (import \"\" \"future.read\" (func $future.read (param i32 i32) (result i32)))\n    (import \"\" \"future.write\" (func $future.write (param i32 i32) (result i32)))\n\n    (func (export \"run\")\n      (local $tmp i64)\n      (local $r i32)\n      (local $w i32)\n      (local.set $tmp (call $future.new))\n\n      (local.set $r (i32.wrap_i64 (local.get $tmp)))\n      (local.set $w (i32.wrap_i64 (i64.shr_u (local.get $tmp) (i64.const 32))))\n\n      (call $future.read (local.get $r) (i32.const 0))\n      i32.const -1 ;; BLOCKED\n      i32.ne\n      if unreachable end\n\n      (call $future.write (local.get $w) (i32.const 0))\n      drop\n    )\n  )\n\n  (core instance $i (instantiate $m\n    (with \"\" (instance\n      (export \"future.new\" (func $future.new))\n      (export \"future.read\" (func $future.read))\n      (export \"future.write\" (func $future.write))\n    ))\n  ))\n\n  (func (export \"run\") (canon lift (core func $i \"run\")))\n)\n\n(assert_trap (invoke \"run\") \"some message here\")\n</code></pre></div><br>\n</p>\n</blockquote>",
        "id": 561499951,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764703002
    },
    {
        "content": "<p>dicej <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12108#issuecomment-3607548312\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12108\">issue #12108</a>:</p>\n<blockquote>\n<p>FYI, I've fixed this locally, but it turns out the <code>p3_http_middleware_host_to_host</code> is doing intra-component <code>stream&lt;u8&gt;</code> reads and writes.  Specifically, the <code>p3_http_middleware</code> component is creating a stream, wrapping it in a request, and passing that request to the <code>p3_http_echo</code> component.  Then the <code>p3_http_echo</code> component consumes the request, wraps the stream in a response, and returns the response.  Finally, the <code>p3_http_middleware</code> component consumes the response and reads from the stream, not realizing it's the same stream it created.</p>\n<p>I think we anticipated this kind of scenario, but it's not clear to me which component ought to change its behavior here.  It seems unfair to make the <code>p3_http_echo</code> component conservatively create an intermediate stream to avoid passing the original one back to the caller, and it's not clear to me how <code>p3_http_middleware</code> could be defensive about it either.</p>\n<p>@lukewagner do you have thoughts on this?</p>\n</blockquote>",
        "id": 561690943,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764777302
    },
    {
        "content": "<p>lukewagner <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12108#issuecomment-3607756407\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12108\">issue #12108</a>:</p>\n<blockquote>\n<p>The same-component trap is very much a \"this will bite folks in unexpected and unfair ways\" TODO to fix, so I think, unfortunately, the \"right\" fix is to have the echo server do an intermediate copy.  FWIW, IIUC, once we get lazy-lowering, I think the same-component-instance case should mostly fall out for free (or with only modest effort) and so we could simply delete the trap.</p>\n</blockquote>",
        "id": 561701831,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764779874
    },
    {
        "content": "<p>dicej <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12108#issuecomment-3607939480\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12108\">issue #12108</a>:</p>\n<blockquote>\n<p>I'm remembering now when we last discussed this, and I guess the ideal solution would be for <code>wit_bindgen</code>'s <code>Stream{Writer::write,Reader::read}</code> to check for the intra-component case and switch to an in-memory channel.  The tricky part is switching back and forth between the \"intra\" and \"inter\" states as the read handle is passed in and out of the component.</p>\n</blockquote>",
        "id": 561712231,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764782336
    },
    {
        "content": "<p>alexcrichton closed <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12108\">issue #12108</a>:</p>\n<blockquote>\n<p>For this test case:</p>\n<div class=\"codehilite\" data-code-language=\"wasm\"><pre><span></span><code>(component\n  (core module $libc (memory (export \"m\") 1))\n  (core instance $libc (instantiate $libc))\n\n  (type $s (stream u32))\n  (core func $stream.new (canon stream.new $s))\n  (core func $stream.read (canon stream.read $s async (memory $libc \"m\")))\n  (core func $stream.write (canon stream.write $s async (memory $libc \"m\")))\n\n  (core module $m\n    (import \"\" \"stream.new\" (func $stream.new (result i64)))\n    (import \"\" \"stream.read\" (func $stream.read (param i32 i32 i32) (result i32)))\n    (import \"\" \"stream.write\" (func $stream.write (param i32 i32 i32) (result i32)))\n\n    (func (export \"run\")\n      (local $tmp i64)\n      (local $r i32)\n      (local $w i32)\n      (local.set $tmp (call $stream.new))\n\n      (local.set $r (i32.wrap_i64 (local.get $tmp)))\n      (local.set $w (i32.wrap_i64 (i64.shr_u (local.get $tmp) (i64.const 32))))\n\n      (call $stream.read (local.get $r) (i32.const 0) (i32.const 4))\n      i32.const -1 ;; BLOCKED\n      i32.ne\n      if unreachable end\n\n      (call $stream.write (local.get $w) (i32.const 0) (i32.const 4))\n      drop\n    )\n  )\n\n  (core instance $i (instantiate $m\n    (with \"\" (instance\n      (export \"stream.new\" (func $stream.new))\n      (export \"stream.read\" (func $stream.read))\n      (export \"stream.write\" (func $stream.write))\n    ))\n  ))\n\n  (func (export \"run\") (canon lift (core func $i \"run\")))\n)\n\n(assert_trap (invoke \"run\") \"some message here\")\n</code></pre></div>\n<p>this yields:</p>\n<p><div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">wast</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"p\">.</span><span class=\"n\">wast</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">W</span><span class=\"w\"> </span><span class=\"n\">component</span><span class=\"o\">-</span><span class=\"n\">model</span><span class=\"o\">-</span><span class=\"k\">async</span>\n<span class=\"w\">    </span><span class=\"n\">Finished</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">dev</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">profile</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">unoptimized</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">debuginfo</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"p\">(</span><span class=\"n\">s</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"mf\">0.10</span><span class=\"n\">s</span>\n<span class=\"w\">     </span><span class=\"n\">Running</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">target</span><span class=\"o\">/</span><span class=\"n\">x86_64</span><span class=\"o\">-</span><span class=\"n\">unknown</span><span class=\"o\">-</span><span class=\"n\">linux</span><span class=\"o\">-</span><span class=\"n\">gnu</span><span class=\"o\">/</span><span class=\"n\">debug</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"n\">wast</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"p\">.</span><span class=\"n\">wast</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">W</span><span class=\"w\"> </span><span class=\"n\">component</span><span class=\"o\">-</span><span class=\"n\">model</span><span class=\"o\">-</span><span class=\"k\">async</span><span class=\"err\">`</span>\n<span class=\"n\">Error</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">script</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">foo</span><span class=\"p\">.</span><span class=\"n\">wast</span><span class=\"o\">'</span>\n\n<span class=\"n\">Caused</span><span class=\"w\"> </span><span class=\"n\">by</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"mi\">0</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">directive</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"n\">foo</span><span class=\"p\">.</span><span class=\"n\">wast</span><span class=\"p\">:</span><span class=\"mi\">45</span>\n<span class=\"w\">    </span><span class=\"mi\">1</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">expected</span><span class=\"w\"> </span><span class=\"n\">trap</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">got</span><span class=\"w\"> </span><span class=\"n\">Component</span><span class=\"p\">([])</span>\n</code></pre></div><br>\n</p>\n</blockquote>",
        "id": 561729327,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764787635
    }
]
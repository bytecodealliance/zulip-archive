[
    {
        "content": "<p>wingo opened <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11667\">issue #11667</a>:</p>\n<blockquote>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">async</span><span class=\"w\"> </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">test_flags_and_type</span><span class=\"p\">(</span><span class=\"n\">dir</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kp\">&amp;</span><span class=\"nc\">Descriptor</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">open</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"n\">path</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kp\">&amp;</span><span class=\"kt\">str</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">oflags</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">OpenFlags</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">fdflags</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">DescriptorFlags</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">_</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"n\">dir</span><span class=\"p\">.</span><span class=\"n\">open_at</span><span class=\"p\">(</span><span class=\"n\">PathFlags</span><span class=\"p\">::</span><span class=\"n\">empty</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">path</span><span class=\"p\">.</span><span class=\"n\">to_string</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">oflags</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">fdflags</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"p\">};</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">open</span><span class=\"p\">(</span><span class=\"s\">\".\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">OpenFlags</span><span class=\"p\">::</span><span class=\"n\">empty</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">DescriptorFlags</span><span class=\"p\">::</span><span class=\"n\">MUTATE_DIRECTORY</span><span class=\"p\">).</span><span class=\"k\">await</span><span class=\"p\">.</span><span class=\"n\">unwrap</span><span class=\"p\">();</span>\n<span class=\"w\">    </span><span class=\"fm\">assert_eq!</span><span class=\"p\">(</span><span class=\"n\">d</span><span class=\"p\">.</span><span class=\"n\">get_flags</span><span class=\"p\">().</span><span class=\"k\">await</span><span class=\"p\">,</span>\n<span class=\"w\">               </span><span class=\"nb\">Ok</span><span class=\"p\">(</span><span class=\"n\">DescriptorFlags</span><span class=\"p\">::</span><span class=\"n\">READ</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">DescriptorFlags</span><span class=\"p\">::</span><span class=\"n\">MUTATE_DIRECTORY</span><span class=\"p\">));</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>I would expect that the directory is opened with <code>MUTATE_DIRECTORY</code>.  However it seems it is not:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">openat2</span><span class=\"p\">(</span><span class=\"mi\">3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">\".\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"n\">flags</span><span class=\"o\">=</span><span class=\"n\">O_RDONLY</span><span class=\"o\">|</span><span class=\"n\">O_LARGEFILE</span><span class=\"o\">|</span><span class=\"n\">O_NOFOLLOW</span><span class=\"o\">|</span><span class=\"n\">O_CLOEXEC</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">resolve</span><span class=\"o\">=</span><span class=\"n\">RESOLVE_NO_MAGICLINKS</span><span class=\"o\">|</span><span class=\"n\">RESOLVE_BENEATH</span><span class=\"p\">},</span><span class=\"w\"> </span><span class=\"mi\">24</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">12</span>\n<span class=\"n\">statx</span><span class=\"p\">(</span><span class=\"mi\">12</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">\"\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">AT_STATX_SYNC_AS_STAT</span><span class=\"o\">|</span><span class=\"n\">AT_EMPTY_PATH</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">STATX_ALL</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"n\">stx_mask</span><span class=\"o\">=</span><span class=\"n\">STATX_ALL</span><span class=\"o\">|</span><span class=\"n\">STATX_MNT_ID</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">stx_attributes</span><span class=\"o\">=</span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">stx_mode</span><span class=\"o\">=</span><span class=\"n\">S_IFDIR</span><span class=\"o\">|</span><span class=\"mi\">0755</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">stx_size</span><span class=\"o\">=</span><span class=\"mi\">4096</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"p\">.})</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span>\n<span class=\"n\">fcntl</span><span class=\"p\">(</span><span class=\"mi\">12</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">F_GETFL</span><span class=\"p\">)</span><span class=\"w\">                      </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mh\">0x28000</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">flags</span><span class=\"w\"> </span><span class=\"n\">O_RDONLY</span><span class=\"o\">|</span><span class=\"n\">O_LARGEFILE</span><span class=\"o\">|</span><span class=\"n\">O_NOFOLLOW</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>It seems we only have <code>READ</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">thread</span><span class=\"w\"> </span><span class=\"o\">'&lt;</span><span class=\"n\">unnamed</span><span class=\"o\">&gt;'</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">panicked</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">bin</span><span class=\"o\">/</span><span class=\"n\">filesystem</span><span class=\"p\">.</span><span class=\"n\">rs</span><span class=\"p\">:</span><span class=\"mi\">620</span><span class=\"p\">:</span><span class=\"mi\">5</span><span class=\"p\">:</span>\n<span class=\"nc\">assertion</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">left</span><span class=\"w\"> </span><span class=\"o\">==</span><span class=\"w\"> </span><span class=\"n\">right</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">failed</span>\n<span class=\"w\">  </span><span class=\"n\">left</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nb\">Ok</span><span class=\"p\">(</span><span class=\"n\">DescriptorFlags</span><span class=\"p\">(</span><span class=\"n\">READ</span><span class=\"p\">))</span>\n<span class=\"w\"> </span><span class=\"n\">right</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nb\">Ok</span><span class=\"p\">(</span><span class=\"n\">DescriptorFlags</span><span class=\"p\">(</span><span class=\"n\">READ</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">MUTATE_DIRECTORY</span><span class=\"p\">))</span>\n</code></pre></div>\n</blockquote>",
        "id": 538677465,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1757517009
    },
    {
        "content": "<p><a href=\"https://github.com/wingo\">wingo</a> added the bug label to <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11667\">Issue #11667</a>.</p>",
        "id": 538677469,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1757517009
    },
    {
        "content": "<p>wingo <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11667#issuecomment-3275434690\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11667\">issue #11667</a>:</p>\n<blockquote>\n<p>It's weirder than that; <code>MUTATE_DIRECTORY</code> doesn't seem to be propagated at all:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">d</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">open</span><span class=\"p\">(</span><span class=\"s\">\".\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">OpenFlags</span><span class=\"p\">::</span><span class=\"n\">DIRECTORY</span><span class=\"p\">,</span>\n<span class=\"w\">                 </span><span class=\"n\">DescriptorFlags</span><span class=\"p\">::</span><span class=\"n\">READ</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">DescriptorFlags</span><span class=\"p\">::</span><span class=\"n\">MUTATE_DIRECTORY</span><span class=\"p\">).</span><span class=\"k\">await</span><span class=\"p\">.</span><span class=\"n\">unwrap</span><span class=\"p\">();</span>\n<span class=\"w\">    </span><span class=\"fm\">assert_eq!</span><span class=\"p\">(</span><span class=\"n\">d</span><span class=\"p\">.</span><span class=\"n\">get_flags</span><span class=\"p\">().</span><span class=\"k\">await</span><span class=\"p\">,</span>\n<span class=\"w\">               </span><span class=\"nb\">Ok</span><span class=\"p\">(</span><span class=\"n\">DescriptorFlags</span><span class=\"p\">::</span><span class=\"n\">READ</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">DescriptorFlags</span><span class=\"p\">::</span><span class=\"n\">MUTATE_DIRECTORY</span><span class=\"p\">));</span>\n</code></pre></div>\n<p>Here the assertion fails; the flags that I get are just <code>READ</code>.</p>\n</blockquote>",
        "id": 538679283,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1757517469
    },
    {
        "content": "<p><a href=\"https://github.com/alexcrichton\">alexcrichton</a> added the wasi:impl label to <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11667\">Issue #11667</a>.</p>",
        "id": 538721309,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1757531067
    },
    {
        "content": "<p><a href=\"https://github.com/alexcrichton\">alexcrichton</a> added the wasi label to <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11667\">Issue #11667</a>.</p>",
        "id": 538721310,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1757531067
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11667#issuecomment-3276183611\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11667\">issue #11667</a>:</p>\n<blockquote>\n<p>I think <code>MUTATE_DIRECTORY</code> is entirely unimplemented in Wasmtime. I'm not seeing any references to it at all. Wasmtime does implement <code>READ</code> and <code>WRITE</code> and I suspect in the transition to p2 this was changed in the WITs but never updated in Wasmtime, so variuos bits and pieces which check for <code>WRITE</code> probably need to check for this instead.</p>\n</blockquote>",
        "id": 538721407,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1757531114
    },
    {
        "content": "<p>wingo <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11667#issuecomment-3279486836\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11667\">issue #11667</a>:</p>\n<blockquote>\n<p>Preopened directories do have <code>MUTATE_DIRECTORY</code> in wasmtime, fwiw.</p>\n</blockquote>",
        "id": 538810475,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1757582919
    }
]
[
    {
        "content": "<p>cfallin opened <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a> from <code>cfallin:wasm-exceptions</code> to <code>bytecodealliance:main</code>:</p>\n<blockquote>\n<p>This PR introduces support for the [Wasm exception-handling proposal], which introduces a conventional try/catch mechanism to WebAssembly. The PR supports modules that use <code>try_table</code> to register handlers for a lexical scope; and provides <code>throw</code> and <code>throw_ref</code> that allocate (in the first case) and throw exception objects.</p>\n<p>This PR builds on top of the work in #10510 for Cranelift-level exception support, #10919 for an unwinder, and #11230 for exception objects built on top of GC, in addition a bunch of smaller fix and enabling PRs around those. It is currently stacked on top of #11321.</p>\n<p>This PR does not yet provide host-boundary-crossing exceptions; exceptions that are not caught in a given Wasm activation become traps at the host boundary. That support will come in a subsequent PR.</p>\n<p>Because exceptions do not yet cross the host boundary, this also does not yet enable the <code>assert_exception</code> wast directive, and so cannot yet support the spec-tests. That will also come in a subsequent PR.</p>\n<p>[Wasm exception-handling proposal]: <a href=\"https://github.com/WebAssembly/exception-handling/\">https://github.com/WebAssembly/exception-handling/</a></p>\n</blockquote>",
        "id": 530865340,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753487015
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#issuecomment-3120697980\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a>:</p>\n<blockquote>\n<p>Logistical note: I'm posting this as a draft now to get early feedback and because I know folks are waiting to see how it is shaping up. I'm on vacation for two weeks starting now (back Mon Aug 11) and will plan to polish then. I'm hoping to actually get host-boundary integration built as well, if I can, in this PR, to enable spec-tests, but if that turns out to be too much then it will come right after. Following that, fuzzing is the only piece that remains, I think.</p>\n</blockquote>",
        "id": 530865558,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753487145
    },
    {
        "content": "<p>cfallin updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a>.</p>",
        "id": 530870856,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753490969
    },
    {
        "content": "<p>cfallin updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a>.</p>",
        "id": 530873078,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753492519
    },
    {
        "content": "<p>cfallin updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a>.</p>",
        "id": 530873231,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753492605
    },
    {
        "content": "<p>cfallin updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a>.</p>",
        "id": 530876947,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753495283
    },
    {
        "content": "<p>cfallin updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a>.</p>",
        "id": 530876976,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753495294
    },
    {
        "content": "<p>cfallin edited <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a>:</p>\n<blockquote>\n<p>This PR introduces support for the [Wasm exception-handling proposal], which introduces a conventional try/catch mechanism to WebAssembly. The PR supports modules that use <code>try_table</code> to register handlers for a lexical scope; and provides <code>throw</code> and <code>throw_ref</code> that allocate (in the first case) and throw exception objects.</p>\n<p>This PR builds on top of the work in #10510 for Cranelift-level exception support, #10919 for an unwinder, and #11230 for exception objects built on top of GC, in addition a bunch of smaller fix and enabling PRs around those.</p>\n<p>This PR does not yet provide host-boundary-crossing exceptions; exceptions that are not caught in a given Wasm activation become traps at the host boundary. That support will come in a subsequent PR.</p>\n<p>Because exceptions do not yet cross the host boundary, this also does not yet enable the <code>assert_exception</code> wast directive, and so cannot yet support the spec-tests. That will also come in a subsequent PR.</p>\n<p>[Wasm exception-handling proposal]: <a href=\"https://github.com/WebAssembly/exception-handling/\">https://github.com/WebAssembly/exception-handling/</a></p>\n</blockquote>",
        "id": 530876992,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753495307
    },
    {
        "content": "<p>cfallin updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a>.</p>",
        "id": 530877335,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753495543
    },
    {
        "content": "<p>alexcrichton submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#pullrequestreview-3057688753\">PR review</a>:</p>\n<blockquote>\n<p>I've left some high-level thoughts here and there, but definitely feel free to defer anything to issues as you feel appropriate.</p>\n</blockquote>",
        "id": 531004345,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753564203
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2232581296\">PR review comment</a>:</p>\n<blockquote>\n<p>Could this be made safe and return an action to perform rather than performing the action? I get jittery skipping Rust frames nowadays and I feel it works best when this propagates upwards as far as it can the action to take before actually taking the action. One example is that with Pulley this can't return <code>!</code> because it'll need to propagate to the interpreter loop to update interpreter state to perform the pseudo-longjmp</p>\n</blockquote>",
        "id": 531004346,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753564204
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2232579654\">PR review comment</a>:</p>\n<blockquote>\n<p>Could this be skipped if the exception tables section is empty?</p>\n</blockquote>",
        "id": 531004347,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753564204
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2232582051\">PR review comment</a>:</p>\n<blockquote>\n<p>In the long-term I think we'll want to handle this differently because <code>store</code> here aliases <code>nogc</code> without the compiler knowing. This is probably fine for now but if this sticks around can you file an issue to improve this in the future?</p>\n<p>One possible idea would be to move the <code>InstanceId</code> into the <code>VMContext</code> and to read that out and then lookup through <code>nogc</code> the <code>InstanceId</code>. Another option would be to add a helper method to <code>Instance</code> which takes the store and the <code>VMContext</code> and returns <code>Pin&lt;&amp;mut Instance&gt;</code> connected to the lifetime of the store, avoiding creating a second store pointer and requiring the store has nothing else borrowed at the same time.</p>\n</blockquote>",
        "id": 531004348,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753564204
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2232583856\">PR review comment</a>:</p>\n<blockquote>\n<p>Could this be done with a <code>#[cfg(debug_assertions)]</code> perhaps? That'll help avoid paging this in if necessary and by construction this should always be true as a result of compilation such that it shouldn't be required to check here too.</p>\n</blockquote>",
        "id": 531004349,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753564204
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2232584001\">PR review comment</a>:</p>\n<blockquote>\n<p>This might be best to switch to <code>GC_TYPES</code> instead of <code>GC</code> since that's the true reliance here, there's no need to enable structs/arrays to enable exceptions too. (just that under the hood exceptions is implemented with GC types)</p>\n</blockquote>",
        "id": 531004350,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753564204
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2232580100\">PR review comment</a>:</p>\n<blockquote>\n<p>Mind adding a <code>tests/disas</code> test for this showing the exception tables?</p>\n</blockquote>",
        "id": 531004351,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753564204
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2232583648\">PR review comment</a>:</p>\n<blockquote>\n<p>To confirm, <code>parse</code> here is a pretty cheap operation?</p>\n</blockquote>",
        "id": 531004352,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753564204
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2232583447\">PR review comment</a>:</p>\n<blockquote>\n<p>Could you expand the documentation here that this should be used judiciously and specifically mention that the closure <code>f</code> is executed under a read lock? That'll help communicate that this can block for awhile waiting for a write lock to finish and additionally this is blocking all writers at the same time.</p>\n</blockquote>",
        "id": 531004353,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753564204
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2232584433\">PR review comment</a>:</p>\n<blockquote>\n<p>Mind double-checking there are tests for these new offset methods (and the ones below) in <code>vmcontext.rs</code>?</p>\n</blockquote>",
        "id": 531004354,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753564204
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2232582508\">PR review comment</a>:</p>\n<blockquote>\n<p>I'm not sure whether it's viable, but personally what I'd ideally like to see is the request-to-throw propagated even through the libcall here through the <code>Result</code>. That'd likely require some finesse and refactoring but I suspect such refactoring is going to be required no matter what for Pulley support eventually.</p>\n<p>In lieu of that though I'd ideally like to see the \"do the throw\" action no higher than here, so my comment below about threading the action-to-do would be handled around here. (although I could also be missing other places where it's acted upon)</p>\n</blockquote>",
        "id": 531004355,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753564204
    },
    {
        "content": "<p>fitzgen submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#pullrequestreview-3064601271\">PR review</a>:</p>\n<blockquote>\n<p>Shaping up nicely!</p>\n<p>We had talked elsewhere about removing the exception composite type variant and having tags refer to just their function type (but we would now optionally have a GC struct layout for a function type's parameters for use with exceptions). This would better align us with the Wasm spec and make it so that there are less new additions to the types registry code and also fewer interactions at runtime with its locking and tables and all that. Are you still planning on pursuing this?</p>\n</blockquote>",
        "id": 531657292,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753807957
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2237850315\">PR review comment</a>:</p>\n<blockquote>\n<p>Might as well <code>smallvec![]</code> these temporaries.</p>\n</blockquote>",
        "id": 531657294,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753807958
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2240391352\">PR review comment</a>:</p>\n<blockquote>\n<p><em>and</em> there are no frames on the stack between the Wasm and here that must run to maintain some safety invariant, and cannot be unwound over.</p>\n<p>This is ~impossible to determine in arbitrary code, which is why pushing the command-return all the way out to the libcall is nice, since we know there is ~nothing on the stack before the Wasm frames at that point.</p>\n</blockquote>",
        "id": 531657295,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753807958
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2240380195\">PR review comment</a>:</p>\n<blockquote>\n<blockquote>\n<p>One possible idea would be to move the InstanceId into the VMContext and to read that out and then lookup through nogc the InstanceId. Another option would be to add a helper method to Instance which takes the store and the VMContext and returns Pin&lt;&amp;mut Instance&gt; connected to the lifetime of the store, avoiding creating a second store pointer and requiring the store has nothing else borrowed at the same time.</p>\n</blockquote>\n<p>Another variant on this idea: we could also have a method on the store that takes a vmctx and gives an instance, something like</p>\n<p><div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">StoreOpaque</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"c1\">// Safety: vmctx must be a valid pointer</span>\n<span class=\"w\">    </span><span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">unsafe</span><span class=\"w\"> </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">instance_from_vmctx</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">vmctx</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">VMContext</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nb\">Option</span><span class=\"o\">&lt;</span><span class=\"n\">Pin</span><span class=\"o\">&lt;&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">Instance</span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"c1\">// Validate that the vmctx is from this store and all that...</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div><br>\n</p>\n</blockquote>",
        "id": 531657296,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753807958
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2240409313\">PR review comment</a>:</p>\n<blockquote>\n<p>Where is this used? I don't actually see it used anywhere and C-f isn't finding anything.</p>\n<p>Also, it is probably better, in terms of horizontal scalability, to clone the layout out of the registry than to hold the lock for the duration of whatever code needs to work with it. If that is something we need to do often, we can look into making that cheaper, eg by storing layouts in an <code>Arc</code> or something.</p>\n</blockquote>",
        "id": 531657297,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753807958
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2240367961\">PR review comment</a>:</p>\n<blockquote>\n<p>Rather than dynamically assert that these are unreachable at runtime, we can statically assert that they are unreachable at compile time via</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"nb\">From</span><span class=\"o\">&lt;</span><span class=\"n\">VMStructRef</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">VMGcRef</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">from</span><span class=\"p\">(</span><span class=\"n\">s</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">VMStructRef</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">VMGcRef</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"p\">{}</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>etc...</p>\n<p>This is nice because any mistakes are caught at compile time.</p>\n</blockquote>",
        "id": 531657298,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753807958
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2237872706\">PR review comment</a>:</p>\n<blockquote>\n<p>I don't think this is correct? I think we mark our own (callee) vmctx as \"the\" <code>vmctx</code> for Cranelift and the caller's vmctx is the second argument that follows afterwards. For example: </p>\n<p><a href=\"https://github.com/bytecodealliance/wasmtime/blob/1155d6dfbfe859cad85cfe0d5700d4acefd04745/crates/cranelift/src/lib.rs#L145-L160\">https://github.com/bytecodealliance/wasmtime/blob/1155d6dfbfe859cad85cfe0d5700d4acefd04745/crates/cranelift/src/lib.rs#L145-L160</a></p>\n</blockquote>",
        "id": 531657299,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753807958
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#issuecomment-3133359321\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a>:</p>\n<blockquote>\n<blockquote>\n<p>We had talked elsewhere about removing the exception composite type variant and having tags refer to just their function type (but we would now optionally have a GC struct layout for a function type's parameters for use with exceptions). This would better align us with the Wasm spec and make it so that there are less new additions to the types registry code and also fewer interactions at runtime with its locking and tables and all that. Are you still planning on pursuing this?</p>\n</blockquote>\n<p>Ah, sorry, I hadn't made a note in the PR message here, but: I tried and abandoned that path. (Or more precisely, having exception layouts hang off of the function type; <code>TagType</code> is already a thin newtype wrapper around <code>FuncType</code>.) At a high level, pulling on that string seemed to unwind way too much structure and hit too many places that really still wanted a concrete type for an exception object. If you're curious, my WIP branch is <a href=\"https://github.com/cfallin/wasmtime/tree/wasm-exception-types\">here</a> (still has many type-errors, mid-refactor). In essence I think that path leads to more complexity, not less, unfortunately.</p>\n<blockquote>\n<p>also fewer interactions at runtime with its locking and tables and all that</p>\n</blockquote>\n<p>The current implementation performs no locking or accesses to the type registry at runtime; it uses the dynamic context mechanism in Cranelift to get straight to the instance, then look up tags (<code>VMTagDefinition</code>s), and compares tag IDs (instance-id/defined-tag-index). In particular, the tag information is at a constant offset in the exception object (similar to array lengths) so we don't need a layout to write the generic path.</p>\n<p>(Still on PTO but will respond occasionally to keep review moving)</p>\n</blockquote>",
        "id": 531659937,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753808760
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#pullrequestreview-3068474011\">PR review</a>.</p>",
        "id": 531661043,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753809094
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2240473183\">PR review comment</a>:</p>\n<blockquote>\n<p>Sorry, this is left over from an earlier implementation that fetched layouts dynamically before I had put the tag info at a constant offset in exception objects. (Or rather, it was always at a constant offset per allocator, but I hadn't done the plumbing that array-lengths have to avoid getting it from the layout.)</p>\n<p>I'll remove this; but to clarify, we have no need to access layouts or the type registry at all at runtime with the exceptions implementation. The unwinder is completely generic over exception layouts and only compares tag identities.</p>\n</blockquote>",
        "id": 531661046,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753809094
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#pullrequestreview-3068573567\">PR review</a>.</p>",
        "id": 531667128,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753811140
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2240541583\">PR review comment</a>:</p>\n<blockquote>\n<p>Yes -- it reads two <code>u32</code>s for lengths of arrays, then builds an <code>ExceptionTable</code> with slices over arrays.</p>\n</blockquote>",
        "id": 531667130,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753811140
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#pullrequestreview-3068598497\">PR review</a>.</p>",
        "id": 531668711,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753811628
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2240558447\">PR review comment</a>:</p>\n<blockquote>\n<p>This is in the context of a <code>Call</code> (codegen for a callsite), so the \"caller\" is the current callsite; and this change is pulling out an existing expression that was bound as <code>let caller_vmctx = ...</code> (see the diff in <code>unchecked_call_impl</code> for example). Happy to rename it to something else, but <code>callee_vmctx</code> would be inaccurate/misleading in this context, IMHO. <code>our_vmctx</code> maybe?</p>\n</blockquote>",
        "id": 531668712,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753811628
    },
    {
        "content": "<p>cfallin edited <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2240558447\">PR review comment</a>.</p>",
        "id": 531668746,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753811641
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#pullrequestreview-3068672143\">PR review</a>.</p>",
        "id": 531672184,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753812818
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2240605777\">PR review comment</a>:</p>\n<blockquote>\n<p>Ah, good call; the first two (methods on <code>VMGcRef</code>) can't follow that pattern because <code>VMGcRef</code> is not actually an uninhabitable enum in the GC-disabled build, so I followed that in the <code>From</code> impls as well, but those can follow the empty-match pattern...</p>\n</blockquote>",
        "id": 531672187,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753812818
    },
    {
        "content": "<p>cfallin updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a>.</p>",
        "id": 533888999,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1754959933
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#pullrequestreview-3108194925\">PR review</a>.</p>",
        "id": 533889785,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1754960638
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2268330905\">PR review comment</a>:</p>\n<blockquote>\n<p>(Removed in rebase.)</p>\n</blockquote>",
        "id": 533889786,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1754960639
    },
    {
        "content": "<p>cfallin updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a>.</p>",
        "id": 533891044,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1754961375
    },
    {
        "content": "<p>github-actions[bot] <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#issuecomment-3177609613\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a>:</p>\n<blockquote>\n<h4>Subscribe to Label Action</h4>\n<p>cc @fitzgen</p>\n<p>&lt;details&gt;<br>\nThis issue or pull request has been labeled: \"cranelift\", \"cranelift:area:aarch64\", \"fuzzing\"</p>\n<p>Thus the following users have been cc'd because of the following labels:</p>\n<ul>\n<li>fitzgen: fuzzing</li>\n</ul>\n<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>\n<p><a href=\"https://github.com/bytecodealliance/subscribe-to-label-action\">Learn more.</a><br>\n&lt;/details&gt;</p>\n</blockquote>",
        "id": 533902353,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1754971013
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#pullrequestreview-3112731543\">PR review</a>.</p>",
        "id": 534051839,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755030878
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2271158319\">PR review comment</a>:</p>\n<blockquote>\n<p>We actually need the GC, though, since we allocate (exception) objects, no?</p>\n</blockquote>",
        "id": 534051840,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755030879
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#pullrequestreview-3112732246\">PR review</a>.</p>",
        "id": 534051869,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755030894
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2271158879\">PR review comment</a>:</p>\n<blockquote>\n<p>Sure, happy to do so. I was following precedent in the rest of this parsing code that returns a clean <code>Err</code> on e.g. missing sections; but I agree we don't have to do so, since our overall safety condition is that the loaded code artifact is the exact output that our compile step produced. I'll add a comment noting this.</p>\n</blockquote>",
        "id": 534051870,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755030894
    },
    {
        "content": "<p>cfallin updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a>.</p>",
        "id": 534051944,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755030934
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#pullrequestreview-3112734958\">PR review</a>.</p>",
        "id": 534051948,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755030936
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2271160407\">PR review comment</a>:</p>\n<blockquote>\n<p>Added!</p>\n</blockquote>",
        "id": 534051949,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755030936
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#pullrequestreview-3112735142\">PR review</a>.</p>",
        "id": 534051961,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755030941
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2271160600\">PR review comment</a>:</p>\n<blockquote>\n<p>Done!</p>\n</blockquote>",
        "id": 534051963,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755030941
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#pullrequestreview-3112736235\">PR review</a>.</p>",
        "id": 534052012,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755030960
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2271161578\">PR review comment</a>:</p>\n<blockquote>\n<p>(resolving but feel free to unresolve if you'd like a different name here)</p>\n</blockquote>",
        "id": 534052013,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755030960
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#pullrequestreview-3112736743\">PR review</a>.</p>",
        "id": 534052027,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755030966
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2271161776\">PR review comment</a>:</p>\n<blockquote>\n<p>Done!</p>\n</blockquote>",
        "id": 534052028,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755030966
    },
    {
        "content": "<p>alexcrichton submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#pullrequestreview-3112765327\">PR review</a>.</p>",
        "id": 534053123,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755031501
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2271182829\">PR review comment</a>:</p>\n<blockquote>\n<p>We need Wasmtime's implementation of a GC yeah, but we don't need the GC-the-wasm-proposal which is what <code>WasmFeatures::GC</code> is here. </p>\n<p>Wasmparser's validation is <a href=\"https://github.com/bytecodealliance/wasm-tools/blob/3391156cee997660f992bdd09ca758a429d3a494/crates/wasmparser/src/validator.rs#L288-L292\">here</a> which effectively equates <code>GC_TYPES</code> to \"every heap type other than functions/exceptions\". That's based on a now-incorrect assumption that exnref wouldn't require a GC in wasmtime. </p>\n<p>On another hand though you can probably delete this entirely. If the exceptions proposal is enabled but <code>GC</code> is disabled then we can let the validator figure it out. If <code>GC_TYPES</code> is disabled then the program can't use <code>exnref</code> anywhere. The only real constraint is that if <code>EXCEPTIONS</code> is enabled then <code>feature = \"gc\"</code> should be enabled since our runtime support requires the GC.</p>\n</blockquote>",
        "id": 534053125,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755031501
    },
    {
        "content": "<p>cfallin updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a>.</p>",
        "id": 534059782,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755034998
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#pullrequestreview-3112989184\">PR review</a>.</p>",
        "id": 534060138,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755035237
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2271369088\">PR review comment</a>:</p>\n<blockquote>\n<p>Addressed in 3c48653a25 -- I went with a variant of <code>StoreOpaque::instance_from_vmctx</code>, except with the additional safety requirement that the <code>vmctx</code> be from that store. This is valid/satisfiable from the stack walk because all Wasm frames in an activation (up to entry from host) will belong to instances in a single store; and is nice not just for perf reasons but because I was having trouble reasoning about the aliasing implications of creating an instance pointer <em>first</em>, and reading out its store pointer, then comparing it to see if we return <code>Some</code> or not. (It would be perfectly valid for another thread to own some other <code>Store</code>; that thread could mutate the instance pointers freely per Rust's aliasing rules; so I think we can't have the instance pointer then do the check, we have to know by invariant that it belongs to us first; but fortunately we do.)</p>\n</blockquote>",
        "id": 534060139,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755035237
    },
    {
        "content": "<p>cfallin updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a>.</p>",
        "id": 534060314,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755035352
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#pullrequestreview-3112999339\">PR review</a>.</p>",
        "id": 534060453,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755035429
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2271376029\">PR review comment</a>:</p>\n<blockquote>\n<p>Ah, right, I had been assuming we separately checked that <code>feature = \"gc\"</code> was enabled when the <code>GC</code> feature is enabled at the wasmparser level, then leaning on that as the load-bearing thing to ensure we have <code>feature = \"gc\"</code>. Addressed in a076222f88 -- switched to an explicit check under <code>not(feature = \"gc\")</code> to ensure <code>EXCEPTIONS</code> is not enabled.</p>\n</blockquote>",
        "id": 534060454,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755035430
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#pullrequestreview-3113020428\">PR review</a>.</p>",
        "id": 534061375,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755036014
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2271392055\">PR review comment</a>:</p>\n<blockquote>\n<p>It could, but it adds some complication to parsing, and an empty section is 8 bytes of content (plus the section header of 64 bytes) so IMHO not too big a deal?</p>\n</blockquote>",
        "id": 534061377,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755036015
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#pullrequestreview-3114213551\">PR review</a>.</p>",
        "id": 534170023,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755068915
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2272284089\">PR review comment</a>:</p>\n<blockquote>\n<p>I've been working on this refactor and agree that it's much cleaner, with one caveat: I'm having trouble finding a way to generically provide <code>catch_unwind_and_record_trap</code> with the store (which it needs to compute the exception unwind action). It takes a <code>FnOnce</code> which ordinarily itself carries the unique ownership of the store. The usual idiom would be to take a <code>&amp;mut Store</code> (or moral equivalent) as another arg, and re-pass that into the <code>FnOnce</code>; but the various use-sites use either <code>InstanceAndStore</code> (libcalls; array-call shim), or <code>ComponentInstance</code> (host funcs for the component case), or <code>Caller</code> (typed funcrefs). I suppose we could require the closure to return the <code>HostResult</code> <em>and</em> a mut store borrow of some sort. I'm a little lost with the various wrapper types we have and their invariants, though, and could use some ideas!</p>\n<p>My WIP branch for this refactor is <a href=\"https://github.com/cfallin/wasmtime/tree/wasm-exceptions-wip\">here</a>; see last commit.</p>\n</blockquote>",
        "id": 534170024,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755068915
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#pullrequestreview-3114257484\">PR review</a>.</p>",
        "id": 534171725,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755069692
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2272313116\">PR review comment</a>:</p>\n<blockquote>\n<p>Or said another way -- what I want is I think something like <code>AsContextMut</code>, but at the monomorphized level (for <code>StoreOpaque</code>). I'm not sure whether that's reasonable to build out, or not. I could use a pairing session to work through this, if someone's up for it (@fitzgen or @alexcrichton?).</p>\n</blockquote>",
        "id": 534171726,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755069692
    },
    {
        "content": "<p>cfallin edited <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2272313116\">PR review comment</a>.</p>",
        "id": 534178128,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755072379
    },
    {
        "content": "<p>alexcrichton submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#pullrequestreview-3116379261\">PR review</a>.</p>",
        "id": 534246262,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755096360
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2273704508\">PR review comment</a>:</p>\n<blockquote>\n<p>I'm not sure I quite follow but sounds like you got it working? Certainly happy to talk in more depth or do a closer review later too</p>\n</blockquote>",
        "id": 534246263,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755096360
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#pullrequestreview-3116471029\">PR review</a>.</p>",
        "id": 534251441,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755097781
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2273773598\">PR review comment</a>:</p>\n<blockquote>\n<p><em>kind</em> of -- this does mean that we resolve the exception very late, after it is recorded in the <code>CallThreadState</code>, because the store is fundamentally owned by the closure so we can't have access to it once we get the <code>HostResult</code> (which may be an exception throw). Instead we resolve it when the trampoline re-enters Rust code to call <code>unwind()</code>. That implies that we potentially need a new GC root now if a <code>CallThreadState</code> exists, though perhaps we can rely on the fact that the \"record trap/exception\" and \"unwind\" happen very close to each other and get away with storing a raw <code>VMExnRef</code> instead. Happy to hear thoughts from @fitzgen on that one...</p>\n</blockquote>",
        "id": 534251443,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755097782
    },
    {
        "content": "<p>fitzgen submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#pullrequestreview-3116547113\">PR review</a>.</p>",
        "id": 534254788,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755098859
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2273826642\">PR review comment</a>:</p>\n<blockquote>\n<p>Generally it is okay to store a raw GC ref as long as it is within an <code>AutoAssertNoGc</code> scope, so that we dynamically catch any errors. But creating one of those requires access to a store, which seems like it is the difficult bit here? I'd have to look more into the exact code to say anything more, maybe we can discuss it in the Cranelift meeting today or something</p>\n</blockquote>",
        "id": 534254791,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755098860
    },
    {
        "content": "<p>cfallin updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a>.</p>",
        "id": 534574473,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755214131
    },
    {
        "content": "<p>cfallin updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a>.</p>",
        "id": 534576094,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755215207
    },
    {
        "content": "<p>cfallin updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a>.</p>",
        "id": 534578446,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755216877
    },
    {
        "content": "<p>cfallin updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a>.</p>",
        "id": 534578694,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755217070
    },
    {
        "content": "<p>cfallin updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a>.</p>",
        "id": 534578796,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755217154
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#pullrequestreview-3122494404\">PR review</a>.</p>",
        "id": 534578859,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755217215
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2277991571\">PR review comment</a>:</p>\n<blockquote>\n<p>Addressed in 1f9f65ad4f6bd24d1fe15120845689f1e11bbd46!</p>\n</blockquote>",
        "id": 534578861,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755217216
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#pullrequestreview-3122495000\">PR review</a>.</p>",
        "id": 534578886,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755217237
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2277991880\">PR review comment</a>:</p>\n<blockquote>\n<p>Addressed in 1f9f65ad4f6bd24d1fe15120845689f1e11bbd46!</p>\n</blockquote>",
        "id": 534578887,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755217237
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2277992091\">PR review comment</a>:</p>\n<blockquote>\n<p>Addressed in 1f9f65ad4f6bd24d1fe15120845689f1e11bbd46!</p>\n</blockquote>",
        "id": 534578906,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755217256
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#pullrequestreview-3122495492\">PR review</a>.</p>",
        "id": 534578907,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755217256
    },
    {
        "content": "<p>cfallin updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a>.</p>",
        "id": 534579882,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755218177
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#pullrequestreview-3122516567\">PR review</a>.</p>",
        "id": 534579891,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755218182
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2278006934\">PR review comment</a>:</p>\n<blockquote>\n<p>Done!</p>\n</blockquote>",
        "id": 534579892,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755218183
    },
    {
        "content": "<p>cfallin updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a>.</p>",
        "id": 534580103,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755218386
    },
    {
        "content": "<p>cfallin updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a>.</p>",
        "id": 534580898,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755219068
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#issuecomment-3190310049\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a>:</p>\n<blockquote>\n<p>@alexcrichton @fitzgen I've now done the refactor we discussed and also added support for Wasm-to-host, host-to-Wasm, and host-to-host (via <code>Func::new</code> -&gt; <code>Func::call</code>) exception throws. The remaining bit to address is Pulley support (I suspect this should be relatively straightforward now?) and adding <code>assert_exception</code> to our WAST runner then enabling spec-tests. I believe the core should be ready for another pass.</p>\n</blockquote>",
        "id": 534581134,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755219292
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2279319529\">PR review comment</a>:</p>\n<blockquote>\n<p>I think that this isn't quite true any more? </p>\n</blockquote>",
        "id": 534680299,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755275372
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2279413192\">PR review comment</a>:</p>\n<blockquote>\n<p>I believe this is unsound because there's a rust destructor on the stack (<code>AutoAssertNoGc</code>) which is skipped as part of the longjmp and/or unwind resumption.</p>\n</blockquote>",
        "id": 534680300,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755275372
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2279376017\">PR review comment</a>:</p>\n<blockquote>\n<p>Could the <code>expect</code> here be propagated to the caller? Or otherwise could this have a <code># Panics</code> section of the documentation and be renamed to <code>unwrap_pending_exception</code>?</p>\n</blockquote>",
        "id": 534680301,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755275372
    },
    {
        "content": "<p>alexcrichton submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#pullrequestreview-3124255840\">PR review</a>.</p>",
        "id": 534680302,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755275372
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2279382319\">PR review comment</a>:</p>\n<blockquote>\n<p>Would it be possible to have <code>TrapReason::Exception</code> directly instead of, even at the lowest layers, encoding through the indirection of <code>anyhow::Error</code>?</p>\n</blockquote>",
        "id": 534680303,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755275372
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2279374762\">PR review comment</a>:</p>\n<blockquote>\n<p>Should this <code>debug_assert!</code> the previous exception was none?</p>\n</blockquote>",
        "id": 534680304,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755275372
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2279379686\">PR review comment</a>:</p>\n<blockquote>\n<p>Could <code>unsafe</code> from these two functions be dropped?</p>\n</blockquote>",
        "id": 534680305,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755275372
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2279287840\">PR review comment</a>:</p>\n<blockquote>\n<p>If it's not too difficult to extract, it might be nice to land the refactoring of how exceptions are allocated/managed separately from this PR which has the other runtime/compiler bits.</p>\n</blockquote>",
        "id": 534680306,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755275372
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2279427284\">PR review comment</a>:</p>\n<blockquote>\n<p>Since <code>self.unwind</code> must be set by this function, could this be modeled as:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">reason</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"c1\">// ...</span>\n<span class=\"p\">};</span>\n<span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">unwind</span><span class=\"p\">.</span><span class=\"n\">set</span><span class=\"p\">(</span><span class=\"n\">state</span><span class=\"p\">);</span>\n</code></pre></div>\n<p>to have compiler checks that every arm sets it?<br>\n</p>\n</blockquote>",
        "id": 534680307,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755275372
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2279308701\">PR review comment</a>:</p>\n<blockquote>\n<p>When updating this, mind updating the comment of the pseudo-struct at the top of this file as well?</p>\n<p>Orthogonally, though, I'm a bit concerned about this because it looks like it's basically redundant information in the <code>VMContext</code> where we have one field for the fp of the exit trampoline and one field for the fp of the frame before the exit trampoline. That seems like it'd be very easy to confuse the two. Could the previous field be removed to only have the fp of the exit trampoline which can be used to infer the fp of the previous frame of the trampoline?</p>\n</blockquote>",
        "id": 534680308,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755275372
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2279387240\">PR review comment</a>:</p>\n<blockquote>\n<p>Could this be updated to disable <code>wasm_gc</code> and <code>wasm_function_references</code>, or not explictily enable them, since they shouldn't be required?</p>\n</blockquote>",
        "id": 534680309,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755275372
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2279367368\">PR review comment</a>:</p>\n<blockquote>\n<p>Instead of implementing these on a public type, could these be implemented on a private internal type? That way we don't have to worry about these details leaking through into the public API</p>\n</blockquote>",
        "id": 534680310,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755275372
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2279315932\">PR review comment</a>:</p>\n<blockquote>\n<p>Mind adding <code># Safety</code> documentation to the function, as well as <code>// SAFETY: ...</code> docs to the <code>unsafe</code> block?</p>\n</blockquote>",
        "id": 534680311,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755275372
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2279373057\">PR review comment</a>:</p>\n<blockquote>\n<p>I think this is copy/pasted from <code>vm/instance.rs</code>, could this be encapsulated over there to avoid having the duplication so far from the original source?</p>\n</blockquote>",
        "id": 534680312,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755275373
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#pullrequestreview-3124571400\">PR review</a>.</p>",
        "id": 534684166,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755277241
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2279500455\">PR review comment</a>:</p>\n<blockquote>\n<p>The thing is that these <em>are</em> necessary for the public API -- the way that a <code>Func</code> throws an exception to its caller is to return an <code>Err</code> with a boxed <code>Rooted&lt;ExnRef&gt;</code>, so we need to implement <code>Error</code> (and its required trait <code>Display</code> in turn).</p>\n<p>Perhaps we could wrap this further, e.g. wrap <code>Rooted&lt;ExnRef&gt;</code> in an <code>Exception</code> type. The <a href=\"https://github.com/bytecodealliance/rfcs/blob/main/accepted/exception-handling.md\">RFC</a> describes this as option 4 for the host API -- I had figured that the exnref itself serves that purpose, but we could give it a nicer type for sure. Thoughts?</p>\n</blockquote>",
        "id": 534684167,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755277241
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#pullrequestreview-3124591069\">PR review</a>.</p>",
        "id": 534684877,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755277580
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2279512872\">PR review comment</a>:</p>\n<blockquote>\n<p>Woah, I'm surprised my tests didn't catch that -- it will leave the no-GC state set, even, keeping the store in a broken state. (I suppose not so surprised, with only short test cases.) Thanks for catching this!</p>\n</blockquote>",
        "id": 534684878,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755277580
    },
    {
        "content": "<p>alexcrichton submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#pullrequestreview-3124668771\">PR review</a>.</p>",
        "id": 534688888,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755279540
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2279565415\">PR review comment</a>:</p>\n<blockquote>\n<p>Structurally something about this is going to need to be adjusted, but I'm not sure how best that would be done. My understanding of this is that anything rooted in <code>catch_unwind_and_record_trap</code> effectively needs to have this logic applied. The code here works for <code>Func::new</code> and <code>Linker::func_new</code>, but there's a lot of other locations that this isn't applied to just yet:</p>\n<ul>\n<li><code>Func::new_unchecked</code> / <code>Linker::func_new_unchecked</code></li>\n<li><code>Func::wrap</code> / <code>Linker::func_wrap</code></li>\n<li>Core wasm libcalls -- unsure how applicable this is, but it's possible to for example have an embedder-defined error throw in <code>ResourceLimiter</code> which ostensibly could be an <code>ExnRef</code>, so in theory <code>memory.grow</code> could be embedder-defined to raise an exception</li>\n<li>Component host functions</li>\n<li>Component libcalls (probably less applicable than core wasm libcalls)</li>\n</ul>\n<p>Overall our story for entering/exiting wasm is pretty messy unfortunately. For example one could argue that <code>CallHook::{CallingHost,ReturningFromHost}</code> should be invoked for libcalls but they aren't. Otherwise handling that is already duplicated across components and core wasm.</p>\n<p>Personally I think the best option is going to be to hook into <code>catch_unwind_and_record_trap</code> directly since that's the \"narrow waist\" for everything anyway. IIRC though you were saying how that's not feasible today since it doesn't have a store nor can easily get a store. I think I see how to do this, so I'll work on a separate PR to thread a store into <code>catch_unwind_and_record_trap</code> for this PR to hook into. </p>\n</blockquote>",
        "id": 534688889,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755279540
    },
    {
        "content": "<p>cfallin updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a>.</p>",
        "id": 534690089,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755280192
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#pullrequestreview-3124695647\">PR review</a>.</p>",
        "id": 534690247,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755280272
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2279584220\">PR review comment</a>:</p>\n<blockquote>\n<p>Great point re: the redundancy -- I was hesitant at first to remove the original Wasm-frame exit FP field, but now I've done that in 3f542bb08e. As a bonus, trampolines are even shorter (no load-from-FP-to-get-Wasm-FP).</p>\n<p>Re: comment -- the pseudo-struct comment doesn't describe these fields, only one field for <code>VMStoreContext</code>. I did grep for <code>last_wasm_exit_fp</code> and try to ensure I updated anything relevant...</p>\n</blockquote>",
        "id": 534690248,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755280272
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#pullrequestreview-3124706553\">PR review</a>.</p>",
        "id": 534690813,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755280568
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2279592165\">PR review comment</a>:</p>\n<blockquote>\n<p>I tried to bottom out all of the ways that host functions could be provided and it did seem to all lead to <code>HostFunc</code> -- perhaps I missed somewhere. This is unfortunately the best we can do though unless we do have a store in <code>catch_unwind_and_record_trap</code>, as far as I can tell. I agree the whole situation is kind of horrific right now...</p>\n</blockquote>",
        "id": 534690815,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755280568
    },
    {
        "content": "<p>cfallin updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a>.</p>",
        "id": 534693814,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755281989
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#pullrequestreview-3124765662\">PR review</a>.</p>",
        "id": 534693820,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755281992
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2279630699\">PR review comment</a>:</p>\n<blockquote>\n<p>Updated!</p>\n</blockquote>",
        "id": 534693823,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755281992
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#pullrequestreview-3124765892\">PR review</a>.</p>",
        "id": 534693833,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755281999
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2279630930\">PR review comment</a>:</p>\n<blockquote>\n<p>Updated!</p>\n</blockquote>",
        "id": 534693834,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755281999
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#pullrequestreview-3124768607\">PR review</a>.</p>",
        "id": 534693993,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755282088
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2279633135\">PR review comment</a>:</p>\n<blockquote>\n<p>Done!</p>\n</blockquote>",
        "id": 534693995,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755282088
    },
    {
        "content": "<p>alexcrichton submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#pullrequestreview-3124769043\">PR review</a>.</p>",
        "id": 534694015,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755282102
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2279633486\">PR review comment</a>:</p>\n<blockquote>\n<p>IMO this required duplication if we don't have a store when handling traps is motivation to push harder on getting a store available while handling traps. I've done this refactoring <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11441\">https://github.com/bytecodealliance/wasmtime/pull/11441</a> which I believe means that this code here can be scoped to <code>HostResult</code> implementations which can now easily access the store.</p>\n</blockquote>",
        "id": 534694016,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755282103
    },
    {
        "content": "<p>cfallin updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a>.</p>",
        "id": 534698301,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755284112
    },
    {
        "content": "<p>cfallin updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a>.</p>",
        "id": 534719818,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755296814
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#issuecomment-3192908879\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a>:</p>\n<blockquote>\n<p>I've refactored on top of #11441 and this is indeed much nicer; I've removed the <code>From</code> impls that would otherwise pass through boxed exceptions from hostcalls without converting to a pending exception, so I'm more confident we won't miss any additional hostcall paths now.</p>\n<p>The current challenge is dealing with rooting: the factor has placed the point at which we capture the <code>Rooted&lt;ExnRef&gt;</code> (refactor to wrap that up in a <code>wasmtime::Exception</code> TBD) outside the root handle scope for the hostcall, so any newly allocated exception from the host becomes unrooted. Pulling this string further may require additional refactors to put the LIFO-scope management in common across all hostcalls; just starting to look into this. More thoughts (or a pairing session if that'd be easier) welcome, @alexcrichton...</p>\n</blockquote>",
        "id": 534720004,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755296961
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#pullrequestreview-3125293437\">PR review</a>.</p>",
        "id": 534720035,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755296989
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2279982897\">PR review comment</a>:</p>\n<blockquote>\n<p>Resolved in refactor (modulo rooting issues below)!</p>\n</blockquote>",
        "id": 534720037,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755296990
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#pullrequestreview-3125293633\">PR review</a>.</p>",
        "id": 534720053,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755297001
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2279983074\">PR review comment</a>:</p>\n<blockquote>\n<p>Done!</p>\n</blockquote>",
        "id": 534720054,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755297001
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#pullrequestreview-3125293820\">PR review</a>.</p>",
        "id": 534720067,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755297011
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2279983209\">PR review comment</a>:</p>\n<blockquote>\n<p>Fixed!</p>\n</blockquote>",
        "id": 534720068,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755297012
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#pullrequestreview-3125294042\">PR review</a>.</p>",
        "id": 534720088,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755297025
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2279983438\">PR review comment</a>:</p>\n<blockquote>\n<p>Yep, this makes more sense -- removed now in refactor.</p>\n</blockquote>",
        "id": 534720090,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755297025
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#pullrequestreview-3125294116\">PR review</a>.</p>",
        "id": 534720097,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755297030
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2279983517\">PR review comment</a>:</p>\n<blockquote>\n<p>Done!</p>\n</blockquote>",
        "id": 534720098,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755297030
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#pullrequestreview-3125294398\">PR review</a>.</p>",
        "id": 534720130,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755297048
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2279983791\">PR review comment</a>:</p>\n<blockquote>\n<p>Done!</p>\n</blockquote>",
        "id": 534720131,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755297048
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#issuecomment-3192950123\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a>:</p>\n<blockquote>\n<p>Oh good point! I think it'd be reasonable to move <a href=\"https://github.com/bytecodealliance/wasmtime/blob/6f6a514b717d323f80d4a810756fb62212d1cc8e/crates/wasmtime/src/runtime/func.rs#L2066-L2079\">this management</a> into the trap-handling bits (or around the <code>enter_host_from_wasm</code> bits). That future-proofs this for component-model-gc support and additionally enables eventually cleaning up libcalls that currently create their own scopes as they no longer need to</p>\n</blockquote>",
        "id": 534721311,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755298168
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#issuecomment-3192952035\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a>:</p>\n<blockquote>\n<p>Actually, I think there are deeper issues with rooting, exceptions, and <code>Result</code> / <code>?</code> ergonomics that we didn't really address in the RFC, and I'm finding I'm bumping into these design questions now. The current state of this PR has working-but-for-unrooted-ref-panics in <code>cargo test --test all -- exceptions</code>, demonstrating a few examples of the issue.</p>\n<p>The basic question is: if we return an exception as a GC object boxed in a <code>Rooted&lt;ExnRef&gt;</code> (eventually inside a nicely-packaged <code>wasmtime::Exception</code> type) in the <code>Err</code> arm of a <code>Result</code>, how should we expect this to interact nicely with handle scopes?</p>\n<p>The most basic example is a host function that allocates an <code>ExnRef</code> and returns <code>Err(exnref.into())</code>, and has no other scopes of its own. We can fix up this PR by moving the root scope teardown outside of the point that we root a pending exception on the store, so that can work fine.</p>\n<p>But in the general case, with user host code creating nested <code>RootScope</code>s, we cannot really expect automatic <code>?</code> passing-up-the-<code>Err</code> to work well. Consider:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">my_hostcall</span><span class=\"p\">(</span><span class=\"o\">..</span><span class=\"p\">.)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"p\">()</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">scope</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">RootScope</span><span class=\"p\">::</span><span class=\"n\">new</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">caller</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"n\">helper</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">scope</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"nb\">Ok</span><span class=\"p\">(())</span>\n<span class=\"p\">}</span>\n\n<span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">helper</span><span class=\"p\">(</span><span class=\"n\">ctx</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">impl</span><span class=\"w\"> </span><span class=\"n\">AsContextMut</span><span class=\"o\">&lt;'</span><span class=\"nb\">_</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"p\">.)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"p\">()</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"nb\">Err</span><span class=\"p\">(</span><span class=\"n\">ExnRef</span><span class=\"p\">::</span><span class=\"n\">new</span><span class=\"p\">(</span><span class=\"o\">..</span><span class=\"p\">.).</span><span class=\"n\">into</span><span class=\"p\">());</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>This will typecheck fine (<code>ExnRef::new()</code> returns a <code>Rooted&lt;ExnRef&gt;</code>, we currently take that as an <code>Error</code> impl directly, we can wrap it up in <code>wasmtime::Exception</code> once I do that); but the exception object will be unrooted once the <code>?</code> propagates it past the user's own <code>RootScope</code>.</p>\n<p>More generally, <code>Err</code>-carried types should generally expect to <em>own</em> their error information. Our lack of lifetimes to denote valid scope is an explicit ergonomic choice, which is great in general, but hides the fact that we will get a dynamic scope-violation (unrooting) error here.</p>\n<p>Should we use a <code>ManuallyRooted</code> instead? I think that's much worse -- it's way too easy to leak, since its <code>Drop</code> impl doesn't unroot (because it can't, because it doesn't have a mut borrow of the <code>Store</code> -- again a totally valid choice that is nice in 99% of cases).</p>\n<p>It's somewhat tempting to say \"don't do that\" to all of this -- it's no different than returning any GC ref type at all. If we take this option, we just fix the exact extent of the root scope when calling out to the host, we root any returned exception when it comes back (concretely: put the <code>HostResult</code> conversion <em>inside</em> the root scope somehow, probably by pulling the scope out to <code>catch_and_record_traps</code>). My broader concern here is that I'm not sure that it has the nice error-propagation properties that we expected. Basically, it's a nonlocal/non-composable footgun: anyone creating a scope anywhere inside complex host logic could cause an exception created on deep to blow up dynamically with a panic.</p>\n<p>One alternative is to have an explicit <code>store.throw(exn)</code> as part of the public API, and then provide a <em>public-facing</em> tombstone type that the user can propagate upward through <code>Result</code>s. This does make things a little weird in other ways, because it's implicit state (we could have an API around \"cancel pending exception\" too if someone wants to \"catch\" it in host code), but it feels the least footgunny in a lot of others. Basically it's extending what we decided to do internally (root the exception on the store, safely) to user code.</p>\n<p>The last option does differ from what we agreed to in the RFC (but the RFC is underspecified with respect to rooting behavior in general, on the other hand) -- so I'd want some consensus here, at least, before building that. Any thoughts?</p>\n</blockquote>",
        "id": 534721413,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755298275
    },
    {
        "content": "<p>cfallin edited a <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#issuecomment-3192952035\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a>:</p>\n<blockquote>\n<p>Actually, I think there are deeper issues with rooting, exceptions, and <code>Result</code> / <code>?</code> ergonomics that we didn't really address in the RFC, and I'm finding I'm bumping into these design questions now. The current state of this PR has working-but-for-unrooted-ref-panics examples of all directions of exception transfer in <code>cargo test --test all -- exceptions</code>, demonstrating a few examples of the issue.</p>\n<p>The basic question is: if we return an exception as a GC object boxed in a <code>Rooted&lt;ExnRef&gt;</code> (eventually inside a nicely-packaged <code>wasmtime::Exception</code> type) in the <code>Err</code> arm of a <code>Result</code>, how should we expect this to interact with handle scopes?</p>\n<p>The most basic example is a host function that allocates an <code>ExnRef</code> and returns <code>Err(exnref.into())</code>, and has no other scopes of its own. We can fix up this PR by moving the root scope teardown outside of the point that we root a pending exception on the store, so that can work fine.</p>\n<p>But in the general case, with user host code creating nested <code>RootScope</code>s, we cannot really expect automatic <code>?</code> passing-up-the-<code>Err</code> to work well. Consider:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">my_hostcall</span><span class=\"p\">(</span><span class=\"o\">..</span><span class=\"p\">.)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"p\">()</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">scope</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">RootScope</span><span class=\"p\">::</span><span class=\"n\">new</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">caller</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"n\">helper</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">scope</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"nb\">Ok</span><span class=\"p\">(())</span>\n<span class=\"p\">}</span>\n\n<span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">helper</span><span class=\"p\">(</span><span class=\"n\">ctx</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">impl</span><span class=\"w\"> </span><span class=\"n\">AsContextMut</span><span class=\"o\">&lt;'</span><span class=\"nb\">_</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"p\">.)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"p\">()</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"nb\">Err</span><span class=\"p\">(</span><span class=\"n\">ExnRef</span><span class=\"p\">::</span><span class=\"n\">new</span><span class=\"p\">(</span><span class=\"o\">..</span><span class=\"p\">.).</span><span class=\"n\">into</span><span class=\"p\">());</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>This will typecheck fine (<code>ExnRef::new()</code> returns a <code>Rooted&lt;ExnRef&gt;</code>, we currently take that as an <code>Error</code> impl directly, we can wrap it up in <code>wasmtime::Exception</code> once I do that); but the exception object will be unrooted once the <code>?</code> propagates it past the user's own <code>RootScope</code>.</p>\n<p>More generally, <code>Err</code>-carried types should generally expect to <em>own</em> their error information. Our lack of lifetimes to denote valid scope is an explicit ergonomic choice, which is great in general, but hides the fact that we will get a dynamic scope-violation (unrooting) error here.</p>\n<p>Should we use a <code>ManuallyRooted</code> instead? I think that's much worse -- it's way too easy to leak, since its <code>Drop</code> impl doesn't unroot (because it can't, because it doesn't have a mut borrow of the <code>Store</code> -- again a totally valid choice that is nice in 99% of cases).</p>\n<p>It's somewhat tempting to say \"don't do that\" to all of this -- it's no different than returning any GC ref type at all. If we take this option, we just fix the exact extent of the root scope when calling out to the host, we root any returned exception when it comes back (concretely: put the <code>HostResult</code> conversion <em>inside</em> the root scope somehow, probably by pulling the scope out to <code>catch_and_record_traps</code>). My broader concern here is that I'm not sure that it has the nice error-propagation properties that we expected. Basically, it's a nonlocal/non-composable footgun: anyone creating a scope anywhere inside complex host logic could cause an exception created on deep to blow up dynamically with a panic.</p>\n<p>One alternative is to have an explicit <code>store.throw(exn)</code> as part of the public API, and then provide a <em>public-facing</em> tombstone type that the user can propagate upward through <code>Result</code>s. This does make things a little weird in other ways, because it's implicit state (we could have an API around \"cancel pending exception\" too if someone wants to \"catch\" it in host code), but it feels the least footgunny in a lot of others. Basically it's extending what we decided to do internally (root the exception on the store, safely) to user code.</p>\n<p>The last option does differ from what we agreed to in the RFC (but the RFC is underspecified with respect to rooting behavior in general, on the other hand) -- so I'd want some consensus here, at least, before building that. Any thoughts?</p>\n</blockquote>",
        "id": 534721458,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755298329
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#issuecomment-3193013280\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a>:</p>\n<blockquote>\n<p>Good points!</p>\n<blockquote>\n<p>Basically, it's a nonlocal/non-composable footgun</p>\n</blockquote>\n<p>To some degree this is inherently true of <code>Rooted</code> and <code>ManuallyRooted</code>. As you point out there's big downsides to using both. That being said I do agree this is particularly exacerbated due to the nature of \"just propagate the error upwards please\" which makes it more likely an exception might fly all the way up past whatever scopes are in use.</p>\n<blockquote>\n<p>One alternative is to have an explicit store.throw(exn) as part of the public API</p>\n</blockquote>\n<p>I like this approach personally. What I might recommend is something like <code>StoreContextMut::throw(&amp;mut self, &amp;Rooted&lt;ExnRef&gt;) -&gt; wasmtime::ThrownException</code> so that way the user doesn't have to create the tombstone themselves and can immediately return that error upwards the stack.</p>\n</blockquote>",
        "id": 534724638,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755301709
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#issuecomment-3193132462\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a>:</p>\n<blockquote>\n<blockquote>\n<p><code>wasmtime::ThrownException</code> so that way the user doesn't have to create the tombstone themselves and can immediately return that error upwards the stack.</p>\n</blockquote>\n<p>Indeed, that was my thought as well. I suppose one could actually also have a signature <code>throw(...) -&gt; Result&lt;Uninhabited, ThrownException&gt;</code> so that one could do <code>store.throw(exn)?;</code> -- or both, <code>thrown_exception(...) -&gt; ThrownException</code> and <code>throw(...)</code> -- but at this point I'm bikeshedding a bit. I'll prototype this to see how it feels.</p>\n</blockquote>",
        "id": 534729841,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755308566
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#issuecomment-3197374018\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a>:</p>\n<blockquote>\n<p>I'd recommend choosing between:</p>\n<ul>\n<li><code>fn throw(&amp;mut self, exn: &amp;Rooted&lt;ExnRef&gt;) -&gt; SomeExceptionType;</code></li>\n<li><code>fn throw&lt;T&gt;(&amp;mut self, exn: &amp;Rooted&lt;ExnRef&gt;) -&gt; Result&lt;T, SomeExceptionType&gt;;</code></li>\n</ul>\n<p>where the latter uses a generic <code>T</code> instead of <code>Uninhabited</code> so that way it can be coerced to any possible type without casts/etc. I'd be on the fence myself about these two signatures, I agree that using <code>?</code> would be nice. One possible compromise could be a <code>Result</code>-based <code>throw</code> for convenience and a method on <code>ExnRef</code> for creating <code>SomeExceptionType</code>, so that way we have both and whatever's most appropriate can be used?</p>\n</blockquote>",
        "id": 534974185,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755530522
    },
    {
        "content": "<p>cfallin updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a>.</p>",
        "id": 535065475,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755586618
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#issuecomment-3199483592\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a>:</p>\n<blockquote>\n<p>Alright, I've built this out -- the API on <code>Store</code> and friends now has a <code>throw</code> as described, and in addition to the lower-level <code>{take,set,has}_pending_exception()</code>, also has a <code>catch</code> helper so one can do something like</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">catch</span><span class=\"p\">(</span><span class=\"o\">|</span><span class=\"n\">store</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">exn</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"p\">.;</span>\n<span class=\"w\">    </span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">throw</span><span class=\"p\">(</span><span class=\"n\">exn</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"nb\">Ok</span><span class=\"p\">(())</span>\n<span class=\"w\">  </span><span class=\"p\">},</span>\n<span class=\"w\">  </span><span class=\"o\">|</span><span class=\"n\">store</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">exn</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"nb\">Err</span><span class=\"p\">(</span><span class=\"s\">\"caught an exception\"</span><span class=\"p\">.</span><span class=\"n\">into</span><span class=\"p\">())</span>\n<span class=\"w\">  </span><span class=\"p\">})</span><span class=\"o\">?</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>or similar.</p>\n<hr>\n<p>This just needs</p>\n<ul>\n<li>[ ] Pulley support</li>\n<li>[ ] WAST driver <code>assert_exception</code> support</li>\n<li>[ ] turn on spec tests</li>\n</ul>\n<p>then I'll flip off the \"draft\" flag.</p>\n</blockquote>",
        "id": 535065931,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755586840
    },
    {
        "content": "<p>cfallin updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a>.</p>",
        "id": 535067142,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755587373
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2285866499\">PR review comment</a>:</p>\n<blockquote>\n<p>Resolved in latest refactor.</p>\n</blockquote>",
        "id": 535172898,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755623727
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#pullrequestreview-3133181159\">PR review</a>.</p>",
        "id": 535172899,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755623727
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#pullrequestreview-3133181724\">PR review</a>.</p>",
        "id": 535172937,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755623740
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2285866892\">PR review comment</a>:</p>\n<blockquote>\n<p>Done!</p>\n</blockquote>",
        "id": 535172938,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755623740
    },
    {
        "content": "<p>cfallin updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a>.</p>",
        "id": 535174165,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755624293
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#pullrequestreview-3133206497\">PR review</a>.</p>",
        "id": 535174185,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755624302
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2285885951\">PR review comment</a>:</p>\n<blockquote>\n<p>Done in 45415e4886!</p>\n</blockquote>",
        "id": 535174189,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755624303
    },
    {
        "content": "<p>cfallin updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a>.</p>",
        "id": 535180500,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755626939
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#issuecomment-3201732110\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a>:</p>\n<blockquote>\n<p>New final boss appears: Pulley support will, I think, require refactoring how setjmp/longjmp is emulated. Right now Pulley <a href=\"https://github.com/bytecodealliance/wasmtime/blob/f8177c201e466ace97a3ce00be69adae8627ddd1/crates/wasmtime/src/runtime/vm/interpreter.rs#L237-L240\">special-cases the <code>raise()</code> libcall</a> and does an interpreter-register-level longjmp across all Wasm frames.</p>\n<p>I believe what we'll ideally want to do instead, to avoid too much duplication in an alternative <code>raise()</code> impl, is to actually invoke the real implementation but then indirect the longjmp through a match on the store's executor: either a real longjmp to the real <code>jmp_buf</code> in the <code>CallThreadState</code>, or a mutation of the interpreter state and a return. Then similarly <code>wasmtime_unwinder::resume_to_exception_handler</code> can have another \"host\" backend that takes the store, fetches the interpreter state, and updates it.</p>\n<p>The alternative is to try to get access to the store inside the Pulley <code>CallIndirectHost</code> impl and determine its <code>UnwindState</code>, but that seems to pull in too much across abstraction boundaries -- for example, it requires Pulley to take the exception payload off the store's root (i.e., have access to the full <code>Store</code>, not just some slice of it).</p>\n<p>I'm tempted to try to land this first and defer Pulley support to a separate PR, with some help (probably from @alexcrichton) to determine the best path here -- it's somewhat close (the stackwalk works fine!) but definitely not trivial.</p>\n</blockquote>",
        "id": 535181578,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755627421
    },
    {
        "content": "<p>cfallin updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a>.</p>",
        "id": 535181723,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755627490
    },
    {
        "content": "<p>cfallin updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a>.</p>",
        "id": 535182243,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755627734
    },
    {
        "content": "<p>cfallin edited a <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#issuecomment-3199483592\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a>:</p>\n<blockquote>\n<p>Alright, I've built this out -- the API on <code>Store</code> and friends now has a <code>throw</code> as described, and in addition to the lower-level <code>{take,set,has}_pending_exception()</code>, also has a <code>catch</code> helper so one can do something like</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">catch</span><span class=\"p\">(</span><span class=\"o\">|</span><span class=\"n\">store</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">exn</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"p\">.;</span>\n<span class=\"w\">    </span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">throw</span><span class=\"p\">(</span><span class=\"n\">exn</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"nb\">Ok</span><span class=\"p\">(())</span>\n<span class=\"w\">  </span><span class=\"p\">},</span>\n<span class=\"w\">  </span><span class=\"o\">|</span><span class=\"n\">store</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">exn</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"nb\">Err</span><span class=\"p\">(</span><span class=\"s\">\"caught an exception\"</span><span class=\"p\">.</span><span class=\"n\">into</span><span class=\"p\">())</span>\n<span class=\"w\">  </span><span class=\"p\">})</span><span class=\"o\">?</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>or similar.</p>\n<hr>\n<p>This just needs</p>\n<ul>\n<li>[ ] <del>Pulley support</del></li>\n<li>[ ] WAST driver <code>assert_exception</code> support</li>\n<li>[ ] turn on spec tests</li>\n</ul>\n<p>then I'll flip off the \"draft\" flag.</p>\n</blockquote>",
        "id": 535182292,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755627763
    },
    {
        "content": "<p>cfallin edited a <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#issuecomment-3199483592\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a>:</p>\n<blockquote>\n<p>Alright, I've built this out -- the API on <code>Store</code> and friends now has a <code>throw</code> as described, and in addition to the lower-level <code>{take,set,has}_pending_exception()</code>, also has a <code>catch</code> helper so one can do something like</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">catch</span><span class=\"p\">(</span><span class=\"o\">|</span><span class=\"n\">store</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">exn</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"p\">.;</span>\n<span class=\"w\">    </span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">throw</span><span class=\"p\">(</span><span class=\"n\">exn</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"nb\">Ok</span><span class=\"p\">(())</span>\n<span class=\"w\">  </span><span class=\"p\">},</span>\n<span class=\"w\">  </span><span class=\"o\">|</span><span class=\"n\">store</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">exn</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"nb\">Err</span><span class=\"p\">(</span><span class=\"s\">\"caught an exception\"</span><span class=\"p\">.</span><span class=\"n\">into</span><span class=\"p\">())</span>\n<span class=\"w\">  </span><span class=\"p\">})</span><span class=\"o\">?</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>or similar.</p>\n<hr>\n<p>This just needs</p>\n<ul>\n<li>[x] <del>Pulley support</del></li>\n<li>[ ] WAST driver <code>assert_exception</code> support</li>\n<li>[ ] turn on spec tests</li>\n</ul>\n<p>then I'll flip off the \"draft\" flag.</p>\n</blockquote>",
        "id": 535182301,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755627766
    },
    {
        "content": "<p>cfallin updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a>.</p>",
        "id": 535197176,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755634581
    },
    {
        "content": "<p>fitzgen <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#issuecomment-3202119265\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a>:</p>\n<blockquote>\n<blockquote>\n<p>I'm tempted to try to land this first and defer Pulley support to a separate PR, with some help (probably from @alexcrichton) to determine the best path here -- it's somewhat close (the stackwalk works fine!) but definitely not trivial.</p>\n</blockquote>\n<p>SGTM, we have a history of landing support for new Wasm proposals a backend at a time (e.g. tail calls, ref types) and as long as there isn't a fundamental reason an implementation approach can't be extended to the unsupported backends that would require redoing the supported backends, then I don't see any reason for disallowing incremental PRs.</p>\n</blockquote>",
        "id": 535198621,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755635199
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#issuecomment-3202143075\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a>:</p>\n<blockquote>\n<p>Agreed yeah definitely feel free to defer Pulley, I'm happy to dive in afterwards and/or have a call to discuss how best to get it working</p>\n</blockquote>",
        "id": 535199732,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755635703
    },
    {
        "content": "<p>cfallin updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a>.</p>",
        "id": 535205878,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755639001
    },
    {
        "content": "<p>cfallin updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a>.</p>",
        "id": 535207956,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755640183
    },
    {
        "content": "<p>cfallin updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a>.</p>",
        "id": 535208843,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755640738
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#issuecomment-3202377129\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a>:</p>\n<blockquote>\n<p>The full test suite is passing now!</p>\n<p>There's quite a lot of rebase churn with the ongoing refactors on main -- to avoid too much rebase pain I'm going to re-squash down to one commit then rebase that as a unit (rather than fixing conflicts at each of N steps). Then I'll see how easy it is to pull out the refactor to exception object layouts (to have one tag slot and share more with structs) -- no guarantees on that. Either way, will mark ready once it's static.</p>\n</blockquote>",
        "id": 535209123,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755640900
    },
    {
        "content": "<p>cfallin edited a <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#issuecomment-3199483592\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a>:</p>\n<blockquote>\n<p>Alright, I've built this out -- the API on <code>Store</code> and friends now has a <code>throw</code> as described, and in addition to the lower-level <code>{take,set,has}_pending_exception()</code>, also has a <code>catch</code> helper so one can do something like</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">catch</span><span class=\"p\">(</span><span class=\"o\">|</span><span class=\"n\">store</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">exn</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"p\">.;</span>\n<span class=\"w\">    </span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">throw</span><span class=\"p\">(</span><span class=\"n\">exn</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"nb\">Ok</span><span class=\"p\">(())</span>\n<span class=\"w\">  </span><span class=\"p\">},</span>\n<span class=\"w\">  </span><span class=\"o\">|</span><span class=\"n\">store</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">exn</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"nb\">Err</span><span class=\"p\">(</span><span class=\"s\">\"caught an exception\"</span><span class=\"p\">.</span><span class=\"n\">into</span><span class=\"p\">())</span>\n<span class=\"w\">  </span><span class=\"p\">})</span><span class=\"o\">?</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>or similar.</p>\n<hr>\n<p>This just needs</p>\n<ul>\n<li>[x] <del>Pulley support</del></li>\n<li>[x] WAST driver <code>assert_exception</code> support</li>\n<li>[ ] turn on spec tests</li>\n</ul>\n<p>then I'll flip off the \"draft\" flag.</p>\n</blockquote>",
        "id": 535209137,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755640906
    },
    {
        "content": "<p>cfallin edited a <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#issuecomment-3199483592\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a>:</p>\n<blockquote>\n<p>Alright, I've built this out -- the API on <code>Store</code> and friends now has a <code>throw</code> as described, and in addition to the lower-level <code>{take,set,has}_pending_exception()</code>, also has a <code>catch</code> helper so one can do something like</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">catch</span><span class=\"p\">(</span><span class=\"o\">|</span><span class=\"n\">store</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">exn</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"p\">.;</span>\n<span class=\"w\">    </span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">throw</span><span class=\"p\">(</span><span class=\"n\">exn</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"nb\">Ok</span><span class=\"p\">(())</span>\n<span class=\"w\">  </span><span class=\"p\">},</span>\n<span class=\"w\">  </span><span class=\"o\">|</span><span class=\"n\">store</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">exn</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"nb\">Err</span><span class=\"p\">(</span><span class=\"s\">\"caught an exception\"</span><span class=\"p\">.</span><span class=\"n\">into</span><span class=\"p\">())</span>\n<span class=\"w\">  </span><span class=\"p\">})</span><span class=\"o\">?</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>or similar.</p>\n<hr>\n<p>This just needs</p>\n<ul>\n<li>[x] <del>Pulley support</del></li>\n<li>[x] WAST driver <code>assert_exception</code> support</li>\n<li>[x] turn on spec tests</li>\n</ul>\n<p>then I'll flip off the \"draft\" flag.</p>\n</blockquote>",
        "id": 535209139,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755640908
    },
    {
        "content": "<p>cfallin updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a>.</p>",
        "id": 535209723,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755641254
    },
    {
        "content": "<p>cfallin updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a>.</p>",
        "id": 535211382,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755642403
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#pullrequestreview-3134036736\">PR review</a>.</p>",
        "id": 535211537,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755642498
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326#discussion_r2286477616\">PR review comment</a>:</p>\n<blockquote>\n<p>Done (#11467)!</p>\n</blockquote>",
        "id": 535211538,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755642499
    },
    {
        "content": "<p>cfallin updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a>.</p>",
        "id": 535211718,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755642655
    },
    {
        "content": "<p><strong>cfallin</strong> has marked <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a> as ready for review.</p>",
        "id": 535211734,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755642665
    },
    {
        "content": "<p><strong>cfallin</strong> requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-default-reviewers\">wasmtime-default-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a>.</p>",
        "id": 535211736,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755642666
    },
    {
        "content": "<p><strong>cfallin</strong> requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-fuzz-reviewers\">wasmtime-fuzz-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a>.</p>",
        "id": 535211737,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755642666
    },
    {
        "content": "<p><strong>cfallin</strong> requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers\">wasmtime-core-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a>.</p>",
        "id": 535211738,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755642666
    },
    {
        "content": "<p><strong>cfallin</strong> requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers\">wasmtime-compiler-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a>.</p>",
        "id": 535211739,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755642666
    },
    {
        "content": "<p><strong>cfallin</strong> requested <a href=\"https://github.com/alexcrichton\">alexcrichton</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">PR #11326</a>.</p>",
        "id": 535211740,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755642666
    }
]
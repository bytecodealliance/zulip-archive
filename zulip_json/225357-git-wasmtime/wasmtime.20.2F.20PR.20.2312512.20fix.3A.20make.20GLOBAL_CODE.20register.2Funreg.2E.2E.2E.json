[
    {
        "content": "<p>zacharywhitley opened <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12512\">PR #12512</a> from <code>tegmentum:fix/global-code-registry-idempotent</code> to <code>bytecodealliance:main</code>:</p>\n<blockquote>\n<h2>Summary</h2>\n<p>This PR makes <code>register_code</code> and <code>unregister_code</code> operations idempotent to prevent SIGABRT crashes caused by virtual address reuse in long-running processes.</p>\n<p>Fixes #12511</p>\n<h2>Problem</h2>\n<p>When creating and destroying many <code>Engine</code> and <code>Module</code> instances, the OS can reuse virtual addresses before all <code>Arc&lt;CodeMemory&gt;</code> references are fully released. This causes:</p>\n<ol>\n<li>\n<p><strong>Duplicate registration</strong>: New engine gets same address as old engine whose Arc hasn't been deallocated yet</p>\n<ul>\n<li><code>assert!(prev.is_none())</code> fails → SIGABRT</li>\n</ul>\n</li>\n<li>\n<p><strong>Double unregistration</strong>: Old Arc finally deallocates after new engine re-registered at same address</p>\n<ul>\n<li><code>assert!(code.is_some())</code> fails → SIGABRT</li>\n</ul>\n</li>\n</ol>\n<p>This consistently crashes after ~350-400 engine/module creations in a single process.</p>\n<h2>Solution</h2>\n<p>Add a <code>BTreeSet</code> to track registered addresses and check before performing operations:</p>\n<ul>\n<li><code>register_code</code>: Skip if address already registered</li>\n<li><code>unregister_code</code>: Skip if address not registered</li>\n</ul>\n<p>This makes both operations safe to call multiple times with the same address.</p>\n<h2>Changes</h2>\n<ul>\n<li>Added <code>registered_addresses()</code> function returning a static <code>RwLock&lt;BTreeSet&lt;usize&gt;&gt;</code></li>\n<li>Modified <code>register_code</code> to check tracking set before inserting</li>\n<li>Modified <code>unregister_code</code> to check tracking set before removing</li>\n<li>Added debug logging (only in debug builds) for skipped operations</li>\n</ul>\n<h2>Testing</h2>\n<ul>\n<li>Ran stress test creating 500+ engines/modules in a loop - passes without crash</li>\n<li>Full wasmtime test suite passes</li>\n<li>No performance regression (BTreeSet lookup is O(log n), same as existing BTreeMap)</li>\n</ul>\n<h2>Impact</h2>\n<p>This fix enables:</p>\n<ul>\n<li>JVM integrations (where <code>signals_based_traps(false)</code> is required)</li>\n<li>Long-running servers dynamically loading/unloading WASM modules  </li>\n<li>Large test suites with many engine/module tests</li>\n<li>Any application creating 350+ engines/modules</li>\n</ul>\n<h2>Backward Compatibility</h2>\n<ul>\n<li>No API changes</li>\n<li>No behavior changes for correctly behaving code</li>\n<li>Only affects edge case of address reuse with deferred Arc deallocation</li>\n</ul>\n</blockquote>",
        "id": 571797837,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1770166659
    },
    {
        "content": "<p><strong>zacharywhitley</strong> requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers\">wasmtime-compiler-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12512\">PR #12512</a>.</p>",
        "id": 571797839,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1770166660
    },
    {
        "content": "<p><strong>zacharywhitley</strong> requested <a href=\"https://github.com/fitzgen\">fitzgen</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12512\">PR #12512</a>.</p>",
        "id": 571797840,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1770166660
    },
    {
        "content": "<p><strong>zacharywhitley</strong> requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-wasi-reviewers\">wasmtime-wasi-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12512\">PR #12512</a>.</p>",
        "id": 571797843,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1770166660
    },
    {
        "content": "<p><strong>zacharywhitley</strong> requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers\">wasmtime-core-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12512\">PR #12512</a>.</p>",
        "id": 571797844,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1770166661
    },
    {
        "content": "<p><strong>zacharywhitley</strong> requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-default-reviewers\">wasmtime-default-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12512\">PR #12512</a>.</p>",
        "id": 571797845,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1770166661
    },
    {
        "content": "<p>zacharywhitley updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12512\">PR #12512</a>.</p>",
        "id": 571798813,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1770167232
    },
    {
        "content": "<p>alexcrichton closed without merge <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12512\">PR #12512</a>.</p>",
        "id": 571801266,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1770169166
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12512#issuecomment-3844751894\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12512\">PR #12512</a>:</p>\n<blockquote>\n<p>I don't believe that this fix is correct, so I'm going to close this in favor of continuing discussion on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12511\">https://github.com/bytecodealliance/wasmtime/issues/12511</a>.</p>\n</blockquote>",
        "id": 571801269,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1770169167
    }
]
[
    {
        "content": "<p>alexcrichton opened <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11799\">PR #11799</a> from <code>alexcrichton:fix-c-api-onwership</code> to <code>bytecodealliance:main</code>:</p>\n<blockquote>\n<p>This commit is a follow-up to #11514 which was discovered through failing tests in the wasmtime-py repository when updating to Wasmtime 37.0.0. Effectively a combination of bugs in the Rust API meant that it wasn't possible to use <code>externref</code> or <code>anyref</code> bindings correctly. The Rust changes in this commit are:</p>\n<ul>\n<li><code>wasmtime_val_unroot</code> correctly drops the value now as opposed to effectively being a noop from before (typo of using <code>as_externref</code> vs <code>from_externref</code>).</li>\n<li><code>wasmtime_{anyref,externref,val}_t</code> now have a <code>Drop</code> implementation in Rust to correctly drop them if a value in Rust is dropped. This is required to correctly manage memory in the <code>wasmtime_func_{call,new}</code> implementations, for example.</li>\n<li><code>wasmtime_{anyref,externref,val}_clone</code> no longer have an unnecessary context parameter.</li>\n<li><code>wasmtime_{anyref,externref,val}_unroot</code> no longer have an unnecessary context parameter.</li>\n</ul>\n<p>Changes in the C/C++ APIs are:</p>\n<ul>\n<li><code>Result::{ok,err}_ref</code> APIs were added in addition to the preexisting rvalue accessors.</li>\n<li>Loading/storing typed arguments now has an overload for <code>const T&amp;</code> and <code>T&amp;&amp;</code> which behaves differently. Notably transferring ownership for <code>T&amp;&amp;</code> and not for <code>const T&amp;</code>. This means that passing parameters when calling a wasm function uses <code>const T&amp;</code>, but passing results from a host import uses <code>T&amp;&amp;</code>.</li>\n<li><code>TypedFunc::call</code> now uses <code>const Params&amp;</code> instead of <code>Params</code> to explicitly specify it doesn't modify the parameters and forces using the <code>const T&amp;</code> store method.</li>\n<li><code>Store::gc</code> is now a convenience method for <code>store.context().gc()</code></li>\n<li><code>ExternRef</code>, <code>AnyRef</code>, and <code>Val</code> now have ownership semantics and destructors. This matches the spirit of #11514 for Rust but models it in C++ as well. This required filling out move/copy constructors/assignments.</li>\n<li>The explicit <code>ExternRef</code> now takes <code>std::any</code> instead of <code>T</code>.</li>\n<li>Minor issues related to ownership are fixed in <code>Val</code> bindings.</li>\n</ul>\n<p>Valgrind was used to ensure that there were no leaks for the test suite which additionally resulted in a number of <code>*_delete</code> calls being added to tests using the C API (accidental omissions).</p>\n<p>The original goal of this change was to be a patch release for 37.0.1 to enable updating wasmtime-py to the 37.0.x releases of Wasmtime. In the end though the changes here were broad enough that I no longer feel that this is a good idea, so wasmtime-py will be skipping the 37 version of Wasmtime.</p>\n<p>&lt;!--<br>\nPlease make sure you include the following information:</p>\n<ul>\n<li>\n<p>If this work has been discussed elsewhere, please include a link to that<br>\n  conversation. If it was discussed in an issue, just mention \"issue #...\".</p>\n</li>\n<li>\n<p>Explain why this change is needed. If the details are in an issue already,<br>\n  this can be brief.</p>\n</li>\n</ul>\n<p>Our development process is documented in the Wasmtime book:<br>\n<a href=\"https://docs.wasmtime.dev/contributing-development-process.html\">https://docs.wasmtime.dev/contributing-development-process.html</a></p>\n<p>Please ensure all communication follows the code of conduct:<br>\n<a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md\">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>\n--&gt;</p>\n</blockquote>",
        "id": 543546516,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1759847214
    },
    {
        "content": "<p><strong>alexcrichton</strong> requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers\">wasmtime-core-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11799\">PR #11799</a>.</p>",
        "id": 543546518,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1759847215
    },
    {
        "content": "<p><strong>alexcrichton</strong> requested <a href=\"https://github.com/pchickey\">pchickey</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11799\">PR #11799</a>.</p>",
        "id": 543546519,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1759847215
    },
    {
        "content": "<p>alexcrichton updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11799\">PR #11799</a>.</p>",
        "id": 543547133,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1759847378
    },
    {
        "content": "<p>alexcrichton has enabled auto merge for <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11799\">PR #11799</a>.</p>",
        "id": 543551544,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1759848393
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11799#issuecomment-3377294703\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11799\">PR #11799</a>:</p>\n<blockquote>\n<p>Once this lands on main I'll backport the merged commit to the release-38.0.0 branch as well</p>\n</blockquote>",
        "id": 543553816,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1759848932
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11799#pullrequestreview-3310951254\">PR review</a>:</p>\n<blockquote>\n<p>Carrying over my review from the GHSA -- thanks again for catching this and fixing it!</p>\n</blockquote>",
        "id": 543576827,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1759854973
    },
    {
        "content": "<p>alexcrichton merged <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11799\">PR #11799</a>.</p>",
        "id": 543582408,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1759856600
    }
]
[
    {
        "content": "<p>ohadravid opened <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12426\">PR #12426</a> from <code>ohadravid:windows-fls-thread-local-guard</code> to <code>bytecodealliance:main</code>:</p>\n<blockquote>\n<p>&lt;!--<br>\nPlease make sure you include the following information:</p>\n<ul>\n<li>\n<p>If this work has been discussed elsewhere, please include a link to that<br>\n  conversation. If it was discussed in an issue, just mention \"issue #...\".</p>\n</li>\n<li>\n<p>Explain why this change is needed. If the details are in an issue already,<br>\n  this can be brief.</p>\n</li>\n</ul>\n<p>Our development process is documented in the Wasmtime book:<br>\n<a href=\"https://docs.wasmtime.dev/contributing-development-process.html\">https://docs.wasmtime.dev/contributing-development-process.html</a></p>\n<p>Please ensure all communication follows the code of conduct:<br>\n<a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md\">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>\n--&gt;</p>\n<p>Follow to <a href=\"https://github.com/rust-lang/rust/pull/148799\">https://github.com/rust-lang/rust/pull/148799</a>, specifically @alexcrichton's <a href=\"https://github.com/rust-lang/rust/pull/148799#issuecomment-3793025504\">comment</a>.</p>\n<p>Summary: <a href=\"https://github.com/rust-lang/rust/pull/148799\">https://github.com/rust-lang/rust/pull/148799</a> switches the way destructors for thread locals are scheduled on Windows, and will now use Fiber Local Storage (<code>FlsAlloc</code> accepts a callback that is called on fiber/thread/process exit).</p>\n<p>Because <code>wasmtime</code> uses Fibers on Windows to support async functions, it now need to make sure that this hook is registered before Fibers are used.</p>\n<p>To do that, we create an additional TLS variable with a <code>Drop</code> impl, and use it just before calling <code>ConvertThreadToFiber</code>. Because <code>ConvertFiberToThread</code> is already called before exiting, this guarantees that the hook will both be registered correctly, and invoked when the thread exits.</p>\n<p>If a fiber does exit abnormally, it's possible that <code>ConvertFiberToThread</code> won't be called, in which case thread locals with <code>Drop</code> impls will be leaked.</p>\n<p>@alexcrichton - let me know if you want me to add a <code>resume_separate_thread</code>-like test that uses thread locals + a \"native\" os thread (== one that isn't initialized with the Rust runtime).</p>\n</blockquote>",
        "id": 569893636,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769279470
    },
    {
        "content": "<p><strong>ohadravid</strong> requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers\">wasmtime-core-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12426\">PR #12426</a>.</p>",
        "id": 569893637,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769279470
    },
    {
        "content": "<p><strong>ohadravid</strong> requested <a href=\"https://github.com/pchickey\">pchickey</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12426\">PR #12426</a>.</p>",
        "id": 569893639,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769279470
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12426#issuecomment-3795676198\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12426\">PR #12426</a>:</p>\n<blockquote>\n<p>Thanks for this! If you've got a test that'd be awesome to add, but no need to go out of your way for that. You can feel free to add it to this crate itself or in the top level <code>tests/*</code> as appropriate</p>\n</blockquote>",
        "id": 569909376,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769295786
    },
    {
        "content": "<p>alexcrichton unassigned pchickey from <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12426\">PR #12426 Added a thread_local guard to trigger dtor hook before fibers are used</a>.</p>",
        "id": 569909384,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769295791
    },
    {
        "content": "<p><strong>alexcrichton</strong> requested <a href=\"https://github.com/alexcrichton\">alexcrichton</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12426\">PR #12426</a>.</p>",
        "id": 569909385,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769295792
    },
    {
        "content": "<p>ohadravid updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12426\">PR #12426</a>.</p>",
        "id": 570646187,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769629332
    },
    {
        "content": "<p>alexcrichton submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12426#pullrequestreview-3718947469\">PR review</a>.</p>",
        "id": 570651231,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769631125
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12426#issuecomment-3813678823\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12426\">PR #12426</a>:</p>\n<blockquote>\n<p>Thanks so much again for this!</p>\n</blockquote>",
        "id": 570651251,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769631134
    },
    {
        "content": "<p>alexcrichton added <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12426\">PR #12426 Added a thread_local guard to trigger dtor hook before fibers are used</a> to the merge queue.</p>",
        "id": 570651260,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769631136
    },
    {
        "content": "<p>alexcrichton merged <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12426\">PR #12426</a>.</p>",
        "id": 570655909,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769632824
    },
    {
        "content": "<p>alexcrichton removed <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12426\">PR #12426 Added a thread_local guard to trigger dtor hook before fibers are used</a> from the merge queue.</p>",
        "id": 570655912,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769632825
    }
]
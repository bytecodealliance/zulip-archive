[
    {
        "content": "<p>fatlotus opened <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12219\">issue #12219</a>:</p>\n<blockquote>\n<p>Please take this report with a grain of salt as I'm fairly new with WASM.</p>\n<h3>Test Case</h3>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"p\">#</span><span class=\"n\">include</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">cassert</span><span class=\"o\">&gt;</span>\n<span class=\"p\">#</span><span class=\"n\">include</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">cstdint</span><span class=\"o\">&gt;</span>\n<span class=\"p\">#</span><span class=\"n\">include</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">cstdio</span><span class=\"o\">&gt;</span>\n<span class=\"p\">#</span><span class=\"n\">include</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">unistd</span><span class=\"p\">.</span><span class=\"n\">h</span><span class=\"o\">&gt;</span>\n\n<span class=\"k\">extern</span><span class=\"w\"> </span><span class=\"s\">\"C\"</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"n\">__attribute__</span><span class=\"p\">((</span><span class=\"n\">import_module</span><span class=\"p\">(</span><span class=\"s\">\"wasi\"</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">import_name</span><span class=\"p\">(</span><span class=\"s\">\"thread-spawn\"</span><span class=\"p\">)))</span>\n<span class=\"n\">int32_t</span><span class=\"w\"> </span><span class=\"n\">spawn_a_thread</span><span class=\"p\">(</span><span class=\"n\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">thread_data</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n\n<span class=\"n\">int</span><span class=\"w\"> </span><span class=\"n\">magic_number</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n\n<span class=\"p\">[[</span><span class=\"n\">clang</span><span class=\"p\">::</span><span class=\"n\">export_name</span><span class=\"p\">(</span><span class=\"s\">\"wasi_thread_start\"</span><span class=\"p\">)]]</span>\n<span class=\"n\">void</span><span class=\"w\"> </span><span class=\"n\">wasi_thread_start</span><span class=\"p\">(</span><span class=\"n\">int32_t</span><span class=\"w\"> </span><span class=\"n\">tid</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">int</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">arg</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">\"Running on a thread. tid=%d, arg=%p, magic_number=%d</span><span class=\"se\">\\n</span><span class=\"s\">\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">tid</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">arg</span><span class=\"p\">,</span>\n<span class=\"w\">         </span><span class=\"n\">magic_number</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n\n<span class=\"n\">int</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"n\">magic_number</span><span class=\"w\"> </span><span class=\"o\">+=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">sleep</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"n\">int</span><span class=\"w\"> </span><span class=\"n\">thread_data</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">\"thread_data=%p</span><span class=\"se\">\\n</span><span class=\"s\">\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">thread_data</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"n\">int</span><span class=\"w\"> </span><span class=\"n\">tid</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">spawn_a_thread</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">thread_data</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"n\">assert</span><span class=\"p\">(</span><span class=\"n\">tid</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"n\">sleep</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">\"After</span><span class=\"se\">\\n</span><span class=\"s\">\"</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>Here's what this compiles to (apologies, it's pretty long) with Homebrew Clang 21.1.8:</p>\n<p><a href=\"https://github.com/user-attachments/files/24339350/main.wat.txt\">main.wat.txt</a></p>\n<h3>Steps to Reproduce</h3>\n<ul>\n<li>wasmtime: <code>$ wasmtime run --wasi threads=y --wasm threads=y main.wat</code></li>\n<li>WAMR: <code>$ iwasm --max-threads=2 main.wasm</code></li>\n</ul>\n<h3>Expected Results</h3>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"n\">iwasm</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">max</span><span class=\"o\">-</span><span class=\"n\">threads</span><span class=\"o\">=</span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"p\">.</span><span class=\"n\">wat</span>\n<span class=\"n\">thread_data</span><span class=\"o\">=</span><span class=\"mh\">0x113b8</span>\n<span class=\"n\">Running</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">thread</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"n\">tid</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">arg</span><span class=\"o\">=</span><span class=\"mh\">0x113b8</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">magic_number</span><span class=\"o\">=</span><span class=\"mi\">1</span>\n<span class=\"n\">After</span>\n</code></pre></div>\n<h3>Actual Results</h3>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">wasi</span><span class=\"w\"> </span><span class=\"n\">threads</span><span class=\"o\">=</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">wasm</span><span class=\"w\"> </span><span class=\"n\">threads</span><span class=\"o\">=</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"p\">.</span><span class=\"n\">wat</span>\n<span class=\"n\">thread_data</span><span class=\"o\">=</span><span class=\"mh\">0x113b8</span>\n<span class=\"n\">Running</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">thread</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"n\">tid</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">arg</span><span class=\"o\">=</span><span class=\"mh\">0x113b8</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">magic_number</span><span class=\"o\">=</span><span class=\"mi\">0</span>\n<span class=\"n\">After</span>\n</code></pre></div>\n<p>In particular, I think the thread should see a <code>magic_number</code> of 1, since it has been incremented by the main program before the thread started.</p>\n<h3>Versions and Environment</h3>\n<p>Wasmtime version or commit: wasmtime 39.0.1</p>\n<p>Operating system: macOS 14.6.1</p>\n<p>Architecture: M1</p>\n<h3>Extra Info</h3>\n<p>There's some funny logic here (<a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasi-threads/src/lib.rs#L165-L179\">https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasi-threads/src/lib.rs#L165-L179</a>) in the wasi threads crate, where the shared memory is somehow re-injected into the linker. In the clang-generated code, the shared memory isn't imported — maybe that means the linker doesn't inject the same shared memory region to each thread?</p>\n</blockquote>",
        "id": 565378907,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1766677582
    },
    {
        "content": "<p><a href=\"https://github.com/fatlotus\">fatlotus</a> added the bug label to <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12219\">Issue #12219</a>.</p>",
        "id": 565378908,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1766677582
    },
    {
        "content": "<p>fatlotus edited <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12219\">issue #12219</a>:</p>\n<blockquote>\n<p>Please take this report with a grain of salt as I'm fairly new with WASM.</p>\n<h3>Test Case</h3>\n<div class=\"codehilite\" data-code-language=\"C++\"><pre><span></span><code><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;cassert&gt;</span>\n<span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;cstdint&gt;</span>\n<span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;cstdio&gt;</span>\n<span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;unistd.h&gt;</span>\n\n<span class=\"k\">extern</span><span class=\"w\"> </span><span class=\"s\">\"C\"</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"n\">__attribute__</span><span class=\"p\">((</span><span class=\"n\">import_module</span><span class=\"p\">(</span><span class=\"s\">\"wasi\"</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">import_name</span><span class=\"p\">(</span><span class=\"s\">\"thread-spawn\"</span><span class=\"p\">)))</span>\n<span class=\"kt\">int32_t</span><span class=\"w\"> </span><span class=\"n\">spawn_a_thread</span><span class=\"p\">(</span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">thread_data</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n\n<span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">magic_number</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n\n<span class=\"p\">[[</span><span class=\"n\">clang</span><span class=\"o\">::</span><span class=\"n\">export_name</span><span class=\"p\">(</span><span class=\"s\">\"wasi_thread_start\"</span><span class=\"p\">)]]</span>\n<span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"n\">wasi_thread_start</span><span class=\"p\">(</span><span class=\"kt\">int32_t</span><span class=\"w\"> </span><span class=\"n\">tid</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">arg</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">\"Running on a thread. tid=%d, arg=%p, magic_number=%d</span><span class=\"se\">\\n</span><span class=\"s\">\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">tid</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">arg</span><span class=\"p\">,</span>\n<span class=\"w\">         </span><span class=\"n\">magic_number</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n\n<span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"n\">magic_number</span><span class=\"w\"> </span><span class=\"o\">+=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">sleep</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">thread_data</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">\"thread_data=%p</span><span class=\"se\">\\n</span><span class=\"s\">\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">thread_data</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">tid</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">spawn_a_thread</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">thread_data</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"n\">assert</span><span class=\"p\">(</span><span class=\"n\">tid</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"n\">sleep</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">\"After</span><span class=\"se\">\\n</span><span class=\"s\">\"</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>Here's what this compiles to (apologies, it's pretty long) with Homebrew Clang 21.1.8:</p>\n<p><a href=\"https://github.com/user-attachments/files/24339350/main.wat.txt\">main.wat.txt</a></p>\n<h3>Steps to Reproduce</h3>\n<ul>\n<li>wasmtime: <code>$ wasmtime run --wasi threads=y --wasm threads=y main.wat</code></li>\n<li>WAMR: <code>$ iwasm --max-threads=2 main.wasm</code></li>\n</ul>\n<h3>Expected Results</h3>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>$<span class=\"w\"> </span>iwasm<span class=\"w\"> </span>--max-threads<span class=\"o\">=</span><span class=\"m\">2</span><span class=\"w\"> </span>main.wat\n<span class=\"nv\">thread_data</span><span class=\"o\">=</span>0x113b8\nRunning<span class=\"w\"> </span>on<span class=\"w\"> </span>a<span class=\"w\"> </span>thread.<span class=\"w\"> </span><span class=\"nv\">tid</span><span class=\"o\">=</span><span class=\"m\">1</span>,<span class=\"w\"> </span><span class=\"nv\">arg</span><span class=\"o\">=</span>0x113b8,<span class=\"w\"> </span><span class=\"nv\">magic_number</span><span class=\"o\">=</span><span class=\"m\">1</span>\nAfter\n</code></pre></div>\n<h3>Actual Results</h3>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>$<span class=\"w\"> </span>wasmtime<span class=\"w\"> </span>run<span class=\"w\"> </span>--wasi<span class=\"w\"> </span><span class=\"nv\">threads</span><span class=\"o\">=</span>y<span class=\"w\"> </span>--wasm<span class=\"w\"> </span><span class=\"nv\">threads</span><span class=\"o\">=</span>y<span class=\"w\"> </span>main.wat\n<span class=\"nv\">thread_data</span><span class=\"o\">=</span>0x113b8\nRunning<span class=\"w\"> </span>on<span class=\"w\"> </span>a<span class=\"w\"> </span>thread.<span class=\"w\"> </span><span class=\"nv\">tid</span><span class=\"o\">=</span><span class=\"m\">1</span>,<span class=\"w\"> </span><span class=\"nv\">arg</span><span class=\"o\">=</span>0x113b8,<span class=\"w\"> </span><span class=\"nv\">magic_number</span><span class=\"o\">=</span><span class=\"m\">0</span>\nAfter\n</code></pre></div>\n<p>In particular, I think the thread should see a <code>magic_number</code> of 1, since it has been incremented by the main program before the thread started.</p>\n<h3>Versions and Environment</h3>\n<p>Wasmtime version or commit: wasmtime 39.0.1</p>\n<p>Operating system: macOS 14.6.1</p>\n<p>Architecture: M1</p>\n<h3>Extra Info</h3>\n<p>There's some funny logic here (<a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasi-threads/src/lib.rs#L165-L179\">https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasi-threads/src/lib.rs#L165-L179</a>) in the wasi threads crate, where the shared memory is somehow re-injected into the linker. In the clang-generated code, the shared memory isn't imported — maybe that means the linker doesn't inject the same shared memory region to each thread?</p>\n</blockquote>",
        "id": 565378954,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1766677640
    },
    {
        "content": "<p>bjorn3 <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12219#issuecomment-3691556740\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12219\">issue #12219</a>:</p>\n<blockquote>\n<p>Did you compile for the wasm32-wasip1 or wasm32-wasip1-threads target?</p>\n</blockquote>",
        "id": 565379012,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1766677741
    },
    {
        "content": "<p>fatlotus <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12219#issuecomment-3691558267\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12219\">issue #12219</a>:</p>\n<blockquote>\n<p>I'm using <code>wasm32-wasip1-threads</code>, but it reproduces on both targets. The full command line I'm using is:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">opt</span><span class=\"o\">/</span><span class=\"n\">homebrew</span><span class=\"o\">/</span><span class=\"n\">opt</span><span class=\"o\">/</span><span class=\"n\">llvm</span><span class=\"o\">/</span><span class=\"n\">bin</span><span class=\"o\">/</span><span class=\"n\">clang</span><span class=\"o\">++</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">std</span><span class=\"o\">=</span><span class=\"n\">c</span><span class=\"o\">++</span><span class=\"mi\">17</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">target</span><span class=\"o\">=</span><span class=\"n\">wasm32</span><span class=\"o\">-</span><span class=\"n\">wasip1</span><span class=\"o\">-</span><span class=\"n\">threads</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">sysroot</span><span class=\"o\">=/</span><span class=\"n\">Users</span><span class=\"o\">/</span><span class=\"n\">jeremyarcher</span><span class=\"o\">/</span><span class=\"n\">Downloads</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">sdk</span><span class=\"o\">-</span><span class=\"mf\">29.0</span><span class=\"o\">-</span><span class=\"n\">arm64</span><span class=\"o\">-</span><span class=\"n\">macos</span><span class=\"o\">/</span><span class=\"n\">share</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">sysroot</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"p\">.</span><span class=\"n\">cpp</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n</code></pre></div>\n<p>(One other hypothesis I had was that the <code>start</code> function might be reinitializing main memory when starting the second <code>Instance</code> for the new thread.)</p>\n</blockquote>",
        "id": 565379113,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1766677891
    },
    {
        "content": "<p>fatlotus edited a <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12219#issuecomment-3691558267\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12219\">issue #12219</a>:</p>\n<blockquote>\n<p>I'm using <code>wasm32-wasip1-threads</code>, but it reproduces on both targets. The full command line I'm using is:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">opt</span><span class=\"o\">/</span><span class=\"n\">homebrew</span><span class=\"o\">/</span><span class=\"n\">opt</span><span class=\"o\">/</span><span class=\"n\">llvm</span><span class=\"o\">/</span><span class=\"n\">bin</span><span class=\"o\">/</span><span class=\"n\">clang</span><span class=\"o\">++</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">std</span><span class=\"o\">=</span><span class=\"n\">c</span><span class=\"o\">++</span><span class=\"mi\">17</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">g</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">target</span><span class=\"o\">=</span><span class=\"n\">wasm32</span><span class=\"o\">-</span><span class=\"n\">wasip1</span><span class=\"o\">-</span><span class=\"n\">threads</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">sysroot</span><span class=\"o\">=~/</span><span class=\"n\">Downloads</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">sdk</span><span class=\"o\">-</span><span class=\"mf\">29.0</span><span class=\"o\">-</span><span class=\"n\">arm64</span><span class=\"o\">-</span><span class=\"n\">macos</span><span class=\"o\">/</span><span class=\"n\">share</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">sysroot</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"p\">.</span><span class=\"n\">cpp</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n</code></pre></div>\n<p>(One other hypothesis I had was that the <code>start</code> function might be reinitializing main memory when starting the second <code>Instance</code> for the new thread.)</p>\n</blockquote>",
        "id": 565379127,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1766677923
    },
    {
        "content": "<p>bjorn3 <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12219#issuecomment-3691580326\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12219\">issue #12219</a>:</p>\n<blockquote>\n<p>Try linking with <code>-Wl,--import-memory,--export-memory</code></p>\n</blockquote>",
        "id": 565380421,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1766679760
    },
    {
        "content": "<p>fatlotus <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12219#issuecomment-3691691143\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12219\">issue #12219</a>:</p>\n<blockquote>\n<p>Yep, that does the trick!</p>\n<p>I wonder if that logic at the end of <code>add_to_linker</code> was meant to be:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">    </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">module</span><span class=\"p\">.</span><span class=\"n\">imports</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"nb\">Some</span><span class=\"p\">(</span><span class=\"n\">m</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">import</span><span class=\"p\">.</span><span class=\"n\">ty</span><span class=\"p\">().</span><span class=\"n\">memory</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"o\">&amp;&amp;</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"p\">.</span><span class=\"n\">is_shared</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">            </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">mem</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">SharedMemory</span><span class=\"p\">::</span><span class=\"n\">new</span><span class=\"p\">(</span><span class=\"n\">module</span><span class=\"p\">.</span><span class=\"n\">engine</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">m</span><span class=\"p\">.</span><span class=\"n\">clone</span><span class=\"p\">())</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">            </span><span class=\"n\">linker</span><span class=\"p\">.</span><span class=\"n\">define</span><span class=\"p\">(</span><span class=\"n\">store</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">import</span><span class=\"p\">.</span><span class=\"n\">module</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">import</span><span class=\"p\">.</span><span class=\"n\">name</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">mem</span><span class=\"p\">.</span><span class=\"n\">clone</span><span class=\"p\">())</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">            </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"nb\">Ok</span><span class=\"p\">(())</span>\n<span class=\"w\">        </span><span class=\"p\">}</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"nb\">Err</span><span class=\"p\">(</span><span class=\"n\">anyhow</span><span class=\"o\">!</span><span class=\"p\">(</span>\n<span class=\"w\">      </span><span class=\"s\">\"memory was not shared; a `wasi-threads` must import \\</span>\n<span class=\"s\">        a shared memory as </span><span class=\"se\">\\\"</span><span class=\"s\">memory</span><span class=\"se\">\\\"</span><span class=\"s\">\"</span>\n<span class=\"w\">    </span><span class=\"p\">));</span>\n</code></pre></div>\n<p>That way this case would be an error.</p>\n</blockquote>",
        "id": 565387457,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1766691019
    },
    {
        "content": "<p>fatlotus edited <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12219\">issue #12219</a>:</p>\n<blockquote>\n<p>Please take this report with a grain of salt as I'm fairly new with WASM.</p>\n<h3>Test Case</h3>\n<div class=\"codehilite\" data-code-language=\"C++\"><pre><span></span><code><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;cassert&gt;</span>\n<span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;cstdint&gt;</span>\n<span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;cstdio&gt;</span>\n<span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;unistd.h&gt;</span>\n\n<span class=\"k\">extern</span><span class=\"w\"> </span><span class=\"s\">\"C\"</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"n\">__attribute__</span><span class=\"p\">((</span><span class=\"n\">import_module</span><span class=\"p\">(</span><span class=\"s\">\"wasi\"</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">import_name</span><span class=\"p\">(</span><span class=\"s\">\"thread-spawn\"</span><span class=\"p\">)))</span>\n<span class=\"kt\">int32_t</span><span class=\"w\"> </span><span class=\"n\">spawn_a_thread</span><span class=\"p\">(</span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">thread_data</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n\n<span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">magic_number</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n\n<span class=\"p\">[[</span><span class=\"n\">clang</span><span class=\"o\">::</span><span class=\"n\">export_name</span><span class=\"p\">(</span><span class=\"s\">\"wasi_thread_start\"</span><span class=\"p\">)]]</span>\n<span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"n\">wasi_thread_start</span><span class=\"p\">(</span><span class=\"kt\">int32_t</span><span class=\"w\"> </span><span class=\"n\">tid</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">arg</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">\"Running on a thread. tid=%d, arg=%p, magic_number=%d</span><span class=\"se\">\\n</span><span class=\"s\">\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">tid</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">arg</span><span class=\"p\">,</span>\n<span class=\"w\">         </span><span class=\"n\">magic_number</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n\n<span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"n\">magic_number</span><span class=\"w\"> </span><span class=\"o\">+=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">sleep</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">thread_data</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">\"thread_data=%p</span><span class=\"se\">\\n</span><span class=\"s\">\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">thread_data</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">tid</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">spawn_a_thread</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">thread_data</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"n\">assert</span><span class=\"p\">(</span><span class=\"n\">tid</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"n\">sleep</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">\"After</span><span class=\"se\">\\n</span><span class=\"s\">\"</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>Here's what this compiles to (apologies, it's pretty long) with Homebrew Clang 21.1.8:</p>\n<p><a href=\"https://github.com/user-attachments/files/24339350/main.wat.txt\">main.wat.txt</a></p>\n<h3>Steps to Reproduce</h3>\n<ul>\n<li>wasmtime: <code>$ wasmtime run --wasi threads=y --wasm threads=y main.wat</code></li>\n<li>WAMR: <code>$ iwasm --max-threads=2 main.wasm</code></li>\n</ul>\n<h3>Expected Results</h3>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>$<span class=\"w\"> </span>iwasm<span class=\"w\"> </span>--max-threads<span class=\"o\">=</span><span class=\"m\">2</span><span class=\"w\"> </span>main.wat\n<span class=\"nv\">thread_data</span><span class=\"o\">=</span>0x113b8\nRunning<span class=\"w\"> </span>on<span class=\"w\"> </span>a<span class=\"w\"> </span>thread.<span class=\"w\"> </span><span class=\"nv\">tid</span><span class=\"o\">=</span><span class=\"m\">1</span>,<span class=\"w\"> </span><span class=\"nv\">arg</span><span class=\"o\">=</span>0x113b8,<span class=\"w\"> </span><span class=\"nv\">magic_number</span><span class=\"o\">=</span><span class=\"m\">1</span>\nAfter\n</code></pre></div>\n<h3>Actual Results</h3>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>$<span class=\"w\"> </span>wasmtime<span class=\"w\"> </span>run<span class=\"w\"> </span>--wasi<span class=\"w\"> </span><span class=\"nv\">threads</span><span class=\"o\">=</span>y<span class=\"w\"> </span>--wasm<span class=\"w\"> </span><span class=\"nv\">threads</span><span class=\"o\">=</span>y<span class=\"w\"> </span>main.wat\n<span class=\"nv\">thread_data</span><span class=\"o\">=</span>0x113b8\nRunning<span class=\"w\"> </span>on<span class=\"w\"> </span>a<span class=\"w\"> </span>thread.<span class=\"w\"> </span><span class=\"nv\">tid</span><span class=\"o\">=</span><span class=\"m\">1</span>,<span class=\"w\"> </span><span class=\"nv\">arg</span><span class=\"o\">=</span>0x113b8,<span class=\"w\"> </span><span class=\"nv\">magic_number</span><span class=\"o\">=</span><span class=\"m\">0</span>\nAfter\n</code></pre></div>\n<p>In particular, I think the thread should see a <code>magic_number</code> of 1, since it has been incremented by the main program before the thread started.</p>\n<h3>Versions and Environment</h3>\n<p>Wasmtime version or commit: wasmtime 39.0.1</p>\n<p>Operating system: macOS 14.6.1</p>\n<p>Architecture: M1</p>\n<h3>Extra Info</h3>\n<p>There's some funny logic here (<a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasi-threads/src/lib.rs#L165-L179\">https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasi-threads/src/lib.rs#L165-L179</a>) in the wasi threads crate, where the shared memory is somehow re-injected into the linker. In the clang-generated code, the shared memory isn't imported — maybe that means the linker doesn't inject the same shared memory region to each thread?</p>\n</blockquote>",
        "id": 565389897,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1766695431
    },
    {
        "content": "<p>fatlotus edited <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12219\">issue #12219</a>:</p>\n<blockquote>\n<p>Please take this report with a grain of salt as I'm fairly new with WASM.</p>\n<h3>Test Case</h3>\n<div class=\"codehilite\" data-code-language=\"C++\"><pre><span></span><code><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;cassert&gt;</span>\n<span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;cstdint&gt;</span>\n<span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;cstdio&gt;</span>\n<span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;unistd.h&gt;</span>\n\n<span class=\"k\">extern</span><span class=\"w\"> </span><span class=\"s\">\"C\"</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"n\">__attribute__</span><span class=\"p\">((</span><span class=\"n\">import_module</span><span class=\"p\">(</span><span class=\"s\">\"wasi\"</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">import_name</span><span class=\"p\">(</span><span class=\"s\">\"thread-spawn\"</span><span class=\"p\">)))</span>\n<span class=\"kt\">int32_t</span><span class=\"w\"> </span><span class=\"n\">spawn_a_thread</span><span class=\"p\">(</span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">thread_data</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n\n<span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">magic_number</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n\n<span class=\"p\">[[</span><span class=\"n\">clang</span><span class=\"o\">::</span><span class=\"n\">export_name</span><span class=\"p\">(</span><span class=\"s\">\"wasi_thread_start\"</span><span class=\"p\">)]]</span>\n<span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"n\">wasi_thread_start</span><span class=\"p\">(</span><span class=\"kt\">int32_t</span><span class=\"w\"> </span><span class=\"n\">tid</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">arg</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">\"Running on a thread. tid=%d, arg=%p, magic_number=%d</span><span class=\"se\">\\n</span><span class=\"s\">\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">tid</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">arg</span><span class=\"p\">,</span>\n<span class=\"w\">         </span><span class=\"n\">magic_number</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n\n<span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"n\">magic_number</span><span class=\"w\"> </span><span class=\"o\">+=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">sleep</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">thread_data</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">\"thread_data=%p</span><span class=\"se\">\\n</span><span class=\"s\">\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">thread_data</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">tid</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">spawn_a_thread</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">thread_data</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"n\">assert</span><span class=\"p\">(</span><span class=\"n\">tid</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"n\">sleep</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">\"After</span><span class=\"se\">\\n</span><span class=\"s\">\"</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>Here's what this compiles to (apologies, it's pretty long) with Homebrew Clang 21.1.8:</p>\n<p><a href=\"https://github.com/user-attachments/files/24339350/main.wat.txt\">main.wat.txt</a></p>\n<h3>Steps to Reproduce</h3>\n<ul>\n<li>wasmtime: <code>$ wasmtime run --wasi threads=y --wasm threads=y main.wat</code></li>\n<li>WAMR: <code>$ iwasm --max-threads=2 main.wasm</code></li>\n</ul>\n<h3>Expected Results</h3>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>$<span class=\"w\"> </span>iwasm<span class=\"w\"> </span>--max-threads<span class=\"o\">=</span><span class=\"m\">2</span><span class=\"w\"> </span>main.wat\n<span class=\"nv\">thread_data</span><span class=\"o\">=</span>0x113b8\nRunning<span class=\"w\"> </span>on<span class=\"w\"> </span>a<span class=\"w\"> </span>thread.<span class=\"w\"> </span><span class=\"nv\">tid</span><span class=\"o\">=</span><span class=\"m\">1</span>,<span class=\"w\"> </span><span class=\"nv\">arg</span><span class=\"o\">=</span>0x113b8,<span class=\"w\"> </span><span class=\"nv\">magic_number</span><span class=\"o\">=</span><span class=\"m\">1</span>\nAfter\n</code></pre></div>\n<h3>Actual Results</h3>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>$<span class=\"w\"> </span>wasmtime<span class=\"w\"> </span>run<span class=\"w\"> </span>--wasi<span class=\"w\"> </span><span class=\"nv\">threads</span><span class=\"o\">=</span>y<span class=\"w\"> </span>--wasm<span class=\"w\"> </span><span class=\"nv\">threads</span><span class=\"o\">=</span>y<span class=\"w\"> </span>main.wat\n<span class=\"nv\">thread_data</span><span class=\"o\">=</span>0x113b8\nRunning<span class=\"w\"> </span>on<span class=\"w\"> </span>a<span class=\"w\"> </span>thread.<span class=\"w\"> </span><span class=\"nv\">tid</span><span class=\"o\">=</span><span class=\"m\">1</span>,<span class=\"w\"> </span><span class=\"nv\">arg</span><span class=\"o\">=</span>0x113b8,<span class=\"w\"> </span><span class=\"nv\">magic_number</span><span class=\"o\">=</span><span class=\"m\">0</span>\nAfter\n</code></pre></div>\n<p>In particular, I think the thread should see a <code>magic_number</code> of 1, since it has been incremented by the main program before the thread started.</p>\n<h3>Versions and Environment</h3>\n<p>Wasmtime version or commit: wasmtime 39.0.1</p>\n<p>Operating system: macOS 14.6.1</p>\n<p>Architecture: M1</p>\n<h3>Extra Info</h3>\n<p>There's some funny logic here (<a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasi-threads/src/lib.rs#L165-L179\">https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasi-threads/src/lib.rs#L165-L179</a>) in the wasi threads crate, where the shared memory is somehow re-injected into the linker. In the clang-generated code, the shared memory isn't imported — maybe that means the linker doesn't inject the same shared memory region to each thread?</p>\n</blockquote>",
        "id": 565389901,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1766695447
    },
    {
        "content": "<p>alexcrichton closed <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12219\">issue #12219</a>:</p>\n<blockquote>\n<p>Please take this report with a grain of salt as I'm fairly new with WASM.</p>\n<h3>Test Case</h3>\n<div class=\"codehilite\" data-code-language=\"C++\"><pre><span></span><code><span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;cassert&gt;</span>\n<span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;cstdint&gt;</span>\n<span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;cstdio&gt;</span>\n<span class=\"cp\">#include</span><span class=\"w\"> </span><span class=\"cpf\">&lt;unistd.h&gt;</span>\n\n<span class=\"k\">extern</span><span class=\"w\"> </span><span class=\"s\">\"C\"</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"n\">__attribute__</span><span class=\"p\">((</span><span class=\"n\">import_module</span><span class=\"p\">(</span><span class=\"s\">\"wasi\"</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">import_name</span><span class=\"p\">(</span><span class=\"s\">\"thread-spawn\"</span><span class=\"p\">)))</span>\n<span class=\"kt\">int32_t</span><span class=\"w\"> </span><span class=\"n\">spawn_a_thread</span><span class=\"p\">(</span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">thread_data</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n\n<span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">magic_number</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n\n<span class=\"p\">[[</span><span class=\"n\">clang</span><span class=\"o\">::</span><span class=\"n\">export_name</span><span class=\"p\">(</span><span class=\"s\">\"wasi_thread_start\"</span><span class=\"p\">)]]</span>\n<span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"n\">wasi_thread_start</span><span class=\"p\">(</span><span class=\"kt\">int32_t</span><span class=\"w\"> </span><span class=\"n\">tid</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">arg</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">\"Running on a thread. tid=%d, arg=%p, magic_number=%d</span><span class=\"se\">\\n</span><span class=\"s\">\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">tid</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">arg</span><span class=\"p\">,</span>\n<span class=\"w\">         </span><span class=\"n\">magic_number</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n\n<span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"n\">magic_number</span><span class=\"w\"> </span><span class=\"o\">+=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">sleep</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">thread_data</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">\"thread_data=%p</span><span class=\"se\">\\n</span><span class=\"s\">\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">thread_data</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"kt\">int</span><span class=\"w\"> </span><span class=\"n\">tid</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">spawn_a_thread</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">thread_data</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"n\">assert</span><span class=\"p\">(</span><span class=\"n\">tid</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"n\">sleep</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">);</span>\n<span class=\"w\">  </span><span class=\"n\">printf</span><span class=\"p\">(</span><span class=\"s\">\"After</span><span class=\"se\">\\n</span><span class=\"s\">\"</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>Here's what this compiles to (apologies, it's pretty long) with Homebrew Clang 21.1.8:</p>\n<p><a href=\"https://github.com/user-attachments/files/24339350/main.wat.txt\">main.wat.txt</a></p>\n<h3>Steps to Reproduce</h3>\n<ul>\n<li>wasmtime: <code>$ wasmtime run --wasi threads=y --wasm threads=y main.wat</code></li>\n<li>WAMR: <code>$ iwasm --max-threads=2 main.wasm</code></li>\n</ul>\n<h3>Expected Results</h3>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>$<span class=\"w\"> </span>iwasm<span class=\"w\"> </span>--max-threads<span class=\"o\">=</span><span class=\"m\">2</span><span class=\"w\"> </span>main.wat\n<span class=\"nv\">thread_data</span><span class=\"o\">=</span>0x113b8\nRunning<span class=\"w\"> </span>on<span class=\"w\"> </span>a<span class=\"w\"> </span>thread.<span class=\"w\"> </span><span class=\"nv\">tid</span><span class=\"o\">=</span><span class=\"m\">1</span>,<span class=\"w\"> </span><span class=\"nv\">arg</span><span class=\"o\">=</span>0x113b8,<span class=\"w\"> </span><span class=\"nv\">magic_number</span><span class=\"o\">=</span><span class=\"m\">1</span>\nAfter\n</code></pre></div>\n<h3>Actual Results</h3>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>$<span class=\"w\"> </span>wasmtime<span class=\"w\"> </span>run<span class=\"w\"> </span>--wasi<span class=\"w\"> </span><span class=\"nv\">threads</span><span class=\"o\">=</span>y<span class=\"w\"> </span>--wasm<span class=\"w\"> </span><span class=\"nv\">threads</span><span class=\"o\">=</span>y<span class=\"w\"> </span>main.wat\n<span class=\"nv\">thread_data</span><span class=\"o\">=</span>0x113b8\nRunning<span class=\"w\"> </span>on<span class=\"w\"> </span>a<span class=\"w\"> </span>thread.<span class=\"w\"> </span><span class=\"nv\">tid</span><span class=\"o\">=</span><span class=\"m\">1</span>,<span class=\"w\"> </span><span class=\"nv\">arg</span><span class=\"o\">=</span>0x113b8,<span class=\"w\"> </span><span class=\"nv\">magic_number</span><span class=\"o\">=</span><span class=\"m\">0</span>\nAfter\n</code></pre></div>\n<p>In particular, I think the thread should see a <code>magic_number</code> of 1, since it has been incremented by the main program before the thread started.</p>\n<h3>Versions and Environment</h3>\n<p>Wasmtime version or commit: wasmtime 39.0.1</p>\n<p>Operating system: macOS 14.6.1</p>\n<p>Architecture: M1</p>\n<h3>Extra Info</h3>\n<p>There's some funny logic here (<a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasi-threads/src/lib.rs#L165-L179\">https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasi-threads/src/lib.rs#L165-L179</a>) in the wasi threads crate, where the shared memory is somehow re-injected into the linker. In the clang-generated code, the shared memory isn't imported — maybe that means the linker doesn't inject the same shared memory region to each thread?</p>\n</blockquote>",
        "id": 566375990,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767625908
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12219#issuecomment-3710833914\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12219\">issue #12219</a>:</p>\n<blockquote>\n<p>Thanks for the report, and I agree with @bjorn3 that the main issue here would be compiling the module to import memory. I agree that the error message could in theory be better, but Wasmtime isn't exactly positioned to have such an error message at this time. For example that would mean that <code>-Sthreads</code> <em>requires</em> you to import a memory which means we couldn't ever turn <code>-Sthreads</code> on-by-default.</p>\n<p>Given that I think that this is otherwise solved, so I'm going to close this.</p>\n</blockquote>",
        "id": 566375996,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767625909
    }
]
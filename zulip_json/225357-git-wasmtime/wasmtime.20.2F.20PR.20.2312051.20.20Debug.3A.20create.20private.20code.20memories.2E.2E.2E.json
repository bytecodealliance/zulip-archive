[
    {
        "content": "<p>cfallin edited <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051\">PR #12051</a>.</p>",
        "id": 560954538,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764460665
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#pullrequestreview-3520876763\">PR review</a>.</p>",
        "id": 560954624,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764460766
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#discussion_r2573257651\">PR review comment</a>:</p>\n<blockquote>\n<p>(Updated after refactor)</p>\n</blockquote>",
        "id": 560954625,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764460766
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#pullrequestreview-3520876799\">PR review</a>.</p>",
        "id": 560954631,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764460775
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#discussion_r2573257702\">PR review comment</a>:</p>\n<blockquote>\n<p>(Updated after refactor)</p>\n</blockquote>",
        "id": 560954632,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764460775
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#pullrequestreview-3520876969\">PR review</a>.</p>",
        "id": 560954690,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764460826
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#discussion_r2573257944\">PR review comment</a>:</p>\n<blockquote>\n<p>This was borrowing-related but I avoided it in the refactor by putting the <code>register_*</code> methods on the <code>Store</code> directly so it can pass in the <code>&amp;Engine</code> from its <code>&amp;Arc</code> separately borrowed -- updated in refactor.</p>\n</blockquote>",
        "id": 560954692,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764460827
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#pullrequestreview-3520877037\">PR review</a>.</p>",
        "id": 560954706,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764460839
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#discussion_r2573258015\">PR review comment</a>:</p>\n<blockquote>\n<p>(Updated inrefactor)</p>\n</blockquote>",
        "id": 560954707,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764460839
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#pullrequestreview-3520877064\">PR review</a>.</p>",
        "id": 560954716,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764460848
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#discussion_r2573258046\">PR review comment</a>:</p>\n<blockquote>\n<p>(Updated in refactor)</p>\n</blockquote>",
        "id": 560954717,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764460848
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#pullrequestreview-3520877129\">PR review</a>.</p>",
        "id": 560954727,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764460862
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#discussion_r2573258085\">PR review comment</a>:</p>\n<blockquote>\n<p>(Updated in refactor)</p>\n</blockquote>",
        "id": 560954728,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764460862
    },
    {
        "content": "<p>cfallin updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051\">PR #12051</a>.</p>",
        "id": 560954749,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764460883
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#pullrequestreview-3520877430\">PR review</a>.</p>",
        "id": 560954836,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764460940
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#discussion_r2573258452\">PR review comment</a>:</p>\n<blockquote>\n<p>The lack of alignment passed in to <code>deserialize_raw</code> is generally problematic but I think I'd prefer to address this in a separate PR -- (i) this is a change to public invariants/APIs, (ii) this is a separate topic and existing deficit that we'll want to think a little carefully about I think!</p>\n</blockquote>",
        "id": 560954837,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764460941
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#pullrequestreview-3520877630\">PR review</a>.</p>",
        "id": 560954876,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764460982
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#discussion_r2573258703\">PR review comment</a>:</p>\n<blockquote>\n<p>Yep, I think we'll want to think carefully about this in its own right -- if you don't mind, could we defer alignment-related things (since it appears to be a pre-existing issue as well)?</p>\n</blockquote>",
        "id": 560954877,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764460983
    },
    {
        "content": "<p>cfallin updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051\">PR #12051</a>.</p>",
        "id": 560955074,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764461145
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#issuecomment-3592042121\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051\">PR #12051</a>:</p>\n<blockquote>\n<p>OK, I've now refactored in the direction we discussed above -- I feel a lot better about the types ensuring we're not leaking the wrong kind of function pointers (i.e. not executing the private copy) now!</p>\n<p>I've updated the initial comment based on the new comment message above -- please see for some of the caveats and reasoning. Let me know what you think!</p>\n</blockquote>",
        "id": 560955185,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764461244
    },
    {
        "content": "<p>alexcrichton submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#pullrequestreview-3526768344\">PR review</a>:</p>\n<blockquote>\n<p>To me this all looks great, thanks for pushing on the refactor!</p>\n<blockquote>\n<p>this is very deeply invasive, and I worry that (for example) indirect function calls are going to be penalized</p>\n</blockquote>\n<p>I didn't run across this myself, so I wanted to clarify -- is this still present or did this end up getting resolved during refactoring?</p>\n</blockquote>",
        "id": 561274472,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764623383
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#discussion_r2578482269\">PR review comment</a>:</p>\n<blockquote>\n<p>Similar to below, mind lifting the <code>let</code> out of the <code>unsafe</code>?</p>\n</blockquote>",
        "id": 561274473,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764623383
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#discussion_r2578571572\">PR review comment</a>:</p>\n<blockquote>\n<p>Could this be <code>#[cfg(feature = \"debug\")]</code> to help optimize this enum representation on debug-less builds? (or is that too much #[cfg] noise for too little benefit?)</p>\n</blockquote>",
        "id": 561274475,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764623383
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#discussion_r2578473363\">PR review comment</a>:</p>\n<blockquote>\n<p>This should probably have been done prior, but mind lifting out the <code>let</code> from the <code>unsafe</code> to make it clear that the <code>unsafe</code> is just for the <code>get_exported_func</code>?</p>\n</blockquote>",
        "id": 561274477,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764623383
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#discussion_r2578585105\">PR review comment</a>:</p>\n<blockquote>\n<p>As a follow-up and/or pending issue, it might be nice to only clone the text section here as opposed to anything else since everything else in the module is irrelevant for the cloning purpose. Modules can often be 2x larger than the text section for the <code>.wasmtime.addrmap</code> section alone so we might have some nice wins cutting down on the size. My hope is that this'd be pretty easy refactor to tack on in the future though where the only caveat would be to redirect some accesses of metadata to the <code>EngineCode</code> layer, if any, rather than using it through <code>StoreCode</code> (and this may already very well be solved entirely in the refactorings of this PR)</p>\n</blockquote>",
        "id": 561274479,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764623383
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#discussion_r2578497393\">PR review comment</a>:</p>\n<blockquote>\n<p>Could this check for <code>module.engine().config().guest_debug</code> and return an error if it's enabled? And/or somehow gracefully fail later on or something like that?</p>\n</blockquote>",
        "id": 561274480,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764623383
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#discussion_r2578597363\">PR review comment</a>:</p>\n<blockquote>\n<p>As a note here, this is pretty cool that the <code>get_foo_and_bar</code> pattern worked here (and everywhere else in this PR) without needing any <code>unsafe</code> anywhere. It's defnitely a drag that we need it at all, but hopefully future Rust features will come to save us one day...</p>\n</blockquote>",
        "id": 561274481,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764623383
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#discussion_r2578594008\">PR review comment</a>:</p>\n<blockquote>\n<p>Could this be replaced with the equivalent that <code>Module</code> is using rather than deleting it? </p>\n<p>Some options for handling this though are:</p>\n<ul>\n<li>Documenting that this may return misleading results with <code>guest_debug</code>.</li>\n<li>Changing to return an <code>Option</code> which is <code>None</code> if <code>guest_debug</code> is enabled.</li>\n</ul>\n<p>As an introspection utility for embedders though I think this is something we'll want to keep</p>\n</blockquote>",
        "id": 561274482,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764623383
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#discussion_r2578650494\">PR review comment</a>:</p>\n<blockquote>\n<p>Since this is on the hot path of instantiation can you rerun the intantiation benchmarks we have in-repo (or some interesting subset of them) to see the impact on the extra maps here?</p>\n</blockquote>",
        "id": 561274483,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764623383
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#discussion_r2578602328\">PR review comment</a>:</p>\n<blockquote>\n<p>To help resolve this could this return an error if <code>guest_debug</code> is enabled? (and then have a fixme-pointing-to-issue to resolve it in the future if necessary)</p>\n</blockquote>",
        "id": 561274485,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764623383
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#discussion_r2578464085\">PR review comment</a>:</p>\n<blockquote>\n<p>As a small change, could this return an error for <code>ExternallyOwned</code> and then use the host page size for alignment for <code>MmapVec::Mmap</code>?</p>\n</blockquote>",
        "id": 561274488,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764623384
    },
    {
        "content": "<p>fitzgen submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#pullrequestreview-3527186223\">PR review</a>.</p>",
        "id": 561281621,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764625485
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#discussion_r2578827884\">PR review comment</a>:</p>\n<blockquote>\n<p>Yeah for sure, was not suggesting anything that needs to be dealt with here and now.</p>\n</blockquote>",
        "id": 561281623,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764625486
    },
    {
        "content": "<p>cfallin updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051\">PR #12051</a>.</p>",
        "id": 561304001,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764637199
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#pullrequestreview-3527679138\">PR review</a>.</p>",
        "id": 561304026,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764637208
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#discussion_r2579204841\">PR review comment</a>:</p>\n<blockquote>\n<p>Done!</p>\n</blockquote>",
        "id": 561304028,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764637209
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#pullrequestreview-3527679294\">PR review</a>.</p>",
        "id": 561304035,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764637213
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#discussion_r2579204944\">PR review comment</a>:</p>\n<blockquote>\n<p>Done!</p>\n</blockquote>",
        "id": 561304036,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764637213
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#pullrequestreview-3527679817\">PR review</a>.</p>",
        "id": 561304054,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764637228
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#discussion_r2579205285\">PR review comment</a>:</p>\n<blockquote>\n<p>Sure, done!</p>\n</blockquote>",
        "id": 561304055,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764637228
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#pullrequestreview-3527680297\">PR review</a>.</p>",
        "id": 561304071,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764637242
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#discussion_r2579205680\">PR review comment</a>:</p>\n<blockquote>\n<p>Done!</p>\n</blockquote>",
        "id": 561304072,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764637242
    },
    {
        "content": "<p>cfallin updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051\">PR #12051</a>.</p>",
        "id": 561305651,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764638199
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#pullrequestreview-3527717464\">PR review</a>.</p>",
        "id": 561305881,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764638291
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#discussion_r2579235641\">PR review comment</a>:</p>\n<blockquote>\n<p>Yeah, definitely! It got a little silly with <code>optional_gc_store_and_registry_and_instance_mut</code> but, well, what happens in no-partial-borrows-land stays in no-partial-borrows-land...</p>\n</blockquote>",
        "id": 561305882,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764638291
    },
    {
        "content": "<p>cfallin updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051\">PR #12051</a>.</p>",
        "id": 561306274,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764638511
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#discussion_r2579243005\">PR review comment</a>:</p>\n<blockquote>\n<p>Done!</p>\n</blockquote>",
        "id": 561306283,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764638517
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#pullrequestreview-3527726530\">PR review</a>.</p>",
        "id": 561306285,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764638517
    },
    {
        "content": "<p>cfallin updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051\">PR #12051</a>.</p>",
        "id": 561306574,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764638705
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#pullrequestreview-3527735625\">PR review</a>.</p>",
        "id": 561306606,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764638722
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#discussion_r2579249929\">PR review comment</a>:</p>\n<blockquote>\n<p>Yep, great point -- filed #12104 and added a comment here.</p>\n</blockquote>",
        "id": 561306607,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764638722
    },
    {
        "content": "<p>cfallin updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051\">PR #12051</a>.</p>",
        "id": 561306700,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764638778
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#discussion_r2579259877\">PR review comment</a>:</p>\n<blockquote>\n<p>Ah, yep, I think I removed this without remembering what I had done for the <code>Module</code> case; over there I added some comments describing that it may not represent all code actually executed.</p>\n</blockquote>",
        "id": 561307245,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764638986
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#pullrequestreview-3527749771\">PR review</a>.</p>",
        "id": 561307246,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764638986
    },
    {
        "content": "<p>cfallin updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051\">PR #12051</a>.</p>",
        "id": 561307300,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764639013
    },
    {
        "content": "<p>cfallin updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051\">PR #12051</a>.</p>",
        "id": 561307926,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764639333
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#pullrequestreview-3527763258\">PR review</a>.</p>",
        "id": 561307943,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764639339
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#discussion_r2579270618\">PR review comment</a>:</p>\n<blockquote>\n<p>Done! Filed #12105.</p>\n</blockquote>",
        "id": 561307944,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764639340
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#pullrequestreview-3527939437\">PR review</a>.</p>",
        "id": 561315536,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764644296
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#discussion_r2579414813\">PR review comment</a>:</p>\n<blockquote>\n<p>Sure -- looks like about a 3% hit on a small module, sequential instantiation:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">bench</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">bench</span><span class=\"w\"> </span><span class=\"n\">instantiation</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"w\"> </span><span class=\"n\">sequential</span><span class=\"o\">/</span><span class=\"n\">pooling</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n\n<span class=\"p\">[</span><span class=\"w\"> </span><span class=\"n\">baseline</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"p\">]</span>\n\n<span class=\"n\">sequential</span><span class=\"o\">/</span><span class=\"n\">pooling</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n<span class=\"w\">                        </span><span class=\"n\">time</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"p\">[</span><span class=\"mf\">1.4748</span><span class=\"w\"> </span><span class=\"err\">µ</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"mf\">1.4770</span><span class=\"w\"> </span><span class=\"err\">µ</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"mf\">1.4795</span><span class=\"w\"> </span><span class=\"err\">µ</span><span class=\"n\">s</span><span class=\"p\">]</span>\n\n<span class=\"p\">[</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">with</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"w\"> </span><span class=\"n\">PR</span><span class=\"o\">'</span><span class=\"na\">s</span><span class=\"w\"> </span><span class=\"n\">changes</span><span class=\"w\"> </span><span class=\"p\">]</span>\n\n<span class=\"n\">sequential</span><span class=\"o\">/</span><span class=\"n\">pooling</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n<span class=\"w\">                        </span><span class=\"n\">time</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"p\">[</span><span class=\"mf\">1.5173</span><span class=\"w\"> </span><span class=\"err\">µ</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"mf\">1.5184</span><span class=\"w\"> </span><span class=\"err\">µ</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"mf\">1.5196</span><span class=\"w\"> </span><span class=\"err\">µ</span><span class=\"n\">s</span><span class=\"p\">]</span>\n<span class=\"w\">                        </span><span class=\"n\">change</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"o\">+</span><span class=\"mf\">2.9095</span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"mf\">3.0865</span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"mf\">3.2436</span><span class=\"o\">%</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">0.00</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"mf\">0.05</span><span class=\"p\">)</span>\n<span class=\"w\">                        </span><span class=\"n\">Performance</span><span class=\"w\"> </span><span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">regressed</span><span class=\"p\">.</span>\n</code></pre></div>\n<p>Since this is constant-overhead-per-module, the operative number is the extra ~40 ns; that seems OK to me?</p>\n</blockquote>",
        "id": 561315537,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764644296
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#issuecomment-3600018870\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051\">PR #12051</a>:</p>\n<blockquote>\n<blockquote>\n<blockquote>\n<p>[indirect function calls]</p>\n</blockquote>\n<p>I didn't run across this myself, so I wanted to clarify -- is this still present or did this end up getting resolved during refactoring?</p>\n</blockquote>\n<p>I was worried about the additional overhead of the <code>EngineCode</code> -&gt; <code>StoreCode</code> lookup in <code>Instance::get_func_ref</code> but that's one <code>BTreeMap</code> lookup, in a <code>BTreeMap</code> likely to have only one or a few entries, and only once per table slot invoked so perhaps not too bad? Actually, let's benchmark -- Sightglass says:</p>\n<p><div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"n\">RUST_LOG</span><span class=\"o\">=</span><span class=\"n\">info</span><span class=\"w\"> </span><span class=\"n\">taskset</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"o\">/</span><span class=\"n\">release</span><span class=\"o\">/</span><span class=\"n\">sightglass</span><span class=\"o\">-</span><span class=\"n\">cli</span><span class=\"w\"> </span><span class=\"n\">benchmark</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">../</span><span class=\"n\">wasmtime</span><span class=\"o\">/</span><span class=\"n\">old</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">e</span><span class=\"w\"> </span><span class=\"o\">../</span><span class=\"n\">wasmtime</span><span class=\"o\">/</span><span class=\"n\">new</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">iterations</span><span class=\"o\">-</span><span class=\"n\">per</span><span class=\"o\">-</span><span class=\"n\">process</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">processes</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"n\">benchmarks</span><span class=\"o\">/</span><span class=\"n\">default</span><span class=\"p\">.</span><span class=\"n\">suite</span>\n<span class=\"p\">[</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"p\">]</span>\n<span class=\"n\">execution</span><span class=\"w\"> </span><span class=\"p\">::</span><span class=\"w\"> </span><span class=\"nc\">cycles</span><span class=\"w\"> </span><span class=\"p\">::</span><span class=\"w\"> </span><span class=\"nc\">benchmarks</span><span class=\"o\">/</span><span class=\"n\">bz2</span><span class=\"o\">/</span><span class=\"n\">benchmark</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n\n<span class=\"w\">  </span><span class=\"n\">No</span><span class=\"w\"> </span><span class=\"n\">difference</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">performance</span><span class=\"p\">.</span>\n\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">71002288</span><span class=\"w\"> </span><span class=\"mf\">72007774.20</span><span class=\"w\"> </span><span class=\"mi\">72896266</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">new</span><span class=\"p\">.</span><span class=\"n\">so</span>\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">70196726</span><span class=\"w\"> </span><span class=\"mf\">71271162.70</span><span class=\"w\"> </span><span class=\"mi\">73367632</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">old</span><span class=\"p\">.</span><span class=\"n\">so</span>\n\n<span class=\"n\">execution</span><span class=\"w\"> </span><span class=\"p\">::</span><span class=\"w\"> </span><span class=\"nc\">cycles</span><span class=\"w\"> </span><span class=\"p\">::</span><span class=\"w\"> </span><span class=\"nc\">benchmarks</span><span class=\"o\">/</span><span class=\"n\">spidermonkey</span><span class=\"o\">/</span><span class=\"n\">benchmark</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n\n<span class=\"w\">  </span><span class=\"n\">No</span><span class=\"w\"> </span><span class=\"n\">difference</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">performance</span><span class=\"p\">.</span>\n\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">449806273</span><span class=\"w\"> </span><span class=\"mf\">459920466.40</span><span class=\"w\"> </span><span class=\"mi\">477878694</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">new</span><span class=\"p\">.</span><span class=\"n\">so</span>\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">455205740</span><span class=\"w\"> </span><span class=\"mf\">461003924.50</span><span class=\"w\"> </span><span class=\"mi\">470907233</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">old</span><span class=\"p\">.</span><span class=\"n\">so</span>\n\n<span class=\"n\">execution</span><span class=\"w\"> </span><span class=\"p\">::</span><span class=\"w\"> </span><span class=\"nc\">cycles</span><span class=\"w\"> </span><span class=\"p\">::</span><span class=\"w\"> </span><span class=\"nc\">benchmarks</span><span class=\"o\">/</span><span class=\"n\">pulldown</span><span class=\"o\">-</span><span class=\"n\">cmark</span><span class=\"o\">/</span><span class=\"n\">benchmark</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n\n<span class=\"w\">  </span><span class=\"n\">No</span><span class=\"w\"> </span><span class=\"n\">difference</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">performance</span><span class=\"p\">.</span>\n\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">4736966</span><span class=\"w\"> </span><span class=\"mf\">4816051.60</span><span class=\"w\"> </span><span class=\"mi\">5011779</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">new</span><span class=\"p\">.</span><span class=\"n\">so</span>\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">4713058</span><span class=\"w\"> </span><span class=\"mf\">4819706.60</span><span class=\"w\"> </span><span class=\"mi\">5088233</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">old</span><span class=\"p\">.</span><span class=\"n\">so</span>\n</code></pre></div><br>\n</p>\n</blockquote>",
        "id": 561318340,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764646363
    },
    {
        "content": "<p>cfallin updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051\">PR #12051</a>.</p>",
        "id": 561318414,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764646415
    },
    {
        "content": "<p>cfallin updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051\">PR #12051</a>.</p>",
        "id": 561318597,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764646557
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#pullrequestreview-3527994809\">PR review</a>.</p>",
        "id": 561318738,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764646657
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#discussion_r2579467444\">PR review comment</a>:</p>\n<blockquote>\n<p>Hmm, actually, this seems to cause a test failure: the registration always happens, so we can't simply throw an error. I think maybe the best we can do (short of a refactor that carries the <code>ProfilingAgent</code> through to the point of instantiation, not just module loading, and registers each instantiation) is have the caveat that <code>perf record</code> will not have registered profiling info for debugging-private copies of code. This may be fine (given issue to track)?</p>\n</blockquote>",
        "id": 561318739,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764646657
    },
    {
        "content": "<p>cfallin updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051\">PR #12051</a>.</p>",
        "id": 561318812,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764646715
    },
    {
        "content": "<p>cfallin updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051\">PR #12051</a>.</p>",
        "id": 561318856,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764646737
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#issuecomment-3600036079\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051\">PR #12051</a>:</p>\n<blockquote>\n<p>OK, I think this is ready for another look -- thanks @alexcrichton!</p>\n</blockquote>",
        "id": 561318891,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764646760
    },
    {
        "content": "<p>fitzgen <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#issuecomment-3603681238\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051\">PR #12051</a>:</p>\n<blockquote>\n<blockquote>\n<p>Actually, let's benchmark -- Sightglass says:</p>\n</blockquote>\n<p>2 processes x 5 iterations per process = 10 total samples per group. You can't generally do significance tests with less than 30 samples per group (and you probably want more than that for the <code>cycles</code> measure, since it is so noisy).</p>\n<p>If you're going to benchmark, then you should do it properly :-p</p>\n<p>Also, fwiw, we have some call-indirect specific micro benchmarks <a href=\"https://github.com/bytecodealliance/wasmtime/blob/196f09fe95efeae48724344b63c8b2182e127ce0/benches/call.rs#L901\">here</a> which might be better for measuring this specific thing.</p>\n</blockquote>",
        "id": 561504580,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764704462
    },
    {
        "content": "<p>fitzgen edited a <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#issuecomment-3603681238\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051\">PR #12051</a>:</p>\n<blockquote>\n<blockquote>\n<p>Actually, let's benchmark -- Sightglass says:</p>\n</blockquote>\n<p>2 processes x 5 iterations per process = 10 total samples per group. You can't generally do significance tests with less than 30 samples per group (and you probably want more than that for the <code>cycles</code> measure, since it is so noisy).</p>\n<p>If you're going to benchmark, then you should do it properly :-p</p>\n<p>If the amount of time taken to run the benchmarks was a concern, then you could pass <code>--benchmark-phase execution</code> to avoid re-compiling on each iteration.</p>\n<p>Also, fwiw, we have some call-indirect specific micro benchmarks <a href=\"https://github.com/bytecodealliance/wasmtime/blob/196f09fe95efeae48724344b63c8b2182e127ce0/benches/call.rs#L901\">here</a> which might be better for measuring this specific thing.</p>\n</blockquote>",
        "id": 561505201,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764704638
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#issuecomment-3603739174\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051\">PR #12051</a>:</p>\n<blockquote>\n<p>OK, cool, I'll rerun this in a bit. Indeed I only had a small sliver of time last night and didn't want to wait hours for results. Good to know that one can re-use compilations, thanks.</p>\n<p>My intent with using the real-program benchmarks rather than microbenchmarks was to measure the effect of call-indirects in proper context, but I can do the microbenchmarks too.</p>\n</blockquote>",
        "id": 561507909,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764705572
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#issuecomment-3603826973\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051\">PR #12051</a>:</p>\n<blockquote>\n<p>Here's the data with 100 data points:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">execution</span><span class=\"w\"> </span><span class=\"p\">::</span><span class=\"w\"> </span><span class=\"nc\">cycles</span><span class=\"w\"> </span><span class=\"p\">::</span><span class=\"w\"> </span><span class=\"nc\">benchmarks</span><span class=\"o\">/</span><span class=\"n\">pulldown</span><span class=\"o\">-</span><span class=\"n\">cmark</span><span class=\"o\">/</span><span class=\"n\">benchmark</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n\n<span class=\"w\">  </span><span class=\"err\">Δ</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">50870.29</span><span class=\"w\"> </span><span class=\"err\">±</span><span class=\"w\"> </span><span class=\"mf\">39152.71</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">confidence</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">99</span><span class=\"o\">%</span><span class=\"p\">)</span>\n\n<span class=\"w\">  </span><span class=\"n\">old</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"mf\">1.00</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"mf\">1.02</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">faster</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">new</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"o\">!</span>\n\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">4490103</span><span class=\"w\"> </span><span class=\"mf\">4689894.33</span><span class=\"w\"> </span><span class=\"mi\">5160645</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">new</span><span class=\"p\">.</span><span class=\"n\">so</span>\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">4502186</span><span class=\"w\"> </span><span class=\"mf\">4639024.04</span><span class=\"w\"> </span><span class=\"mi\">4995740</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">old</span><span class=\"p\">.</span><span class=\"n\">so</span>\n\n<span class=\"n\">execution</span><span class=\"w\"> </span><span class=\"p\">::</span><span class=\"w\"> </span><span class=\"nc\">cycles</span><span class=\"w\"> </span><span class=\"p\">::</span><span class=\"w\"> </span><span class=\"nc\">benchmarks</span><span class=\"o\">/</span><span class=\"n\">spidermonkey</span><span class=\"o\">/</span><span class=\"n\">benchmark</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n\n<span class=\"w\">  </span><span class=\"err\">Δ</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">3902443.50</span><span class=\"w\"> </span><span class=\"err\">±</span><span class=\"w\"> </span><span class=\"mf\">1435000.11</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">confidence</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">99</span><span class=\"o\">%</span><span class=\"p\">)</span>\n\n<span class=\"w\">  </span><span class=\"n\">old</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"mf\">1.01</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"mf\">1.01</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">faster</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">new</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"o\">!</span>\n\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">452564035</span><span class=\"w\"> </span><span class=\"mf\">458920590.84</span><span class=\"w\"> </span><span class=\"mi\">468422822</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">new</span><span class=\"p\">.</span><span class=\"n\">so</span>\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">447394704</span><span class=\"w\"> </span><span class=\"mf\">455018147.34</span><span class=\"w\"> </span><span class=\"mi\">464078661</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">old</span><span class=\"p\">.</span><span class=\"n\">so</span>\n\n<span class=\"n\">execution</span><span class=\"w\"> </span><span class=\"p\">::</span><span class=\"w\"> </span><span class=\"nc\">cycles</span><span class=\"w\"> </span><span class=\"p\">::</span><span class=\"w\"> </span><span class=\"nc\">benchmarks</span><span class=\"o\">/</span><span class=\"n\">bz2</span><span class=\"o\">/</span><span class=\"n\">benchmark</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n\n<span class=\"w\">  </span><span class=\"n\">No</span><span class=\"w\"> </span><span class=\"n\">difference</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">performance</span><span class=\"p\">.</span>\n\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">69507823</span><span class=\"w\"> </span><span class=\"mf\">70879740.15</span><span class=\"w\"> </span><span class=\"mi\">73834440</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">new</span><span class=\"p\">.</span><span class=\"n\">so</span>\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">69568496</span><span class=\"w\"> </span><span class=\"mf\">71123992.19</span><span class=\"w\"> </span><span class=\"mi\">74071155</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">old</span><span class=\"p\">.</span><span class=\"n\">so</span>\n</code></pre></div>\n<p>So a slight slowdown in SpiderMonkey (1%), for example, which makes heavier use of virtual calls.</p>\n<p>I might have some ideas for refactoring the <code>ModuleRegistry::store_code</code> lookup to return a thin wrapper over <code>EngineCode</code> when we aren't configured to do private cloning, which would eliminate the extra lookup -- let me see if that helps...</p>\n</blockquote>",
        "id": 561512004,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764707032
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#issuecomment-3603923368\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051\">PR #12051</a>:</p>\n<blockquote>\n<p>A little more experimentation: I made a <a href=\"https://github.com/cfallin/wasmtime/commit/73b0bbe8d5101e5849a22404f2809895f0ee7495\">small tweak</a> so that we don't do the StoreCode lookup from EngineCode when debugging is not enabled, but rather directly use the EngineCode's image. (Bikeshed the safety type wrappers maybe but the point is the perf experiment)</p>\n<p>It turns out that this doesn't help: <code>old.so</code> is baseline, <code>new.so</code> is this PR, <code>new2.so</code> is the above commit:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">execution</span><span class=\"w\"> </span><span class=\"p\">::</span><span class=\"w\"> </span><span class=\"nc\">cycles</span><span class=\"w\"> </span><span class=\"p\">::</span><span class=\"w\"> </span><span class=\"nc\">benchmarks</span><span class=\"o\">/</span><span class=\"n\">spidermonkey</span><span class=\"o\">/</span><span class=\"n\">benchmark</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n\n<span class=\"w\">  </span><span class=\"err\">Δ</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">3293570.64</span><span class=\"w\"> </span><span class=\"err\">±</span><span class=\"w\"> </span><span class=\"mf\">801397.15</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">confidence</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">99</span><span class=\"o\">%</span><span class=\"p\">)</span>\n\n<span class=\"w\">  </span><span class=\"n\">old</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"mf\">1.01</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"mf\">1.01</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">faster</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">new2</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"o\">!</span>\n\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">444994186</span><span class=\"w\"> </span><span class=\"mf\">457634102.82</span><span class=\"w\"> </span><span class=\"mi\">472147181</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">new2</span><span class=\"p\">.</span><span class=\"n\">so</span>\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">444580053</span><span class=\"w\"> </span><span class=\"mf\">454340532.18</span><span class=\"w\"> </span><span class=\"mi\">464774917</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">old</span><span class=\"p\">.</span><span class=\"n\">so</span>\n\n<span class=\"n\">execution</span><span class=\"w\"> </span><span class=\"p\">::</span><span class=\"w\"> </span><span class=\"nc\">cycles</span><span class=\"w\"> </span><span class=\"p\">::</span><span class=\"w\"> </span><span class=\"nc\">benchmarks</span><span class=\"o\">/</span><span class=\"n\">spidermonkey</span><span class=\"o\">/</span><span class=\"n\">benchmark</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n\n<span class=\"w\">  </span><span class=\"err\">Δ</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">1711875.58</span><span class=\"w\"> </span><span class=\"err\">±</span><span class=\"w\"> </span><span class=\"mf\">601308.43</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">confidence</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">99</span><span class=\"o\">%</span><span class=\"p\">)</span>\n\n<span class=\"w\">  </span><span class=\"n\">new</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"mf\">1.00</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"mf\">1.01</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">faster</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">new2</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"o\">!</span>\n\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">443090662</span><span class=\"w\"> </span><span class=\"mf\">452795699.65</span><span class=\"w\"> </span><span class=\"mi\">464339929</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">new</span><span class=\"p\">.</span><span class=\"n\">so</span>\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">445620051</span><span class=\"w\"> </span><span class=\"mf\">454507575.23</span><span class=\"w\"> </span><span class=\"mi\">465311385</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">new2</span><span class=\"p\">.</span><span class=\"n\">so</span>\n</code></pre></div>\n<p>(aside: Sightglass has a bug where with <code>new.so</code> and <code>new2.so</code>, it strips the common prefix and reports results for <code>.so</code> and <code>2.so</code>; manually edited the above. No energy to go fix that at the moment)</p>\n<p>So perhaps the ~1% overhead is in the additional plumbing in general on the table funcref init path; that's unavoidable unless we monomorphize the whole funcref-related runtime (libcalls on down) on debug and no-debug versions I think. Maybe we eat the 1%. What do you think?</p>\n</blockquote>",
        "id": 561516880,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764708917
    },
    {
        "content": "<p>cfallin edited a <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#issuecomment-3603923368\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051\">PR #12051</a>:</p>\n<blockquote>\n<p>A little more experimentation: I made a <a href=\"https://github.com/cfallin/wasmtime/commit/73b0bbe8d5101e5849a22404f2809895f0ee7495\">small tweak</a> so that we don't do the StoreCode lookup from EngineCode when debugging is not enabled, but rather directly use the EngineCode's image. (Bikeshed the safety type wrappers maybe but the point is the perf experiment)</p>\n<p>It turns out that this doesn't help: <code>old.so</code> is baseline, <code>new.so</code> is this PR, <code>new2.so</code> is the above commit (two separate pairwise runs; 10 processes and 50 data points per process):</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">execution</span><span class=\"w\"> </span><span class=\"p\">::</span><span class=\"w\"> </span><span class=\"nc\">cycles</span><span class=\"w\"> </span><span class=\"p\">::</span><span class=\"w\"> </span><span class=\"nc\">benchmarks</span><span class=\"o\">/</span><span class=\"n\">spidermonkey</span><span class=\"o\">/</span><span class=\"n\">benchmark</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n\n<span class=\"w\">  </span><span class=\"err\">Δ</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">3293570.64</span><span class=\"w\"> </span><span class=\"err\">±</span><span class=\"w\"> </span><span class=\"mf\">801397.15</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">confidence</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">99</span><span class=\"o\">%</span><span class=\"p\">)</span>\n\n<span class=\"w\">  </span><span class=\"n\">old</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"mf\">1.01</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"mf\">1.01</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">faster</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">new2</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"o\">!</span>\n\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">444994186</span><span class=\"w\"> </span><span class=\"mf\">457634102.82</span><span class=\"w\"> </span><span class=\"mi\">472147181</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">new2</span><span class=\"p\">.</span><span class=\"n\">so</span>\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">444580053</span><span class=\"w\"> </span><span class=\"mf\">454340532.18</span><span class=\"w\"> </span><span class=\"mi\">464774917</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">old</span><span class=\"p\">.</span><span class=\"n\">so</span>\n\n<span class=\"n\">execution</span><span class=\"w\"> </span><span class=\"p\">::</span><span class=\"w\"> </span><span class=\"nc\">cycles</span><span class=\"w\"> </span><span class=\"p\">::</span><span class=\"w\"> </span><span class=\"nc\">benchmarks</span><span class=\"o\">/</span><span class=\"n\">spidermonkey</span><span class=\"o\">/</span><span class=\"n\">benchmark</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n\n<span class=\"w\">  </span><span class=\"err\">Δ</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">1711875.58</span><span class=\"w\"> </span><span class=\"err\">±</span><span class=\"w\"> </span><span class=\"mf\">601308.43</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">confidence</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">99</span><span class=\"o\">%</span><span class=\"p\">)</span>\n\n<span class=\"w\">  </span><span class=\"n\">new</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"mf\">1.00</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"mf\">1.01</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"n\">faster</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">new2</span><span class=\"p\">.</span><span class=\"n\">so</span><span class=\"o\">!</span>\n\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">443090662</span><span class=\"w\"> </span><span class=\"mf\">452795699.65</span><span class=\"w\"> </span><span class=\"mi\">464339929</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">new</span><span class=\"p\">.</span><span class=\"n\">so</span>\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">445620051</span><span class=\"w\"> </span><span class=\"mf\">454507575.23</span><span class=\"w\"> </span><span class=\"mi\">465311385</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">new2</span><span class=\"p\">.</span><span class=\"n\">so</span>\n</code></pre></div>\n<p>(aside: Sightglass has a bug where with <code>new.so</code> and <code>new2.so</code>, it strips the common prefix and reports results for <code>.so</code> and <code>2.so</code>; manually edited the above. No energy to go fix that at the moment)</p>\n<p>So perhaps the ~1% overhead is in the additional plumbing in general on the table funcref init path; that's unavoidable unless we monomorphize the whole funcref-related runtime (libcalls on down) on debug and no-debug versions I think. Maybe we eat the 1%. What do you think?</p>\n</blockquote>",
        "id": 561517073,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764708980
    },
    {
        "content": "<p>fitzgen <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#issuecomment-3604282162\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051\">PR #12051</a>:</p>\n<blockquote>\n<blockquote>\n<p>didn't want to wait hours for results</p>\n</blockquote>\n<p>If I do a full run of <code>default.suite</code> it takes 27 mins on my old thinkpad, probably faster for you on a newer MBP, fwiw. Also faster if doing <code>--benchmark-phase execution</code> or if measuring instructions retired and you can drop to a small handful of iterations. But yeah 27 mins is not great.</p>\n<blockquote>\n<p>So perhaps the ~1% overhead is in the additional plumbing in general on the table funcref init path; that's unavoidable unless we monomorphize the whole funcref-related runtime (libcalls on down) on debug and no-debug versions I think. Maybe we eat the 1%. What do you think?</p>\n</blockquote>\n<p>This is only the case for lazy table init, right? If it isn't lazy then we'd still be hitting these branches, but at instantiation time instead, and we would be doing them all at once, so presumably the branch predictor would be more useful in that case, no?</p>\n<p>If this is only for lazy table init, then yeah seems fine by me. Although maybe Alex has more ideas here. I originally was thinking that the module registry could possibly contain a hash map instead of a btree map for the new member, but it sounds like the costs are not related to the data structure.</p>\n<p>Slightly more concerning if this is a 1% slowdown regardless of lazy table init...</p>\n</blockquote>",
        "id": 561535281,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764716126
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#issuecomment-3604307579\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051\">PR #12051</a>:</p>\n<blockquote>\n<blockquote>\n<p>This is only the case for lazy table init, right? </p>\n</blockquote>\n<p>It seems so, yeah -- flipping the default to eager table init in tunables, I get (100 data points, 10 proc * 10/proc):</p>\n<p><div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">execution</span><span class=\"w\"> </span><span class=\"p\">::</span><span class=\"w\"> </span><span class=\"nc\">cycles</span><span class=\"w\"> </span><span class=\"p\">::</span><span class=\"w\"> </span><span class=\"nc\">benchmarks</span><span class=\"o\">/</span><span class=\"n\">spidermonkey</span><span class=\"o\">/</span><span class=\"n\">benchmark</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n\n<span class=\"w\">  </span><span class=\"n\">No</span><span class=\"w\"> </span><span class=\"n\">difference</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">performance</span><span class=\"p\">.</span>\n\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">453510422</span><span class=\"w\"> </span><span class=\"mf\">463605372.90</span><span class=\"w\"> </span><span class=\"mi\">509169192</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">new</span><span class=\"o\">-</span><span class=\"n\">eager</span><span class=\"o\">-</span><span class=\"n\">init</span><span class=\"p\">.</span><span class=\"n\">so</span>\n<span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mi\">453961879</span><span class=\"w\"> </span><span class=\"mf\">467730247.66</span><span class=\"w\"> </span><span class=\"mi\">531244575</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">old</span><span class=\"o\">-</span><span class=\"n\">eager</span><span class=\"o\">-</span><span class=\"n\">init</span><span class=\"p\">.</span><span class=\"n\">so</span>\n</code></pre></div><br>\n</p>\n</blockquote>",
        "id": 561536297,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764716644
    },
    {
        "content": "<p>alexcrichton submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#pullrequestreview-3532604966\">PR review</a>:</p>\n<blockquote>\n<p>Code all looks good to me, thanks for the updates!</p>\n<p>Questions on perf though, so it sounds like:</p>\n<ul>\n<li>Instantiation-wise this is measured as a 3% regression.</li>\n<li>call_indirect-wise it's measured as a \"no meaningful change\"</li>\n</ul>\n<p>Is that right?</p>\n<p>I would view this as adding relatively low-hanging fruit to the \"perf tree\" to pick in the future, and to me it's mostly a question of whether we pick that fruit here or not. The extra data structures can likely be optimized with fewer lookups/insertions or something like that when debugging enabled is my thinking.</p>\n<p>We're also not really measuring heap impact (IIRC B-Trees are relatively bad for that?) which might be another consideration here. Basically I would be surprised if these exact data structures lived as-is for a long period of time past perf testing and such. I'd be more comfortable if the addition of debugging-related features didn't impact the data structures when debugging wasn't turned on, but it's a pretty minor impact here.</p>\n<p>Basically I'm ok with this personally, but I think if we land this as-is it's worth opening an issue describing the possible optimization opportunity. More-or-less it feels like we shouldn't need 4 btree insertions when a single module is instantiated in a store in the fast path. That feels like it's pretty overkill relative to \"lightweight instantiation\". I realize we probably already have 3 insertions or something like that today, but this is basically a ripe area for optimization in the future if someone's interested.</p>\n</blockquote>",
        "id": 561542480,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764720161
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#issuecomment-3604552754\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051\">PR #12051</a>:</p>\n<blockquote>\n<p>Yep, that's right, and I'm happy to file an issue for followup. The refactor I did above to remove the <code>StoreCode</code> lookup for the <code>get_func_ref</code> path could probably be carried further to actually not materialize a true <code>StoreCode</code> at instantiation (instead building a view of text/range in <code>ModuleWithCode</code> when queried) in the non-debugging case; that should let us get back to status quo. It may also be worth optimizing the one-module case (?) -- BTree lookups in a tree of one entry are fast but there's still the allocation and initialization cost.</p>\n</blockquote>",
        "id": 561546062,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764723025
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051#issuecomment-3604561357\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051\">PR #12051</a>:</p>\n<blockquote>\n<p>Followup filed at #12111.</p>\n</blockquote>",
        "id": 561546331,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764723218
    },
    {
        "content": "<p>cfallin merged <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12051\">PR #12051</a>.</p>",
        "id": 561549755,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764726065
    }
]
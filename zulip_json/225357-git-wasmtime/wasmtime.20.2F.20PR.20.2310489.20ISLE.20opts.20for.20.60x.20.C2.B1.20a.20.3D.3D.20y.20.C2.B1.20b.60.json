[
    {
        "content": "<p>scottmcm opened <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10489\">PR #10489</a> from <code>scottmcm:eq-add</code> to <code>bytecodealliance:main</code>:</p>\n<blockquote>\n<p>Noticed these looking at niched discriminant calculations, because <code>discr(a) == discr(b)</code> sometimes expands to <code>frobble(a) + OFFSET == frobble(b) + OFFSET</code>, where it's quite helpful to simplify to <code>frobble(a) == frobble(b)</code> instead.<br>\n</p>\n</blockquote>",
        "id": 508973799,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1743296404
    },
    {
        "content": "<p><strong>scottmcm</strong> requested <a href=\"https://github.com/abrown\">abrown</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10489\">PR #10489</a>.</p>",
        "id": 508973800,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1743296404
    },
    {
        "content": "<p><strong>scottmcm</strong> requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers\">wasmtime-compiler-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10489\">PR #10489</a>.</p>",
        "id": 508973802,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1743296405
    },
    {
        "content": "<p><strong>scottmcm</strong> requested <a href=\"https://github.com/fitzgen\">fitzgen</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10489\">PR #10489</a>.</p>",
        "id": 508976681,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1743298373
    },
    {
        "content": "<p>scottmcm updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10489\">PR #10489</a>.</p>",
        "id": 508976682,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1743298373
    },
    {
        "content": "<p><strong>scottmcm</strong> requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers\">wasmtime-core-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10489\">PR #10489</a>.</p>",
        "id": 508976683,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1743298373
    },
    {
        "content": "<p>scottmcm submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10489#pullrequestreview-2727784267\">PR review</a>.</p>",
        "id": 508977398,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1743298884
    },
    {
        "content": "<p>scottmcm created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10489#discussion_r2020044587\">PR review comment</a>:</p>\n<blockquote>\n<p>A case in the wild, here: was <code>a + -1 == 0</code>, now <code>a == 1</code>.</p>\n</blockquote>",
        "id": 508977399,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1743298884
    },
    {
        "content": "<p>scottmcm submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10489#pullrequestreview-2727786374\">PR review</a>.</p>",
        "id": 508979105,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1743300172
    },
    {
        "content": "<p>scottmcm created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10489#discussion_r2020046735\">PR review comment</a>:</p>\n<blockquote>\n<p>Remind me: is this the kind of place where it makes sense to <code>subsume</code> so it stops looking at further <code>iadd</code>/<code>isub</code> rules?</p>\n</blockquote>",
        "id": 508979106,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1743300172
    },
    {
        "content": "<p>scottmcm updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10489\">PR #10489</a>.</p>",
        "id": 508981300,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1743302023
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10489#pullrequestreview-2727791756\">PR review</a>.</p>",
        "id": 508982975,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1743303470
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10489#discussion_r2020052378\">PR review comment</a>:</p>\n<blockquote>\n<p>Yes, in this case it seems reasonable IMHO -- we're completely removing an op; it feels similar to cprop, where we also subsume because we have unambiguous improvements.</p>\n</blockquote>",
        "id": 508982976,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1743303470
    },
    {
        "content": "<p>scottmcm updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10489\">PR #10489</a>.</p>",
        "id": 508985725,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1743305893
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10489#pullrequestreview-2727799385\">PR review</a>:</p>\n<blockquote>\n<p>Nice, thanks!</p>\n</blockquote>",
        "id": 508988119,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1743308247
    },
    {
        "content": "<p>cfallin merged <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10489\">PR #10489</a>.</p>",
        "id": 508989464,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1743309608
    },
    {
        "content": "<p>fitzgen submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10489#pullrequestreview-2730258116\">PR review</a>.</p>",
        "id": 509280014,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1743447678
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10489#discussion_r2021615514\">PR review comment</a>:</p>\n<blockquote>\n<p>What if we could apply not only this rule, but also cprop the whole thing away? In that case, we would get two rewritten values marked as subsume, and would choose between then arbitrarily, but we would always want the constant right? Should we only be using subsume for constant results? Remembering the rules around subsumption is always frought for me...</p>\n</blockquote>",
        "id": 509280015,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1743447678
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10489#pullrequestreview-2730303637\">PR review</a>.</p>",
        "id": 509283344,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1743448953
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10489#discussion_r2021643624\">PR review comment</a>:</p>\n<blockquote>\n<p>\"Nested subsumes\" will actually work out fine I think, with the new implementation I merged last week: at each level there is only one value returned that is subsumed. Another way to think of it is that the outer subsume takes an argument that comes from the inner rewrite's result, which is (because of the inner subsume) the one constant value, so that constant value flows all the way outward.</p>\n<p>In general I think \"subsume confusion\" is a result of our earlier more ad-hoc approach (as soon as we see it, stop); part of the goal of the rewrite was to make this simpler and more understandable, to the point that subsume should mean \"return this one result from this level of rewrite\" and that's it; so we shouldn't be afraid of using it IMHO.</p>\n</blockquote>",
        "id": 509283346,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1743448953
    },
    {
        "content": "<p>fitzgen submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10489#pullrequestreview-2730323278\">PR review</a>.</p>",
        "id": 509285025,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1743449554
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10489#discussion_r2021655538\">PR review comment</a>:</p>\n<blockquote>\n<p>And this rule and cprop can never both happen at the same level, because cprop uses <code>subsume</code>?</p>\n<p>That is, in this example</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">v0</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">isub</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"p\">}</span>\n<span class=\"n\">v1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">iconst</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">isub</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"p\">}</span>\n<span class=\"n\">v2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">icmp</span><span class=\"w\"> </span><span class=\"n\">eq</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v1</span>\n</code></pre></div>\n<p>we <em>would</em> hit the issue that both cprop and this rule would match and <code>subsume</code>, but we can't actually get that example because the <code>v0</code> and <code>v1</code> eclasses would never contain both the <code>iconst</code>s and the <code>isub</code>s because cprop always <code>subsume</code>s?</p>\n<p>That's pretty subtle.</p>\n</blockquote>",
        "id": 509285026,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1743449555
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10489#pullrequestreview-2730337801\">PR review</a>.</p>",
        "id": 509286359,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1743450016
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10489#discussion_r2021664462\">PR review comment</a>:</p>\n<blockquote>\n<p>Right, yeah; I guess the important points here are:</p>\n<ul>\n<li>subsume is purely heuristic; it's always <em>safe</em> to use, it will never result in a miscompilation; and</li>\n<li>it's actually important to use it when we can, i.e. when unambiguously better rewrites exist, because it results in better canonicalization;</li>\n<li>usage of subsume compounds goodness, in the sense that eliminating unnecessary representations in args can eliminate rule firings later that rewrite that (unambiguously worse) representation.</li>\n</ul>\n<p>In other words, if we <em>did</em> have the example above, there wouldn't be anything <em>wrong</em> -- we just see two different rules claiming they have the best rewrite, so we take both, and we have not as much canonicalization. (Cost-based extraction will still pick the constant in the end.)</p>\n<p>So I still think the advice is generally \"use it whenever rewrite result is unambiguously better\", and trust the framework -- in other words, I would hope we don't have to game out all of these possible outcomes when considering whether to use the feature.</p>\n</blockquote>",
        "id": 509286360,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1743450016
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10489#pullrequestreview-2730394799\">PR review</a>.</p>",
        "id": 509290939,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1743451657
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10489#discussion_r2021697130\">PR review comment</a>:</p>\n<blockquote>\n<p>(After chewing on this more to try to explain better:)</p>\n<p>Maybe the clearest way to see \"subsume\" is: it is a one-level prioritization. It's fine if multiple rules match and put results at this higher priority. We get the most goodness if we're consistent in the use of the priority, so we trim whenever appropriate, and don't get this redundant rule application. But this <em>isn't</em> correctness-bearing at all. Rule authors shouldn't need to worry about it -- the sublety you point out in the example is only \"subtle\" in the sense that the prioritizations compound and we get a good answer out at the end, but this doesn't need to be visible sublety. Regalloc is also really subtle and can interact in weird ways with IR shapes and various choices we make, but we don't worry about it because it \"just works\" -- should be the same here.</p>\n<p>(I'm trying hard to defend \"subsume\" and see it used where appropriate because it's important for good results; I think giving up on it is a mistake and so I want to quash any folkloric \"maybe don't use it\" ideas that float around; and I do think there is latent confusion from our earlier approaches that is still haunting us that is no longer applicable!)</p>\n</blockquote>",
        "id": 509290940,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1743451657
    },
    {
        "content": "<p>scottmcm submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10489#pullrequestreview-2730786213\">PR review</a>.</p>",
        "id": 509330139,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1743467466
    },
    {
        "content": "<p>scottmcm created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10489#discussion_r2021945962\">PR review comment</a>:</p>\n<blockquote>\n<p>Hmm, and I think that if we do end up in that scenario and subsume from <code>1 + 3 == 2 + 3</code> to <code>1 == 2</code>, that's ok because we'll still then apply the const-comparison rule to <em>that</em> and get the <code>false</code> in the end anyway.</p>\n<p>That said, @cfallin, if subsume isn't an \"almost never\" thing, I wonder if it'd be good to separate out -- probably just with different macros, or something, not actually changing the behaviours or the rule runner --  the \"this is an <em>equivalent</em> structure\" rules from the \"this is a <em>better</em> structure\" rules.</p>\n<p>While as I understand things it doesn't <em>work</em> this way, from your explanation it makes me think of like → vs ⇌ in chemistry, for whether things are one-way or equilibria.  It feels like what you're describing is that we want both <code>a + 0 → a</code> rules and <code>2 × a ⇌ a + a</code> rules, with actually rather more → rules now than used to be recommended.<br>\n</p>\n</blockquote>",
        "id": 509330141,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1743467466
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10489#pullrequestreview-2730794355\">PR review</a>.</p>",
        "id": 509330851,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1743467841
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10489#discussion_r2021951093\">PR review comment</a>:</p>\n<blockquote>\n<p>Sure, one option would be to build two separate top-level entry points: <code>simplify</code> vs <code>equivalent</code> or something. \"Simplify\" (our current word choice) actually to me carries the implication of directionality, while the \"not sure, either could work, keep both\" semantics associated with equality saturation is the latter. That's isomorphic to what we've done with <code>subsume</code>, maybe cleaner in some sense (conveyed via placement in a decision tree rather than a side-effect to a side-list). I don't feel too strongly about it either way...</p>\n</blockquote>",
        "id": 509330852,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1743467841
    }
]
[
    {
        "content": "<p>sammyne opened <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12112\">issue #12112</a>:</p>\n<blockquote>\n<p>It's broken to run wasm component model using wrapped <code>realloc</code> with host call.</p>\n<p>The full reproduction repository goes as <a href=\"https://github.com/sammyne/broken-memory-inspector-with-host-call\">https://github.com/sammyne/broken-memory-inspector-with-host-call</a></p>\n<h2>Environment</h2>\n<ul>\n<li>wasmtime v39.0.1</li>\n<li>wasi-sdk v29.0</li>\n<li>wasm-tools v1.243.0</li>\n<li>wit-bindgen v0.48.1</li>\n</ul>\n<h2>Project layout</h2>\n<table>\n<thead>\n<tr>\n<th>folder</th>\n<th>description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>guest</td>\n<td>C++-written wasm component</td>\n</tr>\n<tr>\n<td>host-rs</td>\n<td>Rust-written embedded wasmtime host, exposing a <code>inspect</code> api to called by guest's <code>__wrap_realloc</code></td>\n</tr>\n</tbody>\n</table>\n<h2>Core logic</h2>\n<p><strong>Guest</strong>: <code>__wrap_realloc</code> will call the real <code>realloc</code> and then call <code>inspect</code> to recorded the allocated ptr</p>\n<div class=\"codehilite\" data-code-language=\"C++\"><pre><span></span><code><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">inspect</span><span class=\"p\">(</span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">bool</span><span class=\"w\"> </span><span class=\"n\">alloc_or_free</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"n\">sammyne_hellohost_api_inspect</span><span class=\"p\">(</span><span class=\"kt\">uint64_t</span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">alloc_or_free</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n\n<span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"nf\">__wrap_realloc</span><span class=\"p\">(</span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">ptr</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"c1\">// 不能直接调用 realloc，否则递归导致栈溢出。</span>\n<span class=\"w\">  </span><span class=\"k\">auto</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">__real_realloc</span><span class=\"p\">(</span><span class=\"n\">ptr</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"p\">);</span>\n\n<span class=\"w\">  </span><span class=\"c1\">// TODO: 排查清楚加这行代码会导致失败的原因</span>\n<span class=\"w\">  </span><span class=\"c1\">// printf(\"realloc(%zu)=%p\\n\", size, p);</span>\n<span class=\"w\">  </span><span class=\"n\">inspect</span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">true</span><span class=\"p\">);</span>\n\n<span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p><strong>Host</strong>: <code>MyHost</code> will be injected into wasmtime's <code>Store</code></p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">Host</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">MyHost</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">inspect</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">addr</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">u64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">alloc_or_free</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">bool</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"fm\">println!</span><span class=\"p\">(</span><span class=\"s\">\"addr={addr},alloc-or-free={alloc_or_free}\"</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<h2>Reproduction</h2>\n<p>Using the host to load the guest wasm to tiggering call of <code>realloc</code> as</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>make<span class=\"w\"> </span>run\n</code></pre></div>\n<p>Error output as</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>Error:<span class=\"w\"> </span>call\n\nCaused<span class=\"w\"> </span>by:\n<span class=\"w\">    </span><span class=\"m\">0</span>:<span class=\"w\"> </span>error<span class=\"w\"> </span><span class=\"k\">while</span><span class=\"w\"> </span>executing<span class=\"w\"> </span>at<span class=\"w\"> </span>wasm<span class=\"w\"> </span>backtrace:\n<span class=\"w\">           </span><span class=\"m\">0</span>:<span class=\"w\">   </span>0x1e58<span class=\"w\"> </span>-<span class=\"w\"> </span>greeter.wasm!sammyne_hellohost_api_inspect\n<span class=\"w\">           </span><span class=\"m\">1</span>:<span class=\"w\">    </span>0xe28<span class=\"w\"> </span>-<span class=\"w\"> </span>greeter.wasm!inspect<span class=\"o\">(</span>void*,<span class=\"w\"> </span>bool<span class=\"o\">)</span>\n<span class=\"w\">           </span><span class=\"m\">2</span>:<span class=\"w\">    </span>0xf49<span class=\"w\"> </span>-<span class=\"w\"> </span>greeter.wasm!__wrap_realloc\n<span class=\"w\">           </span><span class=\"m\">3</span>:<span class=\"w\">   </span>0x1d40<span class=\"w\"> </span>-<span class=\"w\"> </span>greeter.wasm!cabi_realloc\n<span class=\"w\">       </span>note:<span class=\"w\"> </span>using<span class=\"w\"> </span>the<span class=\"w\"> </span><span class=\"sb\">`</span><span class=\"nv\">WASMTIME_BACKTRACE_DETAILS</span><span class=\"o\">=</span><span class=\"m\">1</span><span class=\"sb\">`</span><span class=\"w\"> </span>environment<span class=\"w\"> </span>variable<span class=\"w\"> </span>may<span class=\"w\"> </span>show<span class=\"w\"> </span>more<span class=\"w\"> </span>debugging<span class=\"w\"> </span>information\n<span class=\"w\">    </span><span class=\"m\">1</span>:<span class=\"w\"> </span>wasm<span class=\"w\"> </span>trap:<span class=\"w\"> </span>cannot<span class=\"w\"> </span>leave<span class=\"w\"> </span>component<span class=\"w\"> </span>instance\nmake:<span class=\"w\"> </span>***<span class=\"w\"> </span><span class=\"o\">[</span>Makefile:13:<span class=\"w\"> </span>run<span class=\"o\">]</span><span class=\"w\"> </span>Error<span class=\"w\"> </span><span class=\"m\">1</span>\n</code></pre></div>\n<p>Really appreciate if someone could help me out~</p>\n<h2>References</h2>\n<ul>\n<li><a href=\"https://stackoverflow.com/a/46446749/10878967\">How to wrap functions with the <code>--wrap</code> option correctly?</a></li>\n<li><a href=\"https://sourceware.org/binutils/docs/ld/Options.html#index-g_t_002d_002dwrap\">https://sourceware.org/binutils/docs/ld/Options.html#index-g_t_002d_002dwrap</a></li>\n<li><a href=\"https://component-model.bytecodealliance.org/language-support/c.html\">https://component-model.bytecodealliance.org/language-support/c.html</a></li>\n</ul>\n</blockquote>",
        "id": 561556617,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764732450
    },
    {
        "content": "<p>cfallin closed <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12112\">issue #12112</a>:</p>\n<blockquote>\n<p>It's broken to run wasm component model using wrapped <code>realloc</code> with host call.</p>\n<p>The full reproduction repository goes as <a href=\"https://github.com/sammyne/broken-memory-inspector-with-host-call\">https://github.com/sammyne/broken-memory-inspector-with-host-call</a></p>\n<h2>Environment</h2>\n<ul>\n<li>wasmtime v39.0.1</li>\n<li>wasi-sdk v29.0</li>\n<li>wasm-tools v1.243.0</li>\n<li>wit-bindgen v0.48.1</li>\n</ul>\n<h2>Project layout</h2>\n<table>\n<thead>\n<tr>\n<th>folder</th>\n<th>description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>guest</td>\n<td>C++-written wasm component</td>\n</tr>\n<tr>\n<td>host-rs</td>\n<td>Rust-written embedded wasmtime host, exposing a <code>inspect</code> api to called by guest's <code>__wrap_realloc</code></td>\n</tr>\n</tbody>\n</table>\n<h2>Core logic</h2>\n<p><strong>Guest</strong>: <code>__wrap_realloc</code> will call the real <code>realloc</code> and then call <code>inspect</code> to recorded the allocated ptr</p>\n<div class=\"codehilite\" data-code-language=\"C++\"><pre><span></span><code><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"nf\">inspect</span><span class=\"p\">(</span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">p</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">bool</span><span class=\"w\"> </span><span class=\"n\">alloc_or_free</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"n\">sammyne_hellohost_api_inspect</span><span class=\"p\">(</span><span class=\"kt\">uint64_t</span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"p\">),</span><span class=\"w\"> </span><span class=\"n\">alloc_or_free</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n\n<span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"nf\">__wrap_realloc</span><span class=\"p\">(</span><span class=\"kt\">void</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">ptr</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"c1\">// 不能直接调用 realloc，否则递归导致栈溢出。</span>\n<span class=\"w\">  </span><span class=\"k\">auto</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">__real_realloc</span><span class=\"p\">(</span><span class=\"n\">ptr</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"p\">);</span>\n\n<span class=\"w\">  </span><span class=\"c1\">// TODO: 排查清楚加这行代码会导致失败的原因</span>\n<span class=\"w\">  </span><span class=\"c1\">// printf(\"realloc(%zu)=%p\\n\", size, p);</span>\n<span class=\"w\">  </span><span class=\"n\">inspect</span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"nb\">true</span><span class=\"p\">);</span>\n\n<span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">p</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p><strong>Host</strong>: <code>MyHost</code> will be injected into wasmtime's <code>Store</code></p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">Host</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">MyHost</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">inspect</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">addr</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">u64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">alloc_or_free</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">bool</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"fm\">println!</span><span class=\"p\">(</span><span class=\"s\">\"addr={addr},alloc-or-free={alloc_or_free}\"</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<h2>Reproduction</h2>\n<p>Using the host to load the guest wasm to tiggering call of <code>realloc</code> as</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>make<span class=\"w\"> </span>run\n</code></pre></div>\n<p>Error output as</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>Error:<span class=\"w\"> </span>call\n\nCaused<span class=\"w\"> </span>by:\n<span class=\"w\">    </span><span class=\"m\">0</span>:<span class=\"w\"> </span>error<span class=\"w\"> </span><span class=\"k\">while</span><span class=\"w\"> </span>executing<span class=\"w\"> </span>at<span class=\"w\"> </span>wasm<span class=\"w\"> </span>backtrace:\n<span class=\"w\">           </span><span class=\"m\">0</span>:<span class=\"w\">   </span>0x1e58<span class=\"w\"> </span>-<span class=\"w\"> </span>greeter.wasm!sammyne_hellohost_api_inspect\n<span class=\"w\">           </span><span class=\"m\">1</span>:<span class=\"w\">    </span>0xe28<span class=\"w\"> </span>-<span class=\"w\"> </span>greeter.wasm!inspect<span class=\"o\">(</span>void*,<span class=\"w\"> </span>bool<span class=\"o\">)</span>\n<span class=\"w\">           </span><span class=\"m\">2</span>:<span class=\"w\">    </span>0xf49<span class=\"w\"> </span>-<span class=\"w\"> </span>greeter.wasm!__wrap_realloc\n<span class=\"w\">           </span><span class=\"m\">3</span>:<span class=\"w\">   </span>0x1d40<span class=\"w\"> </span>-<span class=\"w\"> </span>greeter.wasm!cabi_realloc\n<span class=\"w\">       </span>note:<span class=\"w\"> </span>using<span class=\"w\"> </span>the<span class=\"w\"> </span><span class=\"sb\">`</span><span class=\"nv\">WASMTIME_BACKTRACE_DETAILS</span><span class=\"o\">=</span><span class=\"m\">1</span><span class=\"sb\">`</span><span class=\"w\"> </span>environment<span class=\"w\"> </span>variable<span class=\"w\"> </span>may<span class=\"w\"> </span>show<span class=\"w\"> </span>more<span class=\"w\"> </span>debugging<span class=\"w\"> </span>information\n<span class=\"w\">    </span><span class=\"m\">1</span>:<span class=\"w\"> </span>wasm<span class=\"w\"> </span>trap:<span class=\"w\"> </span>cannot<span class=\"w\"> </span>leave<span class=\"w\"> </span>component<span class=\"w\"> </span>instance\nmake:<span class=\"w\"> </span>***<span class=\"w\"> </span><span class=\"o\">[</span>Makefile:13:<span class=\"w\"> </span>run<span class=\"o\">]</span><span class=\"w\"> </span>Error<span class=\"w\"> </span><span class=\"m\">1</span>\n</code></pre></div>\n<p>Really appreciate if someone could help me out~</p>\n<h2>References</h2>\n<ul>\n<li><a href=\"https://stackoverflow.com/a/46446749/10878967\">How to wrap functions with the <code>--wrap</code> option correctly?</a></li>\n<li><a href=\"https://sourceware.org/binutils/docs/ld/Options.html#index-g_t_002d_002dwrap\">https://sourceware.org/binutils/docs/ld/Options.html#index-g_t_002d_002dwrap</a></li>\n<li><a href=\"https://component-model.bytecodealliance.org/language-support/c.html\">https://component-model.bytecodealliance.org/language-support/c.html</a></li>\n</ul>\n</blockquote>",
        "id": 561573236,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764744801
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12112#issuecomment-3605359310\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12112\">issue #12112</a>:</p>\n<blockquote>\n<p>Unfortunately, the <a href=\"https://github.com/WebAssembly/component-model/blob/main/design/mvp/CanonicalABI.md\">spec</a> says that realloc cannot call out of the component; so this behavior in Wasmtime is correct. Look for <code>may_leave</code> in that document for details.</p>\n<p>If you need to debug memory allocations, one workaround might be to record some log internally (e.g. in some fixed buffer) and then dump the information via another call into the component.</p>\n<p>I'll close this since there is no Wasmtime bug, but best of luck and feel free to ask on our <a href=\"https://bytecodealliance.zulipchat.com/\">Zulip</a> if you need more tips on debugging your system.</p>\n</blockquote>",
        "id": 561573239,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764744802
    },
    {
        "content": "<p>tschneidereit <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12112#issuecomment-3606671835\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12112\">issue #12112</a>:</p>\n<blockquote>\n<p>One thing to look forward here is a <a href=\"https://github.com/WebAssembly/component-model/issues/383\">planned spec change</a> that will make the <code>realloc</code> calls go away. At a very high level, the idea is that instead of the host calling <code>realloc</code> for a lowered value, it'll provide the required information to the guest on values that can be lowered, and the guest can then decide where to place them (and whether to do the lowering at all).</p>\n</blockquote>",
        "id": 561640404,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1764765601
    }
]
[
    {
        "content": "<p><strong>fitzgen</strong> requested <a href=\"https://github.com/alexcrichton\">alexcrichton</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12231\">PR #12231</a>.</p>",
        "id": 565724905,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767045888
    },
    {
        "content": "<p>fitzgen opened <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12231\">PR #12231</a> from <code>fitzgen:migrate-wasmtime-to-wasmtime-error</code> to <code>bytecodealliance:main</code>:</p>\n<blockquote>\n<p>Instead of <code>anyhow::Error</code>.</p>\n<p>This commit re-exports the <code>wasmtime_internal_error</code> crate as the <code>wasmtime::error</code> module, updates the prelude to include these new error-handling types, redirects our top-level <code>wasmtime::{Error, Result}</code> re-exports to re-export <code>wasmtime::error::{Error, Result}</code>, and updates various use sites that were directly using <code>anyhow</code> to use the new <code>wasmtime</code> versions.</p>\n<p>This process also required updating the component macro and wit-bindgen macro to use the new error types instead of <code>anyhow</code>.</p>\n<p>Part of <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12069\">https://github.com/bytecodealliance/wasmtime/issues/12069</a></p>\n<p>&lt;!--<br>\nPlease make sure you include the following information:</p>\n<ul>\n<li>\n<p>If this work has been discussed elsewhere, please include a link to that<br>\n  conversation. If it was discussed in an issue, just mention \"issue #...\".</p>\n</li>\n<li>\n<p>Explain why this change is needed. If the details are in an issue already,<br>\n  this can be brief.</p>\n</li>\n</ul>\n<p>Our development process is documented in the Wasmtime book:<br>\n<a href=\"https://docs.wasmtime.dev/contributing-development-process.html\">https://docs.wasmtime.dev/contributing-development-process.html</a></p>\n<p>Please ensure all communication follows the code of conduct:<br>\n<a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md\">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>\n--&gt;</p>\n</blockquote>",
        "id": 565724907,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767045888
    },
    {
        "content": "<p><strong>fitzgen</strong> requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers\">wasmtime-core-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12231\">PR #12231</a>.</p>",
        "id": 565724908,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767045889
    },
    {
        "content": "<p><strong>fitzgen</strong> requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-default-reviewers\">wasmtime-default-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12231\">PR #12231</a>.</p>",
        "id": 565724909,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767045889
    },
    {
        "content": "<p>fitzgen updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12231\">PR #12231</a>.</p>",
        "id": 565725057,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767045978
    },
    {
        "content": "<p>fitzgen updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12231\">PR #12231</a>.</p>",
        "id": 565725174,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767046092
    },
    {
        "content": "<p>fitzgen edited <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12231\">PR #12231</a>.</p>",
        "id": 565725190,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767046112
    },
    {
        "content": "<p>fitzgen edited <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12231\">PR #12231</a>:</p>\n<blockquote>\n<p>Instead of <code>anyhow::Error</code>.</p>\n<p>This commit re-exports <code>wasmtime_environ::error</code> as the <code>wasmtime::error</code> module, updates the prelude to include these new error-handling types, redirects our top-level <code>wasmtime::{Error, Result}</code> re-exports to re-export <code>wasmtime::error::{Error, Result}</code>, and updates various use sites that were directly using <code>anyhow</code> to use the new <code>wasmtime</code> versions.</p>\n<p>This process also required updating the component macro and wit-bindgen macro to use the new error types instead of <code>anyhow</code>.</p>\n<p>Part of <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12069\">https://github.com/bytecodealliance/wasmtime/issues/12069</a></p>\n<p>&lt;!--<br>\nPlease make sure you include the following information:</p>\n<ul>\n<li>\n<p>If this work has been discussed elsewhere, please include a link to that<br>\n  conversation. If it was discussed in an issue, just mention \"issue #...\".</p>\n</li>\n<li>\n<p>Explain why this change is needed. If the details are in an issue already,<br>\n  this can be brief.</p>\n</li>\n</ul>\n<p>Our development process is documented in the Wasmtime book:<br>\n<a href=\"https://docs.wasmtime.dev/contributing-development-process.html\">https://docs.wasmtime.dev/contributing-development-process.html</a></p>\n<p>Please ensure all communication follows the code of conduct:<br>\n<a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md\">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>\n--&gt;</p>\n</blockquote>",
        "id": 565725216,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767046141
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12231#issuecomment-3710951007\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12231\">PR #12231</a>:</p>\n<blockquote>\n<p>In retrospect, should we bother with <code>wasmtime::error</code> as a module? (vs just having reexports at the top). I would expect almost all uses to go through <code>wasmtime::Result</code> instead of <code>wasmtime::error::Result</code> (and is something I'd ideally like to see changed in the bindgen output for example).</p>\n</blockquote>",
        "id": 566383167,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767627694
    },
    {
        "content": "<p>fitzgen <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12231#issuecomment-3711665352\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12231\">PR #12231</a>:</p>\n<blockquote>\n<blockquote>\n<p>In retrospect, should we bother with <code>wasmtime::error</code> as a module?</p>\n</blockquote>\n<p>I think we do want a module because otherwise we would have <code>wasmtime::Context</code> (instead of <code>wasmtime::error::Context</code>) which is pretty ambiguous with <code>StoreContext</code> and all that (and we also don't want to rename <code>Context</code> because we want to continue to have porting to the new error infra be just flipping the switch from <code>anyhow</code> to <code>wasmtime-internal-error</code>, which requires API compatibility).</p>\n</blockquote>",
        "id": 566418088,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767638722
    },
    {
        "content": "<p>fitzgen <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12231#issuecomment-3711668587\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12231\">PR #12231</a>:</p>\n<blockquote>\n<blockquote>\n<p>(and is something I'd ideally like to see changed in the bindgen output for example).</p>\n</blockquote>\n<p>Happy to change it, but also this seems like it shouldn't really matter since it is just in macro-expanded code?</p>\n</blockquote>",
        "id": 566418232,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767638789
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12231#issuecomment-3712215013\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12231\">PR #12231</a>:</p>\n<blockquote>\n<p>Scattered thought from some more review:</p>\n<ul>\n<li>Migration is happening in incremental steps, so renaming <code>Context</code> to <code>ErrorContext</code> isn't out of the question is it? For example nothing is using <code>wasmtime::Context</code> today or expecting that to work, so having users change <code>anyhow::Context</code> to <code>wasmtime::ErrorContext</code> doesn't seem like a deal-breaker.</li>\n<li>It's true yeah that macro-expanded code doesn't matter much, but having two paths to the same type means that it's inevitably going to be used both ways in different places. There are other files modified here which use <code>crate::error::...</code> instead of <code>crate::...</code> for example.</li>\n<li>Personally I think that error-handling ergonomics are of a pretty high importance so I want to make sure we're not losing anything in this transition. It's quite easy to throw <code>anyhow::Foo</code> somewhere for example but <code>wasmtime:::error::Foo</code> is much more of a mouthful already. That's where I'd like to keep everything at the crate root of <code>wasmtime::Foo</code> if we can. That's already still slightly worse than anyhow due to the crate name being longer, but there's not much we can do about that. On example is <code>anyhow::Ok(...)</code> being migrated here to <code>wasmtime::error::Ok(...)</code> in a few places which feels overkill to me in terms of \"here's a quick type annotation\" which has turned into a much longer type annotation</li>\n</ul>\n</blockquote>",
        "id": 566444432,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767650010
    },
    {
        "content": "<p>fitzgen <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12231#issuecomment-3712268398\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12231\">PR #12231</a>:</p>\n<blockquote>\n<blockquote>\n<p>Migration is happening in incremental steps, so renaming <code>Context</code> to <code>ErrorContext</code> isn't out of the question is it? For example nothing is using <code>wasmtime::Context</code> today or expecting that to work, so having users change <code>anyhow::Context</code> to <code>wasmtime::ErrorContext</code> doesn't seem like a deal-breaker.</p>\n</blockquote>\n<p>I would say it is 100% a deal-breaker for existing projects that already embed Wasmtime, currently use <code>anyhow</code>, and will start using <code>wasmtime::Error</code> instead. As long as they are only using <code>anyhow</code> via the <code>wasmtime::{Error, Result}</code> aliases today, then the upgrade to Wasmtime that switches away from <code>anyhow</code> shouldn't involve changing any code at all. But if they are using <code>anyhow</code> directly, for example to get the <code>Context</code> trait in scope, then they should be able to mechanically replace all <code>anyhow::Foo</code> with <code>wasmtime::error::Foo</code>. The more things we change, the more pain we are causing downstream.</p>\n<blockquote>\n<p>Personally I think that error-handling ergonomics are of a pretty high importance so I want to make sure we're not losing anything in this transition.</p>\n</blockquote>\n<p>I agree, which is why I am focusing on not only the Wasmtime developers' ergonomics but also embedders' ergonomics. The best ergonomics is \"you don't need to change anything in your existing code and you're already familiar with all the APIs\" which is what we get with matching <code>anyhow</code>'s API and have been aiming for this whole time.</p>\n<blockquote>\n<p>On example is <code>anyhow::Ok(...)</code> being migrated here to <code>wasmtime::error::Ok(...)</code> in a few places which feels overkill to me in terms of \"here's a quick type annotation\" which has turned into a much longer type annotation</p>\n</blockquote>\n<p>This is actually another example of why we <em>cannot</em> just export everything at the top level. A ton of our code in examples, tests, and docs do <code>use wasmtime::*</code> -- and I'm sure that many embedders do that too -- but if we put <code>wasmtime::error::Ok</code> at <code>wasmtime::Ok</code>, then that glob import would mean that <code>wasmtime::Ok</code> replaces the prelude's <code>use core::result::Result::Ok</code>, which makes things like <code>match</code>ing on results break.</p>\n<blockquote>\n<p>having two paths to the same type means that it's inevitably going to be used both ways in different places. There are other files modified here which use <code>crate::error::...</code> instead of <code>crate::...</code> for example.</p>\n</blockquote>\n<p>Having a top-level alias of an item defined in a nested module seems like a very minor blemish to me. Like I guess in a platonic ideal world it would be nice if it didn't exist, and there was only one path for the item, but it also doesn't seem like it actually hurts at all? Simultaneously, it seems pretty common for crates to re-export the most-common functionality from a nested module to the top level: even <code>std</code> does this with e.g. <code>std::collections::HashMap</code> and <code>std::collections::hash_map::HashMap</code>.</p>\n</blockquote>",
        "id": 566446843,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767651229
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12231#issuecomment-3712422598\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12231\">PR #12231</a>:</p>\n<blockquote>\n<p>Personally I'm not too sold on the downstream churn argument. For example I'd disagree that <code>anyhow::Foo</code> wants to become <code>wasmtime::error::Foo</code> -- it will work, yes, but ergnomically it's probably not what you want. For the same reason as this PR, I'd rather read <code>wasmtime::Foo</code> than <code>wasmtime::error::Foo</code> (if possible).</p>\n<p>I would also say that we're teeing up a lot of churn for downstream users because for embeddings it's likely that <code>anyhow</code> is used pervasively throughout rather than just for Wasmtime which means that conversion from <code>wasmtime::Error</code> to <code>anyhow::Error</code> will be required (the entire embedding probably won't want to change to <code>wasmtime::Result</code>). This'll require updating bindgen-generated traits, for example, to use the right error and any other wasm-y path which flows into Wasmtime. Worse yet all implementations of host functions which generate <code>anyhow::Error</code> won't work by-default and will require manual conversions to <code>wasmtime::Error</code> <a href=\"https://github.com/bytecodealliance/wasmtime/blob/2cd7e179322a6d779f6721523a1f91a70e13318a/crates/error/src/error.rs#L524\">due to coherence</a>. Basically I don't think \"minimize churn\" is a viable goal/end-state here, it's inevitably going to be a big, painful, change.</p>\n<p>With this I'd say that the specific context of naming <code>ErrorContext</code> vs <code>Context</code> is more-or-less irrelevant. If anything it might make it nicer in case you need to have both <code>anyhow</code>'s version and <code>wasmtime</code>'s version in scope at the same time. (avoid <code>as _</code> in the import)</p>\n<p>I guess what I'm getting at is:</p>\n<blockquote>\n<p>The best ergonomics is \"you don't need to change anything in your existing code and you're already familiar with all the APIs\"</p>\n</blockquote>\n<p>Given two distinct nominal error types (<code>anyhow::Error</code> and <code>wasmtime::Error</code>) where you can't auto-convert one to the other (the <code>anyhow::Error =&gt; wasmtime::Error</code> direction) I don't think that this is achievable. Day-to-day usage can have similar ergonomics, but I really don't think that landing this change will be a simple search-and-replace-and-you're-done.</p>\n<hr>\n<p>r.e. <code>wasmtime::Ok</code> -- well damn I'd agree that's probably not possible. Alas.</p>\n<hr>\n<blockquote>\n<p>Having a top-level alias of an item defined in a nested module seems like a very minor blemish to me.</p>\n</blockquote>\n<p>Agree yeah and I'm not saying it's absolutely imperative we don't have duplication. What I'm saying is that there should be a more-or-less canonical path that everything is used from. For example most crates use <code>std::collections::HashMap</code> and only if other stuff is also imported from the <code>hash_map</code> module might you import it from there. This PR as-is is a mish-mash of <code>wasmtime::error::Thing</code> vs <code>wasmtime::Thing</code>. It's inevitable this will exist to a certain degree, but what I'm asking for is a pass over this to canonicalize on <code>wasmtime::Thing</code> where possible.</p>\n<hr>\n<p>Overall:</p>\n<ul>\n<li>Due to <code>wasmtime::*</code>, I'd agree <code>wasmtime::error</code> is a required module.</li>\n<li>I'd like to see a pass to rename <code>crate::error::Thing</code> at use-sites to <code>crate::Thing</code> in this PR.</li>\n<li>Given the requirement of <code>wasmtime::error</code> seems fine to leave <code>wasmtime::error::Context</code> as-is.</li>\n<li>I think it's worth setting expectations that we're doing what we can to smooth this transition but it will, in my opinion, almost surely be a pretty painful transition.</li>\n</ul>\n</blockquote>",
        "id": 566453766,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767654753
    },
    {
        "content": "<p>fitzgen updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12231\">PR #12231</a>.</p>",
        "id": 566636510,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767742007
    },
    {
        "content": "<p>fitzgen <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12231#issuecomment-3716727591\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12231\">PR #12231</a>:</p>\n<blockquote>\n<blockquote>\n<p>Overall:</p>\n<ul>\n<li>\n<p>Due to <code>wasmtime::*</code>, I'd agree <code>wasmtime::error</code> is a required module.</p>\n</li>\n<li>\n<p>I'd like to see a pass to rename <code>crate::error::Thing</code> at use-sites to <code>crate::Thing</code> in this PR.</p>\n</li>\n<li>\n<p>Given the requirement of <code>wasmtime::error</code> seems fine to leave <code>wasmtime::error::Context</code> as-is.</p>\n</li>\n<li>\n<p>I think it's worth setting expectations that we're doing what we can to smooth this transition but it will, in my opinion, almost surely be a pretty painful transition.</p>\n</li>\n</ul>\n</blockquote>\n<p>I think we are mostly on the same page.</p>\n<p>Regarding the last bullet point, I just don't want to give up on migration ergonomics by-default and only want us to do it deliberately when we have motivation that overrides those ergonomics. There's flex but we should be cognizant when we are making that trade off, not just accepting it as a lost cause from the start.</p>\n<p>Latest commit has replaced all <code>wasmtime::error::Thing</code> uses with <code>wasmtime::Thing</code> other than the following two cases:</p>\n<ul>\n<li><code>wasmtime::error::Ok</code>, which doesn't have a top-level re-export as discussed earlier</li>\n<li>in macro-generated code, we are doing UFCS to the <code>wasmtime::error::Context::context</code> function, and (as also discussed earlier) we don't have a top-level re-export of that function to use, but I also didn't want to switch away from UFCS</li>\n</ul>\n</blockquote>",
        "id": 566636944,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767742298
    },
    {
        "content": "<p>fitzgen updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12231\">PR #12231</a>.</p>",
        "id": 566637017,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767742343
    },
    {
        "content": "<p>alexcrichton submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12231#pullrequestreview-3632986112\">PR review</a>.</p>",
        "id": 566643799,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767747223
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12231#discussion_r2666715839\">PR review comment</a>:</p>\n<blockquote>\n<p>s/::error// for non-<code>Context</code> things here</p>\n</blockquote>",
        "id": 566643800,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767747224
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12231#discussion_r2666715501\">PR review comment</a>:</p>\n<blockquote>\n<p>s/::error// for non-<code>Context</code> things here</p>\n</blockquote>",
        "id": 566643801,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767747224
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12231#discussion_r2666721177\">PR review comment</a>:</p>\n<blockquote>\n<p>s/::error// </p>\n</blockquote>",
        "id": 566643802,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767747224
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12231#discussion_r2666717810\">PR review comment</a>:</p>\n<blockquote>\n<p>s/::error// </p>\n</blockquote>",
        "id": 566643803,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767747224
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12231#discussion_r2666715302\">PR review comment</a>:</p>\n<blockquote>\n<p>s/::error// for non-<code>Context</code> things here</p>\n</blockquote>",
        "id": 566643804,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767747224
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12231#discussion_r2666723408\">PR review comment</a>:</p>\n<blockquote>\n<p>s/::error//  (or maybe remove entirely due to the prelude import here)</p>\n</blockquote>",
        "id": 566643805,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767747224
    },
    {
        "content": "<p>fitzgen updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12231\">PR #12231</a>.</p>",
        "id": 566778910,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767804912
    },
    {
        "content": "<p>fitzgen has enabled auto merge for <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12231\">PR #12231</a>.</p>",
        "id": 566778977,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767804928
    },
    {
        "content": "<p>fitzgen merged <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12231\">PR #12231</a>.</p>",
        "id": 566786374,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1767807073
    }
]
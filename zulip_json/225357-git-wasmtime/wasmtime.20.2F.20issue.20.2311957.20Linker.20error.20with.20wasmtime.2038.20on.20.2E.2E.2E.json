[
    {
        "content": "<p>mkaput opened <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11957\">issue #11957</a>:</p>\n<blockquote>\n<p>Wasmtime 38.0.3 produces a linker error on ARM64 macOS when building with ThinLTO enabled. The error indicates that <code>wasmtime_fiber_switch</code> symbol is undefined during linking.</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">Undefined</span><span class=\"w\"> </span><span class=\"n\">symbols</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">architecture</span><span class=\"w\"> </span><span class=\"n\">arm64</span><span class=\"p\">:</span>\n<span class=\"w\">  </span><span class=\"s\">\"wasmtime_internal_fiber::stackswitch::aarch64::wasmtime_fiber_switch::hbfe01c429347756b\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">referenced</span><span class=\"w\"> </span><span class=\"n\">from</span><span class=\"p\">:</span>\n<span class=\"w\">      </span><span class=\"nc\">wasmtime_internal_fiber</span><span class=\"p\">::</span><span class=\"n\">unix</span><span class=\"p\">::</span><span class=\"n\">Suspend</span><span class=\"p\">::</span><span class=\"n\">switch</span><span class=\"p\">::</span><span class=\"n\">h3c732376237b9f89</span><span class=\"w\"> </span><span class=\"p\">(.</span><span class=\"n\">llvm</span><span class=\"p\">.</span><span class=\"mi\">8380686341591023165</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"p\">.</span>\n<span class=\"w\">      </span><span class=\"n\">wasmtime_internal_fiber</span><span class=\"p\">::</span><span class=\"n\">Fiber</span><span class=\"cp\">$LT$Resume$C$Yield$C$Return$GT$</span><span class=\"p\">::</span><span class=\"n\">resume</span><span class=\"p\">::</span><span class=\"n\">h3cbe31d926bc312b</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"p\">.</span>\n<span class=\"w\">      </span><span class=\"n\">wasmtime_internal_fiber</span><span class=\"p\">::</span><span class=\"n\">unix</span><span class=\"p\">::</span><span class=\"n\">Suspend</span><span class=\"p\">::</span><span class=\"n\">switch</span><span class=\"p\">::</span><span class=\"n\">h085493437a61cdbb</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"p\">.</span>\n<span class=\"n\">ld</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">symbol</span><span class=\"p\">(</span><span class=\"n\">s</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">found</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">architecture</span><span class=\"w\"> </span><span class=\"n\">arm64</span>\n<span class=\"n\">clang</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">error</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">linker</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"w\"> </span><span class=\"n\">with</span><span class=\"w\"> </span><span class=\"n\">exit</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">use</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">see</span><span class=\"w\"> </span><span class=\"n\">invocation</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>This breaks our releases, as seen here: <a href=\"https://github.com/software-mansion/scarb/actions/runs/18924473454/job/54028423511\">https://github.com/software-mansion/scarb/actions/runs/18924473454/job/54028423511</a>.</p>\n<p>Reverting to Wasmtime 37 workarounds this issue. The same happens when we disable LTO or use Fat LTO. This only happens with ThinLTO which is the only thing we can accept in our project due to other reasons.</p>\n<h3>Steps to Reproduce</h3>\n<ul>\n<li><strong>Architecture</strong>: ARM64 (Apple Silicon)</li>\n<li><strong>OS</strong>: macOS 15.0 (Darwin 25.0.0)</li>\n<li><strong>Rust</strong>: 1.90.0</li>\n<li><strong>Wasmtime</strong>: 38.0.3</li>\n<li><strong>Build Profile</strong>: <code>release</code> with <code>lto = \"thin\"</code></li>\n</ul>\n<p><strong>Cargo.toml:</strong></p>\n<div class=\"codehilite\" data-code-language=\"TOML\"><pre><span></span><code><span class=\"k\">[package]</span>\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"linker-repro\"</span>\n<span class=\"n\">version</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"0.1.0\"</span>\n<span class=\"n\">edition</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"2021\"</span>\n\n<span class=\"k\">[dependencies]</span>\n<span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"38\"</span>\n<span class=\"n\">wasmtime-wasi</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"38\"</span>\n<span class=\"n\">anyhow</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"1\"</span>\n\n<span class=\"k\">[profile.release]</span>\n<span class=\"n\">lto</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"thin\"</span>\n</code></pre></div>\n<p><strong>src/main.rs:</strong></p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"p\">::</span><span class=\"n\">component</span><span class=\"p\">::{</span><span class=\"n\">Component</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">Linker</span><span class=\"p\">};</span>\n<span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"p\">::{</span><span class=\"n\">Engine</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">Store</span><span class=\"p\">};</span>\n<span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::{</span><span class=\"n\">WasiCtx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">WasiCtxView</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">WasiView</span><span class=\"p\">};</span>\n\n<span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">HostState</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">ctx</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">WasiCtx</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">table</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">wasmtime</span><span class=\"p\">::</span><span class=\"n\">component</span><span class=\"p\">::</span><span class=\"n\">ResourceTable</span><span class=\"p\">,</span>\n<span class=\"p\">}</span>\n\n<span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">WasiView</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">HostState</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">ctx</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">WasiCtxView</span><span class=\"o\">&lt;'</span><span class=\"nb\">_</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"n\">WasiCtxView</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">            </span><span class=\"n\">ctx</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kp\">&amp;</span><span class=\"nc\">mut</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">ctx</span><span class=\"p\">,</span>\n<span class=\"w\">            </span><span class=\"n\">table</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kp\">&amp;</span><span class=\"nc\">mut</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">table</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"p\">}</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n\n<span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">anyhow</span><span class=\"p\">::</span><span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"p\">()</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">engine</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Engine</span><span class=\"p\">::</span><span class=\"n\">default</span><span class=\"p\">();</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Linker</span><span class=\"p\">::</span><span class=\"n\">new</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">engine</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">p2</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_sync</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">component</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Component</span><span class=\"p\">::</span><span class=\"n\">new</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">engine</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">\"(component)\"</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">host_state</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">HostState</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"n\">ctx</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">WasiCtx</span><span class=\"p\">::</span><span class=\"n\">builder</span><span class=\"p\">().</span><span class=\"n\">build</span><span class=\"p\">(),</span>\n<span class=\"w\">        </span><span class=\"n\">table</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">wasmtime</span><span class=\"p\">::</span><span class=\"n\">component</span><span class=\"p\">::</span><span class=\"n\">ResourceTable</span><span class=\"p\">::</span><span class=\"n\">new</span><span class=\"p\">(),</span>\n<span class=\"w\">    </span><span class=\"p\">};</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">store</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Store</span><span class=\"p\">::</span><span class=\"n\">new</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">engine</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">host_state</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">_instance</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"p\">.</span><span class=\"n\">instantiate</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">store</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">component</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n\n<span class=\"w\">    </span><span class=\"nb\">Ok</span><span class=\"p\">(())</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p><strong>Build command:</strong></p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>cargo<span class=\"w\"> </span>build<span class=\"w\"> </span>--release\n</code></pre></div>\n<p>This will fail with the linker error shown above.</p>\n<h3>Thoughts</h3>\n<ul>\n<li>I think this regressed in 3e9eca8b23ace6b2631c557e0e84bb8371c18ed2.</li>\n<li>I'm not well versed in these low-level naked functions-LLVM interactions, but prompting llms guided me that there are some issues when you try to combine naked fns with LTO. </li>\n<li>Getting into guessing mode: could it be that ThinLTO is attempting to inline <code>wasmtime_fiber_switch</code> in some places, but forgets in others? <br>\n    - Is it reasonable to attach <code>#[inline(never)]</code> to <code>wasmtime_fiber_switch</code>?<br>\n</li>\n</ul>\n</blockquote>",
        "id": 547954006,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1761835182
    },
    {
        "content": "<p><a href=\"https://github.com/mkaput\">mkaput</a> added the bug label to <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11957\">Issue #11957</a>.</p>",
        "id": 547954008,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1761835182
    },
    {
        "content": "<p>mkaput edited <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11957\">issue #11957</a>:</p>\n<blockquote>\n<p>Wasmtime 38.0.3 produces a linker error on ARM64 macOS when building with ThinLTO enabled. The error indicates that <code>wasmtime_fiber_switch</code> symbol is undefined during linking.</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">Undefined</span><span class=\"w\"> </span><span class=\"n\">symbols</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">architecture</span><span class=\"w\"> </span><span class=\"n\">arm64</span><span class=\"p\">:</span>\n<span class=\"w\">  </span><span class=\"s\">\"wasmtime_internal_fiber::stackswitch::aarch64::wasmtime_fiber_switch::hbfe01c429347756b\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">referenced</span><span class=\"w\"> </span><span class=\"n\">from</span><span class=\"p\">:</span>\n<span class=\"w\">      </span><span class=\"nc\">wasmtime_internal_fiber</span><span class=\"p\">::</span><span class=\"n\">unix</span><span class=\"p\">::</span><span class=\"n\">Suspend</span><span class=\"p\">::</span><span class=\"n\">switch</span><span class=\"p\">::</span><span class=\"n\">h3c732376237b9f89</span><span class=\"w\"> </span><span class=\"p\">(.</span><span class=\"n\">llvm</span><span class=\"p\">.</span><span class=\"mi\">8380686341591023165</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"p\">.</span>\n<span class=\"w\">      </span><span class=\"n\">wasmtime_internal_fiber</span><span class=\"p\">::</span><span class=\"n\">Fiber</span><span class=\"cp\">$LT$Resume$C$Yield$C$Return$GT$</span><span class=\"p\">::</span><span class=\"n\">resume</span><span class=\"p\">::</span><span class=\"n\">h3cbe31d926bc312b</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"p\">.</span>\n<span class=\"w\">      </span><span class=\"n\">wasmtime_internal_fiber</span><span class=\"p\">::</span><span class=\"n\">unix</span><span class=\"p\">::</span><span class=\"n\">Suspend</span><span class=\"p\">::</span><span class=\"n\">switch</span><span class=\"p\">::</span><span class=\"n\">h085493437a61cdbb</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"p\">.</span>\n<span class=\"n\">ld</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">symbol</span><span class=\"p\">(</span><span class=\"n\">s</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">found</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">architecture</span><span class=\"w\"> </span><span class=\"n\">arm64</span>\n<span class=\"n\">clang</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">error</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">linker</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"w\"> </span><span class=\"n\">with</span><span class=\"w\"> </span><span class=\"n\">exit</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">use</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">see</span><span class=\"w\"> </span><span class=\"n\">invocation</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>This breaks our releases, as seen here: <a href=\"https://github.com/software-mansion/scarb/actions/runs/18924473454/job/54028423511\">https://github.com/software-mansion/scarb/actions/runs/18924473454/job/54028423511</a>.</p>\n<p>Reverting to Wasmtime 37 workarounds this issue. The same happens when we disable LTO or use Fat LTO. This only happens with ThinLTO which is the only thing we can accept in our project due to other reasons.</p>\n<h3>Steps to Reproduce</h3>\n<ul>\n<li><strong>Architecture</strong>: ARM64 (Apple Silicon)</li>\n<li><strong>OS</strong>: macOS 26.0</li>\n<li><strong>Rust</strong>: 1.90.0</li>\n<li><strong>Wasmtime</strong>: 38.0.3</li>\n<li><strong>Build Profile</strong>: <code>release</code> with <code>lto = \"thin\"</code></li>\n</ul>\n<p><strong>Cargo.toml:</strong></p>\n<div class=\"codehilite\" data-code-language=\"TOML\"><pre><span></span><code><span class=\"k\">[package]</span>\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"linker-repro\"</span>\n<span class=\"n\">version</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"0.1.0\"</span>\n<span class=\"n\">edition</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"2021\"</span>\n\n<span class=\"k\">[dependencies]</span>\n<span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"38\"</span>\n<span class=\"n\">wasmtime-wasi</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"38\"</span>\n<span class=\"n\">anyhow</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"1\"</span>\n\n<span class=\"k\">[profile.release]</span>\n<span class=\"n\">lto</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"thin\"</span>\n</code></pre></div>\n<p><strong>src/main.rs:</strong></p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"p\">::</span><span class=\"n\">component</span><span class=\"p\">::{</span><span class=\"n\">Component</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">Linker</span><span class=\"p\">};</span>\n<span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"p\">::{</span><span class=\"n\">Engine</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">Store</span><span class=\"p\">};</span>\n<span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::{</span><span class=\"n\">WasiCtx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">WasiCtxView</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">WasiView</span><span class=\"p\">};</span>\n\n<span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">HostState</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">ctx</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">WasiCtx</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">table</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">wasmtime</span><span class=\"p\">::</span><span class=\"n\">component</span><span class=\"p\">::</span><span class=\"n\">ResourceTable</span><span class=\"p\">,</span>\n<span class=\"p\">}</span>\n\n<span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">WasiView</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">HostState</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">ctx</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">WasiCtxView</span><span class=\"o\">&lt;'</span><span class=\"nb\">_</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"n\">WasiCtxView</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">            </span><span class=\"n\">ctx</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kp\">&amp;</span><span class=\"nc\">mut</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">ctx</span><span class=\"p\">,</span>\n<span class=\"w\">            </span><span class=\"n\">table</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kp\">&amp;</span><span class=\"nc\">mut</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">table</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"p\">}</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n\n<span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">anyhow</span><span class=\"p\">::</span><span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"p\">()</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">engine</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Engine</span><span class=\"p\">::</span><span class=\"n\">default</span><span class=\"p\">();</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Linker</span><span class=\"p\">::</span><span class=\"n\">new</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">engine</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">wasmtime_wasi</span><span class=\"p\">::</span><span class=\"n\">p2</span><span class=\"p\">::</span><span class=\"n\">add_to_linker_sync</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">component</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Component</span><span class=\"p\">::</span><span class=\"n\">new</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">engine</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"s\">\"(component)\"</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">host_state</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">HostState</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"n\">ctx</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">WasiCtx</span><span class=\"p\">::</span><span class=\"n\">builder</span><span class=\"p\">().</span><span class=\"n\">build</span><span class=\"p\">(),</span>\n<span class=\"w\">        </span><span class=\"n\">table</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">wasmtime</span><span class=\"p\">::</span><span class=\"n\">component</span><span class=\"p\">::</span><span class=\"n\">ResourceTable</span><span class=\"p\">::</span><span class=\"n\">new</span><span class=\"p\">(),</span>\n<span class=\"w\">    </span><span class=\"p\">};</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">store</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Store</span><span class=\"p\">::</span><span class=\"n\">new</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">engine</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">host_state</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">_instance</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"p\">.</span><span class=\"n\">instantiate</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">store</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">component</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n\n<span class=\"w\">    </span><span class=\"nb\">Ok</span><span class=\"p\">(())</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p><strong>Build command:</strong></p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>cargo<span class=\"w\"> </span>build<span class=\"w\"> </span>--release\n</code></pre></div>\n<p>This will fail with the linker error shown above.</p>\n<h3>Thoughts</h3>\n<ul>\n<li>I think this regressed in 3e9eca8b23ace6b2631c557e0e84bb8371c18ed2.</li>\n<li>I'm not well versed in these low-level naked functions-LLVM interactions, but prompting llms guided me that there are some issues when you try to combine naked fns with LTO. </li>\n<li>Getting into guessing mode: could it be that ThinLTO is attempting to inline <code>wasmtime_fiber_switch</code> in some places, but forgets in others? <br>\n    - Is it reasonable to attach <code>#[inline(never)]</code> to <code>wasmtime_fiber_switch</code>?<br>\n</li>\n</ul>\n</blockquote>",
        "id": 547954165,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1761835219
    },
    {
        "content": "<p>bjorn3 <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11957#issuecomment-3468564835\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11957\">issue #11957</a>:</p>\n<blockquote>\n<p><code>wasmtime_fiber_switch</code> will never get inlined. Rustc implemented naked asm with <code>global_asm!()</code>. LLVM is not even aware there is a function called <code>wasmtime_fiber_switch</code> during optimizations. There is a fair chance this is a visibility bug in rustc. Can you open an issue at <a href=\"https://github.com/rust-lang/rust/issues/\">https://github.com/rust-lang/rust/issues/</a>?</p>\n</blockquote>",
        "id": 547965632,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1761837587
    },
    {
        "content": "<p>mkaput <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11957#issuecomment-3469293961\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11957\">issue #11957</a>:</p>\n<blockquote>\n<p>@bjorn3 makes sense, created the issue there: <a href=\"https://github.com/rust-lang/rust/issues/148307\">https://github.com/rust-lang/rust/issues/148307</a></p>\n<p>I have also tried to find a more minimal reproduction, but no luck in reasonable time. Updated this issue description. Would appreciate any hints. </p>\n</blockquote>",
        "id": 547999325,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1761846461
    },
    {
        "content": "<p>mkaput edited <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11957\">issue #11957</a>:</p>\n<blockquote>\n<p>Wasmtime 38.0.3 produces a linker error on ARM64 macOS when building with ThinLTO enabled. The error indicates that <code>wasmtime_fiber_switch</code> symbol is undefined during linking.</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">error</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">linking</span><span class=\"w\"> </span><span class=\"n\">with</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">cc</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">exit</span><span class=\"w\"> </span><span class=\"n\">status</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"o\">|</span>\n<span class=\"w\">  </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">note</span><span class=\"p\">:</span><span class=\"w\">  </span><span class=\"s\">\"cc\"</span><span class=\"w\"> </span><span class=\"s\">\"&lt;426 object files omitted&gt;\"</span><span class=\"w\"> </span><span class=\"s\">\"/var/folders/8c/r_zrp9mj12xd414t08zrks940000gn/T/rustc2wYYXA/{libwasmtime-e843f7bbc21927d3,libzstd_sys-7eabaf414ee67d02,libwasmtime_internal_jit_debug-9043bb9a4e496da8}.rlib\"</span><span class=\"w\"> </span><span class=\"s\">\"&lt;sysroot&gt;/lib/rustlib/aarch64-apple-darwin/lib/libcompiler_builtins-*.rlib\"</span><span class=\"w\"> </span><span class=\"s\">\"-liconv\"</span><span class=\"w\"> </span><span class=\"s\">\"-lSystem\"</span><span class=\"w\"> </span><span class=\"s\">\"-lc\"</span><span class=\"w\"> </span><span class=\"s\">\"-lm\"</span><span class=\"w\"> </span><span class=\"s\">\"-arch\"</span><span class=\"w\"> </span><span class=\"s\">\"arm64\"</span><span class=\"w\"> </span><span class=\"s\">\"-mmacosx-version-min=11.0.0\"</span><span class=\"w\"> </span><span class=\"s\">\"-L\"</span><span class=\"w\"> </span><span class=\"s\">\"/Users/mk/Developer/software-mansion/scarb/linker-repro/wasmtime-only-test/target/release/build/wasmtime-15671f59b24bbe0f/out\"</span><span class=\"w\"> </span><span class=\"s\">\"-L\"</span><span class=\"w\"> </span><span class=\"s\">\"/Users/mk/Developer/software-mansion/scarb/linker-repro/wasmtime-only-test/target/release/build/zstd-sys-1ea01473940232bc/out\"</span><span class=\"w\"> </span><span class=\"s\">\"-L\"</span><span class=\"w\"> </span><span class=\"s\">\"/Users/mk/Developer/software-mansion/scarb/linker-repro/wasmtime-only-test/target/release/build/wasmtime-internal-jit-debug-2aaf81cce8508d62/out\"</span><span class=\"w\"> </span><span class=\"s\">\"-o\"</span><span class=\"w\"> </span><span class=\"s\">\"/Users/mk/Developer/software-mansion/scarb/linker-repro/wasmtime-only-test/target/release/deps/wasmtime_only_test-69cba5150eff8962\"</span><span class=\"w\"> </span><span class=\"s\">\"-Wl,-dead_strip\"</span><span class=\"w\"> </span><span class=\"s\">\"-nodefaultlibs\"</span>\n<span class=\"w\">  </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">note</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">some</span><span class=\"w\"> </span><span class=\"n\">arguments</span><span class=\"w\"> </span><span class=\"n\">are</span><span class=\"w\"> </span><span class=\"n\">omitted</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"k\">use</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"o\">--</span><span class=\"n\">verbose</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">show</span><span class=\"w\"> </span><span class=\"n\">all</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"w\"> </span><span class=\"n\">arguments</span>\n<span class=\"w\">  </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">note</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">ld</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">warning</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">object</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">/</span><span class=\"n\">private</span><span class=\"o\">/</span><span class=\"n\">var</span><span class=\"o\">/</span><span class=\"n\">folders</span><span class=\"o\">/</span><span class=\"mi\">8</span><span class=\"n\">c</span><span class=\"o\">/</span><span class=\"n\">r_zrp9mj12xd414t08zrks940000gn</span><span class=\"o\">/</span><span class=\"n\">T</span><span class=\"o\">/</span><span class=\"n\">rustc2wYYXA</span><span class=\"o\">/</span><span class=\"n\">libwasmtime</span><span class=\"o\">-</span><span class=\"n\">e843f7bbc21927d3</span><span class=\"p\">.</span><span class=\"n\">rlib</span><span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"p\">](</span><span class=\"mi\">242</span><span class=\"n\">b1992def1ef0b</span><span class=\"o\">-</span><span class=\"n\">helpers</span><span class=\"p\">.</span><span class=\"n\">o</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"n\">was</span><span class=\"w\"> </span><span class=\"n\">built</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">newer</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">macOS</span><span class=\"o\">'</span><span class=\"w\"> </span><span class=\"n\">version</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mf\">26.0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">being</span><span class=\"w\"> </span><span class=\"n\">linked</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mf\">11.0</span><span class=\"p\">)</span>\n<span class=\"w\">          </span><span class=\"n\">ld</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">warning</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">object</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">/</span><span class=\"n\">private</span><span class=\"o\">/</span><span class=\"n\">var</span><span class=\"o\">/</span><span class=\"n\">folders</span><span class=\"o\">/</span><span class=\"mi\">8</span><span class=\"n\">c</span><span class=\"o\">/</span><span class=\"n\">r_zrp9mj12xd414t08zrks940000gn</span><span class=\"o\">/</span><span class=\"n\">T</span><span class=\"o\">/</span><span class=\"n\">rustc2wYYXA</span><span class=\"o\">/</span><span class=\"n\">libwasmtime_internal_jit_debug</span><span class=\"o\">-</span><span class=\"mi\">9043</span><span class=\"n\">bb9a4e496da8</span><span class=\"p\">.</span><span class=\"n\">rlib</span><span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"p\">](</span><span class=\"n\">db3b6bfb95261072</span><span class=\"o\">-</span><span class=\"n\">gdbjit</span><span class=\"p\">.</span><span class=\"n\">o</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"n\">was</span><span class=\"w\"> </span><span class=\"n\">built</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">newer</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">macOS</span><span class=\"o\">'</span><span class=\"w\"> </span><span class=\"n\">version</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mf\">26.0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">being</span><span class=\"w\"> </span><span class=\"n\">linked</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mf\">11.0</span><span class=\"p\">)</span>\n<span class=\"w\">          </span><span class=\"n\">Undefined</span><span class=\"w\"> </span><span class=\"n\">symbols</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">architecture</span><span class=\"w\"> </span><span class=\"n\">arm64</span><span class=\"p\">:</span>\n<span class=\"w\">            </span><span class=\"s\">\"wasmtime_internal_fiber::stackswitch::aarch64::wasmtime_fiber_switch::h0b241ee887e10750\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">referenced</span><span class=\"w\"> </span><span class=\"n\">from</span><span class=\"p\">:</span>\n<span class=\"w\">                </span><span class=\"nc\">wasmtime_internal_fiber</span><span class=\"p\">::</span><span class=\"n\">unix</span><span class=\"p\">::</span><span class=\"n\">Suspend</span><span class=\"p\">::</span><span class=\"n\">switch</span><span class=\"p\">::</span><span class=\"n\">hfd4514b4efef3e13</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">wasmtime_only_test</span><span class=\"o\">-</span><span class=\"mi\">69</span><span class=\"n\">cba5150eff8962</span><span class=\"p\">.</span><span class=\"n\">wasmtime</span><span class=\"o\">-</span><span class=\"n\">e843f7bbc21927d3</span><span class=\"p\">.</span><span class=\"n\">wasmtime</span><span class=\"p\">.</span><span class=\"mf\">7e3</span><span class=\"n\">b8021754df0c4</span><span class=\"o\">-</span><span class=\"n\">cgu</span><span class=\"p\">.</span><span class=\"mf\">05.</span><span class=\"n\">rcgu</span><span class=\"p\">.</span><span class=\"n\">o</span><span class=\"p\">.</span><span class=\"n\">rcgu</span><span class=\"p\">.</span><span class=\"n\">o</span>\n<span class=\"w\">          </span><span class=\"n\">ld</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">symbol</span><span class=\"p\">(</span><span class=\"n\">s</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">found</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">architecture</span><span class=\"w\"> </span><span class=\"n\">arm64</span>\n<span class=\"w\">          </span><span class=\"n\">clang</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">error</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">linker</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"w\"> </span><span class=\"n\">with</span><span class=\"w\"> </span><span class=\"n\">exit</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">use</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">see</span><span class=\"w\"> </span><span class=\"n\">invocation</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>This breaks our releases, as seen here: <a href=\"https://github.com/software-mansion/scarb/actions/runs/18924473454/job/54028423511\">https://github.com/software-mansion/scarb/actions/runs/18924473454/job/54028423511</a>.</p>\n<p>Reverting to Wasmtime 37 workarounds this issue. The same happens when we disable LTO or use Fat LTO. This only happens with ThinLTO which is the only thing we can accept in our project due to other reasons.</p>\n<h3>Steps to Reproduce</h3>\n<ul>\n<li><strong>Architecture</strong>: ARM64 (Apple Silicon)</li>\n<li><strong>OS</strong>: macOS 26.0</li>\n<li><strong>Rust</strong>: 1.90.0</li>\n<li><strong>Wasmtime</strong>: 38.0.3</li>\n<li><strong>Build Profile</strong>: <code>release</code> with <code>lto = \"thin\"</code></li>\n</ul>\n<p><strong>Cargo.toml:</strong></p>\n<div class=\"codehilite\" data-code-language=\"TOML\"><pre><span></span><code><span class=\"k\">[package]</span>\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"linker-repro\"</span>\n<span class=\"n\">version</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"0.1.0\"</span>\n<span class=\"n\">edition</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"2021\"</span>\n\n<span class=\"k\">[dependencies]</span>\n<span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"38\"</span>\n\n<span class=\"k\">[profile.release]</span>\n<span class=\"n\">lto</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"thin\"</span>\n</code></pre></div>\n<p><strong>src/main.rs:</strong></p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">engine</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"p\">::</span><span class=\"n\">Engine</span><span class=\"p\">::</span><span class=\"n\">default</span><span class=\"p\">();</span>\n<span class=\"w\">    </span><span class=\"fm\">println!</span><span class=\"p\">(</span><span class=\"s\">\"Engine created: {:?}\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">engine</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p><strong>Build command:</strong></p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>cargo<span class=\"w\"> </span>build<span class=\"w\"> </span>--release\n</code></pre></div>\n<p>This will fail with the linker error shown above.</p>\n<h3>Thoughts</h3>\n<ul>\n<li>I think this regressed in 3e9eca8b23ace6b2631c557e0e84bb8371c18ed2.</li>\n<li>I'm not well versed in these low-level naked functions-LLVM interactions, but prompting llms guided me that there are some issues when you try to combine naked fns with LTO. </li>\n<li>Getting into guessing mode: could it be that ThinLTO is attempting to inline <code>wasmtime_fiber_switch</code> in some places, but forgets in others? <br>\n    - Is it reasonable to attach <code>#[inline(never)]</code> to <code>wasmtime_fiber_switch</code>?<br>\n</li>\n</ul>\n</blockquote>",
        "id": 547999599,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1761846535
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11957#issuecomment-3475958968\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11957\">issue #11957</a>:</p>\n<blockquote>\n<p>Thanks for the report @mkaput! Mind testing out <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11960\">https://github.com/bytecodealliance/wasmtime/pull/11960</a> and seeing if that works for you? It works for me locally but I want to double-check.</p>\n</blockquote>",
        "id": 548287834,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1761986184
    },
    {
        "content": "<p>mkaput <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11957#issuecomment-3480567651\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11957\">issue #11957</a>:</p>\n<blockquote>\n<p>Yay! I can confirm #11960 works on both my reproduction and real project. Thank you</p>\n</blockquote>",
        "id": 553382318,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1762176970
    },
    {
        "content": "<p>alexcrichton closed <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11957\">issue #11957</a>:</p>\n<blockquote>\n<p>Wasmtime 38.0.3 produces a linker error on ARM64 macOS when building with ThinLTO enabled. The error indicates that <code>wasmtime_fiber_switch</code> symbol is undefined during linking.</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">error</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">linking</span><span class=\"w\"> </span><span class=\"n\">with</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">cc</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">exit</span><span class=\"w\"> </span><span class=\"n\">status</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"o\">|</span>\n<span class=\"w\">  </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">note</span><span class=\"p\">:</span><span class=\"w\">  </span><span class=\"s\">\"cc\"</span><span class=\"w\"> </span><span class=\"s\">\"&lt;426 object files omitted&gt;\"</span><span class=\"w\"> </span><span class=\"s\">\"/var/folders/8c/r_zrp9mj12xd414t08zrks940000gn/T/rustc2wYYXA/{libwasmtime-e843f7bbc21927d3,libzstd_sys-7eabaf414ee67d02,libwasmtime_internal_jit_debug-9043bb9a4e496da8}.rlib\"</span><span class=\"w\"> </span><span class=\"s\">\"&lt;sysroot&gt;/lib/rustlib/aarch64-apple-darwin/lib/libcompiler_builtins-*.rlib\"</span><span class=\"w\"> </span><span class=\"s\">\"-liconv\"</span><span class=\"w\"> </span><span class=\"s\">\"-lSystem\"</span><span class=\"w\"> </span><span class=\"s\">\"-lc\"</span><span class=\"w\"> </span><span class=\"s\">\"-lm\"</span><span class=\"w\"> </span><span class=\"s\">\"-arch\"</span><span class=\"w\"> </span><span class=\"s\">\"arm64\"</span><span class=\"w\"> </span><span class=\"s\">\"-mmacosx-version-min=11.0.0\"</span><span class=\"w\"> </span><span class=\"s\">\"-L\"</span><span class=\"w\"> </span><span class=\"s\">\"/Users/mk/Developer/software-mansion/scarb/linker-repro/wasmtime-only-test/target/release/build/wasmtime-15671f59b24bbe0f/out\"</span><span class=\"w\"> </span><span class=\"s\">\"-L\"</span><span class=\"w\"> </span><span class=\"s\">\"/Users/mk/Developer/software-mansion/scarb/linker-repro/wasmtime-only-test/target/release/build/zstd-sys-1ea01473940232bc/out\"</span><span class=\"w\"> </span><span class=\"s\">\"-L\"</span><span class=\"w\"> </span><span class=\"s\">\"/Users/mk/Developer/software-mansion/scarb/linker-repro/wasmtime-only-test/target/release/build/wasmtime-internal-jit-debug-2aaf81cce8508d62/out\"</span><span class=\"w\"> </span><span class=\"s\">\"-o\"</span><span class=\"w\"> </span><span class=\"s\">\"/Users/mk/Developer/software-mansion/scarb/linker-repro/wasmtime-only-test/target/release/deps/wasmtime_only_test-69cba5150eff8962\"</span><span class=\"w\"> </span><span class=\"s\">\"-Wl,-dead_strip\"</span><span class=\"w\"> </span><span class=\"s\">\"-nodefaultlibs\"</span>\n<span class=\"w\">  </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">note</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">some</span><span class=\"w\"> </span><span class=\"n\">arguments</span><span class=\"w\"> </span><span class=\"n\">are</span><span class=\"w\"> </span><span class=\"n\">omitted</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"k\">use</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"o\">--</span><span class=\"n\">verbose</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">show</span><span class=\"w\"> </span><span class=\"n\">all</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"w\"> </span><span class=\"n\">arguments</span>\n<span class=\"w\">  </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">note</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">ld</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">warning</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">object</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">/</span><span class=\"n\">private</span><span class=\"o\">/</span><span class=\"n\">var</span><span class=\"o\">/</span><span class=\"n\">folders</span><span class=\"o\">/</span><span class=\"mi\">8</span><span class=\"n\">c</span><span class=\"o\">/</span><span class=\"n\">r_zrp9mj12xd414t08zrks940000gn</span><span class=\"o\">/</span><span class=\"n\">T</span><span class=\"o\">/</span><span class=\"n\">rustc2wYYXA</span><span class=\"o\">/</span><span class=\"n\">libwasmtime</span><span class=\"o\">-</span><span class=\"n\">e843f7bbc21927d3</span><span class=\"p\">.</span><span class=\"n\">rlib</span><span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"p\">](</span><span class=\"mi\">242</span><span class=\"n\">b1992def1ef0b</span><span class=\"o\">-</span><span class=\"n\">helpers</span><span class=\"p\">.</span><span class=\"n\">o</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"n\">was</span><span class=\"w\"> </span><span class=\"n\">built</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">newer</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">macOS</span><span class=\"o\">'</span><span class=\"w\"> </span><span class=\"n\">version</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mf\">26.0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">being</span><span class=\"w\"> </span><span class=\"n\">linked</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mf\">11.0</span><span class=\"p\">)</span>\n<span class=\"w\">          </span><span class=\"n\">ld</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">warning</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">object</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">/</span><span class=\"n\">private</span><span class=\"o\">/</span><span class=\"n\">var</span><span class=\"o\">/</span><span class=\"n\">folders</span><span class=\"o\">/</span><span class=\"mi\">8</span><span class=\"n\">c</span><span class=\"o\">/</span><span class=\"n\">r_zrp9mj12xd414t08zrks940000gn</span><span class=\"o\">/</span><span class=\"n\">T</span><span class=\"o\">/</span><span class=\"n\">rustc2wYYXA</span><span class=\"o\">/</span><span class=\"n\">libwasmtime_internal_jit_debug</span><span class=\"o\">-</span><span class=\"mi\">9043</span><span class=\"n\">bb9a4e496da8</span><span class=\"p\">.</span><span class=\"n\">rlib</span><span class=\"p\">[</span><span class=\"mi\">2</span><span class=\"p\">](</span><span class=\"n\">db3b6bfb95261072</span><span class=\"o\">-</span><span class=\"n\">gdbjit</span><span class=\"p\">.</span><span class=\"n\">o</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"n\">was</span><span class=\"w\"> </span><span class=\"n\">built</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">newer</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">macOS</span><span class=\"o\">'</span><span class=\"w\"> </span><span class=\"n\">version</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mf\">26.0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">than</span><span class=\"w\"> </span><span class=\"n\">being</span><span class=\"w\"> </span><span class=\"n\">linked</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mf\">11.0</span><span class=\"p\">)</span>\n<span class=\"w\">          </span><span class=\"n\">Undefined</span><span class=\"w\"> </span><span class=\"n\">symbols</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">architecture</span><span class=\"w\"> </span><span class=\"n\">arm64</span><span class=\"p\">:</span>\n<span class=\"w\">            </span><span class=\"s\">\"wasmtime_internal_fiber::stackswitch::aarch64::wasmtime_fiber_switch::h0b241ee887e10750\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">referenced</span><span class=\"w\"> </span><span class=\"n\">from</span><span class=\"p\">:</span>\n<span class=\"w\">                </span><span class=\"nc\">wasmtime_internal_fiber</span><span class=\"p\">::</span><span class=\"n\">unix</span><span class=\"p\">::</span><span class=\"n\">Suspend</span><span class=\"p\">::</span><span class=\"n\">switch</span><span class=\"p\">::</span><span class=\"n\">hfd4514b4efef3e13</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">wasmtime_only_test</span><span class=\"o\">-</span><span class=\"mi\">69</span><span class=\"n\">cba5150eff8962</span><span class=\"p\">.</span><span class=\"n\">wasmtime</span><span class=\"o\">-</span><span class=\"n\">e843f7bbc21927d3</span><span class=\"p\">.</span><span class=\"n\">wasmtime</span><span class=\"p\">.</span><span class=\"mf\">7e3</span><span class=\"n\">b8021754df0c4</span><span class=\"o\">-</span><span class=\"n\">cgu</span><span class=\"p\">.</span><span class=\"mf\">05.</span><span class=\"n\">rcgu</span><span class=\"p\">.</span><span class=\"n\">o</span><span class=\"p\">.</span><span class=\"n\">rcgu</span><span class=\"p\">.</span><span class=\"n\">o</span>\n<span class=\"w\">          </span><span class=\"n\">ld</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">symbol</span><span class=\"p\">(</span><span class=\"n\">s</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">found</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">architecture</span><span class=\"w\"> </span><span class=\"n\">arm64</span>\n<span class=\"w\">          </span><span class=\"n\">clang</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">error</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">linker</span><span class=\"w\"> </span><span class=\"n\">command</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"w\"> </span><span class=\"n\">with</span><span class=\"w\"> </span><span class=\"n\">exit</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">use</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">v</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">see</span><span class=\"w\"> </span><span class=\"n\">invocation</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>This breaks our releases, as seen here: <a href=\"https://github.com/software-mansion/scarb/actions/runs/18924473454/job/54028423511\">https://github.com/software-mansion/scarb/actions/runs/18924473454/job/54028423511</a>.</p>\n<p>Reverting to Wasmtime 37 workarounds this issue. The same happens when we disable LTO or use Fat LTO. This only happens with ThinLTO which is the only thing we can accept in our project due to other reasons.</p>\n<h3>Steps to Reproduce</h3>\n<ul>\n<li><strong>Architecture</strong>: ARM64 (Apple Silicon)</li>\n<li><strong>OS</strong>: macOS 26.0</li>\n<li><strong>Rust</strong>: 1.90.0</li>\n<li><strong>Wasmtime</strong>: 38.0.3</li>\n<li><strong>Build Profile</strong>: <code>release</code> with <code>lto = \"thin\"</code></li>\n</ul>\n<p><strong>Cargo.toml:</strong></p>\n<div class=\"codehilite\" data-code-language=\"TOML\"><pre><span></span><code><span class=\"k\">[package]</span>\n<span class=\"n\">name</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"linker-repro\"</span>\n<span class=\"n\">version</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"0.1.0\"</span>\n<span class=\"n\">edition</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"2021\"</span>\n\n<span class=\"k\">[dependencies]</span>\n<span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"38\"</span>\n\n<span class=\"k\">[profile.release]</span>\n<span class=\"n\">lto</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"thin\"</span>\n</code></pre></div>\n<p><strong>src/main.rs:</strong></p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">engine</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"p\">::</span><span class=\"n\">Engine</span><span class=\"p\">::</span><span class=\"n\">default</span><span class=\"p\">();</span>\n<span class=\"w\">    </span><span class=\"fm\">println!</span><span class=\"p\">(</span><span class=\"s\">\"Engine created: {:?}\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">engine</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p><strong>Build command:</strong></p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>cargo<span class=\"w\"> </span>build<span class=\"w\"> </span>--release\n</code></pre></div>\n<p>This will fail with the linker error shown above.</p>\n<h3>Thoughts</h3>\n<ul>\n<li>I think this regressed in 3e9eca8b23ace6b2631c557e0e84bb8371c18ed2.</li>\n<li>I'm not well versed in these low-level naked functions-LLVM interactions, but prompting llms guided me that there are some issues when you try to combine naked fns with LTO. </li>\n<li>Getting into guessing mode: could it be that ThinLTO is attempting to inline <code>wasmtime_fiber_switch</code> in some places, but forgets in others? <br>\n    - Is it reasonable to attach <code>#[inline(never)]</code> to <code>wasmtime_fiber_switch</code>?<br>\n</li>\n</ul>\n</blockquote>",
        "id": 553421421,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1762186067
    }
]
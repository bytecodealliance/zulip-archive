[
    {
        "content": "<p>bongjunj opened <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11994\">PR #11994</a> from <code>bongjunj:mul_ne_eqv_ne_div</code> to <code>bytecodealliance:main</code>:</p>\n<blockquote>\n<p>&lt;!--<br>\nPlease make sure you include the following information:</p>\n<ul>\n<li>\n<p>If this work has been discussed elsewhere, please include a link to that<br>\n  conversation. If it was discussed in an issue, just mention \"issue #...\".</p>\n</li>\n<li>\n<p>Explain why this change is needed. If the details are in an issue already,<br>\n  this can be brief.</p>\n</li>\n</ul>\n<p>Our development process is documented in the Wasmtime book:<br>\n<a href=\"https://docs.wasmtime.dev/contributing-development-process.html\">https://docs.wasmtime.dev/contributing-development-process.html</a></p>\n<p>Please ensure all communication follows the code of conduct:<br>\n<a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md\">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>\n--&gt;</p>\n<p>This add the optimization of <code>(x * y) (==/!=) z --&gt; x (==/!=) (y / z)</code>.<br>\n<code>y</code> must be odd and divides <code>z</code> for the rule to be correct.<br>\n</p>\n</blockquote>",
        "id": 554221334,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1762479186
    },
    {
        "content": "<p><strong>bongjunj</strong> requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers\">wasmtime-compiler-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11994\">PR #11994</a>.</p>",
        "id": 554221336,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1762479186
    },
    {
        "content": "<p><strong>bongjunj</strong> requested <a href=\"https://github.com/cfallin\">cfallin</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11994\">PR #11994</a>.</p>",
        "id": 554221338,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1762479187
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11994#pullrequestreview-3431246662\">PR review</a>.</p>",
        "id": 554223403,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1762480244
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11994#discussion_r2501420118\">PR review comment</a>:</p>\n<blockquote>\n<p>Could you add \"and y and z are constant\" to the description here? Otherwise this reads as a fairly odd optimization that is replacing a multiply with a divide, which would ordinarily reduce performance.</p>\n<p>Also: why is it necessary that <code>y</code> is odd? Is that because we need it to be mutually prime with the ring's modulus (2^n) so the product doesn't collapse to zero?</p>\n</blockquote>",
        "id": 554223405,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1762480244
    },
    {
        "content": "<p>bongjunj updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11994\">PR #11994</a>.</p>",
        "id": 554224535,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1762481040
    },
    {
        "content": "<p>bongjunj submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11994#pullrequestreview-3431273130\">PR review</a>.</p>",
        "id": 554224635,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1762481106
    },
    {
        "content": "<p>bongjunj created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11994#discussion_r2501442085\">PR review comment</a>:</p>\n<blockquote>\n<p>I've changed the description so that one can read that the division happens in compile time.<br>\nAlso,  the solution X for X * C = D is not unique when C is even in 2^n module arithmetic.</p>\n</blockquote>",
        "id": 554224636,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1762481106
    },
    {
        "content": "<p>bongjunj edited <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11994#discussion_r2501442085\">PR review comment</a>.</p>",
        "id": 554224683,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1762481132
    },
    {
        "content": "<p>github-actions[bot] <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11994#issuecomment-3500567431\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11994\">PR #11994</a>:</p>\n<blockquote>\n<h4>Subscribe to Label Action</h4>\n<p>cc @cfallin, @fitzgen</p>\n<p>&lt;details&gt;<br>\nThis issue or pull request has been labeled: \"cranelift\", \"isle\"</p>\n<p>Thus the following users have been cc'd because of the following labels:</p>\n<ul>\n<li>cfallin: isle</li>\n<li>fitzgen: isle</li>\n</ul>\n<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>\n<p><a href=\"https://github.com/bytecodealliance/subscribe-to-label-action\">Learn more.</a><br>\n&lt;/details&gt;</p>\n</blockquote>",
        "id": 554233488,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1762487546
    },
    {
        "content": "<p>bongjunj <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11994#issuecomment-3501283035\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11994\">PR #11994</a>:</p>\n<blockquote>\n<blockquote>\n<p>Could you add \"and y and z are constant\" to the description here? Otherwise this reads as a fairly odd optimization that is replacing a multiply with a divide, which would ordinarily reduce performance.</p>\n<p>Also: why is it necessary that <code>y</code> is odd? Is that because we need it to be mutually prime with the ring's modulus (2^n) so the product doesn't collapse to zero?</p>\n</blockquote>\n<p>To clarify, this is the counterexample obtained by Crocus, when <code>y</code> is relaxed to be any bitvector.<br>\nHere, <code>y</code> is even.</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">Verification</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">unnamed</span><span class=\"w\"> </span><span class=\"n\">rule</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">width</span><span class=\"w\"> </span><span class=\"mi\">8</span>\n<span class=\"p\">(</span><span class=\"n\">simplify</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">ne</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">cty</span><span class=\"o\">|</span><span class=\"mi\">8</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">imul</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">ty</span><span class=\"o\">|</span><span class=\"mi\">32</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">x</span><span class=\"o\">|</span><span class=\"p\">#</span><span class=\"n\">x80000002</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">iconst_u</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">ty</span><span class=\"o\">|</span><span class=\"mi\">32</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">y</span><span class=\"o\">|</span><span class=\"p\">#</span><span class=\"n\">x0000000000448102</span><span class=\"p\">]))</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">iconst_u</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">ty</span><span class=\"o\">|</span><span class=\"mi\">32</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">z</span><span class=\"o\">|</span><span class=\"p\">#</span><span class=\"n\">x0000000000890204</span><span class=\"p\">])))</span>\n<span class=\"p\">(</span><span class=\"k\">if</span><span class=\"o\">-</span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"mi\">0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">u64_rem</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">z</span><span class=\"o\">|</span><span class=\"p\">#</span><span class=\"n\">x0000000000890204</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">y</span><span class=\"o\">|</span><span class=\"p\">#</span><span class=\"n\">x0000000000448102</span><span class=\"p\">]))((</span><span class=\"kc\">true</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">u64_ne</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">y</span><span class=\"o\">|</span><span class=\"p\">#</span><span class=\"n\">x0000000000448102</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">))))</span><span class=\"o\">=&gt;</span>\n<span class=\"p\">(</span><span class=\"n\">ne</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">cty</span><span class=\"o\">|</span><span class=\"mi\">8</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">x</span><span class=\"o\">|</span><span class=\"p\">#</span><span class=\"n\">x80000002</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">iconst</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">ty</span><span class=\"o\">|</span><span class=\"mi\">32</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">imm64</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">u64_div</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">z</span><span class=\"o\">|</span><span class=\"p\">#</span><span class=\"n\">x0000000000890204</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">y</span><span class=\"o\">|</span><span class=\"p\">#</span><span class=\"n\">x0000000000448102</span><span class=\"p\">]))))</span>\n</code></pre></div>\n<p>Furthermore, there is a similar optimization in LLVM</p>\n<p>When <code>y</code> is odd:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">define</span><span class=\"w\"> </span><span class=\"n\">i1</span><span class=\"w\"> </span><span class=\"o\">@</span><span class=\"n\">src</span><span class=\"p\">(</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">x</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"p\">#</span><span class=\"mi\">0</span><span class=\"p\">:</span>\n<span class=\"w\">  </span><span class=\"o\">%</span><span class=\"n\">mul</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">mul</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">x</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">7</span>\n<span class=\"w\">  </span><span class=\"o\">%</span><span class=\"n\">eq</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">icmp</span><span class=\"w\"> </span><span class=\"n\">eq</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">mul</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">42</span>\n<span class=\"w\">  </span><span class=\"n\">ret</span><span class=\"w\"> </span><span class=\"n\">i1</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">eq</span>\n<span class=\"p\">}</span>\n<span class=\"o\">=&gt;</span>\n<span class=\"n\">define</span><span class=\"w\"> </span><span class=\"n\">i1</span><span class=\"w\"> </span><span class=\"o\">@</span><span class=\"n\">src</span><span class=\"p\">(</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">x</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">nofree</span><span class=\"w\"> </span><span class=\"n\">willreturn</span><span class=\"w\"> </span><span class=\"n\">memory</span><span class=\"p\">(</span><span class=\"n\">none</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"p\">#</span><span class=\"mi\">0</span><span class=\"p\">:</span>\n<span class=\"w\">  </span><span class=\"o\">%</span><span class=\"n\">eq</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">icmp</span><span class=\"w\"> </span><span class=\"n\">eq</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">x</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">6</span>\n<span class=\"w\">  </span><span class=\"n\">ret</span><span class=\"w\"> </span><span class=\"n\">i1</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">eq</span>\n<span class=\"p\">}</span>\n<span class=\"n\">Transformation</span><span class=\"w\"> </span><span class=\"n\">seems</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">correct</span><span class=\"o\">!</span>\n</code></pre></div>\n<p>When <code>y</code> is even:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"o\">----------------------------------------</span>\n<span class=\"n\">define</span><span class=\"w\"> </span><span class=\"n\">i1</span><span class=\"w\"> </span><span class=\"o\">@</span><span class=\"n\">src</span><span class=\"p\">(</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">x</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"p\">#</span><span class=\"mi\">0</span><span class=\"p\">:</span>\n<span class=\"w\">  </span><span class=\"o\">%</span><span class=\"n\">mul</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">mul</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">x</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">6</span>\n<span class=\"w\">  </span><span class=\"o\">%</span><span class=\"n\">eq</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">icmp</span><span class=\"w\"> </span><span class=\"n\">eq</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">mul</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">42</span>\n<span class=\"w\">  </span><span class=\"n\">ret</span><span class=\"w\"> </span><span class=\"n\">i1</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">eq</span>\n<span class=\"p\">}</span>\n<span class=\"o\">=&gt;</span>\n<span class=\"n\">define</span><span class=\"w\"> </span><span class=\"n\">i1</span><span class=\"w\"> </span><span class=\"o\">@</span><span class=\"n\">tgt</span><span class=\"p\">(</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">x</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"p\">#</span><span class=\"mi\">0</span><span class=\"p\">:</span>\n<span class=\"w\">  </span><span class=\"o\">%</span><span class=\"n\">eq</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">icmp</span><span class=\"w\"> </span><span class=\"n\">eq</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">x</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">7</span>\n<span class=\"w\">  </span><span class=\"n\">ret</span><span class=\"w\"> </span><span class=\"n\">i1</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">eq</span>\n<span class=\"p\">}</span>\n<span class=\"n\">Transformation</span><span class=\"w\"> </span><span class=\"n\">doesn</span><span class=\"o\">'</span><span class=\"na\">t</span><span class=\"w\"> </span><span class=\"n\">verify</span><span class=\"o\">!</span>\n\n<span class=\"n\">ERROR</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">Value</span><span class=\"w\"> </span><span class=\"n\">mismatch</span>\n\n<span class=\"n\">NOTE</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">The</span><span class=\"w\"> </span><span class=\"n\">counterexample</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">unique</span><span class=\"p\">.</span>\n\n<span class=\"n\">Example</span><span class=\"p\">:</span>\n<span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">#</span><span class=\"n\">x80000007</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">2147483655</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"mi\">2147483641</span><span class=\"p\">)</span>\n\n<span class=\"n\">Source</span><span class=\"p\">:</span>\n<span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">mul</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">#</span><span class=\"n\">x0000002a</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">42</span><span class=\"p\">)</span>\n<span class=\"n\">i1</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">eq</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">#</span><span class=\"n\">x1</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n\n<span class=\"n\">Target</span><span class=\"p\">:</span>\n<span class=\"nc\">i1</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">eq</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">#</span><span class=\"n\">x0</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">)</span>\n<span class=\"n\">Source</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">#</span><span class=\"n\">x1</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n<span class=\"n\">Target</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">#</span><span class=\"n\">x0</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>This shows that the optimization violates the semantic equivalence (or refinement) when <code>y</code> is even.<br>\n</p>\n</blockquote>",
        "id": 554263815,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1762504328
    },
    {
        "content": "<p>bongjunj edited a <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11994#issuecomment-3501283035\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11994\">PR #11994</a>:</p>\n<blockquote>\n<blockquote>\n<p>Could you add \"and y and z are constant\" to the description here? Otherwise this reads as a fairly odd optimization that is replacing a multiply with a divide, which would ordinarily reduce performance.</p>\n<p>Also: why is it necessary that <code>y</code> is odd? Is that because we need it to be mutually prime with the ring's modulus (2^n) so the product doesn't collapse to zero?</p>\n</blockquote>\n<p>To clarify, this is the counterexample obtained by Crocus, when <code>y</code> is relaxed to be any bitvector.<br>\nHere, <code>y</code> is even.</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">Verification</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">unnamed</span><span class=\"w\"> </span><span class=\"n\">rule</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">width</span><span class=\"w\"> </span><span class=\"mi\">8</span>\n<span class=\"p\">(</span><span class=\"n\">simplify</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">ne</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">cty</span><span class=\"o\">|</span><span class=\"mi\">8</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">imul</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">ty</span><span class=\"o\">|</span><span class=\"mi\">32</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">x</span><span class=\"o\">|</span><span class=\"p\">#</span><span class=\"n\">x80000002</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">iconst_u</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">ty</span><span class=\"o\">|</span><span class=\"mi\">32</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">y</span><span class=\"o\">|</span><span class=\"p\">#</span><span class=\"n\">x0000000000448102</span><span class=\"p\">]))</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">iconst_u</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">ty</span><span class=\"o\">|</span><span class=\"mi\">32</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">z</span><span class=\"o\">|</span><span class=\"p\">#</span><span class=\"n\">x0000000000890204</span><span class=\"p\">])))</span>\n<span class=\"p\">(</span><span class=\"k\">if</span><span class=\"o\">-</span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"mi\">0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">u64_rem</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">z</span><span class=\"o\">|</span><span class=\"p\">#</span><span class=\"n\">x0000000000890204</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">y</span><span class=\"o\">|</span><span class=\"p\">#</span><span class=\"n\">x0000000000448102</span><span class=\"p\">]))((</span><span class=\"kc\">true</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">u64_ne</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">y</span><span class=\"o\">|</span><span class=\"p\">#</span><span class=\"n\">x0000000000448102</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">))))</span><span class=\"o\">=&gt;</span>\n<span class=\"p\">(</span><span class=\"n\">ne</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">cty</span><span class=\"o\">|</span><span class=\"mi\">8</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">x</span><span class=\"o\">|</span><span class=\"p\">#</span><span class=\"n\">x80000002</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">iconst</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">ty</span><span class=\"o\">|</span><span class=\"mi\">32</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">imm64</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">u64_div</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">z</span><span class=\"o\">|</span><span class=\"p\">#</span><span class=\"n\">x0000000000890204</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">y</span><span class=\"o\">|</span><span class=\"p\">#</span><span class=\"n\">x0000000000448102</span><span class=\"p\">]))))</span>\n</code></pre></div>\n<p>Furthermore, there is a similar optimization in LLVM</p>\n<p>When <code>y</code> is odd:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">define</span><span class=\"w\"> </span><span class=\"n\">i1</span><span class=\"w\"> </span><span class=\"o\">@</span><span class=\"n\">src</span><span class=\"p\">(</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">x</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"p\">#</span><span class=\"mi\">0</span><span class=\"p\">:</span>\n<span class=\"w\">  </span><span class=\"o\">%</span><span class=\"n\">mul</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">mul</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">x</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">7</span>\n<span class=\"w\">  </span><span class=\"o\">%</span><span class=\"n\">eq</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">icmp</span><span class=\"w\"> </span><span class=\"n\">eq</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">mul</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">42</span>\n<span class=\"w\">  </span><span class=\"n\">ret</span><span class=\"w\"> </span><span class=\"n\">i1</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">eq</span>\n<span class=\"p\">}</span>\n<span class=\"o\">=&gt;</span>\n<span class=\"n\">define</span><span class=\"w\"> </span><span class=\"n\">i1</span><span class=\"w\"> </span><span class=\"o\">@</span><span class=\"n\">src</span><span class=\"p\">(</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">x</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">nofree</span><span class=\"w\"> </span><span class=\"n\">willreturn</span><span class=\"w\"> </span><span class=\"n\">memory</span><span class=\"p\">(</span><span class=\"n\">none</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"p\">#</span><span class=\"mi\">0</span><span class=\"p\">:</span>\n<span class=\"w\">  </span><span class=\"o\">%</span><span class=\"n\">eq</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">icmp</span><span class=\"w\"> </span><span class=\"n\">eq</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">x</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">6</span>\n<span class=\"w\">  </span><span class=\"n\">ret</span><span class=\"w\"> </span><span class=\"n\">i1</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">eq</span>\n<span class=\"p\">}</span>\n<span class=\"n\">Transformation</span><span class=\"w\"> </span><span class=\"n\">seems</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">correct</span><span class=\"o\">!</span>\n</code></pre></div>\n<p>When <code>y</code> is even:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"o\">----------------------------------------</span>\n<span class=\"n\">define</span><span class=\"w\"> </span><span class=\"n\">i1</span><span class=\"w\"> </span><span class=\"o\">@</span><span class=\"n\">src</span><span class=\"p\">(</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">x</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"p\">#</span><span class=\"mi\">0</span><span class=\"p\">:</span>\n<span class=\"w\">  </span><span class=\"o\">%</span><span class=\"n\">mul</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">mul</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">x</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">6</span>\n<span class=\"w\">  </span><span class=\"o\">%</span><span class=\"n\">eq</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">icmp</span><span class=\"w\"> </span><span class=\"n\">eq</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">mul</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">42</span>\n<span class=\"w\">  </span><span class=\"n\">ret</span><span class=\"w\"> </span><span class=\"n\">i1</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">eq</span>\n<span class=\"p\">}</span>\n<span class=\"o\">=&gt;</span>\n<span class=\"n\">define</span><span class=\"w\"> </span><span class=\"n\">i1</span><span class=\"w\"> </span><span class=\"o\">@</span><span class=\"n\">tgt</span><span class=\"p\">(</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">x</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"p\">#</span><span class=\"mi\">0</span><span class=\"p\">:</span>\n<span class=\"w\">  </span><span class=\"o\">%</span><span class=\"n\">eq</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">icmp</span><span class=\"w\"> </span><span class=\"n\">eq</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">x</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">7</span>\n<span class=\"w\">  </span><span class=\"n\">ret</span><span class=\"w\"> </span><span class=\"n\">i1</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">eq</span>\n<span class=\"p\">}</span>\n<span class=\"n\">Transformation</span><span class=\"w\"> </span><span class=\"n\">doesn</span><span class=\"o\">'</span><span class=\"na\">t</span><span class=\"w\"> </span><span class=\"n\">verify</span><span class=\"o\">!</span>\n\n<span class=\"n\">ERROR</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">Value</span><span class=\"w\"> </span><span class=\"n\">mismatch</span>\n\n<span class=\"n\">NOTE</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">The</span><span class=\"w\"> </span><span class=\"n\">counterexample</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">unique</span><span class=\"p\">.</span>\n\n<span class=\"n\">Example</span><span class=\"p\">:</span>\n<span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">#</span><span class=\"n\">x80000007</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">2147483655</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"mi\">2147483641</span><span class=\"p\">)</span>\n\n<span class=\"n\">Source</span><span class=\"p\">:</span>\n<span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">mul</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">#</span><span class=\"n\">x0000002a</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">42</span><span class=\"p\">)</span>\n<span class=\"n\">i1</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">eq</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">#</span><span class=\"n\">x1</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n\n<span class=\"n\">Target</span><span class=\"p\">:</span>\n<span class=\"nc\">i1</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">eq</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">#</span><span class=\"n\">x0</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">)</span>\n<span class=\"n\">Source</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">#</span><span class=\"n\">x1</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n<span class=\"n\">Target</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">#</span><span class=\"n\">x0</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>This shows that the optimization violates the semantic equivalence (or refinement) when <code>y</code> is even.</p>\n<p>Reference implementation in LLVM: <a href=\"https://github.com/llvm/llvm-project/blob/a257a063c6fdcbc1db897d360c3791d8c4f4e48d/llvm/lib/Transforms/InstCombine/InstCombineCompares.cpp#L2209-L2230\">https://github.com/llvm/llvm-project/blob/a257a063c6fdcbc1db897d360c3791d8c4f4e48d/llvm/lib/Transforms/InstCombine/InstCombineCompares.cpp#L2209-L2230</a></p>\n</blockquote>",
        "id": 554264198,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1762504470
    },
    {
        "content": "<p>bongjunj edited a <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11994#issuecomment-3501283035\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11994\">PR #11994</a>:</p>\n<blockquote>\n<blockquote>\n<p>Could you add \"and y and z are constant\" to the description here? Otherwise this reads as a fairly odd optimization that is replacing a multiply with a divide, which would ordinarily reduce performance.</p>\n<p>Also: why is it necessary that <code>y</code> is odd? Is that because we need it to be mutually prime with the ring's modulus (2^n) so the product doesn't collapse to zero?</p>\n</blockquote>\n<p>To clarify, this is the counterexample obtained by Crocus, when <code>y</code> is relaxed to be any bitvector.<br>\nHere, <code>y</code> is even.</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">Verification</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">unnamed</span><span class=\"w\"> </span><span class=\"n\">rule</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">width</span><span class=\"w\"> </span><span class=\"mi\">8</span>\n<span class=\"p\">(</span><span class=\"n\">simplify</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">ne</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">cty</span><span class=\"o\">|</span><span class=\"mi\">8</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">imul</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">ty</span><span class=\"o\">|</span><span class=\"mi\">32</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">x</span><span class=\"o\">|</span><span class=\"p\">#</span><span class=\"n\">x80000002</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">iconst_u</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">ty</span><span class=\"o\">|</span><span class=\"mi\">32</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">y</span><span class=\"o\">|</span><span class=\"p\">#</span><span class=\"n\">x0000000000448102</span><span class=\"p\">]))</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">iconst_u</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">ty</span><span class=\"o\">|</span><span class=\"mi\">32</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">z</span><span class=\"o\">|</span><span class=\"p\">#</span><span class=\"n\">x0000000000890204</span><span class=\"p\">])))</span>\n<span class=\"p\">(</span><span class=\"k\">if</span><span class=\"o\">-</span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"p\">((</span><span class=\"mi\">0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">u64_rem</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">z</span><span class=\"o\">|</span><span class=\"p\">#</span><span class=\"n\">x0000000000890204</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">y</span><span class=\"o\">|</span><span class=\"p\">#</span><span class=\"n\">x0000000000448102</span><span class=\"p\">]))((</span><span class=\"kc\">true</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">u64_ne</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">y</span><span class=\"o\">|</span><span class=\"p\">#</span><span class=\"n\">x0000000000448102</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">))))</span><span class=\"o\">=&gt;</span>\n<span class=\"p\">(</span><span class=\"n\">ne</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">cty</span><span class=\"o\">|</span><span class=\"mi\">8</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">x</span><span class=\"o\">|</span><span class=\"p\">#</span><span class=\"n\">x80000002</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">iconst</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">ty</span><span class=\"o\">|</span><span class=\"mi\">32</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">imm64</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">u64_div</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">z</span><span class=\"o\">|</span><span class=\"p\">#</span><span class=\"n\">x0000000000890204</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">y</span><span class=\"o\">|</span><span class=\"p\">#</span><span class=\"n\">x0000000000448102</span><span class=\"p\">]))))</span>\n</code></pre></div>\n<p>Furthermore, there is a similar optimization in LLVM, and the optimization requires <code>y</code> to be odd as well.</p>\n<p>When <code>y</code> is odd:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">define</span><span class=\"w\"> </span><span class=\"n\">i1</span><span class=\"w\"> </span><span class=\"o\">@</span><span class=\"n\">src</span><span class=\"p\">(</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">x</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"p\">#</span><span class=\"mi\">0</span><span class=\"p\">:</span>\n<span class=\"w\">  </span><span class=\"o\">%</span><span class=\"n\">mul</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">mul</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">x</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">7</span>\n<span class=\"w\">  </span><span class=\"o\">%</span><span class=\"n\">eq</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">icmp</span><span class=\"w\"> </span><span class=\"n\">eq</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">mul</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">42</span>\n<span class=\"w\">  </span><span class=\"n\">ret</span><span class=\"w\"> </span><span class=\"n\">i1</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">eq</span>\n<span class=\"p\">}</span>\n<span class=\"o\">=&gt;</span>\n<span class=\"n\">define</span><span class=\"w\"> </span><span class=\"n\">i1</span><span class=\"w\"> </span><span class=\"o\">@</span><span class=\"n\">src</span><span class=\"p\">(</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">x</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">nofree</span><span class=\"w\"> </span><span class=\"n\">willreturn</span><span class=\"w\"> </span><span class=\"n\">memory</span><span class=\"p\">(</span><span class=\"n\">none</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"p\">#</span><span class=\"mi\">0</span><span class=\"p\">:</span>\n<span class=\"w\">  </span><span class=\"o\">%</span><span class=\"n\">eq</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">icmp</span><span class=\"w\"> </span><span class=\"n\">eq</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">x</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">6</span>\n<span class=\"w\">  </span><span class=\"n\">ret</span><span class=\"w\"> </span><span class=\"n\">i1</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">eq</span>\n<span class=\"p\">}</span>\n<span class=\"n\">Transformation</span><span class=\"w\"> </span><span class=\"n\">seems</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">be</span><span class=\"w\"> </span><span class=\"n\">correct</span><span class=\"o\">!</span>\n</code></pre></div>\n<p>When <code>y</code> is even:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"o\">----------------------------------------</span>\n<span class=\"n\">define</span><span class=\"w\"> </span><span class=\"n\">i1</span><span class=\"w\"> </span><span class=\"o\">@</span><span class=\"n\">src</span><span class=\"p\">(</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">x</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"p\">#</span><span class=\"mi\">0</span><span class=\"p\">:</span>\n<span class=\"w\">  </span><span class=\"o\">%</span><span class=\"n\">mul</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">mul</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">x</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">6</span>\n<span class=\"w\">  </span><span class=\"o\">%</span><span class=\"n\">eq</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">icmp</span><span class=\"w\"> </span><span class=\"n\">eq</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">mul</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">42</span>\n<span class=\"w\">  </span><span class=\"n\">ret</span><span class=\"w\"> </span><span class=\"n\">i1</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">eq</span>\n<span class=\"p\">}</span>\n<span class=\"o\">=&gt;</span>\n<span class=\"n\">define</span><span class=\"w\"> </span><span class=\"n\">i1</span><span class=\"w\"> </span><span class=\"o\">@</span><span class=\"n\">tgt</span><span class=\"p\">(</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">x</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"p\">#</span><span class=\"mi\">0</span><span class=\"p\">:</span>\n<span class=\"w\">  </span><span class=\"o\">%</span><span class=\"n\">eq</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">icmp</span><span class=\"w\"> </span><span class=\"n\">eq</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">x</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">7</span>\n<span class=\"w\">  </span><span class=\"n\">ret</span><span class=\"w\"> </span><span class=\"n\">i1</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">eq</span>\n<span class=\"p\">}</span>\n<span class=\"n\">Transformation</span><span class=\"w\"> </span><span class=\"n\">doesn</span><span class=\"o\">'</span><span class=\"na\">t</span><span class=\"w\"> </span><span class=\"n\">verify</span><span class=\"o\">!</span>\n\n<span class=\"n\">ERROR</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">Value</span><span class=\"w\"> </span><span class=\"n\">mismatch</span>\n\n<span class=\"n\">NOTE</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">The</span><span class=\"w\"> </span><span class=\"n\">counterexample</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">unique</span><span class=\"p\">.</span>\n\n<span class=\"n\">Example</span><span class=\"p\">:</span>\n<span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">x</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">#</span><span class=\"n\">x80000007</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">2147483655</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"mi\">2147483641</span><span class=\"p\">)</span>\n\n<span class=\"n\">Source</span><span class=\"p\">:</span>\n<span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">mul</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">#</span><span class=\"n\">x0000002a</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">42</span><span class=\"p\">)</span>\n<span class=\"n\">i1</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">eq</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">#</span><span class=\"n\">x1</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n\n<span class=\"n\">Target</span><span class=\"p\">:</span>\n<span class=\"nc\">i1</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">eq</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">#</span><span class=\"n\">x0</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">)</span>\n<span class=\"n\">Source</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">#</span><span class=\"n\">x1</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n<span class=\"n\">Target</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">#</span><span class=\"n\">x0</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>This shows that the optimization violates the semantic equivalence (or refinement) when <code>y</code> is even.</p>\n<p>Reference implementation in LLVM: <a href=\"https://github.com/llvm/llvm-project/blob/a257a063c6fdcbc1db897d360c3791d8c4f4e48d/llvm/lib/Transforms/InstCombine/InstCombineCompares.cpp#L2209-L2230\">https://github.com/llvm/llvm-project/blob/a257a063c6fdcbc1db897d360c3791d8c4f4e48d/llvm/lib/Transforms/InstCombine/InstCombineCompares.cpp#L2209-L2230</a></p>\n</blockquote>",
        "id": 554264233,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1762504486
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11994#pullrequestreview-3435441327\">PR review</a>:</p>\n<blockquote>\n<p>Yep, that makes sense -- just wanted to get it written down why. Thanks! Happy to merge once the merge conflicts are resolved.</p>\n</blockquote>",
        "id": 554381596,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1762537498
    },
    {
        "content": "<p>bongjunj updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11994\">PR #11994</a>.</p>",
        "id": 554440896,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1762566796
    },
    {
        "content": "<p>bongjunj updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11994\">PR #11994</a>.</p>",
        "id": 554441041,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1762566922
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11994#pullrequestreview-3437030229\">PR review</a>.</p>",
        "id": 554441267,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1762567117
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11994#discussion_r2505968559\">PR review comment</a>:</p>\n<blockquote>\n<p>One more request, sorry -- could you add the commutative versions (const * x) for both rules as well?</p>\n</blockquote>",
        "id": 554441268,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1762567117
    },
    {
        "content": "<p>bongjunj updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11994\">PR #11994</a>.</p>",
        "id": 554450821,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1762576603
    },
    {
        "content": "<p>bongjunj updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11994\">PR #11994</a>.</p>",
        "id": 554450890,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1762576676
    },
    {
        "content": "<p>bongjunj submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11994#pullrequestreview-3437493149\">PR review</a>.</p>",
        "id": 554450923,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1762576715
    },
    {
        "content": "<p>bongjunj created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11994#discussion_r2506211291\">PR review comment</a>:</p>\n<blockquote>\n<p>Thanks!</p>\n</blockquote>",
        "id": 554450924,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1762576715
    },
    {
        "content": "<p>bongjunj updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11994\">PR #11994</a>.</p>",
        "id": 554452207,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1762577887
    },
    {
        "content": "<p>cfallin merged <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11994\">PR #11994</a>.</p>",
        "id": 554459265,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1762585004
    }
]
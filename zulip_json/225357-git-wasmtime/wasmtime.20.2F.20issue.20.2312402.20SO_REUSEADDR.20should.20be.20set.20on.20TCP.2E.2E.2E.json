[
    {
        "content": "<p>wingo opened <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12402\">issue #12402</a>:</p>\n<blockquote>\n<p>When writing a test that sockets have <code>SO_REUSEADDR</code> set for wasip3, @saulecabrera ran into a bug that shows up only on Linux (not mac, not windows): </p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">async</span><span class=\"w\"> </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">test_reuseaddr</span><span class=\"p\">(</span><span class=\"n\">family</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">IpAddressFamily</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">client</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">TcpSocket</span><span class=\"p\">::</span><span class=\"n\">create</span><span class=\"p\">(</span><span class=\"n\">family</span><span class=\"p\">).</span><span class=\"n\">unwrap</span><span class=\"p\">();</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">local_addr</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">server</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">TcpSocket</span><span class=\"p\">::</span><span class=\"n\">create</span><span class=\"p\">(</span><span class=\"n\">family</span><span class=\"p\">).</span><span class=\"n\">unwrap</span><span class=\"p\">();</span>\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">addr</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">IpSocketAddress</span><span class=\"p\">::</span><span class=\"n\">localhost</span><span class=\"p\">(</span><span class=\"n\">family</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"n\">server</span><span class=\"p\">.</span><span class=\"n\">bind</span><span class=\"p\">(</span><span class=\"n\">addr</span><span class=\"p\">).</span><span class=\"n\">unwrap</span><span class=\"p\">();</span>\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">local_addr</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">server</span><span class=\"p\">.</span><span class=\"n\">get_local_address</span><span class=\"p\">().</span><span class=\"n\">unwrap</span><span class=\"p\">();</span>\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">accept</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">server</span><span class=\"p\">.</span><span class=\"n\">listen</span><span class=\"p\">().</span><span class=\"n\">unwrap</span><span class=\"p\">();</span>\n<span class=\"w\">        </span><span class=\"n\">join</span><span class=\"o\">!</span><span class=\"p\">(</span>\n<span class=\"w\">            </span><span class=\"c1\">// Change the state to connected.</span>\n<span class=\"w\">            </span><span class=\"k\">async</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">                </span><span class=\"n\">client</span><span class=\"p\">.</span><span class=\"n\">connect</span><span class=\"p\">(</span><span class=\"n\">local_addr</span><span class=\"p\">).</span><span class=\"k\">await</span><span class=\"p\">.</span><span class=\"n\">unwrap</span><span class=\"p\">();</span>\n<span class=\"w\">            </span><span class=\"p\">},</span>\n<span class=\"w\">            </span><span class=\"k\">async</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">                </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">sock</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">accept</span><span class=\"p\">.</span><span class=\"n\">next</span><span class=\"p\">().</span><span class=\"k\">await</span><span class=\"p\">.</span><span class=\"n\">unwrap</span><span class=\"p\">();</span>\n<span class=\"w\">                </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">send_tx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">send_rx</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">wit_stream</span><span class=\"p\">::</span><span class=\"n\">new</span><span class=\"p\">();</span>\n<span class=\"w\">                </span><span class=\"n\">join</span><span class=\"o\">!</span><span class=\"p\">(</span>\n<span class=\"w\">                    </span><span class=\"k\">async</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">                        </span><span class=\"n\">sock</span><span class=\"p\">.</span><span class=\"n\">send</span><span class=\"p\">(</span><span class=\"n\">send_rx</span><span class=\"p\">).</span><span class=\"k\">await</span><span class=\"p\">.</span><span class=\"n\">unwrap</span><span class=\"p\">();</span>\n<span class=\"w\">                    </span><span class=\"p\">},</span>\n<span class=\"w\">                    </span><span class=\"k\">async</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">                        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">remaining</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">send_tx</span><span class=\"p\">.</span><span class=\"n\">write_all</span><span class=\"p\">(</span><span class=\"fm\">vec!</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">]).</span><span class=\"k\">await</span><span class=\"p\">;</span>\n<span class=\"w\">                        </span><span class=\"fm\">assert!</span><span class=\"p\">(</span><span class=\"n\">remaining</span><span class=\"p\">.</span><span class=\"n\">is_empty</span><span class=\"p\">());</span>\n<span class=\"w\">                        </span><span class=\"nb\">drop</span><span class=\"p\">(</span><span class=\"n\">send_tx</span><span class=\"p\">);</span>\n<span class=\"w\">                    </span><span class=\"p\">}</span>\n<span class=\"w\">                </span><span class=\"p\">);</span>\n<span class=\"w\">            </span><span class=\"p\">}</span>\n<span class=\"w\">        </span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"n\">local_addr</span>\n<span class=\"w\">    </span><span class=\"p\">};</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// Immediately try to connect to the same after the connection is</span>\n<span class=\"w\">    </span><span class=\"c1\">// dropped.  According to the spec, `SO_REUSEADDR` should be set</span>\n<span class=\"w\">    </span><span class=\"c1\">// by default, so the next connection should not be affected by</span>\n<span class=\"w\">    </span><span class=\"c1\">// the `TIME_WAIT` state.</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">next</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">TcpSocket</span><span class=\"p\">::</span><span class=\"n\">create</span><span class=\"p\">(</span><span class=\"n\">family</span><span class=\"p\">).</span><span class=\"n\">unwrap</span><span class=\"p\">();</span>\n<span class=\"w\">    </span><span class=\"n\">next</span><span class=\"p\">.</span><span class=\"n\">bind</span><span class=\"p\">(</span><span class=\"n\">local_addr</span><span class=\"p\">).</span><span class=\"n\">unwrap</span><span class=\"p\">();</span>\n<span class=\"w\">    </span><span class=\"n\">next</span><span class=\"p\">.</span><span class=\"n\">listen</span><span class=\"p\">().</span><span class=\"n\">unwrap</span><span class=\"p\">();</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>When <code>next</code> is bound to the same <code>local_addr</code>, the bind fails.  It is apparently because the <em>first</em> socket <code>server</code> wasn't opened with REUSEADDR, because port is 0 : <a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasi/src/sockets/util.rs#L345\">https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasi/src/sockets/util.rs#L345</a>.  If I change the condition on that line to unconditional \"true\", Saúl's wasi test passes, and no wasmtime test fails.</p>\n<p>So, I propose that wasmtime should just always set REUSEADDR (unless we are on a windows system).</p>\n<p>Full test here: <a href=\"https://github.com/WebAssembly/wasi-testsuite/pull/205\">https://github.com/WebAssembly/wasi-testsuite/pull/205</a></p>\n</blockquote>",
        "id": 569723376,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769177164
    },
    {
        "content": "<p><a href=\"https://github.com/wingo\">wingo</a> added the bug label to <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12402\">Issue #12402</a>.</p>",
        "id": 569723379,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769177164
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12402#issuecomment-3793006576\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12402\">issue #12402</a>:</p>\n<blockquote>\n<p>cc @badeend, do you know why <a href=\"https://github.com/bytecodealliance/wasmtime/blob/21797bb5ec194a319e4837f70bb2fa697a216b9b/crates/wasi/src/sockets/util.rs#L345\">this explicitly excludes port 0</a> from setting reuseaddr? Changing that gets this test passing, and naively I'd expect <code>true</code> to be unconditional there, but you're far more knowledgable about this all than I</p>\n</blockquote>",
        "id": 569817942,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769211001
    },
    {
        "content": "<p><a href=\"https://github.com/alexcrichton\">alexcrichton</a> added the wasi label to <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12402\">Issue #12402</a>.</p>",
        "id": 569817954,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769211005
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12402#issuecomment-3793011623\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12402\">issue #12402</a>:</p>\n<blockquote>\n<p>Also @rvolosatovs you might be able to shed more light on my <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12402#issuecomment-3793006576\">above question</a> too</p>\n</blockquote>",
        "id": 569818122,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769211163
    },
    {
        "content": "<p>badeend <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12402#issuecomment-3836948456\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12402\">issue #12402</a>:</p>\n<blockquote>\n<p>Yes, this is indeed a consequence of the current setup.</p>\n<p>For listener sockets I think it's fine to set it unconditionally.<br>\nFor client sockets I'm not sure.<br>\nLet me think about it</p>\n</blockquote>",
        "id": 571500241,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1770057027
    },
    {
        "content": "<p>badeend <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12402#issuecomment-3903902162\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12402\">issue #12402</a>:</p>\n<blockquote>\n<p>I think it should be fine <span aria-label=\"+1\" class=\"emoji emoji-1f44d\" role=\"img\" title=\"+1\">:+1:</span> </p>\n<p>PTAL at the two PRs I just opened</p>\n</blockquote>",
        "id": 573962846,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1771147031
    },
    {
        "content": "<p>alexcrichton closed <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12402\">issue #12402</a>:</p>\n<blockquote>\n<p>When writing a test that sockets have <code>SO_REUSEADDR</code> set for wasip3, @saulecabrera ran into a bug that shows up only on Linux (not mac, not windows): </p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">async</span><span class=\"w\"> </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">test_reuseaddr</span><span class=\"p\">(</span><span class=\"n\">family</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">IpAddressFamily</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">client</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">TcpSocket</span><span class=\"p\">::</span><span class=\"n\">create</span><span class=\"p\">(</span><span class=\"n\">family</span><span class=\"p\">).</span><span class=\"n\">unwrap</span><span class=\"p\">();</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">local_addr</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">server</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">TcpSocket</span><span class=\"p\">::</span><span class=\"n\">create</span><span class=\"p\">(</span><span class=\"n\">family</span><span class=\"p\">).</span><span class=\"n\">unwrap</span><span class=\"p\">();</span>\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">addr</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">IpSocketAddress</span><span class=\"p\">::</span><span class=\"n\">localhost</span><span class=\"p\">(</span><span class=\"n\">family</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"n\">server</span><span class=\"p\">.</span><span class=\"n\">bind</span><span class=\"p\">(</span><span class=\"n\">addr</span><span class=\"p\">).</span><span class=\"n\">unwrap</span><span class=\"p\">();</span>\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">local_addr</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">server</span><span class=\"p\">.</span><span class=\"n\">get_local_address</span><span class=\"p\">().</span><span class=\"n\">unwrap</span><span class=\"p\">();</span>\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">accept</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">server</span><span class=\"p\">.</span><span class=\"n\">listen</span><span class=\"p\">().</span><span class=\"n\">unwrap</span><span class=\"p\">();</span>\n<span class=\"w\">        </span><span class=\"n\">join</span><span class=\"o\">!</span><span class=\"p\">(</span>\n<span class=\"w\">            </span><span class=\"c1\">// Change the state to connected.</span>\n<span class=\"w\">            </span><span class=\"k\">async</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">                </span><span class=\"n\">client</span><span class=\"p\">.</span><span class=\"n\">connect</span><span class=\"p\">(</span><span class=\"n\">local_addr</span><span class=\"p\">).</span><span class=\"k\">await</span><span class=\"p\">.</span><span class=\"n\">unwrap</span><span class=\"p\">();</span>\n<span class=\"w\">            </span><span class=\"p\">},</span>\n<span class=\"w\">            </span><span class=\"k\">async</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">                </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">sock</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">accept</span><span class=\"p\">.</span><span class=\"n\">next</span><span class=\"p\">().</span><span class=\"k\">await</span><span class=\"p\">.</span><span class=\"n\">unwrap</span><span class=\"p\">();</span>\n<span class=\"w\">                </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">send_tx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">send_rx</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">wit_stream</span><span class=\"p\">::</span><span class=\"n\">new</span><span class=\"p\">();</span>\n<span class=\"w\">                </span><span class=\"n\">join</span><span class=\"o\">!</span><span class=\"p\">(</span>\n<span class=\"w\">                    </span><span class=\"k\">async</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">                        </span><span class=\"n\">sock</span><span class=\"p\">.</span><span class=\"n\">send</span><span class=\"p\">(</span><span class=\"n\">send_rx</span><span class=\"p\">).</span><span class=\"k\">await</span><span class=\"p\">.</span><span class=\"n\">unwrap</span><span class=\"p\">();</span>\n<span class=\"w\">                    </span><span class=\"p\">},</span>\n<span class=\"w\">                    </span><span class=\"k\">async</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">                        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">remaining</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">send_tx</span><span class=\"p\">.</span><span class=\"n\">write_all</span><span class=\"p\">(</span><span class=\"fm\">vec!</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">]).</span><span class=\"k\">await</span><span class=\"p\">;</span>\n<span class=\"w\">                        </span><span class=\"fm\">assert!</span><span class=\"p\">(</span><span class=\"n\">remaining</span><span class=\"p\">.</span><span class=\"n\">is_empty</span><span class=\"p\">());</span>\n<span class=\"w\">                        </span><span class=\"nb\">drop</span><span class=\"p\">(</span><span class=\"n\">send_tx</span><span class=\"p\">);</span>\n<span class=\"w\">                    </span><span class=\"p\">}</span>\n<span class=\"w\">                </span><span class=\"p\">);</span>\n<span class=\"w\">            </span><span class=\"p\">}</span>\n<span class=\"w\">        </span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"n\">local_addr</span>\n<span class=\"w\">    </span><span class=\"p\">};</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// Immediately try to connect to the same after the connection is</span>\n<span class=\"w\">    </span><span class=\"c1\">// dropped.  According to the spec, `SO_REUSEADDR` should be set</span>\n<span class=\"w\">    </span><span class=\"c1\">// by default, so the next connection should not be affected by</span>\n<span class=\"w\">    </span><span class=\"c1\">// the `TIME_WAIT` state.</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">next</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">TcpSocket</span><span class=\"p\">::</span><span class=\"n\">create</span><span class=\"p\">(</span><span class=\"n\">family</span><span class=\"p\">).</span><span class=\"n\">unwrap</span><span class=\"p\">();</span>\n<span class=\"w\">    </span><span class=\"n\">next</span><span class=\"p\">.</span><span class=\"n\">bind</span><span class=\"p\">(</span><span class=\"n\">local_addr</span><span class=\"p\">).</span><span class=\"n\">unwrap</span><span class=\"p\">();</span>\n<span class=\"w\">    </span><span class=\"n\">next</span><span class=\"p\">.</span><span class=\"n\">listen</span><span class=\"p\">().</span><span class=\"n\">unwrap</span><span class=\"p\">();</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>When <code>next</code> is bound to the same <code>local_addr</code>, the bind fails.  It is apparently because the <em>first</em> socket <code>server</code> wasn't opened with REUSEADDR, because port is 0 : <a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasi/src/sockets/util.rs#L345\">https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasi/src/sockets/util.rs#L345</a>.  If I change the condition on that line to unconditional \"true\", Saúl's wasi test passes, and no wasmtime test fails.</p>\n<p>So, I propose that wasmtime should just always set REUSEADDR (unless we are on a windows system).</p>\n<p>Full test here: <a href=\"https://github.com/WebAssembly/wasi-testsuite/pull/205\">https://github.com/WebAssembly/wasi-testsuite/pull/205</a></p>\n</blockquote>",
        "id": 573990216,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1771174108
    }
]
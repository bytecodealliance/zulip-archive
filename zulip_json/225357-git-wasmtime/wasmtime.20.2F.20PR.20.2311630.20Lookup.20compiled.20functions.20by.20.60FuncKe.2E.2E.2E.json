[
    {
        "content": "<p>fitzgen opened <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11630\">PR #11630</a> from <code>fitzgen:organize-compiled-func-locs-by-func-key</code> to <code>bytecodealliance:main</code>:</p>\n<blockquote>\n<p>This treats compiled functions homogeneously, removing the need to add new metadata tables to places like <code>CompiledModuleInfo</code> whenever we add a new kind of function, and simplifying the process of constructing the metadata for a final, linked compilation artifact. This also paves the way to doing gc-sections in our linking (getting smaller code sizes, removing functions that have been inlined into every caller, and etc...) as we no longer assume that certain types of function index spaces are dense.</p>\n<p>This does, however, replace a couple operations that were previously O(1) table lookups with O(log n) binary searches. And, notably, some of these are on the <code>VMFuncRef</code>-creation path, and therefore on the<br>\nforce-initialization-of-a-lazy-funcref-table-slot path, when we look up a Wasm function and its trampolines. Our call-indirect micro-benchmarks show that indirect calling every funcref once in a table of 64Ki slots went from taking ~2.6ms to ~3.8ms (a +46% slowdown). Note that this edge case is both synthetic and the worst-case scenario for this commit's change: we are measuring, as much as we can, <em>only</em> the force-initialization-of-a-lazy-funcref-table-slot path. All other call-indirect benchmarks are within the noise, which is what we would expect.</p>\n<p>Also, the size of <code>.cwasm</code>s is slightly larger: <code>spidermonkey.wasm</code>'s <code>.cwasm</code> size went from <code>19_750_632</code> bytes to <code>19785872</code> bytes, which is a 1.78% increase.</p>\n<p>Ultimately, I believe that the simplification and possibility of doing gc-sections in the future is worth the downsides. That said, if others feel differently, there are some things we could try to improve the situation, although most things I can think of off the top of my head (e.g. LEB128s and delta encoding, making certain <code>FuncKey</code> kinds' index spaces dense) will improve one of code size or lookup times while pessimizing the other. I'm sure we could come up with something given enough effort though.</p>\n<p>&lt;details&gt;</p>\n<p>&lt;summary&gt;call-indirect micro-benchmarks results&lt;/summary&gt;</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">call</span><span class=\"o\">-</span><span class=\"n\">indirect</span><span class=\"o\">/</span><span class=\"n\">same</span><span class=\"o\">-</span><span class=\"n\">callee</span><span class=\"o\">/</span><span class=\"n\">table</span><span class=\"o\">-</span><span class=\"n\">init</span><span class=\"o\">-</span><span class=\"n\">lazy</span><span class=\"o\">/</span><span class=\"mi\">65536</span><span class=\"o\">-</span><span class=\"n\">calls</span>\n<span class=\"w\">                        </span><span class=\"n\">time</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"p\">[</span><span class=\"mf\">144.14</span><span class=\"w\"> </span><span class=\"err\">µ</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"mf\">145.26</span><span class=\"w\"> </span><span class=\"err\">µ</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"mf\">146.56</span><span class=\"w\"> </span><span class=\"err\">µ</span><span class=\"n\">s</span><span class=\"p\">]</span>\n<span class=\"w\">                        </span><span class=\"n\">thrpt</span><span class=\"p\">:</span><span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mf\">447.15</span><span class=\"w\"> </span><span class=\"n\">Melem</span><span class=\"o\">/</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"mf\">451.15</span><span class=\"w\"> </span><span class=\"n\">Melem</span><span class=\"o\">/</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"mf\">454.68</span><span class=\"w\"> </span><span class=\"n\">Melem</span><span class=\"o\">/</span><span class=\"n\">s</span><span class=\"p\">]</span>\n<span class=\"w\">                 </span><span class=\"n\">change</span><span class=\"p\">:</span>\n<span class=\"w\">                        </span><span class=\"nc\">time</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"p\">[</span><span class=\"err\">−</span><span class=\"mf\">5.5066</span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"err\">−</span><span class=\"mf\">3.6611</span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"err\">−</span><span class=\"mf\">1.9130</span><span class=\"o\">%</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">0.00</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"mf\">0.05</span><span class=\"p\">)</span>\n<span class=\"w\">                        </span><span class=\"n\">thrpt</span><span class=\"p\">:</span><span class=\"w\">  </span><span class=\"p\">[</span><span class=\"o\">+</span><span class=\"mf\">1.9503</span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"mf\">3.8002</span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"mf\">5.8275</span><span class=\"o\">%</span><span class=\"p\">]</span>\n<span class=\"w\">                        </span><span class=\"n\">Performance</span><span class=\"w\"> </span><span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">improved</span><span class=\"p\">.</span>\n<span class=\"n\">Found</span><span class=\"w\"> </span><span class=\"mi\">9</span><span class=\"w\"> </span><span class=\"n\">outliers</span><span class=\"w\"> </span><span class=\"n\">among</span><span class=\"w\"> </span><span class=\"mi\">100</span><span class=\"w\"> </span><span class=\"n\">measurements</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mf\">9.00</span><span class=\"o\">%</span><span class=\"p\">)</span>\n<span class=\"w\">  </span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mf\">7.00</span><span class=\"o\">%</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">high</span><span class=\"w\"> </span><span class=\"n\">mild</span>\n<span class=\"w\">  </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mf\">2.00</span><span class=\"o\">%</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">high</span><span class=\"w\"> </span><span class=\"n\">severe</span>\n<span class=\"n\">call</span><span class=\"o\">-</span><span class=\"n\">indirect</span><span class=\"o\">/</span><span class=\"n\">different</span><span class=\"o\">-</span><span class=\"n\">callees</span><span class=\"o\">/</span><span class=\"n\">table</span><span class=\"o\">-</span><span class=\"n\">init</span><span class=\"o\">-</span><span class=\"n\">lazy</span><span class=\"o\">/</span><span class=\"mi\">65536</span><span class=\"o\">-</span><span class=\"n\">calls</span>\n<span class=\"w\">                        </span><span class=\"n\">time</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"p\">[</span><span class=\"mf\">3.8128</span><span class=\"w\"> </span><span class=\"n\">ms</span><span class=\"w\"> </span><span class=\"mf\">3.8433</span><span class=\"w\"> </span><span class=\"n\">ms</span><span class=\"w\"> </span><span class=\"mf\">3.8763</span><span class=\"w\"> </span><span class=\"n\">ms</span><span class=\"p\">]</span>\n<span class=\"w\">                        </span><span class=\"n\">thrpt</span><span class=\"p\">:</span><span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mf\">16.907</span><span class=\"w\"> </span><span class=\"n\">Melem</span><span class=\"o\">/</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"mf\">17.052</span><span class=\"w\"> </span><span class=\"n\">Melem</span><span class=\"o\">/</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"mf\">17.188</span><span class=\"w\"> </span><span class=\"n\">Melem</span><span class=\"o\">/</span><span class=\"n\">s</span><span class=\"p\">]</span>\n<span class=\"w\">                 </span><span class=\"n\">change</span><span class=\"p\">:</span>\n<span class=\"w\">                        </span><span class=\"nc\">time</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"p\">[</span><span class=\"o\">+</span><span class=\"mf\">43.064</span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"mf\">46.066</span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"mf\">49.080</span><span class=\"o\">%</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">0.00</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"mf\">0.05</span><span class=\"p\">)</span>\n<span class=\"w\">                        </span><span class=\"n\">thrpt</span><span class=\"p\">:</span><span class=\"w\">  </span><span class=\"p\">[</span><span class=\"err\">−</span><span class=\"mf\">32.922</span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"err\">−</span><span class=\"mf\">31.538</span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"err\">−</span><span class=\"mf\">30.101</span><span class=\"o\">%</span><span class=\"p\">]</span>\n<span class=\"w\">                        </span><span class=\"n\">Performance</span><span class=\"w\"> </span><span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">regressed</span><span class=\"p\">.</span>\n<span class=\"n\">Found</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"n\">outliers</span><span class=\"w\"> </span><span class=\"n\">among</span><span class=\"w\"> </span><span class=\"mi\">100</span><span class=\"w\"> </span><span class=\"n\">measurements</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mf\">7.00</span><span class=\"o\">%</span><span class=\"p\">)</span>\n<span class=\"w\">  </span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mf\">7.00</span><span class=\"o\">%</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">high</span><span class=\"w\"> </span><span class=\"n\">mild</span>\n<span class=\"n\">call</span><span class=\"o\">-</span><span class=\"n\">indirect</span><span class=\"o\">/</span><span class=\"n\">same</span><span class=\"o\">-</span><span class=\"n\">callee</span><span class=\"o\">/</span><span class=\"n\">table</span><span class=\"o\">-</span><span class=\"n\">init</span><span class=\"o\">-</span><span class=\"n\">strict</span><span class=\"o\">/</span><span class=\"mi\">65536</span><span class=\"o\">-</span><span class=\"n\">calls</span>\n<span class=\"w\">                        </span><span class=\"n\">time</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"p\">[</span><span class=\"mf\">130.27</span><span class=\"w\"> </span><span class=\"err\">µ</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"mf\">131.66</span><span class=\"w\"> </span><span class=\"err\">µ</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"mf\">133.40</span><span class=\"w\"> </span><span class=\"err\">µ</span><span class=\"n\">s</span><span class=\"p\">]</span>\n<span class=\"w\">                        </span><span class=\"n\">thrpt</span><span class=\"p\">:</span><span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mf\">491.26</span><span class=\"w\"> </span><span class=\"n\">Melem</span><span class=\"o\">/</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"mf\">497.75</span><span class=\"w\"> </span><span class=\"n\">Melem</span><span class=\"o\">/</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"mf\">503.09</span><span class=\"w\"> </span><span class=\"n\">Melem</span><span class=\"o\">/</span><span class=\"n\">s</span><span class=\"p\">]</span>\n<span class=\"w\">                 </span><span class=\"n\">change</span><span class=\"p\">:</span>\n<span class=\"w\">                        </span><span class=\"nc\">time</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"p\">[</span><span class=\"err\">−</span><span class=\"mf\">6.4798</span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"err\">−</span><span class=\"mf\">4.1871</span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"err\">−</span><span class=\"mf\">1.8965</span><span class=\"o\">%</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">0.00</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"mf\">0.05</span><span class=\"p\">)</span>\n<span class=\"w\">                        </span><span class=\"n\">thrpt</span><span class=\"p\">:</span><span class=\"w\">  </span><span class=\"p\">[</span><span class=\"o\">+</span><span class=\"mf\">1.9332</span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"mf\">4.3701</span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"mf\">6.9288</span><span class=\"o\">%</span><span class=\"p\">]</span>\n<span class=\"w\">                        </span><span class=\"n\">Performance</span><span class=\"w\"> </span><span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">improved</span><span class=\"p\">.</span>\n<span class=\"n\">Found</span><span class=\"w\"> </span><span class=\"mi\">12</span><span class=\"w\"> </span><span class=\"n\">outliers</span><span class=\"w\"> </span><span class=\"n\">among</span><span class=\"w\"> </span><span class=\"mi\">100</span><span class=\"w\"> </span><span class=\"n\">measurements</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mf\">12.00</span><span class=\"o\">%</span><span class=\"p\">)</span>\n<span class=\"w\">  </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mf\">4.00</span><span class=\"o\">%</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">high</span><span class=\"w\"> </span><span class=\"n\">mild</span>\n<span class=\"w\">  </span><span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mf\">8.00</span><span class=\"o\">%</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">high</span><span class=\"w\"> </span><span class=\"n\">severe</span>\n<span class=\"n\">call</span><span class=\"o\">-</span><span class=\"n\">indirect</span><span class=\"o\">/</span><span class=\"n\">different</span><span class=\"o\">-</span><span class=\"n\">callees</span><span class=\"o\">/</span><span class=\"n\">table</span><span class=\"o\">-</span><span class=\"n\">init</span><span class=\"o\">-</span><span class=\"n\">strict</span><span class=\"o\">/</span><span class=\"mi\">65536</span><span class=\"o\">-</span><span class=\"n\">calls</span>\n<span class=\"w\">                        </span><span class=\"n\">time</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"p\">[</span><span class=\"mf\">176.22</span><span class=\"w\"> </span><span class=\"err\">µ</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"mf\">178.49</span><span class=\"w\"> </span><span class=\"err\">µ</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"mf\">180.99</span><span class=\"w\"> </span><span class=\"err\">µ</span><span class=\"n\">s</span><span class=\"p\">]</span>\n<span class=\"w\">                        </span><span class=\"n\">thrpt</span><span class=\"p\">:</span><span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mf\">362.10</span><span class=\"w\"> </span><span class=\"n\">Melem</span><span class=\"o\">/</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"mf\">367.18</span><span class=\"w\"> </span><span class=\"n\">Melem</span><span class=\"o\">/</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"mf\">371.90</span><span class=\"w\"> </span><span class=\"n\">Melem</span><span class=\"o\">/</span><span class=\"n\">s</span><span class=\"p\">]</span>\n<span class=\"w\">                 </span><span class=\"n\">change</span><span class=\"p\">:</span>\n<span class=\"w\">                        </span><span class=\"nc\">time</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"p\">[</span><span class=\"err\">−</span><span class=\"mf\">18.431</span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"err\">−</span><span class=\"mf\">15.397</span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"err\">−</span><span class=\"mf\">12.330</span><span class=\"o\">%</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">0.00</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"mf\">0.05</span><span class=\"p\">)</span>\n<span class=\"w\">                        </span><span class=\"n\">thrpt</span><span class=\"p\">:</span><span class=\"w\">  </span><span class=\"p\">[</span><span class=\"o\">+</span><span class=\"mf\">14.064</span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"mf\">18.200</span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"mf\">22.595</span><span class=\"o\">%</span><span class=\"p\">]</span>\n<span class=\"w\">                        </span><span class=\"n\">Performance</span><span class=\"w\"> </span><span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">improved</span><span class=\"p\">.</span>\n<span class=\"n\">Found</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"n\">outliers</span><span class=\"w\"> </span><span class=\"n\">among</span><span class=\"w\"> </span><span class=\"mi\">100</span><span class=\"w\"> </span><span class=\"n\">measurements</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mf\">7.00</span><span class=\"o\">%</span><span class=\"p\">)</span>\n<span class=\"w\">  </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mf\">4.00</span><span class=\"o\">%</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">high</span><span class=\"w\"> </span><span class=\"n\">mild</span>\n<span class=\"w\">  </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mf\">3.00</span><span class=\"o\">%</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">high</span><span class=\"w\"> </span><span class=\"n\">severe</span>\n</code></pre></div>\n<p>&lt;/details&gt;</p>\n<p>&lt;!--<br>\nPlease make sure you include the following information:</p>\n<ul>\n<li>\n<p>If this work has been discussed elsewhere, please include a link to that<br>\n  conversation. If it was discussed in an issue, just mention \"issue #...\".</p>\n</li>\n<li>\n<p>Explain why this change is needed. If the details are in an issue already,<br>\n  this can be brief.</p>\n</li>\n</ul>\n<p>Our development process is documented in the Wasmtime book:<br>\n<a href=\"https://docs.wasmtime.dev/contributing-development-process.html\">https://docs.wasmtime.dev/contributing-development-process.html</a></p>\n<p>Please ensure all communication follows the code of conduct:<br>\n<a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md\">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>\n--&gt;</p>\n</blockquote>",
        "id": 537945314,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1757105410
    },
    {
        "content": "<p><strong>fitzgen</strong> requested <a href=\"https://github.com/cfallin\">cfallin</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11630\">PR #11630</a>.</p>",
        "id": 537945318,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1757105411
    },
    {
        "content": "<p><strong>fitzgen</strong> requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers\">wasmtime-compiler-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11630\">PR #11630</a>.</p>",
        "id": 537945320,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1757105412
    },
    {
        "content": "<p><strong>fitzgen</strong> requested <a href=\"https://github.com/alexcrichton\">alexcrichton</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11630\">PR #11630</a>.</p>",
        "id": 537945322,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1757105412
    },
    {
        "content": "<p><strong>fitzgen</strong> requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers\">wasmtime-core-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11630\">PR #11630</a>.</p>",
        "id": 537945323,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1757105412
    },
    {
        "content": "<p>fitzgen edited <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11630\">PR #11630</a>:</p>\n<blockquote>\n<p>This treats compiled functions homogeneously, removing the need to add new metadata tables to places like <code>CompiledModuleInfo</code> whenever we add a new kind of function, and simplifying the process of constructing the metadata for a final, linked compilation artifact. This also paves the way to doing gc-sections in our linking (getting smaller code sizes, removing functions that have been inlined into every caller, and etc...) as we no longer assume that certain types of function index spaces are dense.</p>\n<p>This does, however, replace a couple operations that were previously O(1) table lookups with O(log n) binary searches. And, notably, some of these are on the <code>VMFuncRef</code>-creation path, and therefore on the<br>\nforce-initialization-of-a-lazy-funcref-table-slot path, when we look up a Wasm function and its trampolines. Our call-indirect micro-benchmarks show that indirect calling every funcref once in a table of 64Ki slots went from taking ~2.6ms to ~3.8ms (a +46% slowdown). Note that this edge case is both synthetic and the worst-case scenario for this commit's change: we are measuring, as much as we can, <em>only</em> the force-initialization-of-a-lazy-funcref-table-slot path. All other call-indirect benchmarks are within the noise, which is what we would expect.</p>\n<p>Also, the size of <code>.cwasm</code>s is slightly larger: <code>spidermonkey.wasm</code>'s <code>.cwasm</code> size went from <code>19_750_632</code> bytes to <code>19_785_872</code> bytes, which is a 1.78% increase.</p>\n<p>Ultimately, I believe that the simplification and possibility of doing gc-sections in the future is worth the downsides. That said, if others feel differently, there are some things we could try to improve the situation, although most things I can think of off the top of my head (e.g. LEB128s and delta encoding, making certain <code>FuncKey</code> kinds' index spaces dense) will improve one of code size or lookup times while pessimizing the other. I'm sure we could come up with something given enough effort though.</p>\n<p>&lt;details&gt;</p>\n<p>&lt;summary&gt;call-indirect micro-benchmarks results&lt;/summary&gt;</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">call</span><span class=\"o\">-</span><span class=\"n\">indirect</span><span class=\"o\">/</span><span class=\"n\">same</span><span class=\"o\">-</span><span class=\"n\">callee</span><span class=\"o\">/</span><span class=\"n\">table</span><span class=\"o\">-</span><span class=\"n\">init</span><span class=\"o\">-</span><span class=\"n\">lazy</span><span class=\"o\">/</span><span class=\"mi\">65536</span><span class=\"o\">-</span><span class=\"n\">calls</span>\n<span class=\"w\">                        </span><span class=\"n\">time</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"p\">[</span><span class=\"mf\">144.14</span><span class=\"w\"> </span><span class=\"err\">µ</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"mf\">145.26</span><span class=\"w\"> </span><span class=\"err\">µ</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"mf\">146.56</span><span class=\"w\"> </span><span class=\"err\">µ</span><span class=\"n\">s</span><span class=\"p\">]</span>\n<span class=\"w\">                        </span><span class=\"n\">thrpt</span><span class=\"p\">:</span><span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mf\">447.15</span><span class=\"w\"> </span><span class=\"n\">Melem</span><span class=\"o\">/</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"mf\">451.15</span><span class=\"w\"> </span><span class=\"n\">Melem</span><span class=\"o\">/</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"mf\">454.68</span><span class=\"w\"> </span><span class=\"n\">Melem</span><span class=\"o\">/</span><span class=\"n\">s</span><span class=\"p\">]</span>\n<span class=\"w\">                 </span><span class=\"n\">change</span><span class=\"p\">:</span>\n<span class=\"w\">                        </span><span class=\"nc\">time</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"p\">[</span><span class=\"err\">−</span><span class=\"mf\">5.5066</span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"err\">−</span><span class=\"mf\">3.6611</span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"err\">−</span><span class=\"mf\">1.9130</span><span class=\"o\">%</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">0.00</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"mf\">0.05</span><span class=\"p\">)</span>\n<span class=\"w\">                        </span><span class=\"n\">thrpt</span><span class=\"p\">:</span><span class=\"w\">  </span><span class=\"p\">[</span><span class=\"o\">+</span><span class=\"mf\">1.9503</span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"mf\">3.8002</span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"mf\">5.8275</span><span class=\"o\">%</span><span class=\"p\">]</span>\n<span class=\"w\">                        </span><span class=\"n\">Performance</span><span class=\"w\"> </span><span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">improved</span><span class=\"p\">.</span>\n<span class=\"n\">Found</span><span class=\"w\"> </span><span class=\"mi\">9</span><span class=\"w\"> </span><span class=\"n\">outliers</span><span class=\"w\"> </span><span class=\"n\">among</span><span class=\"w\"> </span><span class=\"mi\">100</span><span class=\"w\"> </span><span class=\"n\">measurements</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mf\">9.00</span><span class=\"o\">%</span><span class=\"p\">)</span>\n<span class=\"w\">  </span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mf\">7.00</span><span class=\"o\">%</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">high</span><span class=\"w\"> </span><span class=\"n\">mild</span>\n<span class=\"w\">  </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mf\">2.00</span><span class=\"o\">%</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">high</span><span class=\"w\"> </span><span class=\"n\">severe</span>\n<span class=\"n\">call</span><span class=\"o\">-</span><span class=\"n\">indirect</span><span class=\"o\">/</span><span class=\"n\">different</span><span class=\"o\">-</span><span class=\"n\">callees</span><span class=\"o\">/</span><span class=\"n\">table</span><span class=\"o\">-</span><span class=\"n\">init</span><span class=\"o\">-</span><span class=\"n\">lazy</span><span class=\"o\">/</span><span class=\"mi\">65536</span><span class=\"o\">-</span><span class=\"n\">calls</span>\n<span class=\"w\">                        </span><span class=\"n\">time</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"p\">[</span><span class=\"mf\">3.8128</span><span class=\"w\"> </span><span class=\"n\">ms</span><span class=\"w\"> </span><span class=\"mf\">3.8433</span><span class=\"w\"> </span><span class=\"n\">ms</span><span class=\"w\"> </span><span class=\"mf\">3.8763</span><span class=\"w\"> </span><span class=\"n\">ms</span><span class=\"p\">]</span>\n<span class=\"w\">                        </span><span class=\"n\">thrpt</span><span class=\"p\">:</span><span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mf\">16.907</span><span class=\"w\"> </span><span class=\"n\">Melem</span><span class=\"o\">/</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"mf\">17.052</span><span class=\"w\"> </span><span class=\"n\">Melem</span><span class=\"o\">/</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"mf\">17.188</span><span class=\"w\"> </span><span class=\"n\">Melem</span><span class=\"o\">/</span><span class=\"n\">s</span><span class=\"p\">]</span>\n<span class=\"w\">                 </span><span class=\"n\">change</span><span class=\"p\">:</span>\n<span class=\"w\">                        </span><span class=\"nc\">time</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"p\">[</span><span class=\"o\">+</span><span class=\"mf\">43.064</span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"mf\">46.066</span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"mf\">49.080</span><span class=\"o\">%</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">0.00</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"mf\">0.05</span><span class=\"p\">)</span>\n<span class=\"w\">                        </span><span class=\"n\">thrpt</span><span class=\"p\">:</span><span class=\"w\">  </span><span class=\"p\">[</span><span class=\"err\">−</span><span class=\"mf\">32.922</span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"err\">−</span><span class=\"mf\">31.538</span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"err\">−</span><span class=\"mf\">30.101</span><span class=\"o\">%</span><span class=\"p\">]</span>\n<span class=\"w\">                        </span><span class=\"n\">Performance</span><span class=\"w\"> </span><span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">regressed</span><span class=\"p\">.</span>\n<span class=\"n\">Found</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"n\">outliers</span><span class=\"w\"> </span><span class=\"n\">among</span><span class=\"w\"> </span><span class=\"mi\">100</span><span class=\"w\"> </span><span class=\"n\">measurements</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mf\">7.00</span><span class=\"o\">%</span><span class=\"p\">)</span>\n<span class=\"w\">  </span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mf\">7.00</span><span class=\"o\">%</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">high</span><span class=\"w\"> </span><span class=\"n\">mild</span>\n<span class=\"n\">call</span><span class=\"o\">-</span><span class=\"n\">indirect</span><span class=\"o\">/</span><span class=\"n\">same</span><span class=\"o\">-</span><span class=\"n\">callee</span><span class=\"o\">/</span><span class=\"n\">table</span><span class=\"o\">-</span><span class=\"n\">init</span><span class=\"o\">-</span><span class=\"n\">strict</span><span class=\"o\">/</span><span class=\"mi\">65536</span><span class=\"o\">-</span><span class=\"n\">calls</span>\n<span class=\"w\">                        </span><span class=\"n\">time</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"p\">[</span><span class=\"mf\">130.27</span><span class=\"w\"> </span><span class=\"err\">µ</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"mf\">131.66</span><span class=\"w\"> </span><span class=\"err\">µ</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"mf\">133.40</span><span class=\"w\"> </span><span class=\"err\">µ</span><span class=\"n\">s</span><span class=\"p\">]</span>\n<span class=\"w\">                        </span><span class=\"n\">thrpt</span><span class=\"p\">:</span><span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mf\">491.26</span><span class=\"w\"> </span><span class=\"n\">Melem</span><span class=\"o\">/</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"mf\">497.75</span><span class=\"w\"> </span><span class=\"n\">Melem</span><span class=\"o\">/</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"mf\">503.09</span><span class=\"w\"> </span><span class=\"n\">Melem</span><span class=\"o\">/</span><span class=\"n\">s</span><span class=\"p\">]</span>\n<span class=\"w\">                 </span><span class=\"n\">change</span><span class=\"p\">:</span>\n<span class=\"w\">                        </span><span class=\"nc\">time</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"p\">[</span><span class=\"err\">−</span><span class=\"mf\">6.4798</span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"err\">−</span><span class=\"mf\">4.1871</span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"err\">−</span><span class=\"mf\">1.8965</span><span class=\"o\">%</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">0.00</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"mf\">0.05</span><span class=\"p\">)</span>\n<span class=\"w\">                        </span><span class=\"n\">thrpt</span><span class=\"p\">:</span><span class=\"w\">  </span><span class=\"p\">[</span><span class=\"o\">+</span><span class=\"mf\">1.9332</span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"mf\">4.3701</span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"mf\">6.9288</span><span class=\"o\">%</span><span class=\"p\">]</span>\n<span class=\"w\">                        </span><span class=\"n\">Performance</span><span class=\"w\"> </span><span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">improved</span><span class=\"p\">.</span>\n<span class=\"n\">Found</span><span class=\"w\"> </span><span class=\"mi\">12</span><span class=\"w\"> </span><span class=\"n\">outliers</span><span class=\"w\"> </span><span class=\"n\">among</span><span class=\"w\"> </span><span class=\"mi\">100</span><span class=\"w\"> </span><span class=\"n\">measurements</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mf\">12.00</span><span class=\"o\">%</span><span class=\"p\">)</span>\n<span class=\"w\">  </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mf\">4.00</span><span class=\"o\">%</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">high</span><span class=\"w\"> </span><span class=\"n\">mild</span>\n<span class=\"w\">  </span><span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mf\">8.00</span><span class=\"o\">%</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">high</span><span class=\"w\"> </span><span class=\"n\">severe</span>\n<span class=\"n\">call</span><span class=\"o\">-</span><span class=\"n\">indirect</span><span class=\"o\">/</span><span class=\"n\">different</span><span class=\"o\">-</span><span class=\"n\">callees</span><span class=\"o\">/</span><span class=\"n\">table</span><span class=\"o\">-</span><span class=\"n\">init</span><span class=\"o\">-</span><span class=\"n\">strict</span><span class=\"o\">/</span><span class=\"mi\">65536</span><span class=\"o\">-</span><span class=\"n\">calls</span>\n<span class=\"w\">                        </span><span class=\"n\">time</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"p\">[</span><span class=\"mf\">176.22</span><span class=\"w\"> </span><span class=\"err\">µ</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"mf\">178.49</span><span class=\"w\"> </span><span class=\"err\">µ</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"mf\">180.99</span><span class=\"w\"> </span><span class=\"err\">µ</span><span class=\"n\">s</span><span class=\"p\">]</span>\n<span class=\"w\">                        </span><span class=\"n\">thrpt</span><span class=\"p\">:</span><span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mf\">362.10</span><span class=\"w\"> </span><span class=\"n\">Melem</span><span class=\"o\">/</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"mf\">367.18</span><span class=\"w\"> </span><span class=\"n\">Melem</span><span class=\"o\">/</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"mf\">371.90</span><span class=\"w\"> </span><span class=\"n\">Melem</span><span class=\"o\">/</span><span class=\"n\">s</span><span class=\"p\">]</span>\n<span class=\"w\">                 </span><span class=\"n\">change</span><span class=\"p\">:</span>\n<span class=\"w\">                        </span><span class=\"nc\">time</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"p\">[</span><span class=\"err\">−</span><span class=\"mf\">18.431</span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"err\">−</span><span class=\"mf\">15.397</span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"err\">−</span><span class=\"mf\">12.330</span><span class=\"o\">%</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">0.00</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"mf\">0.05</span><span class=\"p\">)</span>\n<span class=\"w\">                        </span><span class=\"n\">thrpt</span><span class=\"p\">:</span><span class=\"w\">  </span><span class=\"p\">[</span><span class=\"o\">+</span><span class=\"mf\">14.064</span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"mf\">18.200</span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"mf\">22.595</span><span class=\"o\">%</span><span class=\"p\">]</span>\n<span class=\"w\">                        </span><span class=\"n\">Performance</span><span class=\"w\"> </span><span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">improved</span><span class=\"p\">.</span>\n<span class=\"n\">Found</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"n\">outliers</span><span class=\"w\"> </span><span class=\"n\">among</span><span class=\"w\"> </span><span class=\"mi\">100</span><span class=\"w\"> </span><span class=\"n\">measurements</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mf\">7.00</span><span class=\"o\">%</span><span class=\"p\">)</span>\n<span class=\"w\">  </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mf\">4.00</span><span class=\"o\">%</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">high</span><span class=\"w\"> </span><span class=\"n\">mild</span>\n<span class=\"w\">  </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mf\">3.00</span><span class=\"o\">%</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">high</span><span class=\"w\"> </span><span class=\"n\">severe</span>\n</code></pre></div>\n<p>&lt;/details&gt;</p>\n<p>&lt;!--<br>\nPlease make sure you include the following information:</p>\n<ul>\n<li>\n<p>If this work has been discussed elsewhere, please include a link to that<br>\n  conversation. If it was discussed in an issue, just mention \"issue #...\".</p>\n</li>\n<li>\n<p>Explain why this change is needed. If the details are in an issue already,<br>\n  this can be brief.</p>\n</li>\n</ul>\n<p>Our development process is documented in the Wasmtime book:<br>\n<a href=\"https://docs.wasmtime.dev/contributing-development-process.html\">https://docs.wasmtime.dev/contributing-development-process.html</a></p>\n<p>Please ensure all communication follows the code of conduct:<br>\n<a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md\">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>\n--&gt;</p>\n</blockquote>",
        "id": 537946164,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1757105784
    },
    {
        "content": "<p>fitzgen updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11630\">PR #11630</a>.</p>",
        "id": 537946651,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1757106009
    },
    {
        "content": "<p>fitzgen updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11630\">PR #11630</a>.</p>",
        "id": 537948009,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1757106659
    },
    {
        "content": "<p>github-actions[bot] <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11630#issuecomment-3259950762\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11630\">PR #11630</a>:</p>\n<blockquote>\n<h4>Subscribe to Label Action</h4>\n<p>cc @saulecabrera</p>\n<p>&lt;details&gt;<br>\nThis issue or pull request has been labeled: \"wasmtime:api\", \"winch\"</p>\n<p>Thus the following users have been cc'd because of the following labels:</p>\n<ul>\n<li>saulecabrera: winch</li>\n</ul>\n<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>\n<p><a href=\"https://github.com/bytecodealliance/subscribe-to-label-action\">Learn more.</a><br>\n&lt;/details&gt;</p>\n</blockquote>",
        "id": 537956404,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1757112299
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11630#discussion_r2331236705\">PR review comment</a>:</p>\n<blockquote>\n<p>Could this expand on what a <code>None</code> case means?</p>\n<p>(also if it's purely to be able to use <code>Module::default</code> I think it'd be ok to remove that construction method)</p>\n</blockquote>",
        "id": 538306652,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1757362058
    },
    {
        "content": "<p>alexcrichton submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11630#pullrequestreview-3197953050\">PR review</a>:</p>\n<blockquote>\n<p>Really nice how this turned out, thanks for pushing on this!</p>\n<p>One more benchmark though before merging I now realize -- component instantiation. IIRC we confirmed core wasm instantiation was largely unaffected by this but reading over this I'm remembering that component instantiation, when it hits various initializers for trampolines/builtins/etc, will do the <code>FuncKey</code> lookup now. Can you make a simple-ish <code>spidermonkey.wasm</code> component and compare before/after the instantiation numbers?</p>\n</blockquote>",
        "id": 538306653,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1757362058
    },
    {
        "content": "<p>fitzgen submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11630#pullrequestreview-3218772391\">PR review</a>.</p>",
        "id": 539160455,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1757709984
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11630#discussion_r2345400744\">PR review comment</a>:</p>\n<blockquote>\n<p>Addressed in <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11694\">https://github.com/bytecodealliance/wasmtime/pull/11694</a></p>\n</blockquote>",
        "id": 539160456,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1757709985
    },
    {
        "content": "<p>fitzgen updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11630\">PR #11630</a>.</p>",
        "id": 539635248,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1757965107
    },
    {
        "content": "<p>fitzgen <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11630#issuecomment-3293663797\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11630\">PR #11630</a>:</p>\n<blockquote>\n<p>@alexcrichton mind taking another look at this? Redid a bunch of stuff so that there is actually a (very small) code size improvement now, the various index spaces have nice newtypes, and lookups into dense index spaces are O(1) again.</p>\n</blockquote>",
        "id": 539635431,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1757965173
    },
    {
        "content": "<p>fitzgen edited <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11630\">PR #11630</a>:</p>\n<blockquote>\n<p>This commit refactors our metadata, treating compiled functions homogeneously<br>\nand removing the need to add new tables to places like <code>CompiledModuleInfo</code><br>\nwhenever we add a new kind of function. This also simplifies the process of<br>\nconstructing the metadata for a final, linked compilation artifact. Finally, it<br>\npaves the way to doing gc-sections during our linking process (which would give<br>\nus smaller code sizes by removing functions that have been inlined into every<br>\ncaller, for example) as we now allow holes in certain types of function index<br>\nspaces that were previously always densely populated.</p>\n<p>We have two kinds of index spaces:</p>\n<ol>\n<li>\n<p>Mostly-dense index spaces, which take O(max_index) space and provide O(1)<br>\nlookups.</p>\n</li>\n<li>\n<p>Sparse index spaces, which take O(num_members) space and provide<br>\nO(log n) lookups.</p>\n</li>\n</ol>\n<p>Most of our function index spaces are currently dense, but we can tweak that in<br>\nthe future if necessary.</p>\n<p>Furthermore, code size of <code>.cwasm</code> binaries has shrunk very slightly with this<br>\nrefactoring. Consider <code>spidermonkey.wasm</code>'s compiled <code>.cwasm</code>:</p>\n<ul>\n<li>Size before: 218756 <code>.wasmtime.info</code> section bytes, 20052632 total bytes</li>\n<li>Size after: 213761 <code>.wasmtime.info</code> section bytes, 20047640 total bytes</li>\n</ul>\n<p>That is a 2.28% reduction on the size of the <code>.wasmtime.info</code> section, or a<br>\n0.025% reduction total.</p>\n<p>However, we previously did a single metadata lookup to get the location of both<br>\na Wasm function itself and its array-to-Wasm trampoline at the same time, and in<br>\nthe new version of the code two lookups are performed. This is slightly slower,<br>\nas shown in our call-indirect micro-benchmark that combines lazy table<br>\ninitialization (which delays looking up the function element's location until<br>\nruntime) with indirect-calling each table element exactly once (which defeats<br>\nthe amortization of that lookup). So this micro-benchmark is both synthetic and<br>\nthe worst-case scenario for this commit's change: we are measuring, as much as<br>\nwe can, <em>only</em> the force-initialization-of-a-lazy-funcref-table-slot path.</p>\n<p>Ultimately, I believe that the simplification is worth the regression in this<br>\nmicro-benchmark.</p>\n<p>&lt;details&gt;</p>\n<p>&lt;summary&gt;call-indirect micro-benchmarks results&lt;/summary&gt;</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">call</span><span class=\"o\">-</span><span class=\"n\">indirect</span><span class=\"o\">/</span><span class=\"n\">same</span><span class=\"o\">-</span><span class=\"n\">callee</span><span class=\"o\">/</span><span class=\"n\">table</span><span class=\"o\">-</span><span class=\"n\">init</span><span class=\"o\">-</span><span class=\"n\">lazy</span><span class=\"o\">/</span><span class=\"mi\">65536</span><span class=\"o\">-</span><span class=\"n\">calls</span>\n<span class=\"w\">                        </span><span class=\"n\">time</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"p\">[</span><span class=\"mf\">152.77</span><span class=\"w\"> </span><span class=\"err\">µ</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"mf\">154.92</span><span class=\"w\"> </span><span class=\"err\">µ</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"mf\">157.39</span><span class=\"w\"> </span><span class=\"err\">µ</span><span class=\"n\">s</span><span class=\"p\">]</span>\n<span class=\"w\">                        </span><span class=\"n\">thrpt</span><span class=\"p\">:</span><span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mf\">416.40</span><span class=\"w\"> </span><span class=\"n\">Melem</span><span class=\"o\">/</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"mf\">423.04</span><span class=\"w\"> </span><span class=\"n\">Melem</span><span class=\"o\">/</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"mf\">428.99</span><span class=\"w\"> </span><span class=\"n\">Melem</span><span class=\"o\">/</span><span class=\"n\">s</span><span class=\"p\">]</span>\n<span class=\"w\">                 </span><span class=\"n\">change</span><span class=\"p\">:</span>\n<span class=\"w\">                        </span><span class=\"nc\">time</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"p\">[</span><span class=\"err\">−</span><span class=\"mf\">13.749</span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"err\">−</span><span class=\"mf\">10.205</span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"err\">−</span><span class=\"mf\">6.2864</span><span class=\"o\">%</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">0.00</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"mf\">0.05</span><span class=\"p\">)</span>\n<span class=\"w\">                        </span><span class=\"n\">thrpt</span><span class=\"p\">:</span><span class=\"w\">  </span><span class=\"p\">[</span><span class=\"o\">+</span><span class=\"mf\">6.7081</span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"mf\">11.365</span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"mf\">15.941</span><span class=\"o\">%</span><span class=\"p\">]</span>\n<span class=\"w\">                        </span><span class=\"n\">Performance</span><span class=\"w\"> </span><span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">improved</span><span class=\"p\">.</span>\n<span class=\"n\">Found</span><span class=\"w\"> </span><span class=\"mi\">13</span><span class=\"w\"> </span><span class=\"n\">outliers</span><span class=\"w\"> </span><span class=\"n\">among</span><span class=\"w\"> </span><span class=\"mi\">100</span><span class=\"w\"> </span><span class=\"n\">measurements</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mf\">13.00</span><span class=\"o\">%</span><span class=\"p\">)</span>\n<span class=\"w\">  </span><span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mf\">8.00</span><span class=\"o\">%</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">high</span><span class=\"w\"> </span><span class=\"n\">mild</span>\n<span class=\"w\">  </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mf\">5.00</span><span class=\"o\">%</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">high</span><span class=\"w\"> </span><span class=\"n\">severe</span>\n<span class=\"n\">call</span><span class=\"o\">-</span><span class=\"n\">indirect</span><span class=\"o\">/</span><span class=\"n\">different</span><span class=\"o\">-</span><span class=\"n\">callees</span><span class=\"o\">/</span><span class=\"n\">table</span><span class=\"o\">-</span><span class=\"n\">init</span><span class=\"o\">-</span><span class=\"n\">lazy</span><span class=\"o\">/</span><span class=\"mi\">65536</span><span class=\"o\">-</span><span class=\"n\">calls</span>\n<span class=\"w\">                        </span><span class=\"n\">time</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"p\">[</span><span class=\"mf\">4.3564</span><span class=\"w\"> </span><span class=\"n\">ms</span><span class=\"w\"> </span><span class=\"mf\">4.4641</span><span class=\"w\"> </span><span class=\"n\">ms</span><span class=\"w\"> </span><span class=\"mf\">4.5843</span><span class=\"w\"> </span><span class=\"n\">ms</span><span class=\"p\">]</span>\n<span class=\"w\">                        </span><span class=\"n\">thrpt</span><span class=\"p\">:</span><span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mf\">14.296</span><span class=\"w\"> </span><span class=\"n\">Melem</span><span class=\"o\">/</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"mf\">14.681</span><span class=\"w\"> </span><span class=\"n\">Melem</span><span class=\"o\">/</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"mf\">15.044</span><span class=\"w\"> </span><span class=\"n\">Melem</span><span class=\"o\">/</span><span class=\"n\">s</span><span class=\"p\">]</span>\n<span class=\"w\">                 </span><span class=\"n\">change</span><span class=\"p\">:</span>\n<span class=\"w\">                        </span><span class=\"nc\">time</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"p\">[</span><span class=\"o\">+</span><span class=\"mf\">38.134</span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"mf\">44.404</span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"mf\">50.927</span><span class=\"o\">%</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">0.00</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"mf\">0.05</span><span class=\"p\">)</span>\n<span class=\"w\">                        </span><span class=\"n\">thrpt</span><span class=\"p\">:</span><span class=\"w\">  </span><span class=\"p\">[</span><span class=\"err\">−</span><span class=\"mf\">33.743</span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"err\">−</span><span class=\"mf\">30.750</span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"err\">−</span><span class=\"mf\">27.606</span><span class=\"o\">%</span><span class=\"p\">]</span>\n<span class=\"w\">                        </span><span class=\"n\">Performance</span><span class=\"w\"> </span><span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">regressed</span><span class=\"p\">.</span>\n<span class=\"n\">Found</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"n\">outliers</span><span class=\"w\"> </span><span class=\"n\">among</span><span class=\"w\"> </span><span class=\"mi\">100</span><span class=\"w\"> </span><span class=\"n\">measurements</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mf\">5.00</span><span class=\"o\">%</span><span class=\"p\">)</span>\n<span class=\"w\">  </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mf\">2.00</span><span class=\"o\">%</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">high</span><span class=\"w\"> </span><span class=\"n\">mild</span>\n<span class=\"w\">  </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mf\">3.00</span><span class=\"o\">%</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">high</span><span class=\"w\"> </span><span class=\"n\">severe</span>\n<span class=\"n\">call</span><span class=\"o\">-</span><span class=\"n\">indirect</span><span class=\"o\">/</span><span class=\"n\">same</span><span class=\"o\">-</span><span class=\"n\">callee</span><span class=\"o\">/</span><span class=\"n\">table</span><span class=\"o\">-</span><span class=\"n\">init</span><span class=\"o\">-</span><span class=\"n\">strict</span><span class=\"o\">/</span><span class=\"mi\">65536</span><span class=\"o\">-</span><span class=\"n\">calls</span>\n<span class=\"w\">                        </span><span class=\"n\">time</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"p\">[</span><span class=\"mf\">144.91</span><span class=\"w\"> </span><span class=\"err\">µ</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"mf\">148.41</span><span class=\"w\"> </span><span class=\"err\">µ</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"mf\">152.02</span><span class=\"w\"> </span><span class=\"err\">µ</span><span class=\"n\">s</span><span class=\"p\">]</span>\n<span class=\"w\">                        </span><span class=\"n\">thrpt</span><span class=\"p\">:</span><span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mf\">431.10</span><span class=\"w\"> </span><span class=\"n\">Melem</span><span class=\"o\">/</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"mf\">441.58</span><span class=\"w\"> </span><span class=\"n\">Melem</span><span class=\"o\">/</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"mf\">452.24</span><span class=\"w\"> </span><span class=\"n\">Melem</span><span class=\"o\">/</span><span class=\"n\">s</span><span class=\"p\">]</span>\n<span class=\"w\">                 </span><span class=\"n\">change</span><span class=\"p\">:</span>\n<span class=\"w\">                        </span><span class=\"nc\">time</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"p\">[</span><span class=\"err\">−</span><span class=\"mf\">13.665</span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"err\">−</span><span class=\"mf\">10.470</span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"err\">−</span><span class=\"mf\">7.2626</span><span class=\"o\">%</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">0.00</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"mf\">0.05</span><span class=\"p\">)</span>\n<span class=\"w\">                        </span><span class=\"n\">thrpt</span><span class=\"p\">:</span><span class=\"w\">  </span><span class=\"p\">[</span><span class=\"o\">+</span><span class=\"mf\">7.8313</span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"mf\">11.694</span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"mf\">15.828</span><span class=\"o\">%</span><span class=\"p\">]</span>\n<span class=\"w\">                        </span><span class=\"n\">Performance</span><span class=\"w\"> </span><span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">improved</span><span class=\"p\">.</span>\n<span class=\"n\">Found</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"n\">outliers</span><span class=\"w\"> </span><span class=\"n\">among</span><span class=\"w\"> </span><span class=\"mi\">100</span><span class=\"w\"> </span><span class=\"n\">measurements</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mf\">4.00</span><span class=\"o\">%</span><span class=\"p\">)</span>\n<span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mf\">1.00</span><span class=\"o\">%</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">high</span><span class=\"w\"> </span><span class=\"n\">mild</span>\n<span class=\"w\">  </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mf\">3.00</span><span class=\"o\">%</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">high</span><span class=\"w\"> </span><span class=\"n\">severe</span>\n<span class=\"n\">call</span><span class=\"o\">-</span><span class=\"n\">indirect</span><span class=\"o\">/</span><span class=\"n\">different</span><span class=\"o\">-</span><span class=\"n\">callees</span><span class=\"o\">/</span><span class=\"n\">table</span><span class=\"o\">-</span><span class=\"n\">init</span><span class=\"o\">-</span><span class=\"n\">strict</span><span class=\"o\">/</span><span class=\"mi\">65536</span><span class=\"o\">-</span><span class=\"n\">calls</span>\n<span class=\"w\">                        </span><span class=\"n\">time</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"p\">[</span><span class=\"mf\">195.18</span><span class=\"w\"> </span><span class=\"err\">µ</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"mf\">200.67</span><span class=\"w\"> </span><span class=\"err\">µ</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"mf\">206.49</span><span class=\"w\"> </span><span class=\"err\">µ</span><span class=\"n\">s</span><span class=\"p\">]</span>\n<span class=\"w\">                        </span><span class=\"n\">thrpt</span><span class=\"p\">:</span><span class=\"w\">  </span><span class=\"p\">[</span><span class=\"mf\">317.38</span><span class=\"w\"> </span><span class=\"n\">Melem</span><span class=\"o\">/</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"mf\">326.59</span><span class=\"w\"> </span><span class=\"n\">Melem</span><span class=\"o\">/</span><span class=\"n\">s</span><span class=\"w\"> </span><span class=\"mf\">335.77</span><span class=\"w\"> </span><span class=\"n\">Melem</span><span class=\"o\">/</span><span class=\"n\">s</span><span class=\"p\">]</span>\n<span class=\"w\">                 </span><span class=\"n\">change</span><span class=\"p\">:</span>\n<span class=\"w\">                        </span><span class=\"nc\">time</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"p\">[</span><span class=\"err\">−</span><span class=\"mf\">15.936</span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"err\">−</span><span class=\"mf\">11.568</span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"err\">−</span><span class=\"mf\">7.0835</span><span class=\"o\">%</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mf\">0.00</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"mf\">0.05</span><span class=\"p\">)</span>\n<span class=\"w\">                        </span><span class=\"n\">thrpt</span><span class=\"p\">:</span><span class=\"w\">  </span><span class=\"p\">[</span><span class=\"o\">+</span><span class=\"mf\">7.6235</span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"mf\">13.081</span><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"o\">+</span><span class=\"mf\">18.957</span><span class=\"o\">%</span><span class=\"p\">]</span>\n<span class=\"w\">                        </span><span class=\"n\">Performance</span><span class=\"w\"> </span><span class=\"n\">has</span><span class=\"w\"> </span><span class=\"n\">improved</span><span class=\"p\">.</span>\n<span class=\"n\">Found</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"n\">outliers</span><span class=\"w\"> </span><span class=\"n\">among</span><span class=\"w\"> </span><span class=\"mi\">100</span><span class=\"w\"> </span><span class=\"n\">measurements</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mf\">5.00</span><span class=\"o\">%</span><span class=\"p\">)</span>\n<span class=\"w\">  </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mf\">5.00</span><span class=\"o\">%</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">high</span><span class=\"w\"> </span><span class=\"n\">mild</span>\n</code></pre></div>\n</blockquote>",
        "id": 539635544,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1757965206
    },
    {
        "content": "<p>alexcrichton submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11630#pullrequestreview-3226453152\">PR review</a>.</p>",
        "id": 539653312,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1757973614
    },
    {
        "content": "<p>fitzgen merged <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11630\">PR #11630</a>.</p>",
        "id": 539658773,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1757977176
    }
]
[
    {
        "content": "<p>zzjas opened <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12354\">issue #12354</a>:</p>\n<blockquote>\n<h3>Test Case</h3>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"p\">(</span><span class=\"n\">assert_trap</span>\n<span class=\"w\">  </span><span class=\"p\">(</span><span class=\"n\">component</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"k\">type</span><span class=\"w\"> </span><span class=\"cp\">$enum</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">enum</span><span class=\"w\"> </span><span class=\"s\">\"case0\"</span><span class=\"w\"> </span><span class=\"s\">\"case1\"</span><span class=\"w\"> </span><span class=\"s\">\"case2\"</span><span class=\"p\">))</span>\n\n<span class=\"w\">    </span><span class=\"p\">;;</span><span class=\"w\"> </span><span class=\"n\">Returns</span><span class=\"w\"> </span><span class=\"n\">invalid</span><span class=\"w\"> </span><span class=\"n\">discriminant</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">valid</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">-</span><span class=\"mi\">2</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"n\">component</span><span class=\"w\"> </span><span class=\"cp\">$producer</span>\n<span class=\"w\">      </span><span class=\"p\">(</span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"s\">\"enum\"</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">type</span><span class=\"w\"> </span><span class=\"cp\">$enum</span><span class=\"o\">'</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">eq</span><span class=\"w\"> </span><span class=\"cp\">$enum</span><span class=\"p\">)))</span>\n<span class=\"w\">      </span><span class=\"p\">(</span><span class=\"n\">core</span><span class=\"w\"> </span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"cp\">$core</span>\n<span class=\"w\">        </span><span class=\"p\">(</span><span class=\"n\">func</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">export</span><span class=\"w\"> </span><span class=\"s\">\"get\"</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">i32</span><span class=\"p\">.</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"p\">)))</span>\n<span class=\"w\">      </span><span class=\"p\">(</span><span class=\"n\">core</span><span class=\"w\"> </span><span class=\"n\">instance</span><span class=\"w\"> </span><span class=\"cp\">$inst</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">instantiate</span><span class=\"w\"> </span><span class=\"cp\">$core</span><span class=\"p\">))</span>\n<span class=\"w\">      </span><span class=\"p\">(</span><span class=\"n\">func</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">export</span><span class=\"w\"> </span><span class=\"s\">\"get\"</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"cp\">$enum</span><span class=\"o\">'</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">canon</span><span class=\"w\"> </span><span class=\"n\">lift</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">core</span><span class=\"w\"> </span><span class=\"n\">func</span><span class=\"w\"> </span><span class=\"cp\">$inst</span><span class=\"w\"> </span><span class=\"s\">\"get\"</span><span class=\"p\">))))</span>\n\n<span class=\"w\">    </span><span class=\"p\">;;</span><span class=\"w\"> </span><span class=\"n\">Calls</span><span class=\"w\"> </span><span class=\"n\">producer</span><span class=\"w\"> </span><span class=\"n\">through</span><span class=\"w\"> </span><span class=\"n\">adapter</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">validation</span><span class=\"w\"> </span><span class=\"n\">should</span><span class=\"w\"> </span><span class=\"n\">trap</span><span class=\"w\"> </span><span class=\"n\">here</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"n\">component</span><span class=\"w\"> </span><span class=\"cp\">$consumer</span>\n<span class=\"w\">      </span><span class=\"p\">(</span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"s\">\"enum\"</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">type</span><span class=\"w\"> </span><span class=\"cp\">$enum</span><span class=\"o\">'</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">eq</span><span class=\"w\"> </span><span class=\"cp\">$enum</span><span class=\"p\">)))</span>\n<span class=\"w\">      </span><span class=\"p\">(</span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"s\">\"get\"</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">func</span><span class=\"w\"> </span><span class=\"cp\">$get</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"cp\">$enum</span><span class=\"o\">'</span><span class=\"p\">)))</span>\n<span class=\"w\">      </span><span class=\"p\">(</span><span class=\"n\">core</span><span class=\"w\"> </span><span class=\"n\">func</span><span class=\"w\"> </span><span class=\"cp\">$lowered</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">canon</span><span class=\"w\"> </span><span class=\"n\">lower</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">func</span><span class=\"w\"> </span><span class=\"cp\">$get</span><span class=\"p\">)))</span>\n<span class=\"w\">      </span><span class=\"p\">(</span><span class=\"n\">core</span><span class=\"w\"> </span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"cp\">$core</span>\n<span class=\"w\">        </span><span class=\"p\">(</span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"s\">\"\"</span><span class=\"w\"> </span><span class=\"s\">\"get\"</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">func</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">)))</span>\n<span class=\"w\">        </span><span class=\"p\">(</span><span class=\"n\">func</span><span class=\"w\"> </span><span class=\"cp\">$start</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">call</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"nb\">drop</span><span class=\"p\">)</span>\n<span class=\"w\">        </span><span class=\"p\">(</span><span class=\"n\">start</span><span class=\"w\"> </span><span class=\"cp\">$start</span><span class=\"p\">))</span>\n<span class=\"w\">      </span><span class=\"p\">(</span><span class=\"n\">core</span><span class=\"w\"> </span><span class=\"n\">instance</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">instantiate</span><span class=\"w\"> </span><span class=\"cp\">$core</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">with</span><span class=\"w\"> </span><span class=\"s\">\"\"</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">export</span><span class=\"w\"> </span><span class=\"s\">\"get\"</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">func</span><span class=\"w\"> </span><span class=\"cp\">$lowered</span><span class=\"p\">)))))))</span>\n\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"w\"> </span><span class=\"cp\">$prod</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">instantiate</span><span class=\"w\"> </span><span class=\"cp\">$producer</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">with</span><span class=\"w\"> </span><span class=\"s\">\"enum\"</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">type</span><span class=\"w\"> </span><span class=\"cp\">$enum</span><span class=\"p\">))))</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">instantiate</span><span class=\"w\"> </span><span class=\"cp\">$consumer</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">with</span><span class=\"w\"> </span><span class=\"s\">\"enum\"</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">type</span><span class=\"w\"> </span><span class=\"cp\">$enum</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">with</span><span class=\"w\"> </span><span class=\"s\">\"get\"</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">func</span><span class=\"w\"> </span><span class=\"cp\">$prod</span><span class=\"w\"> </span><span class=\"s\">\"get\"</span><span class=\"p\">)))))</span>\n<span class=\"w\">  </span><span class=\"s\">\"invalid variant discriminant\"</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>Here the line <code>(func (export \"get\") (result $enum') (canon lift (core func $inst \"get\")))</code> tries to lift the <code>$inst.\"get\"</code> (which returns the invalid discriminant) into a component function returning the enum with 3 variants.</p>\n<h3>Steps to Reproduce</h3>\n<p>Save the wast test somewhere (e.g. <code>tests/misc_testsuite/component-model/enum-discriminant-bug.wast</code>) and run</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"o\">-</span><span class=\"n\">cli</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"n\">wast</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"w\"> </span><span class=\"k\">enum</span><span class=\"o\">-</span><span class=\"n\">discriminant</span><span class=\"o\">-</span><span class=\"n\">bug</span>\n</code></pre></div>\n<p>will give:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">Caused</span><span class=\"w\"> </span><span class=\"n\">by</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"mi\">0</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">directive</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">tests</span><span class=\"o\">/</span><span class=\"n\">misc_testsuite</span><span class=\"o\">/</span><span class=\"n\">component</span><span class=\"o\">-</span><span class=\"n\">model</span><span class=\"o\">/</span><span class=\"k\">enum</span><span class=\"o\">-</span><span class=\"n\">discriminant</span><span class=\"o\">-</span><span class=\"n\">bug</span><span class=\"p\">.</span><span class=\"n\">wast</span><span class=\"p\">:</span><span class=\"mi\">2</span>\n<span class=\"w\">    </span><span class=\"mi\">1</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">expected</span><span class=\"w\"> </span><span class=\"n\">trap</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">got</span><span class=\"w\"> </span><span class=\"n\">Component</span><span class=\"p\">([])</span>\n</code></pre></div>\n<h3>Expected Results</h3>\n<p>3 is an invalid discriminant so it should be trapped and pass the assertion.</p>\n<h3>Actual Results</h3>\n<p>Not trapped and failed the assertion.</p>\n<h3>Versions and Environment</h3>\n<p>Wasmtime version or commit: 2e23e223c03543ee81344353e2d6418c0f3de47c</p>\n<h3>Extra Info</h3>\n<p>The discriminant check should have used <code>I32GeU</code> at line 3045:<br>\n<a href=\"https://github.com/bytecodealliance/wasmtime/blob/b856261dde3ea2624511fe4f48c3ed0790ddaa61/crates/environ/src/fact/trampoline.rs#L3043-L3048\">https://github.com/bytecodealliance/wasmtime/blob/b856261dde3ea2624511fe4f48c3ed0790ddaa61/crates/environ/src/fact/trampoline.rs#L3043-L3048</a></p>\n<p>I believe this doesn't enable any memory safety issues since other lifting locations have correct checks:<br>\n<a href=\"https://github.com/bytecodealliance/wasmtime/blob/b856261dde3ea2624511fe4f48c3ed0790ddaa61/crates/component-macro/src/component.rs#L653-L655\">https://github.com/bytecodealliance/wasmtime/blob/b856261dde3ea2624511fe4f48c3ed0790ddaa61/crates/component-macro/src/component.rs#L653-L655</a><br>\n<a href=\"https://github.com/bytecodealliance/wasmtime/blob/b856261dde3ea2624511fe4f48c3ed0790ddaa61/crates/wasmtime/src/runtime/component/values.rs#L994-L996\">https://github.com/bytecodealliance/wasmtime/blob/b856261dde3ea2624511fe4f48c3ed0790ddaa61/crates/wasmtime/src/runtime/component/values.rs#L994-L996</a></p>\n<p>Thanks for looking into this! And as before, happy to submit a PR to fix if it's indeed a bug and the test looks ok.</p>\n</blockquote>",
        "id": 568113008,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768442135
    },
    {
        "content": "<p><a href=\"https://github.com/zzjas\">zzjas</a> added the bug label to <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12354\">Issue #12354</a>.</p>",
        "id": 568113010,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768442136
    },
    {
        "content": "<p>pchickey assigned alexcrichton to <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12354\">issue #12354</a>.</p>",
        "id": 568114114,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768443077
    },
    {
        "content": "<p>pchickey <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12354#issuecomment-3752551767\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12354\">issue #12354</a>:</p>\n<blockquote>\n<p>Thanks for a really high quality bug report! I appreciate that you checked that this was not a memory safety issue before filing a public bug report, if you do discover those please do follow our security policy: <a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/SECURITY.md\">https://github.com/bytecodealliance/wasmtime/blob/main/SECURITY.md</a></p>\n<p>I agree with your assessment of the bug but Alex knows this code better than anyone so I want his eyes on it too. Its a 1 character fix so you are welcome to send the PR or else one of us can make it trivially.<br>\n</p>\n</blockquote>",
        "id": 568114244,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768443219
    },
    {
        "content": "<p>pchickey edited a <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12354#issuecomment-3752551767\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12354\">issue #12354</a>:</p>\n<blockquote>\n<p>Thanks for a really high quality bug report! I appreciate that you checked that this was not a memory safety issue before filing a public bug report, if you do discover those please do follow our security policy: <a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/SECURITY.md\">https://github.com/bytecodealliance/wasmtime/blob/main/SECURITY.md</a></p>\n<p>I agree with your assessment of the bug but Alex knows this code better than anyone so I want his eyes on it too. Its a 1 character fix so you are welcome to send the PR or else one of us can make it trivially.</p>\n<p>Just curious, did you find this \"manually\" or did you use any tools to assist discovering this? If you did use tools that we might want to consider adding to our regular fuzzing or CI process, please talk to us about that on <a href=\"https://bytecodealliance.zulipchat.com/\">https://bytecodealliance.zulipchat.com/</a></p>\n</blockquote>",
        "id": 568114341,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768443317
    },
    {
        "content": "<p>pchickey edited a <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12354#issuecomment-3752551767\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12354\">issue #12354</a>:</p>\n<blockquote>\n<p>Thanks for a really high quality bug report! I appreciate that you checked that this was not a memory safety issue before filing a public bug report, if you do discover those please do follow our security policy: <a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/SECURITY.md\">https://github.com/bytecodealliance/wasmtime/blob/main/SECURITY.md</a></p>\n<p>I agree with your assessment of the bug but Alex knows this code better than anyone so I want his eyes on it too. Its a 1 character fix (plus the nice regression test you wrote) so you are welcome to send the PR or else one of us can make it trivially.</p>\n<p>Just curious, did you find this \"manually\" or did you use any tools to assist discovering this? If you did use tools that we might want to consider adding to our regular fuzzing or CI process, please talk to us about that on <a href=\"https://bytecodealliance.zulipchat.com/\">https://bytecodealliance.zulipchat.com/</a></p>\n</blockquote>",
        "id": 568114384,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768443364
    },
    {
        "content": "<p>zzjas <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12354#issuecomment-3752665174\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12354\">issue #12354</a>:</p>\n<blockquote>\n<p>Thanks for looking into the report! I created a PR for it.</p>\n<p>I did use automated tools to discover this bug (and a few others that I reported recently). Now the tool is still in its very early development phase. Hopefully we will make it public in a few weeks and I'd love to share the tool with you folks then!</p>\n</blockquote>",
        "id": 568117014,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768445823
    },
    {
        "content": "<p>alexcrichton closed <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12354\">issue #12354</a>:</p>\n<blockquote>\n<h3>Test Case</h3>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"p\">(</span><span class=\"n\">assert_trap</span>\n<span class=\"w\">  </span><span class=\"p\">(</span><span class=\"n\">component</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"k\">type</span><span class=\"w\"> </span><span class=\"cp\">$enum</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">enum</span><span class=\"w\"> </span><span class=\"s\">\"case0\"</span><span class=\"w\"> </span><span class=\"s\">\"case1\"</span><span class=\"w\"> </span><span class=\"s\">\"case2\"</span><span class=\"p\">))</span>\n\n<span class=\"w\">    </span><span class=\"p\">;;</span><span class=\"w\"> </span><span class=\"n\">Returns</span><span class=\"w\"> </span><span class=\"n\">invalid</span><span class=\"w\"> </span><span class=\"n\">discriminant</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">valid</span><span class=\"w\"> </span><span class=\"n\">range</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">-</span><span class=\"mi\">2</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"n\">component</span><span class=\"w\"> </span><span class=\"cp\">$producer</span>\n<span class=\"w\">      </span><span class=\"p\">(</span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"s\">\"enum\"</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">type</span><span class=\"w\"> </span><span class=\"cp\">$enum</span><span class=\"o\">'</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">eq</span><span class=\"w\"> </span><span class=\"cp\">$enum</span><span class=\"p\">)))</span>\n<span class=\"w\">      </span><span class=\"p\">(</span><span class=\"n\">core</span><span class=\"w\"> </span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"cp\">$core</span>\n<span class=\"w\">        </span><span class=\"p\">(</span><span class=\"n\">func</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">export</span><span class=\"w\"> </span><span class=\"s\">\"get\"</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"kt\">i32</span><span class=\"p\">.</span><span class=\"k\">const</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"p\">)))</span>\n<span class=\"w\">      </span><span class=\"p\">(</span><span class=\"n\">core</span><span class=\"w\"> </span><span class=\"n\">instance</span><span class=\"w\"> </span><span class=\"cp\">$inst</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">instantiate</span><span class=\"w\"> </span><span class=\"cp\">$core</span><span class=\"p\">))</span>\n<span class=\"w\">      </span><span class=\"p\">(</span><span class=\"n\">func</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">export</span><span class=\"w\"> </span><span class=\"s\">\"get\"</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"cp\">$enum</span><span class=\"o\">'</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">canon</span><span class=\"w\"> </span><span class=\"n\">lift</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">core</span><span class=\"w\"> </span><span class=\"n\">func</span><span class=\"w\"> </span><span class=\"cp\">$inst</span><span class=\"w\"> </span><span class=\"s\">\"get\"</span><span class=\"p\">))))</span>\n\n<span class=\"w\">    </span><span class=\"p\">;;</span><span class=\"w\"> </span><span class=\"n\">Calls</span><span class=\"w\"> </span><span class=\"n\">producer</span><span class=\"w\"> </span><span class=\"n\">through</span><span class=\"w\"> </span><span class=\"n\">adapter</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">validation</span><span class=\"w\"> </span><span class=\"n\">should</span><span class=\"w\"> </span><span class=\"n\">trap</span><span class=\"w\"> </span><span class=\"n\">here</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"n\">component</span><span class=\"w\"> </span><span class=\"cp\">$consumer</span>\n<span class=\"w\">      </span><span class=\"p\">(</span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"s\">\"enum\"</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">type</span><span class=\"w\"> </span><span class=\"cp\">$enum</span><span class=\"o\">'</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">eq</span><span class=\"w\"> </span><span class=\"cp\">$enum</span><span class=\"p\">)))</span>\n<span class=\"w\">      </span><span class=\"p\">(</span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"s\">\"get\"</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">func</span><span class=\"w\"> </span><span class=\"cp\">$get</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"cp\">$enum</span><span class=\"o\">'</span><span class=\"p\">)))</span>\n<span class=\"w\">      </span><span class=\"p\">(</span><span class=\"n\">core</span><span class=\"w\"> </span><span class=\"n\">func</span><span class=\"w\"> </span><span class=\"cp\">$lowered</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">canon</span><span class=\"w\"> </span><span class=\"n\">lower</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">func</span><span class=\"w\"> </span><span class=\"cp\">$get</span><span class=\"p\">)))</span>\n<span class=\"w\">      </span><span class=\"p\">(</span><span class=\"n\">core</span><span class=\"w\"> </span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"cp\">$core</span>\n<span class=\"w\">        </span><span class=\"p\">(</span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"s\">\"\"</span><span class=\"w\"> </span><span class=\"s\">\"get\"</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">func</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">)))</span>\n<span class=\"w\">        </span><span class=\"p\">(</span><span class=\"n\">func</span><span class=\"w\"> </span><span class=\"cp\">$start</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">call</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"nb\">drop</span><span class=\"p\">)</span>\n<span class=\"w\">        </span><span class=\"p\">(</span><span class=\"n\">start</span><span class=\"w\"> </span><span class=\"cp\">$start</span><span class=\"p\">))</span>\n<span class=\"w\">      </span><span class=\"p\">(</span><span class=\"n\">core</span><span class=\"w\"> </span><span class=\"n\">instance</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">instantiate</span><span class=\"w\"> </span><span class=\"cp\">$core</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">with</span><span class=\"w\"> </span><span class=\"s\">\"\"</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">export</span><span class=\"w\"> </span><span class=\"s\">\"get\"</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">func</span><span class=\"w\"> </span><span class=\"cp\">$lowered</span><span class=\"p\">)))))))</span>\n\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"w\"> </span><span class=\"cp\">$prod</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">instantiate</span><span class=\"w\"> </span><span class=\"cp\">$producer</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">with</span><span class=\"w\"> </span><span class=\"s\">\"enum\"</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">type</span><span class=\"w\"> </span><span class=\"cp\">$enum</span><span class=\"p\">))))</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"n\">instance</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">instantiate</span><span class=\"w\"> </span><span class=\"cp\">$consumer</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">with</span><span class=\"w\"> </span><span class=\"s\">\"enum\"</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">type</span><span class=\"w\"> </span><span class=\"cp\">$enum</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">with</span><span class=\"w\"> </span><span class=\"s\">\"get\"</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">func</span><span class=\"w\"> </span><span class=\"cp\">$prod</span><span class=\"w\"> </span><span class=\"s\">\"get\"</span><span class=\"p\">)))))</span>\n<span class=\"w\">  </span><span class=\"s\">\"invalid variant discriminant\"</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>Here the line <code>(func (export \"get\") (result $enum') (canon lift (core func $inst \"get\")))</code> tries to lift the <code>$inst.\"get\"</code> (which returns the invalid discriminant) into a component function returning the enum with 3 variants.</p>\n<h3>Steps to Reproduce</h3>\n<p>Save the wast test somewhere (e.g. <code>tests/misc_testsuite/component-model/enum-discriminant-bug.wast</code>) and run</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"o\">-</span><span class=\"n\">cli</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"n\">wast</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"w\"> </span><span class=\"k\">enum</span><span class=\"o\">-</span><span class=\"n\">discriminant</span><span class=\"o\">-</span><span class=\"n\">bug</span>\n</code></pre></div>\n<p>will give:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">Caused</span><span class=\"w\"> </span><span class=\"n\">by</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"mi\">0</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">directive</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">tests</span><span class=\"o\">/</span><span class=\"n\">misc_testsuite</span><span class=\"o\">/</span><span class=\"n\">component</span><span class=\"o\">-</span><span class=\"n\">model</span><span class=\"o\">/</span><span class=\"k\">enum</span><span class=\"o\">-</span><span class=\"n\">discriminant</span><span class=\"o\">-</span><span class=\"n\">bug</span><span class=\"p\">.</span><span class=\"n\">wast</span><span class=\"p\">:</span><span class=\"mi\">2</span>\n<span class=\"w\">    </span><span class=\"mi\">1</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">expected</span><span class=\"w\"> </span><span class=\"n\">trap</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">got</span><span class=\"w\"> </span><span class=\"n\">Component</span><span class=\"p\">([])</span>\n</code></pre></div>\n<h3>Expected Results</h3>\n<p>3 is an invalid discriminant so it should be trapped and pass the assertion.</p>\n<h3>Actual Results</h3>\n<p>Not trapped and failed the assertion.</p>\n<h3>Versions and Environment</h3>\n<p>Wasmtime version or commit: 2e23e223c03543ee81344353e2d6418c0f3de47c</p>\n<h3>Extra Info</h3>\n<p>The discriminant check should have used <code>I32GeU</code> at line 3045:<br>\n<a href=\"https://github.com/bytecodealliance/wasmtime/blob/b856261dde3ea2624511fe4f48c3ed0790ddaa61/crates/environ/src/fact/trampoline.rs#L3043-L3048\">https://github.com/bytecodealliance/wasmtime/blob/b856261dde3ea2624511fe4f48c3ed0790ddaa61/crates/environ/src/fact/trampoline.rs#L3043-L3048</a></p>\n<p>I believe this doesn't enable any memory safety issues since other lifting locations have correct checks:<br>\n<a href=\"https://github.com/bytecodealliance/wasmtime/blob/b856261dde3ea2624511fe4f48c3ed0790ddaa61/crates/component-macro/src/component.rs#L653-L655\">https://github.com/bytecodealliance/wasmtime/blob/b856261dde3ea2624511fe4f48c3ed0790ddaa61/crates/component-macro/src/component.rs#L653-L655</a><br>\n<a href=\"https://github.com/bytecodealliance/wasmtime/blob/b856261dde3ea2624511fe4f48c3ed0790ddaa61/crates/wasmtime/src/runtime/component/values.rs#L994-L996\">https://github.com/bytecodealliance/wasmtime/blob/b856261dde3ea2624511fe4f48c3ed0790ddaa61/crates/wasmtime/src/runtime/component/values.rs#L994-L996</a></p>\n<p>Thanks for looking into this! And as before, happy to submit a PR to fix if it's indeed a bug and the test looks ok.</p>\n</blockquote>",
        "id": 568125889,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768453148
    }
]
[
    {
        "content": "<p>alexcrichton assigned dicej to <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11348\">issue #11348</a>.</p>",
        "id": 531886251,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753893872
    },
    {
        "content": "<p>alexcrichton opened <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11348\">issue #11348</a>:</p>\n<blockquote>\n<p>Lowering into WebAssembly may require calling the <code>realloc</code> component model abi option to allocate space for a returned list, for example. WebAssembly in async mode must always be invoked on a fiber to support suspension at any time, for example with epochs or fuel injecting yields. Currently the component-model-async implementation does not always create and use a <code>LowerContext</code> on a fiber which will result in panics that fiber-related contextual information is unavailable.</p>\n<p>This was discovered in review of <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11325\">https://github.com/bytecodealliance/wasmtime/pull/11325</a> and while that has an attempted solution for futures and streams it was also discovered that the solution isn't complete. I'm opening issue to keep track of this and take notes over time as necessary. </p>\n<p>I shared with @dicej a small patch:</p>\n<div class=\"codehilite\" data-code-language=\"Diff\"><pre><span></span><code><span class=\"gh\">diff --git a/crates/wasmtime/src/runtime/component/func/options.rs b/crates/wasmtime/src/runtime/component/func/options.rs</span>\n<span class=\"gh\">index 620e5a71d5..a839772824 100644</span>\n<span class=\"gd\">--- a/crates/wasmtime/src/runtime/component/func/options.rs</span>\n<span class=\"gi\">+++ b/crates/wasmtime/src/runtime/component/func/options.rs</span>\n<span class=\"gu\">@@ -241,6 +241,11 @@ impl&lt;'a, T: 'static&gt; LowerContext&lt;'a, T&gt; {</span>\n<span class=\"w\"> </span>        types: &amp;'a ComponentTypes,\n<span class=\"w\"> </span>        instance: Instance,\n<span class=\"w\"> </span>    ) -&gt; LowerContext&lt;'a, T&gt; {\n<span class=\"gi\">+        if cfg!(debug_assertions) {</span>\n<span class=\"gi\">+            if store.engine().config().async_support {</span>\n<span class=\"gi\">+                store.0.with_blocking(|_, _| {});</span>\n<span class=\"gi\">+            }</span>\n<span class=\"gi\">+        }</span>\n<span class=\"w\"> </span>        LowerContext {\n<span class=\"w\"> </span>            store,\n<span class=\"w\"> </span>            options,\n</code></pre></div>\n<p>which can be used to assert that <code>LowerContext</code> is created on a fiber. This currently panics many tests in the <code>component-async-tests</code> crate (and probably others). The current plan is to fix these panics then perhaps move this assertion to <code>realloc</code> instead to have a fast path where \"flat\" types can skip the fiber if they don't need realloc.</p>\n</blockquote>",
        "id": 531886258,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753893873
    },
    {
        "content": "<p><a href=\"https://github.com/alexcrichton\">alexcrichton</a> added the wasm-proposal:component-model-async label to <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11348\">Issue #11348</a>.</p>",
        "id": 531886261,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753893874
    },
    {
        "content": "<p>dicej closed <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11348\">issue #11348</a>:</p>\n<blockquote>\n<p>Lowering into WebAssembly may require calling the <code>realloc</code> component model abi option to allocate space for a returned list, for example. WebAssembly in async mode must always be invoked on a fiber to support suspension at any time, for example with epochs or fuel injecting yields. Currently the component-model-async implementation does not always create and use a <code>LowerContext</code> on a fiber which will result in panics that fiber-related contextual information is unavailable.</p>\n<p>This was discovered in review of <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11325\">https://github.com/bytecodealliance/wasmtime/pull/11325</a> and while that has an attempted solution for futures and streams it was also discovered that the solution isn't complete. I'm opening issue to keep track of this and take notes over time as necessary. </p>\n<p>I shared with @dicej a small patch:</p>\n<div class=\"codehilite\" data-code-language=\"Diff\"><pre><span></span><code><span class=\"gh\">diff --git a/crates/wasmtime/src/runtime/component/func/options.rs b/crates/wasmtime/src/runtime/component/func/options.rs</span>\n<span class=\"gh\">index 620e5a71d5..a839772824 100644</span>\n<span class=\"gd\">--- a/crates/wasmtime/src/runtime/component/func/options.rs</span>\n<span class=\"gi\">+++ b/crates/wasmtime/src/runtime/component/func/options.rs</span>\n<span class=\"gu\">@@ -241,6 +241,11 @@ impl&lt;'a, T: 'static&gt; LowerContext&lt;'a, T&gt; {</span>\n<span class=\"w\"> </span>        types: &amp;'a ComponentTypes,\n<span class=\"w\"> </span>        instance: Instance,\n<span class=\"w\"> </span>    ) -&gt; LowerContext&lt;'a, T&gt; {\n<span class=\"gi\">+        if cfg!(debug_assertions) {</span>\n<span class=\"gi\">+            if store.engine().config().async_support {</span>\n<span class=\"gi\">+                store.0.with_blocking(|_, _| {});</span>\n<span class=\"gi\">+            }</span>\n<span class=\"gi\">+        }</span>\n<span class=\"w\"> </span>        LowerContext {\n<span class=\"w\"> </span>            store,\n<span class=\"w\"> </span>            options,\n</code></pre></div>\n<p>which can be used to assert that <code>LowerContext</code> is created on a fiber. This currently panics many tests in the <code>component-async-tests</code> crate (and probably others). The current plan is to fix these panics then perhaps move this assertion to <code>realloc</code> instead to have a fast path where \"flat\" types can skip the fiber if they don't need realloc.</p>\n</blockquote>",
        "id": 531947185,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753916484
    },
    {
        "content": "<p>dicej <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11348#issuecomment-3138060124\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11348\">issue #11348</a>:</p>\n<blockquote>\n<p>Fixed by #11353 </p>\n</blockquote>",
        "id": 531947188,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1753916484
    }
]
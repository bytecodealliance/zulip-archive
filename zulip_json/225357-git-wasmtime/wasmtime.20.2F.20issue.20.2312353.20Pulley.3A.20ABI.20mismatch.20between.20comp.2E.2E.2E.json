[
    {
        "content": "<p>zzjas opened <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12353\">issue #12353</a>:</p>\n<blockquote>\n<p>While looking at Pulley, we found a potential ABI issues but it's not trivial to test with the exisitng testing infrastructure so I'm opening this issue to see if it should be fixed and/or tested. Happy to submit a PR! Thanks!</p>\n<h1>Mismatch between compiler and interpreter</h1>\n<p>Compiler doesn't use <code>x15</code> for argument,<br>\n<a href=\"https://github.com/bytecodealliance/wasmtime/blob/b856261dde3ea2624511fe4f48c3ed0790ddaa61/cranelift/codegen/src/isa/pulley_shared/abi.rs#L61-L70\">https://github.com/bytecodealliance/wasmtime/blob/b856261dde3ea2624511fe4f48c3ed0790ddaa61/cranelift/codegen/src/isa/pulley_shared/abi.rs#L61-L70</a></p>\n<p>the <code>call_end</code> in interpreter was updated to correctly follow this<br>\n<a href=\"https://github.com/bytecodealliance/wasmtime/blob/b856261dde3ea2624511fe4f48c3ed0790ddaa61/pulley/src/interp.rs#L169-L178\">https://github.com/bytecodealliance/wasmtime/blob/b856261dde3ea2624511fe4f48c3ed0790ddaa61/pulley/src/interp.rs#L169-L178</a></p>\n<p>but <code>call_start</code> is still using x15<br>\n<a href=\"https://github.com/bytecodealliance/wasmtime/blob/b856261dde3ea2624511fe4f48c3ed0790ddaa61/pulley/src/interp.rs#L110-L114\">https://github.com/bytecodealliance/wasmtime/blob/b856261dde3ea2624511fe4f48c3ed0790ddaa61/pulley/src/interp.rs#L110-L114</a></p>\n<p>Probably this is just a subtle oversight that is very easy to fix, but I'm not sure how to properly test it (or if it needs a test at all).</p>\n<p>For now I have a lengthy Rust test that compiles a piece of clif code to Pulley, invokes <code>VM::call</code>, and check the result.</p>\n<hr>\n<p>Another question about Pulley: we also noticed that the <code>compute_arg_locs</code> for Pulley will split a single i128 argument across a register and the stack when only one register is available. I didn't find any document about this so just want to ask if this is the intended behavior.</p>\n<p>Thanks for looking into this!</p>\n</blockquote>",
        "id": 568105052,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768437170
    },
    {
        "content": "<p><a href=\"https://github.com/zzjas\">zzjas</a> added the cranelift label to <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12353\">Issue #12353</a>.</p>",
        "id": 568105053,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768437170
    },
    {
        "content": "<p><a href=\"https://github.com/zzjas\">zzjas</a> added the bug label to <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12353\">Issue #12353</a>.</p>",
        "id": 568105054,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768437170
    },
    {
        "content": "<p>zzjas edited <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12353\">issue #12353</a>:</p>\n<blockquote>\n<p>While looking at Pulley, we found a potential ABI issue but it's not trivial to test with the exisitng testing infrastructure so I'm opening this issue to see if it should be fixed and/or tested. Happy to submit a PR! Thanks!</p>\n<h1>Mismatch between compiler and interpreter</h1>\n<p>Compiler doesn't use <code>x15</code> for argument,<br>\n<a href=\"https://github.com/bytecodealliance/wasmtime/blob/b856261dde3ea2624511fe4f48c3ed0790ddaa61/cranelift/codegen/src/isa/pulley_shared/abi.rs#L61-L70\">https://github.com/bytecodealliance/wasmtime/blob/b856261dde3ea2624511fe4f48c3ed0790ddaa61/cranelift/codegen/src/isa/pulley_shared/abi.rs#L61-L70</a></p>\n<p>the <code>call_end</code> in interpreter was updated to correctly follow this<br>\n<a href=\"https://github.com/bytecodealliance/wasmtime/blob/b856261dde3ea2624511fe4f48c3ed0790ddaa61/pulley/src/interp.rs#L169-L178\">https://github.com/bytecodealliance/wasmtime/blob/b856261dde3ea2624511fe4f48c3ed0790ddaa61/pulley/src/interp.rs#L169-L178</a></p>\n<p>but <code>call_start</code> is still using x15<br>\n<a href=\"https://github.com/bytecodealliance/wasmtime/blob/b856261dde3ea2624511fe4f48c3ed0790ddaa61/pulley/src/interp.rs#L110-L114\">https://github.com/bytecodealliance/wasmtime/blob/b856261dde3ea2624511fe4f48c3ed0790ddaa61/pulley/src/interp.rs#L110-L114</a></p>\n<p>Probably this is just a subtle oversight that is very easy to fix, but I'm not sure how to properly test it (or if it needs a test at all).</p>\n<p>For now I have a lengthy Rust test that compiles a piece of clif code to Pulley, invokes <code>VM::call</code>, and check the result.</p>\n<hr>\n<p>Another question about Pulley: we also noticed that the <code>compute_arg_locs</code> for Pulley will split a single i128 argument across a register and the stack when only one register is available. I didn't find any document about this so just want to ask if this is the intended behavior.</p>\n<p>Thanks for looking into this!</p>\n</blockquote>",
        "id": 568105088,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768437189
    },
    {
        "content": "<p>zzjas edited <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12353\">issue #12353</a>:</p>\n<blockquote>\n<p>While looking at Pulley, we found a potential ABI issue but it's not trivial to test with the exisitng testing infrastructure so I'm opening this issue to see if it should be fixed and/or tested. Happy to submit a PR! Thanks!</p>\n<h3>Mismatch between compiler and interpreter</h3>\n<p>Compiler doesn't use <code>x15</code> for argument,<br>\n<a href=\"https://github.com/bytecodealliance/wasmtime/blob/b856261dde3ea2624511fe4f48c3ed0790ddaa61/cranelift/codegen/src/isa/pulley_shared/abi.rs#L61-L70\">https://github.com/bytecodealliance/wasmtime/blob/b856261dde3ea2624511fe4f48c3ed0790ddaa61/cranelift/codegen/src/isa/pulley_shared/abi.rs#L61-L70</a></p>\n<p>the <code>call_end</code> in interpreter was updated to correctly follow this<br>\n<a href=\"https://github.com/bytecodealliance/wasmtime/blob/b856261dde3ea2624511fe4f48c3ed0790ddaa61/pulley/src/interp.rs#L169-L178\">https://github.com/bytecodealliance/wasmtime/blob/b856261dde3ea2624511fe4f48c3ed0790ddaa61/pulley/src/interp.rs#L169-L178</a></p>\n<p>but <code>call_start</code> is still using x15<br>\n<a href=\"https://github.com/bytecodealliance/wasmtime/blob/b856261dde3ea2624511fe4f48c3ed0790ddaa61/pulley/src/interp.rs#L110-L114\">https://github.com/bytecodealliance/wasmtime/blob/b856261dde3ea2624511fe4f48c3ed0790ddaa61/pulley/src/interp.rs#L110-L114</a></p>\n<p>Probably this is just a subtle oversight that is very easy to fix, but I'm not sure how to properly test it (or if it needs a test at all).</p>\n<p>For now I have a lengthy Rust test that compiles a piece of clif code to Pulley, invokes <code>VM::call</code>, and check the result.</p>\n<hr>\n<p>Another question about Pulley: we also noticed that the <code>compute_arg_locs</code> for Pulley will split a single i128 argument across a register and the stack when only one register is available. I didn't find any document about this so just want to ask if this is the intended behavior.</p>\n<p>Thanks for looking into this!</p>\n</blockquote>",
        "id": 568105119,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768437212
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12353#issuecomment-3752868807\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12353\">issue #12353</a>:</p>\n<blockquote>\n<p>Ah yeah this is a mistake that's fine to fix. I don't believe this is surfaceable via wasm itself because <code>call_{start,end}</code> is only used with a single type signature (our entry trampoline) which doesn't have 16+ arguments. Regardless though still good to fix for future use of pulley!</p>\n<p>For i128 I think we're probably inheriting whatever native platforms do in that regard, but tweaking that to fix any issues arising is also totally ok as it's not used in the <code>call_{start,end}</code> path either</p>\n</blockquote>",
        "id": 568124338,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768451691
    },
    {
        "content": "<p>zzjas <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12353#issuecomment-3756077407\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12353\">issue #12353</a>:</p>\n<blockquote>\n<blockquote>\n<p>Ah yeah this is a mistake that's fine to fix.</p>\n</blockquote>\n<p>Created a PR for the first fix.</p>\n<blockquote>\n<p>For i128 I think we're probably inheriting whatever native platforms do in that regard, but tweaking that to fix any issues arising is also totally ok as it's not used in the call_{start,end} path either</p>\n</blockquote>\n<p>I think right now there's no issue to fix since it's self consistent. From my brief checking, X64 and aarch64 doesn't split i128 but RISC-V splits so either way is fine as long as it's well defined &amp; documented for Pulley (when args on stack is actually implemented for VM::call).</p>\n</blockquote>",
        "id": 568276148,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768498644
    },
    {
        "content": "<p>zzjas edited a <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12353#issuecomment-3756077407\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12353\">issue #12353</a>:</p>\n<blockquote>\n<p>Thanks for looking into this!</p>\n<blockquote>\n<p>Ah yeah this is a mistake that's fine to fix.</p>\n</blockquote>\n<p>Created a PR for the first fix.</p>\n<blockquote>\n<p>For i128 I think we're probably inheriting whatever native platforms do in that regard, but tweaking that to fix any issues arising is also totally ok as it's not used in the call_{start,end} path either</p>\n</blockquote>\n<p>I think right now there's no issue to fix since it's self consistent. From my brief checking, X64 and aarch64 doesn't split i128 but RISC-V splits so either way is fine as long as it's well defined &amp; documented for Pulley (when args on stack is actually implemented for VM::call).</p>\n</blockquote>",
        "id": 568276187,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768498661
    },
    {
        "content": "<p>alexcrichton closed <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12353\">issue #12353</a>:</p>\n<blockquote>\n<p>While looking at Pulley, we found a potential ABI issue but it's not trivial to test with the exisitng testing infrastructure so I'm opening this issue to see if it should be fixed and/or tested. Happy to submit a PR! Thanks!</p>\n<h3>Mismatch between compiler and interpreter</h3>\n<p>Compiler doesn't use <code>x15</code> for argument,<br>\n<a href=\"https://github.com/bytecodealliance/wasmtime/blob/b856261dde3ea2624511fe4f48c3ed0790ddaa61/cranelift/codegen/src/isa/pulley_shared/abi.rs#L61-L70\">https://github.com/bytecodealliance/wasmtime/blob/b856261dde3ea2624511fe4f48c3ed0790ddaa61/cranelift/codegen/src/isa/pulley_shared/abi.rs#L61-L70</a></p>\n<p>the <code>call_end</code> in interpreter was updated to correctly follow this<br>\n<a href=\"https://github.com/bytecodealliance/wasmtime/blob/b856261dde3ea2624511fe4f48c3ed0790ddaa61/pulley/src/interp.rs#L169-L178\">https://github.com/bytecodealliance/wasmtime/blob/b856261dde3ea2624511fe4f48c3ed0790ddaa61/pulley/src/interp.rs#L169-L178</a></p>\n<p>but <code>call_start</code> is still using x15<br>\n<a href=\"https://github.com/bytecodealliance/wasmtime/blob/b856261dde3ea2624511fe4f48c3ed0790ddaa61/pulley/src/interp.rs#L110-L114\">https://github.com/bytecodealliance/wasmtime/blob/b856261dde3ea2624511fe4f48c3ed0790ddaa61/pulley/src/interp.rs#L110-L114</a></p>\n<p>Probably this is just a subtle oversight that is very easy to fix, but I'm not sure how to properly test it (or if it needs a test at all).</p>\n<p>For now I have a lengthy Rust test that compiles a piece of clif code to Pulley, invokes <code>VM::call</code>, and check the result.</p>\n<hr>\n<p>Another question about Pulley: we also noticed that the <code>compute_arg_locs</code> for Pulley will split a single i128 argument across a register and the stack when only one register is available. I didn't find any document about this so just want to ask if this is the intended behavior.</p>\n<p>Thanks for looking into this!</p>\n</blockquote>",
        "id": 568319420,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768514773
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12353#issuecomment-3757192869\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12353\">issue #12353</a>:</p>\n<blockquote>\n<p>I suspect that's a result of Pulley starting out by copying much of the riscv64 code, so makes sense in that regard at least. It should be fine to tweak as necesary though if needed</p>\n</blockquote>",
        "id": 568322239,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768516017
    }
]
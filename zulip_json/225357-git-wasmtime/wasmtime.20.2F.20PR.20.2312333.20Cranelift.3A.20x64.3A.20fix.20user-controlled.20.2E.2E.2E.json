[
    {
        "content": "<p>cfallin opened <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12333\">PR #12333</a> from <code>cfallin:icmp-recursion</code> to <code>bytecodealliance:main</code>:</p>\n<blockquote>\n<p>We had a set of rules introduced in #11097 that attempted to optimize the case of testing the result of an <code>icmp</code> for a nonzero value. This allowed optimization of, for example, <code>(((x == 0) == 0) == 0 ...)</code> to a single level, either <code>x == 0</code> or <code>x != 0</code> depending on even/odd nesting depth.</p>\n<p>Unfortunately this kind of recursion in the backend has a depth bounded only by the user input, hence creates a DoS vulnerability: the wrong kind of compiler input can cause a stack overflow in Cranelift at compilation time. This case is reachable from Wasmtime's Wasm frontend via the <code>i32.eqz</code> operator (for example) as well.</p>\n<p>Ideally, this kind of deep rewrite is best done in our mid-end optimizer, where we think carefully about bounds for recursive rewrites. The left-hand sides for the backend rules should really be fixed shapes that correspond to machine instructions, rather than ad-hoc peephole optimizations in their own right.</p>\n<p>This fix thus simply removes the recursion case that causes the blowup. The patch includes two tests: one with optimizations disabled, showing correct compilation (without the fix, this case fails to compile with a stack overflow), and one with optimizations enabled, showing that the mid-end properly cleans up the nested expression and we get the expected one-level result anyway.</p>\n<p>Note: this was reported as a security issue by @venkkatesh-sekar (thanks!); per our <a href=\"https://docs.wasmtime.dev/security-what-is-considered-a-security-vulnerability.html\">security policy</a>, compilation DoS is not covered, so this is being fixed in a public PR. I will subsequently make a patch release to our currently supported versions (v36, v39, v40, 41).</p>\n<p>&lt;!--<br>\nPlease make sure you include the following information:</p>\n<ul>\n<li>\n<p>If this work has been discussed elsewhere, please include a link to that<br>\n  conversation. If it was discussed in an issue, just mention \"issue #...\".</p>\n</li>\n<li>\n<p>Explain why this change is needed. If the details are in an issue already,<br>\n  this can be brief.</p>\n</li>\n</ul>\n<p>Our development process is documented in the Wasmtime book:<br>\n<a href=\"https://docs.wasmtime.dev/contributing-development-process.html\">https://docs.wasmtime.dev/contributing-development-process.html</a></p>\n<p>Please ensure all communication follows the code of conduct:<br>\n<a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md\">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>\n--&gt;</p>\n</blockquote>",
        "id": 567826491,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768326545
    },
    {
        "content": "<p><strong>cfallin</strong> requested <a href=\"https://github.com/fitzgen\">fitzgen</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12333\">PR #12333</a>.</p>",
        "id": 567826495,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768326546
    },
    {
        "content": "<p><strong>cfallin</strong> requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers\">wasmtime-compiler-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12333\">PR #12333</a>.</p>",
        "id": 567826496,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768326546
    },
    {
        "content": "<p><strong>cfallin</strong> requested <a href=\"https://github.com/alexcrichton\">alexcrichton</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12333\">PR #12333</a>.</p>",
        "id": 567826531,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768326556
    },
    {
        "content": "<p>cfallin edited <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12333\">PR #12333</a>:</p>\n<blockquote>\n<p>We had a set of rules introduced in #11097 that attempted to optimize the case of testing the result of an <code>icmp</code> for a nonzero value. This allowed optimization of, for example, <code>(((x == 0) == 0) == 0 ...)</code> to a single level, either <code>x == 0</code> or <code>x != 0</code> depending on even/odd nesting depth.</p>\n<p>Unfortunately this kind of recursion in the backend has a depth bounded only by the user input, hence creates a compiler DoS vulnerability: the wrong kind of compiler input can cause a stack overflow in Cranelift at compilation time. This case is reachable from Wasmtime's Wasm frontend via the <code>i32.eqz</code> operator (for example) as well.</p>\n<p>Ideally, this kind of deep rewrite is best done in our mid-end optimizer, where we think carefully about bounds for recursive rewrites. The left-hand sides for the backend rules should really be fixed shapes that correspond to machine instructions, rather than ad-hoc peephole optimizations in their own right.</p>\n<p>This fix thus simply removes the recursion case that causes the blowup. The patch includes two tests: one with optimizations disabled, showing correct compilation (without the fix, this case fails to compile with a stack overflow), and one with optimizations enabled, showing that the mid-end properly cleans up the nested expression and we get the expected one-level result anyway.</p>\n<p>Note: this was reported as a security issue by @venkkatesh-sekar (thanks!); per our <a href=\"https://docs.wasmtime.dev/security-what-is-considered-a-security-vulnerability.html\">security policy</a>, compilation DoS is not covered, so this is being fixed in a public PR. I will subsequently make a patch release to our currently supported versions (v36, v39, v40, 41).</p>\n<p>&lt;!--<br>\nPlease make sure you include the following information:</p>\n<ul>\n<li>\n<p>If this work has been discussed elsewhere, please include a link to that<br>\n  conversation. If it was discussed in an issue, just mention \"issue #...\".</p>\n</li>\n<li>\n<p>Explain why this change is needed. If the details are in an issue already,<br>\n  this can be brief.</p>\n</li>\n</ul>\n<p>Our development process is documented in the Wasmtime book:<br>\n<a href=\"https://docs.wasmtime.dev/contributing-development-process.html\">https://docs.wasmtime.dev/contributing-development-process.html</a></p>\n<p>Please ensure all communication follows the code of conduct:<br>\n<a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md\">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>\n--&gt;</p>\n</blockquote>",
        "id": 567826693,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768326613
    },
    {
        "content": "<p>fitzgen submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12333#pullrequestreview-3657096440\">PR review</a>.</p>",
        "id": 567826806,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768326648
    },
    {
        "content": "<p>cfallin has enabled auto merge for <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12333\">PR #12333</a>.</p>",
        "id": 567826940,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768326688
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12333#issuecomment-3745737995\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12333\">PR #12333</a>:</p>\n<blockquote>\n<p>I haven't dug deeply into the fallout here, but it looks like just removing these rules isn't enough to retain the codegen we have from before. A rough hunch is that there's a number of entrypoints for using these ISLE helpers and while the wasm test case here is one which is also cleaned up by the optimizer I think that these rules might be load-bearing for other codegen patterns unrelated to the optimizer.</p>\n<p>It might need to be the case that some entrypoints use one rule, which includes these deleted rules, but then these rules don't recurse on themselves?</p>\n</blockquote>",
        "id": 567832096,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768328360
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12333#issuecomment-3745746996\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12333\">PR #12333</a>:</p>\n<blockquote>\n<p>Although, from another angle, this seems fine as a thing to backport since it's clearly such low impact. I'm not aware of these codegen patterns being load bearing in terms of performance so a temporary minor regression while a \"full fix\" is developed for <code>main</code> I think would also be reasonable. In such a case though there's a number of codegen/etc tests to update to get CI passing.</p>\n</blockquote>",
        "id": 567832445,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768328496
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12333#issuecomment-3745905075\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12333\">PR #12333</a>:</p>\n<blockquote>\n<p>This broke some existing lowerings; playing a bit more with various ways to break the cycle.</p>\n</blockquote>",
        "id": 567838681,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768330773
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12333#issuecomment-3745908749\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12333\">PR #12333</a>:</p>\n<blockquote>\n<p>(On refresh, what Alex said -- somehow those comments didn't appear for me.)</p>\n</blockquote>",
        "id": 567838814,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768330819
    },
    {
        "content": "<p>cfallin updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12333\">PR #12333</a>.</p>",
        "id": 567854366,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768336423
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12333#issuecomment-3746460956\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12333\">PR #12333</a>:</p>\n<blockquote>\n<p>OK, I've reworked things a bit to preserve exactly the same codegen on branches -- I effectively peeled one layer off of <code>is_nonzero_cmp</code> to continue to use with branches but the previous backedge from <code>emit_cmp</code> to <code>is_nonzero_cmp</code> now invokes <code>is_nonzero</code> which has only the base cases. Together with explicit LHS patterns to peel one level of <code>uextend</code> this leaves us with no test-output changes now.</p>\n</blockquote>",
        "id": 567854668,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768336535
    },
    {
        "content": "<p>cfallin updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12333\">PR #12333</a>.</p>",
        "id": 567854831,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768336624
    },
    {
        "content": "<p><strong>cfallin</strong> requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers\">wasmtime-core-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12333\">PR #12333</a>.</p>",
        "id": 567854832,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768336624
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12333#issuecomment-3746467903\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12333\">PR #12333</a>:</p>\n<blockquote>\n<p>Or, well, spoke too soon -- no Cranelift filetest changes. A few disas tests that do FP compares do regress to materializing the bool.</p>\n</blockquote>",
        "id": 567854909,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768336656
    },
    {
        "content": "<p>cfallin updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12333\">PR #12333</a>.</p>",
        "id": 567865911,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768341348
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12333#issuecomment-3746747846\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12333\">PR #12333</a>:</p>\n<blockquote>\n<p>OK, I've gotten full equivalence on the disas tests too -- this needed one new mid-end rule to see through a pattern (<code>fcmp(...) != 0</code>) that we were previously only ever simplifying with this peephole rule in the backend. </p>\n<p>@fitzgen mind giving this another look, since it's a little heavier than before?</p>\n<p>Re: backport, I could certainly backport the rule deletions only, but I'd be a little concerned about performance regressions in that case because this affects many branches. If we feel ok about these rewrites I think the full patch should be applicable back to v36 (LTS).</p>\n</blockquote>",
        "id": 567866236,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768341499
    },
    {
        "content": "<p>alexcrichton submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12333#pullrequestreview-3658212925\">PR review</a>.</p>",
        "id": 567871891,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768344161
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12333#discussion_r2688357363\">PR review comment</a>:</p>\n<blockquote>\n<p>I think this change, the <code>uextend</code>-no-longer-recurses, is what's causing the remaining disassembly differences. Locally I'm seeing <code>(uextend (vall_{any,true} ..))</code> I believe for example.</p>\n<p>Do you think it'd be worth adding those specifically here as well? I'm not sure how to deduplicate this amongst the <code>is_nonzero</code> selectors above otherwise. Although nowadays egraphs might be able to rewrite <code>(brif (uextend val))</code> to <code>(brif val)</code> which I know historically was difficult</p>\n</blockquote>",
        "id": 567871893,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768344162
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12333#issuecomment-3746904096\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12333\">PR #12333</a>:</p>\n<blockquote>\n<p>Also, logistically, @cfallin are you ok running point on backporting/point releases? And 24.0.0, while supported, is unaffected right?</p>\n</blockquote>",
        "id": 567872108,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768344288
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12333#issuecomment-3746917535\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12333\">PR #12333</a>:</p>\n<blockquote>\n<p>Yes, I'm happy to do the backports too. (Sorry, very slow today taking scraps of time between meetings and other interrupts; can hopefully do backports by end of tomorrow at latest.)</p>\n</blockquote>",
        "id": 567872655,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768344612
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12333#issuecomment-3746926403\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12333\">PR #12333</a>:</p>\n<blockquote>\n<p>Oh no worries! Just want to make sure there's explicitly an owner. Tomorrow is totally fine and I can be around to hit approvals and help babysit CI. We've had some CI changes recently like trusted publishing which raises the risk of broken CI on other branches, so something to watch out for.</p>\n</blockquote>",
        "id": 567872947,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768344783
    },
    {
        "content": "<p>cfallin updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12333\">PR #12333</a>.</p>",
        "id": 567873497,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768345147
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12333#pullrequestreview-3658247843\">PR review</a>.</p>",
        "id": 567873512,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768345155
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12333#discussion_r2688390569\">PR review comment</a>:</p>\n<blockquote>\n<p>Ah, I missed this -- fixed in latest push (which drops the commit with any diffs to tests at all).</p>\n</blockquote>",
        "id": 567873513,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768345155
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12333#discussion_r2688391268\">PR review comment</a>:</p>\n<blockquote>\n<p>(Fixed by adding explicit patterns in <code>is_nonzero</code> as you suggest)</p>\n</blockquote>",
        "id": 567873549,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768345176
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12333#pullrequestreview-3658248534\">PR review</a>.</p>",
        "id": 567873551,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768345176
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12333#issuecomment-3746943725\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12333\">PR #12333</a>:</p>\n<blockquote>\n<p>OK, this should be good to go -- if r+ here then I can put up backports momentarily.</p>\n</blockquote>",
        "id": 567873648,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768345223
    },
    {
        "content": "<p>cfallin edited a <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12333#issuecomment-3746943725\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12333\">PR #12333</a>:</p>\n<blockquote>\n<p>OK, this should be good to go -- if r+ here (on new changes) then I can put up backports momentarily.</p>\n</blockquote>",
        "id": 567873708,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768345236
    },
    {
        "content": "<p>alexcrichton submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12333#pullrequestreview-3658269719\">PR review</a>.</p>",
        "id": 567874783,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768345840
    },
    {
        "content": "<p>cfallin has enabled auto merge for <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12333\">PR #12333</a>.</p>",
        "id": 567874910,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768345904
    },
    {
        "content": "<p>cfallin merged <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12333\">PR #12333</a>.</p>",
        "id": 567877845,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768347380
    },
    {
        "content": "<p>adambratschikaye <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12333#issuecomment-3748924064\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12333\">PR #12333</a>:</p>\n<blockquote>\n<p>Thanks for taking care of this @cfallin, @alexcrichton, and @fitzgen!</p>\n</blockquote>",
        "id": 567952578,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768387599
    }
]
[
    {
        "content": "<p><a href=\"https://github.com/TheWaWaR\">TheWaWaR</a> added the bug label to <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10381\">Issue #10381</a>.</p>",
        "id": 505150454,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1741789897
    },
    {
        "content": "<p>TheWaWaR opened <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10381\">issue #10381</a>:</p>\n<blockquote>\n<p>The <code>wasmtime_func_t</code> in <code>wasmtime /extern.h</code> is</p>\n<div class=\"codehilite\" data-code-language=\"C\"><pre><span></span><code><span class=\"k\">typedef</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">wasmtime_func</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"kt\">uint64_t</span><span class=\"w\"> </span><span class=\"n\">store_id</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">__private</span><span class=\"p\">;</span>\n<span class=\"p\">}</span><span class=\"w\"> </span><span class=\"n\">wasmtime_func_t</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>But in rust code (crates/c-api/src/val.rs):</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">#[repr(C)]</span>\n<span class=\"cp\">#[derive(Clone, Copy)]</span>\n<span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">union</span><span class=\"w\"> </span><span class=\"nc\">wasmtime_func_t</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">store_id</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">u64</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">func</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">Func</span><span class=\"p\">,</span>\n<span class=\"p\">}</span>\n\n<span class=\"cp\">#[derive(Copy, Clone, Debug)]</span>\n<span class=\"cp\">#[repr(transparent)]</span><span class=\"w\"> </span><span class=\"c1\">// here for the C API</span>\n<span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">Func</span><span class=\"p\">(</span><span class=\"n\">Stored</span><span class=\"o\">&lt;</span><span class=\"n\">FuncData</span><span class=\"o\">&gt;</span><span class=\"p\">);</span>\n\n<span class=\"cp\">#[repr(C)]</span><span class=\"w\"> </span><span class=\"c1\">// used by reference in the C API, also in `wasmtime_func_t`.</span>\n<span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">Stored</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">store_id</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">StoreId</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">index</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">usize</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">_marker</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">marker</span><span class=\"p\">::</span><span class=\"n\">PhantomData</span><span class=\"o\">&lt;</span><span class=\"k\">fn</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">T</span><span class=\"o\">&gt;</span><span class=\"p\">,</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>The size of wasmtime_func_t in C is 16 bytes, but the size in rust is 24 bytes, which include 2 <code>store_id</code> field.</p>\n<p>As a consequence, the type <code>wasmtime_val_union</code> in Rust can't align with the type <code>wasmtime_valunion_t</code> in C.</p>\n</blockquote>",
        "id": 505150457,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1741789898
    },
    {
        "content": "<p>TheWaWaR edited <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10381\">issue #10381</a>:</p>\n<blockquote>\n<p>The <code>wasmtime_func_t</code> in <code>wasmtime /extern.h</code> is</p>\n<div class=\"codehilite\" data-code-language=\"C\"><pre><span></span><code><span class=\"k\">typedef</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">wasmtime_func</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"kt\">uint64_t</span><span class=\"w\"> </span><span class=\"n\">store_id</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">__private</span><span class=\"p\">;</span>\n<span class=\"p\">}</span><span class=\"w\"> </span><span class=\"n\">wasmtime_func_t</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>But in rust code (crates/c-api/src/val.rs):</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">#[repr(C)]</span>\n<span class=\"cp\">#[derive(Clone, Copy)]</span>\n<span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">union</span><span class=\"w\"> </span><span class=\"nc\">wasmtime_func_t</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">store_id</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">u64</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">func</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">Func</span><span class=\"p\">,</span>\n<span class=\"p\">}</span>\n\n<span class=\"cp\">#[derive(Copy, Clone, Debug)]</span>\n<span class=\"cp\">#[repr(transparent)]</span><span class=\"w\"> </span><span class=\"c1\">// here for the C API</span>\n<span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">Func</span><span class=\"p\">(</span><span class=\"n\">Stored</span><span class=\"o\">&lt;</span><span class=\"n\">FuncData</span><span class=\"o\">&gt;</span><span class=\"p\">);</span>\n\n<span class=\"cp\">#[repr(C)]</span><span class=\"w\"> </span><span class=\"c1\">// used by reference in the C API, also in `wasmtime_func_t`.</span>\n<span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">Stored</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">store_id</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">StoreId</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">index</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">usize</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">_marker</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">marker</span><span class=\"p\">::</span><span class=\"n\">PhantomData</span><span class=\"o\">&lt;</span><span class=\"k\">fn</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">T</span><span class=\"o\">&gt;</span><span class=\"p\">,</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>The size of wasmtime_func_t in C is 16 bytes, but the size in rust is 24 bytes, which include 2 <code>store_id</code> fields.</p>\n<p>As a consequence, the type <code>wasmtime_val_union</code> in Rust can't align with the type <code>wasmtime_valunion_t</code> in C.</p>\n</blockquote>",
        "id": 505150556,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1741789920
    },
    {
        "content": "<p>TheWaWaR <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10381#issuecomment-2718110748\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10381\">issue #10381</a>:</p>\n<blockquote>\n<p>And also the type <code>wasmtime_anyref_t</code> and <code>wasmtime_externref_t</code> in Rust code doesn't have <code>#[repr(C)]</code> in the definition marco <code>ref_wrapper!</code>.</p>\n</blockquote>",
        "id": 505151645,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1741790135
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10381#issuecomment-2718117921\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10381\">issue #10381</a>:</p>\n<blockquote>\n<p>Have you run into issues in the wild as a result of this? Or was this spotted during code review?</p>\n<p>The Rust definition of <code>wasmtime_func_t</code> uses a <code>union</code> so it shouldn't be 24 bytes, but if you found an issue in the wild then that's more worrisome.</p>\n</blockquote>",
        "id": 505152380,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1741790279
    },
    {
        "content": "<p>TheWaWaR <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10381#issuecomment-2718130136\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10381\">issue #10381</a>:</p>\n<blockquote>\n<p>My problem is the callback function registered with <code>wasmtime_linker_define_func</code>, the <code>params</code> can't parse correctly with my zig code. Even the second param's <code>kind</code> field is parse incorrectly.</p>\n</blockquote>",
        "id": 505153629,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1741790520
    },
    {
        "content": "<p>TheWaWaR edited a <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10381#issuecomment-2718130136\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10381\">issue #10381</a>:</p>\n<blockquote>\n<p>My problem is the callback function registered with <code>wasmtime_linker_define_func</code>, the <code>params</code> can't read correctly with my zig code. Even the second param's <code>kind</code> field is incorrect.</p>\n</blockquote>",
        "id": 505153801,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1741790550
    },
    {
        "content": "<p>TheWaWaR edited a <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10381#issuecomment-2718130136\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10381\">issue #10381</a>:</p>\n<blockquote>\n<p>My problem is the callback function registered with <code>wasmtime_linker_define_func</code>, the <code>params</code> can't read correctly with my zig code. Even the second param's <code>kind</code> field is incorrect.</p>\n<p><div class=\"codehilite\" data-code-language=\"Zig\"><pre><span></span><code><span class=\"kr\">pub</span><span class=\"w\"> </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"n\">getKeyboardState</span><span class=\"p\">(</span>\n<span class=\"w\">    </span><span class=\"n\">env</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">anyopaque</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">caller</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">anyopaque</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">args</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"o\">*</span><span class=\"p\">]</span><span class=\"kr\">const</span><span class=\"w\"> </span><span class=\"n\">Value</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">nargs</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">usize</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">results</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"o\">*</span><span class=\"p\">]</span><span class=\"n\">Value</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">nresults</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">usize</span><span class=\"p\">,</span>\n<span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">callconv</span><span class=\"p\">(.</span><span class=\"n\">C</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">?*</span><span class=\"n\">anyopaque</span><span class=\"w\"> </span><span class=\"p\">{}</span>\n\n<span class=\"kr\">pub</span><span class=\"w\"> </span><span class=\"kr\">const</span><span class=\"w\"> </span><span class=\"n\">Value</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kr\">extern</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">kind</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ValueKind</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">of</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ValueUnion</span><span class=\"p\">,</span>\n<span class=\"p\">}</span>\n\n<span class=\"c1\">// wasmtime/val.h: wasmtime_valunion_t</span>\n<span class=\"kr\">pub</span><span class=\"w\"> </span><span class=\"kr\">const</span><span class=\"w\"> </span><span class=\"n\">ValueUnion</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kr\">extern</span><span class=\"w\"> </span><span class=\"k\">union</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"kt\">i32</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"kt\">i64</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">i64</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"kt\">f32</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">f32</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"kt\">f64</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">f64</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">anyref</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">u128</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">externref</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">u128</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">funcref</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">u128</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">v128</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">16</span><span class=\"p\">]</span><span class=\"kt\">u8</span><span class=\"p\">,</span>\n<span class=\"p\">};</span>\n\n<span class=\"c1\">// wasmtime/val.h: wasmtime_valkind_t</span>\n<span class=\"kr\">pub</span><span class=\"w\"> </span><span class=\"kr\">const</span><span class=\"w\"> </span><span class=\"n\">ValueKind</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">enum</span><span class=\"p\">(</span><span class=\"kt\">u8</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"kt\">i64</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"kt\">f32</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"kt\">f64</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">v128</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">funcref</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">externref</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">anyref</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"p\">,</span>\n<span class=\"p\">};</span>\n</code></pre></div><br>\n</p>\n</blockquote>",
        "id": 505154611,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1741790719
    },
    {
        "content": "<p>TheWaWaR edited a <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10381#issuecomment-2718130136\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10381\">issue #10381</a>:</p>\n<blockquote>\n<p>My problem is the callback function registered with <code>wasmtime_linker_define_func</code>, the <code>params</code> can't read correctly with my zig code. Even the second param's <code>kind</code> field is incorrect. (other arguments in the callback function is ok.)</p>\n<p><div class=\"codehilite\" data-code-language=\"Zig\"><pre><span></span><code><span class=\"kr\">pub</span><span class=\"w\"> </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"n\">getKeyboardState</span><span class=\"p\">(</span>\n<span class=\"w\">    </span><span class=\"n\">env</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">anyopaque</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">caller</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">anyopaque</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">args</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"o\">*</span><span class=\"p\">]</span><span class=\"kr\">const</span><span class=\"w\"> </span><span class=\"n\">Value</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">nargs</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">usize</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">results</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"o\">*</span><span class=\"p\">]</span><span class=\"n\">Value</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">nresults</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">usize</span><span class=\"p\">,</span>\n<span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">callconv</span><span class=\"p\">(.</span><span class=\"n\">C</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">?*</span><span class=\"n\">anyopaque</span><span class=\"w\"> </span><span class=\"p\">{}</span>\n\n<span class=\"kr\">pub</span><span class=\"w\"> </span><span class=\"kr\">const</span><span class=\"w\"> </span><span class=\"n\">Value</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kr\">extern</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">kind</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ValueKind</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">of</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ValueUnion</span><span class=\"p\">,</span>\n<span class=\"p\">}</span>\n\n<span class=\"c1\">// wasmtime/val.h: wasmtime_valunion_t</span>\n<span class=\"kr\">pub</span><span class=\"w\"> </span><span class=\"kr\">const</span><span class=\"w\"> </span><span class=\"n\">ValueUnion</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kr\">extern</span><span class=\"w\"> </span><span class=\"k\">union</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"kt\">i32</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"kt\">i64</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">i64</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"kt\">f32</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">f32</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"kt\">f64</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">f64</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">anyref</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">u128</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">externref</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">u128</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">funcref</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">u128</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">v128</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">16</span><span class=\"p\">]</span><span class=\"kt\">u8</span><span class=\"p\">,</span>\n<span class=\"p\">};</span>\n\n<span class=\"c1\">// wasmtime/val.h: wasmtime_valkind_t</span>\n<span class=\"kr\">pub</span><span class=\"w\"> </span><span class=\"kr\">const</span><span class=\"w\"> </span><span class=\"n\">ValueKind</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">enum</span><span class=\"p\">(</span><span class=\"kt\">u8</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"kt\">i64</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"kt\">f32</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"kt\">f64</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">v128</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">funcref</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">externref</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">anyref</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"p\">,</span>\n<span class=\"p\">};</span>\n</code></pre></div><br>\n</p>\n</blockquote>",
        "id": 505154859,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1741790765
    },
    {
        "content": "<p>TheWaWaR edited a <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10381#issuecomment-2718130136\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10381\">issue #10381</a>:</p>\n<blockquote>\n<p>My problem is the callback function registered with <code>wasmtime_linker_define_func</code>, the <code>params</code>/<code>results</code> can't read correctly with my zig code. Even the second param's <code>kind</code> field is incorrect. (other arguments in the callback function is ok.)</p>\n<p><div class=\"codehilite\" data-code-language=\"Zig\"><pre><span></span><code><span class=\"kr\">pub</span><span class=\"w\"> </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"n\">getKeyboardState</span><span class=\"p\">(</span>\n<span class=\"w\">    </span><span class=\"n\">env</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">anyopaque</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">caller</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"n\">anyopaque</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">args</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"o\">*</span><span class=\"p\">]</span><span class=\"kr\">const</span><span class=\"w\"> </span><span class=\"n\">Value</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">nargs</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">usize</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">results</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"o\">*</span><span class=\"p\">]</span><span class=\"n\">Value</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">nresults</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">usize</span><span class=\"p\">,</span>\n<span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">callconv</span><span class=\"p\">(.</span><span class=\"n\">C</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">?*</span><span class=\"n\">anyopaque</span><span class=\"w\"> </span><span class=\"p\">{}</span>\n\n<span class=\"kr\">pub</span><span class=\"w\"> </span><span class=\"kr\">const</span><span class=\"w\"> </span><span class=\"n\">Value</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kr\">extern</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">kind</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ValueKind</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">of</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"n\">ValueUnion</span><span class=\"p\">,</span>\n<span class=\"p\">}</span>\n\n<span class=\"c1\">// wasmtime/val.h: wasmtime_valunion_t</span>\n<span class=\"kr\">pub</span><span class=\"w\"> </span><span class=\"kr\">const</span><span class=\"w\"> </span><span class=\"n\">ValueUnion</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kr\">extern</span><span class=\"w\"> </span><span class=\"k\">union</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"kt\">i32</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"kt\">i64</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">i64</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"kt\">f32</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">f32</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"kt\">f64</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">f64</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">anyref</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">u128</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">externref</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">u128</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">funcref</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"kt\">u128</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">v128</span><span class=\"o\">:</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">16</span><span class=\"p\">]</span><span class=\"kt\">u8</span><span class=\"p\">,</span>\n<span class=\"p\">};</span>\n\n<span class=\"c1\">// wasmtime/val.h: wasmtime_valkind_t</span>\n<span class=\"kr\">pub</span><span class=\"w\"> </span><span class=\"kr\">const</span><span class=\"w\"> </span><span class=\"n\">ValueKind</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">enum</span><span class=\"p\">(</span><span class=\"kt\">u8</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"kt\">i64</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"kt\">f32</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"kt\">f64</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">v128</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">4</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">funcref</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">externref</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">6</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">anyref</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">7</span><span class=\"p\">,</span>\n<span class=\"p\">};</span>\n</code></pre></div><br>\n</p>\n</blockquote>",
        "id": 505155291,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1741790863
    },
    {
        "content": "<p>TheWaWaR <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10381#issuecomment-2718166455\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10381\">issue #10381</a>:</p>\n<blockquote>\n<p>I have tried print the value in <code>c_callback_to_rust_fn</code>, <code>params.as_ptr().addr()</code> matched the value in my zig code, so I guess it's a problem of data structure definition.</p>\n</blockquote>",
        "id": 505156985,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1741791214
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10381#issuecomment-2718169356\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10381\">issue #10381</a>:</p>\n<blockquote>\n<p>Sorry but I'm not familiar enough with Zig to know what I'm looking at there. Can you reduce your problem to being expressed in terms of the C API? One thing I see is that the definition of <code>ValueUnion</code> probably isn't correct sice the alignment of <code>u128</code> isn't the same as <code>wasmtime_func_t</code>.</p>\n<p>Otherwise if you're using Zig there aren't official bindings to Wasmtime available in Zig so you're going to be kind of on your own for support. If you would like support here you'll most likely need to frame your problem in terms of C as opposed to Zig as otherwise you're unlikely to be able to get much help.</p>\n</blockquote>",
        "id": 505157308,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1741791270
    },
    {
        "content": "<p>TheWaWaR edited a <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10381#issuecomment-2718166455\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10381\">issue #10381</a>:</p>\n<blockquote>\n<p>I have tried print the value in <code>c_callback_to_rust_fn</code>:</p>\n<ul>\n<li>The type/value in <code>vals</code> before passing into callback function is correct.</li>\n<li><code>params.as_ptr().addr()</code> matched the value in my zig code<br>\nso I guess it's a problem of data structure definition.</li>\n</ul>\n</blockquote>",
        "id": 505157383,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1741791291
    },
    {
        "content": "<p>TheWaWaR edited a <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10381#issuecomment-2718166455\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10381\">issue #10381</a>:</p>\n<blockquote>\n<p>I have tried print the value in <code>c_callback_to_rust_fn</code>:</p>\n<ul>\n<li>The type/value in <code>vals</code> before passing into callback function is correct.</li>\n<li><code>params.as_ptr().addr()</code> matched the value in my zig code<br>\n*<br>\nso I guess it's a problem of data structure definition.</li>\n</ul>\n</blockquote>",
        "id": 505157435,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1741791301
    },
    {
        "content": "<p>TheWaWaR edited a <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10381#issuecomment-2718166455\">comment</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10381\">issue #10381</a>:</p>\n<blockquote>\n<p>I have tried print the value in <code>c_callback_to_rust_fn</code>:</p>\n<ul>\n<li>The type/value in <code>vals</code> before passing into callback function is correct.</li>\n<li><code>params.as_ptr().addr()</code> matched the value in my zig code</li>\n</ul>\n<p>so I guess it's a problem of data structure definition.</p>\n</blockquote>",
        "id": 505157497,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1741791309
    },
    {
        "content": "<p>TheWaWaR closed <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10381\">issue #10381</a>:</p>\n<blockquote>\n<p>The <code>wasmtime_func_t</code> in <code>wasmtime /extern.h</code> is</p>\n<div class=\"codehilite\" data-code-language=\"C\"><pre><span></span><code><span class=\"k\">typedef</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">wasmtime_func</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"kt\">uint64_t</span><span class=\"w\"> </span><span class=\"n\">store_id</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"kt\">size_t</span><span class=\"w\"> </span><span class=\"n\">__private</span><span class=\"p\">;</span>\n<span class=\"p\">}</span><span class=\"w\"> </span><span class=\"n\">wasmtime_func_t</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>But in rust code (crates/c-api/src/val.rs):</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">#[repr(C)]</span>\n<span class=\"cp\">#[derive(Clone, Copy)]</span>\n<span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">union</span><span class=\"w\"> </span><span class=\"nc\">wasmtime_func_t</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">store_id</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">u64</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">func</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">Func</span><span class=\"p\">,</span>\n<span class=\"p\">}</span>\n\n<span class=\"cp\">#[derive(Copy, Clone, Debug)]</span>\n<span class=\"cp\">#[repr(transparent)]</span><span class=\"w\"> </span><span class=\"c1\">// here for the C API</span>\n<span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">Func</span><span class=\"p\">(</span><span class=\"n\">Stored</span><span class=\"o\">&lt;</span><span class=\"n\">FuncData</span><span class=\"o\">&gt;</span><span class=\"p\">);</span>\n\n<span class=\"cp\">#[repr(C)]</span><span class=\"w\"> </span><span class=\"c1\">// used by reference in the C API, also in `wasmtime_func_t`.</span>\n<span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">Stored</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">store_id</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">StoreId</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">index</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">usize</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">_marker</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">marker</span><span class=\"p\">::</span><span class=\"n\">PhantomData</span><span class=\"o\">&lt;</span><span class=\"k\">fn</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">T</span><span class=\"o\">&gt;</span><span class=\"p\">,</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>The size of wasmtime_func_t in C is 16 bytes, but the size in rust is 24 bytes, which include 2 <code>store_id</code> fields.</p>\n<p>As a consequence, the type <code>wasmtime_val_union</code> in Rust can't align with the type <code>wasmtime_valunion_t</code> in C.</p>\n</blockquote>",
        "id": 505185036,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1741796741
    },
    {
        "content": "<p>TheWaWaR <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10381#issuecomment-2718447160\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10381\">issue #10381</a>:</p>\n<blockquote>\n<p>I tested it in C, it's ok. You are right, I think the problem is the alignment of <code>u128</code>.</p>\n</blockquote>",
        "id": 505185038,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1741796742
    }
]
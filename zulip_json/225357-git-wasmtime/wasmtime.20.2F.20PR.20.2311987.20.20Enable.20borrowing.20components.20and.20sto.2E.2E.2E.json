[
    {
        "content": "<p><strong>alexcrichton</strong> requested <a href=\"https://github.com/fitzgen\">fitzgen</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11987\">PR #11987</a>.</p>",
        "id": 553957811,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1762375014
    },
    {
        "content": "<p>alexcrichton opened <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11987\">PR #11987</a> from <code>alexcrichton:less-clone</code> to <code>bytecodealliance:main</code>:</p>\n<blockquote>\n<p>This commit adds a new, safe, function to the <code>Instance</code> type for<br>\ninternal use in Wasmtime which enables simultaneously borrowing the<br>\n<code>Component</code>-within-the-<code>Instance</code> as well as the original store at the<br>\nsame time. This is not possible to do in safe Rust when the store is<br>\nmutable and must be implemented with <code>unsafe</code> code.</p>\n<p>The motivation for this commit is performance. In <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11974\">https://github.com/bytecodealliance/wasmtime/issues/11974</a> it was<br>\ndiscovered that the addition of a single <code>Arc::clone</code> was enough to<br>\nreduce throughput in the embedding by 20%. While <code>Arc::clone</code> is<br>\ngenerally cheap I can see how a \"contended\" <code>Arc::clone</code> could get quite<br>\nexpensive. This particular benchmark was running multiple instances of<br>\nthe same component across multiple threads which were all doing many<br>\nhost calls. Each host call, after the refactoring of <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10959\">https://github.com/bytecodealliance/wasmtime/pull/10959</a>, contained<br>\nan <code>Arc::clone</code> to the component itself. This in turn led to many<br>\nthreads constantly incrementing/decrementing the <code>Arc::clone</code> count of<br>\nthe same <code>Arc</code> instance.</p>\n<p>At a high level this clone is not necessary. The component lives within<br>\nthe store and cannot be mutated/deleted during execution. Safe Rust,<br>\nhowever, forbids access to the component and mutably using the store at<br>\nthe same time. Thus, this helper function enters the picture. The goal<br>\nhere is to remove the <code>Arc::clone</code> calls without requiring major surgery<br>\nor such to refactor the implementations of various functions throughout<br>\nWasmtime. The <code>unsafe</code> block used to implement this function documents<br>\nmore rationale as to why this should be safe.</p>\n<p>Closes #11974</p>\n</blockquote>",
        "id": 553957812,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1762375014
    },
    {
        "content": "<p><strong>alexcrichton</strong> requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers\">wasmtime-core-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11987\">PR #11987</a>.</p>",
        "id": 553957813,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1762375014
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11987#issuecomment-3493288007\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11987\">PR #11987</a>:</p>\n<blockquote>\n<p>Note that this is built on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11986\">https://github.com/bytecodealliance/wasmtime/pull/11986</a>, so only the second commit is relevant here.</p>\n</blockquote>",
        "id": 553957871,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1762375035
    },
    {
        "content": "<p>fitzgen submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11987#pullrequestreview-3435596966\">PR review</a>:</p>\n<blockquote>\n<p>Do we have tests that run under MIRI that cover this?</p>\n</blockquote>",
        "id": 554388896,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1762539597
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11987#discussion_r2504896179\">PR review comment</a>:</p>\n<blockquote>\n<p><div class=\"codehilite\" data-code-language=\"suggestion\"><pre><span></span><code>        // within a component instance, within a store, to be deallocated or mutated while\n        // a store is in use. Consequently it should be safe to simultaneously\n</code></pre></div><br>\n</p>\n</blockquote>",
        "id": 554388899,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1762539598
    },
    {
        "content": "<p>fitzgen submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11987#pullrequestreview-3435601557\">PR review</a>.</p>",
        "id": 554388967,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1762539616
    },
    {
        "content": "<p>alexcrichton updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11987\">PR #11987</a>.</p>",
        "id": 554403062,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1762544147
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11987#issuecomment-3504539888\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11987\">PR #11987</a>:</p>\n<blockquote>\n<p>We do indeed! There are a number of tests in <code>tests/all/pulley.rs</code> run under miri which do host calls which should exercise these paths.</p>\n</blockquote>",
        "id": 554403348,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1762544255
    },
    {
        "content": "<p>alexcrichton has enabled auto merge for <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11987\">PR #11987</a>.</p>",
        "id": 554403373,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1762544261
    },
    {
        "content": "<p>alexcrichton merged <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11987\">PR #11987</a>.</p>",
        "id": 554408517,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1762546412
    }
]
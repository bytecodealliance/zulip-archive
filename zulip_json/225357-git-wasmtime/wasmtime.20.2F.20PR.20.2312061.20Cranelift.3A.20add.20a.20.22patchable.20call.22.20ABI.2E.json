[
    {
        "content": "<p>cfallin opened <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12061\">PR #12061</a> from <code>cfallin:patchable-abi-is-happy-to-preserve-all-your-registers</code> to <code>bytecodealliance:main</code>:</p>\n<blockquote>\n<p>This ABI is intended for use in scenarios where we want a very lightweight callsite that can be turned on and off by patching in one instruction. (The actual patchable call instruction is not in this PR; that will be a separate PR.)</p>\n<p>The idea is that we define a call to clobber <em>no</em> registers -- not even the arguments! And we restrict signatures such that on all of our supported architectures, all arguments go into registers only. Those two requirements together mean that all callsites for this ABI should have only a raw call instruction, with no loads/stores to stackslots; and have the minimum possible impact on regalloc, by only imposing constraints on args to ensure they are in certain registers but not altering those registers.</p>\n<p>Given this, we could implement, e.g., breakpoints with patchable callsites (off by default) at every sequence point in compiled code. In a typical use-case with Wasmtime-compiled Wasm, that would put a bunch of uses of vmctx constrained to the first argument register in every code path, but vmctx likely already sits there most of the time anyway (for any call to other Wasm functions or for libcalls). Thus, the impact is just the one instruction and nothing else.</p>\n<p>This PR adds the calling convention itself and tests that show that <em>two</em> consecutive callsites can be compiled with no register setup re-occurring from one call to the next (thus demonstrating no clobbers).</p>\n<p>&lt;!--<br>\nPlease make sure you include the following information:</p>\n<ul>\n<li>\n<p>If this work has been discussed elsewhere, please include a link to that<br>\n  conversation. If it was discussed in an issue, just mention \"issue #...\".</p>\n</li>\n<li>\n<p>Explain why this change is needed. If the details are in an issue already,<br>\n  this can be brief.</p>\n</li>\n</ul>\n<p>Our development process is documented in the Wasmtime book:<br>\n<a href=\"https://docs.wasmtime.dev/contributing-development-process.html\">https://docs.wasmtime.dev/contributing-development-process.html</a></p>\n<p>Please ensure all communication follows the code of conduct:<br>\n<a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md\">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>\n--&gt;</p>\n</blockquote>",
        "id": 558550565,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1763682473
    },
    {
        "content": "<p><strong>cfallin</strong> requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers\">wasmtime-compiler-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12061\">PR #12061</a>.</p>",
        "id": 558550567,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1763682474
    },
    {
        "content": "<p><strong>cfallin</strong> requested <a href=\"https://github.com/alexcrichton\">alexcrichton</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12061\">PR #12061</a>.</p>",
        "id": 558550568,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1763682474
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12061#issuecomment-3560692554\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12061\">PR #12061</a>:</p>\n<blockquote>\n<p>(Switching to draft actually -- want to implement the callee side in this one too, sorry)</p>\n</blockquote>",
        "id": 558551119,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1763682787
    },
    {
        "content": "<p>cfallin updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12061\">PR #12061</a>.</p>",
        "id": 558555041,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1763684809
    },
    {
        "content": "<p><strong>cfallin</strong> has marked <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12061\">PR #12061</a> as ready for review.</p>",
        "id": 558555072,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1763684821
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12061#issuecomment-3560768217\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12061\">PR #12061</a>:</p>\n<blockquote>\n<p>OK, good to go now!</p>\n</blockquote>",
        "id": 558555109,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1763684835
    },
    {
        "content": "<p>cfallin updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12061\">PR #12061</a>.</p>",
        "id": 558576746,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1763700844
    },
    {
        "content": "<p>cfallin updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12061\">PR #12061</a>.</p>",
        "id": 558591641,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1763709449
    },
    {
        "content": "<p><strong>cfallin</strong> requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers\">wasmtime-core-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12061\">PR #12061</a>.</p>",
        "id": 558591643,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1763709449
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12061#pullrequestreview-3491509282\">PR review</a>.</p>",
        "id": 558592228,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1763709696
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12061#discussion_r2548789498\">PR review comment</a>:</p>\n<blockquote>\n<p>One thing to note here: riscv64 now counts upward rather than downward when saving clobbers, because it has to worry about 16-aligning vector regs (which were never previously callee-saves) and this is simpler to do (and to match the size computation) with a forward order. This is why a bunch of riscv64 tests were reblessed.</p>\n<p>Pulley copied this logic but (i) I didn't want to alter the special \"pulley-managed clobber saves\" stuff and (ii) I think its vector stores/loads allow unaligned access, unlike riscv64 in the base case.</p>\n</blockquote>",
        "id": 558592230,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1763709696
    },
    {
        "content": "<p>alexcrichton submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12061#pullrequestreview-3492949917\">PR review</a>.</p>",
        "id": 558672302,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1763735168
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12061#discussion_r2549904305\">PR review comment</a>:</p>\n<blockquote>\n<p>Question for you, which I realize is basically unrelated to this PR -- this function feels like it's duplicated logic relative to <code>get_regs_clobbered_by_call</code> where this more-or-less returns the inverse of the other. How come in the backends this has its own implementation vs having one function delegate to the other?</p>\n</blockquote>",
        "id": 558672306,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1763735168
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12061#discussion_r2549915488\">PR review comment</a>:</p>\n<blockquote>\n<p>Similar question to aarch64 (or feel free to resolve with no comment if you respond to aarch64)</p>\n</blockquote>",
        "id": 558672307,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1763735169
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12061#discussion_r2549912951\">PR review comment</a>:</p>\n<blockquote>\n<p>Similar to my question about aarch64, would it be possible to implement this method in terms of <code>get_regs_clobbered_by_call</code>? </p>\n</blockquote>",
        "id": 558672309,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1763735169
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12061#discussion_r2549916103\">PR review comment</a>:</p>\n<blockquote>\n<p>Similar question to aarch64 (or feel free to resolve with no comment if you respond to aarch64)</p>\n</blockquote>",
        "id": 558672310,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1763735169
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12061#discussion_r2549917693\">PR review comment</a>:</p>\n<blockquote>\n<p>Similar question to aarch64 (or feel free to resolve with no comment if you respond to aarch64)</p>\n</blockquote>",
        "id": 558672311,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1763735169
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12061#discussion_r2549908825\">PR review comment</a>:</p>\n<blockquote>\n<p>Is it worth clarifying here that the return register, if applicable, is clobbered? I realize that's sort of like a \"system\" register which isn't tracked by regalloc, but I believe that's the one register that's clobbered with this ABI? (not that it matters, we always save it in the prologue anyway)</p>\n</blockquote>",
        "id": 558672312,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1763735169
    },
    {
        "content": "<p>fitzgen submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12061#pullrequestreview-3494044160\">PR review</a>.</p>",
        "id": 558734888,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1763752387
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12061#discussion_r2550723523\">PR review comment</a>:</p>\n<blockquote>\n<p>Okay great, this is exactly what I was hoping would be here. We should document these constraints in the <code>ir::CallConv</code> doc comments for cranelift embedders tho.</p>\n</blockquote>",
        "id": 558734889,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1763752387
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12061#discussion_r2550720230\">PR review comment</a>:</p>\n<blockquote>\n<p>Alternatively it probably makes sense to restrict this calling convention to only as many arguments as fit in registers (portably?) and disallow returns. We can enforce this in CLIF validation.</p>\n</blockquote>",
        "id": 558734891,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1763752387
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12061#discussion_r2550752224\">PR review comment</a>:</p>\n<blockquote>\n<p>Right, yep, this is documented in this doc-comment (see 11 lines up): \"only up to four arguments of integer type, and no return values\".</p>\n</blockquote>",
        "id": 558736903,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1763753148
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12061#pullrequestreview-3494089423\">PR review</a>.</p>",
        "id": 558736904,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1763753148
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12061#pullrequestreview-3494092631\">PR review</a>.</p>",
        "id": 558737088,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1763753211
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12061#discussion_r2550754431\">PR review comment</a>:</p>\n<blockquote>\n<p>Yes, I believe it is documented: from line 55 in <code>call_conv.rs</code> I have</p>\n<p><div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">      </span><span class=\"sd\">/// The ABI is based on the native register-argument ABI on each</span>\n<span class=\"w\">      </span><span class=\"sd\">/// respective platform, but puts severe restrictions on allowable</span>\n<span class=\"w\">      </span><span class=\"sd\">/// signatures: only up to four arguments of integer type, and no</span>\n<span class=\"w\">      </span><span class=\"sd\">/// return values. It does not support tail-calls, and disallows</span>\n<span class=\"w\">      </span><span class=\"sd\">/// any extension modes on arguments.</span>\n</code></pre></div><br>\n</p>\n</blockquote>",
        "id": 558737089,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1763753211
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12061#pullrequestreview-3494102730\">PR review</a>.</p>",
        "id": 558737660,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1763753387
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12061#discussion_r2550761197\">PR review comment</a>:</p>\n<blockquote>\n<p>That's a great question! They are mostly but not entirely the same: witness the beauty that is the aarch64 calling convention, where it is specified that <em>half</em> of the vector registers (the low/f64 half) is callee-saved while half is caller-saved. The result of that is that we have the special \"caller and callee conventions match so ignore callsites\" logic that gives us the right code in the common case, but we have to conservatively over-approximate otherwise.</p>\n<p>In non-aarch64 cases I agree it could be refactored, though that's another cleanup project I'd rather defer till after this PR if that's OK :-)</p>\n</blockquote>",
        "id": 558737661,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1763753387
    },
    {
        "content": "<p>fitzgen submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12061#pullrequestreview-3494187182\">PR review</a>.</p>",
        "id": 558742428,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1763755273
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12061#discussion_r2550828587\">PR review comment</a>:</p>\n<blockquote>\n<p>D'oh -- thanks!</p>\n</blockquote>",
        "id": 558742430,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1763755274
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12061#issuecomment-3565252107\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12061\">PR #12061</a>:</p>\n<blockquote>\n<p>(There is something weird going on with riscv64 which I spent a bit of time trying to debug with qemu+gdb today -- will resolve that before this moves further)</p>\n</blockquote>",
        "id": 558774558,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1763775266
    },
    {
        "content": "<p>cfallin updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12061\">PR #12061</a>.</p>",
        "id": 558776225,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1763776955
    },
    {
        "content": "<p>cfallin updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12061\">PR #12061</a>.</p>",
        "id": 558776553,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1763777257
    },
    {
        "content": "<p>cfallin updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12061\">PR #12061</a>.</p>",
        "id": 558776611,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1763777312
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12061#issuecomment-3565327603\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12061\">PR #12061</a>:</p>\n<blockquote>\n<p>riscv64 issue was some weirdness with non-aligned stackslot area sizes causing problems with the new alignment of clobber-saves with the bottom-up ordering. I've reverted the changes that flipped the order to bottom-up.</p>\n</blockquote>",
        "id": 558776898,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1763777645
    },
    {
        "content": "<p>cfallin has enabled auto merge for <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12061\">PR #12061</a>.</p>",
        "id": 558777052,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1763777855
    },
    {
        "content": "<p>cfallin merged <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12061\">PR #12061</a>.</p>",
        "id": 558778911,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1763780096
    }
]
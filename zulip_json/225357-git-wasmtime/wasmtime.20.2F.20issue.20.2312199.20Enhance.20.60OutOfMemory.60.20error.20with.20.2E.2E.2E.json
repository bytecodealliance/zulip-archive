[
    {
        "content": "<p>alexcrichton opened <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12199\">issue #12199</a>:</p>\n<blockquote>\n<p>There's some more discussion <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12163#discussion_r2636121426\">here</a>, but I personally think we should strive to extend this error with the contextual number of bytes that were attempted to be allocated. Implementation-wise this will be tricky, however, so it'll require deliberate design.</p>\n</blockquote>",
        "id": 565058269,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1766431063
    },
    {
        "content": "<p><a href=\"https://github.com/alexcrichton\">alexcrichton</a> added the wasmtime:api label to <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12199\">Issue #12199</a>.</p>",
        "id": 565058270,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1766431063
    },
    {
        "content": "<p>fitzgen <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12199#issuecomment-3745778258\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12199\">issue #12199</a>:</p>\n<blockquote>\n<p>How does this sound?</p>\n<ul>\n<li>Bitpack the size and layout into the <code>&amp;OutOfMemory</code> pointer.</li>\n<li>Add a <code>pub fn OutOfMemory::layout(&amp;self) -&gt; Layout</code> method that reads the bitpacked data.</li>\n<li>Do _not_ have a public ctor for <code>OutOfMemory</code> (and I guess also remove the clone/copy derives?)</li>\n<li>Instead have <code>pub fn Error::out_of_memory(layout: Layout) -&gt; Error</code>, which does the bitpacking and wrapping up into an <code>Error</code>.</li>\n</ul>\n<p>So with this setup, you are generally only ever dealing with <code>&amp;OutOfMemory</code> or an <code>Error</code> wrapping an <code>OutOfMemory</code>, but not an owned <code>OutOfMemory</code> that isn't inside an <code>Error</code>. So you can still ask things like <code>error.is&lt;OutOfMemory&gt;()</code> and do <code>error.downcast_ref::&lt;OutOfMemory&gt;().unwrap().layout()</code> and all that, which is / will be (probably?) the most common uses of <code>OutOfMemory</code>.</p>\n<p>However, the one tricky thing is that <code>error.downcast::&lt;OutOfMemory&gt;().unwrap()</code> will give you an owned <code>OutOfMemory</code>, but because it isn't a pointer into an <code>Error</code>, you will lose the bitpacked layout info, and so <code>OutOfMemory::layout</code> will need to return an option or a zero-sized layout or something. Perhaps even worse is that we have no guarantee that taking a reference to an owned <code>OutOfMemory</code> will produce a pointer that won't \"accidentally\" have non-zero data in our bitpacked areas, so we could just return arbitrary (and incorrect) layouts in this case.</p>\n<p>FWIW, we could also avoid this one last edge case by moving the <code>layout</code> method to <code>Error</code>, so you can only get the layout info from an <code>Error</code> that wraps an <code>OutOfMemory</code> (presumably; we'd still have an option for the non-OOM <code>Error</code> case, but we wouldn't have to worry about arbitrary/incorrect layout data). This is probably the way to go, despite the API being a bit funkier...</p>\n</blockquote>",
        "id": 567833794,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768328970
    },
    {
        "content": "<p>fitzgen <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12199#issuecomment-3745801801\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12199\">issue #12199</a>:</p>\n<blockquote>\n<blockquote>\n<p>However, the one tricky thing is that <code>error.downcast::&lt;OutOfMemory&gt;().unwrap()</code> will give you an owned <code>OutOfMemory</code></p>\n</blockquote>\n<p>We could also just make <code>error.downcast::&lt;OutOfMemory&gt;()</code> always fail too. This might actually be the best option, since that way we can use the bitpacked layout information inside the display and debug impls for <code>OutOfMemory</code>, which having the layout accessors on <code>Error</code> wouldn't allow.</p>\n</blockquote>",
        "id": 567834911,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768329367
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12199#issuecomment-3745814072\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12199\">issue #12199</a>:</p>\n<blockquote>\n<p>Wouldn't we want a public constructor of <code>OutOfMemory</code> for collection-based APIs which'd return <code>Result&lt;T, OutOfMemory&gt;</code>?</p>\n</blockquote>",
        "id": 567835436,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768329575
    },
    {
        "content": "<p>fitzgen <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12199#issuecomment-3745823899\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12199\">issue #12199</a>:</p>\n<blockquote>\n<blockquote>\n<p>Wouldn't we want a public constructor of <code>OutOfMemory</code> for collection-based APIs which'd return <code>Result&lt;T, OutOfMemory&gt;</code>?</p>\n</blockquote>\n<p>Yeah I just ran into this as I started investigating further.</p>\n<p>New idea: make <code>OutOfMemory</code> a newtype wrapper around <code>Error</code> where the wrapped <code>Error</code> is guaranteed to be bitpacked with layout info and have a discriminant appropriately set to mark that it is not a boxed dyn error (as it already does today).</p>\n</blockquote>",
        "id": 567835775,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768329715
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12199#issuecomment-3745844730\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12199\">issue #12199</a>:</p>\n<blockquote>\n<p>I may not quite be following something, or I think I'm missing something? I would expect <code>OutOfMemory</code> to contain <code>NonZero&lt;usize&gt;</code> and then <code>Error</code>'s internal <code>NonNull&lt;T&gt;</code> which it contains would be transmuted to <code>NonZero&lt;usize&gt;</code> for getting <code>&amp;OutOfMemory</code> or something like that. I also don't think we can deal with a full <code>Layout</code> (size + align) and can only deal with the size for now, I don't know how to bitpack the alignment into the payload.</p>\n</blockquote>",
        "id": 567836628,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768329995
    },
    {
        "content": "<p>fitzgen <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12199#issuecomment-3745897436\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12199\">issue #12199</a>:</p>\n<blockquote>\n<blockquote>\n<p>I would expect <code>OutOfMemory</code> to contain <code>NonZero&lt;usize&gt;</code> and then <code>Error</code>'s internal <code>NonNull&lt;T&gt;</code> which it contains would be transmuted to <code>NonZero&lt;usize&gt;</code> for getting <code>&amp;OutOfMemory</code> or something like that.</p>\n</blockquote>\n<p>Yeah, this is basically equivalent to my newtype idea.</p>\n<blockquote>\n<p>I also don't think we can deal with a full <code>Layout</code> (size + align) and can only deal with the size for now, I don't know how to bitpack the alignment into the payload.</p>\n</blockquote>\n<p>I think you are correct. I was thinking that, because the alloc size is limited to <code>isize::MAX</code> we had half the bits for the layout, but we have half the <code>usize</code> <em>range</em> which is only one bit. Mixing up domains.</p>\n</blockquote>",
        "id": 567838425,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768330692
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12199#issuecomment-3745924403\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12199\">issue #12199</a>:</p>\n<blockquote>\n<p>On second thought -- I don't think that <code>&amp;NonNull&lt;T&gt;</code> can be safely coerced to <code>&amp;NonZero&lt;usize&gt;</code>. What with provenance and CHERI I suspect that's an explicitly unsupported operation, and that might sink this entire endeavour</p>\n</blockquote>",
        "id": 567839256,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768330966
    },
    {
        "content": "<p>fitzgen <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12199#issuecomment-3745933623\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12199\">issue #12199</a>:</p>\n<blockquote>\n<p>We can have <code>OutOfMemory</code> wrap a <code>NonNull&lt;()&gt;</code> or whatever and bit pack in the address</p>\n</blockquote>",
        "id": 567839485,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768331051
    },
    {
        "content": "<p>fitzgen <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12199#issuecomment-3745938492\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12199\">issue #12199</a>:</p>\n<blockquote>\n<p>(Or be a newtype of <code>Error</code>, as originally suggested)</p>\n</blockquote>",
        "id": 567839611,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768331094
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12199#issuecomment-3745964849\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12199\">issue #12199</a>:</p>\n<blockquote>\n<p>Good point, and ok yeah that seems reasonable (<code>struct OutOfMemory(Error)</code>) with some extra guarantees perhaps or something like that<br>\n</p>\n</blockquote>",
        "id": 567840178,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768331300
    },
    {
        "content": "<p>fitzgen closed <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12199\">issue #12199</a>:</p>\n<blockquote>\n<p>There's some more discussion <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12163#discussion_r2636121426\">here</a>, but I personally think we should strive to extend this error with the contextual number of bytes that were attempted to be allocated. Implementation-wise this will be tricky, however, so it'll require deliberate design.</p>\n</blockquote>",
        "id": 568074051,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768422448
    }
]
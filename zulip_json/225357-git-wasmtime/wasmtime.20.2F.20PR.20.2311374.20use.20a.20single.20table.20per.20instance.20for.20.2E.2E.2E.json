[
    {
        "content": "<p><strong>dicej</strong> requested <a href=\"https://github.com/alexcrichton\">alexcrichton</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11374\">PR #11374</a>.</p>",
        "id": 532386602,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1754086704
    },
    {
        "content": "<p>dicej opened <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11374\">PR #11374</a> from <code>dicej:all-handles-in-same-table</code> to <code>bytecodealliance:main</code>:</p>\n<blockquote>\n<p>Per <a href=\"https://github.com/WebAssembly/component-model/pull/513\">https://github.com/WebAssembly/component-model/pull/513</a>, the spec now puts resources, waitables, waitable sets, subtasks, and error contexts in the same table per instance.  This updates the implementation to match.</p>\n<ul>\n<li>\n<p>Combine the <code>ResourceTable</code> and <code>StateTable</code> data structures into a single <code>HandleTable</code> structure</p>\n</li>\n<li>\n<p>Rename <code>ComponentInstance::instance_resource_tables</code> to <code>instance_handle_tables</code></p>\n</li>\n<li>\n<p>Remove <code>ConcurrentState::waitable_tables</code> and <code>error_context_tables</code> in favor of the above</p>\n</li>\n<li>\n<p>Move various associated functions from <code>ConcurrentState</code> to <code>ComponentInstance</code> so they can access <code>instance_resource_tables</code></p>\n</li>\n</ul>\n<p>While I was doing table-related things, I also updated <code>concurrent::Table::new</code> to reserve the zero handle to mean \"invalid\".  This won't affect what the guest sees in any way, but it allows us to use <code>TableId::new(0)</code> to invalidate host-owned handles in e.g. <code>{Stream,Future}{Reader,Writer}::close</code>.</p>\n<p>Fixes #11189</p>\n<p>&lt;!--<br>\nPlease make sure you include the following information:</p>\n<ul>\n<li>\n<p>If this work has been discussed elsewhere, please include a link to that<br>\n  conversation. If it was discussed in an issue, just mention \"issue #...\".</p>\n</li>\n<li>\n<p>Explain why this change is needed. If the details are in an issue already,<br>\n  this can be brief.</p>\n</li>\n</ul>\n<p>Our development process is documented in the Wasmtime book:<br>\n<a href=\"https://docs.wasmtime.dev/contributing-development-process.html\">https://docs.wasmtime.dev/contributing-development-process.html</a></p>\n<p>Please ensure all communication follows the code of conduct:<br>\n<a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md\">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>\n--&gt;</p>\n</blockquote>",
        "id": 532386603,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1754086705
    },
    {
        "content": "<p><strong>dicej</strong> requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers\">wasmtime-core-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11374\">PR #11374</a>.</p>",
        "id": 532386604,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1754086705
    },
    {
        "content": "<p>alexcrichton updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11374\">PR #11374</a>.</p>",
        "id": 532980763,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1754423635
    },
    {
        "content": "<p>alexcrichton submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11374#pullrequestreview-3089545532\">PR review</a>:</p>\n<blockquote>\n<p>Thanks! I left one comment below and I also pushed up some refactorings I did as well. Mostly I wanted to move away from \"resources over there async things over here\" in the sense that they were still very distinctly separated and I found it difficult how to use a <code>HandleTable</code> as a result due to having to remember which method to use for which object. Instead now I've refactored it so <code>Slot</code> has a \"more flat\" representation.</p>\n<p>This brings a minor size benefit (slot is 24 bytes, not 32, more is possible with some minor refactoring) but additionally helps encapsulate all the low-level details of handle management. I personally feel like this cleaned up code in <code>concurrent.rs</code> and <code>futures_and_streams.rs</code>. I'd naturally like to double-check you're ok with these refactorings though so lemme know if you feel they don't fit well.</p>\n</blockquote>",
        "id": 532982023,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1754424047
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11374#discussion_r2255216747\">PR review comment</a>:</p>\n<blockquote>\n<p>This method, and the <code>reps_to_indexes</code> field, makes me feel uncomfortable and is something that I would prefer to remove entirely unless we otherwise have good motivation for it. Tracing this backwards I found two uses for this:</p>\n<ol>\n<li>For error-context this is used as the \"make sure we always return the same error-context handle\" logic to reuse the same handle. This is, IMO, a debatable part of the specification and also not something we're shipping with WASIp3. I'd prefer to remove the logic entirely and have an implementation-specific detail that lowers new error-context handles each time. That would remove the error-context dependency on this, keep programs working. In the future if we want this error-context behavior we can reevaluate.</li>\n<li>For delivering an event this is used to do a reverse-lookup from the \"rep\" in the host to the handle that the guest has for the relevant waitable. Would it be possible to store the guest handle inside of the host's \"rep\" (or, rather, the host-state object for this) instead? I'm under the impression that guest-state handles can't be removed while they're being waited on which would mean that it should be safe to store the index on the host temporarily.</li>\n</ol>\n<p>I mostly want to double-check with (2) since I'm less familiar with the code. If you agree with both of the above that would remove the need for this entirely (and <code>reps_to_indexes</code>) which I think would be a good cleanup.</p>\n</blockquote>",
        "id": 532982025,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1754424047
    },
    {
        "content": "<p>dicej submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11374#pullrequestreview-3110976812\">PR review</a>.</p>",
        "id": 533994525,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755009025
    },
    {
        "content": "<p>dicej created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11374#discussion_r2270067177\">PR review comment</a>:</p>\n<blockquote>\n<p>Sounds reasonable; I'll give it a shot.</p>\n</blockquote>",
        "id": 533994526,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755009026
    },
    {
        "content": "<p>dicej <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11374#issuecomment-3179850210\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11374\">PR #11374</a>:</p>\n<blockquote>\n<blockquote>\n<p>I'd naturally like to double-check you're ok with these refactorings though so lemme know if you feel they don't fit well.</p>\n</blockquote>\n<p>LGTM, thanks.</p>\n</blockquote>",
        "id": 534005685,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755012542
    },
    {
        "content": "<p>dicej updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11374\">PR #11374</a>.</p>",
        "id": 534009067,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755013623
    },
    {
        "content": "<p>dicej updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11374\">PR #11374</a>.</p>",
        "id": 534027119,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755020137
    },
    {
        "content": "<p>dicej submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11374#pullrequestreview-3112006131\">PR review</a>.</p>",
        "id": 534027160,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755020159
    },
    {
        "content": "<p>dicej created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11374#discussion_r2270652495\">PR review comment</a>:</p>\n<blockquote>\n<p>I just pushed an update; please let me know what you think.</p>\n</blockquote>",
        "id": 534027161,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755020160
    },
    {
        "content": "<p>alexcrichton submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11374#pullrequestreview-3112057569\">PR review</a>:</p>\n<blockquote>\n<p><span aria-label=\"+1\" class=\"emoji emoji-1f44d\" role=\"img\" title=\"+1\">:+1:</span> </p>\n<p>To clarify though, in the commit message you say:</p>\n<blockquote>\n<p>For <code>error-context</code> handles, the spec requirement that we always lower the same<br>\nhandle for the same <code>error-context</code>, combined with the fact that an<br>\n<code>error-context</code> may be referenced by more than one component instance at a time,<br>\nmeans we still need some general way to convert a host rep plus component index<br>\ninto a handle.  </p>\n</blockquote>\n<p>Is the latter part here still a motivation for this \"local\" reference count? For example if <code>reps_to_indexes</code> were entirely removed then <code>error_context_insert</code> would always create a fresh new handle (a violation of the current spec) but there's still a \"global\" reference count for the cross-component reference count for an error-context. Given that would it be possible to delete <code>reps_to_indexes</code> and have a temporary spec violation while the upstream spec is being sorted out?</p>\n</blockquote>",
        "id": 534029264,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755021188
    },
    {
        "content": "<p>dicej <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11374#issuecomment-3180815518\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11374\">PR #11374</a>:</p>\n<blockquote>\n<blockquote>\n<p><span aria-label=\"+1\" class=\"emoji emoji-1f44d\" role=\"img\" title=\"+1\">:+1:</span></p>\n<p>To clarify though, in the commit message you say:</p>\n<blockquote>\n<p>For <code>error-context</code> handles, the spec requirement that we always lower the same<br>\nhandle for the same <code>error-context</code>, combined with the fact that an<br>\n<code>error-context</code> may be referenced by more than one component instance at a time,<br>\nmeans we still need some general way to convert a host rep plus component index<br>\ninto a handle.</p>\n</blockquote>\n<p>Is the latter part here still a motivation for this \"local\" reference count? For example if <code>reps_to_indexes</code> were entirely removed then <code>error_context_insert</code> would always create a fresh new handle (a violation of the current spec) but there's still a \"global\" reference count for the cross-component reference count for an error-context. Given that would it be possible to delete <code>reps_to_indexes</code> and have a temporary spec violation while the upstream spec is being sorted out?</p>\n</blockquote>\n<p>Looks like the <code>error-context</code> \"same handle\" requirement is no longer part of the spec anyway, so I'll go ahead and remove that.</p>\n</blockquote>",
        "id": 534046387,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755028487
    },
    {
        "content": "<p>dicej updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11374\">PR #11374</a>.</p>",
        "id": 534050056,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755030085
    },
    {
        "content": "<p>dicej has enabled auto merge for <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11374\">PR #11374</a>.</p>",
        "id": 534050085,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755030096
    },
    {
        "content": "<p>dicej merged <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11374\">PR #11374</a>.</p>",
        "id": 534054245,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755032020
    }
]
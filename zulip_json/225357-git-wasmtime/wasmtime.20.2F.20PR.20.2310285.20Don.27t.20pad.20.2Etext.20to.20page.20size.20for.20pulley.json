[
    {
        "content": "<p><strong>posborne</strong> requested <a href=\"https://github.com/pchickey\">pchickey</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10285\">PR #10285</a>.</p>",
        "id": 501649941,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1740431795
    },
    {
        "content": "<p>posborne opened <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10285\">PR #10285</a> from <code>posborne:reduce-cwasm-padding-pulley</code> to <code>bytecodealliance:main</code>:</p>\n<blockquote>\n<p>When targeting pulley we aren't directly emitting executable code in the .text section and we don't have a good idea of the true target page size so we end up with ELF files that can have a significant amount of extra padding around the .text section with no benefit to the consumer.</p>\n<p>The change here aligns with the already present section flag SH_WASMTIME_NOT_EXECUTED.  Padding elimination for the .rodata.wasm section is already handled by the presence/absence of the memory-init-on-cow configuration.</p>\n<p>For a basic wasip1 hello-world rust program with the combination of this patch and <code>-O memory-init-cow=n</code> I saw a reduction in the compiled wasm ELF from 421KB to 189KB with the sections no longer showing as being padded out significantly:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"n\">objdump</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">section</span><span class=\"o\">-</span><span class=\"n\">headers</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"o\">/</span><span class=\"n\">wasm32</span><span class=\"o\">-</span><span class=\"n\">wasip1</span><span class=\"o\">/</span><span class=\"n\">release</span><span class=\"o\">/</span><span class=\"n\">hello</span><span class=\"o\">-</span><span class=\"n\">wasm</span><span class=\"o\">-</span><span class=\"n\">world</span><span class=\"o\">-</span><span class=\"mh\">0x00</span><span class=\"p\">.</span><span class=\"n\">cwasm</span>\n\n<span class=\"n\">target</span><span class=\"o\">/</span><span class=\"n\">wasm32</span><span class=\"o\">-</span><span class=\"n\">wasip1</span><span class=\"o\">/</span><span class=\"n\">release</span><span class=\"o\">/</span><span class=\"n\">hello</span><span class=\"o\">-</span><span class=\"n\">wasm</span><span class=\"o\">-</span><span class=\"n\">world</span><span class=\"o\">-</span><span class=\"mh\">0x00</span><span class=\"p\">.</span><span class=\"n\">cwasm</span><span class=\"p\">:</span><span class=\"w\">       </span><span class=\"nc\">file</span><span class=\"w\"> </span><span class=\"n\">format</span><span class=\"w\"> </span><span class=\"n\">elf64</span><span class=\"o\">-</span><span class=\"n\">littleriscv</span>\n\n<span class=\"n\">Sections</span><span class=\"p\">:</span>\n<span class=\"nc\">Idx</span><span class=\"w\"> </span><span class=\"n\">Name</span><span class=\"w\">              </span><span class=\"n\">Size</span><span class=\"w\">     </span><span class=\"n\">VMA</span><span class=\"w\">              </span><span class=\"n\">Type</span>\n<span class=\"w\">  </span><span class=\"mi\">0</span><span class=\"w\">                   </span><span class=\"mi\">00000000</span><span class=\"w\"> </span><span class=\"mi\">0000000000000000</span>\n<span class=\"w\">  </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"n\">wasmtime</span><span class=\"p\">.</span><span class=\"n\">engine</span><span class=\"w\">  </span><span class=\"mi\">00000353</span><span class=\"w\"> </span><span class=\"mi\">0000000000000000</span><span class=\"w\"> </span><span class=\"n\">DATA</span>\n<span class=\"w\">  </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"n\">wasmtime</span><span class=\"p\">.</span><span class=\"n\">bti</span><span class=\"w\">     </span><span class=\"mi\">00000001</span><span class=\"w\"> </span><span class=\"mi\">0000000000000000</span><span class=\"w\"> </span><span class=\"n\">DATA</span>\n<span class=\"w\">  </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"n\">text</span><span class=\"w\">             </span><span class=\"mi\">00011</span><span class=\"n\">bdc</span><span class=\"w\"> </span><span class=\"mi\">0000000000000000</span>\n<span class=\"w\">  </span><span class=\"mi\">4</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"n\">wasmtime</span><span class=\"p\">.</span><span class=\"n\">addrmap</span><span class=\"w\"> </span><span class=\"mi\">00011</span><span class=\"n\">c5c</span><span class=\"w\"> </span><span class=\"mi\">0000000000000000</span><span class=\"w\"> </span><span class=\"n\">DATA</span>\n<span class=\"w\">  </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"n\">wasmtime</span><span class=\"p\">.</span><span class=\"n\">traps</span><span class=\"w\">   </span><span class=\"mi\">00000</span><span class=\"n\">ae0</span><span class=\"w\"> </span><span class=\"mi\">0000000000000000</span><span class=\"w\"> </span><span class=\"n\">DATA</span>\n<span class=\"w\">  </span><span class=\"mi\">6</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"n\">rodata</span><span class=\"p\">.</span><span class=\"n\">wasm</span><span class=\"w\">      </span><span class=\"mf\">000019e8</span><span class=\"w\"> </span><span class=\"mi\">0000000000000000</span><span class=\"w\"> </span><span class=\"n\">DATA</span>\n<span class=\"w\">  </span><span class=\"mi\">7</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"n\">name</span><span class=\"p\">.</span><span class=\"n\">wasm</span><span class=\"w\">        </span><span class=\"mi\">000027</span><span class=\"n\">a6</span><span class=\"w\"> </span><span class=\"mi\">0000000000000000</span><span class=\"w\"> </span><span class=\"n\">DATA</span>\n<span class=\"w\">  </span><span class=\"mi\">8</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"n\">wasmtime</span><span class=\"p\">.</span><span class=\"n\">info</span><span class=\"w\">    </span><span class=\"mi\">000010</span><span class=\"n\">f9</span><span class=\"w\"> </span><span class=\"mi\">0000000000000000</span><span class=\"w\"> </span><span class=\"n\">DATA</span>\n<span class=\"w\">  </span><span class=\"mi\">9</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"n\">symtab</span><span class=\"w\">           </span><span class=\"mi\">00001788</span><span class=\"w\"> </span><span class=\"mi\">0000000000000000</span>\n<span class=\"w\"> </span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"n\">strtab</span><span class=\"w\">           </span><span class=\"mi\">000040</span><span class=\"n\">f0</span><span class=\"w\"> </span><span class=\"mi\">0000000000000000</span>\n<span class=\"w\"> </span><span class=\"mi\">11</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"n\">shstrtab</span><span class=\"w\">         </span><span class=\"mi\">00000089</span><span class=\"w\"> </span><span class=\"mi\">0000000000000000</span>\n</code></pre></div>\n<p>Addresses #10244, CC @ia0 @tschneidereit </p>\n<hr>\n<p>Feedback very welcome as this is a bit of a starter issue for me within wasmtime.  Things I considered but didn't end up going with with this patch:</p>\n<ul>\n<li>Directly inlining the conditional logic for the text align in the two callsites.</li>\n<li>Using the SH_WASMTIME_NOT_EXECUTED instead of looking at the triple again for the alignment decision.</li>\n<li>Possibly looking to see if it made sense to reuse memory-init-on-cow or some other flagging for this decision rather than using the triple.</li>\n</ul>\n<p>I'm also open to any feedback regarding if there is any additional testing that should be added in tree for this patch</p>\n</blockquote>",
        "id": 501649942,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1740431796
    },
    {
        "content": "<p><strong>posborne</strong> requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers\">wasmtime-core-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10285\">PR #10285</a>.</p>",
        "id": 501649945,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1740431798
    },
    {
        "content": "<p>alexcrichton submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10285#pullrequestreview-2638504604\">PR review</a>:</p>\n<blockquote>\n<p>This all looks great to me, thanks for working on this!</p>\n<p>Using <code>objdump --section-headers</code> also makes me think that we should probably also provide a <code>Config::*</code> option for dropping the <code>.symtab</code>, <code>.strtab</code>, and <code>.shstrtab</code> sections. I don't think we have anything relying on that other than various debugging/perf utilities meaning it should be possible to strip them and still have a functioning <code>*.cwasm</code> binary. </p>\n<p>I'll file an issue about this...</p>\n</blockquote>",
        "id": 501653627,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1740433214
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10285#issuecomment-2699342001\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10285\">PR #10285</a>:</p>\n<blockquote>\n<p>@posborne you were probably busy with <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10321\">https://github.com/bytecodealliance/wasmtime/pull/10321</a> and other work, but in the case that you're stuck debugging the CI failure here I can try to help out if you'd like.</p>\n</blockquote>",
        "id": 503392245,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1741134312
    },
    {
        "content": "<p>posborne <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10285#issuecomment-2699582061\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10285\">PR #10285</a>:</p>\n<blockquote>\n<blockquote>\n<p>@posborne you were probably busy with <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10321\">https://github.com/bytecodealliance/wasmtime/pull/10321</a> and other work, but in the case that you're stuck debugging the CI failure here I can try to help out if you'd like.</p>\n</blockquote>\n<p>Ah, I missed that the checks failed due to a CI failure on this one, so I haven't looked yet.  I'll take a look in depth tomorrow, hopefully won't be too hard to resolve but I'll reach out if it's not making sense.</p>\n</blockquote>",
        "id": 503406119,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1741141226
    },
    {
        "content": "<p>posborne updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10285\">PR #10285</a>.</p>",
        "id": 503574235,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1741193616
    },
    {
        "content": "<p>alexcrichton has enabled auto merge for <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10285\">PR #10285</a>.</p>",
        "id": 503577787,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1741194325
    },
    {
        "content": "<p>posborne updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10285\">PR #10285</a>.</p>",
        "id": 505178732,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1741795361
    },
    {
        "content": "<p>alexcrichton merged <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10285\">PR #10285</a>.</p>",
        "id": 505230272,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1741807760
    }
]
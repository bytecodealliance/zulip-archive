[
    {
        "content": "<p>dicej opened <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12589\">issue #12589</a>:</p>\n<blockquote>\n<p>I've been <a href=\"https://github.com/tokio-rs/mio/pull/1836\">adding WASIp2 support to <code>mio</code></a> and triaging failures in its test suite.  <a href=\"https://github.com/tokio-rs/mio/blob/66ac9fab79bf191218488c4f35c99d13935b7e12/tests/udp_socket.rs#L396\">This test</a> is failing, which I tracked down to <code>wasmtime-wasi</code> spuriously changing the local address of a UDP socket when <code>wasi:sockets/udp#udp-socket.stream</code> is called a second time on the same socket (equivalent to calling <code>connect(2)</code> a second time in POSIX).  The test fails because it uses the old local address, not realizing the socket suddenly has a new local address.</p>\n<p>Here's a minimal test case:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"c1\">// udp.rs</span>\n<span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"p\">::{</span><span class=\"n\">error</span><span class=\"p\">::</span><span class=\"n\">Error</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">net</span><span class=\"p\">::</span><span class=\"n\">UdpSocket</span><span class=\"p\">};</span>\n\n<span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"nb\">Box</span><span class=\"o\">&lt;</span><span class=\"k\">dyn</span><span class=\"w\"> </span><span class=\"n\">Error</span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">socket1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">UdpSocket</span><span class=\"p\">::</span><span class=\"n\">bind</span><span class=\"p\">(</span><span class=\"s\">\"127.0.0.1:0\"</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">socket2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">UdpSocket</span><span class=\"p\">::</span><span class=\"n\">bind</span><span class=\"p\">(</span><span class=\"s\">\"127.0.0.1:0\"</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">address1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">socket1</span><span class=\"p\">.</span><span class=\"n\">local_addr</span><span class=\"p\">()</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">address2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">socket2</span><span class=\"p\">.</span><span class=\"n\">local_addr</span><span class=\"p\">()</span><span class=\"o\">?</span><span class=\"p\">;</span>\n\n<span class=\"w\">    </span><span class=\"fm\">println!</span><span class=\"p\">(</span>\n<span class=\"w\">        </span><span class=\"s\">\"before:</span><span class=\"se\">\\n</span><span class=\"s\">  \\</span>\n<span class=\"s\">         socket1 local address: {address1:?}</span><span class=\"se\">\\n</span><span class=\"s\">  \\</span>\n<span class=\"s\">         socket2 local address: {address2:?}\"</span>\n<span class=\"w\">    </span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"n\">socket1</span><span class=\"p\">.</span><span class=\"n\">connect</span><span class=\"p\">(</span><span class=\"n\">address1</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">socket1</span><span class=\"p\">.</span><span class=\"n\">connect</span><span class=\"p\">(</span><span class=\"n\">address2</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">socket2</span><span class=\"p\">.</span><span class=\"n\">connect</span><span class=\"p\">(</span><span class=\"n\">address1</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n\n<span class=\"w\">    </span><span class=\"fm\">println!</span><span class=\"p\">(</span>\n<span class=\"w\">        </span><span class=\"s\">\"before:</span><span class=\"se\">\\n</span><span class=\"s\">  \\</span>\n<span class=\"s\">         socket1 local address: {address1:?} remote address: {remote1:?}</span><span class=\"se\">\\n</span><span class=\"s\">  \\</span>\n<span class=\"s\">         socket2 local address: {address2:?} remote address: {remote2:?}\"</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"n\">address1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">socket1</span><span class=\"p\">.</span><span class=\"n\">local_addr</span><span class=\"p\">()</span><span class=\"o\">?</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"n\">address2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">socket2</span><span class=\"p\">.</span><span class=\"n\">local_addr</span><span class=\"p\">()</span><span class=\"o\">?</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"n\">remote1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">socket1</span><span class=\"p\">.</span><span class=\"n\">peer_addr</span><span class=\"p\">()</span><span class=\"o\">?</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"n\">remote2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">socket2</span><span class=\"p\">.</span><span class=\"n\">peer_addr</span><span class=\"p\">()</span><span class=\"o\">?</span>\n<span class=\"w\">    </span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s\">b\"foobar\"</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">socket1</span><span class=\"p\">.</span><span class=\"n\">send</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">buffer</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"k\">u8</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"mi\">20</span><span class=\"p\">];</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">count</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">socket2</span><span class=\"p\">.</span><span class=\"n\">recv</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">buffer</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n\n<span class=\"w\">    </span><span class=\"fm\">assert_eq!</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">buffer</span><span class=\"p\">[</span><span class=\"o\">..</span><span class=\"n\">count</span><span class=\"p\">]);</span>\n\n<span class=\"w\">    </span><span class=\"fm\">println!</span><span class=\"p\">(</span><span class=\"s\">\"success!\"</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"nb\">Ok</span><span class=\"p\">(())</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>If you build and run that natively on e.g. Linux using <code>rustc udp.rs &amp;&amp; ./udp</code>, you'll see it succeed, with <code>socket1</code>'s local address remaining unchanged before and after the <code>UdpSocket::connect</code> calls.</p>\n<p>If you build and run for WASIp2 using <code>rustc --target=wasm32-wasip2 udp.rs &amp;&amp; wasmtime run -Sudp,inherit-network udp.wasm</code>, you'll see it hang indefinitely due to <code>socket1</code>'s local address changing due to the second <code>UdpSocket::connect</code> call.</p>\n<p>While digging into this, I found that <code>wasmtime-wasi</code> proactively disconnects the socket by calling <code>rustix::net::connect_unspec</code> prior to reconnecting.  When I comment out that code, the issue is fixed:</p>\n<div class=\"codehilite\" data-code-language=\"Diff\"><pre><span></span><code><span class=\"gh\">diff --git a/crates/wasi/src/p2/host/udp.rs b/crates/wasi/src/p2/host/udp.rs</span>\n<span class=\"gh\">index 1ef8350399..5dd426e736 100644</span>\n<span class=\"gd\">--- a/crates/wasi/src/p2/host/udp.rs</span>\n<span class=\"gi\">+++ b/crates/wasi/src/p2/host/udp.rs</span>\n<span class=\"gu\">@@ -71,9 +71,9 @@ impl udp::HostUdpSocket for WasiSocketsCtxView&lt;'_&gt; {</span>\n<span class=\"w\"> </span>        //   if there isn't a disconnect in between.\n\n<span class=\"w\"> </span>        // Step #1: Disconnect\n<span class=\"gd\">-        if socket.is_connected() {</span>\n<span class=\"gd\">-            socket.disconnect()?;</span>\n<span class=\"gd\">-        }</span>\n<span class=\"gi\">+        // if socket.is_connected() {</span>\n<span class=\"gi\">+        //     socket.disconnect()?;</span>\n<span class=\"gi\">+        // }</span>\n\n<span class=\"w\"> </span>        // Step #2: (Re)connect\n<span class=\"w\"> </span>        if let Some(connect_addr) = remote_address {\n<span class=\"gh\">diff --git a/crates/wasi/src/sockets/udp.rs b/crates/wasi/src/sockets/udp.rs</span>\n<span class=\"gh\">index 482c6aa090..ba1e93f18d 100644</span>\n<span class=\"gd\">--- a/crates/wasi/src/sockets/udp.rs</span>\n<span class=\"gi\">+++ b/crates/wasi/src/sockets/udp.rs</span>\n<span class=\"gu\">@@ -162,10 +162,10 @@ impl UdpSocket {</span>\n<span class=\"w\"> </span>        //   if there isn't a disconnect in between.\n\n<span class=\"w\"> </span>        // Step #1: Disconnect\n<span class=\"gd\">-        if let UdpState::Connected(..) = self.udp_state {</span>\n<span class=\"gd\">-            udp_disconnect(&amp;self.socket)?;</span>\n<span class=\"gd\">-            self.udp_state = UdpState::Bound;</span>\n<span class=\"gd\">-        }</span>\n<span class=\"gi\">+        // if let UdpState::Connected(..) = self.udp_state {</span>\n<span class=\"gi\">+        //     udp_disconnect(&amp;self.socket)?;</span>\n<span class=\"gi\">+        //     self.udp_state = UdpState::Bound;</span>\n<span class=\"gi\">+        // }</span>\n<span class=\"w\"> </span>        // Step #2: (Re)connect\n<span class=\"w\"> </span>        connect(&amp;self.socket, &amp;addr).map_err(|error| match error {\n<span class=\"w\"> </span>            Errno::AFNOSUPPORT =&gt; ErrorCode::InvalidArgument, // See `udp_bind` implementation.\n</code></pre></div>\n<p>However, per the surrounding comments, that code is there for a reason, so I assume that removing it isn't the right solution.  @badeend this seems to be related to <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7411\">https://github.com/bytecodealliance/wasmtime/pull/7411</a>, so perhaps you have thoughts?</p>\n</blockquote>",
        "id": 573825029,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1771015496
    },
    {
        "content": "<p>dicej edited <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12589\">issue #12589</a>:</p>\n<blockquote>\n<p>I've been <a href=\"https://github.com/tokio-rs/mio/pull/1836\">adding WASIp2 support to <code>mio</code></a> and triaging failures in its test suite.  <a href=\"https://github.com/tokio-rs/mio/blob/66ac9fab79bf191218488c4f35c99d13935b7e12/tests/udp_socket.rs#L396\">This test</a> is failing, which I tracked down to <code>wasmtime-wasi</code> spuriously changing the local address of a UDP socket when <code>wasi:sockets/udp#udp-socket.stream</code> is called a second time on the same socket (equivalent to calling <code>connect(2)</code> a second time in POSIX).  The test fails because it uses the old local address, not realizing the socket suddenly has a new local address.</p>\n<p>Here's a minimal test case:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"c1\">// udp.rs</span>\n<span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"p\">::{</span><span class=\"n\">error</span><span class=\"p\">::</span><span class=\"n\">Error</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">net</span><span class=\"p\">::</span><span class=\"n\">UdpSocket</span><span class=\"p\">};</span>\n\n<span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"nb\">Box</span><span class=\"o\">&lt;</span><span class=\"k\">dyn</span><span class=\"w\"> </span><span class=\"n\">Error</span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">socket1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">UdpSocket</span><span class=\"p\">::</span><span class=\"n\">bind</span><span class=\"p\">(</span><span class=\"s\">\"127.0.0.1:0\"</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">socket2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">UdpSocket</span><span class=\"p\">::</span><span class=\"n\">bind</span><span class=\"p\">(</span><span class=\"s\">\"127.0.0.1:0\"</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">address1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">socket1</span><span class=\"p\">.</span><span class=\"n\">local_addr</span><span class=\"p\">()</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">address2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">socket2</span><span class=\"p\">.</span><span class=\"n\">local_addr</span><span class=\"p\">()</span><span class=\"o\">?</span><span class=\"p\">;</span>\n\n<span class=\"w\">    </span><span class=\"fm\">println!</span><span class=\"p\">(</span>\n<span class=\"w\">        </span><span class=\"s\">\"before:</span><span class=\"se\">\\n</span><span class=\"s\">  \\</span>\n<span class=\"s\">         socket1 local address: {address1:?}</span><span class=\"se\">\\n</span><span class=\"s\">  \\</span>\n<span class=\"s\">         socket2 local address: {address2:?}\"</span>\n<span class=\"w\">    </span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"n\">socket1</span><span class=\"p\">.</span><span class=\"n\">connect</span><span class=\"p\">(</span><span class=\"n\">address1</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">socket1</span><span class=\"p\">.</span><span class=\"n\">connect</span><span class=\"p\">(</span><span class=\"n\">address2</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">socket2</span><span class=\"p\">.</span><span class=\"n\">connect</span><span class=\"p\">(</span><span class=\"n\">address1</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n\n<span class=\"w\">    </span><span class=\"fm\">println!</span><span class=\"p\">(</span>\n<span class=\"w\">        </span><span class=\"s\">\"after:</span><span class=\"se\">\\n</span><span class=\"s\">  \\</span>\n<span class=\"s\">         socket1 local address: {address1:?} remote address: {remote1:?}</span><span class=\"se\">\\n</span><span class=\"s\">  \\</span>\n<span class=\"s\">         socket2 local address: {address2:?} remote address: {remote2:?}\"</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"n\">address1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">socket1</span><span class=\"p\">.</span><span class=\"n\">local_addr</span><span class=\"p\">()</span><span class=\"o\">?</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"n\">address2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">socket2</span><span class=\"p\">.</span><span class=\"n\">local_addr</span><span class=\"p\">()</span><span class=\"o\">?</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"n\">remote1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">socket1</span><span class=\"p\">.</span><span class=\"n\">peer_addr</span><span class=\"p\">()</span><span class=\"o\">?</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"n\">remote2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">socket2</span><span class=\"p\">.</span><span class=\"n\">peer_addr</span><span class=\"p\">()</span><span class=\"o\">?</span>\n<span class=\"w\">    </span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s\">b\"foobar\"</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">socket1</span><span class=\"p\">.</span><span class=\"n\">send</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">buffer</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"k\">u8</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"mi\">20</span><span class=\"p\">];</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">count</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">socket2</span><span class=\"p\">.</span><span class=\"n\">recv</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">buffer</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n\n<span class=\"w\">    </span><span class=\"fm\">assert_eq!</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">buffer</span><span class=\"p\">[</span><span class=\"o\">..</span><span class=\"n\">count</span><span class=\"p\">]);</span>\n\n<span class=\"w\">    </span><span class=\"fm\">println!</span><span class=\"p\">(</span><span class=\"s\">\"success!\"</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"nb\">Ok</span><span class=\"p\">(())</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>If you build and run that natively on e.g. Linux using <code>rustc udp.rs &amp;&amp; ./udp</code>, you'll see it succeed, with <code>socket1</code>'s local address remaining unchanged before and after the <code>UdpSocket::connect</code> calls.</p>\n<p>If you build and run for WASIp2 using <code>rustc --target=wasm32-wasip2 udp.rs &amp;&amp; wasmtime run -Sudp,inherit-network udp.wasm</code>, you'll see it hang indefinitely due to <code>socket1</code>'s local address changing due to the second <code>UdpSocket::connect</code> call.</p>\n<p>While digging into this, I found that <code>wasmtime-wasi</code> proactively disconnects the socket by calling <code>rustix::net::connect_unspec</code> prior to reconnecting.  When I comment out that code, the issue is fixed:</p>\n<div class=\"codehilite\" data-code-language=\"Diff\"><pre><span></span><code><span class=\"gh\">diff --git a/crates/wasi/src/p2/host/udp.rs b/crates/wasi/src/p2/host/udp.rs</span>\n<span class=\"gh\">index 1ef8350399..5dd426e736 100644</span>\n<span class=\"gd\">--- a/crates/wasi/src/p2/host/udp.rs</span>\n<span class=\"gi\">+++ b/crates/wasi/src/p2/host/udp.rs</span>\n<span class=\"gu\">@@ -71,9 +71,9 @@ impl udp::HostUdpSocket for WasiSocketsCtxView&lt;'_&gt; {</span>\n<span class=\"w\"> </span>        //   if there isn't a disconnect in between.\n\n<span class=\"w\"> </span>        // Step #1: Disconnect\n<span class=\"gd\">-        if socket.is_connected() {</span>\n<span class=\"gd\">-            socket.disconnect()?;</span>\n<span class=\"gd\">-        }</span>\n<span class=\"gi\">+        // if socket.is_connected() {</span>\n<span class=\"gi\">+        //     socket.disconnect()?;</span>\n<span class=\"gi\">+        // }</span>\n\n<span class=\"w\"> </span>        // Step #2: (Re)connect\n<span class=\"w\"> </span>        if let Some(connect_addr) = remote_address {\n<span class=\"gh\">diff --git a/crates/wasi/src/sockets/udp.rs b/crates/wasi/src/sockets/udp.rs</span>\n<span class=\"gh\">index 482c6aa090..ba1e93f18d 100644</span>\n<span class=\"gd\">--- a/crates/wasi/src/sockets/udp.rs</span>\n<span class=\"gi\">+++ b/crates/wasi/src/sockets/udp.rs</span>\n<span class=\"gu\">@@ -162,10 +162,10 @@ impl UdpSocket {</span>\n<span class=\"w\"> </span>        //   if there isn't a disconnect in between.\n\n<span class=\"w\"> </span>        // Step #1: Disconnect\n<span class=\"gd\">-        if let UdpState::Connected(..) = self.udp_state {</span>\n<span class=\"gd\">-            udp_disconnect(&amp;self.socket)?;</span>\n<span class=\"gd\">-            self.udp_state = UdpState::Bound;</span>\n<span class=\"gd\">-        }</span>\n<span class=\"gi\">+        // if let UdpState::Connected(..) = self.udp_state {</span>\n<span class=\"gi\">+        //     udp_disconnect(&amp;self.socket)?;</span>\n<span class=\"gi\">+        //     self.udp_state = UdpState::Bound;</span>\n<span class=\"gi\">+        // }</span>\n<span class=\"w\"> </span>        // Step #2: (Re)connect\n<span class=\"w\"> </span>        connect(&amp;self.socket, &amp;addr).map_err(|error| match error {\n<span class=\"w\"> </span>            Errno::AFNOSUPPORT =&gt; ErrorCode::InvalidArgument, // See `udp_bind` implementation.\n</code></pre></div>\n<p>However, per the surrounding comments, that code is there for a reason, so I assume that removing it isn't the right solution.  @badeend this seems to be related to <a href=\"https://github.com/bytecodealliance/wasmtime/pull/7411\">https://github.com/bytecodealliance/wasmtime/pull/7411</a>, so perhaps you have thoughts?</p>\n</blockquote>",
        "id": 573825773,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1771015855
    },
    {
        "content": "<p><a href=\"https://github.com/dicej\">dicej</a> added the wasi label to <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12589\">Issue #12589</a>.</p>",
        "id": 573826305,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1771016088
    }
]
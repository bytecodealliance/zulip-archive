[
    {
        "content": "<p>zzjas opened <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12336\">issue #12336</a>:</p>\n<blockquote>\n<h3><code>.clif</code> Test Case</h3>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"n\">compile</span>\n<span class=\"n\">set</span><span class=\"w\"> </span><span class=\"n\">enable_nan_canonicalization</span><span class=\"o\">=</span><span class=\"kc\">true</span>\n<span class=\"n\">target</span><span class=\"w\"> </span><span class=\"n\">s390x</span>\n\n<span class=\"n\">function</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">fadd_f128</span><span class=\"p\">(</span><span class=\"kt\">i64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">f128</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">f128</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"n\">block0</span><span class=\"p\">(</span><span class=\"n\">v0</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">i64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v1</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">f128</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v2</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">f128</span><span class=\"p\">):</span>\n<span class=\"w\">    </span><span class=\"nc\">v3</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">fadd</span><span class=\"w\"> </span><span class=\"n\">v1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v2</span>\n<span class=\"w\">    </span><span class=\"n\">store</span><span class=\"w\"> </span><span class=\"n\">v3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v0</span>\n<span class=\"w\">    </span><span class=\"k\">return</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<h3>Steps to Reproduce</h3>\n<p><code>RUST_BACKTRACE=1 cargo run -p cranelift-tools -- test test.clif</code></p>\n<h3>Expected Results</h3>\n<p>No crash</p>\n<h3>Actual Results</h3>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">thread</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">worker</span><span class=\"w\"> </span><span class=\"p\">#</span><span class=\"mi\">0</span><span class=\"o\">'</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">2560515</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">panicked</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">cranelift</span><span class=\"o\">/</span><span class=\"n\">codegen</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">nan_canonicalization</span><span class=\"p\">.</span><span class=\"n\">rs</span><span class=\"p\">:</span><span class=\"mi\">121</span><span class=\"p\">:</span><span class=\"mi\">13</span><span class=\"p\">:</span>\n<span class=\"nc\">Could</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">canonicalize</span><span class=\"w\"> </span><span class=\"n\">NaN</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">Unexpected</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"k\">type</span><span class=\"w\"> </span><span class=\"nc\">found</span><span class=\"p\">.</span>\n</code></pre></div>\n<h3>Versions and Environment</h3>\n<p>Cranelift version or commit: e82a7abfd3e88145450a5465def20f6781e0eb65</p>\n<h3>Extra Info</h3>\n<p>F16 (on RISC-V with zfh) and F128 (on s390x) are valid floating-point types that pass the <code>is_fp_arith()</code> check in <code>nan_canonicalization.rs</code> but fall through to the panic in <code>add_nan_canon_seq()</code>:</p>\n<p><a href=\"https://github.com/bytecodealliance/wasmtime/blob/e82a7abfd3e88145450a5465def20f6781e0eb65/cranelift/codegen/src/nan_canonicalization.rs#L92-L123\">https://github.com/bytecodealliance/wasmtime/blob/e82a7abfd3e88145450a5465def20f6781e0eb65/cranelift/codegen/src/nan_canonicalization.rs#L92-L123</a></p>\n<p>Adding the following arm will fix the F128 for s390x:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">        </span><span class=\"n\">types</span><span class=\"p\">::</span><span class=\"n\">F128</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">            </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">nan_const</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"p\">.</span><span class=\"n\">func</span><span class=\"p\">.</span><span class=\"n\">dfg</span><span class=\"p\">.</span><span class=\"n\">constants</span><span class=\"p\">.</span><span class=\"n\">insert</span><span class=\"p\">(</span><span class=\"n\">Ieee128</span><span class=\"p\">::</span><span class=\"n\">NAN</span><span class=\"p\">.</span><span class=\"n\">into</span><span class=\"p\">());</span>\n<span class=\"w\">            </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">canon_nan</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"p\">.</span><span class=\"n\">ins</span><span class=\"p\">().</span><span class=\"n\">f128const</span><span class=\"p\">(</span><span class=\"n\">nan_const</span><span class=\"p\">);</span>\n<span class=\"w\">            </span><span class=\"n\">scalar_select</span><span class=\"p\">(</span><span class=\"n\">pos</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">canon_nan</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"p\">}</span>\n</code></pre></div>\n<p>I'm not sure if F16 needs to be fixed because of #7322.</p>\n<p>Thanks for looking into this and I'm happy to submit a PR if the fix to F128 looks ok.</p>\n</blockquote>",
        "id": 567867809,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768342158
    },
    {
        "content": "<p><a href=\"https://github.com/zzjas\">zzjas</a> added the bug label to <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12336\">Issue #12336</a>.</p>",
        "id": 567867812,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768342158
    },
    {
        "content": "<p><a href=\"https://github.com/zzjas\">zzjas</a> added the cranelift label to <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12336\">Issue #12336</a>.</p>",
        "id": 567867813,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768342158
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12336#issuecomment-3746906836\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12336\">issue #12336</a>:</p>\n<blockquote>\n<p>I think it'd be reasonable to add support to the <code>nan_canonicalization.rs</code> pass for this yeah, and if you're willing to make a PR that'd be much appreciated!</p>\n</blockquote>",
        "id": 567872235,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768344354
    },
    {
        "content": "<p>zzjas <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12336#issuecomment-3746955049\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12336\">issue #12336</a>:</p>\n<blockquote>\n<p>Happy to make a PR! Just to confirm, do you think just fixing for F128 is enough or would it better to fix for both F128 and F16? Thanks!</p>\n</blockquote>",
        "id": 567874228,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768345514
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12336#issuecomment-3746971277\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12336\">issue #12336</a>:</p>\n<blockquote>\n<p>I'd personally leave that call to you as a subjective balance between implementation complexity and how motivated you are. Cranelift is probably going to have somewhat patchy support for f16/f128 for awhile unless a particularly motivated contributor comes by, so the exact state of support to me I think is fine with whatever so long as it's incrementally moving forward</p>\n</blockquote>",
        "id": 567874982,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768345946
    },
    {
        "content": "<p>cfallin closed <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12336\">issue #12336</a>:</p>\n<blockquote>\n<h3><code>.clif</code> Test Case</h3>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"n\">compile</span>\n<span class=\"n\">set</span><span class=\"w\"> </span><span class=\"n\">enable_nan_canonicalization</span><span class=\"o\">=</span><span class=\"kc\">true</span>\n<span class=\"n\">target</span><span class=\"w\"> </span><span class=\"n\">s390x</span>\n\n<span class=\"n\">function</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">fadd_f128</span><span class=\"p\">(</span><span class=\"kt\">i64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">f128</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">f128</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"n\">block0</span><span class=\"p\">(</span><span class=\"n\">v0</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">i64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v1</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">f128</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v2</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">f128</span><span class=\"p\">):</span>\n<span class=\"w\">    </span><span class=\"nc\">v3</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">fadd</span><span class=\"w\"> </span><span class=\"n\">v1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v2</span>\n<span class=\"w\">    </span><span class=\"n\">store</span><span class=\"w\"> </span><span class=\"n\">v3</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v0</span>\n<span class=\"w\">    </span><span class=\"k\">return</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<h3>Steps to Reproduce</h3>\n<p><code>RUST_BACKTRACE=1 cargo run -p cranelift-tools -- test test.clif</code></p>\n<h3>Expected Results</h3>\n<p>No crash</p>\n<h3>Actual Results</h3>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">thread</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">worker</span><span class=\"w\"> </span><span class=\"p\">#</span><span class=\"mi\">0</span><span class=\"o\">'</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">2560515</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">panicked</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">cranelift</span><span class=\"o\">/</span><span class=\"n\">codegen</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">nan_canonicalization</span><span class=\"p\">.</span><span class=\"n\">rs</span><span class=\"p\">:</span><span class=\"mi\">121</span><span class=\"p\">:</span><span class=\"mi\">13</span><span class=\"p\">:</span>\n<span class=\"nc\">Could</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">canonicalize</span><span class=\"w\"> </span><span class=\"n\">NaN</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">Unexpected</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"k\">type</span><span class=\"w\"> </span><span class=\"nc\">found</span><span class=\"p\">.</span>\n</code></pre></div>\n<h3>Versions and Environment</h3>\n<p>Cranelift version or commit: e82a7abfd3e88145450a5465def20f6781e0eb65</p>\n<h3>Extra Info</h3>\n<p>F16 (on RISC-V with zfh) and F128 (on s390x) are valid floating-point types that pass the <code>is_fp_arith()</code> check in <code>nan_canonicalization.rs</code> but fall through to the panic in <code>add_nan_canon_seq()</code>:</p>\n<p><a href=\"https://github.com/bytecodealliance/wasmtime/blob/e82a7abfd3e88145450a5465def20f6781e0eb65/cranelift/codegen/src/nan_canonicalization.rs#L92-L123\">https://github.com/bytecodealliance/wasmtime/blob/e82a7abfd3e88145450a5465def20f6781e0eb65/cranelift/codegen/src/nan_canonicalization.rs#L92-L123</a></p>\n<p>Adding the following arm will fix the F128 for s390x:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">        </span><span class=\"n\">types</span><span class=\"p\">::</span><span class=\"n\">F128</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">            </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">nan_const</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"p\">.</span><span class=\"n\">func</span><span class=\"p\">.</span><span class=\"n\">dfg</span><span class=\"p\">.</span><span class=\"n\">constants</span><span class=\"p\">.</span><span class=\"n\">insert</span><span class=\"p\">(</span><span class=\"n\">Ieee128</span><span class=\"p\">::</span><span class=\"n\">NAN</span><span class=\"p\">.</span><span class=\"n\">into</span><span class=\"p\">());</span>\n<span class=\"w\">            </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">canon_nan</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">pos</span><span class=\"p\">.</span><span class=\"n\">ins</span><span class=\"p\">().</span><span class=\"n\">f128const</span><span class=\"p\">(</span><span class=\"n\">nan_const</span><span class=\"p\">);</span>\n<span class=\"w\">            </span><span class=\"n\">scalar_select</span><span class=\"p\">(</span><span class=\"n\">pos</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">canon_nan</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"p\">}</span>\n</code></pre></div>\n<p>I'm not sure if F16 needs to be fixed because of #7322.</p>\n<p>Thanks for looking into this and I'm happy to submit a PR if the fix to F128 looks ok.</p>\n</blockquote>",
        "id": 567883096,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1768350223
    }
]
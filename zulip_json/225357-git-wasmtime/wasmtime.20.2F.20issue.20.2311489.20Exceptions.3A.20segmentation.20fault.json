[
    {
        "content": "<p>vouillon opened <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11489\">issue #11489</a>:</p>\n<blockquote>\n<h3>Test Case</h3>\n<p><a href=\"https://github.com/user-attachments/files/21920759/bug.zip\">bug.zip</a></p>\n<h3>Steps to Reproduce</h3>\n<p>Run the following command:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">target</span><span class=\"o\">/</span><span class=\"n\">debug</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"w\">  </span><span class=\"o\">-</span><span class=\"n\">W</span><span class=\"o\">=</span><span class=\"n\">all</span><span class=\"o\">-</span><span class=\"n\">proposals</span><span class=\"o\">=</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"n\">bug</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n</code></pre></div>\n<h3>Expected Results</h3>\n<p>It should not crash</p>\n<h3>Actual Results</h3>\n<p>I get a segfault</p>\n<h3>Versions and Environment</h3>\n<p>Wasmtime commit: 2d25f862b38abd484e5418327a9149e69d3274aa</p>\n<p>Operating system: Linux</p>\n<p>Architecture: x64</p>\n<h3>Extra Info</h3>\n<p>I suspect that the stack unwinder does not deal properly with tail calls.</p>\n<p>I get the following stack trace in gdb:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"p\">#</span><span class=\"mi\">0</span><span class=\"w\">  </span><span class=\"n\">wasmtime</span><span class=\"p\">::</span><span class=\"n\">runtime</span><span class=\"p\">::</span><span class=\"n\">vm</span><span class=\"p\">::</span><span class=\"n\">ModuleRuntimeInfo</span><span class=\"p\">::</span><span class=\"n\">env_module</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">=</span><span class=\"mh\">0x7ffeffffff68</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">crates</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">runtime</span><span class=\"o\">/</span><span class=\"n\">vm</span><span class=\"p\">.</span><span class=\"n\">rs</span><span class=\"p\">:</span><span class=\"mi\">329</span>\n<span class=\"p\">#</span><span class=\"mi\">1</span><span class=\"w\">  </span><span class=\"mh\">0x0000555557fd524f</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"p\">::</span><span class=\"n\">runtime</span><span class=\"p\">::</span><span class=\"n\">vm</span><span class=\"p\">::</span><span class=\"n\">instance</span><span class=\"p\">::</span><span class=\"n\">Instance</span><span class=\"p\">::</span><span class=\"n\">env_module</span>\n<span class=\"w\">    </span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">=</span><span class=\"mh\">0x7ffeffffff60</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">crates</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">runtime</span><span class=\"o\">/</span><span class=\"n\">vm</span><span class=\"o\">/</span><span class=\"n\">instance</span><span class=\"p\">.</span><span class=\"n\">rs</span><span class=\"p\">:</span><span class=\"mi\">357</span>\n<span class=\"p\">#</span><span class=\"mi\">2</span><span class=\"w\">  </span><span class=\"mh\">0x0000555557fd5fe8</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"p\">::</span><span class=\"n\">runtime</span><span class=\"p\">::</span><span class=\"n\">vm</span><span class=\"p\">::</span><span class=\"n\">instance</span><span class=\"p\">::</span><span class=\"n\">Instance</span><span class=\"p\">::</span><span class=\"n\">get_exported_tag</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">=</span><span class=\"mh\">0x7ffeffffff60</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">store</span><span class=\"o\">=..</span><span class=\"p\">.,</span><span class=\"w\"> </span><span class=\"n\">index</span><span class=\"o\">=..</span><span class=\"p\">.)</span>\n<span class=\"w\">    </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">crates</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">runtime</span><span class=\"o\">/</span><span class=\"n\">vm</span><span class=\"o\">/</span><span class=\"n\">instance</span><span class=\"p\">.</span><span class=\"n\">rs</span><span class=\"p\">:</span><span class=\"mi\">666</span>\n<span class=\"p\">#</span><span class=\"mi\">3</span><span class=\"w\">  </span><span class=\"mh\">0x0000555557fb4cad</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"p\">::</span><span class=\"n\">runtime</span><span class=\"p\">::</span><span class=\"n\">vm</span><span class=\"p\">::</span><span class=\"n\">throw</span><span class=\"p\">::</span><span class=\"n\">compute_throw_action</span><span class=\"p\">::{</span><span class=\"n\">closure</span><span class=\"p\">#</span><span class=\"mi\">0</span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">frame</span><span class=\"o\">=</span><span class=\"mh\">0x7ffff69f48f0</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">crates</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">runtime</span><span class=\"o\">/</span><span class=\"n\">vm</span><span class=\"o\">/</span><span class=\"n\">throw</span><span class=\"p\">.</span><span class=\"n\">rs</span><span class=\"p\">:</span><span class=\"mi\">98</span>\n<span class=\"p\">#</span><span class=\"mi\">4</span><span class=\"w\">  </span><span class=\"mh\">0x0000555557f12e5e</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">wasmtime_internal_unwinder</span><span class=\"p\">::</span><span class=\"n\">throw</span><span class=\"p\">::</span><span class=\"n\">compute_throw_action</span><span class=\"p\">::{</span><span class=\"n\">closure</span><span class=\"p\">#</span><span class=\"mi\">0</span><span class=\"p\">}</span><span class=\"o\">&lt;</span><span class=\"n\">wasmtime</span><span class=\"p\">::</span><span class=\"n\">runtime</span><span class=\"p\">::</span><span class=\"n\">vm</span><span class=\"p\">::</span><span class=\"n\">throw</span><span class=\"p\">::</span><span class=\"n\">compute_throw_action</span><span class=\"p\">::{</span><span class=\"n\">closure_env</span><span class=\"p\">#</span><span class=\"mi\">0</span><span class=\"p\">}</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">frame</span><span class=\"o\">=..</span><span class=\"p\">.)</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">crates</span><span class=\"o\">/</span><span class=\"n\">unwinder</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">throw</span><span class=\"p\">.</span><span class=\"n\">rs</span><span class=\"p\">:</span><span class=\"mi\">76</span>\n<span class=\"p\">#</span><span class=\"mi\">5</span><span class=\"w\">  </span><span class=\"mh\">0x0000555558034d24</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">wasmtime_internal_unwinder</span><span class=\"p\">::</span><span class=\"n\">stackwalk</span><span class=\"p\">::</span><span class=\"n\">visit_frames</span><span class=\"o\">&lt;</span><span class=\"n\">wasmtime_internal_unwinder</span><span class=\"p\">::</span><span class=\"n\">throw</span><span class=\"p\">::</span><span class=\"n\">ThrowAction</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wasmtime_internal_unwinder</span><span class=\"p\">::</span><span class=\"n\">throw</span><span class=\"p\">::</span><span class=\"n\">compute_throw_action</span><span class=\"p\">::{</span><span class=\"n\">closure_env</span><span class=\"p\">#</span><span class=\"mi\">0</span><span class=\"p\">}</span><span class=\"o\">&lt;</span><span class=\"n\">wasmtime</span><span class=\"p\">::</span><span class=\"n\">runtime</span><span class=\"p\">::</span><span class=\"n\">vm</span><span class=\"p\">::</span><span class=\"n\">throw</span><span class=\"p\">::</span><span class=\"n\">compute_throw_action</span><span class=\"p\">::{</span><span class=\"n\">closure_env</span><span class=\"p\">#</span><span class=\"mi\">0</span><span class=\"p\">}</span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">unwind</span><span class=\"o\">=..</span><span class=\"p\">.,</span><span class=\"w\"> </span><span class=\"n\">pc</span><span class=\"o\">=</span><span class=\"mi\">140737353797698</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">fp</span><span class=\"o\">=</span><span class=\"mi\">140737331026544</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">trampoline_fp</span><span class=\"o\">=</span><span class=\"mi\">140737331026560</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">=..</span><span class=\"p\">.)</span>\n<span class=\"w\">    </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">crates</span><span class=\"o\">/</span><span class=\"n\">unwinder</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">stackwalk</span><span class=\"p\">.</span><span class=\"n\">rs</span><span class=\"p\">:</span><span class=\"mi\">203</span>\n<span class=\"p\">#</span><span class=\"mi\">6</span><span class=\"w\">  </span><span class=\"mh\">0x0000555557f12c31</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">wasmtime_internal_unwinder</span><span class=\"p\">::</span><span class=\"n\">throw</span><span class=\"p\">::</span><span class=\"n\">compute_throw_action</span><span class=\"o\">&lt;</span><span class=\"n\">wasmtime</span><span class=\"p\">::</span><span class=\"n\">runtime</span><span class=\"p\">::</span><span class=\"n\">vm</span><span class=\"p\">::</span><span class=\"n\">throw</span><span class=\"p\">::</span><span class=\"n\">compute_throw_action</span><span class=\"p\">::{</span><span class=\"n\">closure_env</span><span class=\"p\">#</span><span class=\"mi\">0</span><span class=\"p\">}</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">(</span>\n<span class=\"w\">    </span><span class=\"n\">unwind</span><span class=\"o\">=..</span><span class=\"p\">.,</span><span class=\"w\"> </span><span class=\"n\">frame_handler</span><span class=\"o\">=..</span><span class=\"p\">.,</span><span class=\"w\"> </span><span class=\"n\">exit_pc</span><span class=\"o\">=</span><span class=\"mi\">140737353797991</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">exit_trampoline_frame</span><span class=\"o\">=</span><span class=\"mi\">140737331026368</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">entry_frame</span><span class=\"o\">=</span><span class=\"mi\">140737331026560</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">crates</span><span class=\"o\">/</span><span class=\"n\">unwinder</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">throw</span><span class=\"p\">.</span><span class=\"n\">rs</span><span class=\"p\">:</span><span class=\"mi\">60</span>\n<span class=\"o\">--</span><span class=\"n\">Type</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">RET</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">more</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">q</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">quit</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">c</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"k\">continue</span><span class=\"w\"> </span><span class=\"n\">without</span><span class=\"w\"> </span><span class=\"n\">paging</span><span class=\"o\">--</span>\n<span class=\"p\">#</span><span class=\"mi\">7</span><span class=\"w\">  </span><span class=\"mh\">0x0000555557da8980</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"p\">::</span><span class=\"n\">runtime</span><span class=\"p\">::</span><span class=\"n\">vm</span><span class=\"p\">::</span><span class=\"n\">throw</span><span class=\"p\">::</span><span class=\"n\">compute_throw_action</span><span class=\"w\"> </span><span class=\"p\">(</span>\n<span class=\"w\">    </span><span class=\"n\">store</span><span class=\"o\">=..</span><span class=\"p\">.)</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">crates</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">runtime</span><span class=\"o\">/</span><span class=\"n\">vm</span><span class=\"o\">/</span><span class=\"n\">throw</span><span class=\"p\">.</span><span class=\"n\">rs</span><span class=\"p\">:</span><span class=\"mi\">120</span>\n<span class=\"p\">#</span><span class=\"mi\">8</span><span class=\"w\">  </span><span class=\"mh\">0x0000555557be3f0a</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"p\">::</span><span class=\"n\">runtime</span><span class=\"p\">::</span><span class=\"n\">vm</span><span class=\"p\">::</span><span class=\"n\">traphandlers</span><span class=\"p\">::</span><span class=\"n\">call_thread_state</span><span class=\"p\">::</span><span class=\"n\">CallThreadState</span><span class=\"p\">::</span><span class=\"n\">record_unwind</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"o\">=</span><span class=\"mh\">0x7ffff69f5f30</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">store</span><span class=\"o\">=..</span><span class=\"p\">.,</span><span class=\"w\"> </span><span class=\"n\">reason</span><span class=\"o\">=..</span><span class=\"p\">.)</span>\n<span class=\"w\">    </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">crates</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">runtime</span><span class=\"o\">/</span><span class=\"n\">vm</span><span class=\"o\">/</span><span class=\"n\">traphandlers</span><span class=\"p\">.</span><span class=\"n\">rs</span><span class=\"p\">:</span><span class=\"mi\">819</span>\n<span class=\"p\">#</span><span class=\"mi\">9</span><span class=\"w\">  </span><span class=\"mh\">0x0000555558088a8b</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"p\">::</span><span class=\"n\">runtime</span><span class=\"p\">::</span><span class=\"n\">vm</span><span class=\"p\">::</span><span class=\"n\">traphandlers</span><span class=\"p\">::</span><span class=\"n\">catch_unwind_and_record_trap</span><span class=\"p\">::{</span><span class=\"n\">closure</span><span class=\"p\">#</span><span class=\"mi\">1</span><span class=\"p\">}</span><span class=\"o\">&lt;</span><span class=\"n\">core</span><span class=\"p\">::</span><span class=\"n\">result</span><span class=\"p\">::</span><span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"p\">::</span><span class=\"n\">runtime</span><span class=\"p\">::</span><span class=\"n\">vm</span><span class=\"p\">::</span><span class=\"n\">traphandlers</span><span class=\"p\">::</span><span class=\"n\">TrapReason</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"p\">::</span><span class=\"n\">runtime</span><span class=\"p\">::</span><span class=\"n\">vm</span><span class=\"p\">::</span><span class=\"n\">instance</span><span class=\"p\">::{</span><span class=\"k\">impl</span><span class=\"p\">#</span><span class=\"mi\">0</span><span class=\"p\">}::</span><span class=\"n\">enter_host_from_wasm</span><span class=\"p\">::{</span><span class=\"n\">closure_env</span><span class=\"p\">#</span><span class=\"mi\">0</span><span class=\"p\">}</span><span class=\"o\">&lt;</span><span class=\"n\">core</span><span class=\"p\">::</span><span class=\"n\">result</span><span class=\"p\">::</span><span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"p\">::</span><span class=\"n\">runtime</span><span class=\"p\">::</span><span class=\"n\">vm</span><span class=\"p\">::</span><span class=\"n\">traphandlers</span><span class=\"p\">::</span><span class=\"n\">TrapReason</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"p\">::</span><span class=\"n\">runtime</span><span class=\"p\">::</span><span class=\"n\">vm</span><span class=\"p\">::</span><span class=\"n\">libcalls</span><span class=\"p\">::</span><span class=\"n\">raw</span><span class=\"p\">::</span><span class=\"n\">throw_ref</span><span class=\"p\">::{</span><span class=\"n\">closure_env</span><span class=\"p\">#</span><span class=\"mi\">0</span><span class=\"p\">}</span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">info</span><span class=\"o\">=..</span><span class=\"p\">.)</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">crates</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">runtime</span><span class=\"o\">/</span><span class=\"n\">vm</span><span class=\"o\">/</span><span class=\"n\">traphandlers</span><span class=\"p\">.</span><span class=\"n\">rs</span><span class=\"p\">:</span><span class=\"mi\">136</span>\n<span class=\"p\">#</span><span class=\"mi\">10</span><span class=\"w\"> </span><span class=\"mh\">0x0000555557eff1ef</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"p\">::</span><span class=\"n\">runtime</span><span class=\"p\">::</span><span class=\"n\">vm</span><span class=\"p\">::</span><span class=\"n\">traphandlers</span><span class=\"p\">::</span><span class=\"n\">tls</span><span class=\"p\">::</span><span class=\"n\">with</span><span class=\"o\">&lt;</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"p\">::</span><span class=\"n\">runtime</span><span class=\"p\">::</span><span class=\"n\">vm</span><span class=\"p\">::</span><span class=\"n\">traphandlers</span><span class=\"p\">::</span><span class=\"n\">catch_unwind_and_record_trap</span><span class=\"p\">::{</span><span class=\"n\">closure_env</span><span class=\"p\">#</span><span class=\"mi\">1</span><span class=\"p\">}</span><span class=\"o\">&lt;</span><span class=\"n\">core</span><span class=\"p\">::</span><span class=\"n\">result</span><span class=\"p\">::</span><span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"p\">::</span><span class=\"n\">runtime</span><span class=\"p\">::</span><span class=\"n\">vm</span><span class=\"p\">::</span><span class=\"n\">traphandlers</span><span class=\"p\">::</span><span class=\"n\">TrapReason</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"p\">::</span><span class=\"n\">runtime</span><span class=\"p\">::</span><span class=\"n\">vm</span><span class=\"p\">::</span><span class=\"n\">instance</span><span class=\"p\">::{</span><span class=\"k\">impl</span><span class=\"p\">#</span><span class=\"mi\">0</span><span class=\"p\">}::</span><span class=\"n\">enter_host_from_wasm</span><span class=\"p\">::{</span><span class=\"n\">closure_env</span><span class=\"p\">#</span><span class=\"mi\">0</span><span class=\"p\">}</span><span class=\"o\">&lt;</span><span class=\"n\">core</span><span class=\"p\">::</span><span class=\"n\">result</span><span class=\"p\">::</span><span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"p\">::</span><span class=\"n\">runtime</span><span class=\"p\">::</span><span class=\"n\">vm</span><span class=\"p\">::</span><span class=\"n\">traphandlers</span><span class=\"p\">::</span><span class=\"n\">TrapReason</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"p\">::</span><span class=\"n\">runtime</span><span class=\"p\">::</span><span class=\"n\">vm</span><span class=\"p\">::</span><span class=\"n\">libcalls</span><span class=\"p\">::</span><span class=\"n\">raw</span><span class=\"p\">::</span><span class=\"n\">throw_ref</span><span class=\"p\">::{</span><span class=\"n\">closure_env</span><span class=\"p\">#</span><span class=\"mi\">0</span><span class=\"p\">}</span><span class=\"o\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">closure</span><span class=\"o\">=..</span><span class=\"p\">.)</span>\n<span class=\"w\">    </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">crates</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">runtime</span><span class=\"o\">/</span><span class=\"n\">vm</span><span class=\"o\">/</span><span class=\"n\">traphandlers</span><span class=\"p\">.</span><span class=\"n\">rs</span><span class=\"p\">:</span><span class=\"mi\">1394</span>\n<span class=\"p\">#</span><span class=\"mi\">11</span><span class=\"w\"> </span><span class=\"mh\">0x0000555558084079</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"p\">::</span><span class=\"n\">runtime</span><span class=\"p\">::</span><span class=\"n\">vm</span><span class=\"p\">::</span><span class=\"n\">traphandlers</span><span class=\"p\">::</span><span class=\"n\">catch_unwind_and_record_trap</span><span class=\"o\">&lt;</span><span class=\"n\">core</span><span class=\"p\">::</span><span class=\"n\">result</span><span class=\"p\">::</span><span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"p\">::</span><span class=\"n\">runtime</span><span class=\"p\">::</span><span class=\"n\">vm</span><span class=\"p\">::</span><span class=\"n\">traphandlers</span><span class=\"p\">::</span><span class=\"n\">TrapReason</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"p\">::</span><span class=\"n\">runtime</span><span class=\"p\">::</span><span class=\"n\">vm</span><span class=\"p\">::</span><span class=\"n\">instance</span><span class=\"p\">::{</span><span class=\"k\">impl</span><span class=\"p\">#</span><span class=\"mi\">0</span><span class=\"p\">}::</span><span class=\"n\">enter_host_from_wasm</span><span class=\"p\">::{</span><span class=\"n\">closure_env</span><span class=\"p\">#</span><span class=\"mi\">0</span><span class=\"p\">}</span><span class=\"o\">&lt;</span><span class=\"n\">core</span><span class=\"p\">::</span><span class=\"n\">result</span><span class=\"p\">::</span><span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"p\">::</span><span class=\"n\">runtime</span><span class=\"p\">::</span><span class=\"n\">vm</span><span class=\"p\">::</span><span class=\"n\">traphandlers</span><span class=\"p\">::</span><span class=\"n\">TrapReason</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"p\">::</span><span class=\"n\">runtime</span><span class=\"p\">::</span><span class=\"n\">vm</span><span class=\"p\">::</span><span class=\"n\">libcalls</span><span class=\"p\">::</span><span class=\"n\">raw</span><span class=\"p\">::</span><span class=\"n\">throw_ref</span><span class=\"p\">::{</span><span class=\"n\">closure_env</span><span class=\"p\">#</span><span class=\"mi\">0</span><span class=\"p\">}</span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"p\">(</span>\n<span class=\"w\">    </span><span class=\"n\">store</span><span class=\"o\">=..</span><span class=\"p\">.,</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">=..</span><span class=\"p\">.)</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">crates</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">runtime</span><span class=\"o\">/</span><span class=\"n\">vm</span><span class=\"o\">/</span><span class=\"n\">traphandlers</span><span class=\"p\">.</span><span class=\"n\">rs</span><span class=\"p\">:</span><span class=\"mi\">136</span>\n<span class=\"p\">#</span><span class=\"mi\">12</span><span class=\"w\"> </span><span class=\"mh\">0x0000555557c650b2</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"p\">::</span><span class=\"n\">runtime</span><span class=\"p\">::</span><span class=\"n\">vm</span><span class=\"p\">::</span><span class=\"n\">instance</span><span class=\"p\">::</span><span class=\"n\">Instance</span><span class=\"p\">::</span><span class=\"n\">enter_host_from_wasm</span><span class=\"o\">&lt;</span><span class=\"n\">core</span><span class=\"p\">::</span><span class=\"n\">result</span><span class=\"p\">::</span><span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"p\">::</span><span class=\"n\">runtime</span><span class=\"p\">::</span><span class=\"n\">vm</span><span class=\"p\">::</span><span class=\"n\">traphandlers</span><span class=\"p\">::</span><span class=\"n\">TrapReason</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"p\">::</span><span class=\"n\">runtime</span><span class=\"p\">::</span><span class=\"n\">vm</span><span class=\"p\">::</span><span class=\"n\">libcalls</span><span class=\"p\">::</span><span class=\"n\">raw</span><span class=\"p\">::</span><span class=\"n\">throw_ref</span><span class=\"p\">::{</span><span class=\"n\">closure_env</span><span class=\"p\">#</span><span class=\"mi\">0</span><span class=\"p\">}</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">(</span>\n<span class=\"w\">    </span><span class=\"n\">vmctx</span><span class=\"o\">=..</span><span class=\"p\">.,</span><span class=\"w\"> </span><span class=\"n\">f</span><span class=\"o\">=..</span><span class=\"p\">.)</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">crates</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">runtime</span><span class=\"o\">/</span><span class=\"n\">vm</span><span class=\"o\">/</span><span class=\"n\">instance</span><span class=\"p\">.</span><span class=\"n\">rs</span><span class=\"p\">:</span><span class=\"mi\">265</span>\n<span class=\"p\">#</span><span class=\"mi\">13</span><span class=\"w\"> </span><span class=\"mh\">0x0000555557f6b0bb</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"p\">::</span><span class=\"n\">runtime</span><span class=\"p\">::</span><span class=\"n\">vm</span><span class=\"p\">::</span><span class=\"n\">libcalls</span><span class=\"p\">::</span><span class=\"n\">raw</span><span class=\"p\">::</span><span class=\"n\">throw_ref</span><span class=\"w\"> </span><span class=\"p\">(</span>\n<span class=\"w\">    </span><span class=\"n\">vmctx</span><span class=\"o\">=..</span><span class=\"p\">.,</span><span class=\"w\"> </span><span class=\"n\">exnref</span><span class=\"o\">=</span><span class=\"mi\">16</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">crates</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">runtime</span><span class=\"o\">/</span><span class=\"n\">vm</span><span class=\"o\">/</span><span class=\"n\">libcalls</span><span class=\"p\">.</span><span class=\"n\">rs</span><span class=\"p\">:</span><span class=\"mi\">125</span>\n</code></pre></div>\n</blockquote>",
        "id": 535528431,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755789960
    },
    {
        "content": "<p><a href=\"https://github.com/vouillon\">vouillon</a> added the bug label to <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11489\">Issue #11489</a>.</p>",
        "id": 535528432,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755789960
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11489#issuecomment-3211342202\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11489\">issue #11489</a>:</p>\n<blockquote>\n<p>Thanks -- taking a look!</p>\n</blockquote>",
        "id": 535541660,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755794347
    },
    {
        "content": "<p>cfallin <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11489#issuecomment-3211426249\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11489\">issue #11489</a>:</p>\n<blockquote>\n<p>OK, I think the bug is that I didn't account for the tail-call arg region cleanup when computing the SP for a given frame. I had assumed that all function frames are contiguous, so <code>FP+16</code> (<code>16</code> coming from the unwind trait impl, but that's the value on all our 64-bit platforms) is the <code>SP</code> of the next higher function frame. We use that to load the dynamic context, which we use to compare dynamic tag identities of handlers. Our tail-call ABI has the <em>callee</em> clean up the argument region, since this is necessary to allow arbitrary-to-arbitrary-signature tail calls, and your example has a tail-call from a function of signature <code>(func)</code> to one of signature <code>(func (param i32 i32 i32 i32 i32))</code> (which will go onto the stack on x64, because there are 6 arg regs and we use the first two for caller and callee vmctx). On x64 we use the form of the <code>ret</code> instruction with an SP increment for this (doesn't appear in the disassembly here, but only because <code>$throw</code> ends in an unconditional unreachable state because of the <code>throw</code>).</p>\n<p>I believe the most robust fix for this is to reference dynamic context off of <code>FP</code> instead of <code>SP</code> -- otherwise we need metadata from functions to know their <code>FrameLayout</code> at runtime, which is a much bigger lift. I'll work on that.</p>\n</blockquote>",
        "id": 535545120,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755795875
    }
]
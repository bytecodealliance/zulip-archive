[
    {
        "content": "<p>fitzgen opened <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12381\">PR #12381</a> from <code>fitzgen:fallible-alloc-for-compound-bit-set</code> to <code>bytecodealliance:main</code>:</p>\n<blockquote>\n<p>Part of <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12069\">https://github.com/bytecodealliance/wasmtime/issues/12069</a></p>\n</blockquote>",
        "id": 569342692,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769025160
    },
    {
        "content": "<p><strong>fitzgen</strong> requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers\">wasmtime-compiler-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12381\">PR #12381</a>.</p>",
        "id": 569342693,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769025161
    },
    {
        "content": "<p><strong>fitzgen</strong> requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-default-reviewers\">wasmtime-default-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12381\">PR #12381</a>.</p>",
        "id": 569342695,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769025161
    },
    {
        "content": "<p><strong>fitzgen</strong> requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-fuzz-reviewers\">wasmtime-fuzz-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12381\">PR #12381</a>.</p>",
        "id": 569342696,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769025161
    },
    {
        "content": "<p><strong>fitzgen</strong> requested <a href=\"https://github.com/alexcrichton\">alexcrichton</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12381\">PR #12381</a>.</p>",
        "id": 569342697,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769025162
    },
    {
        "content": "<p>fitzgen updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12381\">PR #12381</a>.</p>",
        "id": 569343351,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769025379
    },
    {
        "content": "<p>alexcrichton submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12381#pullrequestreview-3689539614\">PR review</a>.</p>",
        "id": 569362550,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769031892
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12381#discussion_r2714453495\">PR review comment</a>:</p>\n<blockquote>\n<p>As we go down this route I think that ideally we'd keep all the <code>unsafe</code> fiddly bits in one place, e.g. the <code>wasmtime-environ::collections</code> module. In that sense I'd prefer if we didn't have to dip into <code>unsafe</code> for cases like this. To that extent WDYT of one of:</p>\n<ul>\n<li>Switching this to using a <code>Vec</code> which means no <code>unsafe</code> needed</li>\n<li>Adding fallible-slice-allocation-primitives to <code>wasmtime_environ::collections</code></li>\n<li>Build a <code>Vec</code> here, fallibly, and then convert it to <code>Box&lt;[T]&gt;</code></li>\n</ul>\n</blockquote>",
        "id": 569362551,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769031892
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12381#discussion_r2714455468\">PR review comment</a>:</p>\n<blockquote>\n<p>\"how low... can you go...\"</p>\n</blockquote>",
        "id": 569362552,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769031892
    },
    {
        "content": "<p>fitzgen submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12381#pullrequestreview-3689593452\">PR review</a>.</p>",
        "id": 569364505,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769032643
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12381#discussion_r2714500191\">PR review comment</a>:</p>\n<blockquote>\n<blockquote>\n<p>Adding fallible-slice-allocation-primitives to <code>wasmtime_environ::collections</code></p>\n</blockquote>\n<p>This one won't work in this case because of crate dependencies.</p>\n<blockquote>\n<p>Build a <code>Vec</code> here, fallibly, and then convert it to <code>Box&lt;[T]&gt;</code></p>\n</blockquote>\n<p>This one won't work (at least without some extra care) because <code>Vec&lt;T&gt;</code>-to-<code>Box&lt;[T]&gt;</code> will resize to the exact length so as not to leak the extra capacity, which requires (re)allocation.</p>\n<p>So I guess that leaves us with switching to a <code>Vec</code> of these options.</p>\n<hr>\n<p>But also, while I agree we don't want <code>unsafe</code> fiddly bits spread all over the place willy nilly, I don't think that having <code>unsafe</code> here is really violating that principle in spirit because it is limited to just this collection's internals and is well encapsulated. That is, although this cannot move to <code>wasmtime_environ::collections</code> due to crate deps, it feels to me like it sort of morally is the same thing that <code>wasmtime_environ::collections</code> is.</p>\n<p>How strongly do you feel in this particular case? (with the acknowledgement that we want to coalesce and encapsulate all the <code>unsafe</code> OOM-handling collections stuff as much as possible)</p>\n<hr>\n<p>The _other_ alternative would be to add a new crate in our workspace to hold the <code>unsafe</code> allocation bits for collections and move existing utilities like <a href=\"https://github.com/bytecodealliance/wasmtime/blob/a05256911e832985ef0778dfe3786c59195cbf68/crates/environ/src/collections.rs#L49\"><code>try_alloc</code></a> into that new crate. This way we would be able to put all the little <code>unsafe</code> helpers in one place, but it kind of feels like a lot of work for not that much gain...</p>\n</blockquote>",
        "id": 569364506,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769032643
    },
    {
        "content": "<p>alexcrichton submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12381#pullrequestreview-3689612303\">PR review</a>.</p>",
        "id": 569365502,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769033031
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12381#discussion_r2714517383\">PR review comment</a>:</p>\n<blockquote>\n<p>What I'm also worried about is that if any of this code panics:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">        </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">bitset</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"bp\">self</span>\n<span class=\"w\">            </span><span class=\"p\">.</span><span class=\"n\">elems</span>\n<span class=\"w\">            </span><span class=\"p\">.</span><span class=\"n\">iter</span><span class=\"p\">()</span>\n<span class=\"w\">            </span><span class=\"p\">.</span><span class=\"n\">copied</span><span class=\"p\">()</span>\n<span class=\"w\">            </span><span class=\"p\">.</span><span class=\"n\">chain</span><span class=\"p\">(</span><span class=\"n\">iter</span><span class=\"p\">::</span><span class=\"n\">repeat</span><span class=\"p\">(</span><span class=\"n\">ScalarBitSet</span><span class=\"p\">::</span><span class=\"n\">new</span><span class=\"p\">()).</span><span class=\"n\">take</span><span class=\"p\">(</span><span class=\"n\">to_grow</span><span class=\"p\">))</span>\n<span class=\"w\">            </span><span class=\"p\">.</span><span class=\"n\">enumerate</span><span class=\"p\">()</span>\n<span class=\"w\">        </span><span class=\"p\">{</span>\n<span class=\"w\">            </span><span class=\"c1\">// Safety: the pointer points to a block that is valid for an array</span>\n<span class=\"w\">            </span><span class=\"c1\">// of length `new_len` and indexing by `i` is within that block.</span>\n<span class=\"w\">            </span><span class=\"fm\">debug_assert!</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"w\"> </span><span class=\"n\">new_len</span><span class=\"p\">);</span>\n<span class=\"w\">            </span><span class=\"k\">unsafe</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">                </span><span class=\"n\">ptr</span><span class=\"p\">.</span><span class=\"n\">add</span><span class=\"p\">(</span><span class=\"n\">i</span><span class=\"p\">).</span><span class=\"n\">write</span><span class=\"p\">(</span><span class=\"n\">bitset</span><span class=\"p\">);</span>\n<span class=\"w\">            </span><span class=\"p\">}</span>\n<span class=\"w\">        </span><span class=\"p\">}</span>\n</code></pre></div>\n<p>then the memory is leaked (no dtor for anything in that range).</p>\n<p>We could move <code>wasmtime_environ::collections</code> into its own crate to solve the crate dep problem. I'm sort of a fan of consolidating <code>wasmtime-{internal-error,internal-math}</code> and collections into one crate (e.g. <code>wasmtime-internal-core</code>) where the main purpose of the crate is \"only no_std dependencies, also very limited deps\"</p>\n<blockquote>\n<p>I don't think that having unsafe here is really violating that principle in spirit because it is limited to just this collection's internals and is well encapsulated</p>\n</blockquote>\n<p>I agree with this, but I think we should strive even further than this and encapsulating more. For example I don't think that <code>cranelift-bitset</code>'s tests are run through Miri (although they almost certainly could be), but all of <code>wasmtime_environ</code>'s tests are already run through Miri. I think there's basically a lot of benefit to absolutely minimizing <code>unsafe</code> code and what exactly the contract is doing. I understand it's simpler to just do a bunch of one-off small-ish edits, but this is sort of blazing the trail for custom collections in Wasmtime and I'd prefer idioms that favor safe/small functions with limited <code>unsafe</code> inside and exposing as much as we can via type signatures.</p>\n</blockquote>",
        "id": 569365504,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769033031
    },
    {
        "content": "<p>github-actions[bot] added the label <code>cranelift</code> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12381\">PR #12381</a>.</p>",
        "id": 569380242,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769039310
    },
    {
        "content": "<p>github-actions[bot] added the label <code>fuzzing</code> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12381\">PR #12381</a>.</p>",
        "id": 569380243,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769039310
    },
    {
        "content": "<p>github-actions[bot] <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12381#issuecomment-3781683798\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12381\">PR #12381</a>:</p>\n<blockquote>\n<h4>Subscribe to Label Action</h4>\n<p>cc @fitzgen</p>\n<p>&lt;details&gt;<br>\nThis issue or pull request has been labeled: \"cranelift\", \"fuzzing\"</p>\n<p>Thus the following users have been cc'd because of the following labels:</p>\n<ul>\n<li>fitzgen: fuzzing</li>\n</ul>\n<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>\n<p><a href=\"https://github.com/bytecodealliance/subscribe-to-label-action\">Learn more.</a><br>\n&lt;/details&gt;</p>\n</blockquote>",
        "id": 569380294,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769039334
    },
    {
        "content": "<p><strong>fitzgen</strong> requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers\">wasmtime-core-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12381\">PR #12381</a>.</p>",
        "id": 569575612,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769111181
    },
    {
        "content": "<p>fitzgen updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12381\">PR #12381</a>.</p>",
        "id": 569575613,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769111182
    },
    {
        "content": "<p><strong>fitzgen</strong> requested <a href=\"https://github.com/pchickey\">pchickey</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12381\">PR #12381</a>.</p>",
        "id": 569575614,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769111182
    },
    {
        "content": "<p>fitzgen submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12381#pullrequestreview-3694275283\">PR review</a>.</p>",
        "id": 569575790,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769111250
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12381#discussion_r2718373920\">PR review comment</a>:</p>\n<blockquote>\n<p>Okay in the most recently pushed commits I created the <code>wasmtime-internal-core</code> crate and moved the low-level allocation helpers into there and made <code>CompoundBitSet::try_ensure_capacity</code> fully safe.</p>\n</blockquote>",
        "id": 569575793,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769111251
    },
    {
        "content": "<p><strong>fitzgen</strong> requested <a href=\"https://github.com/alexcrichton\">alexcrichton</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12381\">PR #12381</a>.</p>",
        "id": 569580371,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769112826
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12381#discussion_r2718772217\">PR review comment</a>:</p>\n<blockquote>\n<p>Personally I'd say that wasmtime-{math,error} could get folded in here too (probably in a future PR), but wanted to confirm/deny your thoughts on that?</p>\n</blockquote>",
        "id": 569596047,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769119160
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12381#discussion_r2718784199\">PR review comment</a>:</p>\n<blockquote>\n<p>I think <a href=\"https://doc.rust-lang.org/stable/std/boxed/struct.Box.html#method.assume_init-1\"><code>boxed.assume_init()</code></a> will work here?</p>\n</blockquote>",
        "id": 569596048,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769119161
    },
    {
        "content": "<p>alexcrichton submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12381#pullrequestreview-3694757105\">PR review</a>.</p>",
        "id": 569596049,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769119161
    },
    {
        "content": "<p>fitzgen submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12381#pullrequestreview-3694985114\">PR review</a>.</p>",
        "id": 569604857,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769123244
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12381#discussion_r2718964602\">PR review comment</a>:</p>\n<blockquote>\n<p>I'm half of the mind that there is no need to eagerly merge crates if we don't have any reason to do so, but I don't feel strongly at all. Anyways, I don't think there is anything blocking that, but I don't have any plans on doing it myself.</p>\n</blockquote>",
        "id": 569604858,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769123245
    },
    {
        "content": "<p>fitzgen submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12381#pullrequestreview-3694990011\">PR review</a>.</p>",
        "id": 569604993,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769123312
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12381#discussion_r2718968530\">PR review comment</a>:</p>\n<blockquote>\n<p>Thanks, I was searching all over because I was sure that this existed, but couldn't find it. rustdoc is not great for surfacing methods on like <code>Box&lt;[T]&gt;</code> instead of <code>Box&lt;T&gt;</code>.</p>\n</blockquote>",
        "id": 569604996,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769123312
    },
    {
        "content": "<p>fitzgen updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12381\">PR #12381</a>.</p>",
        "id": 569605272,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769123469
    },
    {
        "content": "<p>fitzgen has enabled auto merge for <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12381\">PR #12381</a>.</p>",
        "id": 569605291,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769123480
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12381#issuecomment-3787244590\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12381\">PR #12381</a>:</p>\n<blockquote>\n<p>Oh also, along the lines of crate consolidation, can you add this crate to the Miri-tested crates in CI? I'll do a follow-up to merge our core utilities into this crate</p>\n</blockquote>",
        "id": 569606009,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769123855
    },
    {
        "content": "<p>fitzgen added <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12381\">PR #12381 Add fallible allocation methods to <code>cranelift_bitset::CompoundBitSet</code></a> to the merge queue</p>",
        "id": 569606748,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769124278
    },
    {
        "content": "<p>fitzgen merged <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12381\">PR #12381</a>.</p>",
        "id": 569609445,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769125676
    },
    {
        "content": "<p>fitzgen removed <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12381\">PR #12381 Add fallible allocation methods to <code>cranelift_bitset::CompoundBitSet</code></a> from the merge queue</p>",
        "id": 569609449,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769125676
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12381#issuecomment-3787822151\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12381\">PR #12381</a>:</p>\n<blockquote>\n<blockquote>\n<p>can you add this crate to the Miri-tested crates in CI</p>\n</blockquote>\n<p>I'm doing this in <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12398\">https://github.com/bytecodealliance/wasmtime/pull/12398</a></p>\n</blockquote>",
        "id": 569623975,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769134889
    }
]
[
    {
        "content": "<p><strong>abrown</strong> requested <a href=\"https://github.com/cfallin\">cfallin</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10260\">PR #10260</a>.</p>",
        "id": 500951170,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1740078398
    },
    {
        "content": "<p><strong>abrown</strong> requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers\">wasmtime-compiler-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10260\">PR #10260</a>.</p>",
        "id": 500951172,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1740078398
    },
    {
        "content": "<p>abrown opened <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10260\">PR #10260</a> from <code>abrown:assembler-priorities</code> to <code>bytecodealliance:main</code>:</p>\n<blockquote>\n<p>See commit messages for details.</p>\n</blockquote>",
        "id": 500951176,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1740078399
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10260#pullrequestreview-2630917726\">PR review</a>:</p>\n<blockquote>\n<p>Thanks! Some thoughts on ordering below but otherwise LGTM.</p>\n</blockquote>",
        "id": 500953178,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1740079169
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10260#discussion_r1964204723\">PR review comment</a>:</p>\n<blockquote>\n<p>It may be a personal preference, but I find the rule-sets easier to read / double-check when they are sorted descending by priority, rather than organized by some other column (type, here). Would you mind regrouping that way so we can see the overall prioritization?</p>\n</blockquote>",
        "id": 500953181,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1740079170
    },
    {
        "content": "<p>abrown submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10260#pullrequestreview-2630953990\">PR review</a>.</p>",
        "id": 500955662,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1740080104
    },
    {
        "content": "<p>abrown created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10260#discussion_r1964226341\">PR review comment</a>:</p>\n<blockquote>\n<p>I agree that we should do descending priority (<code>3 ... 2 ... 1</code>) but this type-based reorganization is @alexcrichton's doing. @alexcrichton, thoughts?</p>\n</blockquote>",
        "id": 500955664,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1740080104
    },
    {
        "content": "<p>abrown submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10260#pullrequestreview-2630958009\">PR review</a>.</p>",
        "id": 500955961,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1740080227
    },
    {
        "content": "<p>abrown created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10260#discussion_r1964228705\">PR review comment</a>:</p>\n<blockquote>\n<p>(another question is what should the priorities be: shouldn't GPR-matching be highest priority since we expect that to be picked most often? Etc.)</p>\n</blockquote>",
        "id": 500955962,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1740080227
    },
    {
        "content": "<p>abrown submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10260#pullrequestreview-2630959449\">PR review</a>.</p>",
        "id": 500956064,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1740080273
    },
    {
        "content": "<p>abrown created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10260#discussion_r1964229492\">PR review comment</a>:</p>\n<blockquote>\n<p>Here's reordered by @alexcrichton's priorities and I don't think the grouping is intuitive:</p>\n<p><div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"p\">(</span><span class=\"n\">rule</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">x64_add</span><span class=\"w\"> </span><span class=\"cp\">$I8</span><span class=\"w\">  </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">is_mem</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span><span class=\"w\">     </span><span class=\"p\">(</span><span class=\"n\">x64_addb_rm</span><span class=\"w\"> </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span>\n<span class=\"p\">(</span><span class=\"n\">rule</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">x64_add</span><span class=\"w\"> </span><span class=\"cp\">$I16</span><span class=\"w\"> </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">is_mem</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span><span class=\"w\">     </span><span class=\"p\">(</span><span class=\"n\">x64_addw_rm</span><span class=\"w\"> </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span>\n<span class=\"p\">(</span><span class=\"n\">rule</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">x64_add</span><span class=\"w\"> </span><span class=\"cp\">$I32</span><span class=\"w\"> </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">is_gpr_mem</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">x64_addl_rm</span><span class=\"w\"> </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span>\n<span class=\"p\">(</span><span class=\"n\">rule</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">x64_add</span><span class=\"w\"> </span><span class=\"cp\">$I64</span><span class=\"w\"> </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">is_gpr_mem</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">x64_addq_rm</span><span class=\"w\"> </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span>\n<span class=\"p\">(</span><span class=\"n\">rule</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">x64_add</span><span class=\"w\"> </span><span class=\"cp\">$I8</span><span class=\"w\">  </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">is_gpr</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span><span class=\"w\">     </span><span class=\"p\">(</span><span class=\"n\">x64_addl_rm</span><span class=\"w\"> </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span>\n<span class=\"p\">(</span><span class=\"n\">rule</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">x64_add</span><span class=\"w\"> </span><span class=\"cp\">$I16</span><span class=\"w\"> </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">is_gpr</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span><span class=\"w\">     </span><span class=\"p\">(</span><span class=\"n\">x64_addl_rm</span><span class=\"w\"> </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span>\n<span class=\"p\">(</span><span class=\"n\">rule</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">x64_add</span><span class=\"w\"> </span><span class=\"cp\">$I32</span><span class=\"w\"> </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">is_simm8</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span><span class=\"w\">   </span><span class=\"p\">(</span><span class=\"n\">x64_addl_mi_sxb</span><span class=\"w\"> </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span>\n<span class=\"p\">(</span><span class=\"n\">rule</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">x64_add</span><span class=\"w\"> </span><span class=\"cp\">$I64</span><span class=\"w\"> </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">is_simm8</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span><span class=\"w\">   </span><span class=\"p\">(</span><span class=\"n\">x64_addq_mi_sxb</span><span class=\"w\"> </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span>\n<span class=\"p\">(</span><span class=\"n\">rule</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">x64_add</span><span class=\"w\"> </span><span class=\"cp\">$I8</span><span class=\"w\">  </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">is_imm8</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span><span class=\"w\">    </span><span class=\"p\">(</span><span class=\"n\">x64_addb_mi</span><span class=\"w\"> </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span>\n<span class=\"p\">(</span><span class=\"n\">rule</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">x64_add</span><span class=\"w\"> </span><span class=\"cp\">$I16</span><span class=\"w\"> </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">is_imm16</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span><span class=\"w\">   </span><span class=\"p\">(</span><span class=\"n\">x64_addw_mi</span><span class=\"w\"> </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span>\n<span class=\"p\">(</span><span class=\"n\">rule</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">x64_add</span><span class=\"w\"> </span><span class=\"cp\">$I32</span><span class=\"w\"> </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">is_imm32</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span><span class=\"w\">   </span><span class=\"p\">(</span><span class=\"n\">x64_addl_mi</span><span class=\"w\"> </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span>\n<span class=\"p\">(</span><span class=\"n\">rule</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">x64_add</span><span class=\"w\"> </span><span class=\"cp\">$I64</span><span class=\"w\"> </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">is_simm32</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span><span class=\"w\">  </span><span class=\"p\">(</span><span class=\"n\">x64_addq_mi_sxl</span><span class=\"w\"> </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span>\n</code></pre></div><br>\n</p>\n</blockquote>",
        "id": 500956066,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1740080274
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10260#pullrequestreview-2630978128\">PR review</a>.</p>",
        "id": 500957477,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1740080834
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10260#discussion_r1964240529\">PR review comment</a>:</p>\n<blockquote>\n<p>Hmm, yeah, that's pretty subtle too.</p>\n<p>I guess I'm curious about the motivation to \"compress\" priorities and make more use of non-overlap: if we know for sure the order in which we want rules to match, I personally don't see a huge issue with linearizing priorities (i.e. encoding a more total order than strictly required to resolve overlaps), if it makes the code clearer.</p>\n<p>Alternately if rules are grouped into \"totally ordered subgroups\", closer to what this PR had, it's not the worst thing if it's fully regular and if the groups are visually separated. I think I was partly reacting to the reverse ordering (lower prio rules first) and the bunched-up view that makes it harder to see the overall shape.</p>\n</blockquote>",
        "id": 500957478,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1740080835
    },
    {
        "content": "<p>alexcrichton submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10260#pullrequestreview-2631304637\">PR review</a>.</p>",
        "id": 500981869,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1740090696
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10260#discussion_r1964428778\">PR review comment</a>:</p>\n<blockquote>\n<p>Personally I prefer logical grouping by \"thing\" rather than priority per-se, an example is <a href=\"https://github.com/bytecodealliance/wasmtime/blob/acef4083d272ed5ae369a4a5dadc603fa79820a7/cranelift/codegen/src/isa/pulley_shared/lower.isle#L251-L300\"><code>isub</code> in pulley</a>. IIRC I've written rules like this on x64 as well, but I may also be misremembering.</p>\n<p>As for the original motivation: personally I  think we should try to avoid \"just keep adding one to the priority until it compiles\" because (a) it feels bad and (b) I'm led to believe the generated code is worse to be a sequence of matches rather than \"one big <code>match</code>\".</p>\n<p>In the abstract there shouldn't be priorities in these rules at all, everything is disjoint. It should be one giant match and we should be able to do <code>(GprMemImm.Mem addr)</code> or something like that. That doesn't work because <code>GprMemImm</code> is a newtype wrapper around <code>RegMemImm</code> which can't be pattern-matched in ISLE.</p>\n<p>In my mind I'm trying to nudge in the direction of removing the priorities here by reducing the number of priorities. Here I agree though that having an ascending/descending list of priorities helps see things. For example @abrown with  the list you <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10260#discussion_r1964229492\">pasted</a> it seems like we can clean this up a bit:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"p\">(</span><span class=\"n\">rule</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">x64_add</span><span class=\"w\"> </span><span class=\"cp\">$I8</span><span class=\"w\">  </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">is_mem</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span><span class=\"w\">     </span><span class=\"p\">(</span><span class=\"n\">x64_addb_rm</span><span class=\"w\"> </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span>\n<span class=\"p\">(</span><span class=\"n\">rule</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">x64_add</span><span class=\"w\"> </span><span class=\"cp\">$I16</span><span class=\"w\"> </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">is_mem</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span><span class=\"w\">     </span><span class=\"p\">(</span><span class=\"n\">x64_addw_rm</span><span class=\"w\"> </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span>\n<span class=\"p\">(</span><span class=\"n\">rule</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">x64_add</span><span class=\"w\"> </span><span class=\"cp\">$I32</span><span class=\"w\"> </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">is_gpr_mem</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">x64_addl_rm</span><span class=\"w\"> </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span>\n<span class=\"p\">(</span><span class=\"n\">rule</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">x64_add</span><span class=\"w\"> </span><span class=\"cp\">$I64</span><span class=\"w\"> </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">is_gpr_mem</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">x64_addq_rm</span><span class=\"w\"> </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span>\n<span class=\"p\">(</span><span class=\"n\">rule</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">x64_add</span><span class=\"w\"> </span><span class=\"cp\">$I8</span><span class=\"w\">  </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">is_gpr</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span><span class=\"w\">     </span><span class=\"p\">(</span><span class=\"n\">x64_addl_rm</span><span class=\"w\"> </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span>\n<span class=\"p\">(</span><span class=\"n\">rule</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">x64_add</span><span class=\"w\"> </span><span class=\"cp\">$I16</span><span class=\"w\"> </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">is_gpr</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span><span class=\"w\">     </span><span class=\"p\">(</span><span class=\"n\">x64_addl_rm</span><span class=\"w\"> </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span>\n<span class=\"p\">;;</span><span class=\"w\"> </span><span class=\"n\">imm</span><span class=\"w\"> </span><span class=\"n\">things</span>\n</code></pre></div>\n<p>to instead be</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"p\">(</span><span class=\"n\">rule</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">x64_add</span><span class=\"w\"> </span><span class=\"cp\">$I8</span><span class=\"w\">  </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">is_gpr_mem</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">x64_addb_rm</span><span class=\"w\"> </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span>\n<span class=\"p\">(</span><span class=\"n\">rule</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">x64_add</span><span class=\"w\"> </span><span class=\"cp\">$I16</span><span class=\"w\"> </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">is_gpr_mem</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">x64_addw_rm</span><span class=\"w\"> </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span>\n<span class=\"p\">(</span><span class=\"n\">rule</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">x64_add</span><span class=\"w\"> </span><span class=\"cp\">$I32</span><span class=\"w\"> </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">is_gpr_mem</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">x64_addl_rm</span><span class=\"w\"> </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span>\n<span class=\"p\">(</span><span class=\"n\">rule</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">x64_add</span><span class=\"w\"> </span><span class=\"cp\">$I64</span><span class=\"w\"> </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">is_gpr_mem</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">x64_addq_rm</span><span class=\"w\"> </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span>\n\n<span class=\"p\">;;</span><span class=\"w\"> </span><span class=\"n\">imm</span><span class=\"w\"> </span><span class=\"n\">things</span>\n</code></pre></div>\n<p>I think that should have no loss of generality? (and we could probably remove the <code>is_mem</code> constructor since uses of that probably want to gbe <code>is_gpr_mem</code> instead).</p>\n<hr>\n<p>So altogether, how about this:</p>\n<ul>\n<li>Group by priority on the instructions, and within a priority sort-by-type.</li>\n<li>One priority is <code>is_gpr_mem</code> which handles the <code>GprMem</code> of the <code>GprMemImm</code> argument</li>\n<li>Another priority is the various imm extractors, e.g. <code>simm8</code> vs <code>imm32</code> in the <code>I32</code> case. </li>\n</ul>\n</blockquote>",
        "id": 500981871,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1740090696
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10260#pullrequestreview-2631340728\">PR review</a>.</p>",
        "id": 500983532,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1740091393
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10260#discussion_r1964450421\">PR review comment</a>:</p>\n<blockquote>\n<p>That sounds good to me; all my opinions are weakly-held, I mostly just want to be able to easily decipher how the rules layer, and that seems like an improvement.</p>\n</blockquote>",
        "id": 500983534,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1740091394
    },
    {
        "content": "<p>abrown submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10260#pullrequestreview-2633908165\">PR review</a>.</p>",
        "id": 501163097,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1740162538
    },
    {
        "content": "<p>abrown created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10260#discussion_r1965989828\">PR review comment</a>:</p>\n<blockquote>\n<p>Nah, @alexcrichton, we can't just use <code>is_gpr_mem</code> everywhere. For those smaller widths, we are actually emitting two different instructions based whether <code>is_mem</code> or <code>is_gpr</code> fires.</p>\n<p>I'm not sure I understand how to decipher the last paragraph there and I would say I don't really care too much either way except that we need to actually get the priorities correct and clear or we have to fix things again like in e6a97ad. What is weird here is that some priorities don't really matter but others do, like the imm extractors you point out.</p>\n</blockquote>",
        "id": 501163099,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1740162538
    },
    {
        "content": "<p>abrown edited <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10260#discussion_r1965989828\">PR review comment</a>.</p>",
        "id": 501163128,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1740162550
    },
    {
        "content": "<p>alexcrichton submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10260#pullrequestreview-2633992676\">PR review</a>.</p>",
        "id": 501169957,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1740164904
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10260#discussion_r1966037979\">PR review comment</a>:</p>\n<blockquote>\n<p>Oh d'oh that's right, I keep forgetting about the subtelties here...</p>\n<p>Ah yeah I also don't mean to say priorities don't matter, because you're right they do for immediates. How about:</p>\n<p><div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"p\">;;</span><span class=\"w\"> </span><span class=\"n\">special</span><span class=\"w\"> </span><span class=\"n\">case</span><span class=\"w\"> </span><span class=\"n\">smaller</span><span class=\"w\"> </span><span class=\"n\">immediates</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">smaller</span><span class=\"w\"> </span><span class=\"n\">instruction</span><span class=\"w\"> </span><span class=\"n\">encoding</span>\n<span class=\"p\">(</span><span class=\"n\">rule</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">x64_add</span><span class=\"w\"> </span><span class=\"cp\">$I32</span><span class=\"w\"> </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">is_simm8</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span><span class=\"w\">   </span><span class=\"p\">(</span><span class=\"n\">x64_addl_mi_sxb</span><span class=\"w\"> </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span>\n<span class=\"p\">(</span><span class=\"n\">rule</span><span class=\"w\"> </span><span class=\"mi\">3</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">x64_add</span><span class=\"w\"> </span><span class=\"cp\">$I64</span><span class=\"w\"> </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">is_simm8</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span><span class=\"w\">   </span><span class=\"p\">(</span><span class=\"n\">x64_addq_mi_sxb</span><span class=\"w\"> </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span>\n\n<span class=\"p\">;;</span><span class=\"w\"> </span><span class=\"n\">matching</span><span class=\"w\"> </span><span class=\"n\">immediates</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">corresponding</span><span class=\"w\"> </span><span class=\"n\">instruction</span>\n<span class=\"p\">(</span><span class=\"n\">rule</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">x64_add</span><span class=\"w\"> </span><span class=\"cp\">$I8</span><span class=\"w\">  </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">is_imm8</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span><span class=\"w\">    </span><span class=\"p\">(</span><span class=\"n\">x64_addb_mi</span><span class=\"w\"> </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span>\n<span class=\"p\">(</span><span class=\"n\">rule</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">x64_add</span><span class=\"w\"> </span><span class=\"cp\">$I16</span><span class=\"w\"> </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">is_imm16</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span><span class=\"w\">   </span><span class=\"p\">(</span><span class=\"n\">x64_addw_mi</span><span class=\"w\"> </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span>\n<span class=\"p\">(</span><span class=\"n\">rule</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">x64_add</span><span class=\"w\"> </span><span class=\"cp\">$I32</span><span class=\"w\"> </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">is_imm32</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span><span class=\"w\">   </span><span class=\"p\">(</span><span class=\"n\">x64_addl_mi</span><span class=\"w\"> </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span>\n<span class=\"p\">(</span><span class=\"n\">rule</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">x64_add</span><span class=\"w\"> </span><span class=\"cp\">$I64</span><span class=\"w\"> </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">is_simm32</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span><span class=\"w\">  </span><span class=\"p\">(</span><span class=\"n\">x64_addq_mi_sxl</span><span class=\"w\"> </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span>\n\n<span class=\"p\">;;</span><span class=\"w\"> </span><span class=\"n\">extend</span><span class=\"w\"> </span><span class=\"mi\">8</span><span class=\"o\">/</span><span class=\"mi\">16</span><span class=\"o\">-</span><span class=\"n\">bit</span><span class=\"w\"> </span><span class=\"n\">register</span><span class=\"o\">-</span><span class=\"n\">to</span><span class=\"o\">-</span><span class=\"n\">register</span><span class=\"w\"> </span><span class=\"n\">addition</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">avoid</span><span class=\"w\"> </span><span class=\"kc\">false</span><span class=\"w\"> </span><span class=\"n\">dependencies</span>\n<span class=\"p\">;;</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"n\">previous</span><span class=\"w\"> </span><span class=\"n\">instructions</span>\n<span class=\"p\">(</span><span class=\"n\">rule</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">x64_add</span><span class=\"w\"> </span><span class=\"cp\">$I8</span><span class=\"w\">  </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">is_gpr</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span><span class=\"w\">     </span><span class=\"p\">(</span><span class=\"n\">x64_addl_rm</span><span class=\"w\"> </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span>\n<span class=\"p\">(</span><span class=\"n\">rule</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">x64_add</span><span class=\"w\"> </span><span class=\"cp\">$I16</span><span class=\"w\"> </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">is_gpr</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span><span class=\"w\">     </span><span class=\"p\">(</span><span class=\"n\">x64_addl_rm</span><span class=\"w\"> </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span>\n\n<span class=\"p\">;;</span><span class=\"w\"> </span><span class=\"n\">matching</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">operand</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">size</span><span class=\"w\"> </span><span class=\"n\">of</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">instruction</span>\n<span class=\"p\">(</span><span class=\"n\">rule</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">x64_add</span><span class=\"w\"> </span><span class=\"cp\">$I8</span><span class=\"w\">  </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">is_mem</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span><span class=\"w\">     </span><span class=\"p\">(</span><span class=\"n\">x64_addb_rm</span><span class=\"w\"> </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span>\n<span class=\"p\">(</span><span class=\"n\">rule</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">x64_add</span><span class=\"w\"> </span><span class=\"cp\">$I16</span><span class=\"w\"> </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">is_mem</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span><span class=\"w\">     </span><span class=\"p\">(</span><span class=\"n\">x64_addw_rm</span><span class=\"w\"> </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span>\n<span class=\"p\">(</span><span class=\"n\">rule</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">x64_add</span><span class=\"w\"> </span><span class=\"cp\">$I32</span><span class=\"w\"> </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">is_gpr_mem</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">x64_addl_rm</span><span class=\"w\"> </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span>\n<span class=\"p\">(</span><span class=\"n\">rule</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">x64_add</span><span class=\"w\"> </span><span class=\"cp\">$I64</span><span class=\"w\"> </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">is_gpr_mem</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">x64_addq_rm</span><span class=\"w\"> </span><span class=\"n\">src1</span><span class=\"w\"> </span><span class=\"n\">src2</span><span class=\"p\">))</span>\n</code></pre></div><br>\n</p>\n</blockquote>",
        "id": 501169959,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1740164905
    },
    {
        "content": "<p>alexcrichton submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10260#pullrequestreview-2633993890\">PR review</a>.</p>",
        "id": 501170037,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1740164943
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10260#discussion_r1966038809\">PR review comment</a>:</p>\n<blockquote>\n<p>Technically the 0-priority rules for 8/16-bit addition could also be <code>is_gpr_mem</code> I think? The 1-priority rules are just an optimization</p>\n</blockquote>",
        "id": 501170039,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1740164943
    },
    {
        "content": "<p>abrown updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10260\">PR #10260</a>.</p>",
        "id": 501211644,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1740186363
    },
    {
        "content": "<p>abrown updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10260\">PR #10260</a>.</p>",
        "id": 501214005,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1740188278
    },
    {
        "content": "<p>abrown submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10260#pullrequestreview-2634581723\">PR review</a>.</p>",
        "id": 501214083,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1740188318
    },
    {
        "content": "<p>abrown created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10260#discussion_r1966380047\">PR review comment</a>:</p>\n<blockquote>\n<p><span aria-label=\"+1\" class=\"emoji emoji-1f44d\" role=\"img\" title=\"+1\">:+1:</span> I'll remove <code>is_mem</code> for now... might need it again in the future.</p>\n</blockquote>",
        "id": 501214084,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1740188318
    },
    {
        "content": "<p>abrown has enabled auto merge for <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10260\">PR #10260</a>.</p>",
        "id": 501214093,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1740188333
    },
    {
        "content": "<p>abrown merged <a href=\"https://github.com/bytecodealliance/wasmtime/pull/10260\">PR #10260</a>.</p>",
        "id": 501216821,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1740190515
    }
]
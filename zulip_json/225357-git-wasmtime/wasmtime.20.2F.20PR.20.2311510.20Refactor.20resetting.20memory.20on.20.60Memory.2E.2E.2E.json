[
    {
        "content": "<p>alexcrichton opened <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11510\">PR #11510</a> from <code>alexcrichton:no-clear-on-drop</code> to <code>bytecodealliance:main</code>:</p>\n<blockquote>\n<p>This commit refactors the behavior of dropping a <code>MemoryImageSlot</code> to no longer map anonymous memory into the slot. This behavior was implemented previously because if a <code>MemoryImageSlot</code> is dropped then the state of the slot is unknown and to prevent any sort of data leakage a reset is performed.</p>\n<p>This reset operation, however, is fallible in that it calls <code>mmap</code>. Calls to <code>mmap</code> can fail due to <code>ENOMEM</code>, for example, if the process has reached its VMA limit. This means that if a process is in a near-OOM condition then failing to allocate a memory image could panic the process due to the <code>unwrap()</code> in the destructor of <code>MemoryImageSlot</code>. The purpose of this commit is to avoid this <code>unwrap()</code> and instead move the reset behavior to a location where an error can be propagated.</p>\n<p>This commit removes the clear-on-drop behavior of <code>MemoryImageSlot</code> slot. This was already disabled everywhere except the pooling allocator. The pooling allocator now maintains an extra bit of state-per-slot where instead of storing <code>Option&lt;MemoryImageSlot&gt;</code> it now stores effectively one other variant of \"unknown\". On reuse of an \"unknown\" slot the memory is reset back to an anonymous mapping and this is all done in a context where an error can be propagated.</p>\n<p>Two tests are added in this commit to confirm all of this behavior:</p>\n<ul>\n<li>\n<p>The first test is a new test that passes both before and after this commit which performs a failed allocation of a memory slot. A successful allocation is then made to ensure that the previous image is not present and zero memory is present. This test fails before the commit if the clear-on-drop behavior is removed, and it fails with this commit if the clear-on-reusing-unknown behavior is removed. Effectively this test ensures that the clear-on-unknown-state logic is present.</p>\n</li>\n<li>\n<p>The second test is a new test that panicked before this commit and passes afterwards. This second test exhausts all VMAs in the current process, or at least most of them, and then tries to allocate some instances with an image. Instance allocation will eventually fail and cause the erroneous path to get executed. This previously unwrapped a <code>ENOMEM</code> failure, and now it can be handled gracefully by the embedder.</p>\n</li>\n</ul>\n<p>&lt;!--<br>\nPlease make sure you include the following information:</p>\n<ul>\n<li>\n<p>If this work has been discussed elsewhere, please include a link to that<br>\n  conversation. If it was discussed in an issue, just mention \"issue #...\".</p>\n</li>\n<li>\n<p>Explain why this change is needed. If the details are in an issue already,<br>\n  this can be brief.</p>\n</li>\n</ul>\n<p>Our development process is documented in the Wasmtime book:<br>\n<a href=\"https://docs.wasmtime.dev/contributing-development-process.html\">https://docs.wasmtime.dev/contributing-development-process.html</a></p>\n<p>Please ensure all communication follows the code of conduct:<br>\n<a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md\">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>\n--&gt;</p>\n</blockquote>",
        "id": 535709213,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755877147
    },
    {
        "content": "<p><strong>alexcrichton</strong> requested <a href=\"https://github.com/fitzgen\">fitzgen</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11510\">PR #11510</a>.</p>",
        "id": 535709216,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755877148
    },
    {
        "content": "<p><strong>alexcrichton</strong> requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers\">wasmtime-core-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11510\">PR #11510</a>.</p>",
        "id": 535709217,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755877148
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11510#issuecomment-3214810726\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11510\">PR #11510</a>:</p>\n<blockquote>\n<p>Some follow-up bits on this:</p>\n<ul>\n<li>Personally I wouldn't consider this a CVE since panicking in near-OOM conditions is not something we can protect against. For example <code>Vec::with_capacity</code> can panic in OOM conditions at any time.</li>\n<li>This was discovered in Spin recently, so if amenable to others I'd probably do another point release of 36.0.2 so we can update to a fixed version more quickly.</li>\n</ul>\n</blockquote>",
        "id": 535709432,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755877232
    },
    {
        "content": "<p>fitzgen submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11510#pullrequestreview-3145185256\">PR review</a>.</p>",
        "id": 535722493,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755881873
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11510#discussion_r2294219615\">PR review comment</a>:</p>\n<blockquote>\n<p>I imagine that these tests will want to return early on <code>WASMTIME_TEST_NO_HOG_MEMORY</code> or whatever the env var is for our tests under <code>qemu</code>.</p>\n</blockquote>",
        "id": 535722495,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755881873
    },
    {
        "content": "<p>alexcrichton submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11510#pullrequestreview-3145199976\">PR review</a>.</p>",
        "id": 535723323,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755882193
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11510#discussion_r2294229631\">PR review comment</a>:</p>\n<blockquote>\n<p>Good point! Let's see what CI says...<br>\n</p>\n</blockquote>",
        "id": 535723324,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755882193
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11510#issuecomment-3215952942\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11510\">PR #11510</a>:</p>\n<blockquote>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">qemu</span><span class=\"o\">-</span><span class=\"n\">arm</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">GLib</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"o\">../../../</span><span class=\"n\">glib</span><span class=\"o\">/</span><span class=\"n\">gmem</span><span class=\"p\">.</span><span class=\"n\">c</span><span class=\"p\">:</span><span class=\"mi\">106</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">allocate</span><span class=\"w\"> </span><span class=\"mi\">40</span><span class=\"w\"> </span><span class=\"n\">bytes</span>\n<span class=\"n\">qemu</span><span class=\"o\">-</span><span class=\"n\">arm</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">QEMU</span><span class=\"w\"> </span><span class=\"n\">internal</span><span class=\"w\"> </span><span class=\"n\">SIGTRAP</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"n\">code</span><span class=\"o\">=</span><span class=\"mi\">128</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">addr</span><span class=\"o\">=</span><span class=\"p\">(</span><span class=\"n\">nil</span><span class=\"p\">)}</span>\n<span class=\"n\">error</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">test</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">rerun</span><span class=\"w\"> </span><span class=\"n\">pass</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"o\">-</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"n\">pooling_alloc_near_oom</span><span class=\"err\">`</span>\n\n<span class=\"n\">Caused</span><span class=\"w\"> </span><span class=\"n\">by</span><span class=\"p\">:</span>\n<span class=\"w\">  </span><span class=\"nc\">process</span><span class=\"w\"> </span><span class=\"n\">didn</span><span class=\"o\">'</span><span class=\"na\">t</span><span class=\"w\"> </span><span class=\"n\">exit</span><span class=\"w\"> </span><span class=\"n\">successfully</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"o\">/</span><span class=\"n\">opt</span><span class=\"o\">/</span><span class=\"n\">hostedtoolcache</span><span class=\"o\">/</span><span class=\"n\">qemu</span><span class=\"o\">/</span><span class=\"n\">bin</span><span class=\"o\">/</span><span class=\"n\">qemu</span><span class=\"o\">-</span><span class=\"n\">arm</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">L</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">usr</span><span class=\"o\">/</span><span class=\"n\">arm</span><span class=\"o\">-</span><span class=\"n\">linux</span><span class=\"o\">-</span><span class=\"n\">gnueabihf</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">E</span><span class=\"w\"> </span><span class=\"n\">LD_LIBRARY_PATH</span><span class=\"o\">=/</span><span class=\"n\">usr</span><span class=\"o\">/</span><span class=\"n\">arm</span><span class=\"o\">-</span><span class=\"n\">linux</span><span class=\"o\">-</span><span class=\"n\">gnueabihf</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">runner</span><span class=\"o\">/</span><span class=\"n\">work</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">/</span><span class=\"n\">target</span><span class=\"o\">/</span><span class=\"n\">armv7</span><span class=\"o\">-</span><span class=\"n\">unknown</span><span class=\"o\">-</span><span class=\"n\">linux</span><span class=\"o\">-</span><span class=\"n\">gnueabihf</span><span class=\"o\">/</span><span class=\"n\">debug</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">pooling_alloc_near_oom</span><span class=\"o\">-</span><span class=\"n\">e44c0c4e75189ad2</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">signal</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">5</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">SIGTRAP</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">trace</span><span class=\"o\">/</span><span class=\"n\">breakpoint</span><span class=\"w\"> </span><span class=\"n\">trap</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>Whelp looks like I'll need to disable this in QEMU yeah</p>\n</blockquote>",
        "id": 535768376,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755906096
    },
    {
        "content": "<p>alexcrichton updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11510\">PR #11510</a>.</p>",
        "id": 535771923,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755910088
    },
    {
        "content": "<p>alexcrichton has enabled auto merge for <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11510\">PR #11510</a>.</p>",
        "id": 535771931,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755910094
    },
    {
        "content": "<p>tschneidereit submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11510#pullrequestreview-3148254453\">PR review</a>.</p>",
        "id": 535810592,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755960418
    },
    {
        "content": "<p>tschneidereit created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11510#discussion_r2296118102\">PR review comment</a>:</p>\n<blockquote>\n<p>I might misunderstand how this works, but shouldn't this return <code>(Some(state), true)</code> to actually reuse the slot after resetting it? By my reading, the current code creates a new slot and then resets that one.</p>\n</blockquote>",
        "id": 535810594,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755960418
    },
    {
        "content": "<p>tschneidereit submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11510#pullrequestreview-3148263882\">PR review</a>.</p>",
        "id": 535810777,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755960679
    },
    {
        "content": "<p>tschneidereit created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11510#discussion_r2296120810\">PR review comment</a>:</p>\n<blockquote>\n<p>Oh, never mind: I get it now. The reset operates on the memory as identified by <code>allocation_index</code>, not the slot itself.</p>\n</blockquote>",
        "id": 535810778,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1755960679
    },
    {
        "content": "<p>alexcrichton updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11510\">PR #11510</a>.</p>",
        "id": 536039778,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1756132610
    },
    {
        "content": "<p>alexcrichton has enabled auto merge for <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11510\">PR #11510</a>.</p>",
        "id": 536039805,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1756132616
    },
    {
        "content": "<p>alexcrichton merged <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11510\">PR #11510</a>.</p>",
        "id": 536105629,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1756154745
    }
]
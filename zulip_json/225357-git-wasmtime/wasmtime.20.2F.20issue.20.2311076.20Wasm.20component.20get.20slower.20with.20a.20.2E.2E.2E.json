[
    {
        "content": "<p>wynterr opened <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11076\">issue #11076</a>:</p>\n<blockquote>\n<p>Hi, I'm working on a project where I'm compiling Rust code into a Wasm component using <a href=\"https://github.com/bytecodealliance/cargo-component\">cargo-component</a>, and hosting that component using the Wasmtime Rust SDK.</p>\n<p>My Wasm component depends on OpenSSL, so I first compiled OpenSSL to Wasm and then linked it into my project. However, my custom logic only uses a small portion of OpenSSL, yet the resulting .wasm file is significantly larger than necessary due to the full inclusion of the OpenSSL dependency.</p>\n<p>I experimented with different pre-compiled Wasm versions of OpenSSL from GitHub, and observed the following:</p>\n<ul>\n<li>Larger Wasm file sizes result in slower execution times, even though the actual function being called is the same.</li>\n<li>This performance degradation affects certain parts of the Wasm function execution more significantly. Specifically, function calls into OpenSSL exhibit significantly increased latency as the .wasm file size grows.</li>\n</ul>\n<p>To reduce file size and improve performance, I also tried compiling my project to a regular Wasm module (instead of a component), and ran <a href=\"https://github.com/WebAssembly/binaryen\">wasm-opt</a> to optimize it. This reduced the file size and improved execution speed as expected.</p>\n<p>However, wasm-opt currently does not support Wasm components.</p>\n<p>So my questions are:</p>\n<ol>\n<li>Why does increasing the size of the Wasm component (even if unrelated to the actual execution path) cause slower runtime performance, especially for specific function calls into OpenSSL?</li>\n<li>Are there any tools or workflows available to optimize or shrink Wasm components, similar to what wasm-opt does for modules?</li>\n</ol>\n<p>Thanks!</p>\n</blockquote>",
        "id": 524878834,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1750337398
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11076#issuecomment-2991803713\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11076\">issue #11076</a>:</p>\n<blockquote>\n<p>Would you be able to share numbers/examples/wasms? It is not expected that the size of a component affects speed (in the same way the size of a core module should not affect speed). That may mean that you're running into a bug and/or something else, so specific numbers, examples, or wasm files will help to debug that.</p>\n<p>As for shrinking a component, no there's no integration I'm aware of with <code>wasm-opt</code> at this time. It's theoretically possible to run <code>wasm-opt</code> individually over each module within a component, but that has not yet been implemented.</p>\n</blockquote>",
        "id": 525051261,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1750429103
    },
    {
        "content": "<p>primoly <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11076#issuecomment-2992981382\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11076\">issue #11076</a>:</p>\n<blockquote>\n<blockquote>\n<ol start=\"2\">\n<li>Are there any tools or workflows available to optimize or shrink Wasm components, similar to what wasm-opt does for modules?</li>\n</ol>\n</blockquote>\n<p>There’s <a href=\"https://github.com/esoterra/component-opt\"><code>component-opt</code></a>. It scoops out all the modules inside the component, runs <code>wasm-opt</code> on them and reassembles the component with the optimised modules. But I believe it uses an old version of Binaryen: 116 from September 2023.<br>\n</p>\n</blockquote>",
        "id": 525105660,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1750455020
    },
    {
        "content": "<p>wynterr <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11076#issuecomment-2999683045\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11076\">issue #11076</a>:</p>\n<blockquote>\n<blockquote>\n<p>Would you be able to share numbers/examples/wasms? It is not expected that the size of a component affects speed (in the same way the size of a core module should not affect speed). That may mean that you're running into a bug and/or something else, so specific numbers, examples, or wasm files will help to debug that.</p>\n<p>As for shrinking a component, no there's no integration I'm aware of with <code>wasm-opt</code> at this time. It's theoretically possible to run <code>wasm-opt</code> individually over each module within a component, but that has not yet been implemented.</p>\n</blockquote>\n<p>Thank you for the response.<br>\nDue to company policy I can't share the wasm files. So I tried to build a mininal example Rust project that does simply a signature verification by openssl and compiled it to a wasm module.</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">openssl</span><span class=\"p\">::</span><span class=\"n\">ec</span><span class=\"p\">::{</span><span class=\"n\">EcGroup</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">EcKey</span><span class=\"p\">};</span>\n<span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">openssl</span><span class=\"p\">::</span><span class=\"n\">nid</span><span class=\"p\">::</span><span class=\"n\">Nid</span><span class=\"p\">;</span>\n<span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">openssl</span><span class=\"p\">::</span><span class=\"n\">pkey</span><span class=\"p\">::</span><span class=\"n\">PKey</span><span class=\"p\">;</span>\n<span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">openssl</span><span class=\"p\">::</span><span class=\"n\">sign</span><span class=\"p\">::{</span><span class=\"n\">Signer</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">Verifier</span><span class=\"p\">};</span>\n<span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">openssl</span><span class=\"p\">::</span><span class=\"n\">hash</span><span class=\"p\">::</span><span class=\"n\">MessageDigest</span><span class=\"p\">;</span>\n<span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"p\">::</span><span class=\"n\">time</span><span class=\"p\">::</span><span class=\"n\">Instant</span><span class=\"p\">;</span>\n\n<span class=\"cp\">#[no_mangle]</span>\n<span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">extern</span><span class=\"w\"> </span><span class=\"s\">\"C\"</span><span class=\"w\"> </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">test_openssl</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">bool</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">group</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">EcGroup</span><span class=\"p\">::</span><span class=\"n\">from_curve_name</span><span class=\"p\">(</span><span class=\"n\">Nid</span><span class=\"p\">::</span><span class=\"n\">X9_62_PRIME256V1</span><span class=\"p\">).</span><span class=\"n\">unwrap</span><span class=\"p\">();</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">key</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">EcKey</span><span class=\"p\">::</span><span class=\"n\">generate</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">group</span><span class=\"p\">).</span><span class=\"n\">unwrap</span><span class=\"p\">();</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">pkey</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">PKey</span><span class=\"p\">::</span><span class=\"n\">from_ec_key</span><span class=\"p\">(</span><span class=\"n\">key</span><span class=\"p\">).</span><span class=\"n\">unwrap</span><span class=\"p\">();</span>\n\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s\">b\"test data\"</span><span class=\"p\">;</span>\n\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">signer</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Signer</span><span class=\"p\">::</span><span class=\"n\">new</span><span class=\"p\">(</span><span class=\"n\">MessageDigest</span><span class=\"p\">::</span><span class=\"n\">sha256</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">pkey</span><span class=\"p\">).</span><span class=\"n\">unwrap</span><span class=\"p\">();</span>\n<span class=\"w\">    </span><span class=\"n\">signer</span><span class=\"p\">.</span><span class=\"n\">update</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">).</span><span class=\"n\">unwrap</span><span class=\"p\">();</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">signature</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">signer</span><span class=\"p\">.</span><span class=\"n\">sign_to_vec</span><span class=\"p\">().</span><span class=\"n\">unwrap</span><span class=\"p\">();</span>\n\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">verifier</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Verifier</span><span class=\"p\">::</span><span class=\"n\">new</span><span class=\"p\">(</span><span class=\"n\">MessageDigest</span><span class=\"p\">::</span><span class=\"n\">sha256</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"n\">pkey</span><span class=\"p\">).</span><span class=\"n\">unwrap</span><span class=\"p\">();</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">total</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"p\">::</span><span class=\"n\">time</span><span class=\"p\">::</span><span class=\"n\">Duration</span><span class=\"p\">::</span><span class=\"n\">new</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">_</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"o\">..</span><span class=\"mi\">100</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">start</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Instant</span><span class=\"p\">::</span><span class=\"n\">now</span><span class=\"p\">();</span>\n<span class=\"w\">        </span><span class=\"n\">verifier</span><span class=\"p\">.</span><span class=\"n\">update</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">).</span><span class=\"n\">unwrap</span><span class=\"p\">();</span>\n<span class=\"w\">        </span><span class=\"n\">verifier</span><span class=\"p\">.</span><span class=\"n\">verify</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"n\">signature</span><span class=\"p\">).</span><span class=\"n\">unwrap</span><span class=\"p\">();</span>\n<span class=\"w\">        </span><span class=\"n\">total</span><span class=\"w\"> </span><span class=\"o\">+=</span><span class=\"w\"> </span><span class=\"n\">start</span><span class=\"p\">.</span><span class=\"n\">elapsed</span><span class=\"p\">();</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"w\">    </span><span class=\"fm\">println!</span><span class=\"p\">(</span><span class=\"s\">\"avg {:?}\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">total</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"w\"> </span><span class=\"mi\">100</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"kc\">true</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>And the result for this example:</p>\n<ol>\n<li>With self-built wasm openssl </li>\n</ol>\n<ul>\n<li>\n<p>Size: 4.2MB </p>\n</li>\n<li>\n<p>Time: ~7.7ms </p>\n</li>\n</ul>\n<ol start=\"2\">\n<li>With self-built openssl + wasm-opt </li>\n</ol>\n<ul>\n<li>\n<p>Size: 1.9MB </p>\n</li>\n<li>\n<p>Time: ~7.8ms </p>\n</li>\n</ul>\n<ol start=\"3\">\n<li>With <a href=\"https://github.com/jedisct1/openssl-wasm\">https://github.com/jedisct1/openssl-wasm</a>  </li>\n</ol>\n<ul>\n<li>\n<p>Size: 2.2MB </p>\n</li>\n<li>\n<p>Time: ~4.1ms </p>\n</li>\n</ul>\n<ol start=\"4\">\n<li>With <a href=\"https://github.com/wapm-packages/OpenSSL/tree/master\">https://github.com/wapm-packages/OpenSSL/tree/master</a>  </li>\n</ol>\n<ul>\n<li>\n<p>Size: 0.98 MB </p>\n</li>\n<li>\n<p>Time: ~2.1ms </p>\n</li>\n</ul>\n<ol start=\"5\">\n<li>Native binary: </li>\n</ol>\n<ul>\n<li>Time: ~140μs </li>\n</ul>\n<p>All wasm files were tested using the following command:<br>\n<code>wasmtime -W unknown-imports-default=y -S cli=y --dir . --invoke test_openssl test_openssl.wasm</code></p>\n<p>For this example, using wasm-opt does reduce its size but actually doesn't improve the speed. Using pre-compiled openssl from github still improves the speed. So maybe it is not the size that matters. It could be wasm-opt that optimizes the performance(for my custom wasm file it does help to boost the performace from ~25ms to ~18ms), and different wasm builds of openssl yield different performance.</p>\n<p>Another thing I’m curious about is why OpenSSL performs so poorly when compiled to WebAssembly, especially compared to other parts of my project, which don’t exhibit the same level of performance degradation. This might not be directly related to Wasmtime itself, but I’d really appreciate any insights into what might be causing this. Thanks!</p>\n</blockquote>",
        "id": 525484846,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1750760150
    },
    {
        "content": "<p>wynterr <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11076#issuecomment-2999690216\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11076\">issue #11076</a>:</p>\n<blockquote>\n<blockquote>\n<blockquote>\n<ol start=\"2\">\n<li>Are there any tools or workflows available to optimize or shrink Wasm components, similar to what wasm-opt does for modules?</li>\n</ol>\n</blockquote>\n<p>There’s <a href=\"https://github.com/esoterra/component-opt\"><code>component-opt</code></a>. It scoops out all the modules inside the component, runs <code>wasm-opt</code> on them and reassembles the component with the optimised modules. But I believe it uses an old version of Binaryen: 116 from September 2023.</p>\n</blockquote>\n<p>Thanks for the info. I just tried it and getting some error saying <code>type index 0 is not a resource type</code>. Maybe it's because of the older version of Binaryen they use.</p>\n</blockquote>",
        "id": 525485235,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1750760304
    },
    {
        "content": "<p>bjorn3 <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11076#issuecomment-2999697920\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11076\">issue #11076</a>:</p>\n<blockquote>\n<blockquote>\n<p>Another thing I’m curious about is why OpenSSL performs so poorly when compiled to WebAssembly, especially compared to other parts of my project, which don’t exhibit the same level of performance degradation. This might not be directly related to Wasmtime itself, but I’d really appreciate any insights into what might be causing this. Thanks!</p>\n</blockquote>\n<p>That could be OpenSSL having a SIMD implementation of this crypto primitive for x86_64, but missing one for wasm.</p>\n</blockquote>",
        "id": 525485583,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1750760451
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11076#issuecomment-3000807338\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11076\">issue #11076</a>:</p>\n<blockquote>\n<p>It looks like you're using different builds of OpenSSL, so can you explain why you think they should all perform the same? They could all have different build flags, come from different sources, or have different patches which could explain the performance difference. This to me looks like it's unrelated to the size of a component and more related to the actual code in the component as to what's taking awhile here or not.</p>\n<p>And yes, OpenSSL likely has far more vectorized/optimized routines for native than for wasm, so wasm is unlikely to be as fast as native.</p>\n</blockquote>",
        "id": 525535730,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1750776366
    },
    {
        "content": "<p>wynterr closed <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11076\">issue #11076</a>:</p>\n<blockquote>\n<p>Hi, I'm working on a project where I'm compiling Rust code into a Wasm component using <a href=\"https://github.com/bytecodealliance/cargo-component\">cargo-component</a>, and hosting that component using the Wasmtime Rust SDK.</p>\n<p>My Wasm component depends on OpenSSL, so I first compiled OpenSSL to Wasm and then linked it into my project. However, my custom logic only uses a small portion of OpenSSL, yet the resulting .wasm file is significantly larger than necessary due to the full inclusion of the OpenSSL dependency.</p>\n<p>I experimented with different pre-compiled Wasm versions of OpenSSL from GitHub, and observed the following:</p>\n<ul>\n<li>Larger Wasm file sizes result in slower execution times, even though the actual function being called is the same.</li>\n<li>This performance degradation affects certain parts of the Wasm function execution more significantly. Specifically, function calls into OpenSSL exhibit significantly increased latency as the .wasm file size grows.</li>\n</ul>\n<p>To reduce file size and improve performance, I also tried compiling my project to a regular Wasm module (instead of a component), and ran <a href=\"https://github.com/WebAssembly/binaryen\">wasm-opt</a> to optimize it. This reduced the file size and improved execution speed as expected.</p>\n<p>However, wasm-opt currently does not support Wasm components.</p>\n<p>So my questions are:</p>\n<ol>\n<li>Why does increasing the size of the Wasm component (even if unrelated to the actual execution path) cause slower runtime performance, especially for specific function calls into OpenSSL?</li>\n<li>Are there any tools or workflows available to optimize or shrink Wasm components, similar to what wasm-opt does for modules?</li>\n</ol>\n<p>Thanks!</p>\n</blockquote>",
        "id": 525643548,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1750833244
    },
    {
        "content": "<p>wynterr <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11076#issuecomment-3003532604\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11076\">issue #11076</a>:</p>\n<blockquote>\n<blockquote>\n<p>It looks like you're using different builds of OpenSSL, so can you explain why you think they should all perform the same? They could all have different build flags, come from different sources, or have different patches which could explain the performance difference. This to me looks like it's unrelated to the size of a component and more related to the actual code in the component as to what's taking awhile here or not.</p>\n<p>And yes, OpenSSL likely has far more vectorized/optimized routines for native than for wasm, so wasm is unlikely to be as fast as native.</p>\n</blockquote>\n<p>Yeah, I realized this after running experiments with the minimal example. Thanks for the response.</p>\n</blockquote>",
        "id": 525643550,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1750833244
    }
]
[
    {
        "content": "<p><a href=\"https://github.com/posborne\">posborne</a> added the bug label to <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10667\">Issue #10667</a>.</p>",
        "id": 514170852,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1745512040
    },
    {
        "content": "<p>posborne opened <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10667\">issue #10667</a>:</p>\n<blockquote>\n<p>Credit to @aturon for the discovery...</p>\n<p>Today, the <code>async_yield_impl</code> behavior triggered an epoch deadline is hit or we run out of fuel does not match that of <a href=\"https://docs.rs/tokio/latest/tokio/task/fn.yield_now.html\"><code>tokio::task::yield_now</code></a>.  They are _mostly_ the same except that with the current implementation that wasm task effectively gets immediately rescheduled (it is not deferred and ends up at the <em>front</em> rather than the <em>back</em> of the pending queue).  This would not necessarily be the case with all task schedulers but is the case with tokio today in its default configuration with the lifo-slot enabled (see <a href=\"https://docs.rs/tokio/latest/tokio/runtime/struct.Builder.html#method.disable_lifo_slot\"><code>tokio::runtime::Builder::disable_lifo_slot</code></a>).</p>\n<p>When targeting tokio, it would be preferred to have the async yield behavior map directly to whatever <code>tokio::task::yield_now</code> does.  There seems to be a couple ways to approach this:</p>\n<ol>\n<li>Feature flagging to enable the direct call.</li>\n<li>Allow embedder to configure the async yield behavior to allow for <code>yield_now</code> to be called.</li>\n</ol>\n<p>Secondarily, even if the lifo-slot was disabled, the <code>yield_now</code> behavior in tokio has the added benefit of not allowing the yielding task to be immediately stolen as it is first moved to the deferred queue.  If the current worker does not end up picking up other blocking work then we'll end up resuming on the same thread and avoid potential thrashing.</p>\n</blockquote>",
        "id": 514170857,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1745512042
    },
    {
        "content": "<p>fitzgen <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10667#issuecomment-2828219429\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10667\">issue #10667</a>:</p>\n<blockquote>\n<p>We jsut talked about this in the Wasmtime biweekly.</p>\n<p>Gist was that we already support <a href=\"https://docs.rs/wasmtime/latest/wasmtime/struct.Store.html#method.epoch_deadline_callback\">calling a callback at epoch interruption points</a> and it makes sense to add an async variation of this callback API. This would allow embedders to call <code>tokio::task::yield_now()</code> from that async callback, while keeping the core of wasmtime free of any assumptions of which particular async executor is being used.</p>\n</blockquote>",
        "id": 514172174,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1745512314
    },
    {
        "content": "<p>posborne closed <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10667\">issue #10667</a>:</p>\n<blockquote>\n<p>Credit to @aturon for the discovery...</p>\n<p>Today, the <code>async_yield_impl</code> behavior triggered an epoch deadline is hit or we run out of fuel does not match that of <a href=\"https://docs.rs/tokio/latest/tokio/task/fn.yield_now.html\"><code>tokio::task::yield_now</code></a>.  They are _mostly_ the same except that with the current implementation that wasm task effectively gets immediately rescheduled (it is not deferred and ends up at the <em>front</em> rather than the <em>back</em> of the pending queue).  This would not necessarily be the case with all task schedulers but is the case with tokio today in its default configuration with the lifo-slot enabled (see <a href=\"https://docs.rs/tokio/latest/tokio/runtime/struct.Builder.html#method.disable_lifo_slot\"><code>tokio::runtime::Builder::disable_lifo_slot</code></a>).</p>\n<p>When targeting tokio, it would be preferred to have the async yield behavior map directly to whatever <code>tokio::task::yield_now</code> does.  There seems to be a couple ways to approach this:</p>\n<ol>\n<li>Feature flagging to enable the direct call.</li>\n<li>Allow embedder to configure the async yield behavior to allow for <code>yield_now</code> to be called.</li>\n</ol>\n<p>Secondarily, even if the lifo-slot was disabled, the <code>yield_now</code> behavior in tokio has the added benefit of not allowing the yielding task to be immediately stolen as it is first moved to the deferred queue.  If the current worker does not end up picking up other blocking work then we'll end up resuming on the same thread and avoid potential thrashing.</p>\n</blockquote>",
        "id": 515536401,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1746116134
    }
]
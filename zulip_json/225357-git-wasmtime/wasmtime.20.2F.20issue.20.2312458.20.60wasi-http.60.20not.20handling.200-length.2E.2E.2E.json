[
    {
        "content": "<p><a href=\"https://github.com/karthik-phl\">karthik-phl</a> added the bug label to <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12458\">Issue #12458</a>.</p>",
        "id": 570461026,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769569903
    },
    {
        "content": "<p>karthik-phl opened <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12458\">issue #12458</a>:</p>\n<blockquote>\n<p>Thanks for filing a bug report! Please fill out the TODOs below.</p>\n<p><strong>Note: if you want to report a security issue, please read our <a href=\"https://bytecodealliance.org/security\">security policy</a>!</strong></p>\n<h3>Test Case</h3>\n<p>Use <code>Reqwest</code> for outbound HTTP calls that are sent by the <code>wasi-http</code> host </p>\n<h3>Steps to Reproduce</h3>\n<ul>\n<li>\n<p>We've created an implementation of the <code>wasi-http</code> host that uses <code>Reqwest 0.13</code> for outbound calls. When using <code>wit-bindgen's</code>  async-stream support to process the response of an outbound call through the host, we found that wasmtime encounters a situation that causes the guest module to crash.</p>\n</li>\n<li>\n<p>Upon further investigation, we found that Reqwest sends a 0-length frame when the end of stream is reached, which is not handled by the <code>poll_produce</code> method of <code>StreamProducer</code>. I think wasmtime should handle this case explicitly and prevent the guest from crashing, and I'm happy to create a PR with this change.</p>\n</li>\n</ul>\n<h3>Expected Results</h3>\n<p>The WASM guest should be able to <code>collect</code> the <code>stream</code> results and continue processing</p>\n<h3>Actual Results</h3>\n<p>The WASM guest crashes abruptly</p>\n<h3>Versions and Environment</h3>\n<p>Wasmtime version or commit: 41.0.x</p>\n</blockquote>",
        "id": 570461027,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769569903
    },
    {
        "content": "<p>karthik-phl edited <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12458\">issue #12458</a>:</p>\n<blockquote>\n<p>Thanks for filing a bug report! Please fill out the TODOs below.</p>\n<p><strong>Note: if you want to report a security issue, please read our <a href=\"https://bytecodealliance.org/security\">security policy</a>!</strong></p>\n<h3>Test Case</h3>\n<p>Use <code>Reqwest</code> for outbound HTTP calls that are sent by the <code>wasi-http</code> host </p>\n<h3>Steps to Reproduce</h3>\n<ul>\n<li>\n<p>We've created an implementation of the <code>wasi-http</code> host that uses <code>Reqwest 0.13</code> for outbound calls. When using <code>wit-bindgen's</code>  async-stream support to process the response of an outbound call through the host, we found that wasmtime encounters a situation that causes the guest module to crash.</p>\n</li>\n<li>\n<p>Upon further investigation, we found that Reqwest sends a 0-length frame when the end of stream is reached, which is not handled by the <code>poll_produce</code> method of <code>StreamProducer</code>. I think wasmtime should handle this case explicitly and prevent the guest from crashing, and I'm happy to create a PR with this change.</p>\n</li>\n<li>\n<p>The following <code>test</code> that can be added to <code>wasi-http/tests/all/p3/mod.rs</code> to simulate the condition that's triggered by the use of a library like <code>Reqwest</code>. Running the test with <code>cargo test -p wasmtime-wasi-http --features p3 --test all p3_http_empty_frame_at_end_of_stream -- --nocapture</code> should indicate the error.</p>\n</li>\n</ul>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"p\">::</span><span class=\"n\">pin</span><span class=\"p\">::</span><span class=\"n\">Pin</span><span class=\"p\">;</span>\n<span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"p\">::</span><span class=\"n\">task</span><span class=\"p\">::{</span><span class=\"n\">Context</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">Poll</span><span class=\"p\">};</span>\n\n<span class=\"c1\">// Custom body wrapper that sends an empty frame at EOS while reporting is_end_stream() = true</span>\n<span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">BodyWithEmptyFrameAtEos</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">inner</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">http_body_util</span><span class=\"p\">::</span><span class=\"n\">StreamBody</span><span class=\"o\">&lt;</span>\n<span class=\"w\">        </span><span class=\"n\">futures</span><span class=\"p\">::</span><span class=\"n\">channel</span><span class=\"p\">::</span><span class=\"n\">mpsc</span><span class=\"p\">::</span><span class=\"n\">Receiver</span><span class=\"o\">&lt;</span><span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"n\">http_body</span><span class=\"p\">::</span><span class=\"n\">Frame</span><span class=\"o\">&lt;</span><span class=\"n\">Bytes</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ErrorCode</span><span class=\"o\">&gt;&gt;</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"o\">&gt;</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">sent_empty</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">bool</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">at_eos</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">bool</span><span class=\"p\">,</span>\n<span class=\"p\">}</span>\n\n<span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">http_body</span><span class=\"p\">::</span><span class=\"n\">Body</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">BodyWithEmptyFrameAtEos</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"k\">type</span><span class=\"w\"> </span><span class=\"nc\">Data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Bytes</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"k\">type</span><span class=\"w\"> </span><span class=\"nc\">Error</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ErrorCode</span><span class=\"p\">;</span>\n\n<span class=\"w\">    </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">poll_frame</span><span class=\"p\">(</span>\n<span class=\"w\">        </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">Pin</span><span class=\"o\">&lt;&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"bp\">Self</span><span class=\"o\">&gt;</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"n\">cx</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kp\">&amp;</span><span class=\"nc\">mut</span><span class=\"w\"> </span><span class=\"n\">Context</span><span class=\"o\">&lt;'</span><span class=\"nb\">_</span><span class=\"o\">&gt;</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">Poll</span><span class=\"o\">&lt;</span><span class=\"nb\">Option</span><span class=\"o\">&lt;</span><span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"n\">http_body</span><span class=\"p\">::</span><span class=\"n\">Frame</span><span class=\"o\">&lt;</span><span class=\"bp\">Self</span><span class=\"p\">::</span><span class=\"n\">Data</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"bp\">Self</span><span class=\"p\">::</span><span class=\"n\">Error</span><span class=\"o\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"c1\">// First, poll the underlying body</span>\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"bp\">self</span><span class=\"p\">;</span>\n<span class=\"w\">        </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">Pin</span><span class=\"p\">::</span><span class=\"n\">new</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"p\">.</span><span class=\"n\">inner</span><span class=\"p\">).</span><span class=\"n\">poll_frame</span><span class=\"p\">(</span><span class=\"n\">cx</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">            </span><span class=\"n\">Poll</span><span class=\"p\">::</span><span class=\"n\">Ready</span><span class=\"p\">(</span><span class=\"nb\">None</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">!</span><span class=\"n\">this</span><span class=\"p\">.</span><span class=\"n\">sent_empty</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">                </span><span class=\"c1\">// When the underlying body ends, send an empty frame</span>\n<span class=\"w\">                </span><span class=\"c1\">// This simulates HTTP implementations that send empty frames at EOS</span>\n<span class=\"w\">                </span><span class=\"n\">this</span><span class=\"p\">.</span><span class=\"n\">sent_empty</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">true</span><span class=\"p\">;</span>\n<span class=\"w\">                </span><span class=\"n\">this</span><span class=\"p\">.</span><span class=\"n\">at_eos</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">true</span><span class=\"p\">;</span>\n<span class=\"w\">                </span><span class=\"n\">Poll</span><span class=\"p\">::</span><span class=\"n\">Ready</span><span class=\"p\">(</span><span class=\"nb\">Some</span><span class=\"p\">(</span><span class=\"nb\">Ok</span><span class=\"p\">(</span><span class=\"n\">http_body</span><span class=\"p\">::</span><span class=\"n\">Frame</span><span class=\"p\">::</span><span class=\"n\">data</span><span class=\"p\">(</span><span class=\"n\">Bytes</span><span class=\"p\">::</span><span class=\"n\">new</span><span class=\"p\">()))))</span>\n<span class=\"w\">            </span><span class=\"p\">}</span>\n<span class=\"w\">            </span><span class=\"n\">other</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">other</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"p\">}</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n\n<span class=\"w\">    </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">is_end_stream</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"bp\">self</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">bool</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"c1\">// Report end of stream once we've reached it</span>\n<span class=\"w\">        </span><span class=\"c1\">// This ensures is_end_stream() = true when we send the empty frame</span>\n<span class=\"w\">        </span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">at_eos</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n\n<span class=\"cp\">#[test_log::test(tokio::test(flavor = </span><span class=\"s\">\"multi_thread\"</span><span class=\"cp\">))]</span>\n<span class=\"k\">async</span><span class=\"w\"> </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">p3_http_empty_frame_at_end_of_stream</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"p\">()</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">_</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">env_logger</span><span class=\"p\">::</span><span class=\"n\">try_init</span><span class=\"p\">();</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// This test verifies the fix which handles the case where a zero-length frame is</span>\n<span class=\"w\">    </span><span class=\"c1\">// received when is_end_stream() is true. Without the fix, the StreamProducer would</span>\n<span class=\"w\">    </span><span class=\"c1\">// crash when the WASM guest tries to read such a frame.</span>\n\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">body</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s\">b\"test\"</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">raw_body</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Bytes</span><span class=\"p\">::</span><span class=\"n\">copy_from_slice</span><span class=\"p\">(</span><span class=\"n\">body</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">body_tx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">body_rx</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">futures</span><span class=\"p\">::</span><span class=\"n\">channel</span><span class=\"p\">::</span><span class=\"n\">mpsc</span><span class=\"p\">::</span><span class=\"n\">channel</span><span class=\"p\">::</span><span class=\"o\">&lt;</span><span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"n\">_</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ErrorCode</span><span class=\"o\">&gt;&gt;</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">wrapped_body</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">BodyWithEmptyFrameAtEos</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"n\">inner</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">http_body_util</span><span class=\"p\">::</span><span class=\"n\">StreamBody</span><span class=\"p\">::</span><span class=\"n\">new</span><span class=\"p\">(</span><span class=\"n\">body_rx</span><span class=\"p\">),</span>\n<span class=\"w\">        </span><span class=\"n\">sent_empty</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">false</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"n\">at_eos</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">false</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"p\">};</span>\n\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">request</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">http</span><span class=\"p\">::</span><span class=\"n\">Request</span><span class=\"p\">::</span><span class=\"n\">builder</span><span class=\"p\">()</span>\n<span class=\"w\">        </span><span class=\"p\">.</span><span class=\"n\">uri</span><span class=\"p\">(</span><span class=\"s\">\"http://localhost/\"</span><span class=\"p\">)</span>\n<span class=\"w\">        </span><span class=\"p\">.</span><span class=\"n\">method</span><span class=\"p\">(</span><span class=\"n\">http</span><span class=\"p\">::</span><span class=\"n\">Method</span><span class=\"p\">::</span><span class=\"n\">GET</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// Use the echo component which actually reads from the stream</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">response</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">futures</span><span class=\"p\">::</span><span class=\"n\">join</span><span class=\"o\">!</span><span class=\"p\">(</span>\n<span class=\"w\">        </span><span class=\"n\">run_http</span><span class=\"p\">(</span>\n<span class=\"w\">            </span><span class=\"n\">P3_HTTP_ECHO_COMPONENT</span><span class=\"p\">,</span>\n<span class=\"w\">            </span><span class=\"n\">request</span><span class=\"p\">.</span><span class=\"n\">body</span><span class=\"p\">(</span><span class=\"n\">wrapped_body</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">,</span>\n<span class=\"w\">            </span><span class=\"n\">oneshot</span><span class=\"p\">::</span><span class=\"n\">channel</span><span class=\"p\">().</span><span class=\"mi\">0</span>\n<span class=\"w\">        </span><span class=\"p\">),</span>\n<span class=\"w\">        </span><span class=\"k\">async</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">            </span><span class=\"n\">body_tx</span>\n<span class=\"w\">                </span><span class=\"p\">.</span><span class=\"n\">send</span><span class=\"p\">(</span><span class=\"nb\">Ok</span><span class=\"p\">(</span><span class=\"n\">http_body</span><span class=\"p\">::</span><span class=\"n\">Frame</span><span class=\"p\">::</span><span class=\"n\">data</span><span class=\"p\">(</span><span class=\"n\">raw_body</span><span class=\"p\">)))</span>\n<span class=\"w\">                </span><span class=\"p\">.</span><span class=\"k\">await</span>\n<span class=\"w\">                </span><span class=\"p\">.</span><span class=\"n\">unwrap</span><span class=\"p\">();</span>\n<span class=\"w\">            </span><span class=\"nb\">drop</span><span class=\"p\">(</span><span class=\"n\">body_tx</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"p\">}</span>\n<span class=\"w\">    </span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"o\">?</span>\n<span class=\"w\">    </span><span class=\"p\">.</span><span class=\"n\">unwrap</span><span class=\"p\">();</span>\n\n<span class=\"w\">    </span><span class=\"fm\">assert_eq!</span><span class=\"p\">(</span><span class=\"n\">response</span><span class=\"p\">.</span><span class=\"n\">status</span><span class=\"p\">().</span><span class=\"n\">as_u16</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"mi\">200</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// Verify the body was echoed correctly (empty frames should be filtered out by the fix)</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">_</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">collected_body</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">response</span><span class=\"p\">.</span><span class=\"n\">into_parts</span><span class=\"p\">();</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">collected_body</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">collected_body</span><span class=\"p\">.</span><span class=\"n\">to_bytes</span><span class=\"p\">();</span>\n<span class=\"w\">    </span><span class=\"fm\">assert_eq!</span><span class=\"p\">(</span><span class=\"n\">collected_body</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">body</span><span class=\"p\">.</span><span class=\"n\">as_slice</span><span class=\"p\">());</span>\n<span class=\"w\">    </span><span class=\"nb\">Ok</span><span class=\"p\">(())</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<h3>Expected Results</h3>\n<p>The WASM guest should be able to <code>collect</code> the <code>stream</code> results and continue processing</p>\n<h3>Actual Results</h3>\n<p>The WASM guest crashes abruptly</p>\n<h3>Versions and Environment</h3>\n<p>Wasmtime version or commit: 41.0.x</p>\n</blockquote>",
        "id": 570494289,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769588334
    },
    {
        "content": "<p>karthik-phl edited <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12458\">issue #12458</a>:</p>\n<blockquote>\n<p>Thanks for filing a bug report! Please fill out the TODOs below.</p>\n<p><strong>Note: if you want to report a security issue, please read our <a href=\"https://bytecodealliance.org/security\">security policy</a>!</strong></p>\n<h3>Test Case</h3>\n<p>Use <code>Reqwest</code> for outbound HTTP calls that are sent by the <code>wasi-http</code> host </p>\n<h3>Steps to Reproduce</h3>\n<ul>\n<li>\n<p>We've created an implementation of the <code>wasi-http</code> host that uses <code>Reqwest 0.13</code> for outbound calls. When using <code>wit-bindgen's</code>  async-stream support to process the response of an outbound call through the host, we found that wasmtime encounters a situation that causes the guest module to crash.</p>\n</li>\n<li>\n<p>Upon further investigation, we found that Reqwest sends a 0-length frame when the end of stream is reached, which is not handled by the <code>poll_produce</code> method of <code>StreamProducer</code>. I think wasmtime should handle this case explicitly and prevent the guest from crashing, and I'm happy to create a PR with this change.</p>\n</li>\n<li>\n<p>The following <code>test</code> that can be added to <code>wasi-http/tests/all/p3/mod.rs</code> to simulate the condition that's triggered by the use of a library like <code>Reqwest</code>. Running the test with <code>cargo test -p wasmtime-wasi-http --features p3 --test all p3_http_empty_frame_at_end_of_stream -- --nocapture</code> should indicate the error.</p>\n</li>\n</ul>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"p\">::</span><span class=\"n\">pin</span><span class=\"p\">::</span><span class=\"n\">Pin</span><span class=\"p\">;</span>\n<span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"p\">::</span><span class=\"n\">task</span><span class=\"p\">::{</span><span class=\"n\">Context</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">Poll</span><span class=\"p\">};</span>\n\n<span class=\"c1\">// Custom body wrapper that sends an empty frame at EOS while reporting is_end_stream() = true</span>\n<span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">BodyWithEmptyFrameAtEos</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">inner</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">http_body_util</span><span class=\"p\">::</span><span class=\"n\">StreamBody</span><span class=\"o\">&lt;</span>\n<span class=\"w\">        </span><span class=\"n\">futures</span><span class=\"p\">::</span><span class=\"n\">channel</span><span class=\"p\">::</span><span class=\"n\">mpsc</span><span class=\"p\">::</span><span class=\"n\">Receiver</span><span class=\"o\">&lt;</span><span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"n\">http_body</span><span class=\"p\">::</span><span class=\"n\">Frame</span><span class=\"o\">&lt;</span><span class=\"n\">Bytes</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ErrorCode</span><span class=\"o\">&gt;&gt;</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"o\">&gt;</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">sent_empty</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">bool</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">at_eos</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">bool</span><span class=\"p\">,</span>\n<span class=\"p\">}</span>\n\n<span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">http_body</span><span class=\"p\">::</span><span class=\"n\">Body</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">BodyWithEmptyFrameAtEos</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"k\">type</span><span class=\"w\"> </span><span class=\"nc\">Data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Bytes</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"k\">type</span><span class=\"w\"> </span><span class=\"nc\">Error</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ErrorCode</span><span class=\"p\">;</span>\n\n<span class=\"w\">    </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">poll_frame</span><span class=\"p\">(</span>\n<span class=\"w\">        </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">Pin</span><span class=\"o\">&lt;&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"bp\">Self</span><span class=\"o\">&gt;</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"n\">cx</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kp\">&amp;</span><span class=\"nc\">mut</span><span class=\"w\"> </span><span class=\"n\">Context</span><span class=\"o\">&lt;'</span><span class=\"nb\">_</span><span class=\"o\">&gt;</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">Poll</span><span class=\"o\">&lt;</span><span class=\"nb\">Option</span><span class=\"o\">&lt;</span><span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"n\">http_body</span><span class=\"p\">::</span><span class=\"n\">Frame</span><span class=\"o\">&lt;</span><span class=\"bp\">Self</span><span class=\"p\">::</span><span class=\"n\">Data</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"bp\">Self</span><span class=\"p\">::</span><span class=\"n\">Error</span><span class=\"o\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"c1\">// First, poll the underlying body</span>\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"bp\">self</span><span class=\"p\">;</span>\n<span class=\"w\">        </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">Pin</span><span class=\"p\">::</span><span class=\"n\">new</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"p\">.</span><span class=\"n\">inner</span><span class=\"p\">).</span><span class=\"n\">poll_frame</span><span class=\"p\">(</span><span class=\"n\">cx</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">            </span><span class=\"n\">Poll</span><span class=\"p\">::</span><span class=\"n\">Ready</span><span class=\"p\">(</span><span class=\"nb\">None</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">!</span><span class=\"n\">this</span><span class=\"p\">.</span><span class=\"n\">sent_empty</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">                </span><span class=\"c1\">// When the underlying body ends, send an empty frame</span>\n<span class=\"w\">                </span><span class=\"c1\">// This simulates HTTP implementations that send empty frames at EOS</span>\n<span class=\"w\">                </span><span class=\"n\">this</span><span class=\"p\">.</span><span class=\"n\">sent_empty</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">true</span><span class=\"p\">;</span>\n<span class=\"w\">                </span><span class=\"n\">this</span><span class=\"p\">.</span><span class=\"n\">at_eos</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">true</span><span class=\"p\">;</span>\n<span class=\"w\">                </span><span class=\"n\">Poll</span><span class=\"p\">::</span><span class=\"n\">Ready</span><span class=\"p\">(</span><span class=\"nb\">Some</span><span class=\"p\">(</span><span class=\"nb\">Ok</span><span class=\"p\">(</span><span class=\"n\">http_body</span><span class=\"p\">::</span><span class=\"n\">Frame</span><span class=\"p\">::</span><span class=\"n\">data</span><span class=\"p\">(</span><span class=\"n\">Bytes</span><span class=\"p\">::</span><span class=\"n\">new</span><span class=\"p\">()))))</span>\n<span class=\"w\">            </span><span class=\"p\">}</span>\n<span class=\"w\">            </span><span class=\"n\">other</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">other</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"p\">}</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n\n<span class=\"w\">    </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">is_end_stream</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"bp\">self</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">bool</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"c1\">// Report end of stream once we've reached it</span>\n<span class=\"w\">        </span><span class=\"c1\">// This ensures is_end_stream() = true when we send the empty frame</span>\n<span class=\"w\">        </span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">at_eos</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n\n<span class=\"cp\">#[test_log::test(tokio::test(flavor = </span><span class=\"s\">\"multi_thread\"</span><span class=\"cp\">))]</span>\n<span class=\"k\">async</span><span class=\"w\"> </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">p3_http_empty_frame_at_end_of_stream</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"p\">()</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">_</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">env_logger</span><span class=\"p\">::</span><span class=\"n\">try_init</span><span class=\"p\">();</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// This test verifies the fix which handles the case where a zero-length frame is</span>\n<span class=\"w\">    </span><span class=\"c1\">// received when is_end_stream() is true. Without the fix, the StreamProducer would</span>\n<span class=\"w\">    </span><span class=\"c1\">// crash when the WASM guest tries to read such a frame.</span>\n\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">body</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s\">b\"test\"</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">raw_body</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Bytes</span><span class=\"p\">::</span><span class=\"n\">copy_from_slice</span><span class=\"p\">(</span><span class=\"n\">body</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">body_tx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">body_rx</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">futures</span><span class=\"p\">::</span><span class=\"n\">channel</span><span class=\"p\">::</span><span class=\"n\">mpsc</span><span class=\"p\">::</span><span class=\"n\">channel</span><span class=\"p\">::</span><span class=\"o\">&lt;</span><span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"n\">_</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ErrorCode</span><span class=\"o\">&gt;&gt;</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">wrapped_body</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">BodyWithEmptyFrameAtEos</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"n\">inner</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">http_body_util</span><span class=\"p\">::</span><span class=\"n\">StreamBody</span><span class=\"p\">::</span><span class=\"n\">new</span><span class=\"p\">(</span><span class=\"n\">body_rx</span><span class=\"p\">),</span>\n<span class=\"w\">        </span><span class=\"n\">sent_empty</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">false</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"n\">at_eos</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">false</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"p\">};</span>\n\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">request</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">http</span><span class=\"p\">::</span><span class=\"n\">Request</span><span class=\"p\">::</span><span class=\"n\">builder</span><span class=\"p\">()</span>\n<span class=\"w\">        </span><span class=\"p\">.</span><span class=\"n\">uri</span><span class=\"p\">(</span><span class=\"s\">\"http://localhost/\"</span><span class=\"p\">)</span>\n<span class=\"w\">        </span><span class=\"p\">.</span><span class=\"n\">method</span><span class=\"p\">(</span><span class=\"n\">http</span><span class=\"p\">::</span><span class=\"n\">Method</span><span class=\"p\">::</span><span class=\"n\">GET</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// Use the echo component which actually reads from the stream</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">response</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">futures</span><span class=\"p\">::</span><span class=\"n\">join</span><span class=\"o\">!</span><span class=\"p\">(</span>\n<span class=\"w\">        </span><span class=\"n\">run_http</span><span class=\"p\">(</span>\n<span class=\"w\">            </span><span class=\"n\">P3_HTTP_ECHO_COMPONENT</span><span class=\"p\">,</span>\n<span class=\"w\">            </span><span class=\"n\">request</span><span class=\"p\">.</span><span class=\"n\">body</span><span class=\"p\">(</span><span class=\"n\">wrapped_body</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">,</span>\n<span class=\"w\">            </span><span class=\"n\">oneshot</span><span class=\"p\">::</span><span class=\"n\">channel</span><span class=\"p\">().</span><span class=\"mi\">0</span>\n<span class=\"w\">        </span><span class=\"p\">),</span>\n<span class=\"w\">        </span><span class=\"k\">async</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">            </span><span class=\"n\">body_tx</span>\n<span class=\"w\">                </span><span class=\"p\">.</span><span class=\"n\">send</span><span class=\"p\">(</span><span class=\"nb\">Ok</span><span class=\"p\">(</span><span class=\"n\">http_body</span><span class=\"p\">::</span><span class=\"n\">Frame</span><span class=\"p\">::</span><span class=\"n\">data</span><span class=\"p\">(</span><span class=\"n\">raw_body</span><span class=\"p\">)))</span>\n<span class=\"w\">                </span><span class=\"p\">.</span><span class=\"k\">await</span>\n<span class=\"w\">                </span><span class=\"p\">.</span><span class=\"n\">unwrap</span><span class=\"p\">();</span>\n<span class=\"w\">            </span><span class=\"nb\">drop</span><span class=\"p\">(</span><span class=\"n\">body_tx</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"p\">}</span>\n<span class=\"w\">    </span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"o\">?</span>\n<span class=\"w\">    </span><span class=\"p\">.</span><span class=\"n\">unwrap</span><span class=\"p\">();</span>\n\n<span class=\"w\">    </span><span class=\"fm\">assert_eq!</span><span class=\"p\">(</span><span class=\"n\">response</span><span class=\"p\">.</span><span class=\"n\">status</span><span class=\"p\">().</span><span class=\"n\">as_u16</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"mi\">200</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// Verify the body was echoed correctly (empty frames should be filtered out by the fix)</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">_</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">collected_body</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">response</span><span class=\"p\">.</span><span class=\"n\">into_parts</span><span class=\"p\">();</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">collected_body</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">collected_body</span><span class=\"p\">.</span><span class=\"n\">to_bytes</span><span class=\"p\">();</span>\n<span class=\"w\">    </span><span class=\"fm\">assert_eq!</span><span class=\"p\">(</span><span class=\"n\">collected_body</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">body</span><span class=\"p\">.</span><span class=\"n\">as_slice</span><span class=\"p\">());</span>\n<span class=\"w\">    </span><span class=\"nb\">Ok</span><span class=\"p\">(())</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>Thanks for looking into this!</p>\n<h3>Expected Results</h3>\n<p>The WASM guest should be able to <code>collect</code> the <code>stream</code> results and continue processing</p>\n<h3>Actual Results</h3>\n<p>The WASM guest crashes abruptly</p>\n<h3>Versions and Environment</h3>\n<p>Wasmtime version or commit: 41.0.x</p>\n</blockquote>",
        "id": 570508048,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769592749
    },
    {
        "content": "<p><a href=\"https://github.com/fitzgen\">fitzgen</a> added the wasi-http label to <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12458\">Issue #12458</a>.</p>",
        "id": 570853459,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769707036
    },
    {
        "content": "<p>alexcrichton closed <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12458\">issue #12458</a>:</p>\n<blockquote>\n<p>Thanks for filing a bug report! Please fill out the TODOs below.</p>\n<p><strong>Note: if you want to report a security issue, please read our <a href=\"https://bytecodealliance.org/security\">security policy</a>!</strong></p>\n<h3>Test Case</h3>\n<p>Use <code>Reqwest</code> for outbound HTTP calls that are sent by the <code>wasi-http</code> host </p>\n<h3>Steps to Reproduce</h3>\n<ul>\n<li>\n<p>We've created an implementation of the <code>wasi-http</code> host that uses <code>Reqwest 0.13</code> for outbound calls. When using <code>wit-bindgen's</code>  async-stream support to process the response of an outbound call through the host, we found that wasmtime encounters a situation that causes the guest module to crash.</p>\n</li>\n<li>\n<p>Upon further investigation, we found that Reqwest sends a 0-length frame when the end of stream is reached, which is not handled by the <code>poll_produce</code> method of <code>StreamProducer</code>. I think wasmtime should handle this case explicitly and prevent the guest from crashing, and I'm happy to create a PR with this change.</p>\n</li>\n<li>\n<p>The following <code>test</code> that can be added to <code>wasi-http/tests/all/p3/mod.rs</code> to simulate the condition that's triggered by the use of a library like <code>Reqwest</code>. Running the test with <code>cargo test -p wasmtime-wasi-http --features p3 --test all p3_http_empty_frame_at_end_of_stream -- --nocapture</code> should indicate the error.</p>\n</li>\n</ul>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"p\">::</span><span class=\"n\">pin</span><span class=\"p\">::</span><span class=\"n\">Pin</span><span class=\"p\">;</span>\n<span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">std</span><span class=\"p\">::</span><span class=\"n\">task</span><span class=\"p\">::{</span><span class=\"n\">Context</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">Poll</span><span class=\"p\">};</span>\n\n<span class=\"c1\">// Custom body wrapper that sends an empty frame at EOS while reporting is_end_stream() = true</span>\n<span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">BodyWithEmptyFrameAtEos</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">inner</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">http_body_util</span><span class=\"p\">::</span><span class=\"n\">StreamBody</span><span class=\"o\">&lt;</span>\n<span class=\"w\">        </span><span class=\"n\">futures</span><span class=\"p\">::</span><span class=\"n\">channel</span><span class=\"p\">::</span><span class=\"n\">mpsc</span><span class=\"p\">::</span><span class=\"n\">Receiver</span><span class=\"o\">&lt;</span><span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"n\">http_body</span><span class=\"p\">::</span><span class=\"n\">Frame</span><span class=\"o\">&lt;</span><span class=\"n\">Bytes</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ErrorCode</span><span class=\"o\">&gt;&gt;</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"o\">&gt;</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">sent_empty</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">bool</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">at_eos</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">bool</span><span class=\"p\">,</span>\n<span class=\"p\">}</span>\n\n<span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">http_body</span><span class=\"p\">::</span><span class=\"n\">Body</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">BodyWithEmptyFrameAtEos</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"k\">type</span><span class=\"w\"> </span><span class=\"nc\">Data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Bytes</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"k\">type</span><span class=\"w\"> </span><span class=\"nc\">Error</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">ErrorCode</span><span class=\"p\">;</span>\n\n<span class=\"w\">    </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">poll_frame</span><span class=\"p\">(</span>\n<span class=\"w\">        </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">Pin</span><span class=\"o\">&lt;&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"bp\">Self</span><span class=\"o\">&gt;</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"n\">cx</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kp\">&amp;</span><span class=\"nc\">mut</span><span class=\"w\"> </span><span class=\"n\">Context</span><span class=\"o\">&lt;'</span><span class=\"nb\">_</span><span class=\"o\">&gt;</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">Poll</span><span class=\"o\">&lt;</span><span class=\"nb\">Option</span><span class=\"o\">&lt;</span><span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"n\">http_body</span><span class=\"p\">::</span><span class=\"n\">Frame</span><span class=\"o\">&lt;</span><span class=\"bp\">Self</span><span class=\"p\">::</span><span class=\"n\">Data</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"bp\">Self</span><span class=\"p\">::</span><span class=\"n\">Error</span><span class=\"o\">&gt;&gt;&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"c1\">// First, poll the underlying body</span>\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"o\">*</span><span class=\"bp\">self</span><span class=\"p\">;</span>\n<span class=\"w\">        </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">Pin</span><span class=\"p\">::</span><span class=\"n\">new</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">this</span><span class=\"p\">.</span><span class=\"n\">inner</span><span class=\"p\">).</span><span class=\"n\">poll_frame</span><span class=\"p\">(</span><span class=\"n\">cx</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">            </span><span class=\"n\">Poll</span><span class=\"p\">::</span><span class=\"n\">Ready</span><span class=\"p\">(</span><span class=\"nb\">None</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">!</span><span class=\"n\">this</span><span class=\"p\">.</span><span class=\"n\">sent_empty</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">                </span><span class=\"c1\">// When the underlying body ends, send an empty frame</span>\n<span class=\"w\">                </span><span class=\"c1\">// This simulates HTTP implementations that send empty frames at EOS</span>\n<span class=\"w\">                </span><span class=\"n\">this</span><span class=\"p\">.</span><span class=\"n\">sent_empty</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">true</span><span class=\"p\">;</span>\n<span class=\"w\">                </span><span class=\"n\">this</span><span class=\"p\">.</span><span class=\"n\">at_eos</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"kc\">true</span><span class=\"p\">;</span>\n<span class=\"w\">                </span><span class=\"n\">Poll</span><span class=\"p\">::</span><span class=\"n\">Ready</span><span class=\"p\">(</span><span class=\"nb\">Some</span><span class=\"p\">(</span><span class=\"nb\">Ok</span><span class=\"p\">(</span><span class=\"n\">http_body</span><span class=\"p\">::</span><span class=\"n\">Frame</span><span class=\"p\">::</span><span class=\"n\">data</span><span class=\"p\">(</span><span class=\"n\">Bytes</span><span class=\"p\">::</span><span class=\"n\">new</span><span class=\"p\">()))))</span>\n<span class=\"w\">            </span><span class=\"p\">}</span>\n<span class=\"w\">            </span><span class=\"n\">other</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"n\">other</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"p\">}</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n\n<span class=\"w\">    </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">is_end_stream</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"bp\">self</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">bool</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"c1\">// Report end of stream once we've reached it</span>\n<span class=\"w\">        </span><span class=\"c1\">// This ensures is_end_stream() = true when we send the empty frame</span>\n<span class=\"w\">        </span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">at_eos</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n\n<span class=\"cp\">#[test_log::test(tokio::test(flavor = </span><span class=\"s\">\"multi_thread\"</span><span class=\"cp\">))]</span>\n<span class=\"k\">async</span><span class=\"w\"> </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">p3_http_empty_frame_at_end_of_stream</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"p\">()</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">_</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">env_logger</span><span class=\"p\">::</span><span class=\"n\">try_init</span><span class=\"p\">();</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// This test verifies the fix which handles the case where a zero-length frame is</span>\n<span class=\"w\">    </span><span class=\"c1\">// received when is_end_stream() is true. Without the fix, the StreamProducer would</span>\n<span class=\"w\">    </span><span class=\"c1\">// crash when the WASM guest tries to read such a frame.</span>\n\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">body</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s\">b\"test\"</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">raw_body</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Bytes</span><span class=\"p\">::</span><span class=\"n\">copy_from_slice</span><span class=\"p\">(</span><span class=\"n\">body</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">body_tx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">body_rx</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">futures</span><span class=\"p\">::</span><span class=\"n\">channel</span><span class=\"p\">::</span><span class=\"n\">mpsc</span><span class=\"p\">::</span><span class=\"n\">channel</span><span class=\"p\">::</span><span class=\"o\">&lt;</span><span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"n\">_</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ErrorCode</span><span class=\"o\">&gt;&gt;</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">wrapped_body</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">BodyWithEmptyFrameAtEos</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"n\">inner</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">http_body_util</span><span class=\"p\">::</span><span class=\"n\">StreamBody</span><span class=\"p\">::</span><span class=\"n\">new</span><span class=\"p\">(</span><span class=\"n\">body_rx</span><span class=\"p\">),</span>\n<span class=\"w\">        </span><span class=\"n\">sent_empty</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">false</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"n\">at_eos</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">false</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"p\">};</span>\n\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">request</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">http</span><span class=\"p\">::</span><span class=\"n\">Request</span><span class=\"p\">::</span><span class=\"n\">builder</span><span class=\"p\">()</span>\n<span class=\"w\">        </span><span class=\"p\">.</span><span class=\"n\">uri</span><span class=\"p\">(</span><span class=\"s\">\"http://localhost/\"</span><span class=\"p\">)</span>\n<span class=\"w\">        </span><span class=\"p\">.</span><span class=\"n\">method</span><span class=\"p\">(</span><span class=\"n\">http</span><span class=\"p\">::</span><span class=\"n\">Method</span><span class=\"p\">::</span><span class=\"n\">GET</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// Use the echo component which actually reads from the stream</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">response</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">futures</span><span class=\"p\">::</span><span class=\"n\">join</span><span class=\"o\">!</span><span class=\"p\">(</span>\n<span class=\"w\">        </span><span class=\"n\">run_http</span><span class=\"p\">(</span>\n<span class=\"w\">            </span><span class=\"n\">P3_HTTP_ECHO_COMPONENT</span><span class=\"p\">,</span>\n<span class=\"w\">            </span><span class=\"n\">request</span><span class=\"p\">.</span><span class=\"n\">body</span><span class=\"p\">(</span><span class=\"n\">wrapped_body</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">,</span>\n<span class=\"w\">            </span><span class=\"n\">oneshot</span><span class=\"p\">::</span><span class=\"n\">channel</span><span class=\"p\">().</span><span class=\"mi\">0</span>\n<span class=\"w\">        </span><span class=\"p\">),</span>\n<span class=\"w\">        </span><span class=\"k\">async</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">            </span><span class=\"n\">body_tx</span>\n<span class=\"w\">                </span><span class=\"p\">.</span><span class=\"n\">send</span><span class=\"p\">(</span><span class=\"nb\">Ok</span><span class=\"p\">(</span><span class=\"n\">http_body</span><span class=\"p\">::</span><span class=\"n\">Frame</span><span class=\"p\">::</span><span class=\"n\">data</span><span class=\"p\">(</span><span class=\"n\">raw_body</span><span class=\"p\">)))</span>\n<span class=\"w\">                </span><span class=\"p\">.</span><span class=\"k\">await</span>\n<span class=\"w\">                </span><span class=\"p\">.</span><span class=\"n\">unwrap</span><span class=\"p\">();</span>\n<span class=\"w\">            </span><span class=\"nb\">drop</span><span class=\"p\">(</span><span class=\"n\">body_tx</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"p\">}</span>\n<span class=\"w\">    </span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"p\">.</span><span class=\"mi\">0</span><span class=\"o\">?</span>\n<span class=\"w\">    </span><span class=\"p\">.</span><span class=\"n\">unwrap</span><span class=\"p\">();</span>\n\n<span class=\"w\">    </span><span class=\"fm\">assert_eq!</span><span class=\"p\">(</span><span class=\"n\">response</span><span class=\"p\">.</span><span class=\"n\">status</span><span class=\"p\">().</span><span class=\"n\">as_u16</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"mi\">200</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// Verify the body was echoed correctly (empty frames should be filtered out by the fix)</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">_</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">collected_body</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">response</span><span class=\"p\">.</span><span class=\"n\">into_parts</span><span class=\"p\">();</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">collected_body</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">collected_body</span><span class=\"p\">.</span><span class=\"n\">to_bytes</span><span class=\"p\">();</span>\n<span class=\"w\">    </span><span class=\"fm\">assert_eq!</span><span class=\"p\">(</span><span class=\"n\">collected_body</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">body</span><span class=\"p\">.</span><span class=\"n\">as_slice</span><span class=\"p\">());</span>\n<span class=\"w\">    </span><span class=\"nb\">Ok</span><span class=\"p\">(())</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>Thanks for looking into this!</p>\n<h3>Expected Results</h3>\n<p>The WASM guest should be able to <code>collect</code> the <code>stream</code> results and continue processing</p>\n<h3>Actual Results</h3>\n<p>The WASM guest crashes abruptly</p>\n<h3>Versions and Environment</h3>\n<p>Wasmtime version or commit: 41.0.x</p>\n</blockquote>",
        "id": 571115216,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769803748
    }
]
[
    {
        "content": "<p>cfallin opened <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10361\">issue #10361</a>:</p>\n<blockquote>\n<p>With the following test-case</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"n\">compile</span>\n<span class=\"n\">target</span><span class=\"w\"> </span><span class=\"n\">x86_64</span>\n\n<span class=\"n\">function</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">f0</span><span class=\"p\">(</span><span class=\"kt\">i32</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"n\">block0</span><span class=\"p\">(</span><span class=\"n\">v0</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v1</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">):</span>\n<span class=\"w\">  </span><span class=\"nc\">v2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">band</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v1</span>\n<span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">v2</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>when running the following command</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"n\">RUST_BACKTRACE</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">RUST_LOG</span><span class=\"o\">=</span><span class=\"n\">trace</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">cranelift</span><span class=\"o\">-</span><span class=\"n\">tools</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">test</span><span class=\"p\">.</span><span class=\"n\">clif</span>\n</code></pre></div>\n<p>I get a panic like so:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\"> </span><span class=\"n\">TRACE</span><span class=\"w\"> </span><span class=\"n\">cranelift_codegen</span><span class=\"p\">::</span><span class=\"n\">machinst</span><span class=\"p\">::</span><span class=\"n\">lower</span><span class=\"w\">      </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">lowering</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">inst</span><span class=\"w\"> </span><span class=\"n\">inst0</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">v2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">band</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v1</span>\n<span class=\"p\">[</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"p\">]</span>\n\n<span class=\"n\">thread</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">worker</span><span class=\"w\"> </span><span class=\"p\">#</span><span class=\"mi\">2</span><span class=\"o\">'</span><span class=\"w\"> </span><span class=\"n\">panicked</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">cranelift</span><span class=\"o\">/</span><span class=\"n\">codegen</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">isa</span><span class=\"o\">/</span><span class=\"n\">x64</span><span class=\"o\">/</span><span class=\"n\">inst</span><span class=\"o\">/</span><span class=\"n\">external</span><span class=\"p\">.</span><span class=\"n\">rs</span><span class=\"p\">:</span><span class=\"mi\">95</span><span class=\"p\">:</span><span class=\"mi\">9</span><span class=\"p\">:</span>\n<span class=\"nc\">internal</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">entered</span><span class=\"w\"> </span><span class=\"n\">unreachable</span><span class=\"w\"> </span><span class=\"n\">code</span>\n<span class=\"n\">stack</span><span class=\"w\"> </span><span class=\"n\">backtrace</span><span class=\"p\">:</span>\n<span class=\"p\">[</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"p\">]</span>\n<span class=\"w\">   </span><span class=\"mi\">3</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">cranelift_codegen</span><span class=\"p\">::</span><span class=\"n\">isa</span><span class=\"p\">::</span><span class=\"n\">x64</span><span class=\"p\">::</span><span class=\"n\">inst</span><span class=\"p\">::</span><span class=\"n\">external</span><span class=\"p\">::</span><span class=\"n\">enc_gpr</span>\n<span class=\"w\">             </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">cranelift</span><span class=\"o\">/</span><span class=\"n\">codegen</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">isa</span><span class=\"o\">/</span><span class=\"n\">x64</span><span class=\"o\">/</span><span class=\"n\">inst</span><span class=\"o\">/</span><span class=\"n\">external</span><span class=\"p\">.</span><span class=\"n\">rs</span><span class=\"p\">:</span><span class=\"mi\">95</span><span class=\"p\">:</span><span class=\"mi\">9</span>\n<span class=\"w\">   </span><span class=\"mi\">4</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">cranelift_codegen</span><span class=\"p\">::</span><span class=\"n\">isa</span><span class=\"p\">::</span><span class=\"n\">x64</span><span class=\"p\">::</span><span class=\"n\">inst</span><span class=\"p\">::</span><span class=\"n\">external</span><span class=\"p\">::</span><span class=\"n\">PairedGpr</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">cranelift_assembler_x64</span><span class=\"p\">::</span><span class=\"n\">api</span><span class=\"p\">::</span><span class=\"n\">AsReg</span><span class=\"o\">&gt;</span><span class=\"p\">::</span><span class=\"n\">enc</span>\n<span class=\"w\">             </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">cranelift</span><span class=\"o\">/</span><span class=\"n\">codegen</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">isa</span><span class=\"o\">/</span><span class=\"n\">x64</span><span class=\"o\">/</span><span class=\"n\">inst</span><span class=\"o\">/</span><span class=\"n\">external</span><span class=\"p\">.</span><span class=\"n\">rs</span><span class=\"p\">:</span><span class=\"mi\">35</span><span class=\"p\">:</span><span class=\"mi\">20</span>\n<span class=\"w\">   </span><span class=\"mi\">5</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">cranelift_assembler_x64</span><span class=\"p\">::</span><span class=\"n\">reg</span><span class=\"p\">::</span><span class=\"n\">Gpr</span><span class=\"o\">&lt;</span><span class=\"n\">R</span><span class=\"o\">&gt;</span><span class=\"p\">::</span><span class=\"n\">enc</span>\n<span class=\"w\">             </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">cranelift</span><span class=\"o\">/</span><span class=\"n\">assembler</span><span class=\"o\">-</span><span class=\"n\">x64</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">reg</span><span class=\"p\">.</span><span class=\"n\">rs</span><span class=\"p\">:</span><span class=\"mi\">27</span><span class=\"p\">:</span><span class=\"mi\">19</span>\n<span class=\"w\">   </span><span class=\"mi\">6</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">cranelift_assembler_x64</span><span class=\"p\">::</span><span class=\"n\">reg</span><span class=\"p\">::</span><span class=\"n\">Gpr</span><span class=\"o\">&lt;</span><span class=\"n\">R</span><span class=\"o\">&gt;</span><span class=\"p\">::</span><span class=\"n\">to_string</span>\n<span class=\"w\">             </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">cranelift</span><span class=\"o\">/</span><span class=\"n\">assembler</span><span class=\"o\">-</span><span class=\"n\">x64</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">reg</span><span class=\"p\">.</span><span class=\"n\">rs</span><span class=\"p\">:</span><span class=\"mi\">34</span><span class=\"p\">:</span><span class=\"mi\">24</span>\n<span class=\"w\">   </span><span class=\"mi\">7</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">cranelift_assembler_x64</span><span class=\"p\">::</span><span class=\"n\">inst</span><span class=\"p\">::</span><span class=\"n\">andl_rm</span><span class=\"o\">&lt;</span><span class=\"n\">R</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">core</span><span class=\"p\">::</span><span class=\"n\">fmt</span><span class=\"p\">::</span><span class=\"n\">Display</span><span class=\"o\">&gt;</span><span class=\"p\">::</span><span class=\"n\">fmt</span>\n<span class=\"w\">             </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">target</span><span class=\"o\">/</span><span class=\"n\">debug</span><span class=\"o\">/</span><span class=\"n\">build</span><span class=\"o\">/</span><span class=\"n\">cranelift</span><span class=\"o\">-</span><span class=\"n\">assembler</span><span class=\"o\">-</span><span class=\"n\">x64</span><span class=\"o\">-</span><span class=\"mi\">0</span><span class=\"n\">a4a19fac84309b6</span><span class=\"o\">/</span><span class=\"n\">out</span><span class=\"o\">/</span><span class=\"n\">assembler</span><span class=\"p\">.</span><span class=\"n\">rs</span><span class=\"p\">:</span><span class=\"mi\">4336</span><span class=\"p\">:</span><span class=\"mi\">19</span>\n<span class=\"p\">[</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"p\">]</span>\n<span class=\"w\">  </span><span class=\"mi\">22</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">cranelift_codegen</span><span class=\"p\">::</span><span class=\"n\">isa</span><span class=\"p\">::</span><span class=\"n\">x64</span><span class=\"p\">::</span><span class=\"n\">inst</span><span class=\"p\">::</span><span class=\"o\">&lt;</span><span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">cranelift_codegen</span><span class=\"p\">::</span><span class=\"n\">machinst</span><span class=\"p\">::</span><span class=\"n\">reg</span><span class=\"p\">::</span><span class=\"n\">PrettyPrint</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">cranelift_codegen</span><span class=\"p\">::</span><span class=\"n\">isa</span><span class=\"p\">::</span><span class=\"n\">x64</span><span class=\"p\">::</span><span class=\"n\">lower</span><span class=\"p\">::</span><span class=\"n\">isle</span><span class=\"p\">::</span><span class=\"n\">generated_code</span><span class=\"p\">::</span><span class=\"n\">MInst</span><span class=\"o\">&gt;</span><span class=\"p\">::</span><span class=\"n\">pretty_print</span>\n<span class=\"w\">             </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">cranelift</span><span class=\"o\">/</span><span class=\"n\">codegen</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">isa</span><span class=\"o\">/</span><span class=\"n\">x64</span><span class=\"o\">/</span><span class=\"n\">inst</span><span class=\"o\">/</span><span class=\"k\">mod</span><span class=\"p\">.</span><span class=\"n\">rs</span><span class=\"p\">:</span><span class=\"mi\">1983</span><span class=\"p\">:</span><span class=\"mi\">17</span>\n<span class=\"w\">  </span><span class=\"mi\">23</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">cranelift_codegen</span><span class=\"p\">::</span><span class=\"n\">isa</span><span class=\"p\">::</span><span class=\"n\">x64</span><span class=\"p\">::</span><span class=\"n\">inst</span><span class=\"p\">::</span><span class=\"o\">&lt;</span><span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">cranelift_codegen</span><span class=\"p\">::</span><span class=\"n\">machinst</span><span class=\"p\">::</span><span class=\"n\">MachInstEmit</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">cranelift_codegen</span><span class=\"p\">::</span><span class=\"n\">isa</span><span class=\"p\">::</span><span class=\"n\">x64</span><span class=\"p\">::</span><span class=\"n\">lower</span><span class=\"p\">::</span><span class=\"n\">isle</span><span class=\"p\">::</span><span class=\"n\">generated_code</span><span class=\"p\">::</span><span class=\"n\">MInst</span><span class=\"o\">&gt;</span><span class=\"p\">::</span><span class=\"n\">pretty_print_inst</span>\n<span class=\"w\">             </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">cranelift</span><span class=\"o\">/</span><span class=\"n\">codegen</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">isa</span><span class=\"o\">/</span><span class=\"n\">x64</span><span class=\"o\">/</span><span class=\"n\">inst</span><span class=\"o\">/</span><span class=\"k\">mod</span><span class=\"p\">.</span><span class=\"n\">rs</span><span class=\"p\">:</span><span class=\"mi\">2967</span><span class=\"p\">:</span><span class=\"mi\">9</span>\n<span class=\"w\">  </span><span class=\"mi\">24</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">cranelift_codegen</span><span class=\"p\">::</span><span class=\"n\">isa</span><span class=\"p\">::</span><span class=\"n\">x64</span><span class=\"p\">::</span><span class=\"n\">inst</span><span class=\"p\">::</span><span class=\"o\">&lt;</span><span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">core</span><span class=\"p\">::</span><span class=\"n\">fmt</span><span class=\"p\">::</span><span class=\"n\">Debug</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">cranelift_codegen</span><span class=\"p\">::</span><span class=\"n\">isa</span><span class=\"p\">::</span><span class=\"n\">x64</span><span class=\"p\">::</span><span class=\"n\">lower</span><span class=\"p\">::</span><span class=\"n\">isle</span><span class=\"p\">::</span><span class=\"n\">generated_code</span><span class=\"p\">::</span><span class=\"n\">MInst</span><span class=\"o\">&gt;</span><span class=\"p\">::</span><span class=\"n\">fmt</span>\n<span class=\"w\">             </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">cranelift</span><span class=\"o\">/</span><span class=\"n\">codegen</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">isa</span><span class=\"o\">/</span><span class=\"n\">x64</span><span class=\"o\">/</span><span class=\"n\">inst</span><span class=\"o\">/</span><span class=\"k\">mod</span><span class=\"p\">.</span><span class=\"n\">rs</span><span class=\"p\">:</span><span class=\"mi\">1991</span><span class=\"p\">:</span><span class=\"mi\">27</span>\n<span class=\"p\">[</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"p\">]</span>\n<span class=\"w\">  </span><span class=\"mi\">39</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">cranelift_codegen</span><span class=\"p\">::</span><span class=\"n\">machinst</span><span class=\"p\">::</span><span class=\"n\">lower</span><span class=\"p\">::</span><span class=\"n\">Lower</span><span class=\"o\">&lt;</span><span class=\"n\">I</span><span class=\"o\">&gt;</span><span class=\"p\">::</span><span class=\"n\">emit</span>\n<span class=\"w\">             </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">cranelift</span><span class=\"o\">/</span><span class=\"n\">codegen</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"p\">.</span><span class=\"n\">rs</span><span class=\"p\">:</span><span class=\"mi\">103</span><span class=\"p\">:</span><span class=\"mi\">13</span>\n</code></pre></div>\n<p>Basically, it seems that the new assembler generates a Debug impl that only works post-regalloc, but we have trace-log messages that print instructions pre-regalloc; we need to handle this as well somehow. Perhaps we can make <code>AsReg::enc()</code> return an <code>Option&lt;u8&gt;</code> and use the underlying <code>Debug</code> (<code>AsReg</code> requires <code>Debug</code>) if the plugged-in register value does not have a hardware encoding (as a vreg won't)?</p>\n<p>cc @abrown </p>\n</blockquote>",
        "id": 504518238,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1741598846
    },
    {
        "content": "<p>abrown assigned abrown to <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10361\">issue #10361</a>.</p>",
        "id": 504738256,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1741667304
    },
    {
        "content": "<p>abrown closed <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10361\">issue #10361</a>:</p>\n<blockquote>\n<p>With the following test-case</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"n\">compile</span>\n<span class=\"n\">target</span><span class=\"w\"> </span><span class=\"n\">x86_64</span>\n\n<span class=\"n\">function</span><span class=\"w\"> </span><span class=\"o\">%</span><span class=\"n\">f0</span><span class=\"p\">(</span><span class=\"kt\">i32</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"n\">block0</span><span class=\"p\">(</span><span class=\"n\">v0</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v1</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">i32</span><span class=\"p\">):</span>\n<span class=\"w\">  </span><span class=\"nc\">v2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">band</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v1</span>\n<span class=\"w\">  </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"n\">v2</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>when running the following command</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"n\">RUST_BACKTRACE</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">RUST_LOG</span><span class=\"o\">=</span><span class=\"n\">trace</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">p</span><span class=\"w\"> </span><span class=\"n\">cranelift</span><span class=\"o\">-</span><span class=\"n\">tools</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">test</span><span class=\"p\">.</span><span class=\"n\">clif</span>\n</code></pre></div>\n<p>I get a panic like so:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\"> </span><span class=\"n\">TRACE</span><span class=\"w\"> </span><span class=\"n\">cranelift_codegen</span><span class=\"p\">::</span><span class=\"n\">machinst</span><span class=\"p\">::</span><span class=\"n\">lower</span><span class=\"w\">      </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">lowering</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">inst</span><span class=\"w\"> </span><span class=\"n\">inst0</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">v2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">band</span><span class=\"p\">.</span><span class=\"kt\">i32</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">v1</span>\n<span class=\"p\">[</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"p\">]</span>\n\n<span class=\"n\">thread</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">worker</span><span class=\"w\"> </span><span class=\"p\">#</span><span class=\"mi\">2</span><span class=\"o\">'</span><span class=\"w\"> </span><span class=\"n\">panicked</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">cranelift</span><span class=\"o\">/</span><span class=\"n\">codegen</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">isa</span><span class=\"o\">/</span><span class=\"n\">x64</span><span class=\"o\">/</span><span class=\"n\">inst</span><span class=\"o\">/</span><span class=\"n\">external</span><span class=\"p\">.</span><span class=\"n\">rs</span><span class=\"p\">:</span><span class=\"mi\">95</span><span class=\"p\">:</span><span class=\"mi\">9</span><span class=\"p\">:</span>\n<span class=\"nc\">internal</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">entered</span><span class=\"w\"> </span><span class=\"n\">unreachable</span><span class=\"w\"> </span><span class=\"n\">code</span>\n<span class=\"n\">stack</span><span class=\"w\"> </span><span class=\"n\">backtrace</span><span class=\"p\">:</span>\n<span class=\"p\">[</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"p\">]</span>\n<span class=\"w\">   </span><span class=\"mi\">3</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">cranelift_codegen</span><span class=\"p\">::</span><span class=\"n\">isa</span><span class=\"p\">::</span><span class=\"n\">x64</span><span class=\"p\">::</span><span class=\"n\">inst</span><span class=\"p\">::</span><span class=\"n\">external</span><span class=\"p\">::</span><span class=\"n\">enc_gpr</span>\n<span class=\"w\">             </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">cranelift</span><span class=\"o\">/</span><span class=\"n\">codegen</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">isa</span><span class=\"o\">/</span><span class=\"n\">x64</span><span class=\"o\">/</span><span class=\"n\">inst</span><span class=\"o\">/</span><span class=\"n\">external</span><span class=\"p\">.</span><span class=\"n\">rs</span><span class=\"p\">:</span><span class=\"mi\">95</span><span class=\"p\">:</span><span class=\"mi\">9</span>\n<span class=\"w\">   </span><span class=\"mi\">4</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">cranelift_codegen</span><span class=\"p\">::</span><span class=\"n\">isa</span><span class=\"p\">::</span><span class=\"n\">x64</span><span class=\"p\">::</span><span class=\"n\">inst</span><span class=\"p\">::</span><span class=\"n\">external</span><span class=\"p\">::</span><span class=\"n\">PairedGpr</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">cranelift_assembler_x64</span><span class=\"p\">::</span><span class=\"n\">api</span><span class=\"p\">::</span><span class=\"n\">AsReg</span><span class=\"o\">&gt;</span><span class=\"p\">::</span><span class=\"n\">enc</span>\n<span class=\"w\">             </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">cranelift</span><span class=\"o\">/</span><span class=\"n\">codegen</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">isa</span><span class=\"o\">/</span><span class=\"n\">x64</span><span class=\"o\">/</span><span class=\"n\">inst</span><span class=\"o\">/</span><span class=\"n\">external</span><span class=\"p\">.</span><span class=\"n\">rs</span><span class=\"p\">:</span><span class=\"mi\">35</span><span class=\"p\">:</span><span class=\"mi\">20</span>\n<span class=\"w\">   </span><span class=\"mi\">5</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">cranelift_assembler_x64</span><span class=\"p\">::</span><span class=\"n\">reg</span><span class=\"p\">::</span><span class=\"n\">Gpr</span><span class=\"o\">&lt;</span><span class=\"n\">R</span><span class=\"o\">&gt;</span><span class=\"p\">::</span><span class=\"n\">enc</span>\n<span class=\"w\">             </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">cranelift</span><span class=\"o\">/</span><span class=\"n\">assembler</span><span class=\"o\">-</span><span class=\"n\">x64</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">reg</span><span class=\"p\">.</span><span class=\"n\">rs</span><span class=\"p\">:</span><span class=\"mi\">27</span><span class=\"p\">:</span><span class=\"mi\">19</span>\n<span class=\"w\">   </span><span class=\"mi\">6</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">cranelift_assembler_x64</span><span class=\"p\">::</span><span class=\"n\">reg</span><span class=\"p\">::</span><span class=\"n\">Gpr</span><span class=\"o\">&lt;</span><span class=\"n\">R</span><span class=\"o\">&gt;</span><span class=\"p\">::</span><span class=\"n\">to_string</span>\n<span class=\"w\">             </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">cranelift</span><span class=\"o\">/</span><span class=\"n\">assembler</span><span class=\"o\">-</span><span class=\"n\">x64</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">reg</span><span class=\"p\">.</span><span class=\"n\">rs</span><span class=\"p\">:</span><span class=\"mi\">34</span><span class=\"p\">:</span><span class=\"mi\">24</span>\n<span class=\"w\">   </span><span class=\"mi\">7</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"o\">&lt;</span><span class=\"n\">cranelift_assembler_x64</span><span class=\"p\">::</span><span class=\"n\">inst</span><span class=\"p\">::</span><span class=\"n\">andl_rm</span><span class=\"o\">&lt;</span><span class=\"n\">R</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"k\">as</span><span class=\"w\"> </span><span class=\"n\">core</span><span class=\"p\">::</span><span class=\"n\">fmt</span><span class=\"p\">::</span><span class=\"n\">Display</span><span class=\"o\">&gt;</span><span class=\"p\">::</span><span class=\"n\">fmt</span>\n<span class=\"w\">             </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">target</span><span class=\"o\">/</span><span class=\"n\">debug</span><span class=\"o\">/</span><span class=\"n\">build</span><span class=\"o\">/</span><span class=\"n\">cranelift</span><span class=\"o\">-</span><span class=\"n\">assembler</span><span class=\"o\">-</span><span class=\"n\">x64</span><span class=\"o\">-</span><span class=\"mi\">0</span><span class=\"n\">a4a19fac84309b6</span><span class=\"o\">/</span><span class=\"n\">out</span><span class=\"o\">/</span><span class=\"n\">assembler</span><span class=\"p\">.</span><span class=\"n\">rs</span><span class=\"p\">:</span><span class=\"mi\">4336</span><span class=\"p\">:</span><span class=\"mi\">19</span>\n<span class=\"p\">[</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"p\">]</span>\n<span class=\"w\">  </span><span class=\"mi\">22</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">cranelift_codegen</span><span class=\"p\">::</span><span class=\"n\">isa</span><span class=\"p\">::</span><span class=\"n\">x64</span><span class=\"p\">::</span><span class=\"n\">inst</span><span class=\"p\">::</span><span class=\"o\">&lt;</span><span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">cranelift_codegen</span><span class=\"p\">::</span><span class=\"n\">machinst</span><span class=\"p\">::</span><span class=\"n\">reg</span><span class=\"p\">::</span><span class=\"n\">PrettyPrint</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">cranelift_codegen</span><span class=\"p\">::</span><span class=\"n\">isa</span><span class=\"p\">::</span><span class=\"n\">x64</span><span class=\"p\">::</span><span class=\"n\">lower</span><span class=\"p\">::</span><span class=\"n\">isle</span><span class=\"p\">::</span><span class=\"n\">generated_code</span><span class=\"p\">::</span><span class=\"n\">MInst</span><span class=\"o\">&gt;</span><span class=\"p\">::</span><span class=\"n\">pretty_print</span>\n<span class=\"w\">             </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">cranelift</span><span class=\"o\">/</span><span class=\"n\">codegen</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">isa</span><span class=\"o\">/</span><span class=\"n\">x64</span><span class=\"o\">/</span><span class=\"n\">inst</span><span class=\"o\">/</span><span class=\"k\">mod</span><span class=\"p\">.</span><span class=\"n\">rs</span><span class=\"p\">:</span><span class=\"mi\">1983</span><span class=\"p\">:</span><span class=\"mi\">17</span>\n<span class=\"w\">  </span><span class=\"mi\">23</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">cranelift_codegen</span><span class=\"p\">::</span><span class=\"n\">isa</span><span class=\"p\">::</span><span class=\"n\">x64</span><span class=\"p\">::</span><span class=\"n\">inst</span><span class=\"p\">::</span><span class=\"o\">&lt;</span><span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">cranelift_codegen</span><span class=\"p\">::</span><span class=\"n\">machinst</span><span class=\"p\">::</span><span class=\"n\">MachInstEmit</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">cranelift_codegen</span><span class=\"p\">::</span><span class=\"n\">isa</span><span class=\"p\">::</span><span class=\"n\">x64</span><span class=\"p\">::</span><span class=\"n\">lower</span><span class=\"p\">::</span><span class=\"n\">isle</span><span class=\"p\">::</span><span class=\"n\">generated_code</span><span class=\"p\">::</span><span class=\"n\">MInst</span><span class=\"o\">&gt;</span><span class=\"p\">::</span><span class=\"n\">pretty_print_inst</span>\n<span class=\"w\">             </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">cranelift</span><span class=\"o\">/</span><span class=\"n\">codegen</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">isa</span><span class=\"o\">/</span><span class=\"n\">x64</span><span class=\"o\">/</span><span class=\"n\">inst</span><span class=\"o\">/</span><span class=\"k\">mod</span><span class=\"p\">.</span><span class=\"n\">rs</span><span class=\"p\">:</span><span class=\"mi\">2967</span><span class=\"p\">:</span><span class=\"mi\">9</span>\n<span class=\"w\">  </span><span class=\"mi\">24</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">cranelift_codegen</span><span class=\"p\">::</span><span class=\"n\">isa</span><span class=\"p\">::</span><span class=\"n\">x64</span><span class=\"p\">::</span><span class=\"n\">inst</span><span class=\"p\">::</span><span class=\"o\">&lt;</span><span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">core</span><span class=\"p\">::</span><span class=\"n\">fmt</span><span class=\"p\">::</span><span class=\"n\">Debug</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">cranelift_codegen</span><span class=\"p\">::</span><span class=\"n\">isa</span><span class=\"p\">::</span><span class=\"n\">x64</span><span class=\"p\">::</span><span class=\"n\">lower</span><span class=\"p\">::</span><span class=\"n\">isle</span><span class=\"p\">::</span><span class=\"n\">generated_code</span><span class=\"p\">::</span><span class=\"n\">MInst</span><span class=\"o\">&gt;</span><span class=\"p\">::</span><span class=\"n\">fmt</span>\n<span class=\"w\">             </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">cranelift</span><span class=\"o\">/</span><span class=\"n\">codegen</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">isa</span><span class=\"o\">/</span><span class=\"n\">x64</span><span class=\"o\">/</span><span class=\"n\">inst</span><span class=\"o\">/</span><span class=\"k\">mod</span><span class=\"p\">.</span><span class=\"n\">rs</span><span class=\"p\">:</span><span class=\"mi\">1991</span><span class=\"p\">:</span><span class=\"mi\">27</span>\n<span class=\"p\">[</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"p\">]</span>\n<span class=\"w\">  </span><span class=\"mi\">39</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">cranelift_codegen</span><span class=\"p\">::</span><span class=\"n\">machinst</span><span class=\"p\">::</span><span class=\"n\">lower</span><span class=\"p\">::</span><span class=\"n\">Lower</span><span class=\"o\">&lt;</span><span class=\"n\">I</span><span class=\"o\">&gt;</span><span class=\"p\">::</span><span class=\"n\">emit</span>\n<span class=\"w\">             </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">cranelift</span><span class=\"o\">/</span><span class=\"n\">codegen</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"p\">.</span><span class=\"n\">rs</span><span class=\"p\">:</span><span class=\"mi\">103</span><span class=\"p\">:</span><span class=\"mi\">13</span>\n</code></pre></div>\n<p>Basically, it seems that the new assembler generates a Debug impl that only works post-regalloc, but we have trace-log messages that print instructions pre-regalloc; we need to handle this as well somehow. Perhaps we can make <code>AsReg::enc()</code> return an <code>Option&lt;u8&gt;</code> and use the underlying <code>Debug</code> (<code>AsReg</code> requires <code>Debug</code>) if the plugged-in register value does not have a hardware encoding (as a vreg won't)?</p>\n<p>cc @abrown </p>\n</blockquote>",
        "id": 505699578,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1741965048
    }
]
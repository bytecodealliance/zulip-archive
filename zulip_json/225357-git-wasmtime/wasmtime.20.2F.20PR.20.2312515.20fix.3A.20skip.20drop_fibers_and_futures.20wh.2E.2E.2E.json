[
    {
        "content": "<p>zacharywhitley opened <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12515\">PR #12515</a> from <code>tegmentum:fix/skip-async-cleanup-when-disabled</code> to <code>bytecodealliance:main</code>:</p>\n<blockquote>\n<h2>Summary</h2>\n<p>When the <code>component-model-async</code> feature is compiled in but the store was created without concurrency support, <code>concurrent_state</code> is <code>None</code>. During <code>Store::drop</code>, <code>drop_fibers_and_futures</code> is called which then calls <code>concurrent_state_mut()</code>. This panics because <code>concurrent_state_mut()</code> unwraps the <code>None</code> value.</p>\n<p>This fix adds a runtime check to early-return when <code>concurrency_support()</code> returns <code>false</code>, preventing the panic during Store drop.</p>\n<h2>Problem</h2>\n<p>In <code>crates/wasmtime/src/runtime/store.rs</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">pub</span><span class=\"p\">(</span><span class=\"k\">crate</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">concurrent_state_mut</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"bp\">self</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"kp\">&amp;</span><span class=\"nc\">mut</span><span class=\"w\"> </span><span class=\"n\">concurrent</span><span class=\"p\">::</span><span class=\"n\">ConcurrentState</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"fm\">debug_assert!</span><span class=\"p\">(</span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">concurrency_support</span><span class=\"p\">());</span>\n<span class=\"w\">    </span><span class=\"bp\">self</span><span class=\"p\">.</span><span class=\"n\">concurrent_state</span><span class=\"p\">.</span><span class=\"n\">as_mut</span><span class=\"p\">().</span><span class=\"n\">unwrap</span><span class=\"p\">()</span><span class=\"w\">  </span><span class=\"c1\">// Panics if concurrent_state is None</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>The <code>debug_assert!</code> only catches this in debug builds, but in release builds the <code>unwrap()</code> will panic.</p>\n<h2>Fix</h2>\n<p>Add a guard in <code>drop_fibers_and_futures</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">pub</span><span class=\"p\">(</span><span class=\"k\">crate</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">drop_fibers_and_futures</span><span class=\"p\">(</span><span class=\"n\">store</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kp\">&amp;</span><span class=\"nc\">mut</span><span class=\"w\"> </span><span class=\"k\">dyn</span><span class=\"w\"> </span><span class=\"n\">VMStore</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"o\">!</span><span class=\"n\">store</span><span class=\"p\">.</span><span class=\"n\">concurrency_support</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"k\">return</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"w\">    </span><span class=\"c1\">// ... rest of cleanup</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<h2>Test Plan</h2>\n<ul>\n<li>Builds successfully with <code>cargo check -p wasmtime --features component-model,component-model-async,async</code></li>\n<li>Confirmed fix prevents panic when dropping stores created without concurrency support</li>\n</ul>\n</blockquote>",
        "id": 571900110,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1770209515
    },
    {
        "content": "<p><strong>zacharywhitley</strong> requested <a href=\"https://github.com/fitzgen\">fitzgen</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12515\">PR #12515</a>.</p>",
        "id": 571900122,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1770209517
    },
    {
        "content": "<p><strong>zacharywhitley</strong> requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers\">wasmtime-core-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12515\">PR #12515</a>.</p>",
        "id": 571900123,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1770209517
    },
    {
        "content": "<p>github-actions[bot] added the label <code>wasmtime:api</code> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12515\">PR #12515</a>.</p>",
        "id": 571918726,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1770213833
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12515#issuecomment-3848113663\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12515\">PR #12515</a>:</p>\n<blockquote>\n<p>Can you add a test for this as well? Somewhere in <code>tests/all/*.rs</code> for example</p>\n</blockquote>",
        "id": 571941113,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1770218874
    }
]
[
    {
        "content": "<p>gfx opened <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12483\">PR #12483</a> from <code>wado-lang:gfx/branch_hinting</code> to <code>bytecodealliance:main</code>:</p>\n<blockquote>\n<p>This PR adds support for the WebAssembly branch hinting proposal by parsing the <code>metadata.code.branch_hint</code> custom section and using the hints to mark cold blocks during Cranelift code generation.</p>\n<p>Implementation details:</p>\n<ul>\n<li>Parse branch hints in <code>ModuleTranslation</code> from the custom section using wasmparser's <code>KnownCustom::BranchHints</code> reader</li>\n<li>Store hints as a map from function index to (offset, taken) pairs</li>\n<li>Add <code>get_branch_hint()</code> helper in <code>FuncEnvironment</code> to look up hints by converting absolute byte offsets to function-relative offsets</li>\n<li>Apply hints in <code>translate_br_if()</code>: when a branch is marked unlikely (<code>taken=false</code>), mark the branch target as cold; when marked likely (<code>taken=true</code>), mark the fallthrough block as cold</li>\n</ul>\n<p>Branch hints are always parsed and applied when present in a module; no configuration flag is required.</p>\n<p>A disassembly test is included to verify cold block annotations, but official WebAssembly spec tests for this proposal are not yet available.</p>\n<p>Closes #9463</p>\n<p>&lt;!--<br>\nPlease make sure you include the following information:</p>\n<ul>\n<li>\n<p>If this work has been discussed elsewhere, please include a link to that<br>\n  conversation. If it was discussed in an issue, just mention \"issue #...\".</p>\n</li>\n<li>\n<p>Explain why this change is needed. If the details are in an issue already,<br>\n  this can be brief.</p>\n</li>\n</ul>\n<p>Our development process is documented in the Wasmtime book:<br>\n<a href=\"https://docs.wasmtime.dev/contributing-development-process.html\">https://docs.wasmtime.dev/contributing-development-process.html</a></p>\n<p>Please ensure all communication follows the code of conduct:<br>\n<a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md\">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>\n--&gt;</p>\n</blockquote>",
        "id": 571181732,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769852657
    },
    {
        "content": "<p><strong>gfx</strong> requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-compiler-reviewers\">wasmtime-compiler-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12483\">PR #12483</a>.</p>",
        "id": 571181735,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769852658
    },
    {
        "content": "<p><strong>gfx</strong> requested <a href=\"https://github.com/fitzgen\">fitzgen</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12483\">PR #12483</a>.</p>",
        "id": 571181736,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769852658
    },
    {
        "content": "<p><strong>gfx</strong> requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers\">wasmtime-core-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12483\">PR #12483</a>.</p>",
        "id": 571181737,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769852659
    },
    {
        "content": "<p><strong>gfx</strong> requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-default-reviewers\">wasmtime-default-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12483\">PR #12483</a>.</p>",
        "id": 571181738,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769852659
    },
    {
        "content": "<p>gfx edited <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12483\">PR #12483</a>:</p>\n<blockquote>\n<p>This PR adds support for the WebAssembly branch hinting proposal by parsing the <code>metadata.code.branch_hint</code> custom section and using the hints to mark cold blocks during Cranelift code generation.</p>\n<p>Implementation details:</p>\n<ul>\n<li>Parse branch hints in <code>ModuleTranslation</code> from the custom section using wasmparser's <code>KnownCustom::BranchHints</code> reader</li>\n<li>Store hints as a map from function index to (offset, taken) pairs</li>\n<li>Add <code>get_branch_hint()</code> helper in <code>FuncEnvironment</code> to look up hints by converting absolute byte offsets to function-relative offsets</li>\n<li>Apply hints in <code>translate_br_if()</code>: when a branch is marked unlikely (<code>taken=false</code>), mark the branch target as cold; when marked likely (<code>taken=true</code>), mark the fallthrough block as cold</li>\n</ul>\n<p>Branch hints are always parsed and applied when present in a module; no configuration flag is required.</p>\n<p>A disassembly test is included to verify cold block annotations, but official WebAssembly spec tests for this proposal are not yet available.</p>\n<p>Closes #9463</p>\n<p>Question: should I add a knob to enable/disable this feature? Currently, this is automatically turned on. I'm not sure I should add an option for it.</p>\n<p>&lt;!--<br>\nPlease make sure you include the following information:</p>\n<ul>\n<li>\n<p>If this work has been discussed elsewhere, please include a link to that<br>\n  conversation. If it was discussed in an issue, just mention \"issue #...\".</p>\n</li>\n<li>\n<p>Explain why this change is needed. If the details are in an issue already,<br>\n  this can be brief.</p>\n</li>\n</ul>\n<p>Our development process is documented in the Wasmtime book:<br>\n<a href=\"https://docs.wasmtime.dev/contributing-development-process.html\">https://docs.wasmtime.dev/contributing-development-process.html</a></p>\n<p>Please ensure all communication follows the code of conduct:<br>\n<a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md\">https://github.com/bytecodealliance/wasmtime/blob/main/CODE_OF_CONDUCT.md</a><br>\n--&gt;</p>\n</blockquote>",
        "id": 571183365,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769854057
    },
    {
        "content": "<p>github-actions[bot] added the label <code>wasmtime:docs</code> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12483\">PR #12483</a>.</p>",
        "id": 571189793,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769859997
    },
    {
        "content": "<p>alexcrichton submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12483#pullrequestreview-3737241825\">PR review</a>.</p>",
        "id": 571344559,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1770006162
    },
    {
        "content": "<p>alexcrichton created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12483#discussion_r2752490258\">PR review comment</a>:</p>\n<blockquote>\n<p>This loop I think might be good to optimize in terms of translation will only lookup branch hints (I think?) in increasing order of offsets. That means that currently this code is an $O(n^2)$ loop as-implemented. That could be optimized by using a binary search here, but I think this could go one step further and, ideally, store a reference to the raw buffer of input wasm data (in theory) here. For example this could be a <code>.peekable()</code> iterator over the raw wasm itself. Looking up via <code>get_branch_hint</code> would advance the iterator if it's at the matching position.</p>\n<p>Regardless I think it'll be needed to remove the quadratic behavior here, and I think ideally it'd be via an iterator-like approach to avoid the logarithmic nature of a binary search.</p>\n</blockquote>",
        "id": 571344561,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1770006163
    },
    {
        "content": "<p>fitzgen submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12483#pullrequestreview-3741186930\">PR review</a>:</p>\n<blockquote>\n<blockquote>\n<p>Question: should I add a knob to enable/disable this feature? Currently, this is automatically turned on. I'm not sure I should add an option for it.</p>\n</blockquote>\n<p>Yes, I think we should have a config knob for this.</p>\n<p>And to follow our rules by the letter, we we shouldn't enable it by default until it is fuzzed (and has been fuzzed for a couple weeks). This would most likely involve adding support to <code>wasm-smith</code> for emitting branch hints.</p>\n</blockquote>",
        "id": 571499262,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1770056716
    },
    {
        "content": "<p>fitzgen submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12483#pullrequestreview-3741186930\">PR review</a>:</p>\n<blockquote>\n<blockquote>\n<p>Question: should I add a knob to enable/disable this feature? Currently, this is automatically turned on. I'm not sure I should add an option for it.</p>\n</blockquote>\n<p>Yes, I think we should have a config knob for this.</p>\n<p>And to follow <a href=\"https://docs.wasmtime.dev/stability-wasm-proposals.html#feature-requirements\">our rules</a> by the letter, we we shouldn't enable it by default until it is fuzzed (and has been fuzzed for a couple weeks). This would most likely involve adding support to <code>wasm-smith</code> for emitting branch hints.</p>\n</blockquote>",
        "id": 571499561,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1770056815
    },
    {
        "content": "<p>gfx updated <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12483\">PR #12483</a>.</p>",
        "id": 571549447,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1770077889
    },
    {
        "content": "<p>gfx submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12483#pullrequestreview-3742188889\">PR review</a>.</p>",
        "id": 571549511,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1770077941
    },
    {
        "content": "<p>gfx created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12483#discussion_r2756554858\">PR review comment</a>:</p>\n<blockquote>\n<p>Ah, you are right. </p>\n<p>How about bc62088d6f7b31712badb427fd37e18c3c410a95 for O(n) complexity?</p>\n</blockquote>",
        "id": 571549512,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1770077941
    },
    {
        "content": "<p>cfallin submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12483#pullrequestreview-3742256268\">PR review</a>.</p>",
        "id": 571551141,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1770079218
    },
    {
        "content": "<p>cfallin created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12483#discussion_r2756612320\">PR review comment</a>:</p>\n<blockquote>\n<p>What Alex is getting at, i think, is that the <a href=\"https://webassembly.github.io/branch-hinting/metadata/code/binary.html\">spec</a> states that the hints are given in PC order. So why not traverse hints in order, taking them when they match as we visit increasing PC offsets? We should be able to that in O(n) time with O(1) space overhead, i.e., not building a HashMap at all.</p>\n</blockquote>",
        "id": 571551142,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1770079219
    },
    {
        "content": "<p>cfallin edited <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12483#discussion_r2756612320\">PR review comment</a>.</p>",
        "id": 571551166,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1770079236
    },
    {
        "content": "<p>AlbertMarashi <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12483#issuecomment-3877118280\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12483\">PR #12483</a>:</p>\n<blockquote>\n<p>How nice, I was just going to start using this - great to see it's being worked on!</p>\n</blockquote>",
        "id": 573016097,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1770724177
    }
]
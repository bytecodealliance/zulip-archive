[
    {
        "content": "<p>zzjas opened <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12451\">PR #12451</a> from <code>zzjas:fix-i31ref-gc</code> to <code>bytecodealliance:main</code>:</p>\n<blockquote>\n<p><code>OwnedRooted&lt;T&gt;::wasm_ty_store</code> unconditionally called <code>require_gc_store_mut()</code>, which fails with \"GC heap not initialized yet\" when passing an <code>i31ref</code> through a typed function and no GC heap has been allocated yet.</p>\n<p><a href=\"https://github.com/bytecodealliance/wasmtime/blob/ab1ab705dd93e7c944c13d4d4b2683e049f4ff73/crates/wasmtime/src/runtime/gc/enabled/rooting.rs#L1817-L1829\">https://github.com/bytecodealliance/wasmtime/blob/ab1ab705dd93e7c944c13d4d4b2683e049f4ff73/crates/wasmtime/src/runtime/gc/enabled/rooting.rs#L1817-L1829</a></p>\n<p>The sibling method <code>Rooted&lt;T&gt;::wasm_ty_store</code> already handles this by using <code>optional_gc_store_mut()</code> with an i31 fallback.</p>\n<p><a href=\"https://github.com/bytecodealliance/wasmtime/blob/ab1ab705dd93e7c944c13d4d4b2683e049f4ff73/crates/wasmtime/src/runtime/gc/enabled/rooting.rs#L1214-L1222\">https://github.com/bytecodealliance/wasmtime/blob/ab1ab705dd93e7c944c13d4d4b2683e049f4ff73/crates/wasmtime/src/runtime/gc/enabled/rooting.rs#L1214-L1222</a></p>\n<p>This PR makes <code>OwnedRooted</code> match that behavior and adds a regression test that fails without the fix and passes with it.</p>\n<p>Without the fix, running <code>cargo test -p wasmtime-cli --test all i31ref::owned_rooted_i31ref_through_typed_wasm_func</code> gives:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">running</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">test</span>\n<span class=\"n\">test</span><span class=\"w\"> </span><span class=\"n\">i31ref</span><span class=\"p\">::</span><span class=\"n\">owned_rooted_i31ref_through_typed_wasm_func</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"n\">FAILED</span>\n\n<span class=\"n\">failures</span><span class=\"p\">:</span>\n\n<span class=\"o\">----</span><span class=\"w\"> </span><span class=\"n\">i31ref</span><span class=\"p\">::</span><span class=\"n\">owned_rooted_i31ref_through_typed_wasm_func</span><span class=\"w\"> </span><span class=\"n\">stdout</span><span class=\"w\"> </span><span class=\"o\">----</span>\n<span class=\"n\">Error</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">GC</span><span class=\"w\"> </span><span class=\"n\">heap</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">initialized</span><span class=\"w\"> </span><span class=\"n\">yet</span>\n\n\n<span class=\"n\">failures</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"nc\">i31ref</span><span class=\"p\">::</span><span class=\"n\">owned_rooted_i31ref_through_typed_wasm_func</span>\n\n<span class=\"n\">test</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">FAILED</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">passed</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">ignored</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"n\">measured</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"mi\">1043</span><span class=\"w\"> </span><span class=\"n\">filtered</span><span class=\"w\"> </span><span class=\"n\">out</span><span class=\"p\">;</span><span class=\"w\"> </span><span class=\"n\">finished</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"mf\">0.01</span><span class=\"n\">s</span>\n</code></pre></div>\n<p>Thanks for looking into this!</p>\n</blockquote>",
        "id": 570396085,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769539021
    },
    {
        "content": "<p><strong>zzjas</strong> requested <a href=\"https://github.com/fitzgen\">fitzgen</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12451\">PR #12451</a>.</p>",
        "id": 570396088,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769539022
    },
    {
        "content": "<p><strong>zzjas</strong> requested <a href=\"https://github.com/orgs/bytecodealliance/teams/wasmtime-core-reviewers\">wasmtime-core-reviewers</a> for a review on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12451\">PR #12451</a>.</p>",
        "id": 570396090,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769539022
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12451#discussion_r2733481053\">PR review comment</a>:</p>\n<blockquote>\n<p>To make sure that this tests what you intend it to test even when invoked via <code>cargo test --all-features</code> (which is how our CI runs unit tests) we need to add <code>config.gc_support(false)</code> here:</p>\n<p><div class=\"codehilite\" data-code-language=\"suggestion\"><pre><span></span><code>    let mut config = Config::new();\n    config.wasm_function_references(true);\n    config.wasm_gc(true);\n    config.gc_support(false);\n</code></pre></div><br>\n</p>\n</blockquote>",
        "id": 570403786,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769541578
    },
    {
        "content": "<p>fitzgen submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12451#pullrequestreview-3713031864\">PR review</a>:</p>\n<blockquote>\n<p>Thanks! Looks good with one minor addition below:</p>\n</blockquote>",
        "id": 570403788,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769541578
    },
    {
        "content": "<p>github-actions[bot] added the label <code>wasmtime:api</code> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12451\">PR #12451</a>.</p>",
        "id": 570419341,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769546901
    },
    {
        "content": "<p>github-actions[bot] added the label <code>wasmtime:ref-types</code> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12451\">PR #12451</a>.</p>",
        "id": 570419343,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769546901
    },
    {
        "content": "<p>github-actions[bot] <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12451#issuecomment-3807463709\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12451\">PR #12451</a>:</p>\n<blockquote>\n<h4>Subscribe to Label Action</h4>\n<p>cc @fitzgen</p>\n<p>&lt;details&gt;<br>\nThis issue or pull request has been labeled: \"wasmtime:api\", \"wasmtime:ref-types\"</p>\n<p>Thus the following users have been cc'd because of the following labels:</p>\n<ul>\n<li>fitzgen: wasmtime:ref-types</li>\n</ul>\n<p>To subscribe or unsubscribe from this label, edit the &lt;code&gt;.github/subscribe-to-label.json&lt;/code&gt; configuration file.</p>\n<p><a href=\"https://github.com/bytecodealliance/subscribe-to-label-action\">Learn more.</a><br>\n&lt;/details&gt;</p>\n</blockquote>",
        "id": 570419430,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769546938
    },
    {
        "content": "<p>zzjas created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12451#discussion_r2733824360\">PR review comment</a>:</p>\n<blockquote>\n<p>Thanks for the suggestion! I tried this locally but it will break the test since <code>(ref null any)</code> will cause <code>gc types are disallowed</code>. But I also tried to run <code>cargo test --all-features</code> without the fix, it will correctly fail with <code>GC heap not initialized yet</code>. I think since the test module doesn't have gc operations so a GcStore was not created -- so the test triggers the desired path.</p>\n</blockquote>",
        "id": 570422567,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769547930
    },
    {
        "content": "<p>zzjas submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12451#pullrequestreview-3713454694\">PR review</a>.</p>",
        "id": 570422568,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769547930
    },
    {
        "content": "<p>fitzgen submitted <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12451#pullrequestreview-3713600194\">PR review</a>.</p>",
        "id": 570428665,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769550243
    },
    {
        "content": "<p>fitzgen created <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12451#discussion_r2733945920\">PR review comment</a>:</p>\n<blockquote>\n<p>Ah okay, that makes sense. Thanks!</p>\n</blockquote>",
        "id": 570428666,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769550243
    },
    {
        "content": "<p>fitzgen added <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12451\">PR #12451 Fix <code>OwnedRooted&lt;T&gt;::wasm_ty_store</code> missing <code>i31ref</code> check</a> to the merge queue.</p>",
        "id": 570428677,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769550249
    },
    {
        "content": "<p>fitzgen merged <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12451\">PR #12451</a>.</p>",
        "id": 570432229,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769551723
    },
    {
        "content": "<p>fitzgen removed <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12451\">PR #12451 Fix <code>OwnedRooted&lt;T&gt;::wasm_ty_store</code> missing <code>i31ref</code> check</a> from the merge queue.</p>",
        "id": 570432232,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1769551724
    }
]
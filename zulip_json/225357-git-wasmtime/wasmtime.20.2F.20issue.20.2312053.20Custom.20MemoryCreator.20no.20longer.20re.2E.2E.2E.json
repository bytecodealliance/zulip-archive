[
    {
        "content": "<p>d-sonuga opened <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12053\">issue #12053</a>:</p>\n<blockquote>\n<p>Hi,</p>\n<p>I've run into an issue after upgrading from Wasmtime 21 to 33, specifically around the behavior of a custom <code>MemoryCreator</code> implementation. I'm using a custom memory creator that allocates memory using mmaped pages.  When the memory is modified, those changes are persisted to disk. On startup, the memory creator reconstructs linear memory from the persisted pages.</p>\n<p>This setup works fine on Wasmtime 21.<br>\nHowever, on Wasmtime 33 (and 38), the behavior changes: the custom-created memory region appears not to be modified, even though the wasm module executes normally. It looks like Wasmtime doesn't actually modify the memory returned by the <code>MemoryCreator</code>.</p>\n<p>My suspicion is that something in Wasmtime's internal memory handling changed, but I'm not certain.</p>\n<p>This is the configuration:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">config</span><span class=\"p\">.</span><span class=\"n\">wasm_backtrace</span><span class=\"p\">(</span><span class=\"kc\">false</span><span class=\"p\">);</span>\n<span class=\"n\">config</span><span class=\"p\">.</span><span class=\"n\">wasm_backtrace_details</span><span class=\"p\">(</span><span class=\"n\">WasmBacktraceDetails</span><span class=\"p\">::</span><span class=\"n\">Disable</span><span class=\"p\">);</span>\n<span class=\"n\">config</span><span class=\"p\">.</span><span class=\"n\">native_unwind_info</span><span class=\"p\">(</span><span class=\"kc\">false</span><span class=\"p\">);</span>\n<span class=\"n\">config</span><span class=\"p\">.</span><span class=\"n\">max_wasm_stack</span><span class=\"p\">(</span><span class=\"mh\">0x80000</span><span class=\"p\">);</span>\n<span class=\"n\">config</span><span class=\"p\">.</span><span class=\"n\">consume_fuel</span><span class=\"p\">(</span><span class=\"kc\">true</span><span class=\"p\">);</span>\n<span class=\"n\">config</span><span class=\"p\">.</span><span class=\"n\">strategy</span><span class=\"p\">(</span><span class=\"n\">Strategy</span><span class=\"p\">::</span><span class=\"n\">Cranelift</span><span class=\"p\">);</span>\n<span class=\"n\">config</span><span class=\"p\">.</span><span class=\"n\">cranelift_opt_level</span><span class=\"p\">(</span><span class=\"n\">OptLevel</span><span class=\"p\">::</span><span class=\"n\">SpeedAndSize</span><span class=\"p\">);</span>\n<span class=\"n\">config</span><span class=\"p\">.</span><span class=\"n\">cranelift_nan_canonicalization</span><span class=\"p\">(</span><span class=\"kc\">true</span><span class=\"p\">);</span>\n<span class=\"n\">config</span><span class=\"p\">.</span><span class=\"n\">memory_may_move</span><span class=\"p\">(</span><span class=\"kc\">false</span><span class=\"p\">);</span>\n<span class=\"n\">config</span><span class=\"p\">.</span><span class=\"n\">memory_guard_size</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">);</span>\n<span class=\"n\">config</span><span class=\"p\">.</span><span class=\"n\">guard_before_linear_memory</span><span class=\"p\">(</span><span class=\"kc\">false</span><span class=\"p\">);</span>\n<span class=\"n\">config</span><span class=\"p\">.</span><span class=\"n\">memory_init_cow</span><span class=\"p\">(</span><span class=\"kc\">false</span><span class=\"p\">);</span>\n<span class=\"n\">config</span><span class=\"p\">.</span><span class=\"n\">generate_address_map</span><span class=\"p\">(</span><span class=\"kc\">false</span><span class=\"p\">);</span>\n<span class=\"n\">config</span><span class=\"p\">.</span><span class=\"n\">macos_use_mach_ports</span><span class=\"p\">(</span><span class=\"kc\">false</span><span class=\"p\">);</span>\n<span class=\"n\">config</span><span class=\"p\">.</span><span class=\"n\">wasm_memory64</span><span class=\"p\">(</span><span class=\"kc\">true</span><span class=\"p\">);</span>\n</code></pre></div>\n<p>The <code>with_host_memory</code> is called later on to set the memory creator.</p>\n<p>@alexcrichton?</p>\n</blockquote>",
        "id": 558365846,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1763624804
    },
    {
        "content": "<p>d-sonuga <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12053#issuecomment-3556640016\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12053\">issue #12053</a>:</p>\n<blockquote>\n<p>Update: the memory actually gets written - the mmap page faults are being triggered and handled correctly - I think the reason is because of instance initialization - the memory keeps getting reinitialized, even when it shouldn't, the <code>needs_init</code> has been removed from the <code>LinearMemory</code> implementation - I think that's it - what was it replaced with?</p>\n</blockquote>",
        "id": 558376264,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1763628486
    },
    {
        "content": "<p>d-sonuga <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12053#issuecomment-3556870116\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12053\">issue #12053</a>:</p>\n<blockquote>\n<p>Update: sorry, it's not Wasmtime that changed. The problem was on my side.</p>\n</blockquote>",
        "id": 558384522,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1763631082
    },
    {
        "content": "<p>alexcrichton closed <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12053\">issue #12053</a>:</p>\n<blockquote>\n<p>Hi,</p>\n<p>I've run into an issue after upgrading from Wasmtime 21 to 33, specifically around the behavior of a custom <code>MemoryCreator</code> implementation. I'm using a custom memory creator that allocates memory using mmaped pages.  When the memory is modified, those changes are persisted to disk. On startup, the memory creator reconstructs linear memory from the persisted pages.</p>\n<p>This setup works fine on Wasmtime 21.<br>\nHowever, on Wasmtime 33 (and 38), the behavior changes: the custom-created memory region appears not to be modified, even though the wasm module executes normally. It looks like Wasmtime doesn't actually modify the memory returned by the <code>MemoryCreator</code>.</p>\n<p>My suspicion is that something in Wasmtime's internal memory handling changed, but I'm not certain.</p>\n<p>This is the configuration:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">config</span><span class=\"p\">.</span><span class=\"n\">wasm_backtrace</span><span class=\"p\">(</span><span class=\"kc\">false</span><span class=\"p\">);</span>\n<span class=\"n\">config</span><span class=\"p\">.</span><span class=\"n\">wasm_backtrace_details</span><span class=\"p\">(</span><span class=\"n\">WasmBacktraceDetails</span><span class=\"p\">::</span><span class=\"n\">Disable</span><span class=\"p\">);</span>\n<span class=\"n\">config</span><span class=\"p\">.</span><span class=\"n\">native_unwind_info</span><span class=\"p\">(</span><span class=\"kc\">false</span><span class=\"p\">);</span>\n<span class=\"n\">config</span><span class=\"p\">.</span><span class=\"n\">max_wasm_stack</span><span class=\"p\">(</span><span class=\"mh\">0x80000</span><span class=\"p\">);</span>\n<span class=\"n\">config</span><span class=\"p\">.</span><span class=\"n\">consume_fuel</span><span class=\"p\">(</span><span class=\"kc\">true</span><span class=\"p\">);</span>\n<span class=\"n\">config</span><span class=\"p\">.</span><span class=\"n\">strategy</span><span class=\"p\">(</span><span class=\"n\">Strategy</span><span class=\"p\">::</span><span class=\"n\">Cranelift</span><span class=\"p\">);</span>\n<span class=\"n\">config</span><span class=\"p\">.</span><span class=\"n\">cranelift_opt_level</span><span class=\"p\">(</span><span class=\"n\">OptLevel</span><span class=\"p\">::</span><span class=\"n\">SpeedAndSize</span><span class=\"p\">);</span>\n<span class=\"n\">config</span><span class=\"p\">.</span><span class=\"n\">cranelift_nan_canonicalization</span><span class=\"p\">(</span><span class=\"kc\">true</span><span class=\"p\">);</span>\n<span class=\"n\">config</span><span class=\"p\">.</span><span class=\"n\">memory_may_move</span><span class=\"p\">(</span><span class=\"kc\">false</span><span class=\"p\">);</span>\n<span class=\"n\">config</span><span class=\"p\">.</span><span class=\"n\">memory_guard_size</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">);</span>\n<span class=\"n\">config</span><span class=\"p\">.</span><span class=\"n\">guard_before_linear_memory</span><span class=\"p\">(</span><span class=\"kc\">false</span><span class=\"p\">);</span>\n<span class=\"n\">config</span><span class=\"p\">.</span><span class=\"n\">memory_init_cow</span><span class=\"p\">(</span><span class=\"kc\">false</span><span class=\"p\">);</span>\n<span class=\"n\">config</span><span class=\"p\">.</span><span class=\"n\">generate_address_map</span><span class=\"p\">(</span><span class=\"kc\">false</span><span class=\"p\">);</span>\n<span class=\"n\">config</span><span class=\"p\">.</span><span class=\"n\">macos_use_mach_ports</span><span class=\"p\">(</span><span class=\"kc\">false</span><span class=\"p\">);</span>\n<span class=\"n\">config</span><span class=\"p\">.</span><span class=\"n\">wasm_memory64</span><span class=\"p\">(</span><span class=\"kc\">true</span><span class=\"p\">);</span>\n</code></pre></div>\n<p>The <code>with_host_memory</code> is called later on to set the memory creator.</p>\n<p>@alexcrichton?</p>\n</blockquote>",
        "id": 558458583,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1763652218
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12053#issuecomment-3558645204\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/12053\">issue #12053</a>:</p>\n<blockquote>\n<p>Ah no worries! I wouldn't rule out something changing on the Wasmtime side as well, so if that shows up feel free to comment here and I can reopen</p>\n</blockquote>",
        "id": 558458586,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1763652218
    }
]
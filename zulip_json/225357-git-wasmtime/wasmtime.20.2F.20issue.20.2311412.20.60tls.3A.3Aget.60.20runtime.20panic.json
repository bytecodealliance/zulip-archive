[
    {
        "content": "<p>rvolosatovs opened <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11412\">issue #11412</a>:</p>\n<blockquote>\n<h3>Test Case</h3>\n<p>While working on wasip3 <code>wasi:filesystem</code> I've encountered a panic in <a href=\"https://github.com/bytecodealliance/wasmtime/commit/54384721d13fcf5eecdc11a57eeb2c2a1c3e73c9\">https://github.com/bytecodealliance/wasmtime/commit/54384721d13fcf5eecdc11a57eeb2c2a1c3e73c9</a></p>\n<h3>Steps to Reproduce</h3>\n<ul>\n<li>checkout <a href=\"https://github.com/bytecodealliance/wasmtime/commit/54384721d13fcf5eecdc11a57eeb2c2a1c3e73c9\">https://github.com/bytecodealliance/wasmtime/commit/54384721d13fcf5eecdc11a57eeb2c2a1c3e73c9</a></li>\n<li>run <code>wasmtime_wasi</code> tests with <code>p3</code> feature enabled</li>\n</ul>\n<h3>Expected Results</h3>\n<p>If the issue is in the <code>wasi:filesystem</code> implementation, i.e. the wasmtime API usage I'd ideally expect a compile-time error. If that's not possible, I'd expect a clearer error message as to what's wrong. If the implementation is correct, I'd not expect a panic.</p>\n<h3>Actual Results</h3>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">thread</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">p3</span><span class=\"p\">::</span><span class=\"n\">p3_filesystem_file_read_write</span><span class=\"o\">'</span><span class=\"w\"> </span><span class=\"n\">panicked</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">crates</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">runtime</span><span class=\"o\">/</span><span class=\"n\">component</span><span class=\"o\">/</span><span class=\"n\">concurrent</span><span class=\"o\">/</span><span class=\"n\">tls</span><span class=\"p\">.</span><span class=\"n\">rs</span><span class=\"p\">:</span><span class=\"mi\">81</span><span class=\"p\">:</span><span class=\"mi\">5</span><span class=\"p\">:</span>\n<span class=\"nc\">attempted</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">recursively</span><span class=\"w\"> </span><span class=\"n\">call</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">tls</span><span class=\"p\">::</span><span class=\"n\">get</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">when</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">pointer</span><span class=\"w\"> </span><span class=\"n\">was</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">present</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"n\">already</span><span class=\"w\"> </span><span class=\"n\">taken</span><span class=\"w\"> </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">previous</span><span class=\"w\"> </span><span class=\"n\">call</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">tls</span><span class=\"p\">::</span><span class=\"n\">get</span><span class=\"err\">`</span>\n</code></pre></div>\n<h3>Versions and Environment</h3>\n<p>Wasmtime version or commit: <a href=\"https://github.com/bytecodealliance/wasmtime/commit/54384721d13fcf5eecdc11a57eeb2c2a1c3e73c9\">https://github.com/bytecodealliance/wasmtime/commit/54384721d13fcf5eecdc11a57eeb2c2a1c3e73c9</a></p>\n<p>Operating system: macOS</p>\n<p>Architecture: aarch64<br>\n</p>\n</blockquote>",
        "id": 533774517,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1754912705
    },
    {
        "content": "<p><a href=\"https://github.com/rvolosatovs\">rvolosatovs</a> added the bug label to <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11412\">Issue #11412</a>.</p>",
        "id": 533774520,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1754912705
    },
    {
        "content": "<p>rvolosatovs <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11412#issuecomment-3174454768\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11412\">issue #11412</a>:</p>\n<blockquote>\n<p>FWIW, I've just tested <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11374\">https://github.com/bytecodealliance/wasmtime/pull/11374</a> and it did not fix the issue</p>\n</blockquote>",
        "id": 533776605,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1754913344
    },
    {
        "content": "<p>alexcrichton <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11412#issuecomment-3175163212\">commented</a> on <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11412\">issue #11412</a>:</p>\n<blockquote>\n<p>This is happening due to <a href=\"https://github.com/bytecodealliance/wasmtime/blob/28f978355509b2a2802cc74388e6feb0be8d0571/crates/wasmtime/src/runtime/component/concurrent.rs#L444-L449\">this panic condition</a>. Effectively <a href=\"https://github.com/bytecodealliance/wasmtime/blob/54384721d13fcf5eecdc11a57eeb2c2a1c3e73c9/crates/wasi/src/p3/filesystem/host.rs#L232\">this line</a> enters a <code>with</code> but <code>store.get_file(&amp;fd)?</code> a few lines down  <a href=\"https://github.com/bytecodealliance/wasmtime/blob/54384721d13fcf5eecdc11a57eeb2c2a1c3e73c9/crates/wasi/src/p3/filesystem/host.rs#L50\">also calls <code>self.with</code></a>, hence the recursive access. </p>\n<p>This is more-or-less a known footgun with <code>Accessor</code>, and I'm not sure how to design something that statically avoids it. I have an idea for improving the error message though.</p>\n</blockquote>",
        "id": 533808797,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1754923107
    },
    {
        "content": "<p>fitzgen closed <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11412\">issue #11412</a>:</p>\n<blockquote>\n<h3>Test Case</h3>\n<p>While working on wasip3 <code>wasi:filesystem</code> I've encountered a panic in <a href=\"https://github.com/bytecodealliance/wasmtime/commit/54384721d13fcf5eecdc11a57eeb2c2a1c3e73c9\">https://github.com/bytecodealliance/wasmtime/commit/54384721d13fcf5eecdc11a57eeb2c2a1c3e73c9</a></p>\n<h3>Steps to Reproduce</h3>\n<ul>\n<li>checkout <a href=\"https://github.com/bytecodealliance/wasmtime/commit/54384721d13fcf5eecdc11a57eeb2c2a1c3e73c9\">https://github.com/bytecodealliance/wasmtime/commit/54384721d13fcf5eecdc11a57eeb2c2a1c3e73c9</a></li>\n<li>run <code>wasmtime_wasi</code> tests with <code>p3</code> feature enabled</li>\n</ul>\n<h3>Expected Results</h3>\n<p>If the issue is in the <code>wasi:filesystem</code> implementation, i.e. the wasmtime API usage I'd ideally expect a compile-time error. If that's not possible, I'd expect a clearer error message as to what's wrong. If the implementation is correct, I'd not expect a panic.</p>\n<h3>Actual Results</h3>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">thread</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">p3</span><span class=\"p\">::</span><span class=\"n\">p3_filesystem_file_read_write</span><span class=\"o\">'</span><span class=\"w\"> </span><span class=\"n\">panicked</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">crates</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">runtime</span><span class=\"o\">/</span><span class=\"n\">component</span><span class=\"o\">/</span><span class=\"n\">concurrent</span><span class=\"o\">/</span><span class=\"n\">tls</span><span class=\"p\">.</span><span class=\"n\">rs</span><span class=\"p\">:</span><span class=\"mi\">81</span><span class=\"p\">:</span><span class=\"mi\">5</span><span class=\"p\">:</span>\n<span class=\"nc\">attempted</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">recursively</span><span class=\"w\"> </span><span class=\"n\">call</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">tls</span><span class=\"p\">::</span><span class=\"n\">get</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">when</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">pointer</span><span class=\"w\"> </span><span class=\"n\">was</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">present</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"n\">already</span><span class=\"w\"> </span><span class=\"n\">taken</span><span class=\"w\"> </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">previous</span><span class=\"w\"> </span><span class=\"n\">call</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">tls</span><span class=\"p\">::</span><span class=\"n\">get</span><span class=\"err\">`</span>\n</code></pre></div>\n<h3>Versions and Environment</h3>\n<p>Wasmtime version or commit: <a href=\"https://github.com/bytecodealliance/wasmtime/commit/54384721d13fcf5eecdc11a57eeb2c2a1c3e73c9\">https://github.com/bytecodealliance/wasmtime/commit/54384721d13fcf5eecdc11a57eeb2c2a1c3e73c9</a></p>\n<p>Operating system: macOS</p>\n<p>Architecture: aarch64<br>\n</p>\n</blockquote>",
        "id": 533829887,
        "sender_full_name": "Wasmtime GitHub notifications bot",
        "timestamp": 1754930198
    }
]
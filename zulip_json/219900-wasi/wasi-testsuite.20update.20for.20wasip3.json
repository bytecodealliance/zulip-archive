[
    {
        "content": "<p>Hello all, I am working on creating a test suite for wasip3.  My near-term goal is to reach <code>wasi-http</code>, without sockets.  The longer-term goal is a conformance test that will allow an implementation of wasi to be evaluated as actually implementing wasip3.</p>\n<p>I will be primarily testing wasmtime but also jco on top of node.</p>\n<p>On a suggestion from <span class=\"user-mention\" data-user-id=\"421591\">@Bailey Hayes</span> I am looking at using <a href=\"https://github.com/WebAssembly/wasi-testsuite\">wasi-testsuite</a> as a base.  I will post into this topic as I go, and will probably also poke people for questions :)</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/WebAssembly/wasi-testsuite\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/1300fb483476ef3ebf77219f77973d063d1c0a60/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f333836383833336431396265386531303139633264623530393266333336366232643838373665656432346536386235303064376438383865366466373762652f576562417373656d626c792f776173692d746573747375697465&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/WebAssembly/wasi-testsuite\" title=\"GitHub - WebAssembly/wasi-testsuite: WASI Testsuite\">GitHub - WebAssembly/wasi-testsuite: WASI Testsuite</a></div><div class=\"message_embed_description\">WASI Testsuite. Contribute to WebAssembly/wasi-testsuite development by creating an account on GitHub.</div></div></div>",
        "id": 534430075,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755158970
    },
    {
        "content": "<p>So, where I'm at:</p>\n<ul>\n<li>Checked out wasi-testsuite</li>\n<li>Ran the test harness; \"success\" but only because there are only test case source files and not the compiled artifacts, and I don't want to use prebuilt binaries because I want to precisely know the source that they correspond to</li>\n<li>Built a fresh wasmtime</li>\n<li>Built a fresh wasi-sdk</li>\n<li>Regenerated the rust and C test cases, using the newly built toolchains</li>\n<li>Ran the test harness; there are failures!</li>\n</ul>\n<p>Now, these are wasip1 tests, and there's no real sense in putting effort into them, but I wonder if there isn't something to be done here; like, <a href=\"https://github.com/WebAssembly/wasi-testsuite/blob/main/tests/c/testsuite/fopen-with-no-access.c\">fopen-with-no-access</a> asserts that <code>errno</code> is <code>ENOTCAPABLE</code>, which I gather is a very wasmtime-of-a-particular-epoch thing, and that <code>ENOTCAPABLE</code> isn't really a thing any more.  Changing to <code>ENOENT</code> is more correct abstractly and allows the test to pass.  This isn't limited to the C test suite, there are similar errors in the rust test suite.</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/WebAssembly/wasi-testsuite/blob/main/tests/c/testsuite/fopen-with-no-access.c\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/1300fb483476ef3ebf77219f77973d063d1c0a60/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f333836383833336431396265386531303139633264623530393266333336366232643838373665656432346536386235303064376438383865366466373762652f576562417373656d626c792f776173692d746573747375697465&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/WebAssembly/wasi-testsuite/blob/main/tests/c/testsuite/fopen-with-no-access.c\" title=\"wasi-testsuite/tests/c/testsuite/fopen-with-no-access.c at main · WebAssembly/wasi-testsuite\">wasi-testsuite/tests/c/testsuite/fopen-with-no-access.c at main · WebAssembly/wasi-testsuite</a></div><div class=\"message_embed_description\">WASI Testsuite. Contribute to WebAssembly/wasi-testsuite development by creating an account on GitHub.</div></div></div>",
        "id": 534431228,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755159416
    },
    {
        "content": "<p>Going to tag in people that may be interested in the conversation; feel free to unset notifications: <span class=\"user-mention\" data-user-id=\"610987\">@Oscar Spencer</span> <span class=\"user-mention\" data-user-id=\"509936\">@Joel Dice</span> <span class=\"user-mention\" data-user-id=\"234973\">@Till Schneidereit</span> <span class=\"user-mention\" data-user-id=\"253994\">@Alex Crichton</span> <span class=\"user-mention\" data-user-id=\"253992\">@Pat Hickey</span> <span class=\"user-mention\" data-user-id=\"938242\">@Tim Chevalier</span></p>",
        "id": 534431798,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755159621
    },
    {
        "content": "<p>also <span class=\"user-mention\" data-user-id=\"253998\">@Luke Wagner</span></p>",
        "id": 534431972,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755159693
    },
    {
        "content": "<p>I think what I will do is, for the C tests, the source will remain the same for wasip3.  i will add additional accepted errnos, and the test will remain valid for previous versions of wasi.  then i will move the rust tests to a separate wasip1 subdir, because they all use the wasip1 toolchain.  then i will add a wasip3 subdir to the rusts tests and start porting simple tests there, before moving on to more interesting inter-component interactions.</p>",
        "id": 534433204,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755160168
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"396878\">@Andy Wingo</span> please tag me as well as you go.....</p>",
        "id": 534468232,
        "sender_full_name": "Ralph",
        "timestamp": 1755172893
    },
    {
        "content": "<p>ENOTCAPABLE is a wasi preview 1 thing, which had a capability system called \"rights\" inherited from cloudabi that we decided to get rid of, not a wasmtime of era thing, but no matter. but yes, a fundamental problem here is that the tests were written in the preview 1 era and not updated since.</p>",
        "id": 534500010,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1755183205
    },
    {
        "content": "<p>I agree with your approach to add more accepted errnos.</p>",
        "id": 534500137,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1755183246
    },
    {
        "content": "<p>in general I was never all that happy with how the wasmtime wasi testsuite tests for behaviors that were pretty dependent on the host operating system shook out. e.g. theres flags to tell the test harness that this host doesnt support hardlinks, this host doesnt support removing nonempty dirs, things like that... basically the \"is this windows or not\" bit</p>",
        "id": 534500448,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1755183331
    },
    {
        "content": "<p>so, after poking at it, i changed the <a href=\"http://build.sh\">build.sh</a> for the c tests to be a build.py, and then i compile the generic c tests for wasm32-wasip{1,2,3} in separate directories.  (wasip3 currently uses the wasip2 target triple.)  there is also something to bring in version-specific tests.  but to land that i am first going to update the wasi-sdk from 17 to 27, see if tests are green, move around the dirs so i can have version-specific tests, etc</p>",
        "id": 534500685,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755183395
    },
    {
        "content": "<p>i will stack some PRs.  i am part of the wasm org i think so i may have some permissions there but who is the wasi-testsuite maintainer?  i.e. who can lgtm?</p>",
        "id": 534500831,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755183443
    },
    {
        "content": "<p>also, who uses the daily test results?</p>",
        "id": 534501472,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755183607
    },
    {
        "content": "<p>but, in practice, filesystem behaviors on windows vs elsewhere is the least interesting problem in all of wasi - ive yet to find anyone who cares who isnt just trying to tell their boss every single tests passes, or fuzz for differences between runtimes, neither of which are very interesting things to care about. we made some severe and sometimes regrettable compromises as dan and I banged my way through creating and updating the test suite for wasmtimes needs, and this is a fine time for a reckoning of \"we really dont care about minutiae of file link behaviors\" when in practice several prominent runtimes that claim to \"support wasi\" have had filesystem sandbox escapes for many many years and have no real interest in fixing it properly</p>",
        "id": 534501497,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1755183614
    },
    {
        "content": "<p>wow :)</p>",
        "id": 534501737,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755183673
    },
    {
        "content": "<p>i think historically marcin was the person to take the wasmtime wasi test suite and move it upstream into the webassembly org repos. I am happy to be your reviewer for things</p>",
        "id": 534501827,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1755183697
    },
    {
        "content": "<p>daily test results? first im aware they exist tbh</p>",
        "id": 534501861,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1755183710
    },
    {
        "content": "<p>there is a github action or workflow or whatever to run tests nightly and commit the results to a git branch</p>",
        "id": 534501950,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755183734
    },
    {
        "content": "<p><a href=\"https://github.com/WebAssembly/wasi-testsuite/tree/prod/daily-test-results\">https://github.com/WebAssembly/wasi-testsuite/tree/prod/daily-test-results</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/WebAssembly/wasi-testsuite/tree/prod/daily-test-results\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/1300fb483476ef3ebf77219f77973d063d1c0a60/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f333836383833336431396265386531303139633264623530393266333336366232643838373665656432346536386235303064376438383865366466373762652f576562417373656d626c792f776173692d746573747375697465&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/WebAssembly/wasi-testsuite/tree/prod/daily-test-results\" title=\"GitHub - WebAssembly/wasi-testsuite at prod/daily-test-results\">GitHub - WebAssembly/wasi-testsuite at prod/daily-test-results</a></div><div class=\"message_embed_description\">WASI Testsuite. Contribute to WebAssembly/wasi-testsuite development by creating an account on GitHub.</div></div></div>",
        "id": 534501985,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755183747
    },
    {
        "content": "<p>huh. how about that</p>",
        "id": 534502059,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1755183771
    },
    {
        "content": "<p>i suppose lets pull up the git blame on the action and then ask them</p>",
        "id": 534502086,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1755183779
    },
    {
        "content": "<p>i'll cc them on the pr</p>",
        "id": 534502145,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755183794
    },
    {
        "content": "<p><a href=\"https://github.com/WebAssembly/wasi-testsuite/issues/109\">https://github.com/WebAssembly/wasi-testsuite/issues/109</a> for an overview issue</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/WebAssembly/wasi-testsuite/issues/109\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/408ba73873c6c7580ddfd30540e73867010b6e9b/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f373265396137333662643437393931393337333363643062313137363261643266363737613562376635623430346335393363633163336166616663316336652f576562417373656d626c792f776173692d7465737473756974652f6973737565732f313039&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/WebAssembly/wasi-testsuite/issues/109\" title=\"Update wasi-testsuite to support testing newer versions of WASI · Issue #109 · WebAssembly/wasi-testsuite\">Update wasi-testsuite to support testing newer versions of WASI · Issue #109 · WebAssembly/wasi-testsuite</a></div><div class=\"message_embed_description\">Hello wasi-testsuite hackers, I would like to update wasi-testsuite to support newer versions of WASI. The idea would be that the scope of wasi-testsuite should be to test the versions of WASI that...</div></div></div>",
        "id": 534506386,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755185082
    },
    {
        "content": "<p>a small but gnarly issue for <span class=\"user-mention\" data-user-id=\"253992\">@Pat Hickey</span> and <span class=\"user-mention\" data-user-id=\"253994\">@Alex Crichton</span>, <a href=\"https://github.com/WebAssembly/wasi-testsuite/issues/111\">https://github.com/WebAssembly/wasi-testsuite/issues/111</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/WebAssembly/wasi-testsuite/issues/111\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/14712613886f6e90772aa8de7d57cce8100d95c3/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f396564653662306133653135656662393862626139393930636533373330633931343339316561633335366263613437373039656130316661623466303830662f576562417373656d626c792f776173692d7465737473756974652f6973737565732f313131&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/WebAssembly/wasi-testsuite/issues/111\" title=\"Update pwrite expected behavior for files opened in append mode · Issue #111 · WebAssembly/wasi-testsuite\">Update pwrite expected behavior for files opened in append mode · Issue #111 · WebAssembly/wasi-testsuite</a></div><div class=\"message_embed_description\">In #95, a test was added that pwrite implements POSIX semantics (https://pubs.opengroup.org/onlinepubs/9699919799/functions/write.html). Note that Linux deviates from POSIX, ignoring the \"offset\" a...</div></div></div>",
        "id": 534621813,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755248707
    },
    {
        "content": "<p>that IS a sticky wicket</p>",
        "id": 534621990,
        "sender_full_name": "Ralph",
        "timestamp": 1755248787
    },
    {
        "content": "<p>the toolchain to create components is very funny.  one would hope that that component creation sediments down into the linker at some point</p>",
        "id": 534643923,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755260667
    },
    {
        "content": "<p>Like this? <a href=\"https://github.com/bytecodealliance/wasm-component-ld/\">https://github.com/bytecodealliance/wasm-component-ld/</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasm-component-ld/\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/be51f36ceb81ccfdbebe6cce62157d21da24bd2a/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f333365333463313061393761306636633432366361373362366266363538616333656336633962333339333635376537643332643662366230323366633366622f62797465636f6465616c6c69616e63652f7761736d2d636f6d706f6e656e742d6c64&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasm-component-ld/\" title=\"GitHub - bytecodealliance/wasm-component-ld: Command line linker for creating WebAssembly components\">GitHub - bytecodealliance/wasm-component-ld: Command line linker for creating WebAssembly components</a></div><div class=\"message_embed_description\">Command line linker for creating WebAssembly components - bytecodealliance/wasm-component-ld</div></div></div>",
        "id": 534644741,
        "sender_full_name": "Lann Martin",
        "timestamp": 1755261045
    },
    {
        "content": "<p>ooh neat, i did not know that one :)</p>",
        "id": 534644833,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755261077
    },
    {
        "content": "<p>/me comes from the web-targetting side of wasm, not much component model stuff there</p>",
        "id": 534644893,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755261106
    },
    {
        "content": "<p>Like this? <span aria-label=\"slight smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"slight smile\">:slight_smile:</span> <a href=\"https://github.com/bytecodealliance/jco/tree/main/packages/jco-transpile\">https://github.com/bytecodealliance/jco/tree/main/packages/jco-transpile</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/jco/tree/main/packages/jco-transpile\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/9a3096f3f2ad3f42e1f696d51d4fb460080d006c/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f613933666634643766646536623037313738343964366139663834383164636331383439666264623635663433353162656633363935663737366635646330332f62797465636f6465616c6c69616e63652f6a636f&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/jco/tree/main/packages/jco-transpile\" title=\"jco/packages/jco-transpile at main · bytecodealliance/jco\">jco/packages/jco-transpile at main · bytecodealliance/jco</a></div><div class=\"message_embed_description\">JavaScript toolchain for working with WebAssembly Components - bytecodealliance/jco</div></div></div>",
        "id": 534645037,
        "sender_full_name": "Lann Martin",
        "timestamp": 1755261181
    },
    {
        "content": "<p>i know of jco!  :)</p>",
        "id": 534645080,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755261196
    },
    {
        "content": "<p>I can't disagree that it's \"not much\" from the outside, but it sure feels like a lot from the inside!</p>",
        "id": 534645760,
        "sender_full_name": "Lann Martin",
        "timestamp": 1755261462
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"396878\">@Andy Wingo</span> gets to re-prove his chops..... :-P</p>",
        "id": 534646134,
        "sender_full_name": "Ralph",
        "timestamp": 1755261633
    },
    {
        "content": "<p>ahaha this is an opportunity to be a complete idiot for a while, i am also doing my first rust in anger</p>",
        "id": 534646248,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755261696
    },
    {
        "content": "<p>oh the Rust in anger part never leaves. &lt;insert Bruce Banner I'm always angry that's my secret here /&gt;</p>",
        "id": 534646425,
        "sender_full_name": "Ralph",
        "timestamp": 1755261779
    },
    {
        "content": "<p>enjoy your idiocy; we're super grateful for your help here.....</p>",
        "id": 534646495,
        "sender_full_name": "Ralph",
        "timestamp": 1755261811
    },
    {
        "content": "<p>i'm happy to be here with yall!</p>",
        "id": 534646646,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755261882
    },
    {
        "content": "<blockquote>\n<p><a href=\"https://github.com/bytecodealliance/wasm-component-ld/\">https://github.com/bytecodealliance/wasm-component-ld/</a></p>\n</blockquote>\n<p>Ah yeah this should be the default linker for <code>wasm32-wasip2</code> (and a hypothetical <code>wasm32-wasip3</code> future target). I'll note though that <code>wasm-component-ld</code> is a glorified wrapper around <code>wasm-ld</code> (the Real Wasm Linker) and <code>wit-component</code> which produces a component from a core module.</p>\n<p>The executable should be bundled with wasi-sdk and unused on <code>wasm32-wasip1</code> but used by default on <code>wasm32-wasip2</code></p>",
        "id": 534666103,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1755269477
    },
    {
        "content": "<p>ah i didn't realize wasm-component-ld was already in the sdk, neat.  i think i was looking on <a href=\"https://github.com/bytecodealliance/wit-bindgen?tab=readme-ov-file#guest-cc\">https://github.com/bytecodealliance/wit-bindgen?tab=readme-ov-file#guest-cc</a> which is probably out of date</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wit-bindgen?tab=readme-ov-file#guest-cc\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/50cd0505ad3a8575e79246c21a37b2737823449e/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f396633643162306531386134363863376234383163343734366363616634323461333366353336613261393134626430613836376139316365353664373734362f62797465636f6465616c6c69616e63652f7769742d62696e6467656e&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wit-bindgen?tab=readme-ov-file#guest-cc\" title=\"GitHub - bytecodealliance/wit-bindgen: A language binding generator for WebAssembly interface types\">GitHub - bytecodealliance/wit-bindgen: A language binding generator for WebAssembly interface types</a></div><div class=\"message_embed_description\">A language binding generator for WebAssembly interface types - bytecodealliance/wit-bindgen</div></div></div>",
        "id": 534666548,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755269700
    },
    {
        "content": "<p>Ah yes sorry those docs are out of date</p>",
        "id": 534666887,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1755269844
    },
    {
        "content": "<p>nowadays with <code>wasm32-wasip2</code> no further steps are needed after clang</p>",
        "id": 534666907,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1755269853
    },
    {
        "content": "<p>does one still need -mexec-model=reactor ?</p>",
        "id": 534666960,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755269876
    },
    {
        "content": "<p>to avoid an <code>int main</code> entrypoint, yes</p>",
        "id": 534667008,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1755269898
    },
    {
        "content": "<p>current status, working on getting some rust-based wasip3 components into wasi-testsuite.  needed to brush up on the rust components toolchain; close to done.  hopefully i can send some prs tomorrow.</p>",
        "id": 534962770,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755526993
    },
    {
        "content": "<p>actually, talking through this a bit -- so wasi-http depends on wasi-clocks.  i will probably first try to test wasi-clocks.  what is the deal with the clocks-timezone feature, will that be part of wasip3 ?</p>",
        "id": 534963568,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755527219
    },
    {
        "content": "<p>and then, for testing clocks: there is no guarantee that the clock under test corresponds to the real time.  (and in some ways it would be nice in a test if the clock could tick as fast as possible; i guess i will punt on that.)  anyway as regards wasmtime, will one monotonic-clock second be equal to a real second when i run tests?</p>",
        "id": 534964248,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755527418
    },
    {
        "content": "<p>and are there wasmtime tests for wasi-clocks?  i was looking but haven't seen them so far</p>",
        "id": 534964644,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755527545
    },
    {
        "content": "<p>wasmtime-wasi's host API allows you to override the default clock implementations for the wall clock and monotonic clock, which we test <a href=\"https://github.com/bytecodealliance/wasmtime/blob/1292237f809c20d7587bf6471e51fd5edf913ca9/crates/wasi/tests/all/p2/api.rs#L45-L89\">here</a> and <a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/crates/test-programs/src/bin/api_time.rs\">here</a>.  There's also a very simple test for the default implementations <a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/crates/test-programs/src/bin/cli_default_clocks.rs\">here</a>, but it doesn't assert anything very interesting at the moment.</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/blob/1292237f809c20d7587bf6471e51fd5edf913ca9/crates/wasi/tests/all/p2/api.rs#L45-L89\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/a28726a497f8f3b35bc5ff403b06cbbc12a90445/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f363637366633386538643738363064646465636166346638353562356361363338386336316265336231316134656366316135643630663535666138373862372f62797465636f6465616c6c69616e63652f7761736d74696d65&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/blob/1292237f809c20d7587bf6471e51fd5edf913ca9/crates/wasi/tests/all/p2/api.rs#L45-L89\" title=\"wasmtime/crates/wasi/tests/all/p2/api.rs at 1292237f809c20d7587bf6471e51fd5edf913ca9 · bytecodealliance/wasmtime\">wasmtime/crates/wasi/tests/all/p2/api.rs at 1292237f809c20d7587bf6471e51fd5edf913ca9 · bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">A lightweight WebAssembly runtime that is fast, secure, and standards-compliant - bytecodealliance/wasmtime</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/blob/main/crates/test-programs/src/bin/api_time.rs\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/a28726a497f8f3b35bc5ff403b06cbbc12a90445/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f363637366633386538643738363064646465636166346638353562356361363338386336316265336231316134656366316135643630663535666138373862372f62797465636f6465616c6c69616e63652f7761736d74696d65&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/crates/test-programs/src/bin/api_time.rs\" title=\"wasmtime/crates/test-programs/src/bin/api_time.rs at main · bytecodealliance/wasmtime\">wasmtime/crates/test-programs/src/bin/api_time.rs at main · bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">A lightweight WebAssembly runtime that is fast, secure, and standards-compliant - bytecodealliance/wasmtime</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/blob/main/crates/test-programs/src/bin/cli_default_clocks.rs\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/a28726a497f8f3b35bc5ff403b06cbbc12a90445/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f363637366633386538643738363064646465636166346638353562356361363338386336316265336231316134656366316135643630663535666138373862372f62797465636f6465616c6c69616e63652f7761736d74696d65&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/crates/test-programs/src/bin/cli_default_clocks.rs\" title=\"wasmtime/crates/test-programs/src/bin/cli_default_clocks.rs at main · bytecodealliance/wasmtime\">wasmtime/crates/test-programs/src/bin/cli_default_clocks.rs at main · bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">A lightweight WebAssembly runtime that is fast, secure, and standards-compliant - bytecodealliance/wasmtime</div></div></div>",
        "id": 534966375,
        "sender_full_name": "Joel Dice",
        "timestamp": 1755528104
    },
    {
        "content": "<p>praise be, thank you!</p>",
        "id": 534966452,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755528129
    },
    {
        "content": "<p>Regarding the timezone feature: looks like it's still an <code>unstable</code> feature in 0.3.0: <a href=\"https://github.com/WebAssembly/wasi-clocks/blob/main/wit-0.3.0-draft/timezone.wit\">https://github.com/WebAssembly/wasi-clocks/blob/main/wit-0.3.0-draft/timezone.wit</a>.  It <em>could</em> be stabilized as part of 0.3.0 or even before that in a 0.2.x release, but I don't know if anyone's working on that.</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/WebAssembly/wasi-clocks/blob/main/wit-0.3.0-draft/timezone.wit\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/b6f0d4d736207bb2e4ef409fcac8e74430b40247/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f346666336162383865346164343634316164633136373537383361396533636131313138353033383962626238333961643730383264633637643937323162612f576562417373656d626c792f776173692d636c6f636b73&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/WebAssembly/wasi-clocks/blob/main/wit-0.3.0-draft/timezone.wit\" title=\"wasi-clocks/wit-0.3.0-draft/timezone.wit at main · WebAssembly/wasi-clocks\">wasi-clocks/wit-0.3.0-draft/timezone.wit at main · WebAssembly/wasi-clocks</a></div><div class=\"message_embed_description\">Clocks API for WASI. Contribute to WebAssembly/wasi-clocks development by creating an account on GitHub.</div></div></div>",
        "id": 534967104,
        "sender_full_name": "Joel Dice",
        "timestamp": 1755528339
    },
    {
        "content": "<p>In any case, I don't think we need to include it as part of the <code>wasi-http</code>-centric testing.</p>",
        "id": 534967297,
        "sender_full_name": "Joel Dice",
        "timestamp": 1755528405
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"396878\">Andy Wingo</span> <a href=\"#narrow/channel/219900-wasi/topic/wasi-testsuite.20update.20for.20wasip3/near/534963568\">said</a>:</p>\n<blockquote>\n<p>actually, talking through this a bit -- so wasi-http depends on wasi-clocks.  i will probably first try to test wasi-clocks.  what is the deal with the clocks-timezone feature, will that be part of wasip3 ?</p>\n</blockquote>\n<p>It is very likely that timezones will be stabilized by p3. Chatter here about steps needed before stabilization: <a href=\"https://github.com/WebAssembly/wasi-clocks/pull/79\">https://github.com/WebAssembly/wasi-clocks/pull/79</a> <span class=\"user-mention\" data-user-id=\"555446\">@Colin D Murphy</span> is working on updating impls and tests</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/WebAssembly/wasi-clocks/pull/79\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/b9f4fbb958fd1711b936cbdf5fea75faa317dd26/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f613231356262343838343933633162386136643765353735386565316461333733326330636534333934393639633630626261386136306431633236646631382f576562417373656d626c792f776173692d636c6f636b732f70756c6c2f3739&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/WebAssembly/wasi-clocks/pull/79\" title=\"Avoid nonstandard use of names for types in wit-0.3.0-draft by bakkot · Pull Request #79 · WebAssembly/wasi-clocks\">Avoid nonstandard use of names for types in wit-0.3.0-draft by bakkot · Pull Request #79 · WebAssembly/wasi-clocks</a></div><div class=\"message_embed_description\">This is the renaming part of #71 by @ptomato applied to the new wit-0.3.0-draft directory. (Edit: as well as some other changes prompted by discussion below.)\nAs discussed in #69 (comment), the use...</div></div></div>",
        "id": 535013092,
        "sender_full_name": "Bailey Hayes",
        "timestamp": 1755546860
    },
    {
        "content": "<p>thanks <span class=\"user-mention\" data-user-id=\"555446\">@Colin D Murphy</span> !!!</p>",
        "id": 535063972,
        "sender_full_name": "Ralph",
        "timestamp": 1755585819
    },
    {
        "content": "<p>i have stupid questions</p>",
        "id": 535121370,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755607753
    },
    {
        "content": "<ol>\n<li>what is the benefit of allowing cargo to build component-using code for the native target (not wasm32-wasip2)?  it's obvious when it happens, i think anyway, but it's a weird outcome</li>\n</ol>",
        "id": 535121446,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755607776
    },
    {
        "content": "<ol start=\"2\">\n<li>is it at all sensible to want to avoid cargo-component ?  with wit-bindgen's inline WIT facility, i don't need to pre-build bindings, and i can have the WIT right next to the code i am testing.  but perhaps cargo-component does some unavoidable wasm-tools magic</li>\n</ol>",
        "id": 535121933,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755607913
    },
    {
        "content": "<ol start=\"3\">\n<li>i realize this is the topic of the channel and project but what is the story for \"cargo test\" of wasm components written in rust?  i suppose specifically for integration tests.  i don't see anything in cargo to let you \"wrap\" binaries in some kind of runner script; it is probably there but i just haven't found it yet</li>\n</ol>",
        "id": 535124712,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755608697
    },
    {
        "content": "<p>regarding (2), it would seem that building cdylibs with --target=wasm32-wasip2 makes components just fine, so no need for cargo-component.</p>",
        "id": 535126247,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755609203
    },
    {
        "content": "<ol start=\"4\">\n<li>how should wasi-testsuite import wasi packages, e.g. wasi:clocks?  git submodule?  or does wit-bindgen have an appropriate search path that for some reason i haven't populated yet</li>\n</ol>",
        "id": 535126523,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755609284
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"396878\">@Andy Wingo</span> you can definitely get by without <code>cargo component</code>, yes. Either by just using the p2 target, or even by targeting p1 and then using a combo of <code>wasm-tools component embed</code> and <code>wasm-tools component new</code></p>",
        "id": 535126622,
        "sender_full_name": "Till Schneidereit",
        "timestamp": 1755609318
    },
    {
        "content": "<p>oh, and regarding (1), there are tools that don't yet support components. An example we're heavily reliant on with StarlingMonkey is <a href=\"https://github.com/bytecodealliance/wizer\">wizer</a>. For those cases, targeting p1, running the additional tools, then componentizing is the way to go</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wizer\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/6a0bf1876368842f202fe86bce70bb8af9024c57/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f656534343962353863643038396532633935666533383037313734653937636234303766373435636464633364663466393734636163383431343366386234662f62797465636f6465616c6c69616e63652f77697a6572&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wizer\" title=\"GitHub - bytecodealliance/wizer: The WebAssembly Pre-Initializer\">GitHub - bytecodealliance/wizer: The WebAssembly Pre-Initializer</a></div><div class=\"message_embed_description\">The WebAssembly Pre-Initializer. Contribute to bytecodealliance/wizer development by creating an account on GitHub.</div></div></div>",
        "id": 535126952,
        "sender_full_name": "Till Schneidereit",
        "timestamp": 1755609417
    },
    {
        "content": "<p>understood regarding -wasip1 but my comment was more about, say, x86_64-linux; weird that wit-bindgen's macros work on that target :)</p>",
        "id": 535128213,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755609800
    },
    {
        "content": "<p>I think at least one of the reasons is being able to run e.g. <code>cargo check</code> or <code>cargo clippy</code> without having to specify a target.</p>",
        "id": 535128480,
        "sender_full_name": "Joel Dice",
        "timestamp": 1755609884
    },
    {
        "content": "<p>ah, I see! You're right that currently there are few uses for this. But not none! <span class=\"user-mention\" data-user-id=\"590366\">@Christof Petig</span> has done a lot of work on making WIT work as an IDL for native code, for example</p>",
        "id": 535128538,
        "sender_full_name": "Till Schneidereit",
        "timestamp": 1755609903
    },
    {
        "content": "<p>regarding (3), I think this should work?</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code><span class=\"nv\">CARGO_TARGET_WASM32_WASIP2_RUNNER</span><span class=\"o\">=</span><span class=\"s2\">\"wasmtime [cli args as needed]\"</span><span class=\"w\"> </span>cargo<span class=\"w\"> </span><span class=\"nb\">test</span>\n</code></pre></div>\n<p>I haven't tested this in a while myself though, so needs some experimentation for sure</p>",
        "id": 535128759,
        "sender_full_name": "Till Schneidereit",
        "timestamp": 1755609980
    },
    {
        "content": "<p>ooh neat</p>",
        "id": 535128836,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755610006
    },
    {
        "content": "<p>You can also put this ^ in <code>.cargo/config.toml</code></p>",
        "id": 535128881,
        "sender_full_name": "Lann Martin",
        "timestamp": 1755610019
    },
    {
        "content": "<p>Here's one from something I wrote recently (freshly tested!)</p>\n<div class=\"codehilite\" data-code-language=\"TOML\"><pre><span></span><code><span class=\"k\">[build]</span>\n<span class=\"n\">target</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"wasm32-wasip2\"</span>\n<span class=\"k\">[target.wasm32-wasip2]</span>\n<span class=\"n\">runner</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"wasmtime run -D address-map\"</span>\n<span class=\"k\">[env]</span>\n<span class=\"n\">WASMTIME_BACKTRACE_DETAILS</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"s2\">\"1\"</span>\n</code></pre></div>",
        "id": 535129050,
        "sender_full_name": "Lann Martin",
        "timestamp": 1755610072
    },
    {
        "content": "<p>thanks!</p>",
        "id": 535129159,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755610107
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"396878\">Andy Wingo</span> <a href=\"#narrow/channel/219900-wasi/topic/wasi-testsuite.20update.20for.20wasip3/near/535126523\">said</a>:</p>\n<blockquote>\n<ol start=\"4\">\n<li>how should wasi-testsuite import wasi packages, e.g. wasi:clocks?  git submodule?  or does wit-bindgen have an appropriate search path that for some reason i haven't populated yet</li>\n</ol>\n</blockquote>\n<p>ok what about this one :)</p>",
        "id": 535130119,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755610388
    },
    {
        "content": "<p>what are you all doing in your wasip3-using packages</p>",
        "id": 535130192,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755610411
    },
    {
        "content": "<p>I think <a href=\"https://crates.io/crates/wkg\">wkg</a> is the way to go for that?</p>",
        "id": 535130437,
        "sender_full_name": "Till Schneidereit",
        "timestamp": 1755610483
    },
    {
        "content": "<p>ahahaha i keep learning about new parts of the toolchain</p>",
        "id": 535130559,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755610507
    },
    {
        "content": "<p>thanks!!</p>",
        "id": 535130571,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755610510
    },
    {
        "content": "<p>which is obviously entirely on you, and not due to any properties of this ecosystem <span aria-label=\"halo\" class=\"emoji emoji-1f607\" role=\"img\" title=\"halo\">:halo:</span></p>",
        "id": 535130825,
        "sender_full_name": "Till Schneidereit",
        "timestamp": 1755610588
    },
    {
        "content": "<p>wellllllll a little of column a, a little of column b ;)</p>",
        "id": 535130885,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755610605
    },
    {
        "content": "<p>okay, I'll accept that: it's probably 10:90 instead of 0:100</p>",
        "id": 535131014,
        "sender_full_name": "Till Schneidereit",
        "timestamp": 1755610643
    },
    {
        "content": "<p>The <code>wkg</code> UX is somewhat under-baked; if you want a full dependency tree you'll need a particular incantation combined with <code>wasm-tools</code></p>",
        "id": 535131088,
        "sender_full_name": "Lann Martin",
        "timestamp": 1755610669
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"480579\">@Lann Martin</span> do you think we can share that incantation, or is that still a well guarded trade secret?</p>",
        "id": 535131677,
        "sender_full_name": "Till Schneidereit",
        "timestamp": 1755610840
    },
    {
        "content": "<p>Working on it <span aria-label=\"slight smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"slight smile\">:slight_smile:</span></p>",
        "id": 535132134,
        "sender_full_name": "Lann Martin",
        "timestamp": 1755610973
    },
    {
        "content": "<div class=\"codehilite\" data-code-language=\"Bash Session\"><pre><span></span><code><span class=\"gp\"># </span>This<span class=\"w\"> </span>will<span class=\"w\"> </span>fetch<span class=\"w\"> </span>the<span class=\"w\"> </span>latest<span class=\"w\"> </span>version<span class=\"w\"> </span>w/o<span class=\"w\"> </span>deps<span class=\"w\"> </span>by<span class=\"w\"> </span>default\n<span class=\"gp\">$ </span>wkg<span class=\"w\"> </span>get<span class=\"w\"> </span>wasi:http\n<span class=\"go\">No version specified; fetching version list...</span>\n<span class=\"go\">Getting wasi:http@0.3.0-rc-2025-08-15...</span>\n<span class=\"go\">Wrote './wasi_http@0.3.0-rc-2025-08-15.wit'</span>\n\n<span class=\"gp\"># </span>Deps<span class=\"w\"> </span>are<span class=\"w\"> </span>included<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>the<span class=\"w\"> </span>binary<span class=\"w\"> </span>encoding...\n<span class=\"gp\">$ </span>wkg<span class=\"w\"> </span>get<span class=\"w\"> </span>wasi:http@0.3.0-rc-2025-08-15<span class=\"w\"> </span>-o<span class=\"w\"> </span>wasi-http.wasm\n<span class=\"go\">Getting wasi:http@0.3.0-rc-2025-08-15...</span>\n<span class=\"go\">Wrote 'wasi-http.wasm'</span>\n\n<span class=\"gp\"># </span>...which<span class=\"w\"> </span>can<span class=\"w\"> </span>be<span class=\"w\"> </span>turned<span class=\"w\"> </span>into<span class=\"w\"> </span>a<span class=\"w\"> </span><span class=\"nb\">source</span><span class=\"w\"> </span>tree<span class=\"w\"> </span>with<span class=\"w\"> </span>wasm-tools\n<span class=\"gp\">$ </span>wasm-tools<span class=\"w\"> </span>component<span class=\"w\"> </span>wit<span class=\"w\"> </span>wasi-http.wasm<span class=\"w\"> </span>--out-dir<span class=\"w\"> </span>wit\n<span class=\"go\">Writing: wit/deps/clocks.wit</span>\n<span class=\"go\">Writing: wit/deps/random.wit</span>\n<span class=\"go\">Writing: wit/deps/cli.wit</span>\n<span class=\"go\">Writing: wit/http.wit</span>\n</code></pre></div>",
        "id": 535133562,
        "sender_full_name": "Lann Martin",
        "timestamp": 1755611316
    },
    {
        "content": "<p>(<code>wkg get</code> should learn <code>--out-dir</code>)</p>",
        "id": 535133801,
        "sender_full_name": "Lann Martin",
        "timestamp": 1755611377
    },
    {
        "content": "<p>am a little surprised there isn't a <code>stream&lt;u8&gt;</code> to <code>future&lt;wasi:http/headers&gt;</code> method somewhere in wasi:http</p>",
        "id": 535135895,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755611927
    },
    {
        "content": "<p>one less thing to test :)</p>",
        "id": 535135920,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755611932
    },
    {
        "content": "<p>Could you say more about what that method would do? <code>wasi:http</code> tries to abstract over protocol details</p>",
        "id": 535136225,
        "sender_full_name": "Lann Martin",
        "timestamp": 1755612010
    },
    {
        "content": "<p>afaics something outside <code>wasi:http</code> has to turn the byte stream into http headers.  i.e. you provide the headers as structured data when making a request or response</p>",
        "id": 535136657,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755612128
    },
    {
        "content": "<p>so you couldn't hook a wasi:http/handler right up to a socket, you need to write a little parser.  fair enough, and it matches how some embedders will want to use it</p>",
        "id": 535136781,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755612160
    },
    {
        "content": "<p>could be i'm holding the thing wrong tho</p>",
        "id": 535136824,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755612171
    },
    {
        "content": "<p>Yeah, correct. In practice so far its mostly \"whatever <code>hyper</code> does\".</p>",
        "id": 535136857,
        "sender_full_name": "Lann Martin",
        "timestamp": 1755612181
    },
    {
        "content": "<p>The rough idea has been that <code>wasi:http</code> only deals with things that are in the <a href=\"https://httpwg.org/http-core/draft-ietf-httpbis-semantics-latest.html\">HTTP Semantics spec</a>, not anything specific to HTTP/1.1,2,3+</p>",
        "id": 535137290,
        "sender_full_name": "Lann Martin",
        "timestamp": 1755612289
    },
    {
        "content": "<p>ah yes, makes sense.  i admit i have only ever implemented http/1.1</p>",
        "id": 535137506,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755612349
    },
    {
        "content": "<p>In that case I'd highly recommend staring at this specific section: <a href=\"http://httpwg.org/http-core/draft-ietf-httpbis-semantics-latest.html#field.host\">httpwg.org/http-core/draft-ietf-httpbis-semantics-latest.html#field.host</a></p>",
        "id": 535137704,
        "sender_full_name": "Lann Martin",
        "timestamp": 1755612399
    },
    {
        "content": "<p>so, i am poking in a little playground repository.  i have inline wit in my src/lib.rs:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">wit_bindgen</span><span class=\"p\">::</span><span class=\"n\">generate</span><span class=\"o\">!</span><span class=\"p\">({</span><span class=\"n\">inline</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">r</span><span class=\"s\">\"</span>\n<span class=\"s\">  package test:playground;</span>\n\n<span class=\"s\">  world the-world {</span>\n<span class=\"s\">            import wasi:http/handler;</span>\n<span class=\"s\">            //...</span>\n<span class=\"s\">  }\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">path</span><span class=\"o\">=</span><span class=\"s\">\"wit\"</span><span class=\"p\">});</span>\n\n<span class=\"c1\">// ...</span>\n</code></pre></div>\n<p>I have imported wasi:http into <code>wit/http.wit</code> as above:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">Writing</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">clocks</span><span class=\"p\">.</span><span class=\"n\">wit</span>\n<span class=\"n\">Writing</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">random</span><span class=\"p\">.</span><span class=\"n\">wit</span>\n<span class=\"n\">Writing</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">cli</span><span class=\"p\">.</span><span class=\"n\">wit</span>\n<span class=\"n\">Writing</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">wit</span><span class=\"o\">/</span><span class=\"n\">http</span><span class=\"p\">.</span><span class=\"n\">wit</span>\n</code></pre></div>\n<p>Firstly it would seem that it's necessary to set <code>path</code> in the bindgen options, otherwise cargo / wit-bindgen don't search anywhere, despite the wit-bindgen docs saying there is a default path.</p>\n<p>Secondly, the import fails in a funny way:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">error</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">package</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">wasi</span><span class=\"p\">:</span><span class=\"nc\">http</span><span class=\"o\">'</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">found</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"n\">known</span><span class=\"w\"> </span><span class=\"n\">packages</span><span class=\"p\">:</span>\n<span class=\"w\">           </span><span class=\"nc\">wasi</span><span class=\"p\">:</span><span class=\"nc\">cli</span><span class=\"o\">@</span><span class=\"mf\">0.3.0</span><span class=\"o\">-</span><span class=\"n\">rc</span><span class=\"o\">-</span><span class=\"mi\">2025</span><span class=\"o\">-</span><span class=\"mi\">08</span><span class=\"o\">-</span><span class=\"mi\">15</span>\n<span class=\"w\">           </span><span class=\"n\">wasi</span><span class=\"p\">:</span><span class=\"nc\">clocks</span><span class=\"o\">@</span><span class=\"mf\">0.3.0</span><span class=\"o\">-</span><span class=\"n\">rc</span><span class=\"o\">-</span><span class=\"mi\">2025</span><span class=\"o\">-</span><span class=\"mi\">08</span><span class=\"o\">-</span><span class=\"mi\">15</span>\n<span class=\"w\">           </span><span class=\"n\">wasi</span><span class=\"p\">:</span><span class=\"nc\">random</span><span class=\"o\">@</span><span class=\"mf\">0.3.0</span><span class=\"o\">-</span><span class=\"n\">rc</span><span class=\"o\">-</span><span class=\"mi\">2025</span><span class=\"o\">-</span><span class=\"mi\">08</span><span class=\"o\">-</span><span class=\"mi\">15</span>\n<span class=\"w\">           </span><span class=\"n\">wasi</span><span class=\"p\">:</span><span class=\"nc\">http</span><span class=\"o\">@</span><span class=\"mf\">0.3.0</span><span class=\"o\">-</span><span class=\"n\">rc</span><span class=\"o\">-</span><span class=\"mi\">2025</span><span class=\"o\">-</span><span class=\"mi\">08</span><span class=\"o\">-</span><span class=\"mi\">15</span>\n<span class=\"w\">           </span><span class=\"n\">test</span><span class=\"p\">:</span><span class=\"nc\">playground</span>\n\n<span class=\"w\">            </span><span class=\"o\">-</span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">macro</span><span class=\"o\">-</span><span class=\"n\">input</span><span class=\"p\">:</span><span class=\"mi\">5</span><span class=\"p\">:</span><span class=\"mi\">20</span>\n<span class=\"w\">             </span><span class=\"o\">|</span>\n<span class=\"w\">           </span><span class=\"mi\">5</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">             </span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"p\">:</span><span class=\"nc\">http</span><span class=\"o\">/</span><span class=\"n\">handler</span><span class=\"p\">;</span>\n<span class=\"w\">             </span><span class=\"o\">|</span><span class=\"w\">                    </span><span class=\"o\">^--------</span>\n<span class=\"w\">  </span><span class=\"o\">-</span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">src</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"p\">.</span><span class=\"n\">rs</span><span class=\"p\">:</span><span class=\"mi\">3</span><span class=\"p\">:</span><span class=\"mi\">1</span>\n</code></pre></div>\n<p>I.e. you can see that it found wasi:http@0.3.0-rc-2025-08-15, and doesn't think that fulfills <code>wasi:http</code>.  is wit-bindgen helpfully preventing me from using a prerelease wasip3 ?</p>",
        "id": 535141388,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755613443
    },
    {
        "content": "<p>I think you need the version in the <code>import</code></p>",
        "id": 535142242,
        "sender_full_name": "Lann Martin",
        "timestamp": 1755613685
    },
    {
        "content": "<p>yeah, <code>import wasi:http/handler@0.3.0-rc...;</code></p>",
        "id": 535142331,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1755613711
    },
    {
        "content": "<blockquote>\n<p>despite the wit-bindgen docs saying there is a default path</p>\n</blockquote>\n<p>This confuses me, your syntax of <code>path = \"wit\"</code> should have failed since it should be <code>path: \"wit\"</code>, but also <code>\"wit\"</code> should be the default search location (relative to the crate root)</p>",
        "id": 535142467,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1755613757
    },
    {
        "content": "<p>ah, i had put the version after the handler, and didn't parse the error message correctly</p>",
        "id": 535142634,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755613805
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"253994\">Alex Crichton</span> <a href=\"#narrow/channel/219900-wasi/topic/wasi-testsuite.20update.20for.20wasip3/near/535142467\">said</a>:</p>\n<blockquote>\n<blockquote>\n<p>despite the wit-bindgen docs saying there is a default path</p>\n</blockquote>\n<p>This confuses me, your syntax of <code>path = \"wit\"</code> should have failed since it should be <code>path: \"wit\"</code>, but also <code>\"wit\"</code> should be the default search location (relative to the crate root)</p>\n</blockquote>\n<p>sorry, that was a retype bug: i had <code>path: \"wit\"</code>.  but without <code>path: \"wit\"</code>, at least with this inline wit, cargo does not look in the <code>wit/</code> directory</p>",
        "id": 535142918,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755613885
    },
    {
        "content": "<p>do you have a repo/branch I could repro on?</p>",
        "id": 535143009,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1755613910
    },
    {
        "content": "<p>(bug hunting adventure for me)</p>",
        "id": 535143059,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1755613922
    },
    {
        "content": "<p>sure i can throw it up somewhere</p>",
        "id": 535143133,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755613942
    },
    {
        "content": "<p><a href=\"https://wingolog.org/priv/playground.tar.gz\">https://wingolog.org/priv/playground.tar.gz</a>, extracts to playground/, repro with <code>cargo build --target=wasm32-wasip2</code></p>",
        "id": 535143773,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755614127
    },
    {
        "content": "<p>aha ok <code>inline</code> disables the default <code>path</code> as otherwise if you used <code>inline</code> you'd have to ensure a <code>wit</code> directory exists -- either should update the documentation or keep the default <code>wit</code> path but don't require it to exist when <code>inline</code> is specified and <code>path</code> isn't specified</p>",
        "id": 535144513,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1755614332
    },
    {
        "content": "<p>to be fair, who knows if <code>inline</code> will get much real use; but it seems nice for testing</p>",
        "id": 535144785,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755614409
    },
    {
        "content": "<p>that's the reason for existence though, it's used all the time in testing wit-bindgen itself and a few places throughout wasmtime too</p>",
        "id": 535144872,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1755614434
    },
    {
        "content": "<p>basically it's too-damn-useful heh</p>",
        "id": 535144903,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1755614443
    },
    {
        "content": "<p><a href=\"https://github.com/bytecodealliance/wit-bindgen/pull/1356\">https://github.com/bytecodealliance/wit-bindgen/pull/1356</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wit-bindgen/pull/1356\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/0eab2b97af468ede5b4cedabf72a151598c1018e/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f363330323364353333626436653931363036643336303066333034343964313334383932666533623733653064306665383036613266656664363636643833302f62797465636f6465616c6c69616e63652f7769742d62696e6467656e2f70756c6c2f31333536&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wit-bindgen/pull/1356\" title=\"Parse `wit` folder in `generate!` with `inline` by alexcrichton · Pull Request #1356 · bytecodealliance/wit-bindgen\">Parse `wit` folder in `generate!` with `inline` by alexcrichton · Pull Request #1356 · bytecodealliance/wit-bindgen</a></div><div class=\"message_embed_description\">This commit updates handling of the inline attribute in the generate! macro of the Rust bindings generator. Previously if inline was specified it would by default lookup nothing on the filesystem u...</div></div></div>",
        "id": 535147495,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1755615214
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"234973\">Till Schneidereit</span> <a href=\"#narrow/channel/219900-wasi/topic/wasi-testsuite.20update.20for.20wasip3/near/535128538\">said</a>:</p>\n<blockquote>\n<p>ah, I see! You're right that currently there are few uses for this. But not none! <span class=\"user-mention silent\" data-user-id=\"590366\">Christof Petig</span> has done a lot of work on making WIT work as an IDL for native code, for example</p>\n</blockquote>\n<p>FWIW, there is experimental work at my megacorp doing something like this as well....</p>",
        "id": 535147747,
        "sender_full_name": "Ralph",
        "timestamp": 1755615287
    },
    {
        "content": "<p><a class=\"message-link\" href=\"/#narrow/channel/219900-wasi/topic/wasi-testsuite.20update.20for.20wasip3/near/535135895\">#wasi &gt; wasi-testsuite update for wasip3 @ 💬</a> re turning raw streams into wasi-http, our hope is that for users who want to do that, there can be a component that provides that as library code. no need for the embedder to support it</p>",
        "id": 535170311,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1755622669
    },
    {
        "content": "<p>the component could be implemented internally with hyper, or with whatever other http implementation is suitable</p>",
        "id": 535170363,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1755622695
    },
    {
        "content": "<p>It would be great to have a stable reference implementation for conformance testing</p>",
        "id": 535170827,
        "sender_full_name": "Lann Martin",
        "timestamp": 1755622888
    },
    {
        "content": "<p>so, we are testing wasi implementations more than the component model itself, so i think many tests can be made just with a single component implementing wasi:cli/run.  and i guess i should be able to make <code>run()</code> async</p>",
        "id": 535260492,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755677417
    },
    {
        "content": "<p>just as an ongoing log, a minimal test looks like this:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">extern</span><span class=\"w\"> </span><span class=\"k\">crate</span><span class=\"w\"> </span><span class=\"n\">wit_bindgen</span><span class=\"p\">;</span>\n\n<span class=\"n\">wit_bindgen</span><span class=\"p\">::</span><span class=\"n\">generate</span><span class=\"o\">!</span><span class=\"p\">({</span><span class=\"n\">inline</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">r</span><span class=\"s\">\"</span>\n<span class=\"s\">  package test:playground;</span>\n\n<span class=\"s\">  world the-world {</span>\n<span class=\"s\">            include wasi:cli/command@0.3.0-rc-2025-08-15;</span>\n<span class=\"s\">  }</span>\n<span class=\"s\">\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">path</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s\">\"wit\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">generate_all</span><span class=\"p\">});</span>\n\n<span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"p\">::</span><span class=\"n\">clocks</span><span class=\"p\">::</span><span class=\"n\">monotonic_clock</span><span class=\"p\">;</span>\n\n<span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">Test</span><span class=\"p\">;</span>\n\n<span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">exports</span><span class=\"p\">::</span><span class=\"n\">wasi</span><span class=\"p\">::</span><span class=\"n\">cli</span><span class=\"p\">::</span><span class=\"n\">run</span><span class=\"p\">::</span><span class=\"n\">Guest</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">Test</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">run</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"p\">()</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">start</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">monotonic_clock</span><span class=\"p\">::</span><span class=\"n\">now</span><span class=\"p\">();</span>\n<span class=\"w\">        </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">end</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">monotonic_clock</span><span class=\"p\">::</span><span class=\"n\">now</span><span class=\"p\">();</span>\n<span class=\"w\">        </span><span class=\"fm\">assert!</span><span class=\"p\">(</span><span class=\"n\">end</span><span class=\"w\"> </span><span class=\"o\">&lt;=</span><span class=\"w\"> </span><span class=\"n\">start</span><span class=\"p\">);</span>\n<span class=\"w\">        </span><span class=\"nb\">Ok</span><span class=\"p\">(())</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n\n<span class=\"n\">export</span><span class=\"o\">!</span><span class=\"p\">(</span><span class=\"n\">Test</span><span class=\"p\">);</span>\n</code></pre></div>",
        "id": 535260730,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755677491
    },
    {
        "content": "<p>then you have to compile wasmtime via <code>cargo build --features component-model-async</code>, otherwise the wit linker won't find wasip3 interfaces; and then you have to run wasmtime with <code>-Sp3=y</code> to enable wasip3 at run-time</p>",
        "id": 535260959,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755677569
    },
    {
        "content": "<p>this test fails as written, i had reversed end and start, just to see what would happen</p>",
        "id": 535261082,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755677609
    },
    {
        "content": "<p>now that i can build components and run them, i will start adding some to wasi-testsuite</p>",
        "id": 535261157,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755677635
    },
    {
        "content": "<p>also, a note, i am not sure how to use wkg to import a number of different packages; if you import <code>wasi:http</code>as in <a class=\"message-link\" href=\"/#narrow/channel/219900-wasi/topic/wasi-testsuite.20update.20for.20wasip3/near/535133562\">#wasi &gt; wasi-testsuite update for wasip3 @ 💬</a>, it will residualize some parts of <code>wasi:clocks</code> in <code>wit/deps/clocks.wit</code>; then if you import <code>wasi:cli</code>, it will residualize a different set of <code>wasi:clocks</code> into <code>wit/deps/clocks.wit</code></p>",
        "id": 535262571,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755678101
    },
    {
        "content": "<p>in this current case i solved the issue by just importing wasi:cli, but that won't work once i start testing wasi:http</p>",
        "id": 535262751,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755678164
    },
    {
        "content": "<p>i suppose some of this weirdness is that i compiled a cdylib component; perhaps there are some ergonomic niceties for compiling implementations of <code>wasi:cli/run</code> if you make binary targets instead of libraries</p>",
        "id": 535263430,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755678415
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"396878\">Andy Wingo</span> <a href=\"#narrow/channel/219900-wasi/topic/wasi-testsuite.20update.20for.20wasip3/near/535262571\">said</a>:</p>\n<blockquote>\n<p>also, a note, i am not sure how to use wkg to import a number of different packages; if you import <code>wasi:http</code>as in <a class=\"message-link\" href=\"/#narrow/channel/219900-wasi/topic/wasi-testsuite.20update.20for.20wasip3/near/535133562\">#wasi &gt; wasi-testsuite update for wasip3 @ 💬</a>, it will residualize some parts of <code>wasi:clocks</code> in <code>wit/deps/clocks.wit</code>; then if you import <code>wasi:cli</code>, it will residualize a different set of <code>wasi:clocks</code> into <code>wit/deps/clocks.wit</code></p>\n</blockquote>\n<p>this is probably an issue to file on wkg....</p>",
        "id": 535267147,
        "sender_full_name": "Ralph",
        "timestamp": 1755679702
    },
    {
        "content": "<p>I've been using <code>wkg fetch</code> against a dummy package / world which seems to fetch all wit dependencies of the world to write to disk. Not sure how that compares to the <code>wkg get &lt;interface&gt; -o &lt;dummy&gt;.wasm</code> + <code>wasm-tools component wit &lt;dummy&gt;.wasm</code> workflow.</p>",
        "id": 535269230,
        "sender_full_name": "Milan (rajsite)",
        "timestamp": 1755680401
    },
    {
        "content": "<p>If you manage your world in a <code>wit/*.wit</code> file then <code>wkg wit fetch</code> will indeed fetch and write deps appropriately.</p>",
        "id": 535299952,
        "sender_full_name": "Lann Martin",
        "timestamp": 1755691899
    },
    {
        "content": "<p>tx milan &amp; lann.  for testing, where each test can define its own world inline, it would be nice to be able to fetch \"all of wasi:clocks, all of wasi:sockets, ...\" etc.  even, all of wasip3, or wasi 1.0, ...<br>\nas it is with a dummy package, it seems i need to include each world in wasi:clocks by name</p>",
        "id": 535315785,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755696957
    },
    {
        "content": "<p>You could have a wit file that imports the root interfaces you need just for the purposes of fetching dependencies. I _think_ <code>inline</code> would still pick up <code>wit/deps/</code> in that scenario but I can never remember the exact behaviors there</p>",
        "id": 535323508,
        "sender_full_name": "Lann Martin",
        "timestamp": 1755699177
    },
    {
        "content": "<p>it would seem that this is enough to get all of wasi:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">world</span><span class=\"w\"> </span><span class=\"n\">wasip3</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">include</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"p\">:</span><span class=\"nc\">cli</span><span class=\"o\">/</span><span class=\"n\">command</span><span class=\"o\">@</span><span class=\"mf\">0.3.0</span><span class=\"o\">-</span><span class=\"n\">rc</span><span class=\"o\">-</span><span class=\"mi\">2025</span><span class=\"o\">-</span><span class=\"mi\">08</span><span class=\"o\">-</span><span class=\"mi\">15</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">include</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"p\">:</span><span class=\"nc\">clocks</span><span class=\"o\">/</span><span class=\"n\">imports</span><span class=\"o\">@</span><span class=\"mf\">0.3.0</span><span class=\"o\">-</span><span class=\"n\">rc</span><span class=\"o\">-</span><span class=\"mi\">2025</span><span class=\"o\">-</span><span class=\"mi\">08</span><span class=\"o\">-</span><span class=\"mi\">15</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">include</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"p\">:</span><span class=\"nc\">filesystem</span><span class=\"o\">/</span><span class=\"n\">imports</span><span class=\"o\">@</span><span class=\"mf\">0.3.0</span><span class=\"o\">-</span><span class=\"n\">rc</span><span class=\"o\">-</span><span class=\"mi\">2025</span><span class=\"o\">-</span><span class=\"mi\">08</span><span class=\"o\">-</span><span class=\"mi\">15</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">include</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"p\">:</span><span class=\"nc\">http</span><span class=\"o\">/</span><span class=\"n\">imports</span><span class=\"o\">@</span><span class=\"mf\">0.3.0</span><span class=\"o\">-</span><span class=\"n\">rc</span><span class=\"o\">-</span><span class=\"mi\">2025</span><span class=\"o\">-</span><span class=\"mi\">08</span><span class=\"o\">-</span><span class=\"mi\">15</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">include</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"p\">:</span><span class=\"nc\">http</span><span class=\"o\">/</span><span class=\"n\">proxy</span><span class=\"o\">@</span><span class=\"mf\">0.3.0</span><span class=\"o\">-</span><span class=\"n\">rc</span><span class=\"o\">-</span><span class=\"mi\">2025</span><span class=\"o\">-</span><span class=\"mi\">08</span><span class=\"o\">-</span><span class=\"mi\">15</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">include</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"p\">:</span><span class=\"nc\">random</span><span class=\"o\">/</span><span class=\"n\">imports</span><span class=\"o\">@</span><span class=\"mf\">0.3.0</span><span class=\"o\">-</span><span class=\"n\">rc</span><span class=\"o\">-</span><span class=\"mi\">2025</span><span class=\"o\">-</span><span class=\"mi\">08</span><span class=\"o\">-</span><span class=\"mi\">15</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">include</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"p\">:</span><span class=\"nc\">sockets</span><span class=\"o\">/</span><span class=\"n\">imports</span><span class=\"o\">@</span><span class=\"mf\">0.3.0</span><span class=\"o\">-</span><span class=\"n\">rc</span><span class=\"o\">-</span><span class=\"mi\">2025</span><span class=\"o\">-</span><span class=\"mi\">08</span><span class=\"o\">-</span><span class=\"mi\">15</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n</code></pre></div>",
        "id": 535324449,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755699436
    },
    {
        "content": "<p>can just include <code>http/proxy</code>, it pulls in <code>http/imports</code> (as <code>cli/command</code> imports <code>cli/imports</code>)</p>",
        "id": 535329122,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755700651
    },
    {
        "content": "<p>anyway, more toolchain weirdness:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">mkdir</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">test</span>\n<span class=\"n\">cd</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">test</span>\n<span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">init</span>\n<span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">add</span><span class=\"w\"> </span><span class=\"n\">wit</span><span class=\"o\">-</span><span class=\"n\">bindgen</span>\n</code></pre></div>\n<p>ok, make a dummy wit file and fetch the wits:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">mkdir</span><span class=\"w\"> </span><span class=\"n\">wit</span>\n<span class=\"n\">cat</span><span class=\"w\"> </span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">wasip3</span><span class=\"p\">.</span><span class=\"n\">wit</span><span class=\"w\"> </span><span class=\"o\">&lt;&lt;</span><span class=\"n\">EOF</span>\n<span class=\"n\">package</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"p\">:</span><span class=\"nc\">dummy</span><span class=\"p\">;</span>\n<span class=\"n\">world</span><span class=\"w\"> </span><span class=\"n\">wasip3</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"n\">include</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"p\">:</span><span class=\"nc\">cli</span><span class=\"o\">/</span><span class=\"n\">command</span><span class=\"o\">@</span><span class=\"mf\">0.3.0</span><span class=\"o\">-</span><span class=\"n\">rc</span><span class=\"o\">-</span><span class=\"mi\">2025</span><span class=\"o\">-</span><span class=\"mi\">08</span><span class=\"o\">-</span><span class=\"mi\">15</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">include</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"p\">:</span><span class=\"nc\">clocks</span><span class=\"o\">/</span><span class=\"n\">imports</span><span class=\"o\">@</span><span class=\"mf\">0.3.0</span><span class=\"o\">-</span><span class=\"n\">rc</span><span class=\"o\">-</span><span class=\"mi\">2025</span><span class=\"o\">-</span><span class=\"mi\">08</span><span class=\"o\">-</span><span class=\"mi\">15</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">include</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"p\">:</span><span class=\"nc\">filesystem</span><span class=\"o\">/</span><span class=\"n\">imports</span><span class=\"o\">@</span><span class=\"mf\">0.3.0</span><span class=\"o\">-</span><span class=\"n\">rc</span><span class=\"o\">-</span><span class=\"mi\">2025</span><span class=\"o\">-</span><span class=\"mi\">08</span><span class=\"o\">-</span><span class=\"mi\">15</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">include</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"p\">:</span><span class=\"nc\">http</span><span class=\"o\">/</span><span class=\"n\">proxy</span><span class=\"o\">@</span><span class=\"mf\">0.3.0</span><span class=\"o\">-</span><span class=\"n\">rc</span><span class=\"o\">-</span><span class=\"mi\">2025</span><span class=\"o\">-</span><span class=\"mi\">08</span><span class=\"o\">-</span><span class=\"mi\">15</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">include</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"p\">:</span><span class=\"nc\">random</span><span class=\"o\">/</span><span class=\"n\">imports</span><span class=\"o\">@</span><span class=\"mf\">0.3.0</span><span class=\"o\">-</span><span class=\"n\">rc</span><span class=\"o\">-</span><span class=\"mi\">2025</span><span class=\"o\">-</span><span class=\"mi\">08</span><span class=\"o\">-</span><span class=\"mi\">15</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"n\">include</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"p\">:</span><span class=\"nc\">sockets</span><span class=\"o\">/</span><span class=\"n\">imports</span><span class=\"o\">@</span><span class=\"mf\">0.3.0</span><span class=\"o\">-</span><span class=\"n\">rc</span><span class=\"o\">-</span><span class=\"mi\">2025</span><span class=\"o\">-</span><span class=\"mi\">08</span><span class=\"o\">-</span><span class=\"mi\">15</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n<span class=\"n\">EOF</span>\n<span class=\"n\">wkg</span><span class=\"w\"> </span><span class=\"n\">wit</span><span class=\"w\"> </span><span class=\"n\">fetch</span>\n</code></pre></div>\n<p>It takes a little time but does make some wit files:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"n\">find</span><span class=\"w\"> </span><span class=\"n\">wit</span>\n<span class=\"n\">wit</span>\n<span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">wasip3</span><span class=\"p\">.</span><span class=\"n\">wit</span>\n<span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span>\n<span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">sockets</span><span class=\"o\">-</span><span class=\"mf\">0.3.0</span><span class=\"o\">-</span><span class=\"n\">rc</span><span class=\"o\">-</span><span class=\"mi\">2025</span><span class=\"o\">-</span><span class=\"mi\">08</span><span class=\"o\">-</span><span class=\"mi\">15</span>\n<span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">sockets</span><span class=\"o\">-</span><span class=\"mf\">0.3.0</span><span class=\"o\">-</span><span class=\"n\">rc</span><span class=\"o\">-</span><span class=\"mi\">2025</span><span class=\"o\">-</span><span class=\"mi\">08</span><span class=\"o\">-</span><span class=\"mi\">15</span><span class=\"o\">/</span><span class=\"n\">package</span><span class=\"p\">.</span><span class=\"n\">wit</span>\n<span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">random</span><span class=\"o\">-</span><span class=\"mf\">0.3.0</span><span class=\"o\">-</span><span class=\"n\">rc</span><span class=\"o\">-</span><span class=\"mi\">2025</span><span class=\"o\">-</span><span class=\"mi\">08</span><span class=\"o\">-</span><span class=\"mi\">15</span>\n<span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">random</span><span class=\"o\">-</span><span class=\"mf\">0.3.0</span><span class=\"o\">-</span><span class=\"n\">rc</span><span class=\"o\">-</span><span class=\"mi\">2025</span><span class=\"o\">-</span><span class=\"mi\">08</span><span class=\"o\">-</span><span class=\"mi\">15</span><span class=\"o\">/</span><span class=\"n\">package</span><span class=\"p\">.</span><span class=\"n\">wit</span>\n<span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">http</span><span class=\"o\">-</span><span class=\"mf\">0.3.0</span><span class=\"o\">-</span><span class=\"n\">rc</span><span class=\"o\">-</span><span class=\"mi\">2025</span><span class=\"o\">-</span><span class=\"mi\">08</span><span class=\"o\">-</span><span class=\"mi\">15</span>\n<span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">http</span><span class=\"o\">-</span><span class=\"mf\">0.3.0</span><span class=\"o\">-</span><span class=\"n\">rc</span><span class=\"o\">-</span><span class=\"mi\">2025</span><span class=\"o\">-</span><span class=\"mi\">08</span><span class=\"o\">-</span><span class=\"mi\">15</span><span class=\"o\">/</span><span class=\"n\">package</span><span class=\"p\">.</span><span class=\"n\">wit</span>\n<span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">clocks</span><span class=\"o\">-</span><span class=\"mf\">0.3.0</span><span class=\"o\">-</span><span class=\"n\">rc</span><span class=\"o\">-</span><span class=\"mi\">2025</span><span class=\"o\">-</span><span class=\"mi\">08</span><span class=\"o\">-</span><span class=\"mi\">15</span>\n<span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">clocks</span><span class=\"o\">-</span><span class=\"mf\">0.3.0</span><span class=\"o\">-</span><span class=\"n\">rc</span><span class=\"o\">-</span><span class=\"mi\">2025</span><span class=\"o\">-</span><span class=\"mi\">08</span><span class=\"o\">-</span><span class=\"mi\">15</span><span class=\"o\">/</span><span class=\"n\">package</span><span class=\"p\">.</span><span class=\"n\">wit</span>\n<span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">filesystem</span><span class=\"o\">-</span><span class=\"mf\">0.3.0</span><span class=\"o\">-</span><span class=\"n\">rc</span><span class=\"o\">-</span><span class=\"mi\">2025</span><span class=\"o\">-</span><span class=\"mi\">08</span><span class=\"o\">-</span><span class=\"mi\">15</span>\n<span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">filesystem</span><span class=\"o\">-</span><span class=\"mf\">0.3.0</span><span class=\"o\">-</span><span class=\"n\">rc</span><span class=\"o\">-</span><span class=\"mi\">2025</span><span class=\"o\">-</span><span class=\"mi\">08</span><span class=\"o\">-</span><span class=\"mi\">15</span><span class=\"o\">/</span><span class=\"n\">package</span><span class=\"p\">.</span><span class=\"n\">wit</span>\n<span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">cli</span><span class=\"o\">-</span><span class=\"mf\">0.3.0</span><span class=\"o\">-</span><span class=\"n\">rc</span><span class=\"o\">-</span><span class=\"mi\">2025</span><span class=\"o\">-</span><span class=\"mi\">08</span><span class=\"o\">-</span><span class=\"mi\">15</span>\n<span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">cli</span><span class=\"o\">-</span><span class=\"mf\">0.3.0</span><span class=\"o\">-</span><span class=\"n\">rc</span><span class=\"o\">-</span><span class=\"mi\">2025</span><span class=\"o\">-</span><span class=\"mi\">08</span><span class=\"o\">-</span><span class=\"mi\">15</span><span class=\"o\">/</span><span class=\"n\">package</span><span class=\"p\">.</span><span class=\"n\">wit</span>\n</code></pre></div>\n<p>Now make src/main.rs:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">extern</span><span class=\"w\"> </span><span class=\"k\">crate</span><span class=\"w\"> </span><span class=\"n\">wit_bindgen</span><span class=\"p\">;</span>\n\n<span class=\"n\">wit_bindgen</span><span class=\"p\">::</span><span class=\"n\">generate</span><span class=\"o\">!</span><span class=\"p\">({</span><span class=\"n\">inline</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">r</span><span class=\"s\">\"</span>\n<span class=\"s\">  package test:test;</span>\n\n<span class=\"s\">  world test {</span>\n<span class=\"s\">      include wasi:clocks/imports@0.3.0-rc-2025-08-15;</span>\n<span class=\"s\">  }</span>\n<span class=\"s\">\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">path</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s\">\"wit\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">generate_all</span><span class=\"p\">});</span>\n\n<span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"p\">::</span><span class=\"n\">clocks</span><span class=\"p\">::</span><span class=\"n\">monotonic_clock</span><span class=\"p\">;</span>\n\n<span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">start</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">monotonic_clock</span><span class=\"p\">::</span><span class=\"n\">now</span><span class=\"p\">();</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">end</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">monotonic_clock</span><span class=\"p\">::</span><span class=\"n\">now</span><span class=\"p\">();</span>\n<span class=\"w\">    </span><span class=\"fm\">assert!</span><span class=\"p\">(</span><span class=\"n\">start</span><span class=\"w\"> </span><span class=\"o\">&lt;=</span><span class=\"w\"> </span><span class=\"n\">end</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>Try to build:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">release</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">target</span><span class=\"o\">=</span><span class=\"n\">wasm32</span><span class=\"o\">-</span><span class=\"n\">wasip2</span>\n</code></pre></div>\n<p>Failures in wit-bindgen:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">error</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">resolve</span><span class=\"w\"> </span><span class=\"n\">directory</span><span class=\"w\"> </span><span class=\"k\">while</span><span class=\"w\"> </span><span class=\"n\">parsing</span><span class=\"w\"> </span><span class=\"n\">WIT</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">path</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">wingo</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">wasip3</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">test</span><span class=\"o\">/</span><span class=\"n\">wit</span><span class=\"p\">]</span>\n\n<span class=\"w\">       </span><span class=\"n\">Caused</span><span class=\"w\"> </span><span class=\"n\">by</span><span class=\"p\">:</span>\n<span class=\"w\">         </span><span class=\"nc\">interface</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">found</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">package</span>\n<span class=\"w\">            </span><span class=\"o\">-</span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">wingo</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">wasip3</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">test</span><span class=\"o\">/</span><span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">cli</span><span class=\"o\">-</span><span class=\"mf\">0.3.0</span><span class=\"o\">-</span><span class=\"n\">rc</span><span class=\"o\">-</span><span class=\"mi\">2025</span><span class=\"o\">-</span><span class=\"mi\">08</span><span class=\"o\">-</span><span class=\"mi\">15</span><span class=\"o\">/</span><span class=\"n\">package</span><span class=\"p\">.</span><span class=\"n\">wit</span><span class=\"p\">:</span><span class=\"mi\">157</span><span class=\"p\">:</span><span class=\"mi\">22</span>\n<span class=\"w\">             </span><span class=\"o\">|</span>\n<span class=\"w\">         </span><span class=\"mi\">157</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">   </span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"p\">:</span><span class=\"nc\">clocks</span><span class=\"o\">/</span><span class=\"n\">timezone</span><span class=\"o\">@</span><span class=\"mf\">0.3.0</span><span class=\"o\">-</span><span class=\"n\">rc</span><span class=\"o\">-</span><span class=\"mi\">2025</span><span class=\"o\">-</span><span class=\"mi\">08</span><span class=\"o\">-</span><span class=\"mi\">15</span><span class=\"p\">;</span>\n<span class=\"w\">             </span><span class=\"o\">|</span><span class=\"w\">                      </span><span class=\"o\">^-------</span>\n<span class=\"o\">..</span><span class=\"p\">.</span>\n</code></pre></div>\n<p>Which is weird because timezones are behind an unstable feature?  OK, add <code>features: [\"clocks-timezone\"]</code> to the <code>generate!</code> invocation:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">wit_bindgen</span><span class=\"p\">::</span><span class=\"n\">generate</span><span class=\"o\">!</span><span class=\"p\">({</span><span class=\"n\">inline</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">r</span><span class=\"s\">\"</span>\n<span class=\"s\">  package test:test;</span>\n\n<span class=\"s\">  world test {</span>\n<span class=\"s\">      include wasi:clocks/imports@0.3.0-rc-2025-08-15;</span>\n<span class=\"s\">  }</span>\n<span class=\"s\">\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">path</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s\">\"wit\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">features</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"s\">\"clocks-timezone\"</span><span class=\"p\">],</span><span class=\"w\"> </span><span class=\"n\">generate_all</span><span class=\"p\">});</span>\n</code></pre></div>\n<p>Another weird wit-bindgen error:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">error</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">multiple</span><span class=\"w\"> </span><span class=\"n\">packages</span><span class=\"w\"> </span><span class=\"n\">have</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">world</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">must</span><span class=\"w\"> </span><span class=\"n\">specify</span><span class=\"w\"> </span><span class=\"n\">which</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"k\">use</span>\n</code></pre></div>\n<p>Which, fair, there are other packages in <code>wit/</code>, but I gave it inline WIT, it should know to choose that world.  Once you do this, it works:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">wit_bindgen</span><span class=\"p\">::</span><span class=\"n\">generate</span><span class=\"o\">!</span><span class=\"p\">({</span><span class=\"n\">inline</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">r</span><span class=\"s\">\"</span>\n<span class=\"s\">  package test:test;</span>\n\n<span class=\"s\">  world test {</span>\n<span class=\"s\">      include wasi:clocks/imports@0.3.0-rc-2025-08-15;</span>\n<span class=\"s\">  }</span>\n<span class=\"s\">\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">path</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s\">\"wit\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">features</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"s\">\"clocks-timezone\"</span><span class=\"p\">],</span><span class=\"w\"> </span><span class=\"n\">world</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s\">\"test:test/test\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">generate_all</span><span class=\"p\">});</span>\n</code></pre></div>\n<p>And with that, it's the shortest sync test I can make.  The resulting component still imports some wasip2 interfaces, so this is not a pure wasip3 test:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"n\">wasm</span><span class=\"o\">-</span><span class=\"n\">tools</span><span class=\"w\"> </span><span class=\"n\">component</span><span class=\"w\"> </span><span class=\"n\">wit</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"o\">/</span><span class=\"n\">wasm32</span><span class=\"o\">-</span><span class=\"n\">wasip2</span><span class=\"o\">/</span><span class=\"n\">release</span><span class=\"o\">/</span><span class=\"n\">playground</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n<span class=\"n\">package</span><span class=\"w\"> </span><span class=\"n\">root</span><span class=\"p\">:</span><span class=\"nc\">component</span><span class=\"p\">;</span>\n\n<span class=\"n\">world</span><span class=\"w\"> </span><span class=\"n\">root</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"p\">:</span><span class=\"nc\">clocks</span><span class=\"o\">/</span><span class=\"n\">monotonic</span><span class=\"o\">-</span><span class=\"n\">clock</span><span class=\"o\">@</span><span class=\"mf\">0.3.0</span><span class=\"o\">-</span><span class=\"n\">rc</span><span class=\"o\">-</span><span class=\"mi\">2025</span><span class=\"o\">-</span><span class=\"mi\">08</span><span class=\"o\">-</span><span class=\"mi\">15</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"p\">:</span><span class=\"nc\">cli</span><span class=\"o\">/</span><span class=\"n\">environment</span><span class=\"o\">@</span><span class=\"mf\">0.2.3</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"p\">:</span><span class=\"nc\">cli</span><span class=\"o\">/</span><span class=\"n\">exit</span><span class=\"o\">@</span><span class=\"mf\">0.2.3</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"p\">:</span><span class=\"nc\">io</span><span class=\"o\">/</span><span class=\"n\">error</span><span class=\"o\">@</span><span class=\"mf\">0.2.3</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"p\">:</span><span class=\"nc\">io</span><span class=\"o\">/</span><span class=\"n\">streams</span><span class=\"o\">@</span><span class=\"mf\">0.2.3</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"p\">:</span><span class=\"nc\">cli</span><span class=\"o\">/</span><span class=\"n\">stdin</span><span class=\"o\">@</span><span class=\"mf\">0.2.3</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"p\">:</span><span class=\"nc\">cli</span><span class=\"o\">/</span><span class=\"n\">stdout</span><span class=\"o\">@</span><span class=\"mf\">0.2.3</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"p\">:</span><span class=\"nc\">cli</span><span class=\"o\">/</span><span class=\"n\">stderr</span><span class=\"o\">@</span><span class=\"mf\">0.2.3</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"p\">:</span><span class=\"nc\">clocks</span><span class=\"o\">/</span><span class=\"n\">wall</span><span class=\"o\">-</span><span class=\"n\">clock</span><span class=\"o\">@</span><span class=\"mf\">0.2.3</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"p\">:</span><span class=\"nc\">filesystem</span><span class=\"o\">/</span><span class=\"n\">types</span><span class=\"o\">@</span><span class=\"mf\">0.2.3</span><span class=\"p\">;</span>\n<span class=\"w\">  </span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"p\">:</span><span class=\"nc\">filesystem</span><span class=\"o\">/</span><span class=\"n\">preopens</span><span class=\"o\">@</span><span class=\"mf\">0.2.3</span><span class=\"p\">;</span>\n\n<span class=\"w\">  </span><span class=\"n\">export</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"p\">:</span><span class=\"nc\">cli</span><span class=\"o\">/</span><span class=\"n\">run</span><span class=\"o\">@</span><span class=\"mf\">0.2.3</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>But, fair enough, there isn't even a <code>wasm32-wasip3</code> target for rustc yet.</p>",
        "id": 535332432,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755701588
    },
    {
        "content": "<p>cc <span class=\"user-mention\" data-user-id=\"253994\">@Alex Crichton</span> for some of the wit-bindgen oddness</p>",
        "id": 535332534,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755701624
    },
    {
        "content": "<blockquote>\n<p>interface not found in package</p>\n</blockquote>\n<p>We've had a lot of historical weirdness around <code>include</code> and feature-gated interfaces so this might be a legitimate bug there. If you avoid <code>include</code>-ing the <code>imports</code> interface and <code>import</code> the relevant ones directly I think it might work?</p>\n<blockquote>\n<p><code>multiple packages have a world, must specify which to use</code></p>\n</blockquote>\n<p>I think that may be due to my fix yesterday where with <code>path</code> plus <code>inline</code> it's thinking that there's two \"root packages\" to choose worlds from, I'll double check the behavior.</p>\n<blockquote>\n<p>The resulting component still imports some wasip2 interfaces, so this is not a pure wasip3 test:</p>\n</blockquote>\n<p>That's expected yeah, you're running into Rust's usage of WASIp1 in the standard library which gets adapted to WASIp2 through the adapter baked into wasm-component-ld</p>",
        "id": 535333186,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1755701792
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"253994\">Alex Crichton</span> <a href=\"#narrow/channel/219900-wasi/topic/wasi-testsuite.20update.20for.20wasip3/near/535333186\">said</a>:</p>\n<blockquote>\n<blockquote>\n<p>interface not found in package</p>\n</blockquote>\n<p>We've had a lot of historical weirdness around <code>include</code> and feature-gated interfaces so this might be a legitimate bug there. If you avoid <code>include</code>-ing the <code>imports</code> interface and <code>import</code> the relevant ones directly I think it might work?</p>\n</blockquote>\n<p>Seems to not work; if after fetching I remove the <code>wasip3.wit</code> and change the inline wit to <code>import wasi:clocks/monotonic-clock@0.3.0-rc-2025-08-15;</code> instead of including, I still get the same error, which actually originates inside the wkg-imported package:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">         </span><span class=\"n\">interface</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">found</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">package</span>\n<span class=\"w\">            </span><span class=\"o\">-</span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">wingo</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">wasip3</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">test</span><span class=\"o\">/</span><span class=\"n\">wit</span><span class=\"o\">/</span><span class=\"n\">deps</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">cli</span><span class=\"o\">-</span><span class=\"mf\">0.3.0</span><span class=\"o\">-</span><span class=\"n\">rc</span><span class=\"o\">-</span><span class=\"mi\">2025</span><span class=\"o\">-</span><span class=\"mi\">08</span><span class=\"o\">-</span><span class=\"mi\">15</span><span class=\"o\">/</span><span class=\"n\">package</span><span class=\"p\">.</span><span class=\"n\">wit</span><span class=\"p\">:</span><span class=\"mi\">157</span><span class=\"p\">:</span><span class=\"mi\">22</span>\n<span class=\"w\">             </span><span class=\"o\">|</span>\n<span class=\"w\">         </span><span class=\"mi\">157</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\">   </span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"p\">:</span><span class=\"nc\">clocks</span><span class=\"o\">/</span><span class=\"n\">timezone</span><span class=\"o\">@</span><span class=\"mf\">0.3.0</span><span class=\"o\">-</span><span class=\"n\">rc</span><span class=\"o\">-</span><span class=\"mi\">2025</span><span class=\"o\">-</span><span class=\"mi\">08</span><span class=\"o\">-</span><span class=\"mi\">15</span><span class=\"p\">;</span>\n</code></pre></div>",
        "id": 535334435,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755702183
    },
    {
        "content": "<p>hm there may be other packages doing <code>include wasi:clocks/imports</code> maybe, I'll try to dig in in a bit (I need to learn <code>wkg</code> myself...)</p>",
        "id": 535334651,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1755702231
    },
    {
        "content": "<p><a href=\"https://github.com/WebAssembly/wasi-cli/blob/965cbde225ac2d8bd5e3a5aa976c2840242d7b8d/wit-0.3.0-draft/imports.wit#L6\">https://github.com/WebAssembly/wasi-cli/blob/965cbde225ac2d8bd5e3a5aa976c2840242d7b8d/wit-0.3.0-draft/imports.wit#L6</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/WebAssembly/wasi-cli/blob/965cbde225ac2d8bd5e3a5aa976c2840242d7b8d/wit-0.3.0-draft/imports.wit#L6\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/1d61750de8695e311ee7c390f3e5f69d3c91a64d/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f336435343937623830323761663932383135333836613765616161613462623761616265323737306138343566326137643738386639663666303165346330662f576562417373656d626c792f776173692d636c69&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/WebAssembly/wasi-cli/blob/965cbde225ac2d8bd5e3a5aa976c2840242d7b8d/wit-0.3.0-draft/imports.wit#L6\" title=\"wasi-cli/wit-0.3.0-draft/imports.wit at 965cbde225ac2d8bd5e3a5aa976c2840242d7b8d · WebAssembly/wasi-cli\">wasi-cli/wit-0.3.0-draft/imports.wit at 965cbde225ac2d8bd5e3a5aa976c2840242d7b8d · WebAssembly/wasi-cli</a></div><div class=\"message_embed_description\">Command-Line Interface (CLI) World for WASI. Contribute to WebAssembly/wasi-cli development by creating an account on GitHub.</div></div></div>",
        "id": 535334959,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755702311
    },
    {
        "content": "<p>(i wasn't sure if wkg would mangle the wit to either fabricate or elide the \"include\", but in this case it does seem to preserve the <code>include</code>)</p>",
        "id": 535335755,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755702510
    },
    {
        "content": "<p>yeah I'll need to double-check how unstable things all work here, what you're doing <em>should</em> work but unstable features have been a thorn in our side for quite awhile</p>",
        "id": 535337186,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1755702867
    },
    {
        "content": "<p>it is not a blocker for me, i just wanted to write it down so i won't forget :)</p>",
        "id": 535337300,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755702895
    },
    {
        "content": "<p>indeed, and thanks!</p>",
        "id": 535337352,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1755702909
    },
    {
        "content": "<p>thank you!</p>",
        "id": 535337376,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755702917
    },
    {
        "content": "<p>otherwise today i talked a bit with <span class=\"user-mention\" data-user-id=\"513417\">@Marcin Kolny</span> regarding wasi-testsuite organization, we seem to be on the same page regarding making wasi-testsuite useful for wasip3 and the broad lines of how to get there.  will have some prs up tomorrow.</p>",
        "id": 535337824,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755703041
    },
    {
        "content": "<p>avoiding the need to specify <code>world:\"...\"</code> when you've also specified <code>inline</code> should be fixed in <a href=\"https://github.com/bytecodealliance/wit-bindgen/pull/1358\">https://github.com/bytecodealliance/wit-bindgen/pull/1358</a></p>",
        "id": 535338516,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1755703220
    },
    {
        "content": "<p>stupid question: would <code>async fn main()</code> make sense in wasip3, for binary targets?  (of course it doesn't work.  but it seems like it would be nice)</p>",
        "id": 535339402,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755703436
    },
    {
        "content": "<p>it would, yeah, but probably won't get native language support for awhile</p>",
        "id": 535339532,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1755703468
    },
    {
        "content": "<p>i guess this would involve more work on the rustc toolchain, whereas building cdylibs can be a library thing</p>",
        "id": 535339575,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755703482
    },
    {
        "content": "<p>what we could get working though is:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">#[wit_bindgen::main]</span>\n<span class=\"k\">async</span><span class=\"w\"> </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"p\">}</span>\n</code></pre></div>",
        "id": 535339580,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1755703483
    },
    {
        "content": "<p>which is similar to <code>#[tokio::main]</code> used in a number of locations</p>",
        "id": 535339664,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1755703505
    },
    {
        "content": "<p>ah interesting</p>",
        "id": 535339697,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755703514
    },
    {
        "content": "<p>Presumably you'd still have to build that as <code>cdylib</code>?</p>",
        "id": 535339859,
        "sender_full_name": "Lann Martin",
        "timestamp": 1755703561
    },
    {
        "content": "<p>would you?  binary targets seem to produce working components without any special annotation in the Cargo.toml</p>",
        "id": 535340110,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755703623
    },
    {
        "content": "<p>technically you wouldn't have to, but you likely would yeah</p>",
        "id": 535340179,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1755703642
    },
    {
        "content": "<p>(which makes my idea probably not work)</p>",
        "id": 535340211,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1755703650
    },
    {
        "content": "<p>it'd produce a workable component but it'd be \"async stackful\" in a sense instead of \"async callback\"</p>",
        "id": 535340305,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1755703671
    },
    {
        "content": "<p>/me nod</p>",
        "id": 535340375,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755703689
    },
    {
        "content": "<p>In case it's not obvious, you can certainly export an async <code>wasi:cli/run#run</code> function using wit-bindgen today with a bit of boilerplate, e.g. <a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/crates/test-programs/src/bin/p3_cli.rs\">https://github.com/bytecodealliance/wasmtime/blob/main/crates/test-programs/src/bin/p3_cli.rs</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/blob/main/crates/test-programs/src/bin/p3_cli.rs\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/c7cbb978183f7d18139d97e7df7478b8842f698c/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f653034376332626636363032393837326362323265346635623636326662303064626366613836366131336236666430303830633333346434646532653637342f62797465636f6465616c6c69616e63652f7761736d74696d65&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/crates/test-programs/src/bin/p3_cli.rs\" title=\"wasmtime/crates/test-programs/src/bin/p3_cli.rs at main · bytecodealliance/wasmtime\">wasmtime/crates/test-programs/src/bin/p3_cli.rs at main · bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">A lightweight WebAssembly runtime that is fast, secure, and standards-compliant - bytecodealliance/wasmtime</div></div></div>",
        "id": 535340873,
        "sender_full_name": "Joel Dice",
        "timestamp": 1755703819
    },
    {
        "content": "<p>ok the other unstable-related issue is confirmed and minimized as:</p>\n<div class=\"codehilite\" data-code-language=\"wit\"><pre><span></span><code>package a:b1;\n\nworld the-world {\n  include a:b2/the-world;\n}\n\npackage a:b2 {\n  world the-world {\n    @unstable(feature = disabled)\n    import a:b3/thing;\n  }\n}\n\npackage a:b3 {\n  @unstable(feature = disabled)\n  interface thing {}\n}\n</code></pre></div>\n<p>(that fails as input to <code>wasm-tools component wit</code>)</p>",
        "id": 535341349,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1755703976
    },
    {
        "content": "<p>Would it be possible to have a </p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">#[wit_bindgen::test]</span>\n<span class=\"k\">async</span><span class=\"w\"> </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">test_xxx</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"p\">}</span>\n</code></pre></div>\n<p>?</p>",
        "id": 535341519,
        "sender_full_name": "Lann Martin",
        "timestamp": 1755704041
    },
    {
        "content": "<p>yeah we could probably get that working</p>",
        "id": 535342027,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1755704215
    },
    {
        "content": "<p>(filed a bug <a href=\"https://github.com/bytecodealliance/wasm-tools/issues/2285\">here</a>)</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasm-tools/issues/2285\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/4fe766b5d613f8ea2f808fbf91d1cb0225312230/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f383335313636303930306362643663643364663534356233653164363036386264396431616633366437633437313731356634373566393164663233316539392f62797465636f6465616c6c69616e63652f7761736d2d746f6f6c732f6973737565732f32323835&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasm-tools/issues/2285\" title=\"Failure to process unstable interface through `include` · Issue #2285 · bytecodealliance/wasm-tools\">Failure to process unstable interface through `include` · Issue #2285 · bytecodealliance/wasm-tools</a></div><div class=\"message_embed_description\">This input: package a:b1; world the-world { include a:b2/the-world; } package a:b2 { world the-world { @unstable(feature = disabled) import a:b3/thing; } } package a:b3 { @unstable(feature = disabl...</div></div></div>",
        "id": 535348620,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1755706163
    },
    {
        "content": "<p>so, wasi-testsuite and wasmtime: there are some tests that fail on rust for <code>--target=wasm32-wasip1</code>.  i triaged here: <a href=\"https://github.com/WebAssembly/wasi-testsuite/issues/101#issuecomment-3210744361\">https://github.com/WebAssembly/wasi-testsuite/issues/101#issuecomment-3210744361</a>.  if there is a kind soul who is able to triage, that would be helpful</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/WebAssembly/wasi-testsuite/issues/101#issuecomment-3210744361\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/9a4d6d9def2f67139ef91e3ceb1f51f171054a0a/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f343938343734316663343135383637613865316263356662346663366338616566396131633236366238646439333939303936633531653766356665626536392f576562417373656d626c792f776173692d7465737473756974652f6973737565732f313031&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/WebAssembly/wasi-testsuite/issues/101#issuecomment-3210744361\" title=\"Tests failing on Wasmtime · Issue #101 · WebAssembly/wasi-testsuite\">Tests failing on Wasmtime · Issue #101 · WebAssembly/wasi-testsuite</a></div><div class=\"message_embed_description\">The \"Daily runtime validation\" workflow shows 9 failures on Wasmtime, which matches the behavior I see when running the tests locally. Is this a problem with the testsuite or with Wasmtime?</div></div></div>",
        "id": 535512928,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755785369
    },
    {
        "content": "<p>daily status: spent some time prepping wasi-testsuite for wasip3 tests: <a href=\"https://github.com/WebAssembly/wasi-testsuite/issues/109#issuecomment-3210363725\">https://github.com/WebAssembly/wasi-testsuite/issues/109#issuecomment-3210363725</a>.  following up on marcin's review comments.<br>\nin the process i triaged the wasip1 tests mentioned in <a class=\"message-link\" href=\"/#narrow/channel/219900-wasi/topic/wasi-testsuite.20update.20for.20wasip3/near/535512928\">#wasi &gt; wasi-testsuite update for wasip3 @ 💬</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/WebAssembly/wasi-testsuite/issues/109#issuecomment-3210363725\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/6b57f23af9ea229fc3526deec4119bbc3b7e0b82/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f393831346538323261346639363239623938373338323562616466373166653666383335656361363534343333623235313531333135613731333264316336342f576562417373656d626c792f776173692d7465737473756974652f6973737565732f313039&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/WebAssembly/wasi-testsuite/issues/109#issuecomment-3210363725\" title=\"Update wasi-testsuite to support testing newer versions of WASI · Issue #109 · WebAssembly/wasi-testsuite\">Update wasi-testsuite to support testing newer versions of WASI · Issue #109 · WebAssembly/wasi-testsuite</a></div><div class=\"message_embed_description\">Hello wasi-testsuite hackers, I would like to update wasi-testsuite to support newer versions of WASI. The idea would be that the scope of wasi-testsuite should be to test the versions of WASI that...</div></div></div>",
        "id": 535517941,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755786764
    },
    {
        "content": "<p>so, it was a day of plumbing.  but, fine, hopefully tomorrow i add the wasip3 things</p>",
        "id": 535520545,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755787531
    },
    {
        "content": "<p><a href=\"https://github.com/WebAssembly/wasi-testsuite/issues/117\">https://github.com/WebAssembly/wasi-testsuite/issues/117</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/WebAssembly/wasi-testsuite/issues/117\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/7b00b6212298c47821f69e0d606d4a4b4b4a078d/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f633132346331396335393533616631663262343365666638646233323366386135346535613431333833326436363761613036373765383563663237666136612f576562417373656d626c792f776173692d7465737473756974652f6973737565732f313137&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/WebAssembly/wasi-testsuite/issues/117\" title=\"RFC: Remove tests of WASI preview 1 rights API as required · Issue #117 · WebAssembly/wasi-testsuite\">RFC: Remove tests of WASI preview 1 rights API as required · Issue #117 · WebAssembly/wasi-testsuite</a></div><div class=\"message_embed_description\">Summary I propose that if there are failing tests related to the WASI preview 1 rights API, that we modify or delete those tests to remove those assertions. Problem Wasmtime fails some tests curren...</div></div></div>",
        "id": 535634613,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755849749
    },
    {
        "content": "<p>so, is wasi-testsuite the right place for wasip3 tests?</p>",
        "id": 535663821,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755862224
    },
    {
        "content": "<p>i want to focus on wasip3 tests and there has probably too much \"making space for wasip3\" so far</p>",
        "id": 535663907,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755862269
    },
    {
        "content": "<p>I think it might be okay to focus on wasip3 for expedience's sake for now, but long-term, it definitely is the right place, yes: once published, p3 will be the latest version of WASI, which should be reflected in the standard's test suite <span aria-label=\"slight smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"slight smile\">:slight_smile:</span></p>",
        "id": 535664086,
        "sender_full_name": "Till Schneidereit",
        "timestamp": 1755862354
    },
    {
        "content": "<p>ok.  i will just keep piling up the prs, hopefully one day things will go faster</p>",
        "id": 535664455,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755862532
    },
    {
        "content": "<p>I think some refactoring is required at the beginning as wasi-testsuite wasn't designed initially for multiple wasi versions. Once we'll go through that phase, further development should be easier.</p>",
        "id": 535664748,
        "sender_full_name": "Marcin Kolny",
        "timestamp": 1755862660
    },
    {
        "content": "<p>wasip1 tests found a nice wasmtime bug: <a href=\"https://github.com/WebAssembly/wasi-testsuite/issues/101#issuecomment-3214123363\">https://github.com/WebAssembly/wasi-testsuite/issues/101#issuecomment-3214123363</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/WebAssembly/wasi-testsuite/issues/101#issuecomment-3214123363\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/1b42b8c52eeb887103ba23df0fee30c680d214a2/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f363230313363663533616331636533666334323835663162653361643133313762353364333763656632393736386162643562343631376564333235646539302f576562417373656d626c792f776173692d7465737473756974652f6973737565732f313031&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/WebAssembly/wasi-testsuite/issues/101#issuecomment-3214123363\" title=\"Tests failing on Wasmtime · Issue #101 · WebAssembly/wasi-testsuite\">Tests failing on Wasmtime · Issue #101 · WebAssembly/wasi-testsuite</a></div><div class=\"message_embed_description\">The \"Daily runtime validation\" workflow shows 9 failures on Wasmtime, which matches the behavior I see when running the tests locally. Is this a problem with the testsuite or with Wasmtime?</div></div></div>",
        "id": 535668595,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1755864073
    },
    {
        "content": "<p>hmm, i am a bit perplexed.  consider this file:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">extern</span><span class=\"w\"> </span><span class=\"k\">crate</span><span class=\"w\"> </span><span class=\"n\">wit_bindgen</span><span class=\"p\">;</span>\n\n<span class=\"n\">wit_bindgen</span><span class=\"p\">::</span><span class=\"n\">generate</span><span class=\"o\">!</span><span class=\"p\">({</span>\n<span class=\"w\">    </span><span class=\"n\">inline</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">r</span><span class=\"s\">\"</span>\n<span class=\"s\">  package test:test;</span>\n\n<span class=\"s\">  world test {</span>\n<span class=\"s\">      include wasi:clocks/imports@0.3.0-rc-2025-08-15;</span>\n<span class=\"s\">      include wasi:cli/command@0.3.0-rc-2025-08-15;</span>\n<span class=\"s\">  }</span>\n<span class=\"s\">\"</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"c1\">// Work around https://github.com/bytecodealliance/wasm-tools/issues/2285.</span>\n<span class=\"w\">    </span><span class=\"n\">features</span><span class=\"p\">:[</span><span class=\"s\">\"clocks-timezone\"</span><span class=\"p\">],</span>\n<span class=\"w\">    </span><span class=\"k\">async</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">[</span>\n<span class=\"w\">        </span><span class=\"s\">\"wasi:cli/run@0.3.0-rc-2025-08-15#run\"</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"p\">],</span>\n<span class=\"w\">    </span><span class=\"n\">generate_all</span>\n<span class=\"p\">});</span>\n\n<span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">wasi</span><span class=\"p\">::</span><span class=\"n\">clocks</span><span class=\"p\">::</span><span class=\"n\">monotonic_clock</span><span class=\"p\">;</span>\n\n<span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">Component</span><span class=\"p\">;</span>\n<span class=\"n\">export</span><span class=\"o\">!</span><span class=\"p\">(</span><span class=\"n\">Component</span><span class=\"p\">);</span>\n\n<span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">exports</span><span class=\"p\">::</span><span class=\"n\">wasi</span><span class=\"p\">::</span><span class=\"n\">cli</span><span class=\"p\">::</span><span class=\"n\">run</span><span class=\"p\">::</span><span class=\"n\">Guest</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">Component</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"k\">async</span><span class=\"w\"> </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">run</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"p\">()</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"n\">monotonic_clock</span><span class=\"p\">::</span><span class=\"n\">wait_for</span><span class=\"p\">(</span><span class=\"mi\">50_000</span><span class=\"k\">u64</span><span class=\"p\">).</span><span class=\"k\">await</span><span class=\"p\">;</span>\n<span class=\"w\">        </span><span class=\"nb\">Ok</span><span class=\"p\">(())</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n\n<span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{}</span>\n</code></pre></div>\n<p>placed in <code>src/bin/minimal.rs</code>, there are the needed wit files in <code>wit/</code>.   Build via <code>cargo build --target=wasm32-wasip2 --release --bin minimal</code>, with wit-bindgen from git.  It has an error:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"p\">[</span><span class=\"n\">dev</span><span class=\"o\">-</span><span class=\"n\">env</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"n\">wingo</span><span class=\"o\">@</span><span class=\"n\">beastie</span><span class=\"w\"> </span><span class=\"o\">~/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">wasip3</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">testsuite</span><span class=\"o\">/</span><span class=\"n\">tests</span><span class=\"o\">/</span><span class=\"n\">rust</span><span class=\"o\">/</span><span class=\"n\">wasm32</span><span class=\"o\">-</span><span class=\"n\">wasip3</span><span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"n\">cargo</span><span class=\"w\"> </span><span class=\"n\">build</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">target</span><span class=\"o\">=</span><span class=\"n\">wasm32</span><span class=\"o\">-</span><span class=\"n\">wasip2</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">release</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">bin</span><span class=\"w\"> </span><span class=\"n\">minimal</span>\n<span class=\"w\">   </span><span class=\"n\">Compiling</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"o\">-</span><span class=\"n\">wasm32</span><span class=\"o\">-</span><span class=\"n\">wasip3</span><span class=\"w\"> </span><span class=\"n\">v0</span><span class=\"p\">.</span><span class=\"mf\">1.0</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"o\">/</span><span class=\"n\">home</span><span class=\"o\">/</span><span class=\"n\">wingo</span><span class=\"o\">/</span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">wasip3</span><span class=\"o\">/</span><span class=\"n\">wasi</span><span class=\"o\">-</span><span class=\"n\">testsuite</span><span class=\"o\">/</span><span class=\"n\">tests</span><span class=\"o\">/</span><span class=\"n\">rust</span><span class=\"o\">/</span><span class=\"n\">wasm32</span><span class=\"o\">-</span><span class=\"n\">wasip3</span><span class=\"p\">)</span>\n<span class=\"n\">error</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">linking</span><span class=\"w\"> </span><span class=\"n\">with</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">wasm</span><span class=\"o\">-</span><span class=\"n\">component</span><span class=\"o\">-</span><span class=\"n\">ld</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">failed</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">exit</span><span class=\"w\"> </span><span class=\"n\">status</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">1</span>\n<span class=\"w\">  </span><span class=\"o\">|</span>\n<span class=\"w\">  </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">note</span><span class=\"p\">:</span><span class=\"w\">  </span><span class=\"s\">\"wasm-component-ld\"</span><span class=\"w\"> </span><span class=\"s\">\"-flavor\"</span><span class=\"w\"> </span><span class=\"s\">\"wasm\"</span><span class=\"w\"> </span><span class=\"s\">\"--export\"</span><span class=\"w\"> </span><span class=\"s\">\"[async-lift]wasi:cli/run@0.3.0-rc-2025-08-15#run\"</span><span class=\"w\"> </span><span class=\"s\">\"--export\"</span><span class=\"w\"> </span><span class=\"s\">\"[callback][async-lift]wasi:cli/run@0.3.0-rc-2025-08-15#run\"</span><span class=\"w\"> </span><span class=\"s\">\"--export\"</span><span class=\"w\"> </span><span class=\"s\">\"__main_void\"</span><span class=\"w\"> </span><span class=\"s\">\"--export\"</span><span class=\"w\"> </span><span class=\"s\">\"cabi_realloc\"</span><span class=\"w\"> </span><span class=\"s\">\"-z\"</span><span class=\"w\"> </span><span class=\"s\">\"stack-size=1048576\"</span><span class=\"w\"> </span><span class=\"s\">\"--stack-first\"</span><span class=\"w\"> </span><span class=\"s\">\"--allow-undefined\"</span><span class=\"w\"> </span><span class=\"s\">\"--no-demangle\"</span><span class=\"w\"> </span><span class=\"s\">\"&lt;sysroot&gt;/lib/rustlib/wasm32-wasip2/lib/self-contained/crt1-command.o\"</span><span class=\"w\"> </span><span class=\"s\">\"&lt;2 object files omitted&gt;\"</span><span class=\"w\"> </span><span class=\"s\">\"/home/wingo/src/wasip3/wasi-testsuite/tests/rust/wasm32-wasip3/target/wasm32-wasip2/release/deps/{libwit_bindgen-d3f7658c15e3bc1f.rlib,libwit_bindgen_rt-e215225e28d37754.rlib,libfutures-1e3aa9526458c95b.rlib,libfutures_executor-4c14e82b92128eea.rlib,libfutures_util-d4d1ebf3054ace8e.rlib,libmemchr-2857ac1428ecf686.rlib,libfutures_io-bd6f5f056e177761.rlib,libslab-b3944246b67457c3.rlib,libfutures_channel-af04b86abb9667b5.rlib,libpin_project_lite-38e8286ac72dc06c.rlib,libfutures_sink-87533dcfb4185e08.rlib,libfutures_task-4934eebbf3d64f90.rlib,libpin_utils-1407d4781aab0b76.rlib,libfutures_core-c2a2480a6530cd71.rlib,libbitflags-77083259b2ec5fc4.rlib}.rlib\"</span><span class=\"w\"> </span><span class=\"s\">\"&lt;sysroot&gt;/lib/rustlib/wasm32-wasip2/lib/{libstd-*,libpanic_abort-*,libwasi-*,librustc_demangle-*,libstd_detect-*,libhashbrown-*,librustc_std_workspace_alloc-*,libminiz_oxide-*,libadler2-*,libunwind-*,libcfg_if-*,liblibc-*}.rlib\"</span><span class=\"w\"> </span><span class=\"s\">\"-l\"</span><span class=\"w\"> </span><span class=\"s\">\"c\"</span><span class=\"w\"> </span><span class=\"s\">\"&lt;sysroot&gt;/lib/rustlib/wasm32-wasip2/lib/{librustc_std_workspace_core-*,liballoc-*,libcore-*,libcompiler_builtins-*}.rlib\"</span><span class=\"w\"> </span><span class=\"s\">\"-L\"</span><span class=\"w\"> </span><span class=\"s\">\"/home/wingo/src/wasip3/wasi-testsuite/tests/rust/wasm32-wasip3/target/wasm32-wasip2/release/build/wit-bindgen-rt-f69b726d7f89fc43/out\"</span><span class=\"w\"> </span><span class=\"s\">\"-L\"</span><span class=\"w\"> </span><span class=\"s\">\"&lt;sysroot&gt;/lib/rustlib/wasm32-wasip2/lib/self-contained\"</span><span class=\"w\"> </span><span class=\"s\">\"-o\"</span><span class=\"w\"> </span><span class=\"s\">\"/home/wingo/src/wasip3/wasi-testsuite/tests/rust/wasm32-wasip3/target/wasm32-wasip2/release/deps/minimal-83a77969722bd283.wasm\"</span><span class=\"w\"> </span><span class=\"s\">\"--gc-sections\"</span><span class=\"w\"> </span><span class=\"s\">\"-O3\"</span><span class=\"w\"> </span><span class=\"s\">\"--strip-debug\"</span>\n<span class=\"w\">  </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">note</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">some</span><span class=\"w\"> </span><span class=\"n\">arguments</span><span class=\"w\"> </span><span class=\"n\">are</span><span class=\"w\"> </span><span class=\"n\">omitted</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"k\">use</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"o\">--</span><span class=\"n\">verbose</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">show</span><span class=\"w\"> </span><span class=\"n\">all</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"w\"> </span><span class=\"n\">arguments</span>\n<span class=\"w\">  </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">note</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">error</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">encode</span><span class=\"w\"> </span><span class=\"n\">component</span>\n\n<span class=\"w\">          </span><span class=\"n\">Caused</span><span class=\"w\"> </span><span class=\"n\">by</span><span class=\"p\">:</span>\n<span class=\"w\">              </span><span class=\"mi\">0</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">decode</span><span class=\"w\"> </span><span class=\"n\">world</span><span class=\"w\"> </span><span class=\"n\">from</span><span class=\"w\"> </span><span class=\"n\">module</span>\n<span class=\"w\">              </span><span class=\"mi\">1</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">module</span><span class=\"w\"> </span><span class=\"n\">was</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">valid</span>\n<span class=\"w\">              </span><span class=\"mi\">2</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">resolve</span><span class=\"w\"> </span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">wasi</span><span class=\"p\">:</span><span class=\"nc\">clocks</span><span class=\"o\">/</span><span class=\"n\">monotonic</span><span class=\"o\">-</span><span class=\"n\">clock</span><span class=\"o\">@</span><span class=\"mf\">0.3.0</span><span class=\"o\">-</span><span class=\"n\">rc</span><span class=\"o\">-</span><span class=\"mi\">2025</span><span class=\"o\">-</span><span class=\"mi\">08</span><span class=\"o\">-</span><span class=\"mi\">15</span><span class=\"p\">::[</span><span class=\"k\">async</span><span class=\"o\">-</span><span class=\"n\">lower</span><span class=\"p\">][</span><span class=\"k\">async</span><span class=\"p\">]</span><span class=\"n\">wait</span><span class=\"o\">-</span><span class=\"k\">for</span><span class=\"err\">`</span>\n<span class=\"w\">              </span><span class=\"mi\">3</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">validate</span><span class=\"w\"> </span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"n\">interface</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">wasi</span><span class=\"p\">:</span><span class=\"nc\">clocks</span><span class=\"o\">/</span><span class=\"n\">monotonic</span><span class=\"o\">-</span><span class=\"n\">clock</span><span class=\"o\">@</span><span class=\"mf\">0.3.0</span><span class=\"o\">-</span><span class=\"n\">rc</span><span class=\"o\">-</span><span class=\"mi\">2025</span><span class=\"o\">-</span><span class=\"mi\">08</span><span class=\"o\">-</span><span class=\"mi\">15</span><span class=\"err\">`</span>\n<span class=\"w\">              </span><span class=\"mi\">4</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">type</span><span class=\"w\"> </span><span class=\"n\">mismatch</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">function</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"p\">[</span><span class=\"k\">async</span><span class=\"p\">]</span><span class=\"n\">wait</span><span class=\"o\">-</span><span class=\"k\">for</span><span class=\"err\">`</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">expected</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"p\">[</span><span class=\"n\">I32</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">I32</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">I32</span><span class=\"p\">]</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">but</span><span class=\"w\"> </span><span class=\"n\">found</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"p\">[</span><span class=\"n\">I64</span><span class=\"p\">]</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"n\">I32</span><span class=\"p\">]</span><span class=\"err\">`</span>\n</code></pre></div>\n<p>If i switch to simple assertions about <code>monotonic_clock::now()</code>, that works, so it's not a linking error for sync bindings.  In what is probably a second problem, the resulting file fails to run:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"s\">\"$HOME/src/wasip3/wasmtime/target/release/wasmtime\"</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">Sp3</span><span class=\"o\">=</span><span class=\"n\">y</span><span class=\"w\"> </span><span class=\"n\">target</span><span class=\"o\">/</span><span class=\"n\">wasm32</span><span class=\"o\">-</span><span class=\"n\">wasip2</span><span class=\"o\">/</span><span class=\"n\">release</span><span class=\"o\">/</span><span class=\"n\">minimal</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n<span class=\"n\">Error</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">parse</span><span class=\"w\"> </span><span class=\"n\">WebAssembly</span><span class=\"w\"> </span><span class=\"n\">module</span>\n\n<span class=\"n\">Caused</span><span class=\"w\"> </span><span class=\"n\">by</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"err\">`</span><span class=\"n\">task</span><span class=\"p\">.</span><span class=\"k\">return</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">requires</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">component</span><span class=\"w\"> </span><span class=\"n\">model</span><span class=\"w\"> </span><span class=\"k\">async</span><span class=\"w\"> </span><span class=\"n\">feature</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">offset</span><span class=\"w\"> </span><span class=\"mh\">0x17b99</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>Which is odd because I built wasmtime with <code>--features component-model-async</code>.  I will try building this as a cdylib instead, perhaps that will help.</p>",
        "id": 536011902,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1756123933
    },
    {
        "content": "<p>right, I get the same result for a minimal cdylib:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">extern</span><span class=\"w\"> </span><span class=\"k\">crate</span><span class=\"w\"> </span><span class=\"n\">wit_bindgen</span><span class=\"p\">;</span>\n\n<span class=\"n\">wit_bindgen</span><span class=\"p\">::</span><span class=\"n\">generate</span><span class=\"o\">!</span><span class=\"p\">({</span>\n<span class=\"w\">    </span><span class=\"n\">inline</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">r</span><span class=\"s\">\"</span>\n<span class=\"s\">  package test:playground;</span>\n\n<span class=\"s\">  world the-world {</span>\n<span class=\"s\">            include wasi:cli/command@0.3.0-rc-2025-08-15;</span>\n<span class=\"s\">  }</span>\n<span class=\"s\">\"</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">path</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s\">\"wit\"</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"k\">async</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">[</span>\n<span class=\"w\">        </span><span class=\"s\">\"wasi:cli/run@0.3.0-rc-2025-08-15#run\"</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"p\">],</span>\n<span class=\"w\">    </span><span class=\"n\">generate_all</span>\n<span class=\"p\">});</span>\n\n<span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">Test</span><span class=\"p\">;</span>\n\n<span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">exports</span><span class=\"p\">::</span><span class=\"n\">wasi</span><span class=\"p\">::</span><span class=\"n\">cli</span><span class=\"p\">::</span><span class=\"n\">run</span><span class=\"p\">::</span><span class=\"n\">Guest</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">Test</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"k\">async</span><span class=\"w\"> </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">run</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"p\">()</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"nb\">Ok</span><span class=\"p\">(())</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n\n<span class=\"n\">export</span><span class=\"o\">!</span><span class=\"p\">(</span><span class=\"n\">Test</span><span class=\"p\">);</span>\n</code></pre></div>",
        "id": 536014298,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1756124678
    },
    {
        "content": "<blockquote>\n<p><code>task.return requires the component model async feature</code></p>\n</blockquote>\n<p>I believe this requires <code>wasmtime -W component-model-async</code> (runtime feature gate too)</p>",
        "id": 536014990,
        "sender_full_name": "Lann Martin",
        "timestamp": 1756124935
    },
    {
        "content": "<p>oh funny, i didn't think to look there, like \"wasm\" was a lower-level thing than wasi / component-model.  thanks!</p>",
        "id": 536017211,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1756125735
    },
    {
        "content": "<p>Yeah we aren't generally very precise in distinguishing these things but technically component model is a wasm proposal while wasi is its own separate (dependent) spec</p>",
        "id": 536017478,
        "sender_full_name": "Lann Martin",
        "timestamp": 1756125832
    },
    {
        "content": "<p>since they are developed in parallel it is convenient to do lockstep-ish releases and they both end up in the \"p3\" bucket</p>",
        "id": 536017606,
        "sender_full_name": "Lann Martin",
        "timestamp": 1756125881
    },
    {
        "content": "<p>what do i need to enable to fix <code>invalid leading byte (0x25) for canonical function (at offset 0x16a4a)</code> ?</p>",
        "id": 536017739,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1756125929
    },
    {
        "content": "<p>i had tried <code>all-proposals=y</code> in addition to <code>component-model-async=y</code> but that wasn't the trick</p>",
        "id": 536017810,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1756125956
    },
    {
        "content": "<p>Ah I just encountered that one. I believe that is caused by a mismatched wasm-component-ld version</p>",
        "id": 536017826,
        "sender_full_name": "Lann Martin",
        "timestamp": 1756125964
    },
    {
        "content": "<p>I fixed it by switching to a recent rust nightly</p>",
        "id": 536017857,
        "sender_full_name": "Lann Martin",
        "timestamp": 1756125973
    },
    {
        "content": "<p>oh :)</p>",
        "id": 536017861,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1756125974
    },
    {
        "content": "<p>wouldn't that be something in wasi-sdk?</p>",
        "id": 536018049,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1756126043
    },
    {
        "content": "<p>ah perhaps i wasn't running my cargo builds in an environment that had my fresh wasi-sdk</p>",
        "id": 536018389,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1756126155
    },
    {
        "content": "<p>wasi-sdk shouldn't have anything to do with binary encoding</p>",
        "id": 536018473,
        "sender_full_name": "Lann Martin",
        "timestamp": 1756126182
    },
    {
        "content": "<p>well wasm-component-ld is there</p>",
        "id": 536018518,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1756126196
    },
    {
        "content": "<p>but maybe wasi-sdk is only for c?</p>",
        "id": 536018630,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1756126236
    },
    {
        "content": "<p>weird stuff</p>",
        "id": 536018679,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1756126252
    },
    {
        "content": "<p>ah wasi-sdk might include wasm-component-ld to make sure you get a compatible version</p>",
        "id": 536018893,
        "sender_full_name": "Lann Martin",
        "timestamp": 1756126319
    },
    {
        "content": "<p>wasi-sdk can be used by any guest language that can do C ffi in wasm</p>",
        "id": 536018986,
        "sender_full_name": "Lann Martin",
        "timestamp": 1756126356
    },
    {
        "content": "<p>its basically wasi-libc plus a compatible toolchain</p>",
        "id": 536019229,
        "sender_full_name": "Lann Martin",
        "timestamp": 1756126435
    },
    {
        "content": "<p>well many thanks lann, after rustupping to a nightly, things are working now</p>",
        "id": 536019428,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1756126488
    },
    {
        "content": "<p>nice, all problems fixed.  ready to make tests, finally ;)</p>",
        "id": 536019908,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1756126638
    },
    {
        "content": "<p>a first async test at <a href=\"https://github.com/WebAssembly/wasi-testsuite/pull/120\">https://github.com/WebAssembly/wasi-testsuite/pull/120</a>, grumble about github and stacked pr's tho</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/WebAssembly/wasi-testsuite/pull/120\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/705800c05c18715b46d87d70f22a420ecf540aad/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f326131366533303137353233313162383036373866343636656336316536626233356463333437343835333362663363323832333530656536303433613763352f576562417373656d626c792f776173692d7465737473756974652f70756c6c2f313230&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/WebAssembly/wasi-testsuite/pull/120\" title=\"First wasip3 test by wingo · Pull Request #120 · WebAssembly/wasi-testsuite\">First wasip3 test by wingo · Pull Request #120 · WebAssembly/wasi-testsuite</a></div><div class=\"message_embed_description\">Depends on #114.  Adds wasm32-wasip3 Rust test directory, with a first Rust-based test.  Test runner not yet updated; requires passing Wcomponent-model-async=y -Sp3=y to wasmtime.  Building the was...</div></div></div>",
        "id": 536038345,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1756132250
    },
    {
        "content": "<p>/me files a spicy bug <a href=\"https://github.com/WebAssembly/wasi-http/issues/179\">https://github.com/WebAssembly/wasi-http/issues/179</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/WebAssembly/wasi-http/issues/179\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/65b9d985a3836c5291033bfe85173c09c63c9cb5/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f623338636231666366653862363864333761363363306666333436656164366164303866323731356232646639623731343439363835653062396538333638622f576562417373656d626c792f776173692d68747470&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/WebAssembly/wasi-http/issues/179\" title=\"WebAssembly/wasi-http\">WebAssembly/wasi-http</a></div><div class=\"message_embed_description\">Contribute to WebAssembly/wasi-http development by creating an account on GitHub.</div></div></div>",
        "id": 536777620,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1756470468
    },
    {
        "content": "<p>just as a summary of where i'm at:</p>\n<ul>\n<li><a href=\"https://github.com/WebAssembly/wasi-testsuite/pull/122\">https://github.com/WebAssembly/wasi-testsuite/pull/122</a> needs merging, it should fix the workflow that runs on merge-to-main that populates the <code>prod/testsuite-base</code> branch with prebuilt tests</li>\n<li><a href=\"https://github.com/WebAssembly/wasi-testsuite/pull/120\">https://github.com/WebAssembly/wasi-testsuite/pull/120</a> is next, it makes the dir for wasip3 rust tests and adds tests for <code>clocks:monotonic-clock</code></li>\n<li><a href=\"https://github.com/WebAssembly/wasi-testsuite/pull/123\">https://github.com/WebAssembly/wasi-testsuite/pull/123</a> is next, it tests <code>clocks:wall-clock</code> (though there is very little that one can assert there), and it adds a test with 20 outstanding <code>monotonic-clock#wait-until</code> invocations, asserting that they complete in order with regards to each other and to the clock</li>\n<li>currently working on http tests.  not going to test time-zone for the time being, as there is little to test, and it is not yet part of wasip3</li>\n</ul>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/WebAssembly/wasi-testsuite/pull/122\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/8336e3cce02893e016ccbfa05326c13d2e6001c9/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f363232366339303531313833636331633964346331363235326639666436636138333336326537346136303464663365326232333633633037343166383731622f576562417373656d626c792f776173692d7465737473756974652f70756c6c2f313232&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/WebAssembly/wasi-testsuite/pull/122\" title=\"Fix the git shenanigans to merge in main to prod/testsuite-base by wingo · Pull Request #122 · WebAssembly/wasi-testsuite\">Fix the git shenanigans to merge in main to prod/testsuite-base by wingo · Pull Request #122 · WebAssembly/wasi-testsuite</a></div><div class=\"message_embed_description\">Apologies for the clownshoes, ptal @loganek !</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/WebAssembly/wasi-testsuite/pull/120\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/035ae236719180f552cbe2d5d55c165d18403d34/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f356534623937653163653463633766643931323636646432363435396236393334346531333839303130656661653132366138626433653734663164346135622f576562417373656d626c792f776173692d7465737473756974652f70756c6c2f313230&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/WebAssembly/wasi-testsuite/pull/120\" title=\"First wasip3 test by wingo · Pull Request #120 · WebAssembly/wasi-testsuite\">First wasip3 test by wingo · Pull Request #120 · WebAssembly/wasi-testsuite</a></div><div class=\"message_embed_description\">Depends on #114.  Adds wasm32-wasip3 Rust test directory, with a first Rust-based test.  Test runner not yet updated; requires passing Wcomponent-model-async=y -Sp3=y to wasmtime.  Building the was...</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/WebAssembly/wasi-testsuite/pull/123\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/97ec091b3fddcff631773f7ad62de5b0801ba8ca/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f326537616136343161623338386537613634633162326161376139616437363336343031613736646637666465643537366333383438306262663366353266642f576562417373656d626c792f776173692d7465737473756974652f70756c6c2f313233&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/WebAssembly/wasi-testsuite/pull/123\" title=\"Add tests for wasip3 wall_clock and for multiple outstanding wait_for invocations by wingo · Pull Request #123 · WebAssembly/wasi-testsuite\">Add tests for wasip3 wall_clock and for multiple outstanding wait_for invocations by wingo · Pull Request #123 · WebAssembly/wasi-testsuite</a></div><div class=\"message_embed_description\">Stacked on #120.</div></div></div>",
        "id": 536780018,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1756471242
    },
    {
        "content": "<p>thanks for lots of great work and great questions, andy!</p>",
        "id": 536831704,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1756487754
    },
    {
        "content": "<p>good morning :)  i would like to merge <a href=\"https://github.com/WebAssembly/wasi-testsuite/pull/120\">https://github.com/WebAssembly/wasi-testsuite/pull/120</a> today</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/WebAssembly/wasi-testsuite/pull/120\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/035ae236719180f552cbe2d5d55c165d18403d34/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f356534623937653163653463633766643931323636646432363435396236393334346531333839303130656661653132366138626433653734663164346135622f576562417373656d626c792f776173692d7465737473756974652f70756c6c2f313230&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/WebAssembly/wasi-testsuite/pull/120\" title=\"First wasip3 test by wingo · Pull Request #120 · WebAssembly/wasi-testsuite\">First wasip3 test by wingo · Pull Request #120 · WebAssembly/wasi-testsuite</a></div><div class=\"message_embed_description\">Depends on #114.  Adds wasm32-wasip3 Rust test directory, with a first Rust-based test.  Test runner not yet updated; requires passing Wcomponent-model-async=y -Sp3=y to wasmtime.  Building the was...</div></div></div>",
        "id": 537800672,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1757053310
    },
    {
        "content": "<p>how should i proceed here <span class=\"user-mention\" data-user-id=\"513417\">@Marcin Kolny</span> ?</p>",
        "id": 537800721,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1757053346
    },
    {
        "content": "<p>status: i have a 60%-done test for <code>wasi:filesystem</code>, but am not posting a pr yet because i am waiting on <a href=\"https://github.com/WebAssembly/wasi-testsuite/pull/120\">https://github.com/WebAssembly/wasi-testsuite/pull/120</a>; otherwise there is nowhere to put it</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/WebAssembly/wasi-testsuite/pull/120\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/0629b0281e5676f1eecf496e25426b9cba875081/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f366538383537303765623238323862316564346266653933616439346666333461623437326263613163643964633436376435623263353930653637343637342f576562417373656d626c792f776173692d7465737473756974652f70756c6c2f313230&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/WebAssembly/wasi-testsuite/pull/120\" title=\"First wasip3 test by wingo · Pull Request #120 · WebAssembly/wasi-testsuite\">First wasip3 test by wingo · Pull Request #120 · WebAssembly/wasi-testsuite</a></div><div class=\"message_embed_description\">Depends on #114.  Adds wasm32-wasip3 Rust test directory, with a first Rust-based test.  Test runner not yet updated; requires passing Wcomponent-model-async=y -Sp3=y to wasmtime.  Building the was...</div></div></div>",
        "id": 538213876,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1757335029
    },
    {
        "content": "<p>current status: slogging away at <a href=\"https://github.com/WebAssembly/wasi-testsuite/pull/130/files\">https://github.com/WebAssembly/wasi-testsuite/pull/130/files</a>.  i have done almost everything that doesn't require streams.  starting streams now; found a fun wasmtime bug: <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11652\">https://github.com/bytecodealliance/wasmtime/issues/11652</a>.  will continue tomorrow</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/WebAssembly/wasi-testsuite/pull/130/files\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/55070b6e630dcd45f2cd4d3959a1b359a5428dbe/68747470733a2f2f617661746172732e67697468756275736572636f6e74656e742e636f6d2f752f313734353930333f733d34303026763d34&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/WebAssembly/wasi-testsuite/pull/130/files\" title=\"Add tests for wasi:filesystem@0.3.0-rc-2025-08-15 by wingo · Pull Request #130 · WebAssembly/wasi-testsuite\">Add tests for wasi:filesystem@0.3.0-rc-2025-08-15 by wingo · Pull Request #130 · WebAssembly/wasi-testsuite</a></div><div class=\"message_embed_description\">WASI Testsuite. Contribute to WebAssembly/wasi-testsuite development by creating an account on GitHub.</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/issues/11652\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/13e8946c7eaf45f4c58d19609666656c8e452efe/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f303263666137613233336237313738613262303832313564626363326438623031326533626166633763333261396366616563353735336433643434343066652f62797465636f6465616c6c69616e63652f7761736d74696d652f6973737565732f3131363532&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/issues/11652\" title=\"iloop when readdir on dir containing symlink · Issue #11652 · bytecodealliance/wasmtime\">iloop when readdir on dir containing symlink · Issue #11652 · bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">Test case use std::process; extern crate wit_bindgen; wit_bindgen::generate!({ inline: r\" package test:test; world test { include wasi:filesystem/imports@0.3.0-rc-2025-08-15; include wasi:cli/comma...</div></div></div>",
        "id": 538460836,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1757430416
    },
    {
        "content": "<p>As a status update on the wasmtime side of things, Andy now <code>wasi:http</code> bits are all landed in Wasmtime so the <code>dev</code> release should be suitable for testing all of WASIp3</p>",
        "id": 538524783,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1757448809
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"509936\">@Joel Dice</span> no idea how, but the stream/future host API refactor (<a href=\"https://github.com/bytecodealliance/wasmtime/pull/11515\">https://github.com/bytecodealliance/wasmtime/pull/11515</a>) fixed my iloop in readdir (<a href=\"https://github.com/bytecodealliance/wasmtime/issues/11652#issuecomment-3278931677\">https://github.com/bytecodealliance/wasmtime/issues/11652#issuecomment-3278931677</a>).  Weird!</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/pull/11515\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/39bf14796e2581e91b6f99e6829661e2e679df69/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f346535643034383738636138626537653733303965626166613838393935316136356435303361343430393237333435386439623139666532613463376162332f62797465636f6465616c6c69616e63652f7761736d74696d652f70756c6c2f3131353135&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/pull/11515\" title=\"Revamp component model stream/future host API (again) by dicej · Pull Request #11515 · bytecodealliance/wasmtime\">Revamp component model stream/future host API (again) by dicej · Pull Request #11515 · bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">This changes the host APIs for dealing with futures and streams from a &quot;rendezvous&quot;-style API to a callback-oriented one.\nPreviously you would create e.g. a StreamReader/StreamWriter pair...</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/issues/11652#issuecomment-3278931677\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/c443beed7525aef0c727d010156ffa5103de86fd/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f626233623064633839386632323136333931316337636232316563336233396130353934386239333834623332393830643265663837643535376332383534362f62797465636f6465616c6c69616e63652f7761736d74696d652f6973737565732f3131363532&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/issues/11652#issuecomment-3278931677\" title=\"iloop when readdir on dir containing symlink · Issue #11652 · bytecodealliance/wasmtime\">iloop when readdir on dir containing symlink · Issue #11652 · bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">Test case use std::process; extern crate wit_bindgen; wit_bindgen::generate!({ inline: r\" package test:test; world test { include wasi:filesystem/imports@0.3.0-rc-2025-08-15; include wasi:cli/comma...</div></div></div>",
        "id": 538790458,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1757576583
    },
    {
        "content": "<p>hoo, read-from-stream's prototype is weird</p>",
        "id": 538834782,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1757590737
    },
    {
        "content": "<p>i guess it is to be expected that this hangs:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">stream</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">future</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">fd</span><span class=\"p\">.</span><span class=\"n\">read_via_stream</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">);</span>\n<span class=\"n\">future</span><span class=\"p\">.</span><span class=\"k\">await</span>\n</code></pre></div>",
        "id": 538835110,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1757590827
    },
    {
        "content": "<p>I have had the same confusion recently. I think in general we expect to read the stream until it's dropped, then poll the future.</p>",
        "id": 538838471,
        "sender_full_name": "Lann Martin",
        "timestamp": 1757591888
    },
    {
        "content": "<p>(or do both concurrently)</p>",
        "id": 538838602,
        "sender_full_name": "Lann Martin",
        "timestamp": 1757591933
    },
    {
        "content": "<p>one of the weird things is that it's tricky to test that <code>read-via-stream(u64::MAX)</code> fails, because if you drop the stream immediately, the future doesn't necessarily resolve to an error</p>",
        "id": 538841909,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1757592749
    },
    {
        "content": "<p>do zero-length reads still allow the stream to start?</p>",
        "id": 538842603,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1757592938
    },
    {
        "content": "<p>it seems not</p>",
        "id": 538843892,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1757593349
    },
    {
        "content": "<p>I think they're supposed to, or at least <em>were</em> supposed to in some design iteration</p>",
        "id": 538851791,
        "sender_full_name": "Lann Martin",
        "timestamp": 1757595508
    },
    {
        "content": "<p>The doc comment in wasmtime <code>main</code> right now says that a zero length read will only return <code>pending</code> if it \"expects\" that a non-zero-length read would also return <code>pending</code>.</p>",
        "id": 538853368,
        "sender_full_name": "Lann Martin",
        "timestamp": 1757595887
    },
    {
        "content": "<p>That's for host streams in general; the filesystem impl might not be up-to-date with that interpretation</p>",
        "id": 538853645,
        "sender_full_name": "Lann Martin",
        "timestamp": 1757595963
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"396878\">Andy Wingo</span> <a href=\"#narrow/channel/219900-wasi/topic/wasi-testsuite.20update.20for.20wasip3/near/538790458\">said</a>:</p>\n<blockquote>\n<p>no idea how, but the stream/future host API refactor (<a href=\"https://github.com/bytecodealliance/wasmtime/pull/11515\">https://github.com/bytecodealliance/wasmtime/pull/11515</a>) fixed my iloop in readdir</p>\n</blockquote>\n<p>That's not totally surprising; that refactor was primarily motivated by the need for finer-grained, more predictable, control of streams and futures in <code>wasmtime-wasi[-http]</code>, and it also forced us to think more precisely about how we wanted them to behave.</p>",
        "id": 538858656,
        "sender_full_name": "Joel Dice",
        "timestamp": 1757597129
    },
    {
        "content": "<p>Zero-length reads/writes are a bit weird because they're used for readiness checks where possible, but a 1-byte read at <code>u64::MAX - 1</code> should deterministically fail</p>",
        "id": 538876532,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1757601346
    },
    {
        "content": "<p>AbiBuffer is odd: its <a href=\"https://docs.rs/wit-bindgen/0.46.0/wit_bindgen/struct.AbiBuffer.html#method.remaining\">remaining()</a> method would seem to duplicate <code>StreamResult::Complete</code>.  as a user you get both values.  i get the reason but it's weird</p>",
        "id": 539008777,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1757665487
    },
    {
        "content": "<p>and my goodness, writing to a stream is gnarly</p>",
        "id": 539014707,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1757667433
    },
    {
        "content": "<p>so.  component-model-knowers.  i initially wrote this to test <code>write-via-stream</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">async</span><span class=\"w\"> </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">pwrite</span><span class=\"p\">(</span><span class=\"n\">fd</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kp\">&amp;</span><span class=\"nc\">Descriptor</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">offset</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">u64</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kp\">&amp;</span><span class=\"p\">[</span><span class=\"kt\">u8</span><span class=\"p\">])</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"kt\">usize</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ErrorCode</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">tx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">rx</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">wit_stream</span><span class=\"p\">::</span><span class=\"n\">new</span><span class=\"p\">();</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">success</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">fd</span><span class=\"p\">.</span><span class=\"n\">write_via_stream</span><span class=\"p\">(</span><span class=\"n\">rx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">offset</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"n\">len</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">data</span><span class=\"p\">.</span><span class=\"n\">len</span><span class=\"p\">();</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">written</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kt\">usize</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">buf</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">tx</span><span class=\"p\">.</span><span class=\"n\">write</span><span class=\"p\">(</span><span class=\"n\">data</span><span class=\"p\">.</span><span class=\"n\">to_vec</span><span class=\"p\">()).</span><span class=\"k\">await</span><span class=\"p\">;</span>\n<span class=\"w\">    </span><span class=\"k\">loop</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">result</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">            </span><span class=\"n\">StreamResult</span><span class=\"p\">::</span><span class=\"n\">Complete</span><span class=\"p\">(</span><span class=\"n\">n</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">                </span><span class=\"fm\">assert!</span><span class=\"p\">(</span><span class=\"n\">n</span><span class=\"w\"> </span><span class=\"o\">&lt;=</span><span class=\"w\"> </span><span class=\"n\">len</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">written</span><span class=\"p\">);</span>\n<span class=\"w\">                </span><span class=\"n\">written</span><span class=\"w\"> </span><span class=\"o\">+=</span><span class=\"w\"> </span><span class=\"n\">n</span><span class=\"p\">;</span>\n<span class=\"w\">                </span><span class=\"fm\">assert_eq!</span><span class=\"p\">(</span><span class=\"n\">buf</span><span class=\"p\">.</span><span class=\"n\">remaining</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">len</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">written</span><span class=\"p\">);</span>\n<span class=\"w\">                </span><span class=\"k\">if</span><span class=\"w\"> </span><span class=\"n\">buf</span><span class=\"p\">.</span><span class=\"n\">remaining</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"o\">!=</span><span class=\"w\"> </span><span class=\"mi\">0</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">                    </span><span class=\"p\">(</span><span class=\"n\">result</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">buf</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">tx</span><span class=\"p\">.</span><span class=\"n\">write_buf</span><span class=\"p\">(</span><span class=\"n\">buf</span><span class=\"p\">).</span><span class=\"k\">await</span><span class=\"p\">;</span>\n<span class=\"w\">                </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"k\">else</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">                    </span><span class=\"k\">break</span><span class=\"p\">;</span>\n<span class=\"w\">                </span><span class=\"p\">}</span>\n<span class=\"w\">            </span><span class=\"p\">},</span>\n<span class=\"w\">            </span><span class=\"n\">StreamResult</span><span class=\"p\">::</span><span class=\"n\">Dropped</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">                </span><span class=\"fm\">panic!</span><span class=\"p\">(</span><span class=\"s\">\"receiver dropped the stream?\"</span><span class=\"p\">);</span>\n<span class=\"w\">            </span><span class=\"p\">},</span>\n<span class=\"w\">            </span><span class=\"n\">StreamResult</span><span class=\"p\">::</span><span class=\"n\">Cancelled</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">                </span><span class=\"k\">break</span><span class=\"p\">;</span>\n<span class=\"w\">            </span><span class=\"p\">}</span>\n<span class=\"w\">        </span><span class=\"p\">}</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"w\">    </span><span class=\"fm\">assert_eq!</span><span class=\"p\">(</span><span class=\"n\">buf</span><span class=\"p\">.</span><span class=\"n\">remaining</span><span class=\"p\">(),</span><span class=\"w\"> </span><span class=\"n\">len</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">written</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"nb\">drop</span><span class=\"p\">(</span><span class=\"n\">tx</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">success</span><span class=\"p\">.</span><span class=\"k\">await</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">        </span><span class=\"nb\">Ok</span><span class=\"p\">(())</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"nb\">Ok</span><span class=\"p\">(</span><span class=\"n\">written</span><span class=\"p\">),</span>\n<span class=\"w\">        </span><span class=\"nb\">Err</span><span class=\"p\">(</span><span class=\"n\">err</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=&gt;</span><span class=\"w\"> </span><span class=\"nb\">Err</span><span class=\"p\">(</span><span class=\"n\">err</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"p\">}</span>\n<span class=\"p\">}</span>\n</code></pre></div>",
        "id": 539014969,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1757667517
    },
    {
        "content": "<p>could be buggy, excuse my bad rust form, etc; anyway, when running this, wasmtime deadlocks.  helpfully it detects the deadlock; but it is not clear to me why it should deadlock at all.  i wrote this from the spec and docs, but now looking at wasmtime tests it would seem that it wants me to wait in parallel on the individual stream writes, at the same time as i wait on the write-via-stream results: <a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/crates/test-programs/src/bin/p3_file_write.rs#L45\">https://github.com/bytecodealliance/wasmtime/blob/main/crates/test-programs/src/bin/p3_file_write.rs#L45</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/blob/main/crates/test-programs/src/bin/p3_file_write.rs#L45\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/fc97dbb158f474c38c754194422763a3f9464bfb/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f306566633730396664393666626263393139323435326562366331663534333261353161306239656138373436366636633030343061363033356263303332302f62797465636f6465616c6c69616e63652f7761736d74696d65&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/crates/test-programs/src/bin/p3_file_write.rs#L45\" title=\"wasmtime/crates/test-programs/src/bin/p3_file_write.rs at main · bytecodealliance/wasmtime\">wasmtime/crates/test-programs/src/bin/p3_file_write.rs at main · bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">A lightweight WebAssembly runtime that is fast, secure, and standards-compliant - bytecodealliance/wasmtime</div></div></div>",
        "id": 539015416,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1757667652
    },
    {
        "content": "<p>but why is this?  if there is an error, why wouldn't the receiving end cancel the stream and cause the future to complete with a failure?</p>",
        "id": 539015662,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1757667738
    },
    {
        "content": "<p>the deadlock occurs at the <code>tx.write(data.to_vec()).await</code> line</p>",
        "id": 539016158,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1757667907
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"480579\">Lann Martin</span> <a href=\"#narrow/channel/219900-wasi/topic/wasi-testsuite.20update.20for.20wasip3/near/538838471\">said</a>:</p>\n<blockquote>\n<p>I have had the same confusion recently. I think in general we expect to read the stream until it's dropped, then poll the future.</p>\n</blockquote>\n<p>this is what I was expecting for the write case, then: write the stream until complete or cancelled, then poll the future.  is it necessarily not that way?</p>",
        "id": 539019415,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1757668947
    },
    {
        "content": "<p>Just to clarify terminology, <code>completed</code> and <code>cancelled</code> are the two stream results that - maybe confusingly - don't terminate the stream. Otherwise yes, my expectation is that you write to the stream until you either get a <code>dropped</code> result (typically because of a write error) or you drop it yourself (because you are done), then await the future.</p>",
        "id": 539055693,
        "sender_full_name": "Lann Martin",
        "timestamp": 1757681020
    },
    {
        "content": "<p>hoo, i did not realize that <code>cancelled</code> doesn't terminate the stream</p>",
        "id": 539070018,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1757684852
    },
    {
        "content": "<p>yeah it is just cancelling the one active operation on the stream</p>",
        "id": 539070154,
        "sender_full_name": "Lann Martin",
        "timestamp": 1757684886
    },
    {
        "content": "<p>Take this with a grain of salt until Joel/Alex/Luke can confirm but I believe the state diagram is basically this: <a href=\"https://gist.github.com/lann/d8dbc6feaf36eb70a17e9506e3c06597\">https://gist.github.com/lann/d8dbc6feaf36eb70a17e9506e3c06597</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://gist.github.com/lann/d8dbc6feaf36eb70a17e9506e3c06597\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/91f9baed8f4fc08c462d1a4de5a8c23942d45e97/68747470733a2f2f6769746875622e6769746875626173736574732e636f6d2f6173736574732f676973742d6f672d696d6167652d3534666437646330373133652e706e67&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://gist.github.com/lann/d8dbc6feaf36eb70a17e9506e3c06597\" title=\"write-stream.mmd\">write-stream.mmd</a></div><div class=\"message_embed_description\">GitHub Gist: instantly share code, notes, and snippets.</div></div></div>",
        "id": 539072104,
        "sender_full_name": "Lann Martin",
        "timestamp": 1757685402
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"396878\">@Andy Wingo</span> I'm not sure what's causing the deadlock.  Would you mind providing instructions for reproducing the issue, e.g. a complete Rust file I can run using <code>wasmtime run</code>?  BTW, you could use <code>StreamWriter::write_all</code> and avoid the loop.</p>",
        "id": 539072162,
        "sender_full_name": "Joel Dice",
        "timestamp": 1757685419
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"480579\">@Lann Martin</span> your diagram looks roughly accurate, but note that the read and write ends of a stream are dropped separately, so a stream could be in one of three states: where neither end is dropped, the write end is dropped, or the read end is dropped.  And when both ends are dropped it ceases to exist entirely.</p>",
        "id": 539073081,
        "sender_full_name": "Joel Dice",
        "timestamp": 1757685672
    },
    {
        "content": "<p>Yeah I should clarify that I was only trying to represent the writer's perspective there.</p>",
        "id": 539073226,
        "sender_full_name": "Lann Martin",
        "timestamp": 1757685710
    },
    {
        "content": "<blockquote>\n<p>as a user you get both values. i get the reason but it's weird</p>\n</blockquote>\n<p>This is trying to expose what the component model is giving us in that the return code of an async operation indicates how many items were transferred and the end-result status of the operation. In many cases dropped == 0 items taken for example but that's not guaranteed.</p>\n<blockquote>\n<p>and my goodness, writing to a stream is gnarly</p>\n</blockquote>\n<p>IMO I'd view this operation as a kernel-like operation. Managing epoll and/or trying to use io-uring would also be quite gnarly and I wouldn't expect those to be simple. I'd think of raw CM streams similarly.</p>\n<p>I've tried to add a few helper methods like <code>write_all</code> and such and if you end up having other common operations it's fine to add more helper methods too.</p>\n<blockquote>\n<p>when running this, wasmtime deadlocks</p>\n</blockquote>\n<p>This is a subtle difference between Rust &amp; JS, calling <code>fd.write_via_stream(rx, offset)</code> doesn't actually do anything. You have to actually poll the future, which in this example only happens at the end of the function during <code>success.await</code>, for anything to happen. The reason your example deadlocks is that functionally what's happening is you created a stream and then wrote to it, but nothing is reading from it because the host API hasn't actually been called yet.</p>\n<p>In the test in Rust you'll find usage of a <code>futures::join!</code> macro which is the current solution for this. It represents \"do these two things at the same time\" which is what you want here, one end calls <code>success.await</code> and the other ened does the writing.</p>",
        "id": 539084110,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1757688623
    },
    {
        "content": "<blockquote>\n<p>Joel/Alex/Luke can confirm but I believe the state diagram is basically this: <a href=\"https://gist.github.com/lann/d8dbc6feaf36eb70a17e9506e3c06597\">https://gist.github.com/lann/d8dbc6feaf36eb70a17e9506e3c06597</a></p>\n</blockquote>\n<p>FWIW that looks right to me</p>",
        "id": 539084359,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1757688664
    },
    {
        "content": "<p>Yeah to your point above, in that state diagram all of the <code>result</code>s are implicitly from polling something.</p>",
        "id": 539085166,
        "sender_full_name": "Lann Martin",
        "timestamp": 1757688778
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"253994\">Alex Crichton</span> <a href=\"#narrow/channel/219900-wasi/topic/wasi-testsuite.20update.20for.20wasip3/near/539084110\">said</a>:</p>\n<blockquote>\n<blockquote>\n<p>as a user you get both values. i get the reason but it's weird</p>\n</blockquote>\n<p>This is trying to expose what the component model is giving us in that the return code of an async operation indicates how many items were transferred and the end-result status of the operation. In many cases dropped == 0 items taken for example but that's not guaranteed.</p>\n</blockquote>\n<p>So let's say you have a stream, you have a vector of <em>total-count</em> items to write the stream, and the receiver consumes those items in a number of batches.</p>\n<p>My question: from the transmitter's perspective (i.e., when it is active and not suspended), could we calculate the AbiBuffer's <code>remaining()</code> as the <em>total-count</em> minus the sum of the previously-received <code>StreamResult::Complete(n)</code> values?  That is what I meant by duplication.  But you seem to be suggesting that no, if the stream result is <code>Dropped</code>, that the previous write may have only been partially consumed, and that the <code>remaining()</code> is the real source of truth?  I would have expected a <code>Complete(n)</code> for the partial write, then a <code>Dropped</code>.</p>\n<blockquote>\n<blockquote>\n<p>and my goodness, writing to a stream is gnarly</p>\n</blockquote>\n<p>IMO I'd view this operation as a kernel-like operation. Managing epoll and/or trying to use io-uring would also be quite gnarly and I wouldn't expect those to be simple. I'd think of raw CM streams similarly.</p>\n<p>I've tried to add a few helper methods like <code>write_all</code> and such and if you end up having other common operations it's fine to add more helper methods too.</p>\n</blockquote>\n<p>I would certainly recommend the <code>write_all</code> methods to others, but I am just trying to get a feel for how things can break when there are drops and cancels and so on :)</p>\n<blockquote>\n<blockquote>\n<p>when running this, wasmtime deadlocks</p>\n</blockquote>\n<p>This is a subtle difference between Rust &amp; JS, calling <code>fd.write_via_stream(rx, offset)</code> doesn't actually do anything. You have to actually poll the future, which in this example only happens at the end of the function during <code>success.await</code>, for anything to happen.</p>\n</blockquote>\n<p>This is indeed subtle, thank you for the hint!  This entirely explains it.  I had no idea about this aspect of Rust, the systems I have worked with all begin execution of the subtask immediately and only suspend if necessary.  Thanks again for the generous close read.</p>",
        "id": 539488729,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1757923964
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"509936\">Joel Dice</span> <a href=\"#narrow/channel/219900-wasi/topic/wasi-testsuite.20update.20for.20wasip3/near/539072162\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"396878\">Andy Wingo</span> I'm not sure what's causing the deadlock.  Would you mind providing instructions for reproducing the issue, e.g. a complete Rust file I can run using <code>wasmtime run</code>?  BTW, you could use <code>StreamWriter::write_all</code> and avoid the loop.</p>\n</blockquote>\n<p>I had just finished preparing the example when Alex corrected my misunderstanding, no need now.  Thank you though.</p>",
        "id": 539488964,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1757924031
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"253994\">@Alex Crichton</span> question, how do you know that in Rust, <code>fd.read_via_stream</code> won't have to poll the future before the sender will be active?</p>",
        "id": 539500350,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1757927168
    },
    {
        "content": "<p>i assume that the whole pre-poll sendable Future thing is a rust-only concern: it would seem that on a component-model async ABI level, calling an async import actually starts the task (as in JS, C#, etc)</p>",
        "id": 539500672,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1757927253
    },
    {
        "content": "<p>Should you be interested, I think <a href=\"https://aturon.github.io/blog/2016/09/07/futures-design/\">this classic blog post</a> by Aaron Turon still gives a pretty good explanation for the design of Rust Futures</p>",
        "id": 539527683,
        "sender_full_name": "Till Schneidereit",
        "timestamp": 1757934940
    },
    {
        "content": "<p>i also enjoyed the blandy/orendorff/tindall chapter on asyncs</p>",
        "id": 539549168,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1757940785
    },
    {
        "content": "<p>finishing filesystem tests.  i am mostly assuming i can read my own writes, that writes to a descriptor within a component are immediately visible to reads within that component without sync, both for data and stat().size</p>",
        "id": 539554553,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1757941913
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"396878\">Andy Wingo</span> <a href=\"#narrow/channel/219900-wasi/topic/wasi-testsuite.20update.20for.20wasip3/near/539500672\">said</a>:</p>\n<blockquote>\n<p>i assume that the whole pre-poll sendable Future thing is a rust-only concern: it would seem that on a component-model async ABI level, calling an async import actually starts the task (as in JS, C#, etc)</p>\n</blockquote>\n<p>I think this is understood but just to be completely clear: in your example the import isn't called until the Rust Future is polled. If you are more familiar with JS you can think of Rust async functions as generators.</p>",
        "id": 539554796,
        "sender_full_name": "Lann Martin",
        "timestamp": 1757941979
    },
    {
        "content": "<p>i know that wasi isn't much able to specify this but maybe tests can nudge implementations in the right direction, i.e. that adding buffering on the host side is a bad thing</p>",
        "id": 539554837,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1757941990
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"480579\">Lann Martin</span> <a href=\"#narrow/channel/219900-wasi/topic/wasi-testsuite.20update.20for.20wasip3/near/539554796\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"396878\">Andy Wingo</span> <a href=\"#narrow/channel/219900-wasi/topic/wasi-testsuite.20update.20for.20wasip3/near/539500672\">said</a>:</p>\n<blockquote>\n<p>i assume that the whole pre-poll sendable Future thing is a rust-only concern: it would seem that on a component-model async ABI level, calling an async import actually starts the task (as in JS, C#, etc)</p>\n</blockquote>\n<p>I think this is understood but just to be completely clear: in your example the import isn't called until the Rust Future is polled. If you are more familiar with JS you can think of Rust async functions as generators.</p>\n</blockquote>\n<p>i did not understand this before but after alex's comment i do now!</p>",
        "id": 539555055,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1757942054
    },
    {
        "content": "<p>(don't js generators actually get to run a bit immediately?  i can't remember, and i implemented them in spidermonkey and v8.. ;)</p>",
        "id": 539555225,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1757942100
    },
    {
        "content": "<p>They do not (I had to verify in the console <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span>)</p>",
        "id": 539555307,
        "sender_full_name": "Lann Martin",
        "timestamp": 1757942119
    },
    {
        "content": "<p>live and learn (and forget, and learn...) :)</p>",
        "id": 539555424,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1757942147
    },
    {
        "content": "<p>I guess more to your question of whether its a \"rust-only concern\", that depends on whether any other languages <em>also</em> treat async functions as generators. I think Python might (edit: it does)? But if you are just asking about the ABI, yes once the async call reaches the ABI the task starts immediately.</p>",
        "id": 539555782,
        "sender_full_name": "Lann Martin",
        "timestamp": 1757942246
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"396878\">Andy Wingo</span> <a href=\"#narrow/channel/219900-wasi/topic/wasi-testsuite.20update.20for.20wasip3/near/539554553\">said</a>:</p>\n<blockquote>\n<p>finishing filesystem tests. i am mostly assuming i can read my own writes, that writes to a descriptor within a component are immediately visible to reads within that component without sync, both for data and stat().size<br>\ni know that wasi isn't much able to specify this but maybe tests can nudge implementations in the right direction, i.e. that adding buffering on the host side is a bad thing</p>\n</blockquote>\n<p>My non-authoritative take would be that for a single descriptor yes you should be able to read your own writes.</p>",
        "id": 539556456,
        "sender_full_name": "Lann Martin",
        "timestamp": 1757942439
    },
    {
        "content": "<p>(feedback welcome re the sync/buffering thing)</p>",
        "id": 539556716,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1757942505
    },
    {
        "content": "<blockquote>\n<p>So let's say you have a stream, you have a vector of <em>total-count</em> items to write the stream, and the receiver consumes those items in a number of batches.</p>\n</blockquote>\n<p>I'm not entirely sure how to respond to your question here in that I'm not totally sure I understand it. That being said I'm going to make a statement here which you may already be aware of but in case you weren't it might reframe your questions here: if a writer writes 10 items, and a reader then reads 4 items, the writer will receive a notification that 4 items were read. The writer doesn't, for example, say blocked until all 10 items are read. </p>\n<p>There's room in the CM spec to allow the reader to keep reading before a notification is delivered (e.g. you read one-item-at-a-time in a loop and we batch all the notifications for the writer) but that's not implemented in Wasmtime right now.</p>\n<blockquote>\n<p>if the stream result is <code>Dropped</code>, that the previous write may have only been partially consumed, and that the <code>remaining()</code> is the real source of truth?</p>\n</blockquote>\n<p>This is indeed a possibility, yeah. Although reading over the APIs again it's a bug that <code>Dropped</code> doesn't have a <code>usize</code> payload on it, that definitely should.</p>\n<p>With that combo of words, does that answer your original question? I fear it may not... Let me know though!</p>",
        "id": 539569951,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1757945489
    },
    {
        "content": "<blockquote>\n<p>how do you know that in Rust, <code>fd.read_via_stream</code> won't have to poll the future before the sender will be active?</p>\n</blockquote>\n<p>Can confirm others' answers here, it's purely a Rust thing. When you do <code>foo()</code> where it was defined as <code>async fn foo() { println!(\"hi\") }</code> that does nothing and prints nothing. All it does is construct a future on the stack that, when polled, will actually print. Once we hit the CM, however, then everything happens in the background similar to JS/etc and pollling in Rust need not happen other than to actually acquire the result of the operation when it's done.</p>",
        "id": 539570528,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1757945609
    },
    {
        "content": "<p>also I totally empathize with you implementing JS generators, my friend and I wrote a JIT for lua in college and I don't actually know anything about writing lua</p>",
        "id": 539570777,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1757945662
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"253994\">Alex Crichton</span> <a href=\"#narrow/channel/219900-wasi/topic/wasi-testsuite.20update.20for.20wasip3/near/539569951\">said</a>:</p>\n<blockquote>\n<p>There's room in the CM spec to allow the reader to keep reading before a notification is delivered (e.g. you read one-item-at-a-time in a loop and we batch all the notifications for the writer) but that's not implemented in Wasmtime right now.</p>\n</blockquote>\n<p>I believe it <em>is</em> implemented, per <a href=\"https://github.com/bytecodealliance/wasip3-prototyping/issues/162\">https://github.com/bytecodealliance/wasip3-prototyping/issues/162</a> and <a href=\"https://github.com/bytecodealliance/wasip3-prototyping/pull/168\">https://github.com/bytecodealliance/wasip3-prototyping/pull/168</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasip3-prototyping/issues/162\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/b6e5824b69c64a27e99e5a6ce8395edd19649f7a/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f336661313338386237633331636634336663646133633537333563643735643531336565643566623232383565326538383666643135353530613861353666342f62797465636f6465616c6c69616e63652f7761736970332d70726f746f747970696e672f6973737565732f313632&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasip3-prototyping/issues/162\" title=\"Multiple writes into the same buffer · Issue #162 · bytecodealliance/wasip3-prototyping\">Multiple writes into the same buffer · Issue #162 · bytecodealliance/wasip3-prototyping</a></div><div class=\"message_embed_description\">As currently specified, if one component does a stream.read and another component does a stream.write that doesn't completely fill the stream.read's buffer, until the STREAM_READ event is delivered...</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasip3-prototyping/pull/168\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/3ebc727d670b18cfea11af27d74f3ea5617a39ab/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f336238383162623661313761396337623435643139333334623939303262393762343030383734343930623665643963656131396632636561366464396366302f62797465636f6465616c6c69616e63652f7761736970332d70726f746f747970696e672f70756c6c2f313638&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasip3-prototyping/pull/168\" title=\"fix various behavior mismatches relative to the spec by dicej · Pull Request #168 · bytecodealliance/wasip3-prototyping\">fix various behavior mismatches relative to the spec by dicej · Pull Request #168 · bytecodealliance/wasip3-prototyping</a></div><div class=\"message_embed_description\">Plus docs, comments, and minor code cleanup.</div></div></div>",
        "id": 539571306,
        "sender_full_name": "Joel Dice",
        "timestamp": 1757945769
    },
    {
        "content": "<p>oh nice!</p>",
        "id": 539571443,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1757945794
    },
    {
        "content": "<p>I thought that was just some hypothetical future thing we would do at some point</p>",
        "id": 539571512,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1757945809
    },
    {
        "content": "<p>I think the hypothetical future thing is to allow you to start multiple reads or writes on the same stream without waiting for previous ones to complete, which is different.</p>",
        "id": 539571681,
        "sender_full_name": "Joel Dice",
        "timestamp": 1757945851
    },
    {
        "content": "<p>i.e. you can start a new read for a write you already read from, but only after you get notification that the previous read completed</p>",
        "id": 539572067,
        "sender_full_name": "Joel Dice",
        "timestamp": 1757945932
    },
    {
        "content": "<p>(and assuming the writer hasn't received their notification yet, at which point the reader will need to wait for a new write)</p>",
        "id": 539572219,
        "sender_full_name": "Joel Dice",
        "timestamp": 1757945964
    },
    {
        "content": "<p>Regarding what <span class=\"user-mention silent\" data-user-id=\"253994\">Alex Crichton</span> <a href=\"#narrow/channel/219900-wasi/topic/wasi-testsuite.20update.20for.20wasip3/near/539569951\">said</a>, I think I was missing that <code>Dropped</code> logically has a <code>usize</code> associated with it:</p>\n<blockquote>\n<blockquote>\n<p>if the stream result is <code>Dropped</code>, that the previous write may have only been partially consumed, and that the <code>remaining()</code> is the real source of truth?</p>\n</blockquote>\n<p>This is indeed a possibility, yeah. Although reading over the APIs again it's a bug that <code>Dropped</code> doesn't have a <code>usize</code> payload on it, that definitely should.</p>\n</blockquote>",
        "id": 539572941,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1757946119
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"253994\">Alex Crichton</span> <a href=\"#narrow/channel/219900-wasi/topic/wasi-testsuite.20update.20for.20wasip3/near/539570528\">said</a>:</p>\n<blockquote>\n<p>Once we hit the CM, however, then everything happens in the background similar to JS/etc and pollling in Rust need not happen other than to actually acquire the result of the operation when it's done.</p>\n</blockquote>\n<p>To clarify, though: it's all still cooperative, so if the caller goes into an infinite loop without yielding, the callee will not have a chance to make progress.  I.e. \"in the background\" means, \"when nothing else is monopolizing the single thread of control\".</p>",
        "id": 539572986,
        "sender_full_name": "Joel Dice",
        "timestamp": 1757946128
    },
    {
        "content": "<p>is the cooperative nature observable?  can progress be made on a cross-component async call in another thread, invisible to other components?</p>",
        "id": 539573385,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1757946226
    },
    {
        "content": "<p>observable, yes, cross-thread, no</p>",
        "id": 539573501,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1757946254
    },
    {
        "content": "<p>ack</p>",
        "id": 539573702,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1757946293
    },
    {
        "content": "<p>ok!  added my filesystem tests, i think especially as regards the actual streaming i/o there can be more tests, but at least all the api is covered.  a bunch of similar draft pr's up at <a href=\"https://github.com/WebAssembly/wasi-testsuite/pulls\">https://github.com/WebAssembly/wasi-testsuite/pulls</a>, but only one marked as ready, so that changes from that review can be replicated in the others: <a href=\"https://github.com/WebAssembly/wasi-testsuite/pull/131\">https://github.com/WebAssembly/wasi-testsuite/pull/131</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/WebAssembly/wasi-testsuite/pulls\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/a449d1f170540e1b7f6b5621d2cc5e7cb1d3dbda/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f323333363132353030386639653937326664653837393865343736626433373833646636386631323131636131626165363937313132326133363264396362302f576562417373656d626c792f776173692d746573747375697465&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/WebAssembly/wasi-testsuite/pulls\" title=\"Pull requests · WebAssembly/wasi-testsuite\">Pull requests · WebAssembly/wasi-testsuite</a></div><div class=\"message_embed_description\">WASI Testsuite. Contribute to WebAssembly/wasi-testsuite development by creating an account on GitHub.</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/WebAssembly/wasi-testsuite/pull/131\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/19e3b6b876e247cd26ce045dbcf8a2d278abcc4e/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f333236653437373038336330383234346139346134326462373935386232626134323132653438396333356165663133386361323330646439396365373663322f576562417373656d626c792f776173692d7465737473756974652f70756c6c2f313331&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/WebAssembly/wasi-testsuite/pull/131\" title=\"wasi:filesystem@0.3.0-rc-2025-08-15: Add tests for flags/type APIs by wingo · Pull Request #131 · WebAssembly/wasi-testsuite\">wasi:filesystem@0.3.0-rc-2025-08-15: Add tests for flags/type APIs by wingo · Pull Request #131 · WebAssembly/wasi-testsuite</a></div><div class=\"message_embed_description\">We read every piece of feedback, and take your input very seriously.</div></div></div>",
        "id": 539724891,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1758015711
    },
    {
        "content": "<p>the tests get compiled nightly but are not run yet.  now that wasi-testsuite actually has wasip3 tests, i need to wire up that bit of the CI.</p>",
        "id": 539725039,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1758015754
    },
    {
        "content": "<p>will see what i can do with http, now that it's in.</p>",
        "id": 539725096,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1758015773
    },
    {
        "content": "<p>review welcome on the <code>wasi:filesystem</code> tests: <a href=\"https://github.com/WebAssembly/wasi-testsuite/pulls\">https://github.com/WebAssembly/wasi-testsuite/pulls</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/WebAssembly/wasi-testsuite/pulls\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/6c671bc33c34b8cb7c002f873cb0048d782f83a7/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f326435623061313338333839373636663832306335656132393165336335393536393936656533616634326638303735356432393538386635643932303938322f576562417373656d626c792f776173692d746573747375697465&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/WebAssembly/wasi-testsuite/pulls\" title=\"Pull requests · WebAssembly/wasi-testsuite\">Pull requests · WebAssembly/wasi-testsuite</a></div><div class=\"message_embed_description\">WASI Testsuite. Contribute to WebAssembly/wasi-testsuite development by creating an account on GitHub.</div></div></div>",
        "id": 540821727,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1758551812
    },
    {
        "content": "<p>OK, quick status: the wasi-testsuite runner tests multiple runtimes at once and skips e.g. WASIp3 tests on a runtime that just does WASIp1.  Working on filing off some sharp edges.  Tomorrow I will add a jco adapter.  There are tests basically only for wasi:clocks and wasi:filesystem currently, and most of the filesystem ones are out for review still; I have held off on http until <a href=\"https://github.com/bytecodealliance/wasmtime/issues/11736\">https://github.com/bytecodealliance/wasmtime/issues/11736</a> is fixed.</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/issues/11736\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/82f017e03c6718278f2e7b072608d45ee5181bff/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f363964363634643563303531393165313637656432663730636535616338386433396166313765633232636163353637646337633039643538313663656265302f62797465636f6465616c6c69616e63652f7761736d74696d652f6973737565732f3131373336&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/issues/11736\" title=\"Add WASIp3 HTTP to `wasmtime run` · Issue #11736 · bytecodealliance/wasmtime\">Add WASIp3 HTTP to `wasmtime run` · Issue #11736 · bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">Hello, Running wasmtime run on a component that uses wasi:http fails: [dev-env] wingo@beastie ~/src/wasip3/wasi-testsuite/tests/rust/wasm32-wasip3$ ~/src/wasip3/wasmtime/target/release/wasmtime -Wc...</div></div></div>",
        "id": 541251934,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1758726050
    },
    {
        "content": "<p>but generally speaking see <a href=\"https://github.com/WebAssembly/wasi-testsuite/pull/162\">https://github.com/WebAssembly/wasi-testsuite/pull/162</a> for an idea of status</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/WebAssembly/wasi-testsuite/pull/162\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/55c3172d7ac23a7cd8847333e60cf79848f53504/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f383537323131323935336533616437666264353134626639313530313233613464386165323137666565373463613038626233393032653731336234303735352f576562417373656d626c792f776173692d7465737473756974652f70756c6c2f313632&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/WebAssembly/wasi-testsuite/pull/162\" title=\"Skip tests that runtimes don't support by wingo · Pull Request #162 · WebAssembly/wasi-testsuite\">Skip tests that runtimes don't support by wingo · Pull Request #162 · WebAssembly/wasi-testsuite</a></div><div class=\"message_embed_description\">Refactor to make runtime adapters declare the WASI versions they support, and for test suites to declare the WASI version they are.  By default, skip tests whose WASI version is not supported by th...</div></div></div>",
        "id": 541252040,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1758726072
    },
    {
        "content": "<p>i regret to inform everyone that i am back on my BS!</p>\n<p>so, question,,, i am looking at <a href=\"https://github.com/WebAssembly/wasi-testsuite/issues/186\">https://github.com/WebAssembly/wasi-testsuite/issues/186</a>.  if, with wit-bindgen, I do:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">main</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">tx</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">rx</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">wit_future</span><span class=\"p\">::</span><span class=\"n\">new</span><span class=\"p\">(</span><span class=\"o\">||</span><span class=\"w\"> </span><span class=\"nb\">Ok</span><span class=\"p\">(</span><span class=\"nb\">None</span><span class=\"p\">));</span>\n<span class=\"w\">    </span><span class=\"nb\">drop</span><span class=\"p\">(</span><span class=\"n\">tx</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"nb\">drop</span><span class=\"p\">(</span><span class=\"n\">rx</span><span class=\"p\">);</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>then I get a panic when dropping <code>tx</code>, because it goes to write and there's no task on the other side to take the value.</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/WebAssembly/wasi-testsuite/issues/186\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/bfc4f72f4337b6bf83dcf36563cd1a6601a94070/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f666433663634643837343838393163346663306430343462653264343930303439353939386630333666346534373963613038343163393064353733613766662f576562417373656d626c792f776173692d7465737473756974652f6973737565732f313836&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/WebAssembly/wasi-testsuite/issues/186\" title=\"http-response wasip3 test fails after toolchain, wit-bindgen, wasmtime update · Issue #186 · WebAssembly/wasi-testsuite\">http-response wasip3 test fails after toolchain, wit-bindgen, wasmtime update · Issue #186 · WebAssembly/wasi-testsuite</a></div><div class=\"message_embed_description\">This was working before when run on wasmtime / ubuntu but not any more. Noting it here. wasmtime -Wcomponent-model-async -Sp3,http tests/rust/testsuite/wasm32-wasip3/http-response.wasm thread 'main...</div></div></div>",
        "id": 562474600,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1765202664
    },
    {
        "content": "<p>what changed between wit-bindgen 0.44 (or so) and 0.48 to make this an error?</p>",
        "id": 562474670,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1765202687
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"509936\">@Joel Dice</span> and <span class=\"user-mention\" data-user-id=\"253994\">@Alex Crichton</span> are all but certainly the best people to answer this</p>",
        "id": 562476998,
        "sender_full_name": "Till Schneidereit",
        "timestamp": 1765203255
    },
    {
        "content": "<p>the concrete use case is creating a http response object without writing any trailers.  the test uses <code>let (_, rx) = wit_future::new(|| Ok(None))</code> for that purpose</p>",
        "id": 562478805,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1765203720
    },
    {
        "content": "<p>Hm yeah that shouldn't panic, that sounds like a bug</p>",
        "id": 562479288,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1765203849
    },
    {
        "content": "<p>neat</p>",
        "id": 562479620,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1765203942
    },
    {
        "content": "<p>Locally that doesn't panic for me, and running the test in the issue yields:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">thread</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">main</span><span class=\"o\">'</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">panicked</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">bin</span><span class=\"o\">/</span><span class=\"n\">http</span><span class=\"o\">-</span><span class=\"n\">response</span><span class=\"p\">.</span><span class=\"n\">rs</span><span class=\"p\">:</span><span class=\"mi\">36</span><span class=\"p\">:</span><span class=\"mi\">50</span><span class=\"p\">:</span>\n<span class=\"nc\">called</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"nb\">Result</span><span class=\"p\">::</span><span class=\"n\">unwrap_err</span><span class=\"p\">()</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"n\">an</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"nb\">Ok</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">()</span>\n<span class=\"n\">note</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">run</span><span class=\"w\"> </span><span class=\"n\">with</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">RUST_BACKTRACE</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">environment</span><span class=\"w\"> </span><span class=\"n\">variable</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">display</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">backtrace</span>\n</code></pre></div>\n<p>which wasmtime version should I be using to repro?</p>",
        "id": 562479974,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1765204022
    },
    {
        "content": "<p>er, as in, locally I edited a wit-bindgen test to create a future and drop the ends and it didn't panic</p>",
        "id": 562480072,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1765204041
    },
    {
        "content": "<p>on the CI we are using the wasmtime <code>dev</code> release.  i get the same thing for wasmtime from git (built today)</p>",
        "id": 562480156,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1765204063
    },
    {
        "content": "<p>we had a bit of a mess updating toolchain and various deps: <a href=\"https://github.com/WebAssembly/wasi-testsuite/pull/185\">https://github.com/WebAssembly/wasi-testsuite/pull/185</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/WebAssembly/wasi-testsuite/pull/185\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/34e104e11c72961fc3c9a87c86fbe6ae13fc0922/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f633336396334306339616537646134353630393430313839343335623933636632363365346134363434623762646262616436383631356431386462343232392f576562417373656d626c792f776173692d7465737473756974652f70756c6c2f313835&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/WebAssembly/wasi-testsuite/pull/185\" title=\"wasip3 rust tests: Pin wit-bindgen to a released version by wingo · Pull Request #185 · WebAssembly/wasi-testsuite\">wasip3 rust tests: Pin wit-bindgen to a released version by wingo · Pull Request #185 · WebAssembly/wasi-testsuite</a></div><div class=\"message_embed_description\">Before, we needed git.  But now we need a released version because git produces errors like \"[async method]descriptor.write-via-stream is not in kebab case (at offset 0x27).</div></div></div>",
        "id": 562480321,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1765204102
    },
    {
        "content": "<p>Should I be able to repro by checking out <code>prod/testsuite-base</code>?</p>",
        "id": 562480628,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1765204164
    },
    {
        "content": "<p>(I can't repro with <code>main</code> wasmtime on <code>prod/testsuite-base</code>)</p>",
        "id": 562480699,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1765204174
    },
    {
        "content": "<p>i think so, yes; lemme try</p>",
        "id": 562480728,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1765204181
    },
    {
        "content": "<p>or, rather, I get the <code>unwrap_err</code> issue from above</p>",
        "id": 562480755,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1765204185
    },
    {
        "content": "<p>I'm on <code>a61233b4927818cd96a6830c97338e71205299e6</code> for <code>prod/testsuite-base</code> and I get:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"o\">../</span><span class=\"n\">wasmtime</span><span class=\"o\">/</span><span class=\"n\">target</span><span class=\"o\">/</span><span class=\"n\">x86_64</span><span class=\"o\">-</span><span class=\"n\">unknown</span><span class=\"o\">-</span><span class=\"n\">linux</span><span class=\"o\">-</span><span class=\"n\">gnu</span><span class=\"o\">/</span><span class=\"n\">release</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">Wcomponent</span><span class=\"o\">-</span><span class=\"n\">model</span><span class=\"o\">-</span><span class=\"k\">async</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">Sp3</span><span class=\"p\">,</span><span class=\"n\">http</span><span class=\"w\"> </span><span class=\"n\">tests</span><span class=\"o\">/</span><span class=\"n\">rust</span><span class=\"o\">/</span><span class=\"n\">testsuite</span><span class=\"o\">/</span><span class=\"n\">wasm32</span><span class=\"o\">-</span><span class=\"n\">wasip3</span><span class=\"o\">/</span><span class=\"n\">http</span><span class=\"o\">-</span><span class=\"n\">response</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n\n<span class=\"n\">thread</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">main</span><span class=\"o\">'</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">panicked</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">src</span><span class=\"o\">/</span><span class=\"n\">bin</span><span class=\"o\">/</span><span class=\"n\">http</span><span class=\"o\">-</span><span class=\"n\">response</span><span class=\"p\">.</span><span class=\"n\">rs</span><span class=\"p\">:</span><span class=\"mi\">36</span><span class=\"p\">:</span><span class=\"mi\">50</span><span class=\"p\">:</span>\n<span class=\"nc\">called</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"nb\">Result</span><span class=\"p\">::</span><span class=\"n\">unwrap_err</span><span class=\"p\">()</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">on</span><span class=\"w\"> </span><span class=\"n\">an</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"nb\">Ok</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">value</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"p\">()</span>\n<span class=\"n\">note</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">run</span><span class=\"w\"> </span><span class=\"n\">with</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">RUST_BACKTRACE</span><span class=\"o\">=</span><span class=\"mi\">1</span><span class=\"err\">`</span><span class=\"w\"> </span><span class=\"n\">environment</span><span class=\"w\"> </span><span class=\"n\">variable</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">display</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">backtrace</span>\n<span class=\"n\">Error</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"n\">main</span><span class=\"w\"> </span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"err\">`</span><span class=\"n\">tests</span><span class=\"o\">/</span><span class=\"n\">rust</span><span class=\"o\">/</span><span class=\"n\">testsuite</span><span class=\"o\">/</span><span class=\"n\">wasm32</span><span class=\"o\">-</span><span class=\"n\">wasip3</span><span class=\"o\">/</span><span class=\"n\">http</span><span class=\"o\">-</span><span class=\"n\">response</span><span class=\"p\">.</span><span class=\"n\">wasm</span><span class=\"err\">`</span>\n\n<span class=\"o\">..</span><span class=\"p\">.</span>\n</code></pre></div>",
        "id": 562480919,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1765204221
    },
    {
        "content": "<p>yes i get the same for the prod/testsuite-base binaries.  weird, I will look into things.</p>",
        "id": 562481465,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1765204343
    },
    {
        "content": "<p>whereas if i build the wasm files locally i get the abort that CI sees.  somethign is off, i will look into it</p>",
        "id": 562481687,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1765204399
    },
    {
        "content": "<p>the github action that uploaded prebuilt tests to prod/testsuite-base was broken <span aria-label=\"upside down\" class=\"emoji emoji-1f643\" role=\"img\" title=\"upside down\">:upside_down:</span></p>",
        "id": 562497443,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1765207884
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"253994\">@Alex Crichton</span> if you try again from <code>prod/testsuite-base</code> i think you will get the error i was seeing</p>",
        "id": 562497942,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1765208002
    },
    {
        "content": "<p>possible differences between the setup on ci and yours:</p>\n<ul>\n<li>ci uses wasm32-wasip2 from rustup to compile wasip3, not the tier3 wasm32-wasip3 target</li>\n<li>ci uses wit-bindgen 0.48.1, not 0.49 / git</li>\n</ul>",
        "id": 562498887,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1765208207
    },
    {
        "content": "<p>lookin</p>",
        "id": 562499822,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1765208413
    },
    {
        "content": "<p>hm ok so the basic issue here is that this is happening in a non-async context and there's a bad error message/handling on wit-bindgen's part</p>",
        "id": 562500931,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1765208678
    },
    {
        "content": "<p>with <code>async fn main() { ... }</code> for example I don't believe this'd cause issues</p>",
        "id": 562501277,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1765208748
    },
    {
        "content": "<p>you are thinking that it should not be possible to make a http response object in a sync context?</p>",
        "id": 562501509,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1765208800
    },
    {
        "content": "<p>well, I'm not going that far yet, just saying what's going on so far</p>",
        "id": 562501629,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1765208828
    },
    {
        "content": "<p>sure.  i have no opinion fwiw.  also does <code>async fn main()</code> work these days?  or is it <code>async fn run()</code> on the guest impl</p>",
        "id": 562501931,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1765208891
    },
    {
        "content": "<p>it'd be <code>async fn run</code> yeah</p>",
        "id": 562502021,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1765208911
    },
    {
        "content": "<p>cool</p>",
        "id": 562502060,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1765208918
    },
    {
        "content": "<p>how exactly async gets hooked up at <code>main</code> at the toolchain level is a bit of an open question</p>",
        "id": 562502127,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1765208930
    },
    {
        "content": "<p>/me nod</p>",
        "id": 562502173,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1765208939
    },
    {
        "content": "<p>to the extent that wasi-testsuite is testing wasi, not toolchains, I'd recommend switching tests to using explicit exports where possible</p>",
        "id": 562502213,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1765208948
    },
    {
        "content": "<p>I recently did that for wit-bindgen's own test suite too</p>",
        "id": 562502247,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1765208953
    },
    {
        "content": "<p>hmm!  i wonder, there is a case for not testing component-model async things though -- the low-level details of how to manage futures and streams, i mean, as these are component-model concerns; i.e. we would ideally use whatever lowest level of abstractions map streams into a language which is a little above the canonical abi</p>",
        "id": 562502979,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1765209154
    },
    {
        "content": "<p>but, perhaps you are right.  i will look into what you did for wit-bindgen</p>",
        "id": 562503046,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1765209172
    },
    {
        "content": "<p>in this specific instance i am ok with the answer being \"it is only sensible to use this interface from within a rust async context, when using rust\", fwiw</p>",
        "id": 562503267,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1765209240
    },
    {
        "content": "<p>I think we'll still want a better answer here longer-term for Rust itself, but yeah for wasi-testsuite I think that's a reasonable rule of thumb</p>",
        "id": 562503799,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1765209417
    },
    {
        "content": "<p>I opened <a href=\"https://github.com/bytecodealliance/wit-bindgen/issues/1456\">https://github.com/bytecodealliance/wit-bindgen/issues/1456</a> for this</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wit-bindgen/issues/1456\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/eb869286c9979b2b7da3e049c0754bab3dac5341/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f356133373831626533316361326361336634303264663163316265613963366235653566383236346164353464613664643061393632383863383266353038652f62797465636f6465616c6c69616e63652f7769742d62696e6467656e2f6973737565732f31343536&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wit-bindgen/issues/1456\" title=\"rust: Panic dropping a future outside of an async context · Issue #1456 · bytecodealliance/wit-bindgen\">rust: Panic dropping a future outside of an async context · Issue #1456 · bytecodealliance/wit-bindgen</a></div><div class=\"message_embed_description\">Code such as this: fn main() { let (tx, rx) = wit_future::new(|| Ok(None)); drop(tx); drop(rx); } will currently fail with: thread 'main' (1) panicked at /home/runner/.cargo/registry/src/index.crat...</div></div></div>",
        "id": 562504267,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1765209540
    }
]
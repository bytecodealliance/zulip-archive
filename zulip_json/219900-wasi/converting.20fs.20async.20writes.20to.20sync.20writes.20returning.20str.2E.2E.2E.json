[
    {
        "content": "<p>One thing that feels off to me about this change is that it would imply to never mix <code>async</code> and <code>stream</code>s in the same function signature. Which might be totally fine, but still.. <span aria-label=\"man shrugging\" class=\"emoji emoji-1f937-200d-2642\" role=\"img\" title=\"man shrugging\">:man_shrugging:</span></p>",
        "id": 567624752,
        "sender_full_name": "Dave Bakker (badeend)",
        "timestamp": 1768245607
    },
    {
        "content": "<p>Agreed yeah, and it also makes me wonder if we should avoid using <code>async</code> in WASI, which feels a bit weird</p>",
        "id": 567626847,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1768246267
    },
    {
        "content": "<p>or rather, feels like a weird conclusion</p>",
        "id": 567626866,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1768246277
    },
    {
        "content": "<p>I think perhaps the general guideline here is: avoid <code>async</code> on resource methods that wait to process an entire stream since that prevents forward-and-forget use cases.  For non-stream-taking functions or scenarios where forward-and-forget isn't desirable (where the stream would be a \"child\" of the resource and so you're not going to drop/transfer the resource until you're done with it), <code>async</code> is fine.</p>",
        "id": 567630801,
        "sender_full_name": "Luke Wagner",
        "timestamp": 1768247524
    },
    {
        "content": "<blockquote>\n<p>scenarios where forward-and-forget isn't desirable (..) <code>async</code> is fine.</p>\n</blockquote>\n<p>that'd still be unrepresentable in Rust (safely)</p>",
        "id": 567631320,
        "sender_full_name": "Dave Bakker (badeend)",
        "timestamp": 1768247716
    },
    {
        "content": "<p>what about, for example, <a href=\"https://github.com/WebAssembly/WASI/blob/7e643518a4bf9767ca799d7aa776c560a2fc0351/proposals/cli/wit-0.3.0-draft/stdio.wit#L48\">write-via-stream</a>?</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/WebAssembly/WASI/blob/7e643518a4bf9767ca799d7aa776c560a2fc0351/proposals/cli/wit-0.3.0-draft/stdio.wit#L48\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/f567583c630c2055e56ffba254c6d3cfa4faae6e/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f643432623862353564623066306566333034363039653435373830346136343338376137356265353230643636376331306336633832333066633962636138612f576562417373656d626c792f57415349&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/WebAssembly/WASI/blob/7e643518a4bf9767ca799d7aa776c560a2fc0351/proposals/cli/wit-0.3.0-draft/stdio.wit#L48\" title=\"WASI/proposals/cli/wit-0.3.0-draft/stdio.wit at 7e643518a4bf9767ca799d7aa776c560a2fc0351 · WebAssembly/WASI\">WASI/proposals/cli/wit-0.3.0-draft/stdio.wit at 7e643518a4bf9767ca799d7aa776c560a2fc0351 · WebAssembly/WASI</a></div><div class=\"message_embed_description\">WebAssembly System Interface. Contribute to WebAssembly/WASI development by creating an account on GitHub.</div></div></div>",
        "id": 567631440,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1768247752
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"889128\">Ludea</span> has marked this topic as resolved.</p>",
        "id": 567631522,
        "sender_full_name": "Notification Bot",
        "timestamp": 1768247783
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"253994\">@Alex Crichton</span> I think it is in the \"fine\" category b/c there isn't a resource involved (that you might want to drop/transfer)</p>",
        "id": 567631694,
        "sender_full_name": "Luke Wagner",
        "timestamp": 1768247846
    },
    {
        "content": "<p>Technically though it still doesn't allow forward-and-forget, right?</p>",
        "id": 567631784,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1768247878
    },
    {
        "content": "<p>because the component always has to be in the middle?</p>",
        "id": 567631801,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1768247884
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"253994\">Alex Crichton</span> has marked this topic as unresolved.</p>",
        "id": 567631837,
        "sender_full_name": "Notification Bot",
        "timestamp": 1768247899
    },
    {
        "content": "<p>(I think the resolution was accidental)</p>",
        "id": 567631849,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1768247905
    },
    {
        "content": "<p>Hmm, maybe I'm confused.  I thought the thing we're \"forgeting\" is the resource whose method is borrowing the resource for the duration of the async call?</p>",
        "id": 567631998,
        "sender_full_name": "Luke Wagner",
        "timestamp": 1768247959
    },
    {
        "content": "<p>Oh, true! I was referring additionally to the component iteslf (I think I crossed some wires here), but the component has to stay alive for <code>async</code> functions where for a sync function you could get your component out of the way entirely</p>",
        "id": 567632158,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1768248010
    },
    {
        "content": "<p>whether that matters, however, is probably to a much lesser degree</p>",
        "id": 567632190,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1768248019
    },
    {
        "content": "<p>(More specifically, \"forget\" means \"drop the resource or transfer to another component (which might drop it immediately, you don't know)\".)</p>",
        "id": 567632199,
        "sender_full_name": "Luke Wagner",
        "timestamp": 1768248022
    },
    {
        "content": "<p>FWIW, in a future with runtime-instantiation (where this does come up again), \"resource-ifying\" a component will \"resource-ify\" the <code>interface</code>s exported by the component, turning free functions into methods of the instance-resource.  But in this case, I think we actually need the \"child\" semantics because if the component-instance gets destroyed, it'll delete the actual implementation of the stream consumer (e.g., its linear memory state), so we can't be firing-and-forgetting.</p>",
        "id": 567633330,
        "sender_full_name": "Luke Wagner",
        "timestamp": 1768248342
    },
    {
        "content": "<p>depends on the implementation(?). If it uses reference counting, the component instance can stay until all its resources have been dropped</p>",
        "id": 567634093,
        "sender_full_name": "Dave Bakker (badeend)",
        "timestamp": 1768248569
    },
    {
        "content": "<p>the WASI 0.3 interfaces have moved away from parent-&gt;child resource traps</p>",
        "id": 567634492,
        "sender_full_name": "Dave Bakker (badeend)",
        "timestamp": 1768248680
    },
    {
        "content": "<p>Good point!  This depends on how things get specified, but I was thinking that <code>resource.drop</code> would synchronously destroy the component instance (so that way resources are freed when you think they are (and if they can't, b/c you have \"dangling\" handles, you trap).  Anyhow, farther future topic</p>",
        "id": 567634533,
        "sender_full_name": "Luke Wagner",
        "timestamp": 1768248690
    },
    {
        "content": "<blockquote>\n<p>the WASI 0.3 interfaces have moved away from parent-&gt;child resource traps</p>\n</blockquote>\n<p>True, but that's due to the lack of a <code>child</code> annotation in WIT that allows bindings generators (specifically of GC languages) to do the thing they need to do to avoid the trap.</p>",
        "id": 567634752,
        "sender_full_name": "Luke Wagner",
        "timestamp": 1768248753
    },
    {
        "content": "<p>There is a somewhat orthogonal vector to all of this where what <span class=\"user-mention\" data-user-id=\"378155\">@Dave Bakker (badeend)</span> you're doing is not pleasant with the default Rust bindings, so e.g. ergonomically we could in theory try to improve things without actually changing WITs</p>",
        "id": 567643350,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1768251962
    },
    {
        "content": "<p>one example is that changing <code>write-via-stream</code>, which doesn't have resources involved, would actually probably be nice from a rust ergonomics perspective where it's easier to deal with concrete types rather than futures</p>",
        "id": 567643449,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1768251994
    },
    {
        "content": "<p>but I wouldn't want rust ergonomics alone to guide decisions of API design in WASI of course</p>",
        "id": 567643506,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1768252018
    },
    {
        "content": "<p>A concrete type instead of <code>impl Future</code> could help with ergonomics and is indeed a Rust-specific thing.<br>\nThe issue at hand is about lifetimes though, and those are a consequence of the WIT signature.<br>\nUnless I'm misunderstanding what you're suggesting</p>",
        "id": 567644702,
        "sender_full_name": "Dave Bakker (badeend)",
        "timestamp": 1768252496
    },
    {
        "content": "<p>oh sorry, I'm apparently a bit scatterbrained. I'm assuming, yes, we'll remove <code>async</code> from resource methods in WASI resources, and a general WASI principle will be no <code>async</code> methods without a good reason. That leaves <code>write-via-stream</code> for stdio, however, which is still <code>async</code>. Using that in the Rust standard library is probably going to be easier if it returned a WIT future as opposed to a Rust <code>impl Future</code>. </p>\n<p>Although that being said libstd is probably going to use stdio through libc, so you can probably just ignore my musing</p>",
        "id": 567645001,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1768252647
    },
    {
        "content": "<p>FWIW, my PR turns <code>write-via-stream</code> non-async as well.<br>\nBut I've lost track in this chat whether the consensus is if that is a good thing or a bad thing</p>",
        "id": 567645711,
        "sender_full_name": "Dave Bakker (badeend)",
        "timestamp": 1768252987
    },
    {
        "content": "<p>I believe consensus is: it's not necessary, but for rust ergonomics it may be nice</p>",
        "id": 567645776,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1768253014
    },
    {
        "content": "<p>but this logic applies to all <code>async</code> functions everywhere, so I'm not sure if we should follow through with that</p>",
        "id": 567645812,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1768253035
    },
    {
        "content": "<p>Also, to provide an entire counterpoint to this, it's kind of nice that the component model guarantees you can't close the resource while there's an active async method running on it. That way implementations don't have to handle the question of \"someone called write, then closed the resource, what do I do?\"</p>",
        "id": 567645926,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1768253085
    },
    {
        "content": "<p>Agree. Although that doesn't extrapolate to the read side, where the stream is returned opposed to consumed</p>",
        "id": 567646658,
        "sender_full_name": "Dave Bakker (badeend)",
        "timestamp": 1768253369
    },
    {
        "content": "<p>good point yeah</p>",
        "id": 567646726,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1768253394
    },
    {
        "content": "<p>changing all resource methods to not be <code>async</code> I believe would require updating quite a lot of <code>wasi:filesystem/types.descriptor</code> functions too, but I'm also less sure that's a good idea</p>",
        "id": 567646809,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1768253425
    }
]
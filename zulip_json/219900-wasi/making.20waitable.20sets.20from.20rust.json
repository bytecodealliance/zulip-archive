[
    {
        "content": "<p>Hello all :)</p>\n<p>I would like to write a simple test to make a couple of async calls to <code>monotonic-clock#wait_for</code>, and wait for the first one that returns.  On the low level I want to make a <code>waitable-set</code> and then <code>waitable-set.join</code> the two futures together; I assume an async function returns a future but perhaps that is a misconception.  Anyway I am having trouble finding how <code>waitable-set.join</code> is mapped into rust and wit-bindgen.  What's up?</p>",
        "id": 536193758,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1756200138
    },
    {
        "content": "<p>/me summons <span class=\"user-mention\" data-user-id=\"234973\">@Till Schneidereit</span></p>",
        "id": 536194013,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1756200227
    },
    {
        "content": "<p>it would seem that I can add a dep on <code>wit-bindgen-rt</code>, which has a WaitableSet binding, but it appears to be private; dunno what is going on</p>",
        "id": 536196328,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1756200868
    },
    {
        "content": "<p>I'm no expert on this by any means, but I think <a href=\"https://github.com/bytecodealliance/wit-bindgen/blob/7bb0545e294753b6275d275c7279e1f0d2daa93e/tests/runtime-async/async/ping-pong/runner.rs\">this test</a> shows how to use <code>futures::join</code> to do this?</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wit-bindgen/blob/7bb0545e294753b6275d275c7279e1f0d2daa93e/tests/runtime-async/async/ping-pong/runner.rs\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/cf83c2f0888848680587089f0155ecba6b844c15/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f393237643262353862343562336431376366343764643564613135313334623763633534326637373161616133353561653461653537646661393063383736352f62797465636f6465616c6c69616e63652f7769742d62696e6467656e&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wit-bindgen/blob/7bb0545e294753b6275d275c7279e1f0d2daa93e/tests/runtime-async/async/ping-pong/runner.rs\" title=\"wit-bindgen/tests/runtime-async/async/ping-pong/runner.rs at 7bb0545e294753b6275d275c7279e1f0d2daa93e · bytecodealliance/wit-bindgen\">wit-bindgen/tests/runtime-async/async/ping-pong/runner.rs at 7bb0545e294753b6275d275c7279e1f0d2daa93e · bytecodealliance/wit-bindgen</a></div><div class=\"message_embed_description\">A language binding generator for WebAssembly interface types - bytecodealliance/wit-bindgen</div></div></div>",
        "id": 536198949,
        "sender_full_name": "Till Schneidereit",
        "timestamp": 1756201465
    },
    {
        "content": "<p>with the <code>runner.rs</code> files in the other async tests having examples, too</p>",
        "id": 536199167,
        "sender_full_name": "Till Schneidereit",
        "timestamp": 1756201535
    },
    {
        "content": "<p>waitable-set.join is more like adding an fd to an epoll set</p>",
        "id": 536201969,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1756202547
    },
    {
        "content": "<p>it's not the actual operation to wait on the epollfd</p>",
        "id": 536202032,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1756202565
    },
    {
        "content": "<p>but this points me in what is probably the right direction, i will see if i can futures::select_biased over a couple of async results</p>",
        "id": 536202127,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1756202598
    },
    {
        "content": "<p><code>join</code> isn't the actual wait operation either, but as I said: I'm by no means an expert on this. <span class=\"user-mention\" data-user-id=\"484032\">@Roman Volosatovs</span> might be around and know, otherwise <span class=\"user-mention\" data-user-id=\"253994\">@Alex Crichton</span> and <span class=\"user-mention\" data-user-id=\"509936\">@Joel Dice</span> would certainly know, but won't be awake for another few hours</p>",
        "id": 536202463,
        "sender_full_name": "Till Schneidereit",
        "timestamp": 1756202716
    },
    {
        "content": "<p>/me lunch, biab</p>",
        "id": 536202725,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1756202810
    },
    {
        "content": "<p>If you are in \"Rust-land\", then you can treat <code>wait_for</code> just as a regular <code>async fn wait_for</code> in Rust, and treat the result value as a regular <a href=\"https://doc.rust-lang.org/std/future/trait.Future.html\">https://doc.rust-lang.org/std/future/trait.Future.html</a></p>\n<p>Perhaps this <code>wasi:clocks</code> test could serve as a good example <a href=\"https://github.com/bytecodealliance/wasmtime/blob/e767c56b824e5ce8947997b052859e050419d35b/crates/test-programs/src/bin/p3_clocks_sleep.rs\">https://github.com/bytecodealliance/wasmtime/blob/e767c56b824e5ce8947997b052859e050419d35b/crates/test-programs/src/bin/p3_clocks_sleep.rs</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/blob/e767c56b824e5ce8947997b052859e050419d35b/crates/test-programs/src/bin/p3_clocks_sleep.rs\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/f5c6b26ae3c7b19a9956340d23fa6d309da0e65c/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f653131346236353965353438316566323232373162656338333236343434386563653262656538376236653531656534393336346537623736356538313865662f62797465636f6465616c6c69616e63652f7761736d74696d65&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/blob/e767c56b824e5ce8947997b052859e050419d35b/crates/test-programs/src/bin/p3_clocks_sleep.rs\" title=\"wasmtime/crates/test-programs/src/bin/p3_clocks_sleep.rs at e767c56b824e5ce8947997b052859e050419d35b · bytecodealliance/wasmtime\">wasmtime/crates/test-programs/src/bin/p3_clocks_sleep.rs at e767c56b824e5ce8947997b052859e050419d35b · bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">A lightweight WebAssembly runtime that is fast, secure, and standards-compliant - bytecodealliance/wasmtime</div></div></div>",
        "id": 536206802,
        "sender_full_name": "Roman Volosatovs",
        "timestamp": 1756204583
    },
    {
        "content": "<p>so <code>futures::select_biased</code> should work just fine (and if it does not - that's a bug we should fix)</p>",
        "id": 536206956,
        "sender_full_name": "Roman Volosatovs",
        "timestamp": 1756204642
    },
    {
        "content": "<p>neat, our tests are similar <a href=\"https://github.com/WebAssembly/wasi-testsuite/pull/120/files#diff-0308e5f25267659be76c7a48f5e83bed5a6258d013f20502300ef18c72411407\">https://github.com/WebAssembly/wasi-testsuite/pull/120/files#diff-0308e5f25267659be76c7a48f5e83bed5a6258d013f20502300ef18c72411407</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/WebAssembly/wasi-testsuite/pull/120/files#diff-0308e5f25267659be76c7a48f5e83bed5a6258d013f20502300ef18c72411407\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/55070b6e630dcd45f2cd4d3959a1b359a5428dbe/68747470733a2f2f617661746172732e67697468756275736572636f6e74656e742e636f6d2f752f313734353930333f733d34303026763d34&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/WebAssembly/wasi-testsuite/pull/120/files#diff-0308e5f25267659be76c7a48f5e83bed5a6258d013f20502300ef18c72411407\" title=\"First wasip3 test by wingo · Pull Request #120 · WebAssembly/wasi-testsuite\">First wasip3 test by wingo · Pull Request #120 · WebAssembly/wasi-testsuite</a></div><div class=\"message_embed_description\">Depends on #114.  Adds wasm32-wasip3 Rust test directory, with a first Rust-based test.  Test runner not yet updated; requires passing Wcomponent-model-async=y -Sp3=y to wasmtime.  Building the was...</div></div></div>",
        "id": 536224367,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1756211010
    },
    {
        "content": "<p>what i am interested in testing tho is when there are multiple futures outstanding</p>",
        "id": 536224526,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1756211060
    },
    {
        "content": "<p>Keep in mind you can always bypass <code>wit-bindgen-rt</code>'s abstractions and import and call the intrinsics directly.  We do that <a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/crates/test-programs/src/bin/async_intertask_communication.rs\">here</a> and <a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/crates/test-programs/src/async_.rs\">here</a>, for example.</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/blob/main/crates/test-programs/src/bin/async_intertask_communication.rs\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/f5c6b26ae3c7b19a9956340d23fa6d309da0e65c/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f653131346236353965353438316566323232373162656338333236343434386563653262656538376236653531656534393336346537623736356538313865662f62797465636f6465616c6c69616e63652f7761736d74696d65&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/crates/test-programs/src/bin/async_intertask_communication.rs\" title=\"wasmtime/crates/test-programs/src/bin/async_intertask_communication.rs at main · bytecodealliance/wasmtime\">wasmtime/crates/test-programs/src/bin/async_intertask_communication.rs at main · bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">A lightweight WebAssembly runtime that is fast, secure, and standards-compliant - bytecodealliance/wasmtime</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/blob/main/crates/test-programs/src/async_.rs\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/f5c6b26ae3c7b19a9956340d23fa6d309da0e65c/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f653131346236353965353438316566323232373162656338333236343434386563653262656538376236653531656534393336346537623736356538313865662f62797465636f6465616c6c69616e63652f7761736d74696d65&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/crates/test-programs/src/async_.rs\" title=\"wasmtime/crates/test-programs/src/async_.rs at main · bytecodealliance/wasmtime\">wasmtime/crates/test-programs/src/async_.rs at main · bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">A lightweight WebAssembly runtime that is fast, secure, and standards-compliant - bytecodealliance/wasmtime</div></div></div>",
        "id": 536233331,
        "sender_full_name": "Joel Dice",
        "timestamp": 1756213814
    },
    {
        "content": "<p>oh that's very funny, thank you for that</p>",
        "id": 536233567,
        "sender_full_name": "Andy Wingo",
        "timestamp": 1756213884
    },
    {
        "content": "<p>Part of this is where it's kind of hard to figure out what exactly you're testing. For example right now you're moreso testing tooling like <code>wasm-component-ld</code> than you're testing the raw component model (e.g. writing source code that's compiled vs writing <code>*.wast</code>). When writing Rust you're more testing the bindings in the <code>wit-bindgen</code> crate than the async intrinsics themselves.</p>\n<p>Given that I feel like the best answer here is \"what are you trying to test\" which lends itself to an answer of how to test it. For example:</p>\n<ul>\n<li>When testing \"shapes\" of a component or raw intrinsics, it can be useful to use <code>*.wast</code> or <code>*.wat</code></li>\n<li>When testing a raw intrinsic, but in the context of something else more complicated, it might be mostly useful to use C which has a much more raw feeling than Rust. This will rely more on <code>wit-bindgen</code> and <code>wasm-component-ld</code>, however.</li>\n<li>When testing high-level interactions I'd recommend Rust because it's far easier to read/write tests using <code>async</code></li>\n</ul>",
        "id": 536250312,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1756218548
    },
    {
        "content": "<p>I realize though that not all of this is up-and-running as of this red hot second, but it's things where I would personally say it's best to avoid raw definitions of APIs where you can because that's technically an \"unstable layer\" which is yet more we'd have to change if we ever tweak it (vs just changing the bindings generator)</p>",
        "id": 536250468,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1756218588
    },
    {
        "content": "<p>It's sufficient, but a case where C may be better suited for example</p>",
        "id": 536250535,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1756218604
    }
]
[
    {
        "content": "<p>Hi,</p>\n<p>It looks like wasmtime's implementation of <code>pwritev()</code>, in both preview1 and the preview1 component adapter, only writes one of the vectors even when more than one non-empty vector is provided:</p>\n<p><a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasi-preview1-component-adapter/src/lib.rs#L1201\">https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasi-preview1-component-adapter/src/lib.rs#L1201</a> (there's even a comment saying \"Skip leading non-empty buffers\", though not why)</p>\n<p>and</p>\n<p><a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasi/src/preview1.rs#L580\">https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasi/src/preview1.rs#L580</a></p>\n<p>As far as I know, the semantics of <code>pwritev()</code> is that all the buffers should be written to the file.</p>\n<p>Is this a bug or deliberate?</p>\n<p>Thanks,<br>\nTim</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasi-preview1-component-adapter/src/lib.rs#L1201\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/581fd4d5bced9b3c38eae4afc04c47b3531147c5/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f613736373238396635343033633961613565636136363835636638626666636666333936336661643637336534623031656637366639333738356334613366352f62797465636f6465616c6c69616e63652f7761736d74696d65&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasi-preview1-component-adapter/src/lib.rs#L1201\" title=\"wasmtime/crates/wasi-preview1-component-adapter/src/lib.rs at main · bytecodealliance/wasmtime\">wasmtime/crates/wasi-preview1-component-adapter/src/lib.rs at main · bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">A lightweight WebAssembly runtime that is fast, secure, and standards-compliant - bytecodealliance/wasmtime</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasi/src/preview1.rs#L580\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/581fd4d5bced9b3c38eae4afc04c47b3531147c5/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f613736373238396635343033633961613565636136363835636638626666636666333936336661643637336534623031656637366639333738356334613366352f62797465636f6465616c6c69616e63652f7761736d74696d65&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/crates/wasi/src/preview1.rs#L580\" title=\"wasmtime/crates/wasi/src/preview1.rs at main · bytecodealliance/wasmtime\">wasmtime/crates/wasi/src/preview1.rs at main · bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">A lightweight WebAssembly runtime that is fast, secure, and standards-compliant - bytecodealliance/wasmtime</div></div></div>",
        "id": 532771635,
        "sender_full_name": "Tim Chevalier",
        "timestamp": 1754329497
    },
    {
        "content": "<blockquote>\n<p>As far as I know, the semantics of <code>pwritev()</code> is that all the buffers should be written to the file.</p>\n</blockquote>\n<p>I don't think that's right. AFAIK, writes are always allowed to return less than requested.</p>",
        "id": 532772883,
        "sender_full_name": "Dave Bakker (badeend)",
        "timestamp": 1754330011
    },
    {
        "content": "<p>The man pages don't describe any such requirement either.</p>",
        "id": 532773323,
        "sender_full_name": "Dave Bakker (badeend)",
        "timestamp": 1754330159
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"378155\">@Dave Bakker (badeend)</span> You're right -- but it still seems strange to me for the implementation to _always_ return less than requested.</p>",
        "id": 532774737,
        "sender_full_name": "Tim Chevalier",
        "timestamp": 1754330810
    },
    {
        "content": "<p>The adapter currently translates 1 \"syscall\" from the guest into 1 syscall on the host, and doesn't attempt to abstract over the mismatch.</p>\n<p>Maybe atomicity might play a role here. If the adapter were to issue writes in a loop, the whole <code>pwritev</code> call from the guest's POV wouldn't be atomic anymore.<br>\nLinux' docs mention:</p>\n<blockquote>\n<p>the data written by writev() is written as a single block that is not intermingled with output from writes in other processes</p>\n</blockquote>\n<p>But can't say for sure if this was the actual reason nor if atomicity is even a requirement for WASI. I wasn't involved in this code.</p>",
        "id": 532775847,
        "sender_full_name": "Dave Bakker (badeend)",
        "timestamp": 1754331384
    },
    {
        "content": "<p>im searching for anywhere we wrote down reasoning for that behavior</p>",
        "id": 532977233,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1754422017
    },
    {
        "content": "<p>i found <a href=\"https://github.com/bytecodealliance/wasmtime/issues/7830\">https://github.com/bytecodealliance/wasmtime/issues/7830</a> which affirms it is the way it is because the manpage permits it</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/issues/7830\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/4847304a0f44746b0ce8c00b34dd8796fe37e2c8/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f316366633738623236633036636331643563383737303330653630626566333864323835623836396662616363323936386666343962336265336330326638322f62797465636f6465616c6c69616e63652f7761736d74696d652f6973737565732f37383330&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/issues/7830\" title=\"POSIX `readv()`/`preadv()`/`writev()`/`pwritev()` do not use all buffers under preview 2 (as found by Python) · Issue #7830 · bytecodealliance/wasmtime\">POSIX `readv()`/`preadv()`/`writev()`/`pwritev()` do not use all buffers under preview 2 (as found by Python) · Issue #7830 · bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">Test Case TODO: upload Wasm file here Steps to Reproduce https://github.com/python/cpython/blob/07236f5b39a2e534cf190cd4f7c73300d209520b/Lib/test/test_posix.py#L520-L525 https://github.com/python/c...</div></div></div>",
        "id": 532977268,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1754422029
    },
    {
        "content": "<p>I can imagine that atomicity was the reason, but I don't know if that reason is well enough motivated that we should keep the behavior or not</p>",
        "id": 532977379,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1754422087
    },
    {
        "content": "<p>I suspect <span class=\"user-mention\" data-user-id=\"254083\">@Dan Gohman</span> is the one who remembers best</p>",
        "id": 532977430,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1754422114
    },
    {
        "content": "<p>It would make sense if atomicity was the reason. The only way I can think of to implement the operations without underlying support in wasip2 would be to copy all the buffers into a single buffer -- but then, that probably wouldn't be what you want if you're concerned about performance enough to use these operations.</p>",
        "id": 532977851,
        "sender_full_name": "Tim Chevalier",
        "timestamp": 1754422319
    },
    {
        "content": "<p>making a copy of all the buffers into a single contiguous buffer is basically just off the table, too expensive</p>",
        "id": 532978980,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1754422776
    },
    {
        "content": "<p>so it really comes down to, do we just write the first buffer, or do we attempt to iterate through all of them</p>",
        "id": 532979047,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1754422810
    },
    {
        "content": "<p>There's more discussion as well at <a href=\"https://github.com/bytecodealliance/wasmtime/issues/8037\">https://github.com/bytecodealliance/wasmtime/issues/8037</a> and <a href=\"https://github.com/bytecodealliance/wasmtime/pull/8072\">https://github.com/bytecodealliance/wasmtime/pull/8072</a>. Personally I've also been one advocating for \"it's ok to pick just one buffer\" for the reason of atomicity.</p>\n<p>This clearly is a common papercut though that hits folks though. My assumption is that most folks are doing small \"hello world\"-style things where it's unreasonable to expect a \"real\" implementation which would check the return value and loop over the result (e.g. writing raw <code>*.wat</code>). In such a context it might be reasonable to see that if multiple vectors were passed and the total size is less than some small threshold (e.g. 512 bytes) we could copy it to the host and do the write</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/issues/8037\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/9c5c858f5c33a8b8af33b73cef2fbc77a9dc7060/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f656262343838613738373566376263323135353939356538326433666365363936653139613566363434373766356331626531366663363930396165313065322f62797465636f6465616c6c69616e63652f7761736d74696d652f6973737565732f38303337&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/issues/8037\" title=\"fd_write ignores iovs_len &gt; 1 · Issue #8037 · bytecodealliance/wasmtime\">fd_write ignores iovs_len &gt; 1 · Issue #8037 · bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">Am I crazy? I thought I might be misunderstanding something, but then I found someone else's example online that also doesn't work. Test Case ;; hello.wat (module ;; define the expected type for fd...</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/pull/8072\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/b7875502bb654476af891bca47f6af410aa4c9c9/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f613664346430373330396666383931346537366133373939303863663434633734613330353733643235393732316363393336623961326133393666656535652f62797465636f6465616c6c69616e63652f7761736d74696d652f70756c6c2f38303732&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/pull/8072\" title=\"Write all iovs in fd_write of wasi-preview1-component-adapter by ospencer · Pull Request #8072 · bytecodealliance/wasmtime\">Write all iovs in fd_write of wasi-preview1-component-adapter by ospencer · Pull Request #8072 · bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">I noticed that the implementation of fd_write in the preview1 adapter only writes the first iov in the list passed. This change writes all of them. I&#39;m happy to add a test for this, though I co...</div></div></div>",
        "id": 532982475,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1754424245
    }
]
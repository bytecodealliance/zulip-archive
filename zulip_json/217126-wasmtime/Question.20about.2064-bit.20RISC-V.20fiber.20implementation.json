[
    {
        "content": "<p>While working on a fiber implementation for 32-bit RISC-V, we noticed that the <a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/crates/fiber/src/stackswitch/riscv64.rs\">implementation for 64-bit RISC-V</a> uses instructions specific to the F extension, which includes additional registers for floating point values, regardless whether the CPU has the extension or not.</p>\n<p>When using an analogous implementation for a 32-bit RISC-V processor without the F extension, execution stops at the first F-specific instruction without an error (we assume a trap handler is activated). We do not have a 64-bit RISC-V chip without the F-extension to test this with, but we assume it would show the same behaviour.</p>\n<p>For our implementation for 32-bit RISC-V, we plan on solving this by checking for the <code>target_feature</code> in addition to the <code>target_arch</code> and only select the implementation if both match the implementation (see the version of <a href=\"http://stackswitch.rs\">stackswitch.rs</a> in <a href=\"https://github.com/COLORADIO-Project/wasmtime/commit/170042df9834eabb5365d3411e821239c5ce8e5f\">our fork</a>).</p>\n<p>We're wondering whether the 64-bit RISC-V implementation being used regardless of the F extension being present on the target CPU actually is a bug or is there something we're missing/misunderstanding?</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/blob/main/crates/fiber/src/stackswitch/riscv64.rs\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/5ad98427f169338af92e8e5daa989e36ca88f70b/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f353033653039373539383334363562646435346139636361346236333832356232373730373264656138313638366562326362393430613632333734373664662f62797465636f6465616c6c69616e63652f7761736d74696d65&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/blob/main/crates/fiber/src/stackswitch/riscv64.rs\" title=\"wasmtime/crates/fiber/src/stackswitch/riscv64.rs at main · bytecodealliance/wasmtime\">wasmtime/crates/fiber/src/stackswitch/riscv64.rs at main · bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">A lightweight WebAssembly runtime that is fast, secure, and standards-compliant - bytecodealliance/wasmtime</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/COLORADIO-Project/wasmtime/commit/170042df9834eabb5365d3411e821239c5ce8e5f\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/a2c8fcac38008d503c14acc5aec3ef9820259181/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f656539346532363938376165323734626535646434613563323337383164353338356334363664653430373835336366613635646632323465336232373661662f434f4c4f524144494f2d50726f6a6563742f7761736d74696d652f636f6d6d69742f31373030343264663938333465616262353336356433343131653832313233396335636538653566&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/COLORADIO-Project/wasmtime/commit/170042df9834eabb5365d3411e821239c5ce8e5f\" title=\"Added fiber implementation for riscv32 · COLORADIO-Project/wasmtime@170042d\">Added fiber implementation for riscv32 · COLORADIO-Project/wasmtime@170042d</a></div><div class=\"message_embed_description\">A lightweight WebAssembly runtime that is fast, secure, and standards-compliant - Added fiber implementation for riscv32 · COLORADIO-Project/wasmtime@170042d</div></div></div>",
        "id": 571086496,
        "sender_full_name": "Max D.",
        "timestamp": 1769794167
    },
    {
        "content": "<p>The riscv64 port targets riscv64gc, which includes F (and D); these are required for the code that we generate on that platform</p>",
        "id": 571087731,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1769794528
    },
    {
        "content": "<p>(and the code that rustc will compile since we build with <code>riscv64gc-unknown-linux-gnu</code>)</p>",
        "id": 571087796,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1769794543
    },
    {
        "content": "<p>You'll need to either do some sort of dynamic feature detection if you want to work on riscv32imac (for example), or build fully for an FPU-free environment</p>",
        "id": 571087996,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1769794605
    },
    {
        "content": "<p>Rustc only has a baremetal riscv64imac target (Linux requires full gc support and other OSes probably do too). For baremetal targets wasmtime doesn't use fibers at all.</p>",
        "id": 571510490,
        "sender_full_name": "bjorn3",
        "timestamp": 1770060948
    },
    {
        "content": "<p>It's perhaps not intended but fibers (as in wasmtime-fiber and the <code>async</code> feature of wasmtime) do work on baremetal ARM Thumbv7/Thumbv8 targets</p>",
        "id": 571513344,
        "sender_full_name": "Antoine Lavandier",
        "timestamp": 1770061957
    },
    {
        "content": "<p>indeed, fibers do work in a <code>no_std</code> build and that's intended -- I added that a bit ago for our <code>no_std</code> x86-64 embedding</p>",
        "id": 571514016,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1770062234
    },
    {
        "content": "<p>Thanks for the clarifications!</p>\n<p>Quick sanity check about your messages, <span class=\"user-mention\" data-user-id=\"254389\">@Chris Fallin</span>:<br>\nSo there does not need to be a check for the features in <code>stackswitch.rs</code> because wasmtime only supports riscv64gc.<br>\nFor the riscv32 implementation, this means we also only need to check for the riscv32 architecture, because only riscv32imac is supported by wasmtime.</p>\n<p>Do we understand your comments correctly?</p>",
        "id": 571717569,
        "sender_full_name": "Max D.",
        "timestamp": 1770138510
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"1015286\">Max D.</span> <a href=\"#narrow/channel/217126-wasmtime/topic/Question.20about.2064-bit.20RISC-V.20fiber.20implementation/near/571717569\">said</a>:</p>\n<blockquote>\n<p>For the riscv32 implementation, this means we also only need to check for the riscv32 architecture, because only riscv32imac is supported by wasmtime.</p>\n</blockquote>\n<p>Well, no, not quite; I never said that Wasmtime supports only <code>riscv32imac</code>. In fact (with Pulley) it should run fine (without async/fibers) on all sorts of riscv32 platforms, whatever is supported by rustc.</p>\n<p>I would expect that we'd need some sort of feature detection to select between different fiber-switching assembly sequences for different variants...</p>",
        "id": 571718647,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1770138793
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"254389\">Chris Fallin</span> <a href=\"#narrow/channel/217126-wasmtime/topic/Question.20about.2064-bit.20RISC-V.20fiber.20implementation/near/571718647\">said</a>:</p>\n<blockquote>\n<p>I never said that Wasmtime supports only <code>riscv32imac</code>.</p>\n</blockquote>\n<p>Oh, sorry, we got that from the <a href=\"https://docs.wasmtime.dev/stability-tiers.html#tiers-of-support-in-wasmtime\">documentation</a>, which we forgot to link. Our implementation only uses instructions from <code>riscv32i</code>, so it should work for any architecture without additional registers, which to our knowledge just means the <code>f</code> and <code>v</code> extensions cannot be present (as the <code>d</code> extension implies the <code>f</code> extension being present).</p>\n<blockquote>\n<p>I would expect that we'd need some sort of feature detection to select between different fiber-switching assembly sequences for different variants...</p>\n</blockquote>\n<p>If our assumptions above are correct, the implementation in <a href=\"https://github.com/bytecodealliance/wasmtime/compare/release-38.0.0...COLORADIO-Project:wasmtime:release-38.0.0\">our fork</a> should do this by only using our implementation if <code>target_arch</code> is <code>riscv32</code> and <code>target_feature</code> does not include <code>f</code> or <code>v</code>. Is this what you mean by feature detection?</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/compare/release-38.0.0...COLORADIO-Project:wasmtime:release-38.0.0\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/ab0d2ad021ad03b8501550aa546c104f842aeea9/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f643738376638646131626235373765613864643361356431616337386566646530663462396331353363386633383132353966333231353730366139663661392f62797465636f6465616c6c69616e63652f7761736d74696d65&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/compare/release-38.0.0...COLORADIO-Project:wasmtime:release-38.0.0\" title=\"Comparing bytecodealliance:release-38.0.0...COLORADIO-Project:release-38.0.0 · bytecodealliance/wasmtime\">Comparing bytecodealliance:release-38.0.0...COLORADIO-Project:release-38.0.0 · bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">A lightweight WebAssembly runtime that is fast, secure, and standards-compliant - Comparing bytecodealliance:release-38.0.0...COLORADIO-Project:release-38.0.0 · bytecodealliance/wasmtime</div></div></div>",
        "id": 571726185,
        "sender_full_name": "Max D.",
        "timestamp": 1770141025
    },
    {
        "content": "<p>Feature-detection-wise yeah you'll want to be using <code>cfg(target_feature = \"...\")</code> in Rust. In theory it would be best to do runtime feature detection but that's not really suitable given the low-level nature of this crate.</p>",
        "id": 571727003,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1770141280
    },
    {
        "content": "<p>In theory what we'll want is something like <code>#[cfg(target_feature = \"f\")] compile_error!(\"this isn't ready for the \\\"f\\\" feature yet\");</code></p>",
        "id": 571727065,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1770141302
    },
    {
        "content": "<p>Ah, that's just the list of builds that we check I think, but we don't want to bake in any assumptions that riscv32 == riscv32imac. I think your compile-time feature checks there make sense; let's call the arch-specific file <code>riscv32imac.rs</code> or something more specific like that</p>",
        "id": 571727100,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1770141312
    },
    {
        "content": "<p>I'll note though that rustc hasn't stabilized all risc-v features, so for example even the <code>riscv64gc</code> target looks like it has \"f\" disabled</p>",
        "id": 571727394,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1770141384
    },
    {
        "content": "<p>in the sense that <code>cfg(target_feature = \"f\")</code> isn't set</p>",
        "id": 571727430,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1770141393
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"253994\">Alex Crichton</span> <a href=\"#narrow/channel/217126-wasmtime/topic/Question.20about.2064-bit.20RISC-V.20fiber.20implementation/near/571727394\">said</a>:</p>\n<blockquote>\n<p>I'll note though that rustc hasn't stabilized all risc-v features, so for example even the <code>riscv64gc</code> target looks like it has \"f\" disabled</p>\n</blockquote>\n<p>that's... extremely odd and sounds like a bug? egads</p>",
        "id": 571727510,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1770141420
    },
    {
        "content": "<p>I don't think this is a situation we can be 100% sound right now -- with a combination of rustc not exposing features to us and there being no reasonable path to runtime feature detection all we can do is try our best to provide guard rails</p>",
        "id": 571727553,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1770141429
    },
    {
        "content": "<p>It's not a bug per se, it's that the <code>\"f\"</code> target feature name in rust isn't stable</p>",
        "id": 571727621,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1770141448
    },
    {
        "content": "<p>ah, gotcha</p>",
        "id": 571727649,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1770141457
    },
    {
        "content": "<p>for example <a href=\"https://github.com/rust-lang/rust/blob/79a1e77fe34b70de8b9b9e7c44ff251003b70aaf/compiler/rustc_target/src/target_features.rs#L608\">this is stable rust right now</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/rust-lang/rust/blob/79a1e77fe34b70de8b9b9e7c44ff251003b70aaf/compiler/rustc_target/src/target_features.rs#L608\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/4fe03cc698a4e4ab4df388142eb8499faa64e251/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f626661343338353632626138343835353934326335376134373439366632313731393432666263643635663635623937616637356134366663656361383131302f727573742d6c616e672f72757374&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/rust-lang/rust/blob/79a1e77fe34b70de8b9b9e7c44ff251003b70aaf/compiler/rustc_target/src/target_features.rs#L608\" title=\"rust/compiler/rustc_target/src/target_features.rs at 79a1e77fe34b70de8b9b9e7c44ff251003b70aaf · rust-lang/rust\">rust/compiler/rustc_target/src/target_features.rs at 79a1e77fe34b70de8b9b9e7c44ff251003b70aaf · rust-lang/rust</a></div><div class=\"message_embed_description\">Empowering everyone to build reliable and efficient software. - rust-lang/rust</div></div></div>",
        "id": 571727830,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1770141514
    },
    {
        "content": "<p>and on <a href=\"https://github.com/rust-lang/rust/blob/55407b8cdb1457c62e0c852f5b53a9cf63ec4e1b/compiler/rustc_target/src/target_features.rs#L608\">current <code>main</code> it's still unstable</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/rust-lang/rust/blob/55407b8cdb1457c62e0c852f5b53a9cf63ec4e1b/compiler/rustc_target/src/target_features.rs#L608\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/4fe03cc698a4e4ab4df388142eb8499faa64e251/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f626661343338353632626138343835353934326335376134373439366632313731393432666263643635663635623937616637356134366663656361383131302f727573742d6c616e672f72757374&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/rust-lang/rust/blob/55407b8cdb1457c62e0c852f5b53a9cf63ec4e1b/compiler/rustc_target/src/target_features.rs#L608\" title=\"rust/compiler/rustc_target/src/target_features.rs at 55407b8cdb1457c62e0c852f5b53a9cf63ec4e1b · rust-lang/rust\">rust/compiler/rustc_target/src/target_features.rs at 55407b8cdb1457c62e0c852f5b53a9cf63ec4e1b · rust-lang/rust</a></div><div class=\"message_embed_description\">Empowering everyone to build reliable and efficient software. - rust-lang/rust</div></div></div>",
        "id": 571727903,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1770141537
    },
    {
        "content": "<p>another way to put what I'm saying, <span class=\"user-mention\" data-user-id=\"1015286\">@Max D.</span> feel free to send a PR with what you have. I don't think it's currently possible to be 100% correct on riscv32 at this time. We'll just have to document that riscv32 for wasmtime is incompatible with floats and that's the best we can do</p>",
        "id": 571728084,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1770141592
    },
    {
        "content": "<p>Thanks a lot again for your help! We've cleaned up our git history and created a pull request on GitHub: <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12506\">https://github.com/bytecodealliance/wasmtime/pull/12506</a></p>\n<p>Looking forward to any feedback on this!</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/pull/12506\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/ab3b68345e39103eba8dc1bfe53bcb3ac12e6781/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f663539353936396133356531616232376532313331386231653233313261613266316632323735303234643835383235376637653066376438303565643461622f62797465636f6465616c6c69616e63652f7761736d74696d652f70756c6c2f3132353036&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/pull/12506\" title=\"Add fiber implementation for riscv32imac by max-dau · Pull Request #12506 · bytecodealliance/wasmtime\">Add fiber implementation for riscv32imac by max-dau · Pull Request #12506 · bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">This adds an implementation for riscv32imac (and other architectures with identical registers) to the internal fiber crate. This enables usage of the async feature of wasmtime on such platforms.\nTh...</div></div></div>",
        "id": 571743826,
        "sender_full_name": "Max D.",
        "timestamp": 1770146551
    }
]
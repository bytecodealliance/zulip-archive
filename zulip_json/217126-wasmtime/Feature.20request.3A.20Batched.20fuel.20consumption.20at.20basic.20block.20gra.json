[
    {
        "content": "<p>Hello! I am working on my own virtual machine and have a question about how fuel consumption is currently implemented and a feature request regarding the same.</p>\n<p>From my research I understand that:</p>\n<ul>\n<li>Fuel <strong>checks</strong> happen at control flow boundaries (function entry, loop headers)</li>\n<li>Fuel <strong>consumption</strong> happens per WebAssembly operator (most operators consume 1 unit)</li>\n<li>This per-operator consumption creates performance overhead</li>\n</ul>\n<p>I would prefer if something like this could be implemented in wasmtime:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"c1\">// Instead of:</span>\n<span class=\"n\">instruction_1</span>\n<span class=\"w\">  </span><span class=\"n\">consume_fuel</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n<span class=\"n\">instruction_2</span>\n<span class=\"w\">  </span><span class=\"n\">consume_fuel</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n<span class=\"n\">instruction_3</span>\n<span class=\"w\">  </span><span class=\"n\">consume_fuel</span><span class=\"p\">(</span><span class=\"mi\">1</span><span class=\"p\">)</span>\n\n<span class=\"c1\">// It would be better if it was something like:</span>\n<span class=\"n\">instruction_1</span>\n<span class=\"n\">instruction_2</span>\n<span class=\"n\">instruction_3</span>\n<span class=\"w\">  </span><span class=\"n\">consume_fuel</span><span class=\"p\">(</span><span class=\"mi\">3</span><span class=\"p\">)</span><span class=\"w\">  </span><span class=\"c1\">// Batch at end of basic block</span>\n</code></pre></div>\n<p>This would reduce the number of increment operations while still allowing fuel checks at control flow boundaries to interrupt execution when needed.</p>\n<h2>Questions</h2>\n<ol>\n<li>Is this kind of batched fuel consumption currently possible with any configuration?</li>\n<li>Has this been considered before? (I saw issue #4109 about \"slacked fuel metering\" but I'm not sure if that's the same thing)</li>\n<li>Would this be feasible to implement in Cranelift's code generation, or are there fundamental reasons why per-operator consumption is necessary?</li>\n</ol>",
        "id": 560898058,
        "sender_full_name": "Aarav Dayal",
        "timestamp": 1764407557
    },
    {
        "content": "<p>You may be interested in <a href=\"https://docs.wasmtime.dev/examples-interrupting-wasm.html\">epoch-based interruption</a>:</p>\n<blockquote>\n<p>Epoch-based interruption imposes relatively low overhead on Wasm execution; it has been measured at around a 10% slowdown. It is faster than fuel-based interruption.</p>\n</blockquote>",
        "id": 560929455,
        "sender_full_name": "Dave Bakker (badeend)",
        "timestamp": 1764435513
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"378155\">Dave Bakker (badeend)</span> <a href=\"#narrow/channel/217126-wasmtime/topic/Feature.20request.3A.20Batched.20fuel.20consumption.20at.20basic.20block.20gra/near/560929455\">said</a>:</p>\n<blockquote>\n<p>You may be interested in <a href=\"https://docs.wasmtime.dev/examples-interrupting-wasm.html\">epoch-based interruption</a>:</p>\n<blockquote>\n<p>Epoch-based interruption imposes relatively low overhead on Wasm execution; it has been measured at around a 10% slowdown. It is faster than fuel-based interruption.</p>\n</blockquote>\n</blockquote>\n<p>I am interested in deterministic fuel metering.</p>",
        "id": 560953481,
        "sender_full_name": "Aarav Dayal",
        "timestamp": 1764459465
    },
    {
        "content": "<p>I believe that this sort of batching is already implemented. The code looks like it's consume-per-op but IIRC it batches up the actual increment until some sort of side-effecting thing happens. Once a side-effecting thing happens though (e.g. loads/stores) for the determinism of fuel it needs to be flushed.</p>\n<p>Having a tunable option for ignoring side effecting ops other than control flow might be a possibility though</p>",
        "id": 560954712,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1764460842
    },
    {
        "content": "<p>Are you sure that wasmtime batches instruction <strong>increments</strong>?</p>",
        "id": 560955536,
        "sender_full_name": "Aarav Dayal",
        "timestamp": 1764461654
    }
]
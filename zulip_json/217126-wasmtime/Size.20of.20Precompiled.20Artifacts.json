[
    {
        "content": "<p>Hi,<br>\nIs there somewhere that documents what goes into the precompiled artifacts made by <code>Engine::precompile_module</code>. The difference in sizes between before and after precompilation can be pretty big, some examples I have go from 35KiB to 100 KiB and I'm wondering if there are ways to reduce this gap.<br>\nFor reference here's the config I'm using for precompilation </p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">    </span><span class=\"kd\">let</span><span class=\"w\"> </span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">config</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">Config</span><span class=\"p\">::</span><span class=\"n\">new</span><span class=\"p\">();</span>\n<span class=\"w\">    </span><span class=\"c1\">// Tell how the memory is expected to behave when instantiated</span>\n<span class=\"w\">    </span><span class=\"n\">config</span><span class=\"p\">.</span><span class=\"n\">memory_reservation</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">config</span><span class=\"p\">.</span><span class=\"n\">wasm_custom_page_sizes</span><span class=\"p\">(</span><span class=\"kc\">true</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">config</span><span class=\"p\">.</span><span class=\"n\">memory_may_move</span><span class=\"p\">(</span><span class=\"kc\">false</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">config</span><span class=\"p\">.</span><span class=\"n\">memory_init_cow</span><span class=\"p\">(</span><span class=\"kc\">false</span><span class=\"p\">);</span>\n\n<span class=\"w\">    </span><span class=\"c1\">// Optimize for Code size in the .cwasm</span>\n<span class=\"w\">    </span><span class=\"n\">config</span><span class=\"p\">.</span><span class=\"n\">cranelift_opt_level</span><span class=\"p\">(</span><span class=\"n\">wasmtime</span><span class=\"p\">::</span><span class=\"n\">OptLevel</span><span class=\"p\">::</span><span class=\"n\">SpeedAndSize</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">config</span><span class=\"p\">.</span><span class=\"n\">target</span><span class=\"p\">(</span><span class=\"s\">\"pulley32\"</span><span class=\"p\">)</span><span class=\"o\">?</span><span class=\"p\">;</span>\n</code></pre></div>",
        "id": 547508759,
        "sender_full_name": "Antoine Lavandier",
        "timestamp": 1761661718
    },
    {
        "content": "<p>One other big one is likely <a href=\"https://docs.rs/wasmtime/latest/wasmtime/struct.Config.html#method.generate_address_map\">disabling address map support</a></p>",
        "id": 547651969,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1761726068
    },
    {
        "content": "<p><a href=\"https://github.com/google/wasefire/issues/458#issuecomment-3189916340\">https://github.com/google/wasefire/issues/458#issuecomment-3189916340</a> is some dissection of the current size if you're curious for a similar/related project where binary sizes were important</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/google/wasefire/issues/458#issuecomment-3189916340\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/b12a2b74a9f8a4112a09fb204b1fccae7ff4ee1c/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f323533653363383037356535376364326634336635636233323066326634623261626437366466346565386237313061386166643737363436316338326464372f676f6f676c652f77617365666972652f6973737565732f343538&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/google/wasefire/issues/458#issuecomment-3189916340\" title=\"Explore Wasmtime as an alternative WebAssembly runtime · Issue #458 · google/wasefire\">Explore Wasmtime as an alternative WebAssembly runtime · Issue #458 · google/wasefire</a></div><div class=\"message_embed_description\">Now that Wasmtime has no-std support, it becomes a possible alternative for the platform WASM runtime. This task should track the feasibility of using Wasmtime, since many roadblocks are expected (...</div></div></div>",
        "id": 547652183,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1761726145
    },
    {
        "content": "<p>there's also <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10286\">https://github.com/bytecodealliance/wasmtime/issues/10286</a> which is an open issue for us</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/issues/10286\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/cdc132293e46d3321916813d67ac29fe591725b6/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f653936646361383035396637306232663935363066633131636537336531333436356631353861343163373861353061386138613263616331386461623330362f62797465636f6465616c6c69616e63652f7761736d74696d652f6973737565732f3130323836&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/issues/10286\" title=\"Investigate removing symbol table from `*.cwasm` · Issue #10286 · bytecodealliance/wasmtime\">Investigate removing symbol table from `*.cwasm` · Issue #10286 · bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">In #10285 it was shown that sections such as .symtab, .strtab, and .shstrtab account for a non-trivial portion of the size of an object file: $ objdump --section-headers target/wasm32-wasip1/releas...</div></div></div>",
        "id": 547652249,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1761726172
    },
    {
        "content": "<p>FWIW, you should be able to see a breakdown of section sizes with a tool like <code>bloaty</code>; e.g. here's a run on a test.cwasm compiled from a test.wat with one tiny function:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"n\">bloaty</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"p\">.</span><span class=\"n\">cwasm</span>\n<span class=\"w\">    </span><span class=\"n\">FILE</span><span class=\"w\"> </span><span class=\"n\">SIZE</span><span class=\"w\">        </span><span class=\"n\">VM</span><span class=\"w\"> </span><span class=\"n\">SIZE</span>\n<span class=\"w\"> </span><span class=\"o\">--------------</span><span class=\"w\">  </span><span class=\"o\">--------------</span>\n<span class=\"w\">  </span><span class=\"mf\">62.6</span><span class=\"o\">%</span><span class=\"w\">  </span><span class=\"mf\">30.8</span><span class=\"n\">Ki</span><span class=\"w\">   </span><span class=\"mf\">0.0</span><span class=\"o\">%</span><span class=\"w\">       </span><span class=\"mi\">0</span><span class=\"w\">    </span><span class=\"p\">[</span><span class=\"n\">Unmapped</span><span class=\"p\">]</span>\n<span class=\"w\">  </span><span class=\"mf\">32.6</span><span class=\"o\">%</span><span class=\"w\">  </span><span class=\"mf\">16.1</span><span class=\"n\">Ki</span><span class=\"w\">  </span><span class=\"mf\">93.0</span><span class=\"o\">%</span><span class=\"w\">  </span><span class=\"mf\">16.0</span><span class=\"n\">Ki</span><span class=\"w\">    </span><span class=\"p\">.</span><span class=\"n\">text</span>\n<span class=\"w\">   </span><span class=\"mf\">2.0</span><span class=\"o\">%</span><span class=\"w\">    </span><span class=\"mi\">1016</span><span class=\"w\">   </span><span class=\"mf\">5.4</span><span class=\"o\">%</span><span class=\"w\">     </span><span class=\"mi\">952</span><span class=\"w\">    </span><span class=\"p\">.</span><span class=\"n\">wasmtime</span><span class=\"p\">.</span><span class=\"n\">engine</span>\n<span class=\"w\">   </span><span class=\"mf\">0.5</span><span class=\"o\">%</span><span class=\"w\">     </span><span class=\"mi\">228</span><span class=\"w\">   </span><span class=\"mf\">0.9</span><span class=\"o\">%</span><span class=\"w\">     </span><span class=\"mi\">164</span><span class=\"w\">    </span><span class=\"p\">.</span><span class=\"n\">eh_frame</span>\n<span class=\"w\">   </span><span class=\"mf\">0.4</span><span class=\"o\">%</span><span class=\"w\">     </span><span class=\"mi\">221</span><span class=\"w\">   </span><span class=\"mf\">0.0</span><span class=\"o\">%</span><span class=\"w\">       </span><span class=\"mi\">0</span><span class=\"w\">    </span><span class=\"p\">.</span><span class=\"n\">shstrtab</span>\n<span class=\"w\">   </span><span class=\"mf\">0.4</span><span class=\"o\">%</span><span class=\"w\">     </span><span class=\"mi\">203</span><span class=\"w\">   </span><span class=\"mf\">0.4</span><span class=\"o\">%</span><span class=\"w\">      </span><span class=\"mi\">75</span><span class=\"w\">    </span><span class=\"p\">.</span><span class=\"n\">wasmtime</span><span class=\"p\">.</span><span class=\"n\">info</span>\n<span class=\"w\">   </span><span class=\"mf\">0.3</span><span class=\"o\">%</span><span class=\"w\">     </span><span class=\"mi\">163</span><span class=\"w\">   </span><span class=\"mf\">0.0</span><span class=\"o\">%</span><span class=\"w\">       </span><span class=\"mi\">0</span><span class=\"w\">    </span><span class=\"p\">.</span><span class=\"n\">strtab</span>\n<span class=\"w\">   </span><span class=\"mf\">0.3</span><span class=\"o\">%</span><span class=\"w\">     </span><span class=\"mi\">160</span><span class=\"w\">   </span><span class=\"mf\">0.0</span><span class=\"o\">%</span><span class=\"w\">       </span><span class=\"mi\">0</span><span class=\"w\">    </span><span class=\"p\">.</span><span class=\"n\">symtab</span>\n<span class=\"w\">   </span><span class=\"mf\">0.3</span><span class=\"o\">%</span><span class=\"w\">     </span><span class=\"mi\">128</span><span class=\"w\">   </span><span class=\"mf\">0.0</span><span class=\"o\">%</span><span class=\"w\">       </span><span class=\"mi\">0</span><span class=\"w\">    </span><span class=\"p\">[</span><span class=\"n\">ELF</span><span class=\"w\"> </span><span class=\"n\">Headers</span><span class=\"p\">]</span>\n<span class=\"w\">   </span><span class=\"mf\">0.2</span><span class=\"o\">%</span><span class=\"w\">      </span><span class=\"mi\">92</span><span class=\"w\">   </span><span class=\"mf\">0.2</span><span class=\"o\">%</span><span class=\"w\">      </span><span class=\"mi\">28</span><span class=\"w\">    </span><span class=\"p\">.</span><span class=\"n\">wasmtime</span><span class=\"p\">.</span><span class=\"n\">addrmap</span>\n<span class=\"w\">   </span><span class=\"mf\">0.1</span><span class=\"o\">%</span><span class=\"w\">      </span><span class=\"mi\">72</span><span class=\"w\">   </span><span class=\"mf\">0.0</span><span class=\"o\">%</span><span class=\"w\">       </span><span class=\"mi\">8</span><span class=\"w\">    </span><span class=\"p\">.</span><span class=\"n\">wasmtime</span><span class=\"p\">.</span><span class=\"n\">exceptions</span>\n<span class=\"w\">   </span><span class=\"mf\">0.1</span><span class=\"o\">%</span><span class=\"w\">      </span><span class=\"mi\">68</span><span class=\"w\">   </span><span class=\"mf\">0.0</span><span class=\"o\">%</span><span class=\"w\">       </span><span class=\"mi\">4</span><span class=\"w\">    </span><span class=\"p\">.</span><span class=\"n\">wasmtime</span><span class=\"p\">.</span><span class=\"n\">traps</span>\n<span class=\"w\">   </span><span class=\"mf\">0.1</span><span class=\"o\">%</span><span class=\"w\">      </span><span class=\"mi\">65</span><span class=\"w\">   </span><span class=\"mf\">0.0</span><span class=\"o\">%</span><span class=\"w\">       </span><span class=\"mi\">1</span><span class=\"w\">    </span><span class=\"p\">.</span><span class=\"n\">wasmtime</span><span class=\"p\">.</span><span class=\"n\">bti</span>\n<span class=\"w\"> </span><span class=\"mf\">100.0</span><span class=\"o\">%</span><span class=\"w\">  </span><span class=\"mf\">49.2</span><span class=\"n\">Ki</span><span class=\"w\"> </span><span class=\"mf\">100.0</span><span class=\"o\">%</span><span class=\"w\">  </span><span class=\"mf\">17.2</span><span class=\"n\">Ki</span><span class=\"w\">    </span><span class=\"n\">TOTAL</span>\n</code></pre></div>",
        "id": 547653021,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1761726439
    },
    {
        "content": "<p>I have looked deeper into optimizing this stuff. This is the configuration I ended up with </p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">    </span><span class=\"n\">config</span><span class=\"p\">.</span><span class=\"n\">memory_init_cow</span><span class=\"p\">(</span><span class=\"kc\">false</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">config</span><span class=\"p\">.</span><span class=\"n\">generate_address_map</span><span class=\"p\">(</span><span class=\"kc\">false</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">config</span><span class=\"p\">.</span><span class=\"n\">table_lazy_init</span><span class=\"p\">(</span><span class=\"kc\">false</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">config</span><span class=\"p\">.</span><span class=\"n\">cranelift_opt_level</span><span class=\"p\">(</span><span class=\"n\">OptLevel</span><span class=\"p\">::</span><span class=\"n\">Speed</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">config</span><span class=\"p\">.</span><span class=\"n\">memory_may_move</span><span class=\"p\">(</span><span class=\"kc\">false</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">config</span><span class=\"p\">.</span><span class=\"n\">memory_reservation</span><span class=\"p\">(</span><span class=\"mi\">0</span><span class=\"p\">);</span>\n<span class=\"w\">    </span><span class=\"n\">config</span><span class=\"p\">.</span><span class=\"n\">wasm_custom_page_sizes</span><span class=\"p\">(</span><span class=\"kc\">true</span><span class=\"p\">);</span>\n</code></pre></div>\n<p>compared to an \"unoptimized\" precompilation this reduced the elf size by about 5, most of coming from <code>generate_adress_map(false)</code>. Now I have ELFs that have the following sections :</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>llvm-readelf<span class=\"w\"> </span>-S<span class=\"w\"> </span>testing.cwasm\nThere<span class=\"w\"> </span>are<span class=\"w\"> </span><span class=\"m\">11</span><span class=\"w\"> </span>section<span class=\"w\"> </span>headers,<span class=\"w\"> </span>starting<span class=\"w\"> </span>at<span class=\"w\"> </span>offset<span class=\"w\"> </span>0x2f28:\n\nSection<span class=\"w\"> </span>Headers:\n<span class=\"w\">  </span><span class=\"o\">[</span>Nr<span class=\"o\">]</span><span class=\"w\"> </span>Name<span class=\"w\">              </span>Type<span class=\"w\">            </span>Address<span class=\"w\">          </span>Off<span class=\"w\">    </span>Size<span class=\"w\">   </span>ES<span class=\"w\"> </span>Flg<span class=\"w\"> </span>Lk<span class=\"w\"> </span>Inf<span class=\"w\"> </span>Al\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"m\">0</span><span class=\"o\">]</span><span class=\"w\">                   </span>NULL<span class=\"w\">            </span><span class=\"m\">0000000000000000</span><span class=\"w\"> </span><span class=\"m\">000000</span><span class=\"w\"> </span><span class=\"m\">000000</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">      </span><span class=\"m\">0</span><span class=\"w\">   </span><span class=\"m\">0</span><span class=\"w\">  </span><span class=\"m\">0</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"m\">1</span><span class=\"o\">]</span><span class=\"w\"> </span>.wasmtime.engine<span class=\"w\">  </span>PROGBITS<span class=\"w\">        </span><span class=\"m\">0000000000000000</span><span class=\"w\"> </span><span class=\"m\">000040</span><span class=\"w\"> </span><span class=\"m\">000315</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">   </span>A<span class=\"w\">  </span><span class=\"m\">0</span><span class=\"w\">   </span><span class=\"m\">0</span><span class=\"w\">  </span><span class=\"m\">1</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"m\">2</span><span class=\"o\">]</span><span class=\"w\"> </span>.wasmtime.bti<span class=\"w\">     </span>PROGBITS<span class=\"w\">        </span><span class=\"m\">0000000000000000</span><span class=\"w\"> </span><span class=\"m\">000355</span><span class=\"w\"> </span><span class=\"m\">000001</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">   </span>A<span class=\"w\">  </span><span class=\"m\">0</span><span class=\"w\">   </span><span class=\"m\">0</span><span class=\"w\">  </span><span class=\"m\">1</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"m\">3</span><span class=\"o\">]</span><span class=\"w\"> </span>.text<span class=\"w\">             </span>PROGBITS<span class=\"w\">        </span><span class=\"m\">0000000000000000</span><span class=\"w\"> </span><span class=\"m\">000356</span><span class=\"w\"> </span>001d93<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">   </span>W<span class=\"w\">  </span><span class=\"m\">0</span><span class=\"w\">   </span><span class=\"m\">0</span><span class=\"w\">  </span><span class=\"m\">1</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"m\">4</span><span class=\"o\">]</span><span class=\"w\"> </span>.wasmtime.traps<span class=\"w\">   </span>PROGBITS<span class=\"w\">        </span><span class=\"m\">0000000000000000</span><span class=\"w\"> </span>0020e9<span class=\"w\"> </span><span class=\"m\">000027</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">   </span>A<span class=\"w\">  </span><span class=\"m\">0</span><span class=\"w\">   </span><span class=\"m\">0</span><span class=\"w\">  </span><span class=\"m\">1</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"m\">5</span><span class=\"o\">]</span><span class=\"w\"> </span>.wasmtime.exceptions<span class=\"w\"> </span>PROGBITS<span class=\"w\">     </span><span class=\"m\">0000000000000000</span><span class=\"w\"> </span><span class=\"m\">002110</span><span class=\"w\"> </span>0000e0<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">   </span>A<span class=\"w\">  </span><span class=\"m\">0</span><span class=\"w\">   </span><span class=\"m\">0</span><span class=\"w\">  </span><span class=\"m\">1</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"m\">6</span><span class=\"o\">]</span><span class=\"w\"> </span>.rodata.wasm<span class=\"w\">      </span>PROGBITS<span class=\"w\">        </span><span class=\"m\">0000000000000000</span><span class=\"w\"> </span>0021f0<span class=\"w\"> </span><span class=\"m\">000034</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">   </span>A<span class=\"w\">  </span><span class=\"m\">0</span><span class=\"w\">   </span><span class=\"m\">0</span><span class=\"w\">  </span><span class=\"m\">1</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"m\">7</span><span class=\"o\">]</span><span class=\"w\"> </span>.wasmtime.info<span class=\"w\">    </span>PROGBITS<span class=\"w\">        </span><span class=\"m\">0000000000000000</span><span class=\"w\"> </span><span class=\"m\">002224</span><span class=\"w\"> </span><span class=\"m\">000596</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">   </span>A<span class=\"w\">  </span><span class=\"m\">0</span><span class=\"w\">   </span><span class=\"m\">0</span><span class=\"w\">  </span><span class=\"m\">1</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"m\">8</span><span class=\"o\">]</span><span class=\"w\"> </span>.symtab<span class=\"w\">           </span>SYMTAB<span class=\"w\">          </span><span class=\"m\">0000000000000000</span><span class=\"w\"> </span>0027c0<span class=\"w\"> </span><span class=\"m\">000300</span><span class=\"w\"> </span><span class=\"m\">18</span><span class=\"w\">      </span><span class=\"m\">9</span><span class=\"w\">  </span><span class=\"m\">32</span><span class=\"w\">  </span><span class=\"m\">8</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"w\"> </span><span class=\"m\">9</span><span class=\"o\">]</span><span class=\"w\"> </span>.strtab<span class=\"w\">           </span>STRTAB<span class=\"w\">          </span><span class=\"m\">0000000000000000</span><span class=\"w\"> </span>002ac0<span class=\"w\"> </span>0003e1<span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">      </span><span class=\"m\">0</span><span class=\"w\">   </span><span class=\"m\">0</span><span class=\"w\">  </span><span class=\"m\">1</span>\n<span class=\"w\">  </span><span class=\"o\">[</span><span class=\"m\">10</span><span class=\"o\">]</span><span class=\"w\"> </span>.shstrtab<span class=\"w\">         </span>STRTAB<span class=\"w\">          </span><span class=\"m\">0000000000000000</span><span class=\"w\"> </span>002ea1<span class=\"w\"> </span><span class=\"m\">000081</span><span class=\"w\"> </span><span class=\"m\">00</span><span class=\"w\">      </span><span class=\"m\">0</span><span class=\"w\">   </span><span class=\"m\">0</span><span class=\"w\">  </span><span class=\"m\">1</span>\n</code></pre></div>\n<p>For some reasons, <code>llvm-size -A</code> and <code>objdump --section-headers</code> don't show the last 3 sections in their output.<br>\nFrom what I understand from <a href=\"https://github.com/bytecodealliance/wasmtime/issues/10286\">this issue</a> <code>.symtab</code>, <code>.strtab</code> and <code>.shstrtab</code> can be stripped and everything should work. What about the <code>.wasmtime</code> sections, especially <code>traps</code> and <code>exceptions</code> and <code>info</code> ?  Can they be removed ?</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/issues/10286\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/cdc132293e46d3321916813d67ac29fe591725b6/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f653936646361383035396637306232663935363066633131636537336531333436356631353861343163373861353061386138613263616331386461623330362f62797465636f6465616c6c69616e63652f7761736d74696d652f6973737565732f3130323836&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/issues/10286\" title=\"Investigate removing symbol table from `*.cwasm` · Issue #10286 · bytecodealliance/wasmtime\">Investigate removing symbol table from `*.cwasm` · Issue #10286 · bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">In #10285 it was shown that sections such as .symtab, .strtab, and .shstrtab account for a non-trivial portion of the size of an object file: $ objdump --section-headers target/wasm32-wasip1/releas...</div></div></div>",
        "id": 558434121,
        "sender_full_name": "Antoine Lavandier",
        "timestamp": 1763646438
    },
    {
        "content": "<p>For a sense of scale, in this example, the sum of all 6 sections, accounts for <code>3853</code>( 28.4 %) out of <code>12776</code> bytes (total measured with <code>wc -c</code>). In another bigger example I have lying around it accounts for <code>7339</code>(19.6 %) out of <code>37448</code> bytes. So it's impact is decreasing but even constant gains in code size are desirable in the constrained environments I'm working in</p>",
        "id": 558438017,
        "sender_full_name": "Antoine Lavandier",
        "timestamp": 1763647425
    },
    {
        "content": "<p>The traps section is necessary for wasmtime to know which locations are expected to trap and thus can be handled by returning a wasm trap to the host code rather than aborting the entire process. The exceptions section is necessary for wasm exceptions to function. The info section contains things like function types and the names and locations of all exports and imports, which is essential information for getting to run any wasm code at all.</p>",
        "id": 558454170,
        "sender_full_name": "bjorn3",
        "timestamp": 1763651203
    },
    {
        "content": "<p><code>.shstrtab</code> is necessary as it contains the names of all ELF sections, which are necessary to locate the sections in the first place.</p>",
        "id": 558454323,
        "sender_full_name": "bjorn3",
        "timestamp": 1763651234
    },
    {
        "content": "<p>it's theoretically possible to strip <code>.wasmtime.traps</code>, <code>.wasmtime.exceptions</code>, <code>.wasmtime.engine</code>, and <code>.wasmtime.bti</code>. </p>\n<ul>\n<li><code>.wasmtime.traps</code> - as bjorn3 mentioned this is used for verifying that a faulting instruction can indeed fault. It's also used to report the trap code when a fault happens. We could in theory add an <code>unsafe</code> method to strip it which would report less information on trap and possibly catch bugs in Wasmtime as \"this is a wasm trap\". For functional correctness though it's not necessarily required.</li>\n<li><code>.wasmtime.exceptions</code> - we should just strip this, it's an empty section anyway</li>\n<li><code>.wasmtime.engine</code> / <code>.wasmtime.bti</code> - this has compile-time metadata which is double-checked when loading the module to ensure that compilation/runtime settings all match. This could, like <code>.wasmtime.traps</code>, in theory be stripped away so long as you opt-in to the unsafety of doing so.</li>\n</ul>\n<p>Otherwise, yeah, <code>.symtab</code> and <code>.strtab</code> are definitely strippable and aren't needed by Wasmtime at all.</p>\n<p>Would you be interested in sending some PRs to help out here? For example stripping <code>.wasmtime.exceptions</code> shouldn't be too hard, and the next-easiest thing would probably be figuring out how to strip the sybols</p>",
        "id": 558457514,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1763651987
    },
    {
        "content": "<p><code>.wamstime.engine</code> in my examples is a flat <code>0x355</code> bytes and <code>.wasmtime.bti</code> is <code>0x1</code> byte  regardless of the <code>.text</code>or <code>.rodata.wasm</code> section sizes so it's really not worth the removal I think. <code>.symtab</code> and <code>.strtab</code> are more interesting to remove. Regarding PRs, I'm not necessarily against it but I can't say that I'll find the time to contribute this. Also this kind of thing is not my domain of expertise. I'm fine <code>llvm-strip</code>ing the unnecessary sections for the time being. Regarding stripping the symbols, in the issue linked above, you mention  [the need to request features to upstream projects like <code>object</code>] so I don't know how much I could do in that direction</p>",
        "id": 558463722,
        "sender_full_name": "Antoine Lavandier",
        "timestamp": 1763653315
    },
    {
        "content": "<p>it's true yeah I don't know how we'd strip the sections in Rust itself</p>",
        "id": 558464326,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1763653448
    },
    {
        "content": "<p>in the meantime <code>llvm-strip</code> should work ok</p>",
        "id": 558464344,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1763653453
    },
    {
        "content": "<p>It's been awhile, but I do think there would need to be updates to a few dependencies (gimli, IIRC) to be able to strip additional sections without external tooling.  It would certainly be convenient to be able to do this without external tooling.</p>",
        "id": 558539616,
        "sender_full_name": "Paul Osborne",
        "timestamp": 1763676779
    }
]
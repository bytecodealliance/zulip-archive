[
    {
        "content": "<p>After a long break I got back to some of my WASM related projects and I'm trying to update from Wasmtime 25 to 41. I was able to make the code compile after updating some of the APIs that changed, here is a <a href=\"https://github.com/drogus/crows/compare/wasmtime-41\">diff</a>. The problem is that when I call a function from the host I get the following error:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">Error</span><span class=\"w\"> </span><span class=\"n\">running</span><span class=\"w\"> </span><span class=\"n\">WASM</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">error</span><span class=\"w\"> </span><span class=\"k\">while</span><span class=\"w\"> </span><span class=\"n\">executing</span><span class=\"w\"> </span><span class=\"n\">at</span><span class=\"w\"> </span><span class=\"n\">wasm</span><span class=\"w\"> </span><span class=\"n\">backtrace</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"mi\">0</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"mh\">0xd8e0</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">wit</span><span class=\"o\">-</span><span class=\"n\">component</span><span class=\"p\">:</span><span class=\"nc\">shim</span><span class=\"o\">!</span><span class=\"n\">indirect</span><span class=\"o\">-</span><span class=\"n\">host</span><span class=\"o\">-</span><span class=\"n\">http</span><span class=\"o\">-</span><span class=\"n\">request</span>\n<span class=\"w\">    </span><span class=\"mi\">1</span><span class=\"p\">:</span><span class=\"w\">    </span><span class=\"mh\">0x868</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"w\"> </span><span class=\"n\">wasm_example</span><span class=\"p\">.</span><span class=\"n\">wasm</span><span class=\"o\">!</span><span class=\"n\">run</span><span class=\"o\">-</span><span class=\"n\">scenario</span>\n\n<span class=\"n\">Caused</span><span class=\"w\"> </span><span class=\"n\">by</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"nc\">pointer</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">aligned</span>\n</code></pre></div>\n<p>I think that the problems might be related to the interface between the guest and the host, or more precisely on how the response from the function is serialised. I tried to isolate the failure and checked what happens when the exported function doesn't call any host functions - it works fine. So then I changed the host function to not return anything, that also works fine. Which seems to indicate that the problem occurs only when I return any actual data from the host to the guest.</p>\n<p>Some more info about the current implementation:</p>\n<ul>\n<li><a href=\"https://github.com/drogus/crows/blob/56b4a09353143398efbc81e17952fa276e620c5e/wasm/crows.wit\">crows.wit</a> (the failing function is <code>http-request</code>)</li>\n<li><a href=\"https://github.com/drogus/crows/blob/db1e5c4dc3215e9ad86ac329657ab0aa67d61b91/component.wit\">the component's wit</a> seems to be correct</li>\n<li>It looks like the store does not have the memory field anymore and I haven't seen any examples where memory was explicitly added to a store, thus <a href=\"https://github.com/drogus/crows/compare/wasmtime-41#diff-7790d680081a414362a091db4ea598fd6a9d775cbe4b26635c3cf8bb18149497L87-L89\">I removed manual <code>Memory</code> creation</a>, but I'm not 100% sure if I should replace it with something else</li>\n<li><a href=\"https://github.com/drogus/crows/blob/db1e5c4dc3215e9ad86ac329657ab0aa67d61b91/wasm/src/runtime.rs#L83-L88\">I added <code>default: async</code></a> entries for imports and exports cause otherwise the build was broken, but the guest side is supposed to be sync, only the host should be async. I'm guessing the <code>async</code> part for exports is just for calling from the async runtime on the Rust side, but again, not sure</li>\n<li><a href=\"https://github.com/drogus/crows/blob/db1e5c4dc3215e9ad86ac329657ab0aa67d61b91/rust-example/src/lib.rs\">here is the implementation of the guest code</a></li>\n<li><a href=\"https://github.com/drogus/crows/blob/db1e5c4dc3215e9ad86ac329657ab0aa67d61b91/wasm/src/runtime.rs#L83-L149\">here is the implementation for the host exports</a></li>\n</ul>\n<p>I'm not really sure how to debug this cause the code seems to be doing roughly a similar thing to what examples are doing, although I haven't seen any recent examples of an async host interface with custom world, only async implementations from wasmtime. Any ideas on how could I debug further or which part of my setup seem problematic?</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/drogus/crows/compare/wasmtime-41\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/7d3eeede9bd02619c0fb2d7a09904ef051e51dc3/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f376633343539666362633739633133393130303163323033353664336231666633316462353764353132386131376634393530613636353330346337636562342f64726f6775732f63726f7773&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/drogus/crows/compare/wasmtime-41\" title=\"Comparing main...wasmtime-41 · drogus/crows\">Comparing main...wasmtime-41 · drogus/crows</a></div><div class=\"message_embed_description\">A distributed load testing tool written in Rust running WASM compiled scenarios - Comparing main...wasmtime-41 · drogus/crows</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/drogus/crows/blob/56b4a09353143398efbc81e17952fa276e620c5e/wasm/crows.wit\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/7d3eeede9bd02619c0fb2d7a09904ef051e51dc3/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f376633343539666362633739633133393130303163323033353664336231666633316462353764353132386131376634393530613636353330346337636562342f64726f6775732f63726f7773&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/drogus/crows/blob/56b4a09353143398efbc81e17952fa276e620c5e/wasm/crows.wit\" title=\"crows/wasm/crows.wit at 56b4a09353143398efbc81e17952fa276e620c5e · drogus/crows\">crows/wasm/crows.wit at 56b4a09353143398efbc81e17952fa276e620c5e · drogus/crows</a></div><div class=\"message_embed_description\">A distributed load testing tool written in Rust running WASM compiled scenarios - drogus/crows</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/drogus/crows/blob/db1e5c4dc3215e9ad86ac329657ab0aa67d61b91/component.wit\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/7d3eeede9bd02619c0fb2d7a09904ef051e51dc3/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f376633343539666362633739633133393130303163323033353664336231666633316462353764353132386131376634393530613636353330346337636562342f64726f6775732f63726f7773&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/drogus/crows/blob/db1e5c4dc3215e9ad86ac329657ab0aa67d61b91/component.wit\" title=\"crows/component.wit at db1e5c4dc3215e9ad86ac329657ab0aa67d61b91 · drogus/crows\">crows/component.wit at db1e5c4dc3215e9ad86ac329657ab0aa67d61b91 · drogus/crows</a></div><div class=\"message_embed_description\">A distributed load testing tool written in Rust running WASM compiled scenarios - drogus/crows</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/drogus/crows/compare/wasmtime-41#diff-7790d680081a414362a091db4ea598fd6a9d775cbe4b26635c3cf8bb18149497L87-L89\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/7d3eeede9bd02619c0fb2d7a09904ef051e51dc3/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f376633343539666362633739633133393130303163323033353664336231666633316462353764353132386131376634393530613636353330346337636562342f64726f6775732f63726f7773&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/drogus/crows/compare/wasmtime-41#diff-7790d680081a414362a091db4ea598fd6a9d775cbe4b26635c3cf8bb18149497L87-L89\" title=\"Comparing main...wasmtime-41 · drogus/crows\">Comparing main...wasmtime-41 · drogus/crows</a></div><div class=\"message_embed_description\">A distributed load testing tool written in Rust running WASM compiled scenarios - Comparing main...wasmtime-41 · drogus/crows</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/drogus/crows/blob/db1e5c4dc3215e9ad86ac329657ab0aa67d61b91/wasm/src/runtime.rs#L83-L88\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/7d3eeede9bd02619c0fb2d7a09904ef051e51dc3/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f376633343539666362633739633133393130303163323033353664336231666633316462353764353132386131376634393530613636353330346337636562342f64726f6775732f63726f7773&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/drogus/crows/blob/db1e5c4dc3215e9ad86ac329657ab0aa67d61b91/wasm/src/runtime.rs#L83-L88\" title=\"crows/wasm/src/runtime.rs at db1e5c4dc3215e9ad86ac329657ab0aa67d61b91 · drogus/crows\">crows/wasm/src/runtime.rs at db1e5c4dc3215e9ad86ac329657ab0aa67d61b91 · drogus/crows</a></div><div class=\"message_embed_description\">A distributed load testing tool written in Rust running WASM compiled scenarios - drogus/crows</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/drogus/crows/blob/db1e5c4dc3215e9ad86ac329657ab0aa67d61b91/rust-example/src/lib.rs\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/7d3eeede9bd02619c0fb2d7a09904ef051e51dc3/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f376633343539666362633739633133393130303163323033353664336231666633316462353764353132386131376634393530613636353330346337636562342f64726f6775732f63726f7773&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/drogus/crows/blob/db1e5c4dc3215e9ad86ac329657ab0aa67d61b91/rust-example/src/lib.rs\" title=\"crows/rust-example/src/lib.rs at db1e5c4dc3215e9ad86ac329657ab0aa67d61b91 · drogus/crows\">crows/rust-example/src/lib.rs at db1e5c4dc3215e9ad86ac329657ab0aa67d61b91 · drogus/crows</a></div><div class=\"message_embed_description\">A distributed load testing tool written in Rust running WASM compiled scenarios - drogus/crows</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/drogus/crows/blob/db1e5c4dc3215e9ad86ac329657ab0aa67d61b91/wasm/src/runtime.rs#L83-L149\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/7d3eeede9bd02619c0fb2d7a09904ef051e51dc3/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f376633343539666362633739633133393130303163323033353664336231666633316462353764353132386131376634393530613636353330346337636562342f64726f6775732f63726f7773&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/drogus/crows/blob/db1e5c4dc3215e9ad86ac329657ab0aa67d61b91/wasm/src/runtime.rs#L83-L149\" title=\"crows/wasm/src/runtime.rs at db1e5c4dc3215e9ad86ac329657ab0aa67d61b91 · drogus/crows\">crows/wasm/src/runtime.rs at db1e5c4dc3215e9ad86ac329657ab0aa67d61b91 · drogus/crows</a></div><div class=\"message_embed_description\">A distributed load testing tool written in Rust running WASM compiled scenarios - drogus/crows</div></div></div>",
        "id": 572528259,
        "sender_full_name": "Piotr Sarnacki",
        "timestamp": 1770467967
    },
    {
        "content": "<p>You're using a pretty old toolchain in <code>rust-toolchain.toml</code>, although that toolchain also shouldn't be able to build wasmtime given its age. So your local configuration might be ignoring that file as well (I ran into that poking at this locally though). I also see you're using a pretty old version of <code>wit-bindgen</code> in the guest (0.33 vs 0.51 is current)</p>\n<p>I might recommend updating some of these related deps first and seeing if that helps? It might be that bugs were fixed there in the meantime</p>",
        "id": 572549445,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1770482814
    },
    {
        "content": "<p>If that doesn't end up fixing it, if you're able to reduce this to a <code>cargo run</code>-able thing to reproduce I can try to help poke a bit more too</p>",
        "id": 572549506,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1770482846
    },
    {
        "content": "<p>OMG, that was indeed <code>wit-bindgen</code> version! Thanks so much for taking a look. I updated most of the stuff in the main Cargo.toml, but I totally forgot that wit-bindgen is also used in the guest project. Regarding the toolchain I was using an override, sorry for the confusion, but yeah, it runs on 1.92 and the newest wasmtime/wit-bindgen combo without any issues.</p>",
        "id": 572556078,
        "sender_full_name": "Piotr Sarnacki",
        "timestamp": 1770487580
    }
]
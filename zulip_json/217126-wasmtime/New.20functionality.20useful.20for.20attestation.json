[
    {
        "content": "<p>Hi.  We've been doing some work relating to remote attestation of Wasm components (I'll spare you the details for those who aren't into that kind of thing), and have had to make some patches to Wasmtime that we're not sure whether we should (a) throw away and replace with some supported interface that we weren't aware of, (b) generalise and try to upstream, or (c) just maintain in our own fork because they're not of interest to anyone else.</p>\n<p>A quick summary of what we've added:</p>\n<p>1. During the process of compiling/instantiating a component, we capture a graph of all of the connections between its core modules so that we can get an accurate representation of what code is actually running after things have been linked together (including eventually across machines with wrpc).  This is probably a bit too niche for mainline inclusion, but would the interfaces that we're using to extract this kind of data be useful for someone?  I was thinking it might be useful somehow e.g. to allow platforms to implement functionality to identify known-vulnerable components or configurations of components without needing to wastefully reparse everything themselves, but maybe it exposes too many internals.</p>\n<p>2. The other addition was some new func_wrap variations in the linker to allow host functions to request also information on which component/core module was the source of a call.  This is needed in attestation e.g. in order to allow us to signal which part of a large application is terminating a TLS session.  But it also kind of violates the usual component model behaviour approach where it doesn't matter who has called an interface.  </p>\n<p>Would either of these things be more generally useful to others, or are we better off keeping all of this in a completely separate fork for people who want to do our weird kind of confidential computing stuff?</p>",
        "id": 553900524,
        "sender_full_name": "Lachlan Gunn",
        "timestamp": 1762359182
    },
    {
        "content": "<blockquote>\n<p>During the process of compiling/instantiating a component, we capture a graph of all of the connections between its core modules</p>\n</blockquote>\n<p>Is there something about this that is specific to Wasmtime or is this information just currently most conveniently accessible there? (or a 3rd option: neither and I'm just confused <span aria-label=\"slight smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"slight smile\">:slight_smile:</span> )</p>",
        "id": 553906170,
        "sender_full_name": "Lann Martin",
        "timestamp": 1762360410
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"480579\">Lann Martin</span> <a href=\"#narrow/channel/217126-wasmtime/topic/New.20functionality.20useful.20for.20attestation/near/553906170\">said</a>:</p>\n<blockquote>\n<p>Is there something about this that is specific to Wasmtime or is this information just currently most conveniently accessible there? (or a 3rd option: neither and I'm just confused <span aria-label=\"slight smile\" class=\"emoji emoji-1f642\" role=\"img\" title=\"slight smile\">:slight_smile:</span> )</p>\n</blockquote>\n<p>A bit of both. We can do it outside by analysing the component and then modelling how everything that gets linked together, but this also means that we need to have a good model of what the embedder does, since we want to eventually enable other stuff involving dynamically linking in drivers and access control shims and such. But if it's done directly in Wasmtime then we can get an accurate picture of what's actually running straight from the horse's mouth, without having to replicate the logic of Wasmtime and the embedder and hope that there aren't any subtle differences between the two implementations.</p>",
        "id": 553910465,
        "sender_full_name": "Lachlan Gunn",
        "timestamp": 1762361331
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"948112\">Lachlan Gunn</span> <a href=\"#narrow/channel/217126-wasmtime/topic/New.20functionality.20useful.20for.20attestation/near/553900524\">said</a>:</p>\n<blockquote>\n<p>2. The other addition was some new func_wrap variations in the linker to allow host functions to request also information on which component/core module was the source of a call.  This is needed in attestation e.g. in order to allow us to signal which part of a large application is terminating a TLS session.  But it also kind of violates the usual component model behaviour approach where it doesn't matter who has called an interface.  </p>\n</blockquote>\n<p>Does this allow the <code>Store</code> (maybe another structure) to define some kind of access policies for the host-defined functions ?</p>",
        "id": 553912120,
        "sender_full_name": "Antoine Lavandier",
        "timestamp": 1762361681
    },
    {
        "content": "<p>But then for the second part, we want to find the caller of a host function in the graph, so I'm not sure how well it can really be separated in practice.</p>",
        "id": 553912200,
        "sender_full_name": "Lachlan Gunn",
        "timestamp": 1762361696
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"940046\">Antoine Lavandier</span> <a href=\"#narrow/channel/217126-wasmtime/topic/New.20functionality.20useful.20for.20attestation/near/553912120\">said</a>:</p>\n<blockquote>\n<p><span class=\"user-mention silent\" data-user-id=\"948112\">Lachlan Gunn</span> <a href=\"#narrow/channel/217126-wasmtime/topic/New.20functionality.20useful.20for.20attestation/near/553900524\">said</a>:</p>\n<blockquote>\n<p>2. The other addition was some new func_wrap variations in the linker to allow host functions to request also information on which component/core module was the source of a call.  This is needed in attestation e.g. in order to allow us to signal which part of a large application is terminating a TLS session.  But it also kind of violates the usual component model behaviour approach where it doesn't matter who has called an interface.  </p>\n</blockquote>\n<p>Does this allow the <code>Store</code> (maybe another structure) to define some kind of access policies for the host-defined functions ?</p>\n</blockquote>\n<p>This was one of the other applications that I had in mind, e.g. If you wanted to host microservices from two different tenants in the one Store but then give them access to different filesystems. Probably this could be achieved in tidier ways like shimming their preloads with another component, but there might be other things that are better implemented in the runtime.</p>",
        "id": 553913721,
        "sender_full_name": "Lachlan Gunn",
        "timestamp": 1762361964
    },
    {
        "content": "<p>Do you have an example of what (1) here might look like in Wasmtime? I'm having a hard time imagining it myself.</p>\n<p>For (2) that seems like a reasonable thing to add to Wasmtime myself, but also somewhat dependent on (1) because otherwise it's not clear to me how an internal part of a component would be identified</p>",
        "id": 553934447,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1762367442
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"253994\">Alex Crichton</span> <a href=\"#narrow/channel/217126-wasmtime/topic/New.20functionality.20useful.20for.20attestation/near/553934447\">said</a>:</p>\n<blockquote>\n<p>Do you have an example of what (1) here might look like in Wasmtime? I'm having a hard time imagining it myself.</p>\n</blockquote>\n<p>The actual graph itself looks like this:<br>\n<a href=\"/user_uploads/15107/yZZG7EhFf5tgXqnKAuKUcW30/image.png\">image.png</a>, or do you mean the code changes?</p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/15107/yZZG7EhFf5tgXqnKAuKUcW30/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"1215x1036\" src=\"/user_uploads/thumbnail/15107/yZZG7EhFf5tgXqnKAuKUcW30/image.png/840x560.webp\"></a></div><blockquote>\n<p>For (2) that seems like a reasonable thing to add to Wasmtime myself, but also somewhat dependent on (1) because otherwise it's not clear to me how an internal part of a component would be identified</p>\n</blockquote>\n<p>At the moment we're using the OptionsIndex from <a href=\"https://docs.rs/wasmtime/latest/src/wasmtime/runtime/component/func/host.rs.html#229\">call_host</a>, which isn't a long-term solution, but we only worked this out yesterday so will hopefully find something less hacky that makes sense independently of the graph.</p>",
        "id": 553953614,
        "sender_full_name": "Lachlan Gunn",
        "timestamp": 1762373541
    },
    {
        "content": "<p>Yeah I'm curious code-changes-wise e.g. how an identifier is used on the host to correlate to internal things within a component. Using <code>OptionsIndex</code> seems like a good starting point though.</p>\n<p>Would it make sense to perhaps discuss over a minimal-ish PR or a PR which might end up getting minimized?</p>",
        "id": 553955769,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1762374324
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"253994\">Alex Crichton</span> <a href=\"#narrow/channel/217126-wasmtime/topic/New.20functionality.20useful.20for.20attestation/near/553955769\">said</a>:</p>\n<blockquote>\n<p>Yeah I'm curious code-changes-wise e.g. how an identifier is used on the host to correlate to internal things within a component. Using <code>OptionsIndex</code> seems like a good starting point though.</p>\n<p>Would it make sense to perhaps discuss over a minimal-ish PR or a PR which might end up getting minimized?</p>\n</blockquote>\n<p>Sounds like a plan.  We'll get it tidied up a little more and start the ball rolling.</p>",
        "id": 553956315,
        "sender_full_name": "Lachlan Gunn",
        "timestamp": 1762374493
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"253994\">Alex Crichton</span> <a href=\"#narrow/channel/217126-wasmtime/topic/New.20functionality.20useful.20for.20attestation/near/553955769\">said</a>:</p>\n<blockquote>\n<p>Yeah I'm curious code-changes-wise e.g. how an identifier is used on the host to correlate to internal things within a component. Using <code>OptionsIndex</code> seems like a good starting point though.</p>\n<p>Would it make sense to perhaps discuss over a minimal-ish PR or a PR which might end up getting minimized?</p>\n</blockquote>\n<p>Sorry to keep you waiting while we made things a bit more presentable, but the PR is up now <a href=\"https://github.com/bytecodealliance/wasmtime/pull/12064\">here</a>.</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/pull/12064\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/90728fe8c2be548399f98d44ba56bfce443c4930/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f316565333530666464363037646163656139393235656637363064336532306337653162346165663066346135356466356461663064373761353166663661612f62797465636f6465616c6c69616e63652f7761736d74696d652f70756c6c2f3132303634&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/pull/12064\" title=\"Capturing caller instance support by gionut 路 Pull Request #12064 路 bytecodealliance/wasmtime\">Capturing caller instance support by gionut 路 Pull Request #12064 路 bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">Previous conversation about this pull request available at:\nhttps://bytecodealliance.zulipchat.com/#narrow/channel/217126-wasmtime/topic/New.20functionality.20useful.20for.20attestation/with/553956...</div></div></div>",
        "id": 558621513,
        "sender_full_name": "Lachlan Gunn",
        "timestamp": 1763719552
    }
]
[
    {
        "content": "<p>Hello,</p>\n<p>I am trying to run modules/components compiled for <code>pulley64</code> in <code>hyperlight-wasm</code>.<br>\nIn <code>hyperlight-wasm</code>, the guest side uses <code>wasmtime</code> with only the following features enabled: <code>[\"runtime\", \"custom-virtual-memory\", \"custom-native-signals\", \"component-model\"]</code>. It is build for <code>x86_64-unknown-none</code>.</p>\n<p>From what I understand from the <code>wasmtime</code> features, pulley support should be already enabled:</p>\n<div class=\"codehilite\" data-code-language=\"TOML\"><pre><span></span><code><span class=\"n\">pulley</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"p\">[</span>\n<span class=\"w\">       </span><span class=\"c1\"># Note that this is intentionally empty. This feature is dynamically activated</span>\n<span class=\"w\">       </span><span class=\"c1\"># in `build.rs` as well when the host platform does not have Cranelift support</span>\n<span class=\"w\">       </span><span class=\"c1\"># for example. That means that dependencies for pulley need to be already</span>\n<span class=\"w\">       </span><span class=\"c1\"># activated anyway.</span>\n<span class=\"w\">     </span><span class=\"p\">]</span>\n</code></pre></div>\n<p>I am pre-compiling the modules/components using wasmtime <code>features = [\"cranelift\", \"pulley\", \"runtime\", \"component-model\" ]</code> and target <code>pulley64</code>, but when running I am getting the following errors:<br>\nFor wasmtime 36.0.5 (we are using LTS version):</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">Exception</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">InvalidOpcode</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">Exception</span><span class=\"w\"> </span><span class=\"n\">vector</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mi\">6</span>\n<span class=\"w\">           </span><span class=\"n\">Faulting</span><span class=\"w\"> </span><span class=\"n\">Instruction</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mh\">0x100005297</span>\n<span class=\"w\">           </span><span class=\"n\">Page</span><span class=\"w\"> </span><span class=\"n\">Fault</span><span class=\"w\"> </span><span class=\"n\">Address</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mh\">0x0</span>\n<span class=\"w\">           </span><span class=\"n\">Error</span><span class=\"w\"> </span><span class=\"n\">code</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mh\">0x0</span>\n<span class=\"w\">           </span><span class=\"n\">Stack</span><span class=\"w\"> </span><span class=\"n\">Pointer</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"mh\">0x23a450</span><span class=\"n\">x23a330</span><span class=\"s\">\"</span>\n</code></pre></div>\n<p>I tried a newer version, wasmtime 41.0.0:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">Error</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">compilation</span><span class=\"w\"> </span><span class=\"n\">settings</span><span class=\"w\"> </span><span class=\"n\">are</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">compatible</span><span class=\"w\"> </span><span class=\"n\">with</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">native</span><span class=\"w\"> </span><span class=\"n\">host</span>\n<span class=\"w\">           </span><span class=\"n\">Caused</span><span class=\"w\"> </span><span class=\"n\">by</span><span class=\"p\">:</span>\n<span class=\"w\">                </span><span class=\"nc\">target</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">pulley64</span><span class=\"o\">-</span><span class=\"n\">unknown</span><span class=\"o\">-</span><span class=\"n\">unknown</span><span class=\"o\">-</span><span class=\"n\">elf</span><span class=\"o\">'</span><span class=\"w\"> </span><span class=\"n\">specified</span><span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">configuration</span><span class=\"w\"> </span><span class=\"n\">does</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"k\">match</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">host</span><span class=\"s\">\"</span>\n</code></pre></div>\n<p>Do you spot something I might be doing wrongly?</p>",
        "id": 571630940,
        "sender_full_name": "Doru Blânzeanu",
        "timestamp": 1770116740
    },
    {
        "content": "<p>Not a wasmtime develpoper, but I remember pulley having issue with trying to use a no-std target in an std environment. IIRC using the <code>cranelift</code> features enables the <code>std</code> feature. Does removing this feature help ?</p>",
        "id": 571652827,
        "sender_full_name": "Antoine Lavandier",
        "timestamp": 1770123274
    },
    {
        "content": "<p>I tried removing <code>cranelift</code> from wasmtime when pre-compiling the modules/components, but the <code>precompile_module</code> and <code>precompile_component</code> APIs from wasmtime were no longer exposed.</p>\n<p>I haven't seen any other option to precompile when <code>cranelift</code> was not enabled</p>",
        "id": 571653951,
        "sender_full_name": "Doru Blânzeanu",
        "timestamp": 1770123530
    },
    {
        "content": "<p>Oh sorry, I misread your message, I thought that you were running the module in std contexts. I checked on what I did that worked and I just used <code>config.target(\"pulley64\")</code> on both sides (precompilation and running). I assume that this is also what you do ?</p>",
        "id": 571660108,
        "sender_full_name": "Antoine Lavandier",
        "timestamp": 1770125049
    },
    {
        "content": "<p>Partly.<br>\n I am setting <code>config.target(\"pulley64\")</code> when compiling and running, but the part that's running it is built for <code>no-std</code> (<code>x86_64-unknown-none</code>) and I cannot set <code>features = [ \"pulley\" ]</code> because that needs <code>std</code>.</p>\n<p>The <a href=\"https://docs.wasmtime.dev/examples-pulley.html?search=undefined\">docs</a> and wasmtime <code>Cargo.toml</code> specify that when <code>runtime</code> is enabled, but <code>cranelift</code> is NOT, pulley is enabled by default (no need for the feature).<br>\nI don't know if I understand it correctly, should I be able to run modules/components pre-compiled to <code>pulley64</code> in my conditions?</p>",
        "id": 571662374,
        "sender_full_name": "Doru Blânzeanu",
        "timestamp": 1770125612
    },
    {
        "content": "<p>After reading more thoroughly, the docs I linked say that on <code>supported architectures</code> cranelift is by default used (x86_64 and aarch64), so maybe that's why I see this behaviour.<br>\nThen my question is, is there a way to make <code>pulley</code> work on <code>no-std</code>?</p>",
        "id": 571664275,
        "sender_full_name": "Doru Blânzeanu",
        "timestamp": 1770126032
    },
    {
        "content": "<p>I definitely does work in <code>no_std</code>. Does it help to select pulley 64 explicitely instead of relying on the automatic detection ?</p>",
        "id": 571668719,
        "sender_full_name": "Antoine Lavandier",
        "timestamp": 1770127097
    },
    {
        "content": "<p>I tried again from scratch (new checkout) with a module and it worked. I don't know what I had done, maybe I had some leftover changes.<br>\nI'll try with components also.<br>\nThank you for the help!</p>",
        "id": 571670008,
        "sender_full_name": "Doru Blânzeanu",
        "timestamp": 1770127366
    }
]
[
    {
        "content": "<p>Continuation of <a class=\"stream-topic\" data-stream-id=\"217126\" href=\"/#narrow/channel/217126-wasmtime/topic/Getting.20component.20information.20on.20host.20calls/with/571096072\">#wasmtime &gt; Getting component information on host calls</a>.</p>\n<p>I would personally like for Wasmtime to support identifying the guest which is making a host call.</p>\n<hr>\n<p>I have not been able to think of a different way to resolve this besides maybe providing some key (like a UUID) to the guest which they must provide when making host calls but I find that to be quite dirty as I don't want to put the burden on the guest.</p>\n<hr>\n<p>Some of my use cases are:</p>\n<ol>\n<li>I will run an unknown amount of plugins all with different permissions. I need to make sure a callee has the permission to do some action.</li>\n</ol>\n<p>Example: Some plugins may be allowed to shut down the whole applications while others don't, this is configurable at runtime by the user. To solve this I have made a <code>shutdown</code> host function but I need to be able to verify that the callee has the permission to actually initiate this.</p>\n<ol start=\"2\">\n<li>Plugins may (un)register some (recurring) tasks at an arbitrary time, I want to solve this via host functions as well. Then again I need to be able to map the task to the right plugin so that I can send the result of the task to right plugin.</li>\n</ol>\n<p>To go a bit more in depth into this issue. I currently solve this by having an <code>initialization</code> guest function which I call at the start of my program and ask for all task registrations then. But I've noticed that this doesn't fully solve it and that I instead want support plugins (un)registering tasks at any time.</p>\n<hr>\n<p>I think that generally there are a lot of other use cases for plugin based systems besides the above.</p>\n<p>Let me know what your thoughts are on these use cases.</p>\n<p>cc <span class=\"user-mention\" data-user-id=\"253994\">@Alex Crichton</span></p>",
        "id": 571099564,
        "sender_full_name": "Eduard Smet (Celarye)",
        "timestamp": 1769798307
    },
    {
        "content": "<p>Does each guest have its own <code>Store</code>?</p>",
        "id": 571105303,
        "sender_full_name": "Lann Martin",
        "timestamp": 1769800194
    },
    {
        "content": "<p>Yes, but down the line a plugin will have multiple stores as a bunch of events will initiate a call to the same plugin. The store will then also be dropped at the end of the call.</p>",
        "id": 571105592,
        "sender_full_name": "Eduard Smet (Celarye)",
        "timestamp": 1769800304
    },
    {
        "content": "<p>Recentish wasmtime lets you optionally <code>bindgen</code> host function signatures where the function will receive a reference to the <code>Store</code>. You can embed some identifier in the store's <code>data</code> (inner <code>T</code>).</p>",
        "id": 571109393,
        "sender_full_name": "Lann Martin",
        "timestamp": 1769801595
    },
    {
        "content": "<p>This is also possible in older wasmtime but slightly more complicated.</p>",
        "id": 571109446,
        "sender_full_name": "Lann Martin",
        "timestamp": 1769801613
    },
    {
        "content": "<p>I guess that will indeed solve my issue in a cleaner way than adding a key as parameter. Could you perhaps point me to the relevant bindgen option?</p>\n<p>And is this invisible to the guest?</p>",
        "id": 571109856,
        "sender_full_name": "Eduard Smet (Celarye)",
        "timestamp": 1769801760
    },
    {
        "content": "<p><a href=\"https://docs.rs/wasmtime/latest/wasmtime/component/macro.bindgen.html\">https://docs.rs/wasmtime/latest/wasmtime/component/macro.bindgen.html</a><br>\nSearch <code>`store` flag</code></p>",
        "id": 571110311,
        "sender_full_name": "Lann Martin",
        "timestamp": 1769801931
    },
    {
        "content": "<p>Yes, invisible to the guest</p>",
        "id": 571110503,
        "sender_full_name": "Lann Martin",
        "timestamp": 1769801981
    },
    {
        "content": "<p>Then I guess that if I can get this to work that my issue can be considered resolved. Although maybe the topic itself is not resolved per se, depends if someone else has something to add to it.</p>",
        "id": 571110694,
        "sender_full_name": "Eduard Smet (Celarye)",
        "timestamp": 1769802038
    },
    {
        "content": "<p>You could also consider this as a solution to it I guess and it would probably be a good thing to explicitly document it somewhere (e.g. Component Model book) like that as well.</p>",
        "id": 571111055,
        "sender_full_name": "Eduard Smet (Celarye)",
        "timestamp": 1769802165
    },
    {
        "content": "<p>Well, the solution is somewhat Wasmtime-specific, and we sometimes refer to this kind of approach as \"host magic\" which we try to avoid for general-purpose interfaces, but I think it is reasonable for a plugin system</p>",
        "id": 571111239,
        "sender_full_name": "Lann Martin",
        "timestamp": 1769802233
    },
    {
        "content": "<p>Another approach that might work here would be to return some <code>resource</code> type when you register a task. Resource access is enforced by the runtime; a component (instance) cannot do anything with a resource unless it has been explicitly passed a handle to it.</p>",
        "id": 571111895,
        "sender_full_name": "Lann Martin",
        "timestamp": 1769802476
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"480579\">Lann Martin</span> <a href=\"#narrow/channel/217126-wasmtime/topic/Support.20for.20identifying.20the.20guest.20making.20a.20host.20call/near/571111239\">said</a>:</p>\n<blockquote>\n<p>Well, the solution is somewhat Wasmtime-specific, and we sometimes refer to this kind of approach as \"host magic\" which we try to avoid for general-purpose interfaces, but I think it is reasonable for a plugin system</p>\n</blockquote>\n<p>I am not planning on switching away from Wasmtime or to support other runtimes so I think I should be in the clear for using this.</p>",
        "id": 571113023,
        "sender_full_name": "Eduard Smet (Celarye)",
        "timestamp": 1769802841
    },
    {
        "content": "<p>But maybe we wouldn’t want Wasmtime specific solutions in the Component Model book?</p>",
        "id": 571113080,
        "sender_full_name": "Eduard Smet (Celarye)",
        "timestamp": 1769802867
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"480579\">Lann Martin</span> <a href=\"#narrow/channel/217126-wasmtime/topic/Support.20for.20identifying.20the.20guest.20making.20a.20host.20call/near/571111895\">said</a>:</p>\n<blockquote>\n<p>Another approach that might work here would be to return some <code>resource</code> type when you register a task. Resource access is enforced by the runtime; a component (instance) cannot do anything with a resource unless it has been explicitly passed a handle to it.</p>\n</blockquote>\n<p>Can you perhaps link an example, as my understanding on how to use resources is quite limited as well.</p>",
        "id": 571113300,
        "sender_full_name": "Eduard Smet (Celarye)",
        "timestamp": 1769802968
    },
    {
        "content": "<p>Although I can’t even imagine how use case one would look with this.</p>",
        "id": 571113556,
        "sender_full_name": "Eduard Smet (Celarye)",
        "timestamp": 1769803071
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"480579\">Lann Martin</span> <a href=\"#narrow/channel/217126-wasmtime/topic/Support.20for.20identifying.20the.20guest.20making.20a.20host.20call/near/571110311\">said</a>:</p>\n<blockquote>\n<p><a href=\"https://docs.rs/wasmtime/latest/wasmtime/component/macro.bindgen.html\">https://docs.rs/wasmtime/latest/wasmtime/component/macro.bindgen.html</a><br>\nSearch <code>`store` flag</code></p>\n</blockquote>\n<p>I found it in the docs and it reminded me how the async keyword in WIT files enables this as well, do you perhaps know the reason for that?</p>",
        "id": 571114081,
        "sender_full_name": "Eduard Smet (Celarye)",
        "timestamp": 1769803276
    },
    {
        "content": "<p>It's hard to give specific design advice without details but based on your description I could imagine something like this:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">interface</span><span class=\"w\"> </span><span class=\"n\">plugin</span><span class=\"o\">-</span><span class=\"n\">registrar</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"n\">register</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">func</span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">registered</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n<span class=\"n\">resource</span><span class=\"w\"> </span><span class=\"n\">registered</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"n\">unregister</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">func</span><span class=\"p\">();</span>\n<span class=\"w\">  </span><span class=\"n\">shutdown</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">func</span><span class=\"p\">();</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>Where plugins would import <code>plugin-registrar</code> from the host.</p>",
        "id": 571114841,
        "sender_full_name": "Lann Martin",
        "timestamp": 1769803594
    },
    {
        "content": "<p>I guess you'd still need something in the <code>Store</code> with this specific design. Again, hard to say without more context.</p>",
        "id": 571115167,
        "sender_full_name": "Lann Martin",
        "timestamp": 1769803731
    },
    {
        "content": "<p>I am going to give the Store solution a try first</p>",
        "id": 571117524,
        "sender_full_name": "Eduard Smet (Celarye)",
        "timestamp": 1769804658
    },
    {
        "content": "<p>I can chime in to basically just second everything Lann said, putting data in the Store, with a plugin-per-store, is a key feature of how to model an embedding in wasmtime</p>",
        "id": 571126839,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1769808224
    },
    {
        "content": "<p>Alright thanks a lot for the support again. Just so they don’t get lost I think these questions are still nice to see answered:</p>\n<ul>\n<li>Why does the async keyword in WIT files include the Store context to host functions by default?</li>\n<li>Would a short section in the Component Model book on a design pattern like this be interesting? If so, I would love to contribute that once I’ve successfully implemented it. As I would say that it makes quite a significant positive change to how I will implement things.</li>\n</ul>",
        "id": 571127624,
        "sender_full_name": "Eduard Smet (Celarye)",
        "timestamp": 1769808578
    },
    {
        "content": "<p>For the async keyword, that's more or less a bug in wasmtime. There are subtle reasons why it's the case, but the short reason is that it's the only way wasmtime supports</p>",
        "id": 571128434,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1769808904
    },
    {
        "content": "<p>For expanding book documentation, I think that would be great!</p>",
        "id": 571128488,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1769808928
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"253994\">Alex Crichton</span> <a href=\"#narrow/channel/217126-wasmtime/topic/Support.20for.20identifying.20the.20guest.20making.20a.20host.20call/near/571128434\">said</a>:</p>\n<blockquote>\n<p>For the async keyword, that's more or less a bug in wasmtime. There are subtle reasons why it's the case, but the short reason is that it's the only way wasmtime supports</p>\n</blockquote>\n<p>\"Feature bug\" by now or something that'll get fixed (if possible)?</p>",
        "id": 571128642,
        "sender_full_name": "Eduard Smet (Celarye)",
        "timestamp": 1769808994
    },
    {
        "content": "<p>Hard to say unfortunately. It's an artifact of trying to reconcile \"old async\" in wasmtime which is invisible to the guest and allows no concurrency with \"new async\" which is visible to the guest and allows concurrency. The component async keyword implies behavior in the guest which if the host wants to faithfully represent requires the signature with the store right now. An alternative is basically unknown at this point but something I want to tackle because I don't want wasmtime to indefinitely have two async systems in effect</p>",
        "id": 571129043,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1769809182
    }
]
[
    {
        "content": "<p>I'm adding WASIp3 instance reuse options to the <code>wasmtime serve</code> CLI as part of <a href=\"https://github.com/bytecodealliance/wasmtime/pull/11807\">https://github.com/bytecodealliance/wasmtime/pull/11807</a>, including:</p>\n<ul>\n<li>max number of requests to handle using a single instance</li>\n<li>max number of concurrent requests to handle using a single instance</li>\n<li>how long an instance can sit idle before we drop it</li>\n</ul>\n<p>Any opinions about where these should go in the CLI, e.g. under <code>-W</code>, <code>-S</code>, or at the top level?</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/pull/11807\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/32df4809a633a395f861b14edc44d7acb57dc60e/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f353731653939303666393832613862303633663164336333373135626161333564343363303963306231303538663535396663353562663039393663636631302f62797465636f6465616c6c69616e63652f7761736d74696d652f70756c6c2f3131383037&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/pull/11807\" title=\"support WASIp3 instance reuse in `wasmtime serve` by dicej 路 Pull Request #11807 路 bytecodealliance/wasmtime\">support WASIp3 instance reuse in `wasmtime serve` by dicej 路 Pull Request #11807 路 bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">This is a draft implementation of WASIp3 instance reuse.  Previously, we used one store and one instance per request for both p2 and p3 handlers, discarding the store and instance immediately after...</div></div></div>",
        "id": 544212021,
        "sender_full_name": "Joel Dice",
        "timestamp": 1760114746
    },
    {
        "content": "<p>I dont think these options belong under -W (wasm features)</p>",
        "id": 544214668,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1760115854
    },
    {
        "content": "<p>putting them under -S is really down to whether theres a possible interpretation of them in <code>wasmtime run</code> or <code>wasmtime wizer</code> etc which I expect the answer is no</p>",
        "id": 544214735,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1760115883
    },
    {
        "content": "<p>I agree, although currently setting a timeout requires <code>-Wtimeout=N</code> which surprised me a little.</p>",
        "id": 544214763,
        "sender_full_name": "Joel Dice",
        "timestamp": 1760115899
    },
    {
        "content": "<p>oh, huh, yeah i wouldnt have expected time out to be under -W either!</p>",
        "id": 544214808,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1760115915
    },
    {
        "content": "<p>i wouldnt complain if there was a top level --timeout= for wasmtime serve that was an alias for -Wtimeout=, just for the sake of discoverability....</p>",
        "id": 544215130,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1760116022
    },
    {
        "content": "<p>but thats an aside. i guess id like to see these as top level <code>wasmtime serve</code> options, and the max requests to handle using a single instance, and how long an instance can sit idle, could be reused for p2 as well</p>",
        "id": 544215295,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1760116085
    },
    {
        "content": "<p>thats a long standing request for wasmtime cli to support, and of course more and more (by which i mean the two private ones im responsible for) embeddings are making instance reuse a tunable knob these days</p>",
        "id": 544215388,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1760116124
    },
    {
        "content": "<p>Yeah, adding support for (non-concurrent) reuse for p2 isn't a priority for me right now, but definitely makes sense</p>",
        "id": 544215415,
        "sender_full_name": "Joel Dice",
        "timestamp": 1760116133
    },
    {
        "content": "<p>well once you have the options in there ill add the p2 reuse implementation</p>",
        "id": 544215509,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1760116169
    },
    {
        "content": "<p>The intention for <code>-W</code> was \"things affecting wasm runtime semantics\" which is why timeouts/features are there as well as things like determinism/nan canonicalization/etc</p>",
        "id": 544216776,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1760116678
    },
    {
        "content": "<p>The downside of <code>-S</code> or <code>-W</code> or such is that they show up on all commands while only being relevant to <code>serve</code>, so I'd lean towards what Pat is thinking as well with top-level commands</p>",
        "id": 544216893,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1760116728
    },
    {
        "content": "<p>we could perhaps entertain a <code>-P</code> or <code>--proxy</code> for <code>wasmtime-serve</code> specific options</p>",
        "id": 544216927,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1760116742
    },
    {
        "content": "<p>but if the man page for <code>wasmtime serve</code> is long that's also not the end of the world</p>",
        "id": 544216954,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1760116752
    }
]
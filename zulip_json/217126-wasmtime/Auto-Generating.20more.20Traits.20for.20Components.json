[
    {
        "content": "<p>Hi,<br>\nWhile working with components, I found myself wanting to be generics on Components in the same way that Components are generic on the Host. <br>\nSo If you're amenable to such a change, I would like to work on modifying <code>component::bindgen!</code> to add the following things:</p>\n<ul>\n<li>make all World types implements a <code>IsComponent&lt;T:Host&gt;</code> trait that contains <code>add_to_linker</code> and <code>instantiate/instantiate_aysnc</code>. This would require a <code>IsComponent&lt;T&gt;</code>present in <code>wasmtime::component</code> </li>\n<li>make worlds that export an interface do it through a trait that can be imported from elsewhere in the same way that the Host traits  works. </li>\n</ul>\n<p>Together these would make code like this possible:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"c1\">// A world exporting a foo interface and importing a bar interface.</span>\n<span class=\"n\">A</span><span class=\"w\"> </span><span class=\"n\">FooGuest</span><span class=\"w\"> </span><span class=\"k\">trait</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">generated</span><span class=\"w\"> </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">implement</span><span class=\"w\"> </span><span class=\"n\">by</span><span class=\"w\"> </span><span class=\"n\">the</span><span class=\"w\"> </span><span class=\"n\">generated</span><span class=\"w\"> </span><span class=\"k\">type</span><span class=\"w\"> </span><span class=\"nc\">Baz</span><span class=\"p\">;</span>\n<span class=\"n\">bindgen</span><span class=\"o\">!</span><span class=\"p\">({</span><span class=\"n\">world</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"s\">\"baz\"</span><span class=\"p\">});</span>\n\n<span class=\"k\">struct</span><span class=\"w\"> </span><span class=\"nc\">MyHost</span><span class=\"p\">;</span>\n<span class=\"k\">impl</span><span class=\"w\"> </span><span class=\"n\">bar</span><span class=\"p\">::</span><span class=\"n\">Host</span><span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span><span class=\"n\">MyHost</span><span class=\"w\"> </span><span class=\"p\">{};</span>\n\n<span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">start_foo_component</span><span class=\"o\">&lt;</span><span class=\"n\">H</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">Host</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"p\">:</span><span class=\"nc\">IsAComponent</span><span class=\"o\">&lt;</span><span class=\"n\">H</span><span class=\"o\">&gt;</span><span class=\"w\">  </span><span class=\"o\">+</span><span class=\"w\"> </span><span class=\"n\">FooGuest</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"n\">store</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kp\">&amp;</span><span class=\"nc\">mut</span><span class=\"w\"> </span><span class=\"n\">Store</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"p\">:</span><span class=\"kp\">&amp;</span><span class=\"nc\">mut</span><span class=\"w\"> </span><span class=\"n\">Linker</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">component</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kp\">&amp;</span><span class=\"nc\">Component</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">C</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">  </span><span class=\"n\">C</span><span class=\"p\">::</span><span class=\"n\">add_to_linker</span><span class=\"p\">::</span><span class=\"o\">&lt;</span><span class=\"n\">_</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">HasSelf</span><span class=\"o\">&lt;</span><span class=\"n\">_</span><span class=\"o\">&gt;&gt;</span><span class=\"p\">(</span><span class=\"n\">linker</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"o\">|</span><span class=\"n\">state</span><span class=\"o\">|</span><span class=\"w\"> </span><span class=\"n\">state</span><span class=\"p\">});</span>\n<span class=\"w\">  </span><span class=\"n\">C</span><span class=\"p\">::</span><span class=\"n\">instantiate</span><span class=\"p\">(</span><span class=\"n\">store</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">component</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">linker</span><span class=\"p\">).</span><span class=\"n\">unwrap</span><span class=\"p\">()</span>\n<span class=\"p\">}</span>\n\n<span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">run_foo_component</span><span class=\"o\">&lt;</span><span class=\"n\">H</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">Host</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">C</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">FooGuest</span><span class=\"o\">&gt;</span><span class=\"p\">(</span><span class=\"n\">store</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kp\">&amp;</span><span class=\"nc\">mut</span><span class=\"w\"> </span><span class=\"n\">Store</span><span class=\"o\">&lt;</span><span class=\"n\">H</span><span class=\"o\">&gt;</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">instance</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">C</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">   </span><span class=\"n\">instance</span><span class=\"p\">.</span><span class=\"n\">call_foo</span><span class=\"p\">(</span><span class=\"n\">store</span><span class=\"p\">).</span><span class=\"n\">unwrap</span><span class=\"p\">();</span>\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>What do you think ?</p>",
        "id": 553574846,
        "sender_full_name": "Antoine Lavandier",
        "timestamp": 1762251760
    },
    {
        "content": "<p>I don't think I understand your proposal enough from the above. How complex is it to make these changes? It would be useful for me to see the code output by bindgen for an example before and after side-by-side</p>",
        "id": 553685841,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1762280388
    },
    {
        "content": "<p>So I've trying working on the first point, turns out that it's more complicated than I thought because of the existence of auto-generated <code>LinkOptions</code>. I wanted to show a before/after generated code  through the <code>bindgen_examples</code> modules but running <code>cargo doc -p wasmtime --features \"component-model, runtime, async\"</code> breaks the <code>bindgen_examples</code></p>",
        "id": 554063062,
        "sender_full_name": "Antoine Lavandier",
        "timestamp": 1762427794
    },
    {
        "content": "<p>In any case here's a before after of what I've currently got :<br>\nNot expanded: </p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">use</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"p\">::</span><span class=\"n\">component</span><span class=\"p\">::</span><span class=\"n\">bindgen</span><span class=\"p\">;</span>\n\n<span class=\"n\">bindgen</span><span class=\"o\">!</span><span class=\"p\">({</span>\n<span class=\"w\">  </span><span class=\"n\">inline</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">r</span><span class=\"p\">#</span><span class=\"s\">\"</span>\n<span class=\"s\">      package my:project;</span>\n<span class=\"s\">      world hello-world {</span>\n<span class=\"s\">          import name: func() -&gt; string;</span>\n<span class=\"s\">          export greet: func();</span>\n<span class=\"s\">      }</span>\n<span class=\"s\">  \"</span><span class=\"p\">#,</span>\n<span class=\"p\">});</span>\n\n\n\n<span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">main</span><span class=\"w\"> </span><span class=\"p\">()</span><span class=\"w\"> </span><span class=\"p\">{</span>\n\n<span class=\"p\">}</span>\n</code></pre></div>\n<p>before after diff: </p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>diffoscope<span class=\"w\"> </span>before.rs<span class=\"w\"> </span>after.rs\n---<span class=\"w\"> </span>before.rs\n+++<span class=\"w\"> </span>after.rs\n@@<span class=\"w\"> </span>-266,9<span class=\"w\"> </span>+266,29<span class=\"w\"> </span>@@\n<span class=\"w\">                 </span>wasmtime::component::TypedFunc::&lt;<span class=\"o\">()</span>,<span class=\"w\"> </span><span class=\"o\">()</span>&gt;::new_unchecked<span class=\"o\">(</span>self.greet<span class=\"o\">)</span>\n<span class=\"w\">             </span><span class=\"o\">}</span><span class=\"p\">;</span>\n<span class=\"w\">             </span><span class=\"nb\">let</span><span class=\"w\"> </span><span class=\"o\">()</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span>callee.call<span class=\"o\">(</span>store.as_context_mut<span class=\"o\">()</span>,<span class=\"w\"> </span><span class=\"o\">())</span>?<span class=\"p\">;</span>\n<span class=\"w\">             </span>callee.post_return<span class=\"o\">(</span>store.as_context_mut<span class=\"o\">())</span>?<span class=\"p\">;</span>\n<span class=\"w\">             </span>Ok<span class=\"o\">(())</span>\n<span class=\"w\">         </span><span class=\"o\">}</span>\n<span class=\"w\">     </span><span class=\"o\">}</span>\n+<span class=\"w\">    </span>impl&lt;T,<span class=\"w\"> </span>D&gt;<span class=\"w\"> </span>wasmtime::component::ComponentInstance&lt;T,<span class=\"w\"> </span>D&gt;<span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span>HelloWorld\n+<span class=\"w\">    </span>where\n+<span class=\"w\">        </span>T:<span class=\"w\"> </span><span class=\"s1\">'static,</span>\n<span class=\"s1\">+        D: HelloWorldImportsWithStore,</span>\n<span class=\"s1\">+        for&lt;'</span>a&gt;<span class=\"w\"> </span>D::Data&lt;<span class=\"s1\">'a&gt;: HelloWorldImports,</span>\n<span class=\"s1\">+    {</span>\n<span class=\"s1\">+        fn instantiate(</span>\n<span class=\"s1\">+            store: impl wasmtime::AsContextMut&lt;Data = T&gt;,</span>\n<span class=\"s1\">+            component: &amp;wasmtime::component::Component,</span>\n<span class=\"s1\">+            linker: &amp;wasmtime::component::Linker&lt;T&gt;,</span>\n<span class=\"s1\">+        ) -&gt; wasmtime::Result&lt;Self&gt; {</span>\n<span class=\"s1\">+            Self::instantiate(store, component, linker)</span>\n<span class=\"s1\">+        }</span>\n<span class=\"s1\">+        fn add_to_linker(</span>\n<span class=\"s1\">+            linker: &amp;mut wasmtime::component::Linker&lt;T&gt;,</span>\n<span class=\"s1\">+            host_getter: fn(&amp;mut T) -&gt; D::Data&lt;'</span>_&gt;,\n+<span class=\"w\">        </span><span class=\"o\">)</span><span class=\"w\"> </span>-&gt;<span class=\"w\"> </span>wasmtime::Result&lt;<span class=\"o\">()</span>&gt;<span class=\"w\"> </span><span class=\"o\">{</span>\n+<span class=\"w\">            </span>Self::add_to_linker::&lt;T,<span class=\"w\"> </span>D&gt;<span class=\"o\">(</span>linker,<span class=\"w\"> </span>host_getter<span class=\"o\">)</span>\n+<span class=\"w\">        </span><span class=\"o\">}</span>\n+<span class=\"w\">    </span><span class=\"o\">}</span>\n<span class=\"w\"> </span><span class=\"o\">}</span><span class=\"p\">;</span>\n<span class=\"w\"> </span>fn<span class=\"w\"> </span>main<span class=\"o\">()</span><span class=\"w\"> </span><span class=\"o\">{}</span>\n</code></pre></div>",
        "id": 554066347,
        "sender_full_name": "Antoine Lavandier",
        "timestamp": 1762428903
    },
    {
        "content": "<p>Currently this only adds code that implements the (new) <code>wasmtime::component::ComponentInstance</code> trait. <br>\nHere's its definition: </p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"sd\">/// Trait that allows to start any auto-generated component. See [``]</span>\n<span class=\"sd\">///</span>\n<span class=\"sd\">/// [`bindgen!`](crate::component::bindgen) will implement this for T, D that have the</span>\n<span class=\"sd\">/// proper bounds</span>\n<span class=\"k\">pub</span><span class=\"w\"> </span><span class=\"k\">trait</span><span class=\"w\"> </span><span class=\"n\">ComponentInstance</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">D</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">crate</span><span class=\"p\">::</span><span class=\"n\">component</span><span class=\"p\">::</span><span class=\"n\">HasData</span><span class=\"o\">&gt;</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nb\">Sized</span><span class=\"w\"> </span><span class=\"p\">{</span>\n<span class=\"w\">    </span><span class=\"sd\">/// Wrapper on the autogenerated Self::instantiate</span>\n<span class=\"w\">    </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">instantiate</span><span class=\"p\">(</span>\n<span class=\"w\">        </span><span class=\"n\">store</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">impl</span><span class=\"w\"> </span><span class=\"n\">AsContextMut</span><span class=\"o\">&lt;</span><span class=\"n\">Data</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\">  </span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"n\">component</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kp\">&amp;</span><span class=\"nc\">Component</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"n\">linker</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kp\">&amp;</span><span class=\"nc\">Linker</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span>\n<span class=\"w\">    </span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">crate</span><span class=\"p\">::</span><span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"bp\">Self</span><span class=\"o\">&gt;</span><span class=\"p\">;</span>\n\n<span class=\"w\">    </span><span class=\"sd\">/// Wrapper on the autogenerated Self::add_to_linker</span>\n<span class=\"w\">    </span><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">add_to_linker</span><span class=\"p\">(</span>\n<span class=\"w\">        </span><span class=\"n\">linker</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"kp\">&amp;</span><span class=\"nc\">mut</span><span class=\"w\"> </span><span class=\"n\">Linker</span><span class=\"o\">&lt;</span><span class=\"n\">T</span><span class=\"o\">&gt;</span><span class=\"p\">,</span>\n<span class=\"w\">        </span><span class=\"n\">host_getter</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">fn</span><span class=\"p\">(</span><span class=\"o\">&amp;</span><span class=\"k\">mut</span><span class=\"w\"> </span><span class=\"n\">T</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">D</span><span class=\"p\">::</span><span class=\"n\">Data</span><span class=\"o\">&lt;'</span><span class=\"nb\">_</span><span class=\"o\">&gt;</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">crate</span><span class=\"p\">::</span><span class=\"nb\">Result</span><span class=\"o\">&lt;</span><span class=\"p\">()</span><span class=\"o\">&gt;</span><span class=\"p\">;</span>\n<span class=\"p\">}</span>\n</code></pre></div>",
        "id": 554066617,
        "sender_full_name": "Antoine Lavandier",
        "timestamp": 1762428991
    },
    {
        "content": "<p>That seems reasonable to me yeah. I migth bindgen <code>ComponentInstance</code> to something like <code>BindgenWorld</code> to make it clear that it's from <code>bindgen!</code>, or maybe even <code>World</code> or <code>WitWorld</code>, but that's just a minor detail.</p>",
        "id": 554124295,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1762443727
    },
    {
        "content": "<p>Any idea on how to deal with worlds that have a  <code>options: &amp;LinkOptions</code> argument in their <code>add_to_linker</code> ? This is a generated type so I don't see how to deal with that. Adding another generic  is always an option I guess...</p>",
        "id": 554131715,
        "sender_full_name": "Antoine Lavandier",
        "timestamp": 1762445410
    },
    {
        "content": "<p>I think it'd be reasonable to avoid exposing that in the trait and use <code>LinkOptions::default()</code>, and if customization is needed the raw functions can be used</p>",
        "id": 554137487,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1762446817
    }
]
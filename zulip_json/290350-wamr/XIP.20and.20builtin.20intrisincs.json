[
    {
        "content": "<p>Hi<br>\nI'm working on an STM32-based platform that runs a WebAssembly (WASM) application performing compute-intensive tasks involving double-precision and floating-point operations. Due to limited RAM and FLASH space, I aim to execute the WASM module directly from FLASH using Execute In Place (XIP).</p>\n<h2>Toolchain</h2>\n<ul>\n<li><strong>Compiler:</strong> Clang (compiling C source files to WASM)</li>\n<li><strong>AOT Compiler:</strong> <code>wamrc</code> (WebAssembly Micro Runtime Ahead-of-Time compiler)</li>\n</ul>\n<h2>Objective</h2>\n<p>Enable XIP to reduce memory footprint while maintaining full support for floating-point and double-precision computations.</p>\n<h2>Initial Approach</h2>\n<p>I compiled the WASM module using the following command:</p>\n<div class=\"codehilite\" data-code-language=\"Bash\"><pre><span></span><code>./wamrc<span class=\"w\"> </span>--xip<span class=\"w\"> </span>--size-level<span class=\"o\">=</span><span class=\"m\">3</span><span class=\"w\"> </span><span class=\"se\">\\</span>\n<span class=\"w\">        </span>--target<span class=\"o\">=</span>thumbv8m.base<span class=\"w\"> </span><span class=\"se\">\\</span>\n<span class=\"w\">        </span>--cpu<span class=\"o\">=</span>cortex-m33<span class=\"w\"> </span><span class=\"se\">\\</span>\n<span class=\"w\">        </span>--target-abi<span class=\"o\">=</span>eabi<span class=\"w\"> </span><span class=\"se\">\\</span>\n<span class=\"w\">        </span>-o<span class=\"w\"> </span>myfile_v8m.aot<span class=\"w\"> </span>./myfile.wasm\n\nThis<span class=\"w\"> </span>enabled<span class=\"w\"> </span>XIP<span class=\"w\"> </span>as<span class=\"w\"> </span>expected.<span class=\"w\"> </span>However,<span class=\"w\"> </span>at<span class=\"w\"> </span>runtime,<span class=\"w\"> </span>some<span class=\"w\"> </span>double<span class=\"w\"> </span>values<span class=\"w\"> </span>were<span class=\"w\"> </span>replaced<span class=\"w\"> </span>by<span class=\"w\"> </span>NaN,<span class=\"w\"> </span>leading<span class=\"w\"> </span>to<span class=\"w\"> </span>incorrect<span class=\"w\"> </span>calculations<span class=\"w\"> </span>and<span class=\"w\"> </span>integer<span class=\"w\"> </span>overflows.\n\nFollowing<span class=\"w\"> </span>what<span class=\"w\"> </span>it<span class=\"w\"> </span>is<span class=\"w\"> </span>described<span class=\"w\"> </span><span class=\"k\">in</span><span class=\"w\"> </span>https://github.com/bytecodealliance/wasm-micro-runtime/blob/main/doc/xip.md\n\nI<span class=\"w\"> </span>tried<span class=\"w\"> </span>the<span class=\"w\"> </span>following<span class=\"w\"> </span>command.\n\n<span class=\"sb\">```</span>bash\n./wamrc<span class=\"w\"> </span>--xip<span class=\"w\"> </span>--size-level<span class=\"o\">=</span><span class=\"m\">3</span><span class=\"w\"> </span><span class=\"se\">\\</span>\n<span class=\"w\">        </span>--target<span class=\"o\">=</span>thumbv8m.base<span class=\"w\"> </span><span class=\"se\">\\</span>\n<span class=\"w\">        </span>--cpu<span class=\"o\">=</span>cortex-m33<span class=\"w\"> </span><span class=\"se\">\\</span>\n<span class=\"w\">        </span>--target-abi<span class=\"o\">=</span>eabi<span class=\"w\"> </span><span class=\"se\">\\</span>\n<span class=\"w\">        </span>--enable-builtin-intrinsics<span class=\"o\">=</span>fp.common<span class=\"w\"> </span><span class=\"se\">\\ </span><span class=\"o\">(</span>\n<span class=\"w\">        </span>-o<span class=\"w\"> </span>myfile_v8m.aot<span class=\"w\"> </span>./myfile.wasm\n\nWith<span class=\"w\"> </span>this<span class=\"w\"> </span>configuration,<span class=\"w\"> </span>the<span class=\"w\"> </span>WASM<span class=\"w\"> </span>module<span class=\"w\"> </span>fails<span class=\"w\"> </span>to<span class=\"w\"> </span>load<span class=\"w\"> </span>the<span class=\"w\">  </span>aot<span class=\"w\"> </span>module<span class=\"w\"> </span>and<span class=\"w\"> </span>outputs<span class=\"w\"> </span>the<span class=\"w\"> </span>following<span class=\"w\"> </span>error\n\n**<span class=\"w\"> </span>AOT<span class=\"w\"> </span>module<span class=\"w\"> </span>load<span class=\"w\"> </span>failed:<span class=\"w\"> </span>cannot<span class=\"w\"> </span>apply<span class=\"w\"> </span>relocation<span class=\"w\"> </span>to<span class=\"w\"> </span>text<span class=\"w\"> </span>section<span class=\"w\"> </span><span class=\"k\">for</span><span class=\"w\"> </span>aot<span class=\"w\"> </span>file<span class=\"w\"> </span>generated<span class=\"w\"> </span>with<span class=\"w\"> </span><span class=\"s2\">\"--enable-indirect-mode\"</span><span class=\"w\"> </span>flag**\n\nAm<span class=\"w\"> </span>I<span class=\"w\"> </span>missing<span class=\"w\"> </span>something?\n</code></pre></div>",
        "id": 520843046,
        "sender_full_name": "Borja Tellado",
        "timestamp": 1748424163
    },
    {
        "content": "<p>Would you mind transferring this issue to GitHub <a href=\"https://github.com/bytecodealliance/wasm-micro-runtime/issues\">https://github.com/bytecodealliance/wasm-micro-runtime/issues</a>. so I can involve some customers with experience on that feature?</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasm-micro-runtime/issues\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/1af15b239a7d5ada811df1716683750dc9cc2169/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f366563646132656538633438393164323466306465323434313062313535653365316161666633346534393637663435376132363362623464636230303632392f62797465636f6465616c6c69616e63652f7761736d2d6d6963726f2d72756e74696d65&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasm-micro-runtime/issues\" title=\"Issues · bytecodealliance/wasm-micro-runtime\">Issues · bytecodealliance/wasm-micro-runtime</a></div><div class=\"message_embed_description\">WebAssembly Micro Runtime (WAMR). Contribute to bytecodealliance/wasm-micro-runtime development by creating an account on GitHub.</div></div></div>",
        "id": 520889224,
        "sender_full_name": "lum1n0us",
        "timestamp": 1748437840
    },
    {
        "content": "<p>Ok, great !! I will transfer the issue</p>",
        "id": 520891272,
        "sender_full_name": "Borja Tellado",
        "timestamp": 1748438427
    }
]
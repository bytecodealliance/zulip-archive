[
    {
        "content": "<p>Hi, <br>\nI'm trying to use WAMR on top of some rust OS using the <code>wamr-rust-sdk</code> crate. This is only for testing/benchmarking pupose so I'm not worried about doing a proper port. <br>\nAnyway, after tinkering around I was able to compile to run on an NRF52840DK (Thumbv7 arch) and I have had errors regarding allocations. After tracking the source of my error, I realized that this is because I stubbed <code>os_mmap</code> from the <code>platform_api_vmcore.h</code>. I'm  surprised by this being an issue for two reasons:</p>\n<ul>\n<li>This function is in a section called <code>APIs required by WAMR AOT</code> and compiled without AOT support and in the configuration specified that I wanted to run the interpreter. </li>\n<li>I used the memory pool allocation strategy instead of using the system alloc strategy. </li>\n</ul>\n<p>This leads me to the following questions :</p>\n<ul>\n<li>Did I misunderstand something ? </li>\n<li>What does the memory pool strategy do if not use the provided pool to put the linear memory of the instances ? </li>\n<li>It seems to require more memory that I would have thought: loading the modules fails when the pool is under 120 KiB, despite the module weighing 262 bytes by itself and the linear memory seemingly not being part of the equation.</li>\n</ul>\n<p>The exact allocation path is related to the linear memory of the instance i'm trying to build. I'm using WAMR 2.3.1, the version used by the <code>wamr-rust-sdk</code></p>\n<p>Thanks in advance</p>",
        "id": 566942091,
        "sender_full_name": "Antoine Lavandier",
        "timestamp": 1767879059
    },
    {
        "content": "<p>I'm not quite following the sentence of \"because I stubbed os_mmap from the platform_api_vmcore.h.\" However, I assume it suggests that the problem is caused by an incorrect implementation of <code>os_mmap()</code>.</p>\n<p>The statement \"APIs required by WAMR AOT\" is outdated, that's for sure. It should be updated to reflect the fact that wasm_memory.c is used to create linear memory across all three allocation strategies.</p>\n<p>Besides the part for the WASM file itself, the runtime also requires memory resources for its own operation and execution, which can be configured by arguments of <code>wasm_runtime_instantiate()</code> such as <code>default_stack_size</code> and <code>host_managed_heap_size</code> . Additionally, the initial and maximum linear memory size, like <code>(memory 10 20)</code>, of the WASM module can be partially controlled by compilation flags.</p>",
        "id": 567431670,
        "sender_full_name": "lum1n0us",
        "timestamp": 1768183716
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"415410\">lum1n0us</span> <a href=\"#narrow/channel/290350-wamr/topic/Questions.20regarding.20memory.20allocation.20strategies/near/567431670\">said</a>:</p>\n<blockquote>\n<p>I'm not quite following the sentence of \"because I stubbed os_mmap from the platform_api_vmcore.h.\" However, I assume it suggests that the problem is caused by an incorrect implementation of <code>os_mmap()</code>.</p>\n</blockquote>\n<p>Not quite an incorrect implementation, I just hadn't implemented it. </p>\n<blockquote>\n<p>The statement \"APIs required by WAMR AOT\" is outdated, that's for sure. It should be updated to reflect the fact that wasm_memory.c is used to create linear memory across all three allocation strategies.</p>\n</blockquote>\n<p>Ok, that's what I figured but it's nice to be reassured that I'm not crazy. </p>\n<blockquote>\n<p>Besides the part for the WASM file itself, the runtime also requires memory resources for its own operation and execution, which can be configured by arguments of <code>wasm_runtime_instantiate()</code> such as <code>default_stack_size</code> and <code>host_managed_heap_size</code> . Additionally, the initial and maximum linear memory size, like <code>(memory 10 20)</code>, of the WASM module can be partially controlled by compilation flags.</p>\n</blockquote>\n<p>Makes sense, however in the specific context I didn't have much control on <code>wasm_runtime_instantiate</code> arguments so maybe 120KiB is a default somewhere ? </p>\n<p>That being said, I still don't get what <code>Alloc_With_Pool</code> does if <code>os_mmap</code> is still used in the process of allocating the linear memory. Maybe it's another case of outdated information but this <a href=\"https://bytecodealliance.github.io/wamr.dev/blog/the-wamr-memory-model/#memory-allocators\">blog post</a> flat out says </p>\n<blockquote>\n<p>The mode restricts all the memory used by wamr in a fixed memory region that was provided by the host during initiating the WAMR runtime. All the memory categories are allocated inside the memory region by using WAMR built-in memory allocator <code>ems</code>.</p>\n</blockquote>\n<p>Which to me means that <code>os_mmap</code> shouldn't have to be implemented. Or is supposed to be implemented by redirecting calls to this <code>ems</code> allocator ?</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://bytecodealliance.github.io/wamr.dev/blog/the-wamr-memory-model/#memory-allocators\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/8c54c649f4409f2cc38adadf3d6f8d43a782c48f/68747470733a2f2f62797465636f6465616c6c69616e63652e6769746875622e696f2f77616d722e6465762f77616d722e706e67&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://bytecodealliance.github.io/wamr.dev/blog/the-wamr-memory-model/#memory-allocators\" title=\"The WAMR memory model\">The WAMR memory model</a></div><div class=\"message_embed_description\">The WAMR memory categories # According to the lifecycle and associated functionalities, we put the memory used in WAMR into four categories:\nruntime memory: memory used by runtime globally Wasm module memory: memory used for a loaded Wasm module, freed when the module is unloaded Wasm module instance memory: memory used for a Wasm module instance, freed when the instance is destroyed Execution environment memory: memory use for execution of Wasm function from a Wasm module instance.</div></div></div>",
        "id": 567468483,
        "sender_full_name": "Antoine Lavandier",
        "timestamp": 1768207996
    },
    {
        "content": "<p><span aria-label=\"thinking\" class=\"emoji emoji-1f914\" role=\"img\" title=\"thinking\">:thinking:</span>  In that case, you might want to refer to the implementation of the Zephyr platform in the link: <a href=\"https://github.com/bytecodealliance/wasm-micro-runtime/blob/main/core/shared/platform/zephyr/zephyr_platform.c#L184-L221\">https://github.com/bytecodealliance/wasm-micro-runtime/blob/main/core/shared/platform/zephyr/zephyr_platform.c#L184-L221</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasm-micro-runtime/blob/main/core/shared/platform/zephyr/zephyr_platform.c#L184-L221\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/ba5caa1b10a026b4b0db667f3cc138c6d7e49a78/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f613637353838633337623135326330623234323534306564386435343262643635663739616135336361656131623031326632636232303764343837386330312f62797465636f6465616c6c69616e63652f7761736d2d6d6963726f2d72756e74696d65&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasm-micro-runtime/blob/main/core/shared/platform/zephyr/zephyr_platform.c#L184-L221\" title=\"wasm-micro-runtime/core/shared/platform/zephyr/zephyr_platform.c at main · bytecodealliance/wasm-micro-runtime\">wasm-micro-runtime/core/shared/platform/zephyr/zephyr_platform.c at main · bytecodealliance/wasm-micro-runtime</a></div><div class=\"message_embed_description\">WebAssembly Micro Runtime (WAMR). Contribute to bytecodealliance/wasm-micro-runtime development by creating an account on GitHub.</div></div></div>",
        "id": 567906843,
        "sender_full_name": "lum1n0us",
        "timestamp": 1768368396
    },
    {
        "content": "<p>Thanks for the pointer. I have already basically copied the implementation from RIOT and now the interpreter works. I still have some issues with AOT however. Still I'm not sure that I grasp the various memory models of WAMR if I end up using the system allocator whether I want to or not... </p>\n<p>For the WAMR AOT stuff, in some files, wamr fails with <code>AOT module load failed: resolve symbol __aeabi_memclr failed</code>. <br>\nThe target is an Rasperry PI Pico 2 W. Wamr is compiled with  <code>WAMR_BUILD_TARGET = \"THUMBV8M.MAIN\"</code> and the AOT file was produced with <code>wamrc --target=thumbv8m.main --target-abi=eabihf</code> <br>\nAny idea of where that could come from ? </p>\n<p>Thanks for the previous replies btw !</p>",
        "id": 567931421,
        "sender_full_name": "Antoine Lavandier",
        "timestamp": 1768381260
    },
    {
        "content": "<p>You might want to add platform specification implementation under core/iwasm/aot/arch.</p>",
        "id": 569992333,
        "sender_full_name": "lum1n0us",
        "timestamp": 1769386488
    }
]
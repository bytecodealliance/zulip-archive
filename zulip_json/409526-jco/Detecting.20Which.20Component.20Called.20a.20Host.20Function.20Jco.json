[
    {
        "content": "<p>I'm trying to figure out if in jco-transpile bindings (e.g. preview2-shims or some other custom wit implementation)  there's any kind of state.<br>\nIn wasmtime bindings, you implement everything as a trait, and the first parameter is always <code>&amp;mut self</code>. You can keep any state inside self. Is there anything like this in Jco?</p>\n<p>I'd like to use this in cases where there are multiple wasm components running on the same page, and I wanna customize the behavior according to which component called a function.</p>",
        "id": 566862215,
        "sender_full_name": "Mendy Berger",
        "timestamp": 1767844307
    },
    {
        "content": "<p>This topic was moved here from <a class=\"stream-topic\" data-stream-id=\"206238\" href=\"/#narrow/channel/206238-general/topic/Detecting.20Which.20Component.20Called.20a.20Host.20Function.20Jco\">#general &gt; Detecting Which Component Called a Host Function Jco</a> by <span class=\"user-mention silent\" data-user-id=\"253994\">Alex Crichton</span>.</p>",
        "id": 566968078,
        "sender_full_name": "Notification Bot",
        "timestamp": 1767885561
    },
    {
        "content": "<p>I can't recall; <span class=\"user-mention\" data-user-id=\"234973\">@Till Schneidereit</span>  should know, or perhaps <span class=\"user-mention\" data-user-id=\"763150\">@Tomasz Andrzejak</span></p>",
        "id": 566995684,
        "sender_full_name": "Ralph",
        "timestamp": 1767892989
    },
    {
        "content": "<p>Hey <span class=\"user-mention\" data-user-id=\"419274\">@Mendy Berger</span> could you expand on what you mean here? Do you mean whether <code>preview2-shim</code> depend on any global state <em>outside</em> the module? They are ES modules, so is the question more whether there is any use of <code>globalThis</code>?</p>\n<p>Either way, I think a quick way to figure out would be to inspect code from a transpiled component -- it's not too difficult to scan (ignoring any complaints about <em>how</em> the code is written/what code is there, of course!)</p>\n<p>With regards to shims, that's entirely up to shims and how you bundle -- in general the shims are also modules, but you could easily write a shim that does depend on global state or one that does not. It also depends on what you're targeting with the shim -- obviously the Node shim versus browser shim (which is pretty incomplete!) must depend on platform primitives, which are globals in a sense... There's no place to pass in a custom implementation of platform primitives like <code>TextEncoder</code> for example, but not sure if that's what you mean by state.</p>\n<p>A good place to look might be <a href=\"https://github.com/bytecodealliance/jco/blob/main/packages/preview2-shim/lib/nodejs/filesystem.js#L722\">filesystem implementation from P2-shim</a> -- for example the <code>preopenEntries</code> array is clearly state, but not sure that's what you're referring to.</p>\n<p>When you say customize their behavior according to which component called a function, do you mean... when each component calls an import? If that's the case, you should be able to achieve that by wrapping the imports object (or any individual import) with a proxy.</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/jco/blob/main/packages/preview2-shim/lib/nodejs/filesystem.js#L722\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/4faf00a6048d320f771d0b4a0077da2c44145407/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f333033373462313535363233323666656430313039316335353831616435316262626137323231313265623035633534613132626337623431313539336631382f62797465636f6465616c6c69616e63652f6a636f&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/jco/blob/main/packages/preview2-shim/lib/nodejs/filesystem.js#L722\" title=\"jco/packages/preview2-shim/lib/nodejs/filesystem.js at main · bytecodealliance/jco\">jco/packages/preview2-shim/lib/nodejs/filesystem.js at main · bytecodealliance/jco</a></div><div class=\"message_embed_description\">JavaScript toolchain for working with WebAssembly Components - bytecodealliance/jco</div></div></div>",
        "id": 567089935,
        "sender_full_name": "Victor Adossi",
        "timestamp": 1767946730
    },
    {
        "content": "<blockquote>\n<p>When you say customize their behavior according to which component called a function, do you mean... when each component calls an import?</p>\n</blockquote>\n<p>That's pretty much what I'm looking for. <br>\nIs there any way I can figure out from inside the function which component called it? <br>\nEven with a proxy, how would I know which component called?</p>",
        "id": 567144958,
        "sender_full_name": "Mendy Berger",
        "timestamp": 1767966255
    },
    {
        "content": "<p>I would give each component its own host wrapper that injects the component id, but I haven't used jco in a while so I'm not sure if giving different hosts to instances is hard with the current implementation</p>",
        "id": 567145395,
        "sender_full_name": "Ramon Klass",
        "timestamp": 1767966391
    },
    {
        "content": "<p>What Ramon suggested sounds right -- if the function you're calling is an import, then you can give each instantiation wrapper/proxy that identifies the instantiation.</p>\n<p>Do you have a quick code snippet of what your instantiation looks like? I think that would help make some of these worries concrete/work through them -- <em>I think</em> you should be good to go by \"just\" wrapping the imports that components are using (then you would know which component was using that import).</p>",
        "id": 567370960,
        "sender_full_name": "Victor Adossi",
        "timestamp": 1768113202
    }
]
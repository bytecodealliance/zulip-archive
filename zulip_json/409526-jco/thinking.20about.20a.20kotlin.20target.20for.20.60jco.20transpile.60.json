[
    {
        "content": "<p>I'm blown away by wasm components and want to use them in the JVM, but the wasm runtimes available there don't support components. This situation is similar to Node.js and browsers, where I've successfully used <code>jco transpile</code> to work around the issue. That set me thinking: it should be possible to enhance <code>jco transpile</code> and have it generate Kotlin code instead of Javascript. Has anyone ever looked into more targets than only JS? Are there any caveats to be aware of? I have an early prototype that looks promising, but I wanted to check here if there are any unknown unknowns lurking around the corner.</p>",
        "id": 572445796,
        "sender_full_name": "Adolfo Ochagavía",
        "timestamp": 1770404211
    },
    {
        "content": "<p>For additional context, I'm not interested in running components that rely on WASI interfaces, just \"wasm core\". I'm hoping that would reduce the implementation surface considerably.</p>",
        "id": 572446549,
        "sender_full_name": "Adolfo Ochagavía",
        "timestamp": 1770404464
    },
    {
        "content": "<p>In general the approach that jco uses, which is to take a wasm component and decompose it into 1. a set of wasm modules, and 2. glue code that implements a component runtime specific to that component by instantiating those modules, is a great architecture which we encourage folks to pursue if they arent able to use a native component runtime on their platform yet</p>",
        "id": 572448299,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1770405148
    },
    {
        "content": "<p>jco is architected this way, and i recall someone did something similar for python but i dont have a link to it handy. in general its easiest in languages that have eval, since then it can be \"ordinary\" library code, but theres no reason to not use it as a \"macro\" pass in languages without eval.</p>",
        "id": 572448382,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1770405186
    },
    {
        "content": "<p>I'm enthusiastic about you taking that approach to a kotlin component runtime, using whatever core wasm runtime you like. Its quite possible that buildign such a thing would crib a whole lot of code from jco, which is probably the best implementation of the rough architecture described. But I don't think it would actually be an advantage to either your project or to jco to have both languages supported inside the same tool. My advice is to fork jco and hack it into exactly what you need</p>",
        "id": 572448800,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1770405349
    },
    {
        "content": "<p>That's great to hear, thanks a lot! I was indeed thinking of a fork, or even a reimplementation (I'm keen on using Rust, because of the language and because they have good libraries for wasm-related stuff). We'll see how it goes...</p>",
        "id": 572467018,
        "sender_full_name": "Adolfo Ochagavía",
        "timestamp": 1770413951
    },
    {
        "content": "<p>AFAIK, the core of jco that knows how to parse/decompose a component is written in Rust - its wasm-tools + wasmtime-environ</p>",
        "id": 572487082,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1770427168
    },
    {
        "content": "<p>(its been many years since ive been in that code so its possible something has changed, but i doubt it - the algorithm in wasmtime-environ has, afaik, never been replicated elsewhere)</p>",
        "id": 572487153,
        "sender_full_name": "Pat Hickey",
        "timestamp": 1770427225
    },
    {
        "content": "<p>Hey <span class=\"user-mention\" data-user-id=\"1024632\">@Adolfo Ochagavía</span> a bit late but I think that what I can add is that you should take a look at the following repos/codebases:</p>\n<ul>\n<li><a href=\"https://github.com/bytecodealliance/wasm-tools/blob/b3666ed1d3b4758639fd7d8d66f1067702d614be/README.md?plain=1#L152\"><code>wasm-tools component unbundle</code></a> (i.e. the first step of decomposing a component into modules that are easier to run for runtimes that don't yet support the ComponentModel)</li>\n<li><a href=\"https://github.com/bytecodealliance/wasm-tools/tree/main/crates/wasmparser\"><code>wasmparser</code></a> <em>technically</em> unnecesary, but obviously you'll want to be able to create scaffolding around the WIT and sections included in the component. A lot of the work Jco does is essentially iterating the structure of the Wasm and dealing with various sections and generating code, as I'm sure you've seen.</li>\n<li><a href=\"https://github.com/bytecodealliance/wit-bindgen/tree/main/crates/core\"><code>wit-bindgen-core</code></a> is actually not a requirement but it's a big part of <code>jco transpile</code> -- by providing essentially a visitor to <a href=\"https://github.com/bytecodealliance/wit-bindgen/blob/76e9f08917cacce2515445dc69ce923410449e5f/crates/core/src/abi.rs#L769\"><code>abi::call</code></a>, you can do generation for various distinct instructions (some pseudo instructions/more representing areas of execution).</li>\n</ul>\n<p>Glad you're keen on using Rust, because much of the tooling is written in Rust :)</p>\n<p>A rewrite of Jco is great place to start, sorry for any weird code you see! We're always happy to take pull requests or contributions and would be delighted if you took some notes on hard to understand bits/ways the codebase could be simpler.</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasm-tools/blob/b3666ed1d3b4758639fd7d8d66f1067702d614be/README.md?plain=1#L152\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/de6a06960b88727ecee9d5842a177987f56d97ae/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f353831356332626138326366306236313031333734333836313233373261623434323531643735383431336236633066353437393333366164386337626137332f62797465636f6465616c6c69616e63652f7761736d2d746f6f6c73&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasm-tools/blob/b3666ed1d3b4758639fd7d8d66f1067702d614be/README.md?plain=1#L152\" title=\"wasm-tools/README.md at b3666ed1d3b4758639fd7d8d66f1067702d614be · bytecodealliance/wasm-tools\">wasm-tools/README.md at b3666ed1d3b4758639fd7d8d66f1067702d614be · bytecodealliance/wasm-tools</a></div><div class=\"message_embed_description\"> CLI and Rust libraries for low-level manipulation of WebAssembly modules  - bytecodealliance/wasm-tools</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasm-tools/tree/main/crates/wasmparser\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/de6a06960b88727ecee9d5842a177987f56d97ae/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f353831356332626138326366306236313031333734333836313233373261623434323531643735383431336236633066353437393333366164386337626137332f62797465636f6465616c6c69616e63652f7761736d2d746f6f6c73&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasm-tools/tree/main/crates/wasmparser\" title=\"wasm-tools/crates/wasmparser at main · bytecodealliance/wasm-tools\">wasm-tools/crates/wasmparser at main · bytecodealliance/wasm-tools</a></div><div class=\"message_embed_description\"> CLI and Rust libraries for low-level manipulation of WebAssembly modules  - bytecodealliance/wasm-tools</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wit-bindgen/tree/main/crates/core\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/00667b18d08d4bf1aaa3a9d763f475dfc456295a/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f323966393236396466313832653263656236656133636331633863396637646239373664646262393330366566303039636639666461316365616631303937642f62797465636f6465616c6c69616e63652f7769742d62696e6467656e&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wit-bindgen/tree/main/crates/core\" title=\"wit-bindgen/crates/core at main · bytecodealliance/wit-bindgen\">wit-bindgen/crates/core at main · bytecodealliance/wit-bindgen</a></div><div class=\"message_embed_description\">A language binding generator for WebAssembly interface types - bytecodealliance/wit-bindgen</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wit-bindgen/blob/76e9f08917cacce2515445dc69ce923410449e5f/crates/core/src/abi.rs#L769\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/00667b18d08d4bf1aaa3a9d763f475dfc456295a/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f323966393236396466313832653263656236656133636331633863396637646239373664646262393330366566303039636639666461316365616631303937642f62797465636f6465616c6c69616e63652f7769742d62696e6467656e&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wit-bindgen/blob/76e9f08917cacce2515445dc69ce923410449e5f/crates/core/src/abi.rs#L769\" title=\"wit-bindgen/crates/core/src/abi.rs at 76e9f08917cacce2515445dc69ce923410449e5f · bytecodealliance/wit-bindgen\">wit-bindgen/crates/core/src/abi.rs at 76e9f08917cacce2515445dc69ce923410449e5f · bytecodealliance/wit-bindgen</a></div><div class=\"message_embed_description\">A language binding generator for WebAssembly interface types - bytecodealliance/wit-bindgen</div></div></div>",
        "id": 572504109,
        "sender_full_name": "Victor Adossi",
        "timestamp": 1770445296
    },
    {
        "content": "<p>There is some chance that <a href=\"https://github.com/pulseengine/meld\">https://github.com/pulseengine/meld</a> might work (create multi memory modules from components)</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/pulseengine/meld\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/b6b6c527834ea8b230ba915f54ea2d230fc66c83/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f303436383963306265623439633330396461353865393734626364396466663330663162343863663663666439303439666663616238316238346433323430652f70756c7365656e67696e652f6d656c64&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/pulseengine/meld\" title=\"GitHub - pulseengine/meld: Static WebAssembly component fusion\">GitHub - pulseengine/meld: Static WebAssembly component fusion</a></div><div class=\"message_embed_description\">Static WebAssembly component fusion. Contribute to pulseengine/meld development by creating an account on GitHub.</div></div></div>",
        "id": 572507630,
        "sender_full_name": "Christof Petig",
        "timestamp": 1770449840
    },
    {
        "content": "<p>you might also want to chat with <span class=\"user-mention\" data-user-id=\"548708\">@Zalim Bashorov (Kotlin_, JetBrains)</span> about your JVM/Kotlin thing....</p>",
        "id": 572832548,
        "sender_full_name": "Ralph",
        "timestamp": 1770655279
    },
    {
        "content": "<p>Thanks a lot for the great ideas! I'll keep you posted ;)</p>",
        "id": 573064898,
        "sender_full_name": "Adolfo Ochagavía",
        "timestamp": 1770735376
    }
]
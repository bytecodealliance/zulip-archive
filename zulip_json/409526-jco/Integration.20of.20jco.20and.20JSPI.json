[
    {
        "content": "<p>I would like to use jco together with JSPI. To be specific, I have many WASIp2 (which are currently wrapped WASIp1) applications, which are in turn wrapped with jco and ran from the web as well as other platforms. Since wasi-virt is incapable of providing a filesystem <em>overlay</em>, I have to implement the entire filesystem in JavaScript. </p>\n<p>Right now, I have to download the entire filesystem upfront. I would like to download files on-demand whenever they're opened (or at least to provide the option to do so), to avoid massive waste of bandwidth when packages like Clang are involved (where sizes of 100..400 MB are not uncommon). To do this, I need jco to wrap the <code>wasi:cli/run</code> export in <code>WebAssembly.promising</code> (easy enough), and the <code>path_open</code> import (or its WASIp2 equivalent) in <code>WebAssembly.Suspending</code> (which <code>--async-import</code> seems to silently fail to do).</p>\n<p>How do I do this with jco?</p>",
        "id": 547761784,
        "sender_full_name": "Catherine (whitequark)",
        "timestamp": 1761755126
    },
    {
        "content": "<p>Have you tried with the <code>asyncMode: 'jspi'</code> option just yet? Also, I'm assuming you already know about <code>--instantiation=async</code>?</p>",
        "id": 547762863,
        "sender_full_name": "Victor Adossi",
        "timestamp": 1761755393
    },
    {
        "content": "<p>Here's an example from a test:</p>\n<p><a href=\"https://github.com/bytecodealliance/jco/blob/fd13566145b81611c7ad400cb115ae195f2c30f6/packages/jco/test/jspi.js#L72\">https://github.com/bytecodealliance/jco/blob/fd13566145b81611c7ad400cb115ae195f2c30f6/packages/jco/test/jspi.js#L72</a></p>\n<p>Unfortunately we don't have a good example in the Jco book, but we do have the option documented:</p>\n<p><a href=\"https://bytecodealliance.github.io/jco/transpiling.html?highlight=jspi#options\">https://bytecodealliance.github.io/jco/transpiling.html?highlight=jspi#options</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/jco/blob/fd13566145b81611c7ad400cb115ae195f2c30f6/packages/jco/test/jspi.js#L72\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/9de63283e00e68386926e114af382da5a4e218fa/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f643266363864306334363932373139333364353739336665383732396133376633623236373863393363346538396131633436336635313362383834393366382f62797465636f6465616c6c69616e63652f6a636f&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/jco/blob/fd13566145b81611c7ad400cb115ae195f2c30f6/packages/jco/test/jspi.js#L72\" title=\"jco/packages/jco/test/jspi.js at fd13566145b81611c7ad400cb115ae195f2c30f6 路 bytecodealliance/jco\">jco/packages/jco/test/jspi.js at fd13566145b81611c7ad400cb115ae195f2c30f6 路 bytecodealliance/jco</a></div><div class=\"message_embed_description\">JavaScript toolchain for working with WebAssembly Components - bytecodealliance/jco</div></div></div>",
        "id": 547763195,
        "sender_full_name": "Victor Adossi",
        "timestamp": 1761755468
    },
    {
        "content": "<p>As you can see from the test you'll need to <a href=\"https://github.com/bytecodealliance/jco/blob/fd13566145b81611c7ad400cb115ae195f2c30f6/packages/jco/test/jspi.js#L88\">specify your async imports as well</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/jco/blob/fd13566145b81611c7ad400cb115ae195f2c30f6/packages/jco/test/jspi.js#L88\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/9de63283e00e68386926e114af382da5a4e218fa/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f643266363864306334363932373139333364353739336665383732396133376633623236373863393363346538396131633436336635313362383834393366382f62797465636f6465616c6c69616e63652f6a636f&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/jco/blob/fd13566145b81611c7ad400cb115ae195f2c30f6/packages/jco/test/jspi.js#L88\" title=\"jco/packages/jco/test/jspi.js at fd13566145b81611c7ad400cb115ae195f2c30f6 路 bytecodealliance/jco\">jco/packages/jco/test/jspi.js at fd13566145b81611c7ad400cb115ae195f2c30f6 路 bytecodealliance/jco</a></div><div class=\"message_embed_description\">JavaScript toolchain for working with WebAssembly Components - bytecodealliance/jco</div></div></div>",
        "id": 547763357,
        "sender_full_name": "Victor Adossi",
        "timestamp": 1761755503
    },
    {
        "content": "<p>I'd love to know which documentation you took a quick glance at to see where we should include better docs on this, but the book is probably a good start (contributions welcome of course!).</p>\n<p>If you'd like to create a ticket against jco that would help with tracking the improvement to the documentation</p>",
        "id": 547763598,
        "sender_full_name": "Victor Adossi",
        "timestamp": 1761755557
    },
    {
        "content": "<p>Turns out I had a small and difficult to notice typo in my <code>jco</code> invocation. The following seems to do what I want:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">jco</span><span class=\"w\"> </span><span class=\"p\">[</span><span class=\"o\">..</span><span class=\"p\">.]</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"k\">async</span><span class=\"o\">-</span><span class=\"n\">mode</span><span class=\"w\"> </span><span class=\"n\">jspi</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"k\">async</span><span class=\"o\">-</span><span class=\"n\">exports</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">wasi</span><span class=\"p\">:</span><span class=\"nc\">cli</span><span class=\"o\">/</span><span class=\"n\">run</span><span class=\"p\">#</span><span class=\"n\">run</span><span class=\"o\">'</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"k\">async</span><span class=\"o\">-</span><span class=\"n\">imports</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">wasi</span><span class=\"p\">:</span><span class=\"nc\">filesystem</span><span class=\"o\">/</span><span class=\"n\">types</span><span class=\"cp\">#[method]</span><span class=\"n\">descriptor</span><span class=\"p\">.</span><span class=\"n\">open</span><span class=\"o\">-</span><span class=\"n\">at</span><span class=\"o\">'</span>\n</code></pre></div>\n<p>Thanks!</p>",
        "id": 547778714,
        "sender_full_name": "Catherine (whitequark)",
        "timestamp": 1761760091
    }
]
[
    {
        "content": "<p>I'm seeing a problem when using <code>jco transpile</code> on a minimal async string-returning export.</p>\n<p>Minimal WIT:</p>\n<div class=\"codehilite\"><pre><span></span><code>package example:async-exports;\n\nworld w {\n    export get-literal: async func() -&gt; string;\n}\n</code></pre></div>\n\n<p>Rust implementation:</p>\n<div class=\"codehilite\"><pre><span></span><code>async fn get_literal() -&gt; String {\n    &quot;hello&quot;.into()\n}\n</code></pre></div>\n\n<p>This compiles to Wasm successfully.</p>\n<p>However, when running <code>jco transpile</code>, the generated JS fails at runtime.</p>\n<p>The generated JS includes a trampoline like:</p>\n<div class=\"codehilite\"><pre><span></span><code>const trampoline17 = taskReturn.bind(\n    null,\n    0,\n    true,\n    memory0,\n    null,\n    [_liftFlatStringUTF8],\n);\n</code></pre></div>\n\n<p><code>_liftFlatStringUTF8</code> internally uses <code>utf8Decoder</code>, but the generated JS<br>\nnever defines:</p>\n<div class=\"codehilite\"><pre><span></span><code>const utf8Decoder = new TextDecoder();\n</code></pre></div>\n\n<p>As a result, calling the export throws:</p>\n<div class=\"codehilite\"><pre><span></span><code>ReferenceError: utf8Decoder is not defined\n</code></pre></div>\n\n<p>After debugging, I found that the wasm instructions do not contain a<br>\n<code>StringLift</code> instruction. <code>Generator::lift</code> inside wit-bindgen is private,<br>\nand <code>StringLift</code> is only emitted in specific cases. For this async export,<br>\nno lift instruction is emitted, so jco never generates the decoding code.</p>\n<p>My question:</p>\n<p>**Should wit-bindgen be emitting a <code>StringLift</code> instruction for an async<br>\nfunction returning <code>string</code>? Or is jco expected to generate the string-lift<br>\ncode for returned strings even when wit-bindgen doesn't emit <code>StringLift</code>?**</p>\n<p>At the moment, the result is that any async export returning <code>string</code><br>\ncauses runtime failure due to missing UTF-8 decoder initialization.</p>\n<p>Would appreciate clarification on where the responsibility lies.</p>",
        "id": 560900366,
        "sender_full_name": "ktz_alias",
        "timestamp": 1764409573
    },
    {
        "content": "<p>Hey <span class=\"user-mention\" data-user-id=\"1001980\">@ktz_alias</span> so currently async P3 work in Jco is experimental, but this is a case that <em>should</em> work. There is a question of which version of the tooling you used to produce this component as well, since there have been recent changes to make <code>async</code> part of the function rather than a hint which we're not compatible with <em>at all</em> right now. I'm going to assume you're using just slightly older tooling that is still compatible (please let me know if I'm wrong here -- IIRC if you weren't lots of things would have broken before you could run of this, if you're using the Rust toolchain).</p>\n<p>I think you raise a good point here about upstream wit-bindgen's behavior (please feel free to jump in <span class=\"user-mention\" data-user-id=\"509936\">@Joel Dice</span>  / <span class=\"user-mention\" data-user-id=\"253994\">@Alex Crichton</span> ), as the resulting <code>string</code> is lifted \"dynamically\" during <a href=\"https://github.com/WebAssembly/component-model/blob/main/design/mvp/CanonicalABI.md#-canon-taskreturn\"><code>task.return</code></a>. <code>StringLift</code> is basically <code>ListCanonLift</code> which is <em>supposedly</em> called to deal with values by popping them off the stack -- I think in this case the async code is writing those values directly to the memory (the results storage area). This goes through <code>lift_from_memory</code>, and as you mentioned, <a href=\"https://github.com/bytecodealliance/wit-bindgen/blob/369bbb052c14feef54a10060fd93b0e5bf3c6f2a/crates/core/src/abi.rs#L2003\"><code>String</code> does not emit when it reads</a>, where as <a href=\"https://github.com/bytecodealliance/wit-bindgen/blob/369bbb052c14feef54a10060fd93b0e5bf3c6f2a/crates/core/src/abi.rs#L2024\">others (eg.<code>Record</code>s) do</a> (and they have the same blurb about stacks). </p>\n<p>The thing is, string lifting code there has been in place for 2 years (!), so reads from memory don't seem to have done this for a while.</p>\n<p>(While we're here, <code>ErrorContext</code> also maybe should be emitting an <code>ErrorContextLift</code>...)</p>\n<p>Regardless of whether the tooling should be changed or not (it <em>seems</em> like it should!) on the Jco side I think we should fix the lifting function here to require the decoder intrinsic every time we see see the flat string lift happen, since we really can't have one without the other in any case and the shared text decoder is a jco-side optimization.</p>\n<p>Will have a patch up for this soon.</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/WebAssembly/component-model/blob/main/design/mvp/CanonicalABI.md#-canon-taskreturn\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/86d79d885cc78e36e204908364456bcc1796b539/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f666333343531333135346261333262353262393361653037396338666434356162306461356565356439643431316639653062316133663338343461313930322f576562417373656d626c792f636f6d706f6e656e742d6d6f64656c&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/WebAssembly/component-model/blob/main/design/mvp/CanonicalABI.md#-canon-taskreturn\" title=\"component-model/design/mvp/CanonicalABI.md at main · WebAssembly/component-model\">component-model/design/mvp/CanonicalABI.md at main · WebAssembly/component-model</a></div><div class=\"message_embed_description\">Repository for design and specification of the Component Model - WebAssembly/component-model</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wit-bindgen/blob/369bbb052c14feef54a10060fd93b0e5bf3c6f2a/crates/core/src/abi.rs#L2003\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/cddb263b456df496dfc86a85967ddf51096c1fb8/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f306564393330353339646462636134663964633539353235333138303232636330353363623431333562376666636361626135376434653136636461303761322f62797465636f6465616c6c69616e63652f7769742d62696e6467656e&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wit-bindgen/blob/369bbb052c14feef54a10060fd93b0e5bf3c6f2a/crates/core/src/abi.rs#L2003\" title=\"wit-bindgen/crates/core/src/abi.rs at 369bbb052c14feef54a10060fd93b0e5bf3c6f2a · bytecodealliance/wit-bindgen\">wit-bindgen/crates/core/src/abi.rs at 369bbb052c14feef54a10060fd93b0e5bf3c6f2a · bytecodealliance/wit-bindgen</a></div><div class=\"message_embed_description\">A language binding generator for WebAssembly interface types - bytecodealliance/wit-bindgen</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wit-bindgen/blob/369bbb052c14feef54a10060fd93b0e5bf3c6f2a/crates/core/src/abi.rs#L2024\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/cddb263b456df496dfc86a85967ddf51096c1fb8/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f306564393330353339646462636134663964633539353235333138303232636330353363623431333562376666636361626135376434653136636461303761322f62797465636f6465616c6c69616e63652f7769742d62696e6467656e&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wit-bindgen/blob/369bbb052c14feef54a10060fd93b0e5bf3c6f2a/crates/core/src/abi.rs#L2024\" title=\"wit-bindgen/crates/core/src/abi.rs at 369bbb052c14feef54a10060fd93b0e5bf3c6f2a · bytecodealliance/wit-bindgen\">wit-bindgen/crates/core/src/abi.rs at 369bbb052c14feef54a10060fd93b0e5bf3c6f2a · bytecodealliance/wit-bindgen</a></div><div class=\"message_embed_description\">A language binding generator for WebAssembly interface types - bytecodealliance/wit-bindgen</div></div></div>",
        "id": 561132225,
        "sender_full_name": "Victor Adossi",
        "timestamp": 1764588292
    },
    {
        "content": "<p>If you wouldn't mind submitting an issue to jco along with a reproduction component that would be fantastic -- happy to include this as part of the test suite since it's an external toolchain interop bug.</p>",
        "id": 561133290,
        "sender_full_name": "Victor Adossi",
        "timestamp": 1764588619
    },
    {
        "content": "<p><a href=\"https://github.com/bytecodealliance/jco/pull/1142\">PR for the jco-side fix</a> is up, I'll either get that reproduction from you or make one and add a test on to the PR</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/jco/pull/1142\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/7dc99c9cedd6ae273abb5daab3cadbf31afd339c/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f383430613933653134346363376633316534376138366663653137383334323934666139316633346166613432613964336462653630663337666437656165332f62797465636f6465616c6c69616e63652f6a636f2f70756c6c2f31313432&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/jco/pull/1142\" title=\"fix(jco): require utf8 decoder for flat string lifts by vados-cosmonic · Pull Request #1142 · bytecodealliance/jco\">fix(jco): require utf8 decoder for flat string lifts by vados-cosmonic · Pull Request #1142 · bytecodealliance/jco</a></div><div class=\"message_embed_description\">This commit fixes a bug by which strings loaded from memory during async returns did not have the shared decoder (created via intrinsic) present.\nThis commit stops short of reworking the dependency...</div></div></div>",
        "id": 561133720,
        "sender_full_name": "Victor Adossi",
        "timestamp": 1764588747
    },
    {
        "content": "<p>Another <a href=\"https://github.com/bytecodealliance/jco/pull/1143\">jco side fix</a> was required -- a patch release will be out soon, should be out within the next hour!</p>\n<p>Note that <em>for now</em> you should be using (and I assume you <em>already are</em> using) a version of <code>wit-bindgen</code> strictly earlier than 0.48.0. This is what <code>jco</code> is pinned to, for now until we absorb the aforementioned function async-ness changes!</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/jco/pull/1143\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/43ca06f50ee9a8694a11a3d3e368c518baa33ad5/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f613237376361306636343639356561303436333434643365623464303164643462623939646462646335633231373534653162396163633066663863623564382f62797465636f6465616c6c69616e63652f6a636f2f70756c6c2f31313433&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/jco/pull/1143\" title=\"fix(jco): async return writing for caller memory by vados-cosmonic · Pull Request #1143 · bytecodealliance/jco\">fix(jco): async return writing for caller memory by vados-cosmonic · Pull Request #1143 · bytecodealliance/jco</a></div><div class=\"message_embed_description\">This commit fixes a bug where the memory for writing to was being retrieved too eagerly (@ trampoline fn binding time), and was not available properly when performing async task.returns.</div></div></div>",
        "id": 561154353,
        "sender_full_name": "Victor Adossi",
        "timestamp": 1764594599
    },
    {
        "content": "<p>Thanks!<br>\nHere are the versions of the toolchain I used to build the component:</p>\n<p>rust: 1.91.1 (ea2d97820 2025-10-10)<br>\nwit-bindgen: 0.47.0<br>\nwit-bindgen-cli: 0.47.0<br>\nwasm-tools: 1.240.0 (dafe42f8f 2025-10-08)</p>\n<p>These were used to build the small test component (<code>async func() -&gt; string</code>) that reproduces the issue.<br>\nThe component was compiled for the <code>wasm32-wasip1</code> target and then componentized using <code>wasm-tools component new</code>.</p>",
        "id": 561168410,
        "sender_full_name": "ktz_alias",
        "timestamp": 1764597840
    },
    {
        "content": "<blockquote>\n<p>Note that for now you should be using (and I assume you already are using) a version of wit-bindgen strictly earlier than 0.48.0. This is what jco is pinned to, for now until we absorb the aforementioned function async-ness changes!</p>\n</blockquote>\n<p>Yes, I was indeed using wit-bindgen 0.47.0 (the version jco is pinned to).<br>\nI didn’t use 0.48.0 or later.</p>",
        "id": 561168633,
        "sender_full_name": "ktz_alias",
        "timestamp": 1764597895
    },
    {
        "content": "<p>Victor I suspect that wit-bindgen is going to need some sort of top-level helper function to assist with generating code for <code>task.return</code>. The way guest bindgen interacts with <code>task.return</code> is completely different than the host, so I think there'd need to be a specific hook for \"run the generation of <code>task.return</code> which does lifts\" which doesn't currently exist. That I think would be the one to generate <code>StringLift</code> and various instructions</p>",
        "id": 561208965,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1764606162
    },
    {
        "content": "<p>This topic was moved here from <a class=\"stream-topic\" data-stream-id=\"206238\" href=\"/#narrow/channel/206238-general/topic/Should.20StringLift.20be.20emitted.20for.20async.20return.20values.3F\">#general &gt; Should StringLift be emitted for async return values?</a> by <span class=\"user-mention silent\" data-user-id=\"253994\">Alex Crichton</span>.</p>",
        "id": 561211043,
        "sender_full_name": "Notification Bot",
        "timestamp": 1764606496
    },
    {
        "content": "<p>A bit late getting back here, but the bug is fixed via jco-side changes in <a href=\"https://www.npmjs.com/package/@bytecodealliance/jco/v/1.15.4\">jco v1.15.4</a>. </p>\n<p>Since we do actually have the type information and the lifts that need to happen... it was solvable completely via Jco host generation code -- I think we can put off changes to bindgen (and possibly someday a fork/rework/rebuild of host-focused stuff) to another day!</p>",
        "id": 561243402,
        "sender_full_name": "Victor Adossi",
        "timestamp": 1764612974
    }
]
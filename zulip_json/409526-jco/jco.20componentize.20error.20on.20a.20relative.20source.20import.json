[
    {
        "content": "<p>I want to componentize a node js \"bin\" as a cli/command component. I seem to be mixed up on how to achieve this. Do I need to bundle all imports into one script and <code>jco componentize</code> that or are <code>import {myApi} from './poultry.js'</code> allowed and it is for some reason not working for me?</p>\n<p>This seems to be an error stating that I can't import from relative sources while componentizing?</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">pnpm</span><span class=\"w\"> </span><span class=\"n\">exec</span><span class=\"w\"> </span><span class=\"n\">jco</span><span class=\"w\"> </span><span class=\"n\">componentize</span><span class=\"w\"> </span><span class=\"o\">--</span><span class=\"n\">wit</span><span class=\"w\"> </span><span class=\"n\">wasm</span><span class=\"o\">/</span><span class=\"n\">poultry</span><span class=\"p\">.</span><span class=\"n\">wit</span><span class=\"w\"> </span><span class=\"n\">lib_js</span><span class=\"o\">/</span><span class=\"n\">bin</span><span class=\"p\">.</span><span class=\"n\">js</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">o</span><span class=\"w\"> </span><span class=\"n\">poultry</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n<span class=\"p\">(</span><span class=\"n\">jco</span><span class=\"w\"> </span><span class=\"n\">componentize</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"n\">Error</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">Failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">initialize</span><span class=\"w\"> </span><span class=\"n\">component</span><span class=\"p\">:</span>\n<span class=\"nc\">Exception</span><span class=\"w\"> </span><span class=\"k\">while</span><span class=\"w\"> </span><span class=\"n\">evaluating</span><span class=\"w\"> </span><span class=\"n\">top</span><span class=\"o\">-</span><span class=\"n\">level</span><span class=\"w\"> </span><span class=\"n\">script</span>\n<span class=\"n\">ReferenceError</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">Error</span><span class=\"w\"> </span><span class=\"n\">loading</span><span class=\"w\"> </span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"s\">\"./poultry.js\"</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">resolved</span><span class=\"w\"> </span><span class=\"n\">path</span><span class=\"w\"> </span><span class=\"s\">\"poultry.js\"</span><span class=\"p\">):</span><span class=\"w\"> </span><span class=\"nc\">No</span><span class=\"w\"> </span><span class=\"n\">such</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"n\">directory</span>\n</code></pre></div>\n<p>I'm also curious, is it necessary to create an arbitrary WIT that exports \"cli/command\" or could that be implicit because the entrypoint has an exported \"run()\" function, much like how the Rust target <code>wasm32-wasip2</code> will automatically build a <code>cli/command</code> component from a binary crate?</p>",
        "id": 558933369,
        "sender_full_name": "adam",
        "timestamp": 1763943517
    },
    {
        "content": "<blockquote>\n<p>Do I need to bundle all imports into one script and¬†<code>jco componentize</code>¬†that or are¬†<code>import {myApi} from './poultry.js'</code>¬†allowed and it is for some reason not working for me?</p>\n</blockquote>\n<p>Yep! See relevant issue: <a href=\"https://github.com/bytecodealliance/StarlingMonkey/issues/15\">https://github.com/bytecodealliance/StarlingMonkey/issues/15</a><br>\nExamples today use a bunder like rollup: <a href=\"https://github.com/bytecodealliance/jco/tree/main/examples/components/http-server-hono\">https://github.com/bytecodealliance/jco/tree/main/examples/components/http-server-hono</a></p>\n<blockquote>\n<p>I'm also curious, is it necessary to create an arbitrary WIT that exports \"cli/command\" or could that be implicit because the entrypoint has an exported \"run()\" function</p>\n</blockquote>\n<p>You'll need to setup the wit folder with your world and the deps for jco.</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/StarlingMonkey/issues/15\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/9f294778da42ef5ad60771e5ffeae52fff94327a/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f316164656430666130623533653031613533646530346638326636326464363666376239373138363930653633306234633734333061636531356565373861382f62797465636f6465616c6c69616e63652f537461726c696e674d6f6e6b65792f6973737565732f3135&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/StarlingMonkey/issues/15\" title=\"Resolving Node.js packages ¬∑ Issue #15 ¬∑ bytecodealliance/StarlingMonkey\">Resolving Node.js packages ¬∑ Issue #15 ¬∑ bytecodealliance/StarlingMonkey</a></div><div class=\"message_embed_description\">I really like the static nature of source resolution during Wizering as an alternative to bundling. Further to this, it could be worth implementing the full Node.js resolution algorithm to automati...</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/jco/tree/main/examples/components/http-server-hono\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/775fcbb37fae236bb406eedbae9484bed6673855/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f363637346537316361633761323634646537613632353662653736616537613535666566383236346466306163326531303438393865333564626637313162332f62797465636f6465616c6c69616e63652f6a636f&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/jco/tree/main/examples/components/http-server-hono\" title=\"jco/examples/components/http-server-hono at main ¬∑ bytecodealliance/jco\">jco/examples/components/http-server-hono at main ¬∑ bytecodealliance/jco</a></div><div class=\"message_embed_description\">JavaScript toolchain for working with WebAssembly Components - bytecodealliance/jco</div></div></div>",
        "id": 559104002,
        "sender_full_name": "Milan (rajsite)",
        "timestamp": 1764003956
    },
    {
        "content": "<p>Are there plans to have a frontend for jco or componentize that is more like the dx of building WASI components with the Rust tooling? Seems like a huge difference between the JS experience and Rust.</p>\n<p>Having started with the Rust experience, it caught me off guard that building a cli/command component without any component imports and no other exports would even need a wit file.</p>",
        "id": 560048790,
        "sender_full_name": "adam",
        "timestamp": 1764032122
    },
    {
        "content": "<p>Specifically for fetching wit more automatically there is: <a href=\"https://github.com/bytecodealliance/jco/issues/529\">https://github.com/bytecodealliance/jco/issues/529</a><br>\nAnd for more out of the box node api support: <a href=\"https://github.com/bytecodealliance/StarlingMonkey/issues/188\">https://github.com/bytecodealliance/StarlingMonkey/issues/188</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/jco/issues/529\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/540b85372deef5cf4785fdb4d5b700eddc14efc9/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f393836633336336264643036376163666265306362323737653133353264343562356161353464333861613534633230346339313330353361663134613733652f62797465636f6465616c6c69616e63652f6a636f2f6973737565732f353239&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/jco/issues/529\" title=\"Support pulling known WASI WIT worlds from BCA repositories ¬∑ Issue #529 ¬∑ bytecodealliance/jco\">Support pulling known WASI WIT worlds from BCA repositories ¬∑ Issue #529 ¬∑ bytecodealliance/jco</a></div><div class=\"message_embed_description\">Now that BCA tooling (wkg, etc) have evolved to be be able to push/pull OCI artifacts for well known/standardized interfaces from a central location, it would be useful if jco could make use of the...</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/StarlingMonkey/issues/188\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/1cd760c18ba0950012a1f95f51a4e18ccda9276b/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f376132633333326430353662393636633666383030313439633236373539653335653633353166316261633137616331626561396665333337653261323162622f62797465636f6465616c6c69616e63652f537461726c696e674d6f6e6b65792f6973737565732f313838&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/StarlingMonkey/issues/188\" title=\"Node.js builtins ¬∑ Issue #188 ¬∑ bytecodealliance/StarlingMonkey\">Node.js builtins ¬∑ Issue #188 ¬∑ bytecodealliance/StarlingMonkey</a></div><div class=\"message_embed_description\">Tracking issue for supporting Node.js builtins (import fs from node:fs, ...), where each builtin can be individually turned on or off. We should implement this layer in C++ (or Rust), and try to bu...</div></div></div>",
        "id": 560073556,
        "sender_full_name": "Milan (rajsite)",
        "timestamp": 1764050049
    },
    {
        "content": "<p>So I looked at the docs for the componentiz from @bytecodealliance/componentize-js and it explicitly says </p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"w\">     </span><span class=\"n\">and</span><span class=\"w\"> </span><span class=\"n\">can</span><span class=\"w\"> </span><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"n\">other</span><span class=\"w\"> </span><span class=\"n\">modules</span><span class=\"w\"> </span><span class=\"n\">using</span><span class=\"w\"> </span><span class=\"n\">relative</span><span class=\"w\"> </span><span class=\"n\">paths</span><span class=\"p\">.</span>\n<span class=\"w\">   </span><span class=\"o\">*/</span>\n<span class=\"w\">  </span><span class=\"n\">sourcePath</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">string</span><span class=\"p\">;</span>\n</code></pre></div>\n<p>I tried this API as an alternative to using jco from the CLI but when using this fn, it throws an error on any \"node:\" style imports:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">ReferenceError</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">Error</span><span class=\"w\"> </span><span class=\"n\">loading</span><span class=\"w\"> </span><span class=\"n\">module</span><span class=\"w\"> </span><span class=\"s\">\"node:fs/promises\"</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">resolved</span><span class=\"w\"> </span><span class=\"n\">path</span><span class=\"w\"> </span><span class=\"s\">\"lib_js/node:fs/promises\"</span><span class=\"p\">):</span><span class=\"w\"> </span><span class=\"nc\">No</span><span class=\"w\"> </span><span class=\"n\">such</span><span class=\"w\"> </span><span class=\"n\">file</span><span class=\"w\"> </span><span class=\"n\">or</span><span class=\"w\"> </span><span class=\"n\">directory</span>\n</code></pre></div>\n<p>Here's the attempted componentizing:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"n\">import</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">componentize</span><span class=\"w\"> </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"n\">from</span><span class=\"w\"> </span><span class=\"o\">'@</span><span class=\"n\">bytecodealliance</span><span class=\"o\">/</span><span class=\"n\">componentize</span><span class=\"o\">-</span><span class=\"n\">js</span><span class=\"o\">'</span>\n\n<span class=\"k\">const</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">component</span><span class=\"w\"> </span><span class=\"p\">}</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"k\">await</span><span class=\"w\"> </span><span class=\"n\">componentize</span><span class=\"p\">({</span>\n<span class=\"w\">    </span><span class=\"n\">sourcePath</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">lib_js</span><span class=\"o\">/</span><span class=\"n\">bin</span><span class=\"p\">.</span><span class=\"n\">js</span><span class=\"o\">'</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">witPath</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">wasm</span><span class=\"o\">/</span><span class=\"n\">poultry</span><span class=\"p\">.</span><span class=\"n\">wit</span><span class=\"o\">'</span><span class=\"p\">,</span>\n<span class=\"w\">    </span><span class=\"n\">preview2Adapter</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"o\">'</span><span class=\"na\">node_modules</span><span class=\"o\">/@</span><span class=\"n\">bytecodealliance</span><span class=\"o\">/</span><span class=\"n\">jco</span><span class=\"o\">/</span><span class=\"n\">lib</span><span class=\"o\">/</span><span class=\"n\">wasi_snapshot_preview1</span><span class=\"p\">.</span><span class=\"n\">command</span><span class=\"p\">.</span><span class=\"n\">wasm</span><span class=\"o\">'</span><span class=\"p\">,</span>\n<span class=\"p\">})</span>\n\n<span class=\"n\">console</span><span class=\"p\">.</span><span class=\"n\">log</span><span class=\"p\">(</span><span class=\"n\">new</span><span class=\"w\"> </span><span class=\"n\">TextDecoder</span><span class=\"p\">().</span><span class=\"n\">decode</span><span class=\"p\">(</span><span class=\"n\">component</span><span class=\"p\">))</span>\n</code></pre></div>\n<p>It sounds like I don't need to use <code>esbuild</code> to prebundle with the most uptodate componentize, but node dependencies seem to cause an error.</p>",
        "id": 560253029,
        "sender_full_name": "adam",
        "timestamp": 1764104815
    },
    {
        "content": "<p>I'm also confused about the path to preview 2 adapter option. JCO uses a path to a file packaged with the npm package that's called preview1.</p>",
        "id": 560253245,
        "sender_full_name": "adam",
        "timestamp": 1764104940
    },
    {
        "content": "<p>It sounds like I don't need to use <code>esbuild</code> to prebundle with the most up-to-date componentize, but node dependencies seem to cause an error. However, if I use JCO which uses the newest componentize API, I get errors from relative path imports. Head scratch fever!</p>",
        "id": 560254551,
        "sender_full_name": "adam",
        "timestamp": 1764105565
    },
    {
        "content": "<p>The preview2-shim npm package seems to have WASI impls for Node and browser environments, yet a suggestion I found for making a JS component from a Node JS program is to implement the component using <code>import XYZ from 'ABC'</code> where ABC is a WASI import specifier and when hosting the component needing to fulfill the FS APIs with those customized imports.</p>",
        "id": 560257158,
        "sender_full_name": "adam",
        "timestamp": 1764106713
    },
    {
        "content": "<p>The shim package has implementations of wasi:fs -&gt; js. So that's taking any wasm component (rust, go, js-based) that uses wasi:fs and generates a browser / node library for it (js + core wasm) to translate wasi:fs calls into other calls (browser custom API and node via fs).</p>\n<p>I'm not aware of any implementations of node:fs -&gt; js backed by wasi:fs (taking js that call node:fs and transforms to a component via JCO / ComponentizeJS that calls wasi:fs).</p>\n<p>The second issue I had linked before was for first class node builtins (like node:fs) in starlingmonkey. So far we have first class support for math, date, webcrypto, fetch, fetch- event, backed by wasi apis but not node:fs.</p>\n<p>Another related project is jco-std, that provides an alternative to native fetch-event via express like APIs backed by wasi:http. That would be a good place to land node:fs like APIs backed by wasi:fs. <a href=\"https://github.com/bytecodealliance/jco/tree/main/packages/jco-std\">https://github.com/bytecodealliance/jco/tree/main/packages/jco-std</a></p>\n<p>But also I'm just a lurker, wasn't aware of the relative import support in ComponentizeJS so maybe others are aware of node:fs implementations backed by wasi:fs. I'd love that too! The alternative right now is using wasi:fs directly which isn't so bad but would certainly appreciate a more familiar API.</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/jco/tree/main/packages/jco-std\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/723ce8dcb0ca9235c4ec5c11f61b913cf98b2fb9/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f376634323562313232393230366231653639376364393264303366383163643736613862616365393438323065356331346139323335653363613164383565332f62797465636f6465616c6c69616e63652f6a636f&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/jco/tree/main/packages/jco-std\" title=\"jco/packages/jco-std at main ¬∑ bytecodealliance/jco\">jco/packages/jco-std at main ¬∑ bytecodealliance/jco</a></div><div class=\"message_embed_description\">JavaScript toolchain for working with WebAssembly Components - bytecodealliance/jco</div></div></div>",
        "id": 560269443,
        "sender_full_name": "Milan (rajsite)",
        "timestamp": 1764113401
    },
    {
        "content": "<p>Thanks for the excellent support/help here Milan! Just chiming in to note that everything Milan is saying is spot on at this point!</p>\n<p>I think Jco <em>could</em> be behind on componentize-js versions (IIRC it's not but I could be wrong!)</p>\n<p>Right now, we don't have a Node shim but we absolutely could and it's something we want to do.  Like Milan said ideally we'd have first class builtins at the StarlingMonkey level, but right now what is supported is more like WinterCG/WinterTC (i.e. interoperable Javascript runtime features)</p>",
        "id": 560322492,
        "sender_full_name": "Victor Adossi",
        "timestamp": 1764142930
    },
    {
        "content": "<blockquote>\n<p>But also I'm just a lurker, wasn't aware of the relative import support in ComponentizeJS so maybe others are aware of node:fs implementations backed by wasi:fs. I'd love that too! The alternative right now is using wasi:fs directly which isn't so bad but would certainly appreciate a more familiar API.</p>\n</blockquote>\n<p>Just between you me and everyone else that could possibly be reading this thread, as soon as async work in Jco is done I'm looking forward to adding TS support and bundling via <code>rolldown</code> -- the oxc ecosystem is fantastic and fits right in. </p>\n<p>Along with that it would be natural to add a NodeJS shim via a project like <a href=\"https://github.com/unjs/unenv\">unenv</a> , even if it would be slow (and maybe have the integrations themselves live in <code>jco-std</code> and be re-surfaced in Jco). </p>\n<p>This is all really exciting work (I think) and I'm happy to review any PRs that move us forward! Even taking on \"little\" stuff like moving the current projects to Typescript would be much appreciated.</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/unjs/unenv\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/1b6dbe681b34dfdbee9b97d2cdd4567c45288166/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f316366643261316461373630336464633365303965393761303935306230333866643936623637336131333737633333333263626437646135396631313562312f756e6a732f756e656e76&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/unjs/unenv\" title=\"GitHub - unjs/unenv: üïäÔ∏è Node.js compatibility for any JavaScript runtime, including browsers and edge workers.\">GitHub - unjs/unenv: üïäÔ∏è Node.js compatibility for any JavaScript runtime, including browsers and edge workers.</a></div><div class=\"message_embed_description\">üïäÔ∏è Node.js compatibility for any JavaScript runtime, including browsers and edge workers. - unjs/unenv</div></div></div>",
        "id": 560322871,
        "sender_full_name": "Victor Adossi",
        "timestamp": 1764143073
    }
]
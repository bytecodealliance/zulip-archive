[
    {
        "content": "<p>Thanks for all the replies! <span class=\"user-mention\" data-user-id=\"253990\">@fitzgen (he/him)</span> <span class=\"user-mention\" data-user-id=\"382336\">@Adel Prokurov</span>  I finally made it by using <code>object</code> and <code>gimli</code> for writing an in-memory ELF object with DWARF, and LLDB's JIT interface now recognizes my generated code. It's lucky that these two are all bundled in the Cranelift related crates. Some notable steps to make this happen:</p>\n<ul>\n<li>I forked the <code>cranelift-jit</code> crate to expose the function <strong>size</strong>, which seems impossible to get in the original crate. This serves as the size of the <code>.text</code> section.</li>\n<li>Use <code>object::write</code> to write the ELF object, leave the <code>.text</code> section data blank. Add a symbol to this section with the generated function name, e.g. <code>b\"jit_main\"</code>.</li>\n<li>Write the DWARF sections, and write them to the object with <code>.set_section_data</code>.</li>\n<li>Write the ELF object to the memory. Then use <code>object::read</code> to read it again.</li>\n</ul>\n<p>Then the hard part: do the manual relocations (have to be <code>unsafe</code>):</p>\n<ul>\n<li>For <code>.text</code> section, set <code>sh_addr</code> with the code address, and <code>sh_size</code>with the size.</li>\n<li>For other sections, set <code>sh_addr</code> to the <code>bytes.as_ptr() + sh_off</code>, so those <code>0x0</code> addresses are now the actual ones in virtual memory.</li>\n</ul>\n<p>Because I notice that <code>object::write</code> and <code>object::build</code> only accepts a <code>Cow</code> to write (I'm afraid it copies) the data, but since we already have a portion of in-memory generated code, we only need to set the right address and size.</p>\n<ul>\n<li>Finally, register the ELF object with <code>wasmtime-jit-debug</code> crate.</li>\n</ul>\n<p>And now settting breakpoints should work, but stacktraces and unwinding might not work properly, I'm still doing my experimentation on this.</p>",
        "id": 554615065,
        "sender_full_name": "Anqur",
        "timestamp": 1762745480
    },
    {
        "content": "<p><span class=\"user-mention silent\" data-user-id=\"985444\">Anqur</span> has marked this topic as resolved.</p>",
        "id": 554615708,
        "sender_full_name": "Notification Bot",
        "timestamp": 1762746047
    },
    {
        "content": "<p>For backtraces/unwinding you could take inspiration from <a href=\"https://github.com/rust-lang/rustc_codegen_cranelift/blob/9d292ca475cf182d404f5c1f4b6eaf07ac8bfb21/src/debuginfo/unwind.rs#L265-L312\">https://github.com/rust-lang/rustc_codegen_cranelift/blob/9d292ca475cf182d404f5c1f4b6eaf07ac8bfb21/src/debuginfo/unwind.rs#L265-L312</a></p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/rust-lang/rustc_codegen_cranelift/blob/9d292ca475cf182d404f5c1f4b6eaf07ac8bfb21/src/debuginfo/unwind.rs#L265-L312\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/4611d0de456f84eb15e053e53681dd99acd06d67/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f316539393162363839343634383034323635623733373966636535633366386364636439323461303162386563353763663936386333643633323665316266612f727573742d6c616e672f72757374635f636f646567656e5f6372616e656c696674&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/rust-lang/rustc_codegen_cranelift/blob/9d292ca475cf182d404f5c1f4b6eaf07ac8bfb21/src/debuginfo/unwind.rs#L265-L312\" title=\"rustc_codegen_cranelift/src/debuginfo/unwind.rs at 9d292ca475cf182d404f5c1f4b6eaf07ac8bfb21 · rust-lang/rustc_codegen_cranelift\">rustc_codegen_cranelift/src/debuginfo/unwind.rs at 9d292ca475cf182d404f5c1f4b6eaf07ac8bfb21 · rust-lang/rustc_codegen_cranelift</a></div><div class=\"message_embed_description\">Cranelift based backend for rustc. Contribute to rust-lang/rustc_codegen_cranelift development by creating an account on GitHub.</div></div></div>",
        "id": 554666574,
        "sender_full_name": "bjorn3",
        "timestamp": 1762771106
    },
    {
        "content": "<p>Although I think that only works for backtraces generated by your executable itself, not for debuggers. For debuggers I suspect you need to include the <code>.eh_frame</code> section in the debuginfo ELF file you register with the debugger.</p>",
        "id": 554666785,
        "sender_full_name": "bjorn3",
        "timestamp": 1762771169
    }
]
[
    {
        "content": "<p>Hello everyone! I'm new to Cranelift at the moment but have been looking to possibly use the DSLs for compiler peepholes in Cranelift in my project for formalising peepholes in Lean, particularly for encoding the actual rules in the theorem statement.</p>\n<p>For example below are two theorems (not rewrites yet!) for associativity and UB refinement using the ~&gt; relation (this is a LLVM style poison model of UB).</p>\n<p><a href=\"/user_uploads/15107/LtEakhimo6bVmf6vSq0TW9pq/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/15107/LtEakhimo6bVmf6vSq0TW9pq/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"832x294\" src=\"/user_uploads/thumbnail/15107/LtEakhimo6bVmf6vSq0TW9pq/image.png/840x560.webp\"></a></div><p><a href=\"/user_uploads/15107/TXA91NTGEI1KpJ4iR2eop_KG/image.png\">image.png</a></p>\n<div class=\"message_inline_image\"><a href=\"/user_uploads/15107/TXA91NTGEI1KpJ4iR2eop_KG/image.png\" title=\"image.png\"><img data-original-content-type=\"image/png\" data-original-dimensions=\"813x374\" src=\"/user_uploads/thumbnail/15107/TXA91NTGEI1KpJ4iR2eop_KG/image.png/840x560.webp\"></a></div><p>The peepmatic DSL seems like a perfect fit, and I'll have to adjust it to support polymorphism ∀bitwidths. I've looked around at the resources and I've seen for Peepmatic:</p>\n<ul>\n<li><a href=\"https://github.com/fitzgen/peepmatic\">https://github.com/fitzgen/peepmatic</a></li>\n<li><a href=\"https://github.com/bytecodealliance/wasmtime/pull/1647\">https://github.com/bytecodealliance/wasmtime/pull/1647</a></li>\n<li><a href=\"https://docs.google.com/presentation/d/1RW_UHWX1t9-_XkXVsPZauliW1LIJgGz02hUFZE7APT0\">https://docs.google.com/presentation/d/1RW_UHWX1t9-_XkXVsPZauliW1LIJgGz02hUFZE7APT0</a></li>\n</ul>\n<p>My question is, what happened to Peepmatic? I can't find much mention of it inside the Cranelift codebase. Was it subsumed into a more general rewriting system under ISLE? (I thought peepmatic was for the middle end generic peepholes, that are separate to instruction selection/lowering)</p>\n<p>I'm looking for a good DSL base to represent rewrites in a compiler, from what I've seen I can choose between the existing DSL in Cranelift (might not be peepmatic anymore) or the Go compiler's <code>.rules</code> DSL. Cranelift seems like it would be the better choice, given the existing literature and resources around it.</p>\n<p>Could the community also point me towards where to get started with understanding how the existing DSL is implemented in Cranelift? I appreciate it!</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/fitzgen/peepmatic\" style='background-image: url(\"https://uploads.zulipusercontent.net/7c6568374e8e1d0c6ef343b473dfd48f81399102/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f663238376635643638366564656131666335626334303162373835396262396636333030613736626135316138386435653137366364393033356464646138372f6669747a67656e2f706565706d61746963\")'></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/fitzgen/peepmatic\" title=\"GitHub - fitzgen/peepmatic: A DSL and compiler for generating peephole optimizers for Cranelift\">GitHub - fitzgen/peepmatic: A DSL and compiler for generating peephole optimizers for Cranelift</a></div><div class=\"message_embed_description\">A DSL and compiler for generating peephole optimizers for Cranelift - fitzgen/peepmatic</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/pull/1647\" style='background-image: url(\"https://uploads.zulipusercontent.net/dff5e172e936a08dd90e4f457534d4875b390639/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f343864643932356636376535623136313434333836356361346432656361663637343738343434633137323165333261386134666632333033663138373633342f62797465636f6465616c6c69616e63652f7761736d74696d652f70756c6c2f31363437\")'></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/pull/1647\" title=\"Introduce peepmatic: a peephole optimizations DSL and peephole optimizer compiler by fitzgen · Pull Request #1647 · bytecodealliance/wasmtime\">Introduce peepmatic: a peephole optimizations DSL and peephole optimizer compiler by fitzgen · Pull Request #1647 · bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">This PR introduces peepmatic, a peephole optimizations DSL and peephole optimizer compiler.\nDevelopers write a set of optimizations in the DSL, and then peepmatic compiles the set of optimizations ...</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://docs.google.com/presentation/d/1RW_UHWX1t9-_XkXVsPZauliW1LIJgGz02hUFZE7APT0\" style='background-image: url(\"https://uploads.zulipusercontent.net/36fc58ef43dd9aed41a4219f54123db30f397464/68747470733a2f2f6c68372d75732e676f6f676c6575736572636f6e74656e742e636f6d2f646f63732f41486b6277794c496671535335786e704442526e655a77705a355971775047794474684772305a566c454b4c5876587151354c6e50655f4b4f4a667945585330654c37786a4d7436696159613030534a67453237515f43325845783343615f5356363773773631413032463551597642697a7a4f677873553d77313230302d683633302d70\")'></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://docs.google.com/presentation/d/1RW_UHWX1t9-_XkXVsPZauliW1LIJgGz02hUFZE7APT0\" title=\"peepmatic\">peepmatic</a></div><div class=\"message_embed_description\">peepmatic A peephole optimizations DSL and peephole optimizer compiler for Cranelift Nick Fitzgerald • 2020-05-04</div></div></div>",
        "id": 566110821,
        "sender_full_name": "l1mey",
        "timestamp": 1767397818
    },
    {
        "content": "<p>Hi <span class=\"user-mention\" data-user-id=\"1010397\">@l1mey</span> -- thanks for the question!</p>\n<p>You're correct that ISLE has subsumed Peepmatic, and we subsequently removed Peepmatic from the tree -- for all the reasoning, see <span class=\"user-mention\" data-user-id=\"253990\">@fitzgen (he/him)</span> 's PR here: <a href=\"https://github.com/bytecodealliance/wasmtime/pull/3543\">https://github.com/bytecodealliance/wasmtime/pull/3543</a></p>\n<p>ISLE was originally designed for the instruction-selection/lowering use-case, but its (not well-kept) secret is that it is a general matching language, and so in our new rewrite-based mid-end (<a href=\"https://github.com/bytecodealliance/rfcs/blob/main/accepted/cranelift-egraph.md\">https://github.com/bytecodealliance/rfcs/blob/main/accepted/cranelift-egraph.md</a>) we re-used ISLE as well. In essence we have two different ISLE environments with two separate preludes that bind it to either the mid-end or back-end context.</p>\n<p>For more on ISLE, you can read the <a href=\"https://github.com/bytecodealliance/wasmtime/blob/b5272a5f103053f5ada2a38d5302a8d1e2de442d/cranelift/isle/docs/language-reference.md#L4\">ISLE langref</a>, the docs on the backend integration <a href=\"https://github.com/bytecodealliance/wasmtime/blob/b5272a5f103053f5ada2a38d5302a8d1e2de442d/cranelift/docs/isle-integration.md\">here</a>, the RFC on the ISLE design <a href=\"https://github.com/bytecodealliance/rfcs/pull/15\">here</a>, the RFC on the mid-end <a href=\"https://github.com/bytecodealliance/rfcs/blob/main/accepted/cranelift-egraph.md\">here</a>, and my blog post on ISLE <a href=\"https://cfallin.org/blog/2023/01-20/cranelift-isle/\">here</a>.</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/pull/3543\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/550aa2035f595312b91f23551653264742e39b76/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f303732393537383330333131633662393362623964323433623532306164316638323562373336393766363361343837633532336561393432326438633337312f62797465636f6465616c6c69616e63652f7761736d74696d652f70756c6c2f33353433&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/pull/3543\" title=\"Remove Peepmatic!!! by fitzgen · Pull Request #3543 · bytecodealliance/wasmtime\">Remove Peepmatic!!! by fitzgen · Pull Request #3543 · bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">Peepmatic was an early attempt at a DSL for peephole optimizations, with the\nidea that maybe sometime in the future we could user it for instruction\nselection as well. It didn&#39;t really pan out,...</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/rfcs/blob/main/accepted/cranelift-egraph.md\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/a2bb1b2f4010235d0e4bc5d57519ccff156b2ab4/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f623936333532663064656264663732356436353061383264363963393662613962346666616561643337343339326662393166316632633738383731333061372f62797465636f6465616c6c69616e63652f72666373&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/rfcs/blob/main/accepted/cranelift-egraph.md\" title=\"rfcs/accepted/cranelift-egraph.md at main · bytecodealliance/rfcs\">rfcs/accepted/cranelift-egraph.md at main · bytecodealliance/rfcs</a></div><div class=\"message_embed_description\">RFC process for Bytecode Alliance projects. Contribute to bytecodealliance/rfcs development by creating an account on GitHub.</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/blob/b5272a5f103053f5ada2a38d5302a8d1e2de442d/cranelift/isle/docs/language-reference.md#L4\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/34dabd3677b5987bc3177defd1fadf91b7563340/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f646530663734613737633864383239623735323233353262376364643936363461366265373564373237313438613832363732373330663761376236336163322f62797465636f6465616c6c69616e63652f7761736d74696d65&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/blob/b5272a5f103053f5ada2a38d5302a8d1e2de442d/cranelift/isle/docs/language-reference.md#L4\" title=\"wasmtime/cranelift/isle/docs/language-reference.md at b5272a5f103053f5ada2a38d5302a8d1e2de442d · bytecodealliance/wasmtime\">wasmtime/cranelift/isle/docs/language-reference.md at b5272a5f103053f5ada2a38d5302a8d1e2de442d · bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">A lightweight WebAssembly runtime that is fast, secure, and standards-compliant - bytecodealliance/wasmtime</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/blob/b5272a5f103053f5ada2a38d5302a8d1e2de442d/cranelift/docs/isle-integration.md\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/34dabd3677b5987bc3177defd1fadf91b7563340/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f646530663734613737633864383239623735323233353262376364643936363461366265373564373237313438613832363732373330663761376236336163322f62797465636f6465616c6c69616e63652f7761736d74696d65&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/blob/b5272a5f103053f5ada2a38d5302a8d1e2de442d/cranelift/docs/isle-integration.md\" title=\"wasmtime/cranelift/docs/isle-integration.md at b5272a5f103053f5ada2a38d5302a8d1e2de442d · bytecodealliance/wasmtime\">wasmtime/cranelift/docs/isle-integration.md at b5272a5f103053f5ada2a38d5302a8d1e2de442d · bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">A lightweight WebAssembly runtime that is fast, secure, and standards-compliant - bytecodealliance/wasmtime</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/rfcs/pull/15\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/da18071f198054a5c3e3ed57768a589a0fdbc608/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f393436663636386637393336303863373937343530386466336435343730623362386237393561613632333931313637386231643233646332373035333134372f62797465636f6465616c6c69616e63652f726663732f70756c6c2f3135&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/rfcs/pull/15\" title=\"RFC: design of ISLE instruction-selector DSL. by cfallin · Pull Request #15 · bytecodealliance/rfcs\">RFC: design of ISLE instruction-selector DSL. by cfallin · Pull Request #15 · bytecodealliance/rfcs</a></div><div class=\"message_embed_description\">Rendered\nThis RFC proposes a new DSL for the instruction selectors in Cranelift,\nautomating the generation of the backends based on a list of term-rewriting\nrules provided by the backend author.\nTh...</div></div></div>",
        "id": 566112689,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1767399916
    },
    {
        "content": "<p>You can see examples of our use of ISLE to define mid-end rewrites <a href=\"https://github.com/bytecodealliance/wasmtime/tree/main/cranelift/codegen/src/opts/\">here</a>, as well.</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/tree/main/cranelift/codegen/src/opts/\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/34dabd3677b5987bc3177defd1fadf91b7563340/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f646530663734613737633864383239623735323233353262376364643936363461366265373564373237313438613832363732373330663761376236336163322f62797465636f6465616c6c69616e63652f7761736d74696d65&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/tree/main/cranelift/codegen/src/opts/\" title=\"wasmtime/cranelift/codegen/src/opts at main · bytecodealliance/wasmtime\">wasmtime/cranelift/codegen/src/opts at main · bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">A lightweight WebAssembly runtime that is fast, secure, and standards-compliant - bytecodealliance/wasmtime</div></div></div>",
        "id": 566112714,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1767399954
    },
    {
        "content": "<p>I appreciate it! Thanks for the quick response. I'll take a look over these and let you know if I have any further questions.</p>",
        "id": 566117400,
        "sender_full_name": "l1mey",
        "timestamp": 1767406438
    }
]
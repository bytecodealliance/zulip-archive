[
    {
        "content": "<p>I'm investigating cranelift since the beginning of this week and have a few questions. Instead of creating a bunch of threads, I thought I'd cummulate them here :D</p>",
        "id": 568028083,
        "sender_full_name": "Firestar99",
        "timestamp": 1768407955
    },
    {
        "content": "<p>What's the difference between a <code>StackSlot</code> and a <code>DynamicStackSlot</code>? Is <code>DynamicStackSlot</code> only used to put <code>DynamicType</code>s on the stack, for what are those used? I remember something about ARM having a dynamically sized SIMD width, could it be for that?</p>",
        "id": 568028797,
        "sender_full_name": "Firestar99",
        "timestamp": 1768408109
    },
    {
        "content": "<p>yes, exactly, and only for its new SVE instruction set, which isn't really fully supported in our compiler</p>",
        "id": 568029095,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1768408182
    },
    {
        "content": "<p>I've been reading into isle for a few days now, and I see this pattern in <a href=\"https://github.com/bytecodealliance/wasmtime/blob/100e90bcca285d3b1146995b65105da91583c3d1/cranelift/isle/isle/isle_examples/pass/tutorial.isle#L37-L62\"><code>tutorial.isle</code></a>:</p>\n<div class=\"codehilite\" data-code-language=\"Common Lisp\"><pre><span></span><code><span class=\"p\">(</span><span class=\"nv\">decl</span><span class=\"w\"> </span><span class=\"nv\">lower</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">HighLevelInst</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"nv\">LowLevelInst</span><span class=\"p\">)</span>\n<span class=\"p\">(</span><span class=\"nv\">rule</span><span class=\"w\"> </span><span class=\"nv\">lower</span><span class=\"w\"> </span><span class=\"o\">...</span><span class=\"p\">)</span>\n<span class=\"p\">(</span><span class=\"nv\">decl</span><span class=\"w\"> </span><span class=\"nv\">inst_result</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">HighLevelInst</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"nv\">Value</span><span class=\"p\">)</span>\n<span class=\"p\">(</span><span class=\"nv\">extern</span><span class=\"w\"> </span><span class=\"nv\">extractor</span><span class=\"w\"> </span><span class=\"nv\">inst_result</span><span class=\"w\"> </span><span class=\"nv\">inst_result</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>I see these <code>decl</code> as rust function calls, in macro-rules form <code>(decl $name:ident $($param:ty),+ $result:ty)</code>. So isle would generate to this in rust, ignoring <code>self</code>:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">constructor_lower</span><span class=\"p\">(</span><span class=\"n\">_</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">HighLevelInst</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">LowLevelInst</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"p\">}</span>\n<span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">inst_result</span><span class=\"p\">(</span><span class=\"n\">_</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">HighLevelInst</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nb\">Option</span><span class=\"o\">&lt;</span><span class=\"n\">Value</span><span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"p\">}</span>\n</code></pre></div>\n<p>(I think constructors only return <code>Option&lt;_&gt;</code> if the <code>decl</code> has <code>partial</code>?)</p>\n<p>Now in the <a href=\"https://github.com/bytecodealliance/wasmtime/blob/87ed3b6019abf061aedb3262563a4db8750b11da/cranelift/codegen/src/prelude_lower.isle#L279-L281\"><code>prelude.lower</code></a> I'm coming across this:</p>\n<div class=\"codehilite\" data-code-language=\"Common Lisp\"><pre><span></span><code><span class=\"p\">(</span><span class=\"nv\">decl</span><span class=\"w\"> </span><span class=\"nv\">value_type</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">Type</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"nv\">Value</span><span class=\"p\">)</span>\n<span class=\"p\">(</span><span class=\"nv\">extern</span><span class=\"w\"> </span><span class=\"nv\">extractor</span><span class=\"w\"> </span><span class=\"nv\">infallible</span><span class=\"w\"> </span><span class=\"nv\">value_type</span><span class=\"w\"> </span><span class=\"nv\">value_type</span><span class=\"p\">)</span>\n</code></pre></div>\n<p>which I would think should be:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">value_type</span><span class=\"p\">(</span><span class=\"n\">val</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">Type</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">Value</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"p\">}</span>\n</code></pre></div>\n<p>but it is actually:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"k\">fn</span><span class=\"w\"> </span><span class=\"nf\">value_type</span><span class=\"p\">(</span><span class=\"n\">val</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">Value</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"p\">-&gt;</span><span class=\"w\"> </span><span class=\"nc\">Type</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"o\">..</span><span class=\"p\">.</span><span class=\"w\"> </span><span class=\"p\">}</span>\n</code></pre></div>\n<p>Why are params and return type suddenly swapped? <br>\n(Logically, it ofc only sense to turn an SSA value into a result type, not the other way around)</p>\n<p>These \"swapped params / results\" go all the way up to <code>has_type</code>, where I originally encountered it:</p>\n<div class=\"codehilite\" data-code-language=\"Common Lisp\"><pre><span></span><code><span class=\"p\">(</span><span class=\"nv\">decl</span><span class=\"w\"> </span><span class=\"nv\">result_type</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">Type</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"nv\">Inst</span><span class=\"p\">)</span>\n<span class=\"p\">(</span><span class=\"nv\">extractor</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">result_type</span><span class=\"w\"> </span><span class=\"nv\">ty</span><span class=\"p\">)</span>\n<span class=\"w\">           </span><span class=\"p\">(</span><span class=\"nv\">first_result</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">value_type</span><span class=\"w\"> </span><span class=\"nv\">ty</span><span class=\"p\">)))</span>\n<span class=\"p\">(</span><span class=\"nv\">decl</span><span class=\"w\"> </span><span class=\"nv\">has_type</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">Type</span><span class=\"w\"> </span><span class=\"nv\">Inst</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"nv\">Inst</span><span class=\"p\">)</span>\n<span class=\"p\">(</span><span class=\"nv\">extractor</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">has_type</span><span class=\"w\"> </span><span class=\"nv\">ty</span><span class=\"w\"> </span><span class=\"nv\">inst</span><span class=\"p\">)</span>\n<span class=\"w\">           </span><span class=\"p\">(</span><span class=\"nb\">and</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"nv\">result_type</span><span class=\"w\"> </span><span class=\"nv\">ty</span><span class=\"p\">)</span>\n<span class=\"w\">                </span><span class=\"nv\">inst</span><span class=\"p\">))</span>\n</code></pre></div>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/blob/100e90bcca285d3b1146995b65105da91583c3d1/cranelift/isle/isle/isle_examples/pass/tutorial.isle#L37-L62\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/7046c4b4290d53a4d1f3f27d3d2dcac26d378400/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f666433346664313261376436373633373330393462393330396237633730343762303061333337353130643662386632353732643132663834313061656637322f62797465636f6465616c6c69616e63652f7761736d74696d65&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/blob/100e90bcca285d3b1146995b65105da91583c3d1/cranelift/isle/isle/isle_examples/pass/tutorial.isle#L37-L62\" title=\"wasmtime/cranelift/isle/isle/isle_examples/pass/tutorial.isle at 100e90bcca285d3b1146995b65105da91583c3d1 路 bytecodealliance/wasmtime\">wasmtime/cranelift/isle/isle/isle_examples/pass/tutorial.isle at 100e90bcca285d3b1146995b65105da91583c3d1 路 bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">A lightweight WebAssembly runtime that is fast, secure, and standards-compliant - bytecodealliance/wasmtime</div></div></div><div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/blob/87ed3b6019abf061aedb3262563a4db8750b11da/cranelift/codegen/src/prelude_lower.isle#L279-L281\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/7046c4b4290d53a4d1f3f27d3d2dcac26d378400/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f666433346664313261376436373633373330393462393330396237633730343762303061333337353130643662386632353732643132663834313061656637322f62797465636f6465616c6c69616e63652f7761736d74696d65&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/blob/87ed3b6019abf061aedb3262563a4db8750b11da/cranelift/codegen/src/prelude_lower.isle#L279-L281\" title=\"wasmtime/cranelift/codegen/src/prelude_lower.isle at 87ed3b6019abf061aedb3262563a4db8750b11da 路 bytecodealliance/wasmtime\">wasmtime/cranelift/codegen/src/prelude_lower.isle at 87ed3b6019abf061aedb3262563a4db8750b11da 路 bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">A lightweight WebAssembly runtime that is fast, secure, and standards-compliant - bytecodealliance/wasmtime</div></div></div>",
        "id": 568193905,
        "sender_full_name": "Firestar99",
        "timestamp": 1768479576
    },
    {
        "content": "<p>I assume the answer is that <code>extern extractor</code>s \"swap\" return type and args <em>within Rust</em> compared to their constructor counterparts, since they \"work in reverse\" to constructors? Which would allow isle extractors, constructors and types (implicitly declaring both) to be declared with the exact same arg order, but extractors ofc \"working in reverse\".</p>",
        "id": 568205864,
        "sender_full_name": "Firestar99",
        "timestamp": 1768482501
    },
    {
        "content": "<p>Yep, exactly</p>",
        "id": 568215546,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1768484780
    }
]
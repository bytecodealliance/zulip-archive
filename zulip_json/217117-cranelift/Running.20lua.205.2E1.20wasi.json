[
    {
        "content": "<p>Hi all,</p>\n<p>I'm quite new to WASM. My goal is to run Lua 5.1 using wasmtime so that I can support some legacy plugins. I've manage to get lua 5.1 to build to wasi by 1) using the new <code>-wasm-enable-sjlj</code> flag from wasi-sdk, and 2) stubbing out some lua things I don't need (like tmp files and system()).</p>\n<p>When I attempt to run the built wasi binary with wasmtime it fails (expectedly?):</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"o\">%</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"n\">run</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">W</span><span class=\"w\"> </span><span class=\"n\">exceptions</span><span class=\"o\">=</span><span class=\"n\">yes</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">W</span><span class=\"w\"> </span><span class=\"n\">legacy</span><span class=\"o\">-</span><span class=\"n\">exceptions</span><span class=\"o\">=</span><span class=\"n\">yes</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">lua</span>\n<span class=\"n\">Error</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">compile</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">wasm</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]::</span><span class=\"n\">function</span><span class=\"p\">[</span><span class=\"mi\">123</span><span class=\"p\">]::</span><span class=\"n\">luaD_rawrunprotected</span>\n\n<span class=\"n\">Caused</span><span class=\"w\"> </span><span class=\"n\">by</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"mi\">0</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">WebAssembly</span><span class=\"w\"> </span><span class=\"n\">translation</span><span class=\"w\"> </span><span class=\"n\">error</span>\n<span class=\"w\">    </span><span class=\"mi\">1</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">Unsupported</span><span class=\"w\"> </span><span class=\"n\">feature</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">proposed</span><span class=\"w\"> </span><span class=\"n\">exception</span><span class=\"w\"> </span><span class=\"n\">handling</span><span class=\"w\"> </span><span class=\"n\">operator</span><span class=\"w\"> </span><span class=\"n\">Try</span><span class=\"w\"> </span><span class=\"p\">{</span><span class=\"w\"> </span><span class=\"n\">blockty</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">Empty</span><span class=\"w\"> </span><span class=\"p\">}</span>\n</code></pre></div>\n<p>From what I can glean from googling this work is currently going on in cranelift, so I'm not sure if it should be working or not at this point. Any info appreciated and sorry if I'm posting in the wrong channel.</p>",
        "id": 535357721,
        "sender_full_name": "Brian G. Merrell",
        "timestamp": 1755709534
    },
    {
        "content": "<p><span class=\"user-mention\" data-user-id=\"949827\">@Brian G. Merrell</span> exception handling is under review and should land soon -- I've just gotten all spec-tests to pass in my branch (<a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\">https://github.com/bytecodealliance/wasmtime/pull/11326</a>). If you wait until the next Wasmtime release, it should be present there, assuming nothing goes wrong</p>\n<div class=\"message_embed\"><a class=\"message_embed_image\" href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\" style=\"background-image: url(&quot;https://uploads.zulipusercontent.net/26ed48f19fe92c46d27f30fa8f2570b71d3a818b/68747470733a2f2f6f70656e67726170682e6769746875626173736574732e636f6d2f636334643038613036396330623564623066326162323531323330643030663732663131333863323663306439323763633638343763623133306238303564622f62797465636f6465616c6c69616e63652f7761736d74696d652f70756c6c2f3131333236&quot;)\"></a><div class=\"data-container\"><div class=\"message_embed_title\"><a href=\"https://github.com/bytecodealliance/wasmtime/pull/11326\" title=\"WebAssembly exception-handling support. by cfallin 路 Pull Request #11326 路 bytecodealliance/wasmtime\">WebAssembly exception-handling support. by cfallin 路 Pull Request #11326 路 bytecodealliance/wasmtime</a></div><div class=\"message_embed_description\">This PR introduces support for the Wasm exception-handling proposal, which introduces a conventional try/catch mechanism to WebAssembly. The PR supports modules that use try_table to register handl...</div></div></div>",
        "id": 535358928,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1755710020
    },
    {
        "content": "<p>You're correct that current Wasmtime (latest release, and <code>main</code>) do not have Wasm exception-handling support</p>",
        "id": 535358965,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1755710036
    },
    {
        "content": "<p>Awesome! thank you! (and yes, I built wasmtime from main since I knew that was all in the works)</p>",
        "id": 535359058,
        "sender_full_name": "Brian G. Merrell",
        "timestamp": 1755710078
    },
    {
        "content": "<p>Note though <span class=\"user-mention\" data-user-id=\"949827\">@Brian G. Merrell</span> you'll need to build lua with the standard wasm exceptions proposal, the <code>try</code> instruction that this is failing on is the \"legacy wasm exceptions\" which Wasmtime has no plans to implement at this time. This is probably going to be figuring out the right flags to pass to the compile (I'm not sure what such flags are myself)</p>",
        "id": 535360868,
        "sender_full_name": "Alex Crichton",
        "timestamp": 1755710903
    },
    {
        "content": "<p>I believe LLVM doesn't have support for it directly at the moment; the expected path is to use Binaryen (it has a pass to translate legacy exceptions to standard exceptions; I don't remember off top of head)</p>",
        "id": 535361688,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1755711251
    },
    {
        "content": "<p>I don't know whether the wasi-libc release binaries are already translated as such or not though?</p>",
        "id": 535361795,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1755711313
    },
    {
        "content": "<p>Hmm.. would this be a problem for me since <code>-wasm-enable-sjlj</code> is an llvm flag? (sjlj is needed for Lua setjump/longjump support afaik.)</p>",
        "id": 535362186,
        "sender_full_name": "Brian G. Merrell",
        "timestamp": 1755711512
    },
    {
        "content": "<p>shouldn't be a problem as long as you're able to run the Binaryen pass IIRC</p>",
        "id": 535362240,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1755711541
    },
    {
        "content": "<p>LLVM got exception support in Wasm early, before the proposal was overhauled, and then they patched up the difference with Binaryen; and I believe the maintainers of the LLVM backend haven't prioritized an update in LLVM proper because the patch is \"good enough\" (and they expect ~everyone to run Binaryen on production binaries anyway). It's a little annoying and hopefully one day the extra step won't be necessary; but at least the compatibility path is there</p>",
        "id": 535362441,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1755711633
    },
    {
        "content": "<p>(and for the record we are explicitly avoiding implementing legacy exceptions because it's not a standard (and by policy we don't ship nonstandard extensions), and also because the exceptions-proposal folks in the Wasm CG have discussed how to \"unship\" it eventually and we don't want to make that problem worse)</p>",
        "id": 535362614,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1755711721
    },
    {
        "content": "<p>Ah, OK. I ran the original wasi binary through binaryen (which I'm hearing about for the first time <span aria-label=\"sweat smile\" class=\"emoji emoji-1f605\" role=\"img\" title=\"sweat smile\">:sweat_smile:</span>). I suspect this is more what I should be doing atm:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">W</span><span class=\"w\"> </span><span class=\"n\">exceptions</span><span class=\"o\">=</span><span class=\"n\">yes</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">lua</span><span class=\"p\">.</span><span class=\"n\">exnref</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n<span class=\"n\">Error</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">failed</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">compile</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">wasm</span><span class=\"p\">[</span><span class=\"mi\">0</span><span class=\"p\">]::</span><span class=\"n\">function</span><span class=\"p\">[</span><span class=\"mi\">96</span><span class=\"p\">]</span>\n\n<span class=\"n\">Caused</span><span class=\"w\"> </span><span class=\"n\">by</span><span class=\"p\">:</span>\n<span class=\"w\">    </span><span class=\"mi\">0</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">WebAssembly</span><span class=\"w\"> </span><span class=\"n\">translation</span><span class=\"w\"> </span><span class=\"n\">error</span>\n<span class=\"w\">    </span><span class=\"mi\">1</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">Unsupported</span><span class=\"w\"> </span><span class=\"n\">feature</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">exception</span><span class=\"w\"> </span><span class=\"n\">operators</span><span class=\"w\"> </span><span class=\"n\">are</span><span class=\"w\"> </span><span class=\"n\">not</span><span class=\"w\"> </span><span class=\"n\">yet</span><span class=\"w\"> </span><span class=\"n\">implemented</span>\n</code></pre></div>",
        "id": 535363881,
        "sender_full_name": "Brian G. Merrell",
        "timestamp": 1755712296
    },
    {
        "content": "<p>If you're feeling adventurous, you could pull down my branch (<code>git clone -b wasm-exceptions https://github.com/cfallin/wasmtime</code>), build that and try it out with that command line; we pass spec tests now but a real-world validation would be really cool too</p>",
        "id": 535364102,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1755712396
    },
    {
        "content": "<p>Great, I will</p>",
        "id": 535364206,
        "sender_full_name": "Brian G. Merrell",
        "timestamp": 1755712453
    },
    {
        "content": "<p>I'll be darned! It works:</p>\n<div class=\"codehilite\" data-code-language=\"Rust\"><pre><span></span><code><span class=\"cp\">$</span><span class=\"w\"> </span><span class=\"o\">~/</span><span class=\"n\">code</span><span class=\"o\">/</span><span class=\"n\">github</span><span class=\"p\">.</span><span class=\"n\">com</span><span class=\"o\">/</span><span class=\"n\">cfallin</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"o\">/</span><span class=\"n\">target</span><span class=\"o\">/</span><span class=\"n\">release</span><span class=\"o\">/</span><span class=\"n\">wasmtime</span><span class=\"w\"> </span><span class=\"o\">-</span><span class=\"n\">W</span><span class=\"w\"> </span><span class=\"n\">exceptions</span><span class=\"o\">=</span><span class=\"n\">yes</span><span class=\"w\"> </span><span class=\"p\">.</span><span class=\"o\">/</span><span class=\"n\">lua</span><span class=\"p\">.</span><span class=\"n\">exnref</span><span class=\"p\">.</span><span class=\"n\">wasm</span>\n<span class=\"n\">Lua</span><span class=\"w\"> </span><span class=\"mf\">5.1.5</span><span class=\"w\">  </span><span class=\"n\">Copyright</span><span class=\"w\"> </span><span class=\"p\">(</span><span class=\"n\">C</span><span class=\"p\">)</span><span class=\"w\"> </span><span class=\"mi\">1994</span><span class=\"o\">-</span><span class=\"mi\">2012</span><span class=\"w\"> </span><span class=\"n\">Lua</span><span class=\"p\">.</span><span class=\"n\">org</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">PUC</span><span class=\"o\">-</span><span class=\"n\">Rio</span>\n<span class=\"o\">&gt;</span><span class=\"w\"> </span><span class=\"kr\">do</span>\n<span class=\"w\">  </span><span class=\"n\">print</span><span class=\"p\">(</span><span class=\"s\">\"About to test error handling...\"</span><span class=\"p\">)</span>\n\n<span class=\"w\">  </span><span class=\"n\">local</span><span class=\"w\"> </span><span class=\"n\">function</span><span class=\"w\"> </span><span class=\"n\">boom</span><span class=\"p\">()</span>\n<span class=\"w\">    </span><span class=\"n\">error</span><span class=\"p\">(</span><span class=\"s\">\"this is a test error\"</span><span class=\"p\">)</span>\n<span class=\"w\">  </span><span class=\"n\">end</span>\n\n<span class=\"w\">  </span><span class=\"n\">local</span><span class=\"w\"> </span><span class=\"n\">ok</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">msg</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">pcall</span><span class=\"p\">(</span><span class=\"n\">boom</span><span class=\"p\">)</span>\n<span class=\"w\">  </span><span class=\"n\">print</span><span class=\"p\">(</span><span class=\"s\">\"pcall returned:\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ok</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">msg</span><span class=\"p\">)</span>\n\n<span class=\"w\">  </span><span class=\"n\">local</span><span class=\"w\"> </span><span class=\"n\">co</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">coroutine</span><span class=\"p\">.</span><span class=\"n\">create</span><span class=\"p\">(</span><span class=\"n\">function</span><span class=\"p\">()</span>\n<span class=\"w\">    </span><span class=\"n\">print</span><span class=\"p\">(</span><span class=\"s\">\"Inside coroutine\"</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"n\">coroutine</span><span class=\"p\">.</span><span class=\"kr\">yield</span><span class=\"p\">(</span><span class=\"s\">\"yielded once\"</span><span class=\"p\">)</span>\n<span class=\"w\">    </span><span class=\"k\">return</span><span class=\"w\"> </span><span class=\"s\">\"done\"</span>\n<span class=\"w\">  </span><span class=\"n\">end</span><span class=\"p\">)</span>\n\n<span class=\"w\">  </span><span class=\"n\">local</span><span class=\"w\"> </span><span class=\"n\">ok1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">val1</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">coroutine</span><span class=\"p\">.</span><span class=\"n\">resume</span><span class=\"p\">(</span><span class=\"n\">co</span><span class=\"p\">)</span>\n<span class=\"w\">  </span><span class=\"n\">print</span><span class=\"p\">(</span><span class=\"s\">\"resume 1:\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ok1</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">val1</span><span class=\"p\">)</span>\n\n<span class=\"w\">  </span><span class=\"n\">local</span><span class=\"w\"> </span><span class=\"n\">ok2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">val2</span><span class=\"w\"> </span><span class=\"o\">=</span><span class=\"w\"> </span><span class=\"n\">coroutine</span><span class=\"p\">.</span><span class=\"n\">resume</span><span class=\"p\">(</span><span class=\"n\">co</span><span class=\"p\">)</span>\n<span class=\"w\">  </span><span class=\"n\">print</span><span class=\"p\">(</span><span class=\"s\">\"resume 2:\"</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">ok2</span><span class=\"p\">,</span><span class=\"w\"> </span><span class=\"n\">val2</span><span class=\"p\">)</span>\n<span class=\"n\">end</span>\n<span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"o\">&gt;&gt;</span><span class=\"w\"> </span><span class=\"o\">&gt;&gt;</span>\n<span class=\"n\">About</span><span class=\"w\"> </span><span class=\"n\">to</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"n\">error</span><span class=\"w\"> </span><span class=\"n\">handling</span><span class=\"o\">..</span><span class=\"p\">.</span>\n<span class=\"n\">pcall</span><span class=\"w\"> </span><span class=\"n\">returned</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">false</span><span class=\"w\">   </span><span class=\"n\">stdin</span><span class=\"p\">:</span><span class=\"mi\">5</span><span class=\"p\">:</span><span class=\"w\"> </span><span class=\"nc\">this</span><span class=\"w\"> </span><span class=\"n\">is</span><span class=\"w\"> </span><span class=\"n\">a</span><span class=\"w\"> </span><span class=\"n\">test</span><span class=\"w\"> </span><span class=\"n\">error</span>\n<span class=\"n\">Inside</span><span class=\"w\"> </span><span class=\"n\">coroutine</span>\n<span class=\"n\">resume</span><span class=\"w\"> </span><span class=\"mi\">1</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"nc\">true</span><span class=\"w\">    </span><span class=\"n\">yielded</span><span class=\"w\"> </span><span class=\"n\">once</span>\n<span class=\"n\">resume</span><span class=\"w\"> </span><span class=\"mi\">2</span><span class=\"p\">:</span><span class=\"w\">   </span><span class=\"nc\">true</span><span class=\"w\">    </span><span class=\"n\">done</span>\n</code></pre></div>",
        "id": 535368031,
        "sender_full_name": "Brian G. Merrell",
        "timestamp": 1755714057
    },
    {
        "content": "<p>nice! thanks for testing this!</p>",
        "id": 535368122,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1755714094
    },
    {
        "content": "<p>Thanks for doing the work.. being able to run lua in wasmtime is going to be big for us I think.</p>",
        "id": 535368263,
        "sender_full_name": "Brian G. Merrell",
        "timestamp": 1755714138
    },
    {
        "content": "<p>and now this is merged, so you should be able to build from <code>main</code> (and assuming it doesn't have to be backed out, will be in Wasmtime 37 released in a month, but off by default still)</p>",
        "id": 535422309,
        "sender_full_name": "Chris Fallin",
        "timestamp": 1755746924
    }
]